<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ESP32S3å­¦ä¹ ç¬”è®°</title>
    <url>/2025/01/12/ESP32S3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>ä¸»è¦å­¦ä¹ ç«‹åˆ›<strong>ESP32S3 N16R8</strong>çš„åŸºæœ¬é…ç½®ä»¥åŠå…¶å„éƒ¨ä»¶ç»„æˆ</p>
<h1 id="ç»„æˆç»“æ„"><a class="markdownIt-Anchor" href="#ç»„æˆç»“æ„"></a> ç»„æˆç»“æ„</h1>
<img src="https://s2.loli.net/2025/05/08/1dog3h8nKRCOMPW.png" style="zoom: 50%;" />
<img src="https://s2.loli.net/2025/05/08/DCTorxL4l6cPMYz.png" style="zoom:50%;" />
<table>
<thead>
<tr>
<th style="text-align:center">ç±»åˆ«</th>
<th style="text-align:center">å‹å·</th>
<th style="text-align:center">å‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ¨¡ç»„</td>
<td style="text-align:center"><strong>ESP32-S3-WROOM-1-N16R8</strong></td>
<td style="text-align:center">æ­è½½ XtensaÂ® 32 ä½ LX7 åŒæ ¸å¤„ç†å™¨ï¼Œä¸»é¢‘é«˜è¾¾ <strong>240 MHz</strong>ï¼Œå†…ç½®<strong>SRAM 512kB</strong>ï¼Œå¤–ç½®<strong>PSRAM 8MB</strong>ï¼Œå¤–ç½®<strong>FLASH 16MB</strong>ï¼Œ2.4 GHz Wi-Fi (802.11 b/g/n) 40MHzå¸¦å®½ï¼ŒBluetooth 5 (LE) å’Œ Bluetooth Meshï¼Œé›†æˆAIå‘é‡æŒ‡ä»¤ï¼ŒåŠ é€Ÿç¥ç»ç½‘ç»œè®¡ç®—å’Œä¿¡å·å¤„ç†</td>
</tr>
<tr>
<td style="text-align:center">æ˜¾ç¤ºå±</td>
<td style="text-align:center"><strong>ST7789</strong></td>
<td style="text-align:center">2.0å¯¸ã€IPSå…¨è§†è§’ã€åˆ†è¾¨ç‡320*240ã€<strong>SPIæ¥å£</strong></td>
</tr>
<tr>
<td style="text-align:center">è§¦æ‘¸å±</td>
<td style="text-align:center"><strong>FT6336</strong></td>
<td style="text-align:center">ç”µå®¹è§¦æ‘¸ã€<strong>I2Cæ¥å£</strong></td>
</tr>
<tr>
<td style="text-align:center">å§¿æ€ä¼ æ„Ÿå™¨</td>
<td style="text-align:center"><strong>QMI8658</strong></td>
<td style="text-align:center">ä¸‰è½´åŠ é€Ÿåº¦+ä¸‰è½´é™€èºä»ªã€<strong>I2Cæ¥å£</strong></td>
</tr>
<tr>
<td style="text-align:center">éŸ³é¢‘DAC</td>
<td style="text-align:center"><strong>ES8311</strong></td>
<td style="text-align:center">å•é€šé“ã€<strong>I2Cæ¥å£</strong></td>
</tr>
<tr>
<td style="text-align:center">éŸ³é¢‘ADC</td>
<td style="text-align:center"><strong>ES7210</strong></td>
<td style="text-align:center">å››é€šé“(å¼€å‘æ¿ç”¨ä¸‰ä¸ªé€šé“)ã€<strong>I2Cæ¥å£</strong></td>
</tr>
<tr>
<td style="text-align:center">éŸ³é¢‘åŠŸæ”¾</td>
<td style="text-align:center">NS4150B</td>
<td style="text-align:center">å•å£°é“Dç±»éŸ³é¢‘æ”¾å¤§å™¨</td>
</tr>
<tr>
<td style="text-align:center">éº¦å…‹é£</td>
<td style="text-align:center">ZTS6216</td>
<td style="text-align:center">é…å¥—åŒè·¯éº¦å…‹é£ã€æ¨¡æ‹Ÿè¾“å‡º</td>
</tr>
<tr>
<td style="text-align:center">å–‡å­</td>
<td style="text-align:center">DB1811AB50</td>
<td style="text-align:center">1811éŸ³è…”å–‡å­ã€1W</td>
</tr>
<tr>
<td style="text-align:center">USB HUB</td>
<td style="text-align:center">CH334F</td>
<td style="text-align:center">USB2.0 HUB</td>
</tr>
<tr>
<td style="text-align:center">USBè½¬ä¸²å£</td>
<td style="text-align:center">CH340K</td>
<td style="text-align:center">æ³¢ç‰¹ç‡æœ€å¤§2Mbps</td>
</tr>
<tr>
<td style="text-align:center">ç”µæºèŠ¯ç‰‡</td>
<td style="text-align:center">SY8088AAC</td>
<td style="text-align:center">æä¾›åŒè·¯ã€æ¯è·¯1A</td>
</tr>
<tr>
<td style="text-align:center">GH1.25æ¥å£</td>
<td style="text-align:center"></td>
<td style="text-align:center">ä¸¤è·¯å¤–æ‹“ä¼ æ„Ÿå™¨æ¥å£ï¼Œå¯ä»¥ç»™å¤–éƒ¨ä¼ æ„Ÿå™¨ä¾›ç”µ5Vå’Œ3.3Vï¼Œå¯ä»¥ä½œä¸ºGPIOã€CANã€I2Cã€UARTã€PWMç­‰æ¥å£</td>
</tr>
<tr>
<td style="text-align:center">TFå¡æ¥å£</td>
<td style="text-align:center"></td>
<td style="text-align:center">é‡‡ç”¨1-SDæ¨¡å¼ä¸ESP32è¿æ¥</td>
</tr>
<tr>
<td style="text-align:center">Type-Cæ¥å£</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç”¨äºä¾›ç”µã€ç¨‹åºä¸‹è½½ã€ç¨‹åºè°ƒè¯•ï¼Œä»¥åŠUSBæ•°æ®é€šä¿¡</td>
</tr>
<tr>
<td style="text-align:center">æŒ‰é”®</td>
<td style="text-align:center"></td>
<td style="text-align:center">ä¸€ä¸ªå¤ä½æŒ‰é”®ã€ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰æŒ‰é”®</td>
</tr>
</tbody>
</table>
<h1 id="åŸºç¡€å¤–è®¾"><a class="markdownIt-Anchor" href="#åŸºç¡€å¤–è®¾"></a> åŸºç¡€å¤–è®¾</h1>
<h2 id="æŒ‰é”®key"><a class="markdownIt-Anchor" href="#æŒ‰é”®key"></a> æŒ‰é”®Key</h2>
<h3 id="æ ·ä¾‹"><a class="markdownIt-Anchor" href="#æ ·ä¾‹"></a> æ ·ä¾‹</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/FreeRTOS.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/task.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/queue.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;driver/gpio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> QueueHandle_t gpio_evt_queue = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> IRAM_ATTR <span class="title function_">gpio_isr_handler</span><span class="params">(<span class="type">void</span>* arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> gpio_num = (<span class="type">uint32_t</span>) arg;</span><br><span class="line">    xQueueSendFromISR(gpio_evt_queue, &amp;gpio_num, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gpio_task_example</span><span class="params">(<span class="type">void</span>* arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> io_num;</span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">        <span class="keyword">if</span>(xQueueReceive(gpio_evt_queue, &amp;io_num, portMAX_DELAY)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;GPIO[%&quot;</span>PRIu32<span class="string">&quot;] intr, val: %d\n&quot;</span>, io_num, gpio_get_level(io_num));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">gpio_config_t</span> io_conf = &#123;</span><br><span class="line">        .intr_type = GPIO_INTR_NEGEDGE, <span class="comment">//falling edge interrupt</span></span><br><span class="line">        .mode = GPIO_MODE_INPUT, <span class="comment">//set as input mode</span></span><br><span class="line">        .pin_bit_mask = <span class="number">1</span>&lt;&lt;GPIO_NUM_0, <span class="comment">//bit mask of the pins GPIO0</span></span><br><span class="line">        .pull_down_en = <span class="number">0</span>, <span class="comment">//disable pull-down mode</span></span><br><span class="line">        .pull_up_en = <span class="number">1</span> <span class="comment">//enable pull-up mode</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//configure GPIO with the given settings</span></span><br><span class="line">    gpio_config(&amp;io_conf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create a queue to handle gpio event from isr</span></span><br><span class="line">    gpio_evt_queue = xQueueCreate(<span class="number">10</span>, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">    <span class="comment">//start gpio task</span></span><br><span class="line">    xTaskCreate(gpio_task_example, <span class="string">&quot;gpio_task_example&quot;</span>, <span class="number">2048</span>, <span class="literal">NULL</span>, <span class="number">10</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//install gpio isr service</span></span><br><span class="line">    gpio_install_isr_service(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//hook isr handler for specific gpio pin</span></span><br><span class="line">    gpio_isr_handler_add(GPIO_NUM_0, gpio_isr_handler, (<span class="type">void</span>*) GPIO_NUM_0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å§¿æ€ä¼ æ„Ÿå™¨qmi8658"><a class="markdownIt-Anchor" href="#å§¿æ€ä¼ æ„Ÿå™¨qmi8658"></a> å§¿æ€ä¼ æ„Ÿå™¨ï¼ˆQMI8658ï¼‰</h2>
<p>I2Cæ§åˆ¶ï¼Œåœ°å€<strong>QMI8658_SENSOR_ADDR= 0x6A</strong></p>
<p>å†…éƒ¨é›†æˆ 3 è½´åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨å’Œ 3 è½´é™€èºä»ªä¼ æ„Ÿå™¨ï¼Œæ”¯æŒ <strong>SPI å’Œ I2C</strong> é€šä¿¡</p>
<p><strong>I2Cçš„é¢‘ç‡</strong>ä¸º<strong>100000</strong></p>
<p>BSP_I2C_NUMä¸º0</p>
<table>
<thead>
<tr>
<th style="text-align:center">è¯´æ˜</th>
<th style="text-align:center">PIN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">I2C_SCL</td>
<td style="text-align:center">GPIO_NUM_1</td>
</tr>
<tr>
<td style="text-align:center">I2C_SDA</td>
<td style="text-align:center">GPIO_NUM_2</td>
</tr>
</tbody>
</table>
<p><strong>è®¡ç®—å€¾æ–œè§’åº¦</strong>ï¼ˆå››å…ƒæ³•ï¼‰</p>
<p><img src="https://s2.loli.net/2025/05/08/lGz1Uq5tER89fs4.png" alt="" /></p>
<p><strong>é…ç½®qmi8658</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>  QMI8658_SENSOR_ADDR       0x6A</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">qmi8658_reg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    QMI8658_WHO_AM_I,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_I2CM_STATUS = <span class="number">44</span>,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_dQW_L = <span class="number">73</span>,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_RESET = <span class="number">96</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">void</span> qmi8658_init(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    qmi8658_register_read(QMI8658_WHO_AM_I, &amp;id ,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span> (id != <span class="number">0x05</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        vTaskDelay(<span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">        qmi8658_register_read(QMI8658_WHO_AM_I, &amp;id ,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ESP_LOGI(TAG, <span class="string">&quot;QMI8658 OK!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_RESET, <span class="number">0xb0</span>);  <span class="comment">// å¤ä½</span></span><br><span class="line">    vTaskDelay(<span class="number">10</span> / portTICK_PERIOD_MS);</span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL1, <span class="number">0x40</span>); <span class="comment">// CTRL1 è®¾ç½®åœ°å€è‡ªåŠ¨å¢åŠ </span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL7, <span class="number">0x03</span>); <span class="comment">// CTRL7 å…è®¸åŠ é€Ÿåº¦å’Œé™€èºä»ª</span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL2, <span class="number">0x95</span>); <span class="comment">// CTRL2 è®¾ç½®ACC 4g 250Hz</span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL3, <span class="number">0xd5</span>); <span class="comment">// CTRL3 è®¾ç½®GRY 512dps 250Hz</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»æ“ä½œ</span></span><br><span class="line"><span class="type">esp_err_t</span> <span class="title function_">qmi8658_register_read</span><span class="params">(<span class="type">uint8_t</span> reg_addr, <span class="type">uint8_t</span> *data, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> i2c_master_write_read_device(BSP_I2C_NUM, QMI8658_SENSOR_ADDR,  &amp;reg_addr, <span class="number">1</span>, data, len, <span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å†™æ“ä½œ</span></span><br><span class="line"><span class="type">esp_err_t</span> <span class="title function_">qmi8658_register_write_byte</span><span class="params">(<span class="type">uint8_t</span> reg_addr, <span class="type">uint8_t</span> data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> write_buf[<span class="number">2</span>] = &#123;reg_addr, data&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i2c_master_write_to_device(BSP_I2C_NUM, QMI8658_SENSOR_ADDR, write_buf, <span class="keyword">sizeof</span>(write_buf), <span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ±‚å–å§¿æ€æ•°å€¼</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">int16_t</span> acc_y;</span><br><span class="line">    <span class="type">int16_t</span> acc_x;</span><br><span class="line">    <span class="type">int16_t</span> acc_z;</span><br><span class="line">    <span class="type">int16_t</span> gyr_y;</span><br><span class="line">    <span class="type">int16_t</span> gyr_x;</span><br><span class="line">    <span class="type">int16_t</span> gyr_z;</span><br><span class="line">    <span class="type">float</span> AngleX;</span><br><span class="line">    <span class="type">float</span> AngleY;</span><br><span class="line">    <span class="type">float</span> AngleZ;</span><br><span class="line">&#125;t_sQMI8658;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–åŠ é€Ÿåº¦å’Œé™€èºä»ªå¯„å­˜å™¨å€¼</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">qmi8658_Read_AccAndGry</span><span class="params">(t_sQMI8658 *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> status, data_ready=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int16_t</span> buf[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">    qmi8658_register_read(QMI8658_STATUS0, &amp;status, <span class="number">1</span>); <span class="comment">// è¯»çŠ¶æ€å¯„å­˜å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; <span class="number">0x03</span>) 					<span class="comment">// åˆ¤æ–­åŠ é€Ÿåº¦å’Œé™€èºä»ªæ•°æ®æ˜¯å¦å¯è¯»</span></span><br><span class="line">        data_ready = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (data_ready == <span class="number">1</span>)&#123;  				<span class="comment">// å¦‚æœæ•°æ®å¯è¯»</span></span><br><span class="line">        data_ready = <span class="number">0</span>;</span><br><span class="line">        qmi8658_register_read(QMI8658_AX_L, (<span class="type">uint8_t</span> *)buf, <span class="number">12</span>); <span class="comment">// è¯»åŠ é€Ÿåº¦å’Œé™€èºä»ªå€¼</span></span><br><span class="line">        p-&gt;acc_x = buf[<span class="number">0</span>];</span><br><span class="line">        p-&gt;acc_y = buf[<span class="number">1</span>];</span><br><span class="line">        p-&gt;acc_z = buf[<span class="number">2</span>];</span><br><span class="line">        p-&gt;gyr_x = buf[<span class="number">3</span>];</span><br><span class="line">        p-&gt;gyr_y = buf[<span class="number">4</span>];</span><br><span class="line">        p-&gt;gyr_z = buf[<span class="number">5</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–XYZè½´çš„å€¾è§’å€¼</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">qmi8658_fetch_angleFromAcc</span><span class="params">(t_sQMI8658 *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> temp;</span><br><span class="line"></span><br><span class="line">    qmi8658_Read_AccAndGry(p); <span class="comment">// è¯»å–åŠ é€Ÿåº¦å’Œé™€èºä»ªçš„å¯„å­˜å™¨å€¼</span></span><br><span class="line">    <span class="comment">// æ ¹æ®å¯„å­˜å™¨å€¼ è®¡ç®—å€¾è§’å€¼ å¹¶æŠŠå¼§åº¦è½¬æ¢æˆè§’åº¦</span></span><br><span class="line">    temp = (<span class="type">float</span>)p-&gt;acc_x / <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_y * (<span class="type">float</span>)p-&gt;acc_y + (<span class="type">float</span>)p-&gt;acc_z * (<span class="type">float</span>)p-&gt;acc_z) );</span><br><span class="line">    p-&gt;AngleX = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/Ï€=57.29578</span></span><br><span class="line">    temp = (<span class="type">float</span>)p-&gt;acc_y / <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_x * (<span class="type">float</span>)p-&gt;acc_x + (<span class="type">float</span>)p-&gt;acc_z * (<span class="type">float</span>)p-&gt;acc_z) );</span><br><span class="line">    p-&gt;AngleY = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/Ï€=57.29578</span></span><br><span class="line">    temp = <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_x * (<span class="type">float</span>)p-&gt;acc_x + (<span class="type">float</span>)p-&gt;acc_y * (<span class="type">float</span>)p-&gt;acc_y) ) / (<span class="type">float</span>)p-&gt;acc_z;</span><br><span class="line">    p-&gt;AngleZ = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/Ï€=57.29578</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ioæ‹“å±•pac9557"><a class="markdownIt-Anchor" href="#ioæ‹“å±•pac9557"></a> IOæ‹“å±•ï¼ˆPAC9557ï¼‰</h2>
<p>å¤–è®¾æ‹“å±•å£ï¼Œç”±<strong>I2Cæ§åˆ¶</strong>ï¼Œåœ°å€<strong>PCA9557_SENSOR_ADDR = 0x19</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//LCD_CS å¯¹åº” PCA9557 çš„ IO0 å¼•è„šï¼ŒPA_EN å¯¹åº” IO1 å¼•è„šï¼ŒDVP_PWDN å¯¹åº” IO2 å¼•è„š</span></span><br></pre></td></tr></table></figure>
<h2 id="éŸ³é¢‘è¾“å…¥es7210"><a class="markdownIt-Anchor" href="#éŸ³é¢‘è¾“å…¥es7210"></a> éŸ³é¢‘è¾“å…¥ï¼ˆES7210ï¼‰</h2>
<p>AD0æ¥é«˜ç”µå¹³ï¼ŒAD1æ¥ä½ç”µå¹³ï¼Œ<strong>I2Cåœ°å€ä¸º0x41</strong></p>
<p><strong>ES7210</strong> è¿æ¥ MIC <strong>è´Ÿè´£éŸ³é¢‘è¾“å…¥</strong>ï¼Œ<strong>ES8311</strong> åªè´Ÿè´£<strong>éŸ³é¢‘è¾“å‡º</strong></p>
<p><strong>ES7210 å¯ä»¥è¿æ¥ 4 ä¸ª MIC</strong>ï¼Œå¼€å‘æ¿ä¸Šè¿æ¥äº† 3 ä¸ª MICï¼Œ<strong>MIC1 å’Œ MIC2 æ¥æ”¶äººè¯´è¯çš„å£°éŸ³</strong>ï¼Œ <strong>MIC3 è¿æ¥äº† ES8311 çš„è¾“å‡º</strong>ï¼Œç”¨äºå›å£°æ¶ˆé™¤ã€‚</p>
<p>S3èŠ¯ç‰‡ä¼šåšå›å£°æ¶ˆé™¤ï¼Œ<strong>éŸ³å“åœ¨æ’­æ”¾å£°éŸ³çš„æ—¶å€™ï¼Œå¯ä»¥è¯´è¯æ‰“æ–­å®ƒ</strong>ã€‚</p>
<p>è¿™ä¸ªåŸç†å°±æ˜¯ ES8311 è¾“å‡ºçš„ä¿¡å·ï¼Œä¸ä»…ç»™äº†å–‡å­ï¼Œè¿˜ç»™äº† ES7210 çš„ MIC3 è¾“å…¥ï¼ŒESP32 åœ¨æ¥æ”¶åˆ° MIC1 MIC2 å’Œ MIC3 çš„å£°éŸ³åï¼Œå¯ä»¥åˆ†ç¦»å‡º MIC3ï¼Œä»è€Œè¿›è¡Œè¯†åˆ«ã€‚</p>
<p><strong>æœ¬éƒ¨åˆ†ä¾‹ç¨‹</strong></p>
<ol>
<li>
<p>åˆå§‹åŒ–I2Sæ€»çº¿</p>
</li>
<li>
<p>åˆå§‹åŒ–ES7120èŠ¯ç‰‡</p>
</li>
<li>
<p>åŠ è½½SDå¡</p>
</li>
<li>
<p>å½•åˆ¶å£°éŸ³</p>
</li>
</ol>
<h3 id="i2sçš„ioå’Œå¯„å­˜å™¨é…ç½®"><a class="markdownIt-Anchor" href="#i2sçš„ioå’Œå¯„å­˜å™¨é…ç½®"></a> I2Sçš„IOå’Œå¯„å­˜å™¨é…ç½®</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_ES7210_I2C_ADDR    (0x41)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2C port and GPIOs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_NUM            (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_SDA_IO         (1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_SCL_IO         (2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2S port and GPIOs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_NUM            (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_MCK_IO         (38)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_BCK_IO         (14)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_WS_IO          (13)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_DI_IO          (12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2S configurations */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_TDM_FORMAT     (ES7210_I2S_FMT_I2S)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_CHAN_NUM       (2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_SAMPLE_RATE    (48000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_MCLK_MULTIPLE  (I2S_MCLK_MULTIPLE_256)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_SAMPLE_BITS    (I2S_DATA_BIT_WIDTH_16BIT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_TDM_SLOT_MASK  (I2S_TDM_SLOT0 | I2S_TDM_SLOT1)</span></span><br></pre></td></tr></table></figure>
<h3 id="æ ‡å‡†i2så’Œtdm_i2sæ¨¡å¼"><a class="markdownIt-Anchor" href="#æ ‡å‡†i2så’Œtdm_i2sæ¨¡å¼"></a> æ ‡å‡†I2Så’ŒTDM_I2Sæ¨¡å¼</h3>
<p>I2Sæ¨¡å¼</p>
<img src="https://s2.loli.net/2025/05/08/ejG41dOuWKL8rUX.png" style="zoom: 67%;" />
<p><strong>TDM_I2Sæ¨¡å¼</strong></p>
<img src="https://s2.loli.net/2025/05/08/oLIKBUTzCDepwHG.png" style="zoom:67%;" />
<p>ES7210å·¥ä½œåœ¨<strong>I2Sæ¨¡å¼</strong>æ—¶ï¼Œåªèƒ½<strong>é‡‡é›†2ä¸ªé€šé“</strong>ï¼Œè€Œå·¥ä½œåœ¨<strong>TDM_I2S</strong>æ¨¡å¼æ—¶ï¼Œå¯ä»¥<strong>é‡‡é›†4ä¸ªé€šé“</strong></p>
<h2 id="éŸ³é¢‘è¾“å‡ºes8311"><a class="markdownIt-Anchor" href="#éŸ³é¢‘è¾“å‡ºes8311"></a> éŸ³é¢‘è¾“å‡ºï¼ˆES8311ï¼‰</h2>
<p>ä¸»å‡½æ•°åŒ…æ‹¬ï¼š</p>
<ol>
<li><code>i2s_driver_init()</code> å‡½æ•°åˆå§‹åŒ– i2s æ¥å£</li>
<li><code>es8311_codec_init()</code> å‡½æ•°åˆå§‹åŒ– <strong>i2c æ¥å£å¹¶åˆå§‹åŒ– es8311 èŠ¯ç‰‡</strong></li>
<li><code>pca9557_init()</code> å‡½æ•°åˆå§‹åŒ– IO æ‰©å±•èŠ¯ç‰‡ pca9557</li>
<li><code>pa_en()</code> å‡½æ•°ç”¨äºæ§åˆ¶éŸ³é¢‘åŠŸæ”¾çš„æ‰“å¼€å’Œå…³é—­ï¼ŒIO1å¼•è„š</li>
<li><code>i2s_music()</code> å‡½æ•°æ˜¯åˆ›å»ºçš„ä»»åŠ¡å‡½æ•°ï¼Œç”¨äºæ’­æ”¾éŸ³ä¹</li>
</ol>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_INPUT_PORT              0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_OUTPUT_PORT             0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_POLARITY_INVERSION_PORT 0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_CONFIGURATION_PORT      0x03</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_CS_GPIO                 BIT(0)    <span class="comment">// PCA9557_GPIO_NUM_1</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PA_EN_GPIO                  BIT(1)    <span class="comment">// PCA9557_GPIO_NUM_2</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DVP_PWDN_GPIO               BIT(2)    <span class="comment">// PCA9557_GPIO_NUM_3</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_SENSOR_ADDR   0x19        <span class="comment">/*!&lt; Slave address of the MPU9250 sensor */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_BITS(_m, _s, _v)  ((_v) ? (_m)|((_s)) : (_m)&amp;~((_s)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pca9557_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lcd_cs</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pa_en</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dvp_pwdn</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–PCA9557 IOæ‰©å±•èŠ¯ç‰‡</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pca9557_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å†™å…¥æ§åˆ¶å¼•è„šé»˜è®¤å€¼ DVP_PWDN=1  PA_EN = 0  LCD_CS = 1</span></span><br><span class="line">    pca9557_register_write_byte(PCA9557_OUTPUT_PORT, <span class="number">0x05</span>);</span><br><span class="line">    <span class="comment">// æŠŠPCA9557èŠ¯ç‰‡çš„IO1 IO1 IO2è®¾ç½®ä¸ºè¾“å‡º(0) å…¶å®ƒå¼•è„šä¿æŒé»˜è®¤çš„è¾“å…¥(1)</span></span><br><span class="line">    pca9557_register_write_byte(PCA9557_CONFIGURATION_PORT, <span class="number">0xf8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¶²æ™¶æ˜¾ç¤ºst7789ft6557"><a class="markdownIt-Anchor" href="#æ¶²æ™¶æ˜¾ç¤ºst7789ft6557"></a> æ¶²æ™¶æ˜¾ç¤ºï¼ˆST7789+FT6557ï¼‰</h2>
<p><strong>ä½¿ç”¨SPIé©±åŠ¨</strong>ï¼Œå­˜å‚¨åˆ°SPIRAMä¸­</p>
<p>æ¶²æ™¶å±æ˜¾ç¤ºçš„å¼€å…³æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ <code>esp_lcd_panel_disp_on_off()</code>ï¼Œä¸€ä¸ªæ˜¯ <code>bsp_display_backlight_on()</code></p>
<p>åŒºåˆ«ï¼š</p>
<p><code>esp_lcd_panel_disp_on_off()</code> ç”¨æ¥æ§åˆ¶çš„æ˜¯æ¶²æ™¶å±çš„é©±åŠ¨èŠ¯ç‰‡ ST7789 ä¸­çš„å¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨<strong>æ§åˆ¶æ¶²æ™¶å±æ˜¾ç¤º</strong>ä¸å¦ã€‚</p>
<p><code>bsp_display_backlight_on()</code> ç”¨æ¥æ§åˆ¶æ¶²æ™¶å± LED èƒŒå…‰ï¼Œé€šè¿‡<strong>è°ƒèŠ‚ PWM å ç©ºæ¯”è°ƒèŠ‚äº®åº¦</strong>ï¼Œä½¿ç”¨çš„æ˜¯ LEDC å¤–è®¾äº§ç”Ÿçš„ PWM ä¿¡å·ã€‚</p>
<p><code>esp_lcd_panel_swap_xy()</code> å‡½æ•°æ§åˆ¶ xy åæ ‡ç¿»è½¬ï¼Œç¬¬ 2 ä¸ªå‚æ•°ï¼Œtrue è¡¨ç¤ºç¿»è½¬ï¼Œfalse è¡¨ç¤ºä¸ç¿»è½¬ã€‚</p>
<p><code>esp_lcd_panel_mirror()</code> å‡½æ•°æ§åˆ¶ xy æ–¹å‘æ˜¯å¦é•œåƒã€‚ç¬¬ 2 ä¸ªå‚æ•°æ§åˆ¶ x æ–¹å‘ï¼Œç¬¬ 3 ä¸ªå‚æ•°æ§åˆ¶ y æ–¹å‘ï¼Œtrue è¡¨ç¤ºé•œåƒï¼Œfalse è¡¨ç¤ºä¸é•œåƒã€‚</p>
<h3 id="å®éªŒ"><a class="markdownIt-Anchor" href="#å®éªŒ"></a> å®éªŒ</h3>
<p>IO42 å¼•è„šæ§åˆ¶æ¶²æ™¶å±çš„èƒŒå…‰ï¼Œ<strong>ä½ç”µå¹³äº®</strong>ï¼Œå¦‚æœ <strong>IO42 å¼•è„šè¾“å‡º PWM ä¿¡å·</strong>ï¼Œå°±å¯ä»¥é€šè¿‡è°ƒèŠ‚å ç©ºæ¯”ï¼Œå‡åŒ€çš„<strong>æ§åˆ¶æ¶²æ™¶å±çš„èƒŒå…‰äº®åº¦</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_BACKLIGHT     (GPIO_NUM_42)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_LEDC_CH          LEDC_CHANNEL_0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_PIXEL_CLOCK_HZ     (80 * 1000 * 1000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_NUM            (SPI3_HOST)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_CMD_BITS               (8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_PARAM_BITS             (8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_BITS_PER_PIXEL     (16)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_MOSI      (GPIO_NUM_40)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_CLK       (GPIO_NUM_41)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_CS        (GPIO_NUM_NC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_DC            (GPIO_NUM_39)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_RST           (GPIO_NUM_NC)</span></span><br></pre></td></tr></table></figure>
<p><strong>äº®åº¦è°ƒèŠ‚å‡½æ•°</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">esp_err_t</span> <span class="title function_">bsp_display_brightness_set</span><span class="params">(<span class="type">int</span> brightness_percent)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (brightness_percent &gt; <span class="number">100</span>) &#123;</span><br><span class="line">        brightness_percent = <span class="number">100</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (brightness_percent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        brightness_percent = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ESP_LOGI(TAG, <span class="string">&quot;Setting LCD backlight: %d%%&quot;</span>, brightness_percent);</span><br><span class="line">    <span class="comment">// LEDC resolution set to 10bits, thus: 100% = 1023</span></span><br><span class="line">    <span class="type">uint32_t</span> duty_cycle = (<span class="number">1023</span> * brightness_percent) / <span class="number">100</span>;</span><br><span class="line">    BSP_ERROR_CHECK_RETURN_ERR(ledc_set_duty(LEDC_LOW_SPEED_MODE, LCD_LEDC_CH, duty_cycle));</span><br><span class="line">    BSP_ERROR_CHECK_RETURN_ERR(ledc_update_duty(LEDC_LOW_SPEED_MODE, LCD_LEDC_CH));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ESP_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ‘„åƒå¤´gc0308"><a class="markdownIt-Anchor" href="#æ‘„åƒå¤´gc0308"></a> æ‘„åƒå¤´ï¼ˆGC0308ï¼‰</h2>
<p>ä¸€èˆ¬ <strong>500W åƒç´ ä»¥ä¸‹</strong>çš„æ‘„åƒå¤´æ¨¡å—ï¼Œä½¿ç”¨ <strong>DVP æ¥å£</strong>ï¼Œ<strong>ä»¥ä¸Šçš„ä½¿ç”¨ MIPI æ¥å£</strong>ã€‚MIPI æ¥å£é€Ÿåº¦è¦é«˜äº DVP æ¥å£ã€‚</p>
<p>GC0308 æ‘„åƒå¤´æœ€å¤§åˆ†è¾¨ç‡ 640 * 480ï¼Œ30W åƒç´ ï¼Œå·¥ä½œåœ¨ 24MHz é¢‘ç‡ä¸‹ï¼Œè¾“å‡º 240 *320 åˆ†è¾¨ç‡æ—¶ï¼Œå¯è¾¾ 30 å¸§ã€‚</p>
<h3 id="å®éªŒ-2"><a class="markdownIt-Anchor" href="#å®éªŒ-2"></a> å®éªŒ</h3>
<p>PWDN å¼•è„šæ§åˆ¶æ‘„åƒå¤´è¿›å…¥å¾…æœºæ¨¡å¼å’Œå·¥ä½œæ¨¡å¼ï¼Œ<strong>é«˜ç”µå¹³è¿›å…¥å¾…æœºæ¨¡å¼</strong>ï¼Œ<strong>ä½ç”µå¹³è¿›å…¥å·¥ä½œæ¨¡å¼</strong></p>
<p><code>.ledc_channel</code> å’Œ <code>.ledc_timer</code>ä¸­ï¼ŒLEDC å¤–è®¾ç”¨æ¥ç»™æŸä¸ªå¼•è„šäº§ç”Ÿ PWM ä¿¡å·ï¼Œè¿™é‡Œå¯ä»¥ç”¨æ¥äº§ç”Ÿæ—¶é’Ÿä¿¡å·ç»™æ‘„åƒå¤´çš„ XCLK å¼•è„šã€‚ä½†æ˜¯ <strong>S3 èŠ¯ç‰‡ç”¨ä¸ç€</strong>ï¼Œå› ä¸º S3 èŠ¯ç‰‡çš„ CAM å¤–è®¾ä¼šäº§ç”Ÿ XCLK ä¿¡å·ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œçœ‹ ESP32-S3 çš„æŠ€æœ¯å‚è€ƒæ‰‹å†Œå¯ä»¥äº†è§£åˆ°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®©æ‘„åƒå¤´æ˜¾ç¤ºåˆ°LCD</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_camera_lcd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    xQueueLCDFrame = xQueueCreate(<span class="number">2</span>, <span class="keyword">sizeof</span>(<span class="type">camera_fb_t</span> *));</span><br><span class="line">    xTaskCreatePinnedToCore(task_process_camera, <span class="string">&quot;task_process_camera&quot;</span>, <span class="number">3</span> * <span class="number">1024</span>, <span class="literal">NULL</span>, <span class="number">5</span>, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">    xTaskCreatePinnedToCore(task_process_lcd, <span class="string">&quot;task_process_lcd&quot;</span>, <span class="number">4</span> * <span class="number">1024</span>, <span class="literal">NULL</span>, <span class="number">5</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºäº†ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€ä¸ªä»»åŠ¡æ˜¯æ‘„åƒå¤´è·å–ç”»é¢çš„ä»»åŠ¡ï¼Œä¸€ä¸ªæ˜¯æ¶²æ™¶å±æ˜¾ç¤ºç”»é¢çš„ä»»åŠ¡ã€‚å…¶ä¸­ï¼Œè¿˜åˆ›å»ºäº†ä¸€ä¸ªé˜Ÿåˆ—ä¿¡å·ï¼Œæ‘„åƒå¤´è·å–åˆ°ç”»é¢ï¼Œå‘é€é˜Ÿåˆ—ä¿¡å·é€šçŸ¥ LCD æ˜¾ç¤ºã€‚<strong>ESP32S3 æ˜¯åŒæ ¸å¤„ç†å™¨</strong>ï¼Œè¿™ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€ä¸ªå®šä¹‰åœ¨ CPU0 ä¸Šè¿è¡Œï¼Œä¸€ä¸ªå®šä¹‰åœ¨ CPU1 ä¸Šè¿è¡Œï¼Œè¿™æ ·å¯ä»¥æé«˜è¿è¡Œé€Ÿåº¦ã€‚xTaskCreatePinnedToCore()å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°ï¼Œç”¨æ¥å®šä¹‰åœ¨å“ªä¸ª CPU ä¸Šè¿è¡Œã€‚</p>
<p><strong>esp_camera_fb_get()å‡½æ•°</strong>ç”¨æ¥è·å–ä¸€å¸§æ‘„åƒå¤´å›¾åƒï¼Œå¹¶æŠŠè·å–åˆ°çš„ä¸€å¸§ä¿¡æ¯è¿”å›</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_PWDN -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_RESET -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_XCLK 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_SIOD 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_SIOC 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D7 9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D6 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D5 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D4 15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D3 17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D2 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D1 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D0 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_VSYNC 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_HREF 46</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_PCLK 7</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XCLK_FREQ_HZ 24000000</span></span><br></pre></td></tr></table></figure>
<h2 id="lvgl"><a class="markdownIt-Anchor" href="#lvgl"></a> LVGL</h2>
<p>LVGLï¼ˆLight and Versatile Graphics Libraryï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å›¾å½¢ç”¨æˆ·ç•Œé¢åº“ï¼Œæ—¨åœ¨ä¸ºåµŒå…¥å¼ç³»ç»Ÿæä¾›è½»é‡çº§ã€å¯ç§»æ¤ã€çµæ´»ä¸”æ˜“äºä½¿ç”¨çš„å›¾å½¢ç”¨æˆ·ç•Œé¢è§£å†³æ–¹æ¡ˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¼€å‘æ¿æ˜¾ç¤ºåˆå§‹åŒ–</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bsp_lvgl_start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–LVGL */</span></span><br><span class="line">    <span class="type">lvgl_port_cfg_t</span> lvgl_cfg = ESP_LVGL_PORT_INIT_CONFIG();</span><br><span class="line">    lvgl_port_init(&amp;lvgl_cfg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–æ¶²æ™¶å± å¹¶æ·»åŠ LVGLæ¥å£ï¼Œè‡ªå·±å†™ */</span></span><br><span class="line">    disp = bsp_display_lcd_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–è§¦æ‘¸å± å¹¶æ·»åŠ LVGLæ¥å£ï¼Œè‡ªå·±å†™ */</span></span><br><span class="line">    disp_indev = bsp_display_indev_init(disp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ‰“å¼€æ¶²æ™¶å±èƒŒå…‰ */</span></span><br><span class="line">    bsp_display_backlight_on();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    bsp_i2c_init();  		<span class="comment">// I2Cåˆå§‹åŒ–</span></span><br><span class="line">    pca9557_init();  		<span class="comment">// IOæ‰©å±•èŠ¯ç‰‡åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    bsp_lvgl_start(); 		<span class="comment">// åˆå§‹åŒ–lvglæ˜¾ç¤º</span></span><br><span class="line">    lv_demo_benchmark(); 	<span class="comment">// è°ƒç”¨lvgl demo</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="é…ç½®"><a class="markdownIt-Anchor" href="#é…ç½®"></a> é…ç½®</h1>
<h2 id="åŸºç¡€é…ç½®"><a class="markdownIt-Anchor" href="#åŸºç¡€é…ç½®"></a> åŸºç¡€é…ç½®</h2>
<ul>
<li>
<p><strong>Flash = 16MB</strong></p>
</li>
<li>
<p>è¦å­˜å‚¨MP3æ–‡ä»¶ï¼Œéœ€è¦è®¾ç½®FATæ–‡ä»¶ç³»ç»Ÿï¼Œ<strong>Default block size = 4096</strong></p>
</li>
<li>
<p>ä½¿ç”¨SPIï¼Œéœ€è¦è®¾ç½®SPIRAMï¼Œ<strong>åº”ç”¨å¤–å­˜ï¼ŒOctalï¼ˆ8çº¿SPIï¼‰ Mode PSRAMï¼Œ80MHz clock speed</strong></p>
</li>
<li>
<p>è°ƒç”¨æ‘„åƒå¤´ï¼Œè®¾ç½®<strong>CPUé¢‘ç‡ä¸º240MHz</strong>ï¼Œè¿˜æœ‰å¦‚ä¸‹</p>
<img src="https://s2.loli.net/2025/05/09/zKmQhEqObg7tDY4.png" style="zoom:67%;" />
</li>
<li>
<p>ä½¿ç”¨LVGLï¼Œéœ€è¦<strong>è®¾ç½®åè½¬é¢œè‰²</strong>ï¼ŒColor settingsä¸‹çš„Swap the 2 bytes ofâ€¦<strong>æ‰“å‹¾</strong></p>
</li>
<li>
<p>è®¾ç½®å…¶ä»–å­—ä½“ï¼ŒFont usageå¯ä»¥å¼€å¯ <strong>Enable Monserrat 24</strong>ç­‰</p>
</li>
</ul>
<h2 id="ymlæ–‡ä»¶"><a class="markdownIt-Anchor" href="#ymlæ–‡ä»¶"></a> ymlæ–‡ä»¶</h2>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">lvgl/lvgl:</span> <span class="string">~8.3.0</span></span><br><span class="line">  <span class="attr">espressif/esp_lvgl_port:</span> <span class="string">~1.4.0</span>             <span class="comment"># LVGLæ¥å£</span></span><br><span class="line">  <span class="attr">espressif/esp_lcd_touch_ft5x06:</span> <span class="string">~1.0.6</span>      <span class="comment"># è§¦æ‘¸å±é©±åŠ¨</span></span><br><span class="line">  <span class="attr">chmorgan/esp-audio-player:</span> <span class="string">~1.0.7</span>           <span class="comment"># éŸ³é¢‘æ’­æ”¾</span></span><br><span class="line">  <span class="attr">chmorgan/esp-file-iterator:</span> <span class="number">1.0</span><span class="number">.0</span>           <span class="comment"># è·å–æ–‡ä»¶</span></span><br><span class="line">  <span class="attr">espressif/esp_codec_dev:</span> <span class="string">~1.3.0</span>             <span class="comment"># éŸ³é¢‘é©±åŠ¨</span></span><br><span class="line">  <span class="attr">espressif/esp-sr:</span> <span class="string">~1.6.0</span>                    <span class="comment"># è¯­éŸ³è¯†åˆ«</span></span><br><span class="line">  <span class="attr">espressif/zlib:</span> <span class="string">^1.3.0</span></span><br><span class="line">  <span class="attr">espressif/esp32-camera:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="comment">## Required IDF version</span></span><br><span class="line">  <span class="attr">idf:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">~5.2.5</span></span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<p><a href="https://wiki.lckfb.com/zh-hans/szpi-esp32s3/download-center.html">ã€ä¸‹è½½ä¸­å¿ƒã€‘å®æˆ˜æ´¾ | ç«‹åˆ›å¼€å‘æ¿æŠ€æœ¯æ–‡æ¡£ä¸­å¿ƒ</a></p>
<p><a href="https://blog.csdn.net/MJiarong_personal/article/details/121726585">ã€ESP32-S3çš„å¼€å‘ã€‘| 1.åˆè¯† ESP32-S3_esp32s3å¼•è„šå›¾è¯¦ç»†è§£é‡Š-CSDNåšå®¢</a></p>
<p><a href="https://gitee.com/gsm-wheather-project/gsm-weather-esp32s3-esp-idf5.0/tree/master/components">components Â· GSM-Weather-project/gsm-weather-esp32s3-esp-idf5.0 - ç äº‘ - å¼€æºä¸­å›½</a></p>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>ESP</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>Bootloaderå­¦ä¹ ç¬”è®°</title>
    <url>/2025/05/10/Bootloader%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="bootloaderiap"><a class="markdownIt-Anchor" href="#bootloaderiap"></a> Bootloader+IAP</h1>
<h2 id="ç®€è¦è¯´æ˜"><a class="markdownIt-Anchor" href="#ç®€è¦è¯´æ˜"></a> ç®€è¦è¯´æ˜</h2>
<p>æœ¬å­¦ä¹ ç¬”è®°ä¸»è¦åŒ…æ‹¬<strong>STM32F103C8T6</strong>ä¸‹çš„Bootloader+IAP</p>
<p><strong>Bootloader</strong>ï¼šç”¨äºæ›´æ–°APPçš„ç¨‹åº</p>
<p><strong>IAP</strong>ï¼šåœ¨è®¾å¤‡è¿è¡Œæ—¶ï¼Œç”±Bootloaderå¼•å¯¼å¯¹è‡ªèº«ç¨‹åºæ“¦å†™</p>
<p><strong>OTA</strong>ï¼šæ— çº¿é€šä¿¡å°†æ–°çš„å›ºä»¶ä¸‹è½½åˆ°è®¾å¤‡ä¸­ï¼ˆOver The Airï¼‰</p>
<h3 id="è¯´æ˜"><a class="markdownIt-Anchor" href="#è¯´æ˜"></a> è¯´æ˜</h3>
<p><strong>ä½¿ç”¨çš„APPæ•°æ®ï¼ŒOTAæ ‡å¿—ä½ï¼Œç‰ˆæœ¬å·å­˜å‚¨åœ¨AT24C02</strong></p>
<p><strong>å¤šä¸ªå¤‡ä»½APPæ•°æ®å­˜å‚¨åœ¨W25Q64</strong></p>
<p>Qï¼šå·²ç»æ“ä½œäº†AT24C02å’ŒW25Q64ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æ“ä½œå•ç‰‡æœºä¸Šçš„SRAMï¼Ÿ</p>
<p>Aï¼šAT24C02å’ŒFlashè¯»å†™å¤ªæ…¢ï¼Œè·Ÿä¸ä¸ŠCPUçš„é€Ÿåº¦ï¼Œ<strong>SRAMæ˜¯ä¸´æ—¶ã€é«˜é€Ÿçš„æ•°æ®äº¤æ¢åŒº</strong>ã€‚</p>
<h2 id="æ•´ä½“æµç¨‹å›¾"><a class="markdownIt-Anchor" href="#æ•´ä½“æµç¨‹å›¾"></a> æ•´ä½“æµç¨‹å›¾</h2>
<p><img src="https://s2.loli.net/2025/05/10/ADCErlteIk9JBR4.png" alt="" /></p>
<h2 id="åˆ†åŒº"><a class="markdownIt-Anchor" href="#åˆ†åŒº"></a> åˆ†åŒº</h2>
<p>AåŒºå­˜æ”¾APPï¼ŒBåŒºå­˜æ”¾Bootloaderç¨‹åºã€‚<strong>OTA_Flagè¡¨ç¤ºæ˜¯å¦æ›´æ–°APPï¼Œå­˜æ”¾åœ¨AT24C02ä¸­</strong></p>
<ol>
<li>
<p>âŒï¸**| A | B |**------&gt;ç¨‹åºè¿è¡Œåï¼Œå…ˆè¿›å…¥AåŒºï¼›è‹¥OTA_Flag=1å¼€å§‹æ›´æ–°æ•°æ®ï¼Œå½“æ­£åœ¨æ›´æ–°çš„AåŒºå‡ºç°å¼‚å¸¸é€€å‡ºï¼Œä¸‹ä¸€æ¬¡ä¸Šç”µåè¿è¡ŒAå‘ç°ç¨‹åºä¸å…¨ï¼Œæ— æ³•å†è¿›å…¥BåŒºè¿›è¡Œåç»­æ›´æ–°AåŒºçš„æ“ä½œï¼Œå¹¶ä¸”ä¹‹å‰çš„AåŒºç¨‹åºæœ‰å‡ºç°é—®é¢˜ï¼Œ<strong>æ‚²æŠ¥ï¼Œæˆç –å¤´äº†</strong>ã€‚</p>
</li>
<li>
<p>âœ”ï¸**| B | A |**------&gt;ç¨‹åºè¿è¡Œåï¼Œå…ˆè¿›å…¥BåŒºï¼Œè§‚æµ‹åˆ°OTA_Flag=1åå¯¹AåŒºè¿›è¡Œæ•°æ®æ›´æ–°ï¼Œå³ä½¿å¼‚å¸¸é€€å‡ºï¼Œåç»­ä»ç„¶å¯ä»¥è¿›å…¥BåŒºå¯¹AåŒºè¿›è¡Œæ›´æ–°ï¼Œæ›´æ–°å®Œæˆåç½®OTA_Flag=0ã€‚</p>
</li>
</ol>
<h2 id="æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆ"></a> æ–¹æ¡ˆ</h2>
<p>ğŸ¦<strong>DMA + ç©ºé—²ä¸­æ–­</strong></p>
<p>åœ¨æ— éœ€CPUå¸®åŠ©ä¸‹ï¼Œ<strong>DMA</strong>è´Ÿè´£å¤–è®¾ä¸å¯„å­˜å™¨ä¹‹é—´<strong>æ•°æ®ä¼ è¾“</strong></p>
<p><strong>ç©ºé—²ä¸­æ–­</strong>ï¼ˆIDLEï¼‰æ˜¯ä¸²å£é€šä¿¡ä¸­<strong>åˆ¤æ–­â€œæ¥æ”¶å®Œæˆâ€çš„ç»å…¸æ–¹å¼</strong></p>
<p><strong>ç¯å½¢ç¼“å†²åŒº</strong>ï¼š<strong>æ•°æ®ä¼ è¾“</strong>è¿‡ç¨‹ä¸­ï¼Œ<strong>æ¥æ”¶é€Ÿåº¦å’Œå¤„ç†é€Ÿåº¦ä¸ä¸€å®šä¸€è‡´</strong>ï¼Œå› æ­¤<strong>éœ€è¦ç¼“å†²åŒºå…ˆä¿å­˜æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±</strong>ï¼›ä¸€ç»´æ•°ç»„ï¼Œç¡®è®¤<strong>å•æ¬¡æ¥æ”¶æœ€å¤§é‡</strong>ï¼Œé˜²æ­¢å‡ºç°è¶Šç•Œé—®é¢˜</p>
<p><strong>ç¼“å†²åŒºçš„æ„ä¹‰</strong>ï¼šDMAä¼šä¸€ç›´ç­‰å¾…ç¼“å†²åŒºè¢«å¡«æ»¡æ‰èƒ½å®Œæˆæ¥æ”¶ï¼›è€Œå®é™…é€šä¿¡ä¸­æ•°æ®å¾€å¾€é•¿åº¦ä¸å®šï¼Œå› æ­¤éœ€è¦é…åˆ UART çš„ç©ºé—²ä¸­æ–­æ¥è¯†åˆ«æ•°æ®ç»“æŸï¼Œæå‰å¤„ç†æ¥æ”¶ç¼“å†²åŒºå†…å®¹ï¼Œé˜²æ­¢æ•°æ®æ»ç•™æˆ–ä¸¢å¤±ã€‚</p>
<p><strong>SEæŒ‡é’ˆå¯¹ï¼ˆç¯å½¢ç¼“å†²ï¼‰</strong>ï¼šç¼“å†²åŒºæ˜¯ä¸€ç»´æ•°ç»„ï¼Œæ€»é•¿åº¦ä¸º 2048 Byteï¼Œåˆ’åˆ†ä¸º10ä¸ªæ•°æ®å—ï¼Œæ¯ä¸ªæ•°æ®å—200 Byteã€‚é€šè¿‡ä¸¤ä¸ªæŒ‡é’ˆ INï¼ˆç”Ÿäº§è€…æŒ‡é’ˆï¼‰å’Œ OUTï¼ˆæ¶ˆè´¹è€…æŒ‡é’ˆï¼‰ç®¡ç†ç¼“å†²åŒºçš„è¯»å†™æ“ä½œã€‚å½“ IN â‰  OUT æ—¶ï¼Œè¡¨ç¤ºç¼“å†²åŒºä¸­å­˜åœ¨å¾…å¤„ç†çš„æ•°æ®åŒ…ã€‚æŒ‡é’ˆæ¯æ¬¡ç§»åŠ¨ä¸€ä¸ªæ•°æ®å—ï¼ˆ200å­—èŠ‚ï¼‰ï¼Œå½“æŒ‡é’ˆåˆ°è¾¾ç¼“å†²åŒºæœ«å°¾æ—¶è‡ªåŠ¨å›å·åˆ°èµ·å§‹ä½ç½®ï¼Œå®ç°ç¯å½¢ç¼“å†²æœºåˆ¶ã€‚</p>
<p><img src="https://s2.loli.net/2025/07/26/ic8CNdYyWEVsgkx.png" alt="" /></p>
<p>â—TIPï¼šæ¯æ¬¡æ¥æ”¶åï¼Œéƒ½<strong>éœ€è¦åˆ¤æ–­å‰©ä½™ç©ºé—´</strong>ï¼Œä»¥é˜²å†…å­˜ä¸è¶³ï¼ŒåŠæ—¶å›å·ï¼›éœ€è¦è®°å½•å·²ç»å­˜æ”¾çš„<strong>ç´¯åŠ å€¼</strong></p>
<h2 id="ç¼–ç¨‹"><a class="markdownIt-Anchor" href="#ç¼–ç¨‹"></a> ç¼–ç¨‹</h2>
<p>STM32F103C8T6ä½¿ç”¨å¤–éƒ¨é«˜é€Ÿæ—¶é’ŸHSEï¼Œ8MHzï¼›é€šè¿‡PLLï¼ˆå€é¢‘é”ç›¸ç¯ï¼‰å¯ä»¥è¾¾åˆ°72MHz</p>
<h3 id="ä¸²å£ä¸dma"><a class="markdownIt-Anchor" href="#ä¸²å£ä¸dma"></a> ä¸²å£ä¸DMA</h3>
<h5 id="hç¨‹åº"><a class="markdownIt-Anchor" href="#hç¨‹åº"></a> .hç¨‹åº</h5>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç¼“å†²åŒºå¤§å°å®šä¹‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> URx_SIZE 2048           <span class="comment">// æ¥æ”¶ç¼“å†²åŒºæ€»å¤§å°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UTx_SIZE 2048           <span class="comment">// å‘é€ç¼“å†²åŒºå¤§å°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> URx_MAX 256             <span class="comment">// å•æ¬¡DMAæ¥æ”¶æœ€å¤§å­—èŠ‚æ•°</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 8                  <span class="comment">// æ¥æ”¶æ•°æ®åŒ…é˜Ÿåˆ—æ·±åº¦</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> URx_Buff[URx_SIZE];</span><br><span class="line"><span class="type">uint8_t</span> UTx_Buff[UTx_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸä¸€ç»„æ•°æ®æ¥æ”¶å¼€å§‹ä¸ç»“æŸï¼Œ startï¼šå¼€å§‹ï¼Œ endï¼šç»“å°¾</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">uint8_t</span> *start;             <span class="comment">// æ•°æ®åŒ…èµ·å§‹åœ°å€</span></span><br><span class="line">	<span class="type">uint8_t</span> *end;               <span class="comment">// æ•°æ®åŒ…ç»“æŸåœ°å€</span></span><br><span class="line">&#125;UCB_URxBuff;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç®¡ç†ä¸²å£æ¥æ”¶æ•°æ®</span></span><br><span class="line"><span class="comment">   URxCounter	å½“å‰ç¼“å†²åŒºä¸­æœªå¤„ç†çš„æ•°æ®é‡</span></span><br><span class="line"><span class="comment">   URxDataPtr	ç¼“å†²åŒºå­˜å‚¨æ•°ç»„åºå·</span></span><br><span class="line"><span class="comment">   URxDataIN	æŒ‡å‘ä¸‹ä¸€ç»„å¯å†™å…¥æ•°æ®çš„ä½ç½®</span></span><br><span class="line"><span class="comment">   URxDataOUT	æŒ‡å‘ä¸‹ä¸€ä¸ªå¾…è¯»å–æ•°æ®çš„ä½ç½®</span></span><br><span class="line"><span class="comment">   URxDataEND	æŒ‡å‘æ•°ç»„æœ«å°¾	*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">uint16_t</span> URxCounter;        <span class="comment">// æ¥æ”¶è®¡æ•°å™¨ï¼Œè®°å½•å½“å‰æ¥æ”¶ä½ç½®</span></span><br><span class="line">	UCB_URxBuff URxDataPtr[NUM]; <span class="comment">// æ•°æ®åŒ…æŒ‡é’ˆæ•°ç»„ï¼ˆç¯å½¢é˜Ÿåˆ—ï¼‰</span></span><br><span class="line">	UCB_URxBuff *URxDataIN;     <span class="comment">// è¾“å…¥æŒ‡é’ˆï¼ˆç”Ÿäº§è€…ï¼‰</span></span><br><span class="line">	UCB_URxBuff *URxDataOUT;    <span class="comment">// è¾“å‡ºæŒ‡é’ˆï¼ˆæ¶ˆè´¹è€…ï¼‰</span></span><br><span class="line">	UCB_URxBuff *URxDataEND;    <span class="comment">// é˜Ÿåˆ—æœ«å°¾æŒ‡é’ˆ</span></span><br><span class="line">&#125;UCB_CB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> UCB_CB UCB;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">uint8_t</span> URx_Buff[URx_SIZE];</span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®ä¸²å£å’Œdma"><a class="markdownIt-Anchor" href="#é…ç½®ä¸²å£å’Œdma"></a> é…ç½®ä¸²å£å’ŒDMA</h4>
<ol>
<li>è®¾ç½®ç›¸å…³<strong>å¤–è®¾æ—¶é’Ÿ</strong></li>
<li>åˆå§‹åŒ–<strong>GPIO(IOåˆ†åŒº,MODE,é¢‘ç‡,IOå£)</strong></li>
<li>é…ç½®<strong>ä¸²å£ï¼ˆåˆå§‹åŒ–ï¼Œæ³¢ç‰¹ç‡ï¼Œæ ¡éªŒï¼Œæ•°æ®ä½é•¿åº¦ï¼Œåœæ­¢ä½ä¸ªæ•°ï¼Œæ¥æ”¶å‘æƒ…å†µï¼‰</strong></li>
<li>é…ç½®<strong>ä¸²å£DMA</strong></li>
<li>æ‰“å¼€<strong>ä¸²å£ä¸­æ–­ï¼ˆIDLEä¸ºç©ºé—²ä¸­æ–­ï¼‰</strong></li>
<li><strong>è°ƒç”¨å…¶ä»–åŠŸèƒ½å‡½æ•°</strong></li>
<li><strong>ä½¿èƒ½ä¸²å£</strong></li>
</ol>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">RCC_USART_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_USART1, ENABLE);</span><br><span class="line">	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1, ENABLE);		<span class="comment">// é…ç½®DMA</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">GPIO_USART_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;<span class="comment">// é…ç½®PA9ä¸ºTXï¼ˆå¤ç”¨æ¨æŒ½è¾“å‡ºï¼‰</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;</span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;<span class="comment">// é…ç½®PA10ä¸ºRXï¼ˆæµ®ç©ºè¾“å…¥ï¼‰</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">NVIC_USART_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// é…ç½®ä¸­æ–­</span></span><br><span class="line">	NVIC_SetPriorityGrouping(NVIC_PriorityGroup_2);</span><br><span class="line">		</span><br><span class="line">	NVIC_InitTypeDef NVIC_InitStructure;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = <span class="number">0</span>;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = <span class="number">0</span>;</span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DMA_USART_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	DMA_InitTypeDef DMA_InitStructure;</span><br><span class="line">    <span class="comment">//URx_Buffé•¿åº¦ä¸ºURx_MAXï¼Œæ­¤å¤„+1æ˜¯ä¸ºäº†é…åˆIDLEå®ç°ä¸­æ–­</span></span><br><span class="line">	DMA_InitStructure.DMA_BufferSize = URx_MAX + <span class="number">1</span>;</span><br><span class="line">	DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralSRC;</span><br><span class="line">	DMA_InitStructure.DMA_M2M = DMA_M2M_Disable;</span><br><span class="line">	DMA_InitStructure.DMA_MemoryBaseAddr = (<span class="type">uint32_t</span>)URx_Buff;</span><br><span class="line">	DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_Byte;</span><br><span class="line">	DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable;</span><br><span class="line">	DMA_InitStructure.DMA_Mode = DMA_Mode_Normal;</span><br><span class="line">	DMA_InitStructure.DMA_PeripheralBaseAddr = (<span class="type">uint32_t</span>)&amp;USART1-&gt;DR;</span><br><span class="line">	DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_Byte;</span><br><span class="line">	DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable;</span><br><span class="line">	DMA_InitStructure.DMA_Priority = DMA_Priority_High;</span><br><span class="line">	DMA_Init(DMA1_Channel5, &amp;DMA_InitStructure);</span><br><span class="line">	</span><br><span class="line">	DMA_Cmd(DMA1_Channel5, ENABLE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// USART1åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">USART1_Init</span><span class="params">(<span class="type">uint32_t</span> band)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ä½¿èƒ½æ—¶é’Ÿ</span></span><br><span class="line">	RCC_USART_Init();</span><br><span class="line">	GPIO_USART_Init();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// é…ç½®USART1å‚æ•°</span></span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line">	USART_InitStructure.USART_BaudRate = band;</span><br><span class="line">	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;</span><br><span class="line">	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;</span><br><span class="line">	USART_InitStructure.USART_Parity = USART_Parity_No;</span><br><span class="line">	USART_InitStructure.USART_StopBits = USART_StopBits_1;</span><br><span class="line">	USART_InitStructure.USART_WordLength = USART_WordLength_8b;</span><br><span class="line">	USART_Init(USART1, &amp;USART_InitStructure);</span><br><span class="line">	</span><br><span class="line">	USART_DMACmd(USART1, USART_DMAReq_Rx, ENABLE);</span><br><span class="line">	USART_ITConfig(USART1, USART_IT_IDLE, ENABLE);</span><br><span class="line">	</span><br><span class="line">	NVIC_USART_Init();</span><br><span class="line">	DMA_USART_Init();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// åˆå§‹åŒ–ä¸²å£æ§åˆ¶å—</span></span><br><span class="line">	UCB.URxCounter = <span class="number">0</span>;</span><br><span class="line">	UCB.URxDataIN = &amp;UCB.URxDataPtr[<span class="number">0</span>];</span><br><span class="line">	UCB.URxDataOUT = &amp;UCB.URxDataPtr[<span class="number">0</span>];</span><br><span class="line">	UCB.URxDataEND = &amp;UCB.URxDataPtr[NUM - <span class="number">1</span>];</span><br><span class="line">	UCB.URxDataIN-&gt;start = URx_Buff;</span><br><span class="line">	</span><br><span class="line">	USART_Cmd(USART1, ENABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°"><a class="markdownIt-Anchor" href="#ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°"></a> ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°</h4>
<ol>
<li><strong>æ£€æµ‹ç©ºé—²ä¸­æ–­</strong></li>
<li><strong>æ¶ˆé™¤ç©ºé—²ä¸­æ–­æ ‡å¿—ä½</strong>ï¼ˆåªæœ‰è¯»æ ‡å¿—ä½å¯„å­˜å™¨å’Œæ•°æ®ä½å¯„å­˜å™¨æ‰èƒ½å°†ç©ºé—²æ ‡å¿—ä½æ¸…é™¤ï¼‰</li>
<li>åœ¨ç©ºé—²ä¸­æ–­ä¸­<strong>è¯»å–ä¸²å£DMAå¢æ·»æ•°æ®çš„é•¿åº¦</strong>(DMA,é€šé“) â€” counter += (æ€»é‡ - å‰©ä½™ç©ºé—²å€¼)</li>
<li><strong>è®¾ç½®ç¼“å†²åŒºçš„INæŒ‡é’ˆ</strong></li>
<li>Disable DMAï¼Œé‡æ–°é…ç½®DMAï¼ˆDMAï¼Œé€šé“ï¼Œå¤§å°ï¼Œåœ°å€ï¼‰ï¼Œä¿è¯ä¸å‡ºç°å®ŒæˆçŠ¶æ€ï¼Œå†ä½¿èƒ½DMA</li>
</ol>
<p><strong>è¦ä¸€ç›´è®©DMAè¯»å–æ•°æ®ï¼Œç›´åˆ°å‡ºç°ç©ºé—²ä¸­æ–­æ‰ä¼šåœæ­¢ï¼Œå› æ­¤ä¸ä¼šå‡ºç°å®ŒæˆçŠ¶æ€</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief USART1ä¸­æ–­å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param æ— </span></span><br><span class="line"><span class="comment"> * @return æ— </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * å¤„ç†USART1çš„IDLEï¼ˆç©ºé—²ï¼‰ä¸­æ–­ï¼š</span></span><br><span class="line"><span class="comment"> * 1. æ£€æµ‹åˆ°ä¸²å£ç©ºé—²æ—¶ï¼Œè¡¨ç¤ºä¸€ä¸ªæ•°æ®åŒ…æ¥æ”¶å®Œæˆ</span></span><br><span class="line"><span class="comment"> * 2. è®¡ç®—å®é™…æ¥æ”¶çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment"> * 3. æ›´æ–°ç¯å½¢ç¼“å†²åŒºæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * 4. é‡æ–°é…ç½®DMAä¸ºä¸‹ä¸€æ¬¡æ¥æ”¶åšå‡†å¤‡</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * å·¥ä½œæµç¨‹ï¼š</span></span><br><span class="line"><span class="comment"> * - IDLEä¸­æ–­è§¦å‘ -&gt; æ•°æ®åŒ…æ¥æ”¶å®Œæˆ</span></span><br><span class="line"><span class="comment"> * - è®¡ç®—æ¥æ”¶é•¿åº¦ -&gt; æ›´æ–°æ•°æ®åŒ…ç»“æŸæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * - ç§»åŠ¨è¾“å…¥æŒ‡é’ˆ -&gt; å¤„ç†ç¯å½¢ç¼“å†²åŒºç»•å›</span></span><br><span class="line"><span class="comment"> * - é‡å¯DMAæ¥æ”¶ -&gt; å‡†å¤‡æ¥æ”¶ä¸‹ä¸€ä¸ªæ•°æ®åŒ…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">USART1_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// æ£€æŸ¥IDLEä¸­æ–­æ ‡å¿—ä½</span></span><br><span class="line">	<span class="keyword">if</span>(USART_GetFlagStatus(USART1, USART_FLAG_IDLE) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// æ¸…é™¤IDLEä¸­æ–­æ ‡å¿—ä½</span></span><br><span class="line">		USART_ClearFlag(USART1, USART_FLAG_IDLE);</span><br><span class="line">		<span class="comment">// è¯»å–æ•°æ®å¯„å­˜å™¨ä»¥æ¸…é™¤IDLEæ ‡å¿—ï¼ˆå¿…é¡»æ“ä½œï¼‰</span></span><br><span class="line">		USART_ReceiveData(USART1);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// è®¡ç®—æœ¬æ¬¡æ¥æ”¶çš„æ•°æ®é•¿åº¦å¹¶æ›´æ–°æ¥æ”¶è®¡æ•°å™¨</span></span><br><span class="line">		UCB.URxCounter += (URx_MAX + <span class="number">1</span>) - DMA_GetCurrDataCounter(DMA1_Channel5);</span><br><span class="line">		<span class="comment">// è®¾ç½®å½“å‰æ•°æ®åŒ…çš„ç»“æŸåœ°å€</span></span><br><span class="line">		UCB.URxDataIN-&gt;end = &amp;URx_Buff[UCB.URxCounter - <span class="number">1</span>];</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// ç§»åŠ¨è¾“å…¥æŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªæ•°æ®åŒ…ä½ç½®</span></span><br><span class="line">		UCB.URxDataIN++;</span><br><span class="line">		<span class="comment">// æ£€æŸ¥æ˜¯å¦åˆ°è¾¾é˜Ÿåˆ—æœ«å°¾ï¼Œè¿›è¡Œç¯å½¢å¤„ç†</span></span><br><span class="line">		<span class="keyword">if</span>(UCB.URxDataIN == UCB.URxDataEND)</span><br><span class="line">		&#123;</span><br><span class="line">			UCB.URxDataIN = &amp;UCB.URxDataPtr[<span class="number">0</span>];     <span class="comment">// å›åˆ°é˜Ÿåˆ—å¼€å¤´</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// æ£€æŸ¥å‰©ä½™ç¼“å†²åŒºç©ºé—´ï¼Œå†³å®šä¸‹ä¸€æ¬¡DMAæ¥æ”¶çš„èµ·å§‹åœ°å€</span></span><br><span class="line">		<span class="keyword">if</span>(URx_SIZE - UCB.URxCounter &gt;= URx_MAX)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// å‰©ä½™ç©ºé—´è¶³å¤Ÿï¼Œç»§ç»­åœ¨å½“å‰ä½ç½®æ¥æ”¶</span></span><br><span class="line">			UCB.URxDataIN-&gt;start = &amp;URx_Buff[UCB.URxCounter];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// å‰©ä½™ç©ºé—´ä¸è¶³ï¼Œå›åˆ°ç¼“å†²åŒºå¼€å¤´</span></span><br><span class="line">			UCB.URxDataIN-&gt;start = URx_Buff;</span><br><span class="line">			UCB.URxCounter = <span class="number">0</span>;                     <span class="comment">// é‡ç½®æ¥æ”¶è®¡æ•°å™¨</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// é‡æ–°é…ç½®DMAä¸ºä¸‹ä¸€æ¬¡æ¥æ”¶</span></span><br><span class="line">		DMA_Cmd(DMA1_Channel5, DISABLE);                           <span class="comment">// ç¦ç”¨DMA</span></span><br><span class="line">		DMA_SetCurrDataCounter(DMA1_Channel5, URx_MAX + <span class="number">1</span>);        <span class="comment">// è®¾ç½®ä¼ è¾“è®¡æ•°</span></span><br><span class="line">		DMA1_Channel5-&gt;CMAR = (<span class="type">uint32_t</span>)UCB.URxDataIN-&gt;start;      <span class="comment">// è®¾ç½®å†…å­˜åœ°å€</span></span><br><span class="line">		DMA_Cmd(DMA1_Channel5, ENABLE);                            <span class="comment">// é‡æ–°å¯ç”¨DMA</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç¼–å†™æ–°çš„printfå‡½æ•°"><a class="markdownIt-Anchor" href="#ç¼–å†™æ–°çš„printfå‡½æ•°"></a> ç¼–å†™æ–°çš„Printfå‡½æ•°</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ¼å¼åŒ–æ‰“å°å‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">uprintf</span><span class="params">(<span class="type">char</span> *format, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    va_list list_data;</span><br><span class="line">    va_start(list_data, format);</span><br><span class="line"></span><br><span class="line">    vsnprintf((<span class="type">char</span> *)UTx_Buff, <span class="keyword">sizeof</span>(UTx_Buff), format, list_data);</span><br><span class="line">    va_end(list_data);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint16_t</span> len = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)UTx_Buff);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (USART_GetFlagStatus(USART1, USART_FLAG_TXE) != <span class="number">1</span>);</span><br><span class="line">        USART_SendData(USART1, UTx_Buff[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (USART_GetFlagStatus(USART1, USART_FLAG_TC) != <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="i2c"><a class="markdownIt-Anchor" href="#i2c"></a> I2C</h3>
<p><strong>è½¯ä»¶I2C</strong>ï¼Œå»¶æ—¶éƒ¨åˆ†éœ€è¦è‡ªå·±é‡æ–°è®¾è®¡</p>
<h4 id="hç¨‹åº-2"><a class="markdownIt-Anchor" href="#hç¨‹åº-2"></a> .hç¨‹åº</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SCL_H GPIO_SetBits(GPIOB, GPIO_Pin_3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCL_L GPIO_ResetBits(GPIOB, GPIO_Pin_3)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDA_H GPIO_SetBits(GPIOB, GPIO_Pin_4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDA_L GPIO_ResetBits(GPIOB, GPIO_Pin_4)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Read_SDA GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_4)</span></span><br></pre></td></tr></table></figure>
<h4 id="delay"><a class="markdownIt-Anchor" href="#delay"></a> Delay</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å»¶æ—¶åŠŸèƒ½åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾®ç§’çº§å»¶æ—¶</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(<span class="type">uint16_t</span> us)</span></span><br><span class="line">&#123;</span><br><span class="line">	SysTick_Config(SystemCoreClock / <span class="number">1000000</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(us--)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(!((SysTick-&gt;CTRL) &amp; (SysTick_CTRL_COUNTFLAG)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	SysTick-&gt;CTRL &amp;= ~SysTick_CTRL_ENABLE_Msk;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯«ç§’çº§å»¶æ—¶</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(<span class="type">uint16_t</span> ms)</span></span><br><span class="line">&#123;</span><br><span class="line">	SysTick_Config(SystemCoreClock / <span class="number">1000</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(ms--)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(!((SysTick-&gt;CTRL) &amp; (SysTick_CTRL_COUNTFLAG)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	SysTick-&gt;CTRL &amp;= ~SysTick_CTRL_ENABLE_Msk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åˆå§‹åŒ–-startå’Œstopä¿¡å·"><a class="markdownIt-Anchor" href="#åˆå§‹åŒ–-startå’Œstopä¿¡å·"></a> åˆå§‹åŒ–ã€STARTå’ŒSTOPä¿¡å·</h4>
<ol>
<li>
<p>ç¡¬ä»¶I2Cï¼Œå¼€å¯<strong>æ—¶é’Ÿ</strong></p>
</li>
<li>
<p>é…ç½®<strong>GPIO</strong>ï¼ˆPB6ï¼ŒPB7ï¼Œå¼€æ¼æ¨¡å¼ï¼‰</p>
</li>
<li>
<p>é…ç½®<strong>SCLå’ŒSDA</strong>ä¸¤æ¡çº¿</p>
</li>
</ol>
<p><strong>èµ·å§‹ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»é«˜ç”µå¹³å˜ä¸ºä½ç”µå¹³</p>
<p><strong>åœæ­¢ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»ä½ç”µå¹³å˜ä¸ºé«˜ç”µå¹³</p>
<p><strong>æ•°æ®ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä¿æŒä¸å˜ï¼›<strong>SCLä½ç”µå¹³ï¼ŒSDAç”µå¹³å¯ä»¥ä¿®æ”¹</strong></p>
<p><strong>åº”ç­”ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDA<strong>ä½ç”µå¹³</strong>ï¼Œ<strong>åº”ç­”</strong>ï¼Œå¦åˆ™ï¼Œéåº”ç­”</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">I2C1_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ä½¿èƒ½GPIOBæ—¶é’Ÿ</span></span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);</span><br><span class="line">	</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// é…ç½®SCLå¼•è„šï¼ˆPB3ï¼‰ä¸ºå¼€æ¼è¾“å‡º</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD;   <span class="comment">// å¼€æ¼è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_3;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// é…ç½®SDAå¼•è„šï¼ˆPB4ï¼‰ä¸ºå¼€æ¼è¾“å‡º</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD;   <span class="comment">// å¼€æ¼è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// è®¾ç½®æ€»çº¿åˆå§‹çŠ¶æ€ä¸ºé«˜ç”µå¹³ï¼ˆç©ºé—²çŠ¶æ€ï¼‰</span></span><br><span class="line">	SCL_H;</span><br><span class="line">	SDA_H;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Startä¿¡å· */</span></span><br><span class="line"><span class="comment">// ä¸€æ—¦ Start äº§ç”Ÿåï¼Œæ•°æ®ä¼ è¾“å¿…é¡»åœ¨ SCL ä¸ºä½æ—¶å¼€å§‹ã€‚</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	SCL_H;                              <span class="comment">// ç¡®ä¿SCLä¸ºé«˜ç”µå¹³</span></span><br><span class="line">	SDA_H;                              <span class="comment">// ç¡®ä¿SDAä¸ºé«˜ç”µå¹³</span></span><br><span class="line">	delay_us(<span class="number">2</span>);                        <span class="comment">// å»¶æ—¶ç­‰å¾…ä¿¡å·ç¨³å®š</span></span><br><span class="line">	SDA_L;                              <span class="comment">// SDAå˜ä¸ºä½ç”µå¹³ï¼ˆèµ·å§‹æ¡ä»¶ï¼‰</span></span><br><span class="line">	SCL_L;                              <span class="comment">// SCLå˜ä¸ºä½ç”µå¹³ï¼Œå‡†å¤‡å‘é€æ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Endä¿¡å· */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Stop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	SCL_L;                              <span class="comment">// ç¡®ä¿SCLä¸ºä½ç”µå¹³</span></span><br><span class="line">	SDA_L;                              <span class="comment">// ç¡®ä¿SDAä¸ºä½ç”µå¹³</span></span><br><span class="line">	delay_us(<span class="number">2</span>);                        <span class="comment">// å»¶æ—¶ç­‰å¾…ä¿¡å·ç¨³å®š</span></span><br><span class="line">	SCL_H;                              <span class="comment">// SCLå˜ä¸ºé«˜ç”µå¹³</span></span><br><span class="line">	SDA_H;                              <span class="comment">// SDAå˜ä¸ºé«˜ç”µå¹³ï¼ˆåœæ­¢æ¡ä»¶ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å‘é€ä¸€ä¸ªå­—èŠ‚"><a class="markdownIt-Anchor" href="#å‘é€ä¸€ä¸ªå­—èŠ‚"></a> å‘é€ä¸€ä¸ªå­—èŠ‚</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendByte</span><span class="params">(<span class="type">uint8_t</span> tx)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ä»æœ€é«˜ä½å¼€å§‹å‘é€ï¼ˆMSB firstï¼‰</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int8_t</span> i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">	&#123;</span><br><span class="line">		SCL_L;                              <span class="comment">// SCLç½®ä½ï¼Œå‡†å¤‡è®¾ç½®æ•°æ®</span></span><br><span class="line">		<span class="keyword">if</span>(tx &amp; (<span class="number">1</span> &lt;&lt; i))                   <span class="comment">// æ£€æŸ¥å½“å‰ä½æ˜¯å¦ä¸º1</span></span><br><span class="line">		&#123;</span><br><span class="line">			SDA_H;                          <span class="comment">// å‘é€é€»è¾‘1</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			SDA_L;                          <span class="comment">// å‘é€é€»è¾‘0</span></span><br><span class="line">		&#125;</span><br><span class="line">		delay_us(<span class="number">2</span>);                        <span class="comment">// å»¶æ—¶ç­‰å¾…æ•°æ®ç¨³å®š</span></span><br><span class="line">		SCL_H;                              <span class="comment">// SCLç½®é«˜ï¼Œè®©ä»æœºè¯»å–æ•°æ®</span></span><br><span class="line">		delay_us(<span class="number">2</span>);                        <span class="comment">// å»¶æ—¶ä¿æŒæ—¶é’Ÿé«˜ç”µå¹³</span></span><br><span class="line">	&#125;</span><br><span class="line">	SCL_L;                                  <span class="comment">// å‘é€å®Œæˆï¼ŒSCLç½®ä½</span></span><br><span class="line">	SDA_H;                                  <span class="comment">// é‡Šæ”¾SDAçº¿ï¼Œå‡†å¤‡æ¥æ”¶ACK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯»å–ä¸€ä¸ªå­—èŠ‚"><a class="markdownIt-Anchor" href="#è¯»å–ä¸€ä¸ªå­—èŠ‚"></a> è¯»å–ä¸€ä¸ªå­—èŠ‚</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint8_t</span> <span class="title function_">I2C_ReadByte</span><span class="params">(<span class="type">uint8_t</span> ack)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> rx = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// ä»æœ€é«˜ä½å¼€å§‹æ¥æ”¶ï¼ˆMSB firstï¼‰</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int8_t</span> i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">	&#123;</span><br><span class="line">		SCL_L;                              <span class="comment">// SCLç½®ä½ï¼Œå‡†å¤‡è¯»å–æ•°æ®</span></span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">		SCL_H;                              <span class="comment">// SCLç½®é«˜ï¼Œè¯»å–æ•°æ®</span></span><br><span class="line">		<span class="keyword">if</span>(Read_SDA)                        <span class="comment">// è¯»å–SDAä¸Šçš„æ•°æ®</span></span><br><span class="line">		&#123;</span><br><span class="line">			rx |= (<span class="number">1</span> &lt;&lt; i);                 <span class="comment">// å¦‚æœSDAä¸ºé«˜ï¼Œè®¾ç½®å¯¹åº”ä½</span></span><br><span class="line">		&#125;</span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	SCL_L;                                  <span class="comment">// æ•°æ®æ¥æ”¶å®Œæˆï¼ŒSCLç½®ä½</span></span><br><span class="line">	<span class="comment">// å‘é€åº”ç­”æˆ–éåº”ç­”</span></span><br><span class="line">	<span class="keyword">if</span>(ack)</span><br><span class="line">	&#123;</span><br><span class="line">		SDA_L;                              <span class="comment">// å‘é€ACKï¼ˆåº”ç­”ï¼‰</span></span><br><span class="line">		SCL_H;</span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">		SCL_L;</span><br><span class="line">		SDA_H;                              <span class="comment">// é‡Šæ”¾SDAçº¿</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		SDA_H;</span><br><span class="line">		SCL_H;</span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">		SCL_L;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç­‰å¾…ä»æœºack"><a class="markdownIt-Anchor" href="#ç­‰å¾…ä»æœºack"></a> ç­‰å¾…ä»æœºACK</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint8_t</span> <span class="title function_">I2C_Wait_ACK</span><span class="params">(<span class="type">int16_t</span> timeout)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ç­‰å¾…SDAå˜ä¸ºä½ç”µå¹³ï¼ˆä»æœºåº”ç­”ï¼‰</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		timeout--;</span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">	&#125;<span class="keyword">while</span>(Read_SDA &amp;&amp; timeout &gt;= <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(timeout &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;                           <span class="comment">// ç­‰å¾…è¶…æ—¶</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	SCL_H;                                  <span class="comment">// SCLç½®é«˜ï¼Œè¯»å–åº”ç­”ä¿¡å·</span></span><br><span class="line">	delay_us(<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span>(Read_SDA != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;                           <span class="comment">// åº”ç­”ä¿¡å·æ— æ•ˆ</span></span><br><span class="line">	&#125;</span><br><span class="line">	SCL_L;                                  <span class="comment">// SCLç½®ä½ï¼Œåº”ç­”è¯»å–å®Œæˆ</span></span><br><span class="line">	delay_us(<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;                               <span class="comment">// æˆåŠŸæ¥æ”¶åº”ç­”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="at24c02"><a class="markdownIt-Anchor" href="#at24c02"></a> AT24C02</h3>
<p><strong>I2Cé€šä¿¡</strong>ï¼Œè®¾å¤‡åœ°å€ï¼š1 0 1 0  E2 E1 E0 R/éWï¼›è¯»R=1ï¼Œ0XA1ï¼›å†™W=0;0XA0ï¼Œ<strong>æŒ‰å­—èŠ‚å†™å…¥</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> AT24C02_WADDR 0xA0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AT24C02_RADDR 0xA1</span></span><br></pre></td></tr></table></figure>
<p>AT24C02å…±<strong>16é¡µ</strong>ï¼Œ<strong>ä¸€é¡µ16å­—èŠ‚</strong>ï¼Œå…±256å­—èŠ‚ï¼›<strong>å­˜åœ¨å›å·é—®é¢˜</strong></p>
<h4 id="å†™å…¥"><a class="markdownIt-Anchor" href="#å†™å…¥"></a> å†™å…¥</h4>
<img src="https://s2.loli.net/2025/05/09/4LQS8qFYM3cmdbp.png" style="zoom:80%;" />
<h5 id="byte-write"><a class="markdownIt-Anchor" href="#byte-write"></a> Byte Write</h5>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// addr:å†™å…¥çš„EEPROMå†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment">// wdata:å†™å…¥çš„æ•°æ®</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_WriteByte</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> wdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)  			<span class="comment">// 100ä¸ºç­‰å¾…åº”ç­”çš„ä¿¡å·</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;                			<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line">    </span><br><span class="line">    I2C_SendByte(addr);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥åœ°å€å¤±è´¥</span></span><br><span class="line">    </span><br><span class="line">    I2C_SendByte(wdata);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥æ•°æ®å¤±è´¥</span></span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="page-write"><a class="markdownIt-Anchor" href="#page-write"></a> Page Write</h5>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// addrï¼šå†™å…¥åœ°å€</span></span><br><span class="line"><span class="comment">// wdataï¼šå†™å…¥æ•°æ®</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_WritePage</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> *wdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; 							<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line"></span><br><span class="line">    I2C_SendByte(addr);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥åœ°å€å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        I2C_SendByte(wdata[i]);</span><br><span class="line">        <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span> + i; 					<span class="comment">// å†™å…¥æ•°æ®å¤±è´¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯»å–"><a class="markdownIt-Anchor" href="#è¯»å–"></a> è¯»å–</h4>
<img src="https://s2.loli.net/2025/05/09/74nb8woeaplzTcr.png" style="zoom:67%;" />
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// addrï¼šè¯»å–çš„èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="comment">// rdataï¼šæŒ‡å‘å­˜å‚¨è¯»å–æ•°æ®çš„ç¼“å†²åŒºçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// datalen:è¯»å–æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_ReadData</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> *rdata, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; 							<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line"></span><br><span class="line">    I2C_SendByte(addr); 					<span class="comment">// å†™å…¥è¯»å–åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥è¯»å–åœ°å€å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_RADDR); 			<span class="comment">// å‘é€è¯»å–ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>; 							<span class="comment">// åˆ‡æ¢è¯»æ¨¡å¼æ—¶èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; datalen - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rdata[i] = I2C_ReadByte(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    rdata[datalen - <span class="number">1</span>] = I2C_ReadByte(<span class="number">0</span>); 	<span class="comment">// è¯»å–æœ€åä¸€ä¸ªå­—èŠ‚æ—¶ä¸å‘é€ACKä¿¡å·</span></span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="spi"><a class="markdownIt-Anchor" href="#spi"></a> SPI</h3>
<p>å¤–éƒ¨FLASHå‹å·ä¸ºW25Q64ï¼Œä½¿ç”¨<strong>ç¡¬ä»¶SPI</strong></p>
<img src="https://s2.loli.net/2025/05/09/WoTtsqaOecy1FAw.png" style="zoom:50%;" />
<ol>
<li>
<p>é…ç½®<strong>SPI0æ—¶é’Ÿ</strong>ï¼Œç›¸å…³<strong>GPIOå¼€å¯</strong></p>
</li>
<li>
<p><strong>å¤ä½SPIå¤–è®¾</strong></p>
</li>
<li>
<p>é…ç½®<strong>SPIç»“æ„ä½“æˆå‘˜ï¼ˆä¸»ä»æ¨¡å¼ï¼Œå‘é€ç±»å‹ï¼ˆå…¨åŒå·¥ï¼‰ï¼Œä¸€å¸§å¤§å°ï¼Œç¡¬ä»¶/è½¯ä»¶ï¼Œå¤§ç«¯/å°ç«¯ï¼ˆå¤§ç«¯ï¼‰ï¼Œå·¥ä½œæ–¹å¼ï¼ˆææ€§ï¼ˆä¸Šä¸‹ï¼‰/ç›¸ä½ï¼ˆä¸€äºŒï¼‰ï¼Œä»æœºå†³å®šï¼‰ï¼Œä¼ è¾“é€Ÿåº¦ï¼‰</strong></p>
</li>
<li>
<p><strong>åˆå§‹åŒ–SPI</strong></p>
</li>
<li>
<p><strong>ä½¿èƒ½SPI</strong></p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–SPI1</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SPI1_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ä½¿èƒ½GPIOAå’ŒSPI1æ—¶é’Ÿ</span></span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_SPI1, ENABLE);</span><br><span class="line"></span><br><span class="line">    GPIO_InitTypeDef GPIO_StructInit;</span><br><span class="line">    GPIO_StructInit.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_7;	<span class="comment">// é…ç½®SCKå’ŒMOSIå¼•è„š(PA5,PA7)</span></span><br><span class="line">    GPIO_StructInit.GPIO_Mode = GPIO_Mode_AF_PP; 		<span class="comment">// å¤ç”¨æ¨æŒ½è¾“å‡º</span></span><br><span class="line">    GPIO_StructInit.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_StructInit);</span><br><span class="line"></span><br><span class="line">    GPIO_StructInit.GPIO_Pin = GPIO_Pin_6;				<span class="comment">// é…ç½®MISOå¼•è„š(PA6)</span></span><br><span class="line">    GPIO_StructInit.GPIO_Mode = GPIO_Mode_IN_FLOATING;	<span class="comment">// æµ®ç©ºè¾“å…¥</span></span><br><span class="line">    GPIO_StructInit.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_StructInit);</span><br><span class="line">    </span><br><span class="line">    SPI_I2S_DeInit(SPI1);					<span class="comment">// å¤ä½SPI1å¤–è®¾</span></span><br><span class="line">    </span><br><span class="line">    SPI_InitTypeDef SPI_InitStructure;		<span class="comment">// é…ç½®SPIå‚æ•°</span></span><br><span class="line">    <span class="comment">/* SPIåˆå§‹åŒ–ç»“æ„ä½“é…ç½® */</span></span><br><span class="line">    <span class="comment">// SPIå·¥ä½œæ¨¡å¼ï¼šä¸»æ¨¡å¼ï¼ˆæ§åˆ¶æ—¶é’Ÿä¿¡å·ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_Mode = SPI_Mode_Master;</span><br><span class="line">    <span class="comment">// SPIé€šä¿¡æ–¹å‘ï¼šåŒçº¿å…¨åŒå·¥ï¼ˆåŒæ—¶å‘é€å’Œæ¥æ”¶ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;</span><br><span class="line">    <span class="comment">// æ•°æ®å¸§æ ¼å¼ï¼š8ä½æ•°æ®</span></span><br><span class="line">    SPI_InitStructure.SPI_DataSize = SPI_DataSize_8b;</span><br><span class="line">    <span class="comment">// æ—¶é’Ÿææ€§ï¼šé«˜ç”µå¹³ç©ºé—²ï¼ˆCPOL=1ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_CPOL = SPI_CPOL_High;</span><br><span class="line">    <span class="comment">// æ—¶é’Ÿç›¸ä½ï¼šç¬¬äºŒä¸ªè¾¹æ²¿é‡‡æ ·ï¼ˆCPHA=1ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_CPHA = SPI_CPHA_2Edge;</span><br><span class="line">    <span class="comment">// ç‰‡é€‰æ§åˆ¶ï¼šè½¯ä»¶NSSç®¡ç†ï¼ˆæ‰‹åŠ¨æ§åˆ¶ç‰‡é€‰ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_NSS = SPI_NSS_Soft;</span><br><span class="line">    <span class="comment">// æ³¢ç‰¹ç‡é¢„åˆ†é¢‘ï¼šç³»ç»Ÿæ—¶é’Ÿ2åˆ†é¢‘ï¼ˆfPCLK/2ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_2;</span><br><span class="line">    <span class="comment">// æ•°æ®ä¼ è¾“é¡ºåºï¼šé«˜ä½å…ˆå‘é€ï¼ˆMSB firstï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;</span><br><span class="line">    <span class="comment">// CRCå¤šé¡¹å¼ï¼š7,å¤§éƒ¨åˆ†SPIè®¾å¤‡ç”¨ä¸åˆ°ï¼Œéšä¾¿ç»™ä¸ªå€¼</span></span><br><span class="line">    SPI_InitStructure.SPI_CRCPolynomial = <span class="number">7</span>;</span><br><span class="line">    SPI_Init(SPI1, &amp;SPI_InitStructure);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿èƒ½SPI1</span></span><br><span class="line">    SPI_Cmd(SPI1, ENABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="https://s2.loli.net/2025/05/09/TlW7HSEm5eXfPBD.png" style="zoom: 50%;" />
<h4 id="æ•°æ®æ”¶å‘"><a class="markdownIt-Anchor" href="#æ•°æ®æ”¶å‘"></a> æ•°æ®æ”¶å‘</h4>
<p><strong>SPI_I2S_FLAG_TXE</strong>è¡¨ç¤º<strong>å‘é€åŒºç©ºäº†</strong>ï¼Œ<strong>SPI_SPI_FLAG_RXNE</strong>è¡¨ç¤º<strong>æ¥æ”¶åŒºä¸ä¸ºç©º</strong>ã€‚åˆ‡è®°<strong>å…¨åŒå·¥ï¼Œæœ‰å‘å°±æœ‰æ”¶ï¼</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPIå•å­—èŠ‚è¯»å†™ï¼Œtxæ˜¯è¦å‘é€çš„æ•°æ®å­—èŠ‚</span></span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">SPI1_ReadWrite_Byte</span><span class="params">(<span class="type">uint16_t</span> tx)</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">while</span> (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_TXE) != <span class="number">1</span>);	<span class="comment">// ç­‰å¾…å‘é€ç¼“å†²åŒºç©º</span></span><br><span class="line">    SPI_I2S_SendData(SPI1, tx);									<span class="comment">// å‘é€æ•°æ®</span></span><br><span class="line">    <span class="keyword">while</span> (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_RXNE) != <span class="number">1</span>);<span class="comment">// ç­‰å¾…æ¥æ”¶ç¼“å†²åŒºéç©º</span></span><br><span class="line">    <span class="keyword">return</span> SPI_I2S_ReceiveData(SPI1);							<span class="comment">// è¿”å›æ¥æ”¶åˆ°çš„æ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¤šå­—èŠ‚å†™å…¥SPIï¼Œwdataè¦å‘é€çš„æ•°æ®ç¼“å†²åŒºæŒ‡é’ˆï¼Œdatalenè¦å‘é€çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SPI1_Write</span><span class="params">(<span class="type">uint8_t</span> *wdata, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; datalen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        SPI1_ReadWrite_Byte(wdata[i]); 			<span class="comment">// åªå‘é€æ•°æ®ï¼Œå¿½ç•¥æ¥æ”¶å†…å®¹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¤šå­—èŠ‚è¯»å–SPIï¼Œrdataæ¥æ”¶æ•°æ®ç¼“å†²åŒºæŒ‡é’ˆï¼Œdatalenè¦è¯»å–çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SPI1_Read</span><span class="params">(<span class="type">uint8_t</span> *rdata, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; datalen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rdata[i] = SPI1_ReadWrite_Byte(<span class="number">0xff</span>); <span class="comment">// å‘é€dummyæ•°æ®(0xFF)æ¥è¯»å–ï¼Œæƒ³æƒ³Flashæ¸…é›¶</span></span><br><span class="line">    &#125;							</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="w25q64"><a class="markdownIt-Anchor" href="#w25q64"></a> W25Q64</h3>
<h4 id="çŠ¶æ€å¯„å­˜å™¨"><a class="markdownIt-Anchor" href="#çŠ¶æ€å¯„å­˜å™¨"></a> <strong>çŠ¶æ€å¯„å­˜å™¨</strong></h4>
<p>ä¸»è¦çœ‹<strong>S0 â€” BUSY</strong></p>
<img src="https://s2.loli.net/2025/05/09/KWenVOwYPLpoXaz.png" style="zoom:67%;" />
<h4 id="æŒ‡ä»¤è¡¨"><a class="markdownIt-Anchor" href="#æŒ‡ä»¤è¡¨"></a> <strong>æŒ‡ä»¤è¡¨</strong></h4>
<img src="https://s2.loli.net/2025/05/09/piZ37vGDV6htqL8.png" style="zoom: 80%;" />
<h4 id="ç›¸å…³ç¨‹åº"><a class="markdownIt-Anchor" href="#ç›¸å…³ç¨‹åº"></a> <strong>ç›¸å…³ç¨‹åº</strong></h4>
<p>SPI+Flashéœ€ç­‰å¾…<strong>BusyçŠ¶æ€</strong>ï¼Œå…ˆè¯»å–çŠ¶æ€å¯„å­˜å™¨åœ°å€ï¼Œåéšä¾¿å†™å…¥å…¶å®ƒï¼ˆæ­¤æ—¶å†™å…¥ä»€ä¹ˆéƒ½ä¸é‡è¦ï¼Œä¸»è¦è·å–å¯„å­˜å™¨ä¸­çš„æ•°å€¼ï¼‰ï¼Œ<strong>æ‰“å¼€ç‰‡é€‰ï¼Œä½¿èƒ½Writeå†å…³é—­</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CS_ENABLE GPIO_ResetBits(GPIOA, GPIO_Pin_4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CS_DISABLE GPIO_SetBits(GPIOA, GPIO_Pin_4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// W25Q64åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);</span><br><span class="line">    GPIO_InitTypeDef GPIO_StructInit;</span><br><span class="line">    GPIO_StructInit.GPIO_Pin = GPIO_Pin_4;         	<span class="comment">// CSç‰‡é€‰å¼•è„šï¼ˆä½ç”µå¹³æœ‰æ•ˆï¼‰</span></span><br><span class="line">    GPIO_StructInit.GPIO_Mode = GPIO_Mode_Out_PP;  	<span class="comment">// æ¨æŒ½è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">    GPIO_StructInit.GPIO_Speed = GPIO_Speed_50MHz; 	<span class="comment">// 50MHzé€Ÿåº¦</span></span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_StructInit);</span><br><span class="line">    CS_DISABLE;  									<span class="comment">// é»˜è®¤ç¦ç”¨ç‰‡é€‰</span></span><br><span class="line">    SPI1_Init(); 									<span class="comment">// åˆå§‹åŒ–SPI1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç­‰å¾…èŠ¯ç‰‡ç©ºé—²</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_WaitBusy</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> res;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        CS_ENABLE;                       			<span class="comment">// ä½¿èƒ½ç‰‡é€‰</span></span><br><span class="line">        SPI1_ReadWrite_Byte(<span class="number">0x05</span>);       			<span class="comment">// å‘é€è¯»å–çŠ¶æ€å¯„å­˜å™¨å‘½ä»¤</span></span><br><span class="line">        res = SPI1_ReadWrite_Byte(<span class="number">0xff</span>); 			<span class="comment">// è¯»å–çŠ¶æ€å¯„å­˜å™¨å€¼</span></span><br><span class="line">        CS_DISABLE;                      			<span class="comment">// ç¦ç”¨ç‰‡é€‰</span></span><br><span class="line">    &#125; <span class="keyword">while</span> ((res &amp; <span class="number">0x01</span>) == <span class="number">0x01</span>); 				<span class="comment">// æ£€æŸ¥BUSYä½ï¼ˆbit0ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿èƒ½å†™æ“ä½œ</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_Enable</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    W25Q64_WaitBusy(); 								<span class="comment">// ç­‰å¾…ç©ºé—²</span></span><br><span class="line">    CS_ENABLE;</span><br><span class="line">    SPI1_ReadWrite_Byte(<span class="number">0x06</span>); 						<span class="comment">// å‘é€å†™ä½¿èƒ½æŒ‡ä»¤</span></span><br><span class="line">    CS_DISABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ“¦é™¤64kb"><a class="markdownIt-Anchor" href="#æ“¦é™¤64kb"></a> æ“¦é™¤64KB</h4>
<p>W25Q64æ€»å…±<strong>8MB</strong> = 8 * 1024KBï¼Œ<strong>ä¸€æ¬¡æ“¦é™¤64KB</strong>ï¼Œå¯å¾—å…±è®¡8 * 1024 / 64 = <strong>128ä¸ªBlock</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ“¦é™¤64KBçš„å—ï¼Œblock: è¦æ“¦é™¤çš„å—ç¼–å·</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_Erase_64k</span><span class="params">(<span class="type">uint8_t</span> block)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> wdata[<span class="number">4</span>];</span><br><span class="line">    wdata[<span class="number">0</span>] = <span class="number">0xD8</span>;                      		<span class="comment">// å—æ“¦é™¤æŒ‡ä»¤</span></span><br><span class="line">    wdata[<span class="number">1</span>] = (block * <span class="number">64</span> * <span class="number">1024</span>) &gt;&gt; <span class="number">16</span>; 		<span class="comment">// è®¡ç®—å—èµ·å§‹åœ°å€ï¼ˆé«˜å­—èŠ‚ï¼‰</span></span><br><span class="line">    wdata[<span class="number">2</span>] = (block * <span class="number">64</span> * <span class="number">1024</span>) &gt;&gt; <span class="number">8</span>;  		<span class="comment">// ä¸­å­—èŠ‚</span></span><br><span class="line">    wdata[<span class="number">3</span>] = (block * <span class="number">64</span> * <span class="number">1024</span>) &gt;&gt; <span class="number">0</span>;  		<span class="comment">// ä½å­—èŠ‚</span></span><br><span class="line">    W25Q64_WaitBusy();							<span class="comment">// ç­‰å¾…BUSY</span></span><br><span class="line">    W25Q64_Enable(); 							<span class="comment">// ä½¿èƒ½å†™æ“ä½œ</span></span><br><span class="line">    CS_ENABLE;</span><br><span class="line">    SPI1_Write(wdata, <span class="number">4</span>); 						<span class="comment">// å‘é€æ“¦é™¤æŒ‡ä»¤å’Œåœ°å€</span></span><br><span class="line">    CS_DISABLE;</span><br><span class="line">    W25Q64_WaitBusy(); 							<span class="comment">// ç­‰å¾…æ“¦é™¤å®Œæˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é¡µå†™å…¥256byte"><a class="markdownIt-Anchor" href="#é¡µå†™å…¥256byte"></a> é¡µå†™å…¥256Byte</h4>
<p><strong>é¡µåœ°å€ = page * 256 Byteï¼Œæ¯æ¬¡ä»é¡µåœ°å€å¼€å§‹å†™å…¥256 Byteï¼Œé¡µåœ°å€æ€»é•¿24ä½</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŒ‰é¡µå†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">// wbuff: å¾…å†™å…¥æ•°æ®çš„ç¼“å†²åŒºæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// page: ç›®æ ‡é¡µå·</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_PageWrite</span><span class="params">(<span class="type">uint8_t</span> *wbuff, <span class="type">uint16_t</span> page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> wdata[<span class="number">4</span>];</span><br><span class="line">    wdata[<span class="number">0</span>] = <span class="number">0x02</span>;               				<span class="comment">// é¡µå†™æŒ‡ä»¤</span></span><br><span class="line">    wdata[<span class="number">1</span>] = (page * <span class="number">256</span>) &gt;&gt; <span class="number">16</span>; 				<span class="comment">// è®¡ç®—é¡µèµ·å§‹åœ°å€ï¼ˆé«˜å­—èŠ‚ï¼‰</span></span><br><span class="line">    wdata[<span class="number">2</span>] = (page * <span class="number">256</span>) &gt;&gt; <span class="number">8</span>;  				<span class="comment">// ä¸­å­—èŠ‚</span></span><br><span class="line">    wdata[<span class="number">3</span>] = (page * <span class="number">256</span>) &gt;&gt; <span class="number">0</span>;  				<span class="comment">// ä½å­—èŠ‚</span></span><br><span class="line">    W25Q64_WaitBusy();</span><br><span class="line">    W25Q64_Enable(); 							<span class="comment">// ä½¿èƒ½å†™æ“ä½œ</span></span><br><span class="line">    CS_ENABLE;</span><br><span class="line">    SPI1_Write(wdata, <span class="number">4</span>);   					<span class="comment">// å‘é€å†™æŒ‡ä»¤å’Œåœ°å€</span></span><br><span class="line">    SPI1_Write(wbuff, <span class="number">256</span>); 					<span class="comment">// å†™å…¥256å­—èŠ‚æ•°æ®</span></span><br><span class="line">    CS_DISABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯»å–æ•°æ®"><a class="markdownIt-Anchor" href="#è¯»å–æ•°æ®"></a> è¯»å–æ•°æ®</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">// rbuff: æ•°æ®è¯»å–ç¼“å†²åŒºæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// addr: èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="comment">// datalen: è¦è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_Read</span><span class="params">(<span class="type">uint8_t</span> *rbuff, <span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> datalen)</span> <span class="comment">// åœ°å€åªç”¨24ä½</span></span><br><span class="line">&#123;</span><br><span class="line">    W25Q64_WaitBusy();</span><br><span class="line">    CS_ENABLE;</span><br><span class="line">    SPI1_ReadWrite_Byte(<span class="number">0x03</span>);</span><br><span class="line">    SPI1_ReadWrite_Byte((<span class="type">uint16_t</span>)(addr &gt;&gt; <span class="number">16</span>));</span><br><span class="line">    SPI1_ReadWrite_Byte((<span class="type">uint16_t</span>)(addr &gt;&gt; <span class="number">8</span>));</span><br><span class="line">    SPI1_ReadWrite_Byte((<span class="type">uint16_t</span>)(addr &gt;&gt; <span class="number">0</span>));</span><br><span class="line">    SPI1_Read(rbuff, datalen);</span><br><span class="line">    CS_DISABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="stm32çš„flash"><a class="markdownIt-Anchor" href="#stm32çš„flash"></a> STM32çš„FLASH</h3>
<p>Flash<strong>æ“¦é™¤åä¸º0xFF</strong></p>
<h4 id="æ“¦é™¤flash"><a class="markdownIt-Anchor" href="#æ“¦é™¤flash"></a> æ“¦é™¤Flash</h4>
<p>Flash<strong>ä¸€é¡µ1KB</strong>ï¼Œä¸‹é¢å‡½æ•°å®ç°<strong>ä¸€æ¬¡æ“¦é™¤numé¡µ</strong>æ•°æ®</p>
<p><strong>æµç¨‹</strong>ï¼š</p>
<ol>
<li>
<p>Flashå¼€é”</p>
</li>
<li>
<p><strong>ç¡®è®¤åœ°å€ï¼Œæ“¦é™¤åœ°å€æ•°æ®</strong></p>
</li>
<li>
<p>Flashé”å®š</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// start	èµ·å§‹é¡µå·</span></span><br><span class="line"><span class="comment">// num		éœ€è¦æ“¦é™¤çš„é¡µæ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FLASH_Erase</span><span class="params">(<span class="type">uint16_t</span> start, <span class="type">uint16_t</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> i;</span><br><span class="line">    FLASH_Unlock(); 					<span class="comment">// è§£é”FLASHæ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—ç›®æ ‡é¡µåœ°å€ï¼šFLASHèµ·å§‹åœ°å€ + èµ·å§‹é¡µå· * é¡µå¤§å° + å½“å‰é¡µåç§»</span></span><br><span class="line">        FLASH_ErasePage((FLASH_SADDR + start * <span class="number">1024</span>) + (<span class="number">1024</span> * i));</span><br><span class="line">    &#125;</span><br><span class="line">    FLASH_Lock(); 						<span class="comment">// é”å®šFLASH</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å†™å…¥flash"><a class="markdownIt-Anchor" href="#å†™å…¥flash"></a> å†™å…¥Flash</h4>
<p>ä¸€æ¬¡å†™å…¥<strong>numä¸ª4å­—èŠ‚æ•°æ®</strong>ï¼Œåœ°å€è‡ªåŠ¨é€’å¢</p>
<p><strong>æµç¨‹</strong>ï¼š</p>
<ol>
<li>
<p>Flashå¼€é”</p>
</li>
<li>
<p><strong>å°†æ•°æ®å†™å…¥å¯¹åº”åœ°å€</strong></p>
</li>
<li>
<p>Flashé”å®š</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//	saddr	ç›®æ ‡èµ·å§‹åœ°å€ï¼ˆå¿…é¡»ä¸º4çš„å€æ•°ï¼‰</span></span><br><span class="line"><span class="comment">//	wdata	å¾…å†™å…¥æ•°æ®çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">//	wnum	éœ€è¦å†™å…¥çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FLASH_Write</span><span class="params">(<span class="type">uint32_t</span> saddr, <span class="type">uint32_t</span> *wdata, <span class="type">uint32_t</span> wnum)</span></span><br><span class="line">&#123;</span><br><span class="line">    FLASH_Unlock(); 						<span class="comment">// è§£é”FLASHæ“ä½œ</span></span><br><span class="line">    <span class="keyword">while</span> (wnum)</span><br><span class="line">    &#123;</span><br><span class="line">        FLASH_ProgramWord(saddr, *wdata); 	<span class="comment">// æŒ‰uint32_tå†™å…¥æ•°æ®</span></span><br><span class="line">        wnum -= <span class="number">4</span>;                        	<span class="comment">// å‰©ä½™å­—èŠ‚æ•°å‡4</span></span><br><span class="line">        saddr += <span class="number">4</span>;                       	<span class="comment">// åœ°å€æŒ‡é’ˆé€’å¢4å­—èŠ‚</span></span><br><span class="line">        wdata++;                          	<span class="comment">// æ•°æ®æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ª32ä½æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line">    FLASH_Lock(); 							<span class="comment">// é”å®šFLASH</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bootloaderåŠŸèƒ½å®ç°"><a class="markdownIt-Anchor" href="#bootloaderåŠŸèƒ½å®ç°"></a> BootloaderåŠŸèƒ½å®ç°</h2>
<img src="https://s2.loli.net/2025/05/10/NkZvJ52acX16gfT.png" style="zoom:50%;" />
<h3 id="abåˆ†åŒºè§„åˆ’"><a class="markdownIt-Anchor" href="#abåˆ†åŒºè§„åˆ’"></a> ABåˆ†åŒºè§„åˆ’</h3>
<p><strong>1ä¸ªæ‰‡é¡µ1KB</strong>ï¼ŒAåŒºèµ·å§‹ä½ç½®ï¼š0x 0800 5000ï¼Œ å•ç‰‡æœºRAMä½ç½®ï¼š0x20000000 ~ 0x2000FFFF</p>
<table>
<thead>
<tr>
<th style="text-align:center">STM32F103C8T6</th>
<th style="text-align:center">64KB</th>
<th style="text-align:center">æ‰‡é¡µ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">BåŒº</td>
<td style="text-align:center">20KB</td>
<td style="text-align:center">0 ~ 19</td>
</tr>
<tr>
<td style="text-align:center">AåŒº</td>
<td style="text-align:center">44KB</td>
<td style="text-align:center">20 ~ 63</td>
</tr>
</tbody>
</table>
<h3 id="æ³¨æ„ç‚¹"><a class="markdownIt-Anchor" href="#æ³¨æ„ç‚¹"></a> æ³¨æ„ç‚¹</h3>
<table>
<thead>
<tr>
<th style="text-align:center">é—®é¢˜</th>
<th style="text-align:center">è§£ç­”</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>è°å°†OTA_Flagæ‰“å‹¾ï¼Ÿ</strong></td>
<td style="text-align:center">AåŒºè´Ÿè´£æ§åˆ¶ï¼Œæ ‡å¿—ä½å­˜æ”¾åœ¨24C02</td>
</tr>
<tr>
<td style="text-align:center"><strong>ä»€ä¹ˆæ—¶å€™OTA_flagæ‰“å‹¾</strong></td>
<td style="text-align:center">AåŒºä¸‹è½½å®Œæ¯•ä¹‹å</td>
</tr>
<tr>
<td style="text-align:center"><strong>OTAæ—¶ï¼Œæœ€æ–°ç‰ˆæœ¬çš„ç¨‹åºæ–‡ä»¶ä¸‹è½½åˆ°å“ªï¼Ÿ</strong></td>
<td style="text-align:center">åˆ†ç‰‡ä¸‹è½½ï¼Œå…±è®¡256ç‰‡å¡å…¥W25Q64ï¼ˆä¸€é¡µ256Byteï¼Œå…±256é¡µï¼‰</td>
</tr>
<tr>
<td style="text-align:center"><strong>OTAæ—¶ï¼Œæœ€æ–°ç‰ˆæœ¬çš„ç¨‹åºæ–‡ä»¶å¦‚ä½•ä¸‹è½½ï¼Ÿä¸‹è½½å¤šå°‘ï¼Ÿ</strong></td>
<td style="text-align:center">æœåŠ¡å™¨ä¸‹å‘ç¨‹åºå¤§å°ï¼Œåˆ†ç‰‡ä¸‹è½½åˆ°W25Q64</td>
</tr>
<tr>
<td style="text-align:center"><strong>ä¸‹è½½å¤šå°‘è¿™ä¸ªå˜é‡ç”¨ä¸ç”¨ä¿å­˜ï¼Ÿ</strong></td>
<td style="text-align:center">éœ€è¦ï¼Œä¿å­˜åˆ°24C02ä¹‹ä¸­</td>
</tr>
<tr>
<td style="text-align:center"><strong>å‘ç”ŸOTAäº‹ä»¶æ—¶ï¼ŒBåŒºå¦‚ä½•æ›´æ–°AåŒº</strong></td>
<td style="text-align:center">ä»W25Q64è¯»å–æ•°æ®ï¼Œå†™å…¥AåŒºFlash</td>
</tr>
</tbody>
</table>
<h3 id="otaå®å®šä¹‰"><a class="markdownIt-Anchor" href="#otaå®å®šä¹‰"></a> OTAå®å®šä¹‰</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_SADDR 0x08000000                                     <span class="comment">// FLASHèµ·å§‹åœ°å€</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_PAGE_SIZE 1024                                       <span class="comment">// Flashé¡µå¤§å°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_NUM 64                                               <span class="comment">// FLASHæ€»é¡µæ•°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_B_NUM 20                                             <span class="comment">// BåŒºé¡µæ•°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_A_NUM FLASH_NUM - FLASH_B_NUM                        <span class="comment">// AåŒºé¡µæ•°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_A_SPAGE FLASH_B_NUM                                  <span class="comment">// AåŒºèµ·å§‹é¡µæ•°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_A_SADDR FLASH_SADDR + FLASH_A_SPAGE *FLASH_PAGE_SIZE <span class="comment">// AåŒºèµ·å§‹åœ°å€</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPDATA_A_FLAG 0x00000001     <span class="comment">// AåŒºæ›´æ–°æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IAP_XMODEM_FLAG 0x00000002   <span class="comment">// ä½¿ç”¨Xmodemåè®®çš„æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IAP_XMODEMD_FLAG 0x00000004  <span class="comment">// Xmodemåè®®ä¼ è¾“æ•°æ®çš„æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_VERSION_FLAG 0x00000008  <span class="comment">// è®¾ç½®ç‰ˆæœ¬å·çš„å‘½ä»¤æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_5_FLAG 0x000000010       <span class="comment">// å‘å¤–éƒ¨FLASHä¸‹è½½ç¨‹åºçš„å‘½ä»¤æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD5_XMODEM_FLAG 0x000000020 <span class="comment">// æ ‡è®°ä½¿ç”¨å‘½ä»¤5åï¼ŒXmodemåè®®ä¼ è¾“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_6_FLAG 0x000000040       <span class="comment">// ä½¿ç”¨å¤–éƒ¨FLASHå†…ç¨‹åº</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OTA_SET_FLAG 0xAABBCCDD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³äºæ•°ç»„å¤§å°æ˜¯11çš„åŸå› ï¼Œä¸€ä¸ªuint32_tä¸º4ä½ï¼Œ(1+11)*4=48 Byteï¼Œå¯¹åº”24C02å­˜å‚¨ä¸­æ¯é¡µ16Byteï¼Œåªéœ€è¦3é¡µå°±èƒ½å­˜å‚¨</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> OTA_flag;    			<span class="comment">// OTAæ ‡å¿—ä½</span></span><br><span class="line">    <span class="type">uint32_t</span> FireLen[<span class="number">11</span>]; 			<span class="comment">// ç”¨äºå­˜å‚¨å›ºä»¶å„éƒ¨åˆ†çš„å¤§å°,0å·æˆå‘˜å›ºå®šW25Q64</span></span><br><span class="line">    <span class="type">uint8_t</span> OTA_Ver[<span class="number">32</span>];  			<span class="comment">// ç‰ˆæœ¬å·</span></span><br><span class="line">&#125; OTA_CB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> UpDataBuff[FLASH_PAGE_SIZE]; <span class="comment">// ä¸´æ—¶å­˜å‚¨å¤–éƒ¨æ¥æ”¶çš„å›ºä»¶æ•°æ®å—</span></span><br><span class="line">    <span class="type">uint32_t</span> W25Q64_BlockNM;             <span class="comment">// è®°å½•å½“å‰å›ºä»¶å†™å…¥å“ªä¸ªå—</span></span><br><span class="line">    <span class="type">uint32_t</span> XmodemTimer;                <span class="comment">// è®°å½•å»¶æ—¶</span></span><br><span class="line">    <span class="type">uint32_t</span> XmodemNB;                   <span class="comment">// æ•°æ®åŒ…æ¥æ”¶æ•°é‡</span></span><br><span class="line">    <span class="type">uint32_t</span> XmodemCRC;                  <span class="comment">// å­˜æ”¾CRCæ ¡éªŒ</span></span><br><span class="line">&#125; UpData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> OTA_CB OTA;</span><br><span class="line"><span class="keyword">extern</span> UpData Updata_A;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OTA_INFO_SIZE sizeof(OTA_CB)</span></span><br></pre></td></tr></table></figure>
<h3 id="otaè¯»å–æ ‡å¿—ä½"><a class="markdownIt-Anchor" href="#otaè¯»å–æ ‡å¿—ä½"></a> OTAè¯»å–æ ‡å¿—ä½</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯»å–OTAæ ‡å¿—ä½,åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®éœ€è¦æ›´æ–°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">AT24C02_ReadOTA</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;OTA, <span class="number">0</span>, OTA_INFO_SIZE); 	<span class="comment">// å¼€è¾Ÿä¸€ä¸ªOTA_INFO_SIZEå¤§å°çš„åœ°å€ï¼Œåˆå§‹åŒ–ä¸º0</span></span><br><span class="line">    <span class="comment">// ä»AT24C02è¯»å–OTA_INFO_SIZEçš„æ•°æ®åˆ°ç»“æ„ä½“ä¸­</span></span><br><span class="line">    AT24C02_ReadData(<span class="number">0</span>, (<span class="type">uint8_t</span> *)&amp;OTA, OTA_INFO_SIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="otaä¿å­˜å…³é”®å˜é‡åˆ°at24c02"><a class="markdownIt-Anchor" href="#otaä¿å­˜å…³é”®å˜é‡åˆ°at24c02"></a> OTAä¿å­˜å…³é”®å˜é‡åˆ°AT24C02</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å†™å…¥OTAé…ç½®åˆ°EEPROM</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">AT24C02_WriteOTA</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> *pdata = (<span class="type">uint8_t</span> *)&amp;OTA;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; (OTA_INFO_SIZE + <span class="number">7</span>) / <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		AT24C02_WritePage(i * <span class="number">8</span>, pdata + i * <span class="number">8</span>);</span><br><span class="line">    	delay_ms(<span class="number">10</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼•å¯¼æ›´æ–°ota"><a class="markdownIt-Anchor" href="#å¼•å¯¼æ›´æ–°ota"></a> å¼•å¯¼æ›´æ–°OTA</h3>
<p><strong>(ä»ä¸‹é¢å‘ä¸Šçœ‹)</strong></p>
<p><strong>åˆ†åŒºè·³è½¬</strong>ä¸¤å¤§å…³é”®<strong>SPã€PC</strong>è®¾å®š</p>
<p>Cortex-M3æœ‰<strong>R0-R12é€šç”¨å¯„å­˜å™¨ï¼ŒR13æœ‰MSPï¼ˆä¸»å †æ ˆæŒ‡é’ˆï¼‰å’ŒPSPï¼ˆè¿›ç¨‹å †æ ˆæŒ‡é’ˆï¼‰(ä¿å­˜ç°åœºå’Œæ¢å¤ç°åœºçš„æŒ‡é’ˆ)ï¼ŒR14æ˜¯LRï¼ˆè¿æ¥å¯„å­˜å™¨ï¼Œä¿å­˜å­å‡½æ•°ä¹‹é—´è·³è½¬çš„è¿”å›å€¼ï¼‰ï¼ŒR15æ˜¯PCï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰</strong></p>
<ul>
<li>
<p>20(AåŒºèµ·å§‹é¡µ) * 1024 = 20480 â€”&gt; 0x00005000 + 0x08000000 = <strong>0x08005000</strong>ï¼Œæ­¤ä¸ºAåŒºå¼€å§‹æ—¶SP<strong>åœ°å€</strong></p>
</li>
<li>
<p>AåŒºèµ·å§‹ä½ç½®<strong>0x08005000 + 4</strong>(32ä½çš„æŒ‡é’ˆæ˜¯4Byte)ï¼Œæ­¤ä¸ºAåŒºå¼€å§‹æ—¶<strong>PCåœ°å€</strong></p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RAM ï¼š 0x20000000 ~ 0x2000FFFF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_A_SADDR FLASH_SADDR + FLASH_A_SPAGE * FLASH_PAGE_SIZE <span class="comment">// AåŒºèµ·å§‹åœ°å€</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*load_a)</span><span class="params">(<span class="type">void</span>)</span>; 	<span class="comment">// å›è°ƒå‡½æ•°ï¼Œå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªæ— å‚æ•°ã€æ— è¿”å›å€¼çš„å‡½æ•°</span></span><br><span class="line">load_a load_A;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºä¿®æ”¹ä¸»å †æ ˆæŒ‡é’ˆ(MSP)</span></span><br><span class="line">__ASM <span class="type">void</span> <span class="title function_">MSR_SP</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;				 				</span><br><span class="line">	MSR MSP, r0;<span class="comment">// MSRæŒ‡ä»¤ç”¨äºå°†ç¨‹åºçŠ¶æ€å¯„å­˜å™¨çš„å†…å®¹ä¼ é€åˆ°é€šç”¨å¯„å­˜å™¨ä¸­ï¼ŒR0=addr</span></span><br><span class="line">	BX r14;<span class="comment">// é€šè¿‡é“¾æ¥å¯„å­˜å™¨LR(r14)è¿”å›è°ƒç”¨è€…ï¼Œç­‰åŒäºreturn</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·³è½¬åˆ°AåŒºåº”ç”¨ç¨‹åº</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LOAD_A</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((*(<span class="type">uint32_t</span> *)addr &gt;= <span class="number">0x20000000</span>) &amp;&amp; (*(<span class="type">uint32_t</span> *)addr &lt;= <span class="number">0x2000FFFF</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// è®¾ç½®AåŒºèµ·å§‹åœ°å€,å› ä¸ºMSR_SPå‡½æ•°æ¥æ”¶uint32_tçš„æ•°æ®ï¼Œæ‰€ä»¥å…ˆå¼ºåˆ¶è½¬æ¢ï¼Œå†æŒ‡é’ˆå–åœ°å€</span></span><br><span class="line">		MSR_SP(*(<span class="type">uint32_t</span> *)addr);</span><br><span class="line">		load_A = (load_a) * (<span class="type">uint32_t</span> *)(addr + <span class="number">4</span>); <span class="comment">// è·å–å¤ä½ä¸­æ–­å¤„ç†ç¨‹åºåœ°å€</span></span><br><span class="line">		load_A();									<span class="comment">// å®é™…æ‰§è¡Œçš„æ˜¯Reset_Handler</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		uprintf(<span class="string">&quot;è·³è½¬Aåˆ†åŒºå¤±è´¥\r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•å¯¼OTAå‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BootLoader_Jump</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ç­‰å¾…20*100msæ£€æµ‹æ˜¯å¦è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼</span></span><br><span class="line">	<span class="keyword">if</span> (BootLoader_Enter(<span class="number">20</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// æ£€æŸ¥OTAæ›´æ–°æ ‡å¿—</span></span><br><span class="line">		<span class="keyword">if</span> (OTA.OTA_flag == OTA_SET_FLAG)</span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;OTAæ›´æ–° \r\n&quot;</span>);</span><br><span class="line">			BootState |= UPDATA_A_FLAG;	 <span class="comment">// è®¾ç½®AåŒºæ›´æ–°æ ‡å¿—</span></span><br><span class="line">			UpDATA_A.W25Q64_BlockNM = <span class="number">0</span>; <span class="comment">// é»˜è®¤ä½¿ç”¨W25Q64çš„å—0</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;è·³è½¬Aåˆ†åŒº \r\n&quot;</span>);</span><br><span class="line">			LOAD_A(FLASH_A_SADDR); <span class="comment">// è·³è½¬åˆ°AåŒºåº”ç”¨ç¨‹åº</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	uprintf(<span class="string">&quot;è¿›å…¥BootLoaderå‘½ä»¤è¡Œ \r\n&quot;</span>);</span><br><span class="line">	BootLoader_Info();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¤ä½å¤–è®¾ï¼Œæ²¡ç”¨åˆ°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BootLoader_Clear</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	USART_DeInit(USART1);</span><br><span class="line">	GPIO_DeInit(GPIOA);</span><br><span class="line">	GPIO_DeInit(GPIOB);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bootloaderäº‹ä»¶"><a class="markdownIt-Anchor" href="#bootloaderäº‹ä»¶"></a> BootLoaderäº‹ä»¶</h3>
<p><strong>(ä»ä¸Šé¢å‘ä¸‹çœ‹)</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint32_t</span> BootState; 			<span class="comment">// ç³»ç»Ÿå¯åŠ¨çŠ¶æ€æ ‡å¿—ä½</span></span><br><span class="line"><span class="type">uint8_t</span> wdata[<span class="number">2048</span>];</span><br><span class="line"><span class="type">uint8_t</span> rdata[<span class="number">2048</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*	æ˜¾ç¤ºBootLoaderå‘½ä»¤è¡Œå¸®åŠ©ä¿¡æ¯	*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BootLoader_Info</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	uprintf(<span class="string">&quot; \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[1]æ“¦é™¤AåŒº \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[2]ä¸²å£IAPä¸‹è½½AåŒº \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[3]è®¾ç½®OTAç‰ˆæœ¬å· \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[4]æŸ¥è¯¢OTAç‰ˆæœ¬å· \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[5]å‘å¤–éƒ¨FLASHä¸‹è½½ç¨‹åº \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[6]ä½¿ç”¨å¤–éƒ¨FLASHå†…ç¨‹åº \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[7]é‡å¯ \r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*	æ£€æµ‹æ˜¯å¦è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼ï¼Œtimeout è¶…æ—¶æ—¶é—´ï¼Œ1-è¿›å…¥å‘½ä»¤è¡Œï¼Œ0-ä¸è¿›å…¥	*/</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">BootLoader_Enter</span><span class="params">(<span class="type">uint8_t</span> timeout)</span></span><br><span class="line">&#123;</span><br><span class="line">	uprintf(<span class="string">&quot;è¾“å…¥å°å†™å­—æ¯w,è¿›å…¥BootLoaderå‘½ä»¤è¡Œ \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">while</span> (timeout--)</span><br><span class="line">	&#123;</span><br><span class="line">		Delay_ms(<span class="number">200</span>);</span><br><span class="line">		<span class="keyword">if</span> (U1_RX_Buff[<span class="number">0</span>] == <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>; 							<span class="comment">// è¿›å…¥å‘½ä»¤è¡Œ</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>; 									<span class="comment">// ä¸è¿›å…¥</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Bootloaderäº‹ä»¶ç»„</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BootLoader_Event</span><span class="params">(<span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> temp, i;</span><br><span class="line">	<span class="keyword">if</span> (BootState == <span class="number">0</span>)<span class="comment">// BootState=0ï¼šä¸è¿›è¡Œå…¶ä»–æ“ä½œï¼Œæ˜¾ç¤ºç•Œé¢</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;1&#x27;</span>))<span class="comment">//	æ“¦é™¤AåŒº</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;[1]æ“¦é™¤AåŒº \r\n&quot;</span>);</span><br><span class="line">			FLASH_Erase(FLASH_A_SPAGE, FLASH_A_NUM);</span><br><span class="line">			Delay_ms(<span class="number">100</span>);</span><br><span class="line">			BootLoader_Info();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;2&#x27;</span>))<span class="comment">//	é€šè¿‡Xmodemä¸‹è½½å›ºä»¶åˆ°AåŒº</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;é€šè¿‡Xmodemåè®®,ä¸²å£IAPä¸‹è½½AåŒºç¨‹åº,ä½¿ç”¨binæ–‡ä»¶ \r\n&quot;</span>);</span><br><span class="line">			FLASH_Erase(FLASH_A_SPAGE, FLASH_A_NUM);		   <span class="comment">// æ“¦é™¤ç›®æ ‡åŒºåŸŸ</span></span><br><span class="line">			BootState |= (IAP_XMODEM_FLAG | IAP_XMODEMD_FLAG); <span class="comment">// è®¾ç½®Xmodemæ ‡å¿—</span></span><br><span class="line">			UpDATA_A.XmodemTimer = <span class="number">0</span>;						   <span class="comment">// é‡ç½®è®¡æ—¶å™¨</span></span><br><span class="line">			UpDATA_A.XmodemNB = <span class="number">0</span>;							   <span class="comment">// é‡ç½®æ•°æ®åŒ…è®¡æ•°å™¨</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;3&#x27;</span>))	<span class="comment">//	è®¾ç½®ç‰ˆæœ¬å·</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;è®¾ç½®ç‰ˆæœ¬å· \r\n&quot;</span>);</span><br><span class="line">			BootState |= SET_VERSION_FLAG;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;4&#x27;</span>))	<span class="comment">//	æŸ¥è¯¢ç‰ˆæœ¬å·</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;æŸ¥è¯¢ç‰ˆæœ¬å· \r\n&quot;</span>);</span><br><span class="line">			AT24C02_ReadOTA();							</span><br><span class="line">			uprintf(<span class="string">&quot;ç‰ˆæœ¬å·:%s \r\n&quot;</span>, OTA.OTA_Ver);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;5&#x27;</span>))	<span class="comment">//å‘å¤–éƒ¨FLASHä¼ è¾“ç¨‹åº</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;å‘å¤–éƒ¨FLASHä¼ è¾“ç¨‹åº,è¾“å…¥éœ€è¦ä½¿ç”¨çš„å—ç¼–å·(1~9) \r\n&quot;</span>);</span><br><span class="line">			BootState |= CMD_5_FLAG;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;6&#x27;</span>))	<span class="comment">//ä½¿ç”¨å¤–éƒ¨FLASHä¸‹è½½ç¨‹åº</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;ä½¿ç”¨å¤–éƒ¨FLASHä¸‹è½½ç¨‹åº,è¾“å…¥éœ€è¦ä½¿ç”¨çš„å—ç¼–å·(1~9) \r\n&quot;</span>);</span><br><span class="line">			BootState |= CMD_6_FLAG;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;7&#x27;</span>))	<span class="comment">// Reset</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;é‡å¯ä¸­ \r\n&quot;</span>);</span><br><span class="line">			__set_FAULTMASK(<span class="number">1</span>);</span><br><span class="line">			Delay_ms(<span class="number">100</span>);</span><br><span class="line">			NVIC_SystemReset();							<span class="comment">//NVICé‡å¯</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (BootState &amp; IAP_XMODEMD_FLAG)				<span class="comment">// Xmodemåè®®æ•°æ®å¤„ç†</span></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">// æ¥æ”¶æ•°æ®åŒ…ï¼ˆ133å­—èŠ‚ï¼š1ä¸ªå­—èŠ‚+128å­—èŠ‚+2CRC+2Byteåºå·ï¼‰</span></span><br><span class="line">		<span class="keyword">if</span> ((datalen == <span class="number">133</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="number">0x01</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			BootState &amp;= ~IAP_XMODEM_FLAG;	</span><br><span class="line">			UpDATA_A.XmodemCRC = Xmodem_CRC16(&amp;data[<span class="number">3</span>], <span class="number">128</span>);<span class="comment">// è®¡ç®—æ¥æ”¶æ•°æ®çš„CRCæ ¡éªŒå€¼</span></span><br><span class="line">			<span class="keyword">if</span> (UpDATA_A.XmodemCRC == data[<span class="number">131</span>] * <span class="number">256</span> + data[<span class="number">132</span>])	<span class="comment">// æ ¡éªŒé€šè¿‡å¤„ç†</span></span><br><span class="line">			&#123;</span><br><span class="line">				UpDATA_A.XmodemNB++;<span class="comment">// Xmodemæ¥æ”¶æ•°æ®åŒ…å¢åŠ 					</span></span><br><span class="line">				<span class="comment">// å°†æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒº</span></span><br><span class="line">                <span class="built_in">memcpy</span>(&amp;UpDATA_A.UpDataBuff[((UpDATA_A.XmodemNB - <span class="number">1</span>) % (FLASH_PAGE_SIZE / <span class="number">128</span>)) * <span class="number">128</span>], &amp;data[<span class="number">3</span>], <span class="number">128</span>); </span><br><span class="line">                <span class="comment">//&amp;data[3]ï¼šXmodemåŒ…çš„æ•°æ®éƒ¨åˆ†ä»ç¬¬4å­—èŠ‚å¼€å§‹ï¼ˆè·³è¿‡1å­—èŠ‚å¤´+2å­—èŠ‚åºå·ï¼‰</span></span><br><span class="line">                <span class="comment">//(FLASH_PAGE_SIZE(1024) / 128)è®¡ç®—ä¸€é¡µå¯ä»¥å­˜ä¸‹çš„åŒ…æ•°ï¼Œå¯¹è¯¥å–æ¨¡ï¼Œå½“è¶…è¿‡ä¸€é¡µé‡æ–°è®¡ç®—</span></span><br><span class="line">				<span class="keyword">if</span> ((UpDATA_A.XmodemNB % (FLASH_PAGE_SIZE / <span class="number">128</span>)) == <span class="number">0</span>) <span class="comment">// 1024/128=8ï¼Œæ¯8ä¸ªæ•°æ®åŒ…å‘é€ä¸€æ¬¡</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (BootState &amp; CMD5_XMODEM_FLAG)<span class="comment">// é€‰æ‹©å†™å…¥W25Q64æˆ–FLASH</span></span><br><span class="line">					&#123;							</span><br><span class="line">						<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)<span class="comment">// å†™å…¥å¤–éƒ¨W25Q64ï¼Œæ¯æ¬¡å†™å…¥256å­—èŠ‚ï¼Œå†™4æ¬¡ä¸ºä¸€é¡µ</span></span><br><span class="line">						&#123;</span><br><span class="line">							W25Q64_PageWrite(&amp;UpDATA_A.UpDataBuff[i * <span class="number">256</span>], </span><br><span class="line">							(UpDATA_A.XmodemNB / <span class="number">8</span> - <span class="number">1</span>) * <span class="number">4</span> + i + UpDATA_A.W25Q64_BlockNM * <span class="number">64</span> * <span class="number">4</span>);</span><br><span class="line">							<span class="comment">//(x/8-1)*4+i,xè¡¨ç¤ºæ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¸ªæ•°ï¼Œ4è¡¨ç¤ºå†™å…¥W25Q64çš„é¡µæ•°,iç”¨æ¥å®šä½é¡µæ•°</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">// FLASH_A_SADDR + ((UpDATA_A.XmodemNB / (FLASH_PAGE_SIZE / 128)) - 1) * FLASH_PAGE_SIZE</span></span><br><span class="line">						<span class="comment">// AåŒºçš„èµ·å§‹åœ°å€+((æ¥æ”¶çš„8ä¸ªXmodemåè®®åŒ… / (ä¸€é¡µå æ®çš„åè®®åŒ…æ•°é‡)) -1(ç´¢å¼•ä»0å¼€å§‹) * å½“å‰é¡µåç§»åœ°å€</span></span><br><span class="line">                        <span class="comment">// é€šè¿‡Xmodemåè®®ä¼ è¾“çš„å†™å…¥åˆ°ç¼“å†²åŒºçš„æ•°æ®</span></span><br><span class="line">						FLASH_Write(FLASH_A_SADDR + ((UpDATA_A.XmodemNB / (FLASH_PAGE_SIZE / <span class="number">128</span>)) - <span class="number">1</span>) * FLASH_PAGE_SIZE,</span><br><span class="line">						(<span class="type">uint32_t</span> *)UpDATA_A.UpDataBuff, FLASH_PAGE_SIZE);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				uprintf(<span class="string">&quot;\x06&quot;</span>); 			<span class="comment">// è¡¨ç¤ºXmodemåè®®åŒ…è¯»å–æˆåŠŸ</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;\x15&quot;</span>); 			<span class="comment">// è¡¨ç¤ºXmodemåè®®åŒ…è¯»å–å¤±è´¥</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="number">0x04</span>)) 					<span class="comment">// è¯»å–Xmodemåè®®åŒ…å‰©ä½™çš„æ•°æ®</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;\x06&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> ((UpDATA_A.XmodemNB % (FLASH_PAGE_SIZE / <span class="number">128</span>)) != <span class="number">0</span>) <span class="comment">// å¦‚æœæœ‰å‰©ä½™çš„æ•°æ®</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (BootState &amp; CMD5_XMODEM_FLAG)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">					&#123;</span><br><span class="line">						W25Q64_PageWrite(&amp;UpDATA_A.UpDataBuff[i * <span class="number">256</span>],</span><br><span class="line">						(UpDATA_A.XmodemNB / <span class="number">8</span>) * <span class="number">4</span> + i + UpDATA_A.W25Q64_BlockNM * <span class="number">64</span> * <span class="number">4</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					FLASH_Write(FLASH_A_SADDR + ((UpDATA_A.XmodemNB / (FLASH_PAGE_SIZE / <span class="number">128</span>))) * FLASH_PAGE_SIZE,</span><br><span class="line">					(<span class="type">uint32_t</span> *)UpDATA_A.UpDataBuff,</span><br><span class="line">					(UpDATA_A.XmodemNB % (FLASH_PAGE_SIZE / <span class="number">128</span>)) * <span class="number">128</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			BootState &amp;= ~IAP_XMODEMD_FLAG;</span><br><span class="line">			<span class="keyword">if</span> (BootState &amp; CMD5_XMODEM_FLAG) 		<span class="comment">// å°†æ•°æ®ä¸‹è½½åˆ°W25Q64</span></span><br><span class="line">			&#123;</span><br><span class="line">				BootState &amp;= ~CMD5_XMODEM_FLAG;		<span class="comment">// å°†æ ‡å¿—ä½å¤ä½</span></span><br><span class="line">				OTA.FireLen[UpDATA_A.W25Q64_BlockNM] = UpDATA_A.XmodemNB * <span class="number">128</span>; <span class="comment">// å°†Xmodemæ•°æ®å­˜å…¥W25Q64ä¸­</span></span><br><span class="line">				AT24C02_WriteOTA();					<span class="comment">// å­˜å‚¨æ•°æ®,æ‰ç”µä¸ä¸¢å¤±</span></span><br><span class="line">				Delay_ms(<span class="number">100</span>);</span><br><span class="line">				BootLoader_Info();					<span class="comment">//é‡æ–°æ˜¾ç¤ºå‘½ä»¤è¡Œ</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				__set_FAULTMASK(<span class="number">1</span>); 				<span class="comment">// å…³é—­æ‰€æœ‰ä¸­æ–­</span></span><br><span class="line">				Delay_ms(<span class="number">100</span>);</span><br><span class="line">				NVIC_SystemReset(); 				<span class="comment">// ç¨‹åºé‡å¯</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (BootState &amp; SET_VERSION_FLAG) 		<span class="comment">// è®¾ç½®ç‰ˆæœ¬å·</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (datalen &lt;= <span class="number">32</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">sscanf</span>((<span class="type">const</span> <span class="type">char</span> *)data, <span class="string">&quot;VER-%d.%d.%d-%d/%d/%d-%d:%d&quot;</span>, &amp;temp, &amp;temp, &amp;temp, &amp;temp, &amp;temp, &amp;temp, &amp;temp, &amp;temp) == <span class="number">8</span>)</span><br><span class="line">			&#123;								   <span class="comment">// VER-1.0.0-2025/5/1-10:28</span></span><br><span class="line">				<span class="built_in">memset</span>(OTA.OTA_Ver, <span class="number">0</span>, <span class="number">32</span>);	   <span class="comment">// å°†ä¹‹å‰çš„ç‰ˆæœ¬å·æ¸…é›¶</span></span><br><span class="line">				<span class="built_in">memcpy</span>(OTA.OTA_Ver, data, <span class="number">32</span>); <span class="comment">// å¡«å…¥æ–°çš„ç‰ˆæœ¬å·</span></span><br><span class="line">				AT24C02_WriteOTA();			   <span class="comment">// å†™å…¥æ‰ç”µä¸ä¸¢å¤±èŠ¯ç‰‡</span></span><br><span class="line">				uprintf(<span class="string">&quot;ç‰ˆæœ¬å·æ­£ç¡® \r\n&quot;</span>);</span><br><span class="line">				BootLoader_Info();</span><br><span class="line">				BootState &amp;= ~SET_VERSION_FLAG; <span class="comment">// ä½¿ç”¨å®Œå¤ä½æ ‡å¿—ä½</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;ç‰ˆæœ¬å·é•¿åº¦é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (BootState &amp; CMD_5_FLAG)			<span class="comment">// å°†binç¨‹åºä¼ å…¥W25Q64çš„ç¬¬%dä¸ªå—</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (datalen == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ((data[<span class="number">0</span>] &gt;= <span class="number">0x31</span>) &amp;&amp; (data[<span class="number">0</span>] &lt;= <span class="number">0x39</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				UpDATA_A.W25Q64_BlockNM = data[<span class="number">0</span>] - <span class="number">0x30</span>; 	<span class="comment">// å­—ç¬¦è½¬æ¢æ•°å­—</span></span><br><span class="line">				BootState |= (IAP_XMODEM_FLAG | IAP_XMODEMD_FLAG | CMD5_XMODEM_FLAG);<span class="comment">//åŠ ä¸ŠXMODEMçš„æ ‡å¿—ä½</span></span><br><span class="line">				UpDATA_A.XmodemTimer = <span class="number">0</span>;					<span class="comment">// æ¸…ç©ºå®šæ—¶å™¨</span></span><br><span class="line">				UpDATA_A.XmodemNB = <span class="number">0</span>;						<span class="comment">// æ¸…ç©ºå‘é€çš„åŒ…æ•°</span></span><br><span class="line">				OTA.FireLen[UpDATA_A.W25Q64_BlockNM] = <span class="number">0</span>;	<span class="comment">// ç½®é›¶è¡¨ç¤ºæ¸…ç©ºæ•°æ®</span></span><br><span class="line">				W25Q64_Erase_64k(UpDATA_A.W25Q64_BlockNM);	<span class="comment">// æ“¦é™¤æ•´å—</span></span><br><span class="line">				uprintf(<span class="string">&quot;é€šè¿‡Xmodemåè®®,å‘å¤–éƒ¨FLASHç¬¬%dä¸ªå—ä¼ è¾“ç¨‹åº,ä½¿ç”¨binæ–‡ä»¶ \r\n&quot;</span>, UpDATA_A.W25Q64_BlockNM);</span><br><span class="line">				BootState &amp;= ~CMD_5_FLAG;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;ç¼–å·é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;æ•°æ®é•¿åº¦é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (BootState &amp; CMD_6_FLAG) 						<span class="comment">// ä½¿ç”¨W25Q64ä¿å­˜çš„APPç¨‹åº</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (datalen == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ((data[<span class="number">0</span>] &gt;= <span class="number">0x31</span>) &amp;&amp; (data[<span class="number">0</span>] &lt;= <span class="number">0x39</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				UpDATA_A.W25Q64_BlockNM = data[<span class="number">0</span>] - <span class="number">0x30</span>; 		<span class="comment">// å­—ç¬¦è½¬æ¢æ•°å­—</span></span><br><span class="line">				BootState |= UPDATA_A_FLAG;				  <span class="comment">// AåŒºæ›´æ–°æ ‡å¿—</span></span><br><span class="line">				BootState &amp;= ~CMD_6_FLAG;				  <span class="comment">// å°†å‘½ä»¤6æ ‡å¿—ç½®ä½</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;ç¼–å·é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;é•¿åº¦é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸»ç¨‹åº"><a class="markdownIt-Anchor" href="#ä¸»ç¨‹åº"></a> ä¸»ç¨‹åº</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// éœ€è¦ç”¨åˆ°çš„åŠŸèƒ½ï¼šä¸²å£ï¼ŒSPIï¼ŒFLASH</span></span><br><span class="line"><span class="type">uint32_t</span> BootState; 	<span class="comment">// ç³»ç»Ÿå¯åŠ¨çŠ¶æ€æ ‡å¿—ä½</span></span><br><span class="line"><span class="type">uint8_t</span> wdata[<span class="number">2048</span>];</span><br><span class="line"><span class="type">uint8_t</span> rdata[<span class="number">2048</span>];</span><br><span class="line"><span class="keyword">extern</span> OTA_CB OTA;</span><br><span class="line"><span class="keyword">extern</span> UpData UpDATA_A;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">uint32_t</span> BootState;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> i;</span><br><span class="line">	USART1_Init(<span class="number">921600</span>); 	<span class="comment">// åˆå§‹åŒ–ä¸²å£1ï¼Œæ³¢ç‰¹ç‡921600</span></span><br><span class="line">	Delay_Init();		 <span class="comment">// åˆå§‹åŒ–å»¶æ—¶å‡½æ•°</span></span><br><span class="line">	I2C1_Init();		 <span class="comment">// åˆå§‹åŒ–I2C1ï¼ˆç”¨äºAT24C02é€šä¿¡ï¼‰</span></span><br><span class="line">	AT24C02_ReadOTA();	 <span class="comment">// ä»AT24C02è¯»å–OTAæ ‡å¿—ä½</span></span><br><span class="line">	W25Q64_Init();		 <span class="comment">// åˆå§‹åŒ–W25Q64ï¼ˆSPI Flashï¼‰</span></span><br><span class="line">	BootLoader_Jump();	 <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬åˆ°BootLoader</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Delay_ms(<span class="number">10</span>); <span class="comment">// ä¸»å¾ªç¯å»¶æ—¶10ms</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// ä¸²å£1å¤„ç†ç¼“å†²åŒºæ•°æ®</span></span><br><span class="line">		<span class="keyword">if</span> (U1CB.URxDataOUT != U1CB.URxDataIN)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®ï¼ˆXmodemåè®®æˆ–å…¶ä»–æŒ‡ä»¤ï¼‰</span></span><br><span class="line">			BootLoader_Event(U1CB.URxDataOUT-&gt;start, U1CB.URxDataOUT-&gt;end - U1CB.URxDataOUT-&gt;start + <span class="number">1</span>);</span><br><span class="line">			<span class="comment">// ç§»åŠ¨æ¥æ”¶ç¼“å†²åŒºæŒ‡é’ˆ</span></span><br><span class="line">			U1CB.URxDataOUT++;</span><br><span class="line">			<span class="keyword">if</span> (U1CB.URxDataOUT == U1CB.URxDataEND)</span><br><span class="line">			&#123;</span><br><span class="line">				U1CB.URxDataOUT = &amp;U1CB.URxDataPtr[<span class="number">0</span>]; <span class="comment">// ç¯å½¢ç¼“å†²åŒºå›å·</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€Xmodemåè®®çš„æ§åˆ¶å­—ç¬¦&#x27;C&#x27;</span></span><br><span class="line">		<span class="keyword">if</span> (BootState &amp; IAP_XMODEM_FLAG)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (UpDATA_A.XmodemTimer &gt;= <span class="number">100</span>) 	<span class="comment">// æ¯100æ¬¡å¾ªç¯å‘é€ä¸€æ¬¡&#x27;C&#x27;</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;C&quot;</span>); 				<span class="comment">// å‘é€Xmodemèµ·å§‹ä¿¡å·</span></span><br><span class="line">				UpDATA_A.XmodemTimer = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			UpDATA_A.XmodemTimer++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°AåŒºå›ºä»¶</span></span><br><span class="line">		<span class="keyword">if</span> (BootState &amp; UPDATA_A_FLAG)</span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;é•¿åº¦%då­—èŠ‚\r\n&quot;</span>, OTA.FireLen[UpDATA_A.W25Q64_BlockNM]);</span><br><span class="line">			<span class="comment">// æ“¦é™¤ç›®æ ‡FLASHåŒºåŸŸ(AåŒº)</span></span><br><span class="line">			FLASH_Erase(FLASH_A_SPAGE, FLASH_A_NUM);</span><br><span class="line">			uprintf(<span class="string">&quot;AåŒºå·²æ“¦é™¤ \r\n&quot;</span>);</span><br><span class="line">			<span class="comment">// æ£€æŸ¥å›ºä»¶é•¿åº¦æ˜¯å¦ä¸º4çš„å€æ•°</span></span><br><span class="line">			<span class="keyword">if</span> (OTA.FireLen[UpDATA_A.W25Q64_BlockNM] % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// æŒ‰1KBé¡µå¾ªç¯å†™å…¥å®Œæ•´æ•°æ®å—</span></span><br><span class="line">				<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (OTA.FireLen[UpDATA_A.W25Q64_BlockNM] / <span class="number">1024</span>); i++)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// ä»W25Q64è¯»å–1KBæ•°æ®åˆ°ç¼“å†²åŒº</span></span><br><span class="line">                    			<span class="comment">// æºåœ°å€ï¼šå—å·Ã—64KB + åç§»é‡ï¼Œ è¯»å–é•¿åº¦=1KB</span></span><br><span class="line">					W25Q64_Read(UpDATA_A.UpDataBuff, i * FLASH_PAGE_SIZE + <span class="number">64</span> * <span class="number">1024</span> * UpDATA_A.W25Q64_BlockNM, FLASH_PAGE_SIZE);</span><br><span class="line">					<span class="comment">// å°†1KBæ•°æ®å†™å…¥FLASHï¼ˆç›®æ ‡åœ°å€é€’å¢ï¼‰</span></span><br><span class="line">                    <span class="comment">// ç›®æ ‡åœ°å€</span></span><br><span class="line">                    <span class="comment">// æ•°æ®æŒ‡é’ˆï¼ˆå¼ºåˆ¶è½¬æ¢ä¸ºuint32_t*ï¼‰</span></span><br><span class="line">                    <span class="comment">// å†™å…¥é•¿åº¦=1KB</span></span><br><span class="line">					FLASH_Write(FLASH_A_SADDR + i * FLASH_PAGE_SIZE, (<span class="type">uint32_t</span> *)UpDATA_A.UpDataBuff, FLASH_PAGE_SIZE);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// å¤„ç†å‰©ä½™ä¸è¶³1KBçš„æ•°æ®</span></span><br><span class="line">				<span class="keyword">if</span> (OTA.FireLen[UpDATA_A.W25Q64_BlockNM] % <span class="number">1024</span> != <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">memset</span>(UpDATA_A.UpDataBuff, <span class="number">0</span>, FLASH_PAGE_SIZE);</span><br><span class="line">					<span class="comment">// è¯»å–å‰©ä½™æ•°æ®</span></span><br><span class="line">                    <span class="comment">// å‰©ä½™æ•°æ®çš„èµ·å§‹åœ°å€ï¼Œå‰©ä½™æ•°æ®é•¿åº¦</span></span><br><span class="line">					W25Q64_Read(UpDATA_A.UpDataBuff, i * FLASH_PAGE_SIZE + <span class="number">64</span> * <span class="number">1024</span> * UpDATA_A.W25Q64_BlockNM,</span><br><span class="line">					OTA.FireLen[UpDATA_A.W25Q64_BlockNM] % <span class="number">1024</span>);</span><br><span class="line">                    </span><br><span class="line">					<span class="comment">// å†™å…¥å‰©ä½™æ•°æ®åˆ°FLASH</span></span><br><span class="line">					FLASH_Write(FLASH_A_SADDR + i * FLASH_PAGE_SIZE, (<span class="type">uint32_t</span> *)UpDATA_A.UpDataBuff, OTA.FireLen[UpDATA_A.W25Q64_BlockNM] % <span class="number">1024</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// OTAæ›´æ–°åï¼ŒUpDATA_A.W25Q64_BlockNM == 0</span></span><br><span class="line">				<span class="keyword">if</span> (UpDATA_A.W25Q64_BlockNM == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					OTA.OTA_flag = <span class="number">0</span>;				<span class="comment">// æ¸…é™¤OTAæ ‡å¿—</span></span><br><span class="line">					AT24C02_WriteOTA(); 			<span class="comment">// æ›´æ–°åå†™å…¥AT24C02ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// é‡å¯</span></span><br><span class="line">				uprintf(<span class="string">&quot; \r\nAåŒºæ›´æ–°å®Œæ¯• \r\n&quot;</span>);</span><br><span class="line">				__set_FAULTMASK(<span class="number">1</span>); <span class="comment">// å±è”½æ‰€æœ‰å¼‚å¸¸</span></span><br><span class="line">				Delay_ms(<span class="number">100</span>);</span><br><span class="line">				NVIC_SystemReset(); <span class="comment">// ç³»ç»Ÿå¤ä½</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;é•¿åº¦é”™è¯¯\r\n&quot;</span>);	 <span class="comment">// æ•°æ®é•¿åº¦æœªå¯¹é½</span></span><br><span class="line">				BootState &amp;= ~UPDATA_A_FLAG; <span class="comment">// æ¸…é™¤æ›´æ–°æ ‡å¿—</span></span><br><span class="line">				BootLoader_Info();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="xmodemåè®®"><a class="markdownIt-Anchor" href="#xmodemåè®®"></a> Xmodemåè®®</h1>
<p><strong>Xmodemä½¿ç”¨SecureCRTP</strong>è½¯ä»¶é…ç½®è¿æ¥ä¸²å£é€šä¿¡ï¼Œç›¸è¾ƒäºYmodemæ˜¯æ›´å°çš„Package</p>
<h2 id="æ ¼å¼"><a class="markdownIt-Anchor" href="#æ ¼å¼"></a> æ ¼å¼</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Byte1</th>
<th style="text-align:center">Byte2</th>
<th style="text-align:center">Byte3</th>
<th style="text-align:center">Byte4 ~ Byte131</th>
<th style="text-align:center">Byte132 ~ Byte133</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Start of Header(SOH)</td>
<td style="text-align:center">Packet Number</td>
<td style="text-align:center">~(Packet Number)</td>
<td style="text-align:center">Pcacket Data</td>
<td style="text-align:center">CRC16 Check</td>
</tr>
</tbody>
</table>
<h2 id="æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#æŒ‡ä»¤"></a> æŒ‡ä»¤</h2>
<table>
<thead>
<tr>
<th style="text-align:center">ä½</th>
<th style="text-align:center">æŒ‡ä»¤</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SOH</td>
<td style="text-align:center">0x01</td>
<td style="text-align:center">128å­—èŠ‚æ•°æ®åŒ…å¸§å¤´</td>
</tr>
<tr>
<td style="text-align:center">STX</td>
<td style="text-align:center">0x02</td>
<td style="text-align:center">1024å­—èŠ‚æ•°æ®åŒ…å¸§å¤´</td>
</tr>
<tr>
<td style="text-align:center">EOT</td>
<td style="text-align:center">0x04</td>
<td style="text-align:center">ç»“æŸä¼ è¾“</td>
</tr>
<tr>
<td style="text-align:center">ACK</td>
<td style="text-align:center">0x06</td>
<td style="text-align:center">æ­£ç¡®åº”ç­”</td>
</tr>
<tr>
<td style="text-align:center">NAK</td>
<td style="text-align:center">0x15</td>
<td style="text-align:center">é”™è¯¯åº”ç­”ï¼Œé‡ä¼ æ•°æ®</td>
</tr>
<tr>
<td style="text-align:center">CAN</td>
<td style="text-align:center">0x18</td>
<td style="text-align:center">å–æ¶ˆä¼ è¾“</td>
</tr>
<tr>
<td style="text-align:center">CTRLZ</td>
<td style="text-align:center">0x1A</td>
<td style="text-align:center">æ•°æ®å¡«å……</td>
</tr>
<tr>
<td style="text-align:center">HSC</td>
<td style="text-align:center">0x43</td>
<td style="text-align:center">æ¡æ‰‹</td>
</tr>
</tbody>
</table>
<h2 id="ä¾‹å­"><a class="markdownIt-Anchor" href="#ä¾‹å­"></a> ä¾‹å­</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">â€˜Câ€™											<span class="comment">// å‘é€ä¸€ä¸ªCç­‰å¾…æ•°æ®åŒ…</span></span><br><span class="line">											<span class="comment">// (3sä¸€æ¬¡ï¼Œç­‰å¾…åº”ç­”)</span></span><br><span class="line">SOH | <span class="number">0x01</span> | <span class="number">0xFE</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬ä¸€æ¡æŒ‡ä»¤</span></span><br><span class="line">ACKï¼ˆæ­£ç¡®åº”ç­”ï¼‰</span><br><span class="line">SOH | <span class="number">0x02</span> | <span class="number">0xFD</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬äºŒæ¡æŒ‡ä»¤</span></span><br><span class="line">NAKï¼ˆé”™è¯¯åº”ç­”ï¼‰</span><br><span class="line">SOH | <span class="number">0x02</span> | <span class="number">0xFD</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬äºŒæ¡æŒ‡ä»¤</span></span><br><span class="line">ACK</span><br><span class="line">SOH | <span class="number">0x03</span> | <span class="number">0xFC</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16s	<span class="comment">// ç¬¬ä¸‰æ¡æŒ‡ä»¤</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h2 id="crc16ç¨‹åº"><a class="markdownIt-Anchor" href="#crc16ç¨‹åº"></a> CRC16ç¨‹åº</h2>
<p>STM32æ”¯æŒCRC32ï¼Œä¸æ”¯æŒCRC16ï¼Œéœ€è¦è‡ªå·±å†™</p>
<p>å¤šé¡¹å¼p(x) = <strong>x^16 + x^12 + x^5 + 1</strong>ï¼Œå€ŸåŠ©å¤šé¡¹å¼å°†è¾“å…¥çš„æ•°å€¼è¿›è¡Œ<strong>æ¨¡2é™¤æ³•</strong>ï¼Œåœ¨Cè¯­è¨€ä¸­æ˜¯è¿›è¡Œ<strong>å¼‚æˆ–è¿ç®—</strong>^ã€‚</p>
<p><img src="https://s2.loli.net/2025/05/09/V1B2YkysPQZipdg.png" alt="" /></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ–‡å­—è¯´æ˜</span></span><br><span class="line">å¯„å­˜å™¨æ¸…é›¶</span><br><span class="line">æ•°æ®æœ€å³è¾¹è¡¥é½Wä½<span class="number">0</span> 							<span class="comment">// Wæ˜¯CRCæ ¡éªŒå€¼çš„ä½æ•°</span></span><br><span class="line">when(è¿˜æœ‰æ•°æ®)&#123;</span><br><span class="line">    å·¦ç§»å¯„å­˜å™¨<span class="number">1</span>ä½ï¼Œè¯»å–æ•°æ®çš„ä¸‹ä¸€ä½åˆ°å¯„å­˜å™¨çš„bit <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (å·¦ç§»å¯„å­˜å™¨æ—¶å‡ºç°æº¢å‡º)&#123;</span><br><span class="line">        å¯„å­˜å™¨ ^= poly;    				<span class="comment">// è¿™é‡Œçš„poly=0011ï¼ŒæŒ‰ç…§ä¸Šé¢çš„ä¾‹å­</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">å¯„å­˜å™¨çš„å€¼å°±æ˜¯æ ¡éªŒå€¼</span><br><span class="line">    </span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">Xmodem_CRC16</span><span class="params">(<span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> i;</span><br><span class="line">	<span class="type">uint16_t</span> Crcinit = <span class="number">0x0000</span>; 	<span class="comment">// åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">	<span class="type">uint16_t</span> Poly = <span class="number">0x1021</span>;	   	<span class="comment">// XMODEM ä½¿ç”¨çš„å¤šé¡¹å¼ï¼šx^16 + x^12 + x^5 + 1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (datalen--)</span><br><span class="line">	&#123;</span><br><span class="line">		Crcinit = (*data &lt;&lt; <span class="number">8</span>) ^ Crcinit;</span><br><span class="line">		<span class="comment">// å·¦ç§»å…«ä½æ˜¯å› ä¸ºCRCæ˜¯é«˜ä½ä¼˜å…ˆè®¡ç®—ï¼Œå¼‚æˆ–æ˜¯ä¸ºäº†æ”¹å˜å½“å‰CRCçš„å€¼</span></span><br><span class="line">		<span class="comment">// å¼‚æˆ–å°†æ–°æ•°æ®â€œæ··åˆâ€è¿›å½“å‰çš„CRCå€¼ï¼Œä½¿CRCè®¡ç®—èƒ½è¦†ç›–æ‰€æœ‰è¾“å…¥æ•°æ®</span></span><br><span class="line">		<span class="comment">// è‹¥ç›´æ¥èµ‹å€¼ä¼šä¸¢å¤±ä¹‹å‰è®¡ç®—çš„CRCå€¼</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">// æ¯ä¸ªbitéƒ½è¦å½±å“CRCè®¡ç®—ï¼Œæ‰€ä»¥å¿…é¡»å¾ªç¯ 8 æ¬¡</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (Crcinit &amp; <span class="number">0x8000</span>) 	<span class="comment">// æ£€æŸ¥æœ€é«˜ä½æ˜¯å¦ä¸º1</span></span><br><span class="line">				Crcinit = (Crcinit &lt;&lt; <span class="number">1</span>) ^ Poly;</span><br><span class="line">			<span class="comment">// å¦‚æœæœ€é«˜ä½æ˜¯1ï¼Œè¯´æ˜å½“å‰çš„CRCå€¼å·²ç»è¾¾åˆ°æˆ–è¶…è¿‡å¤šé¡¹å¼çš„æœ€é«˜ä½(Polyæœ€é«˜ä½ä¸º0x1000)</span></span><br><span class="line">			<span class="comment">// å¿…é¡»å‡å»å¤šé¡¹(å³^Poly)å¦åˆ™CRCå€¼ä¼šè¶Šæ¥è¶Šå¤§</span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				Crcinit = (Crcinit &lt;&lt; <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		data++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Crcinit;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<p><a href="https://github.com/havenxie/stm32-iap-uart-boot">havenxie/stm32-iap-uart-boot: STM32 IAP(UARTæ¨¡å¼)çš„BOOTéƒ¨åˆ†</a></p>
<p><a href="https://www.bilibili.com/video/BV1SatHeBEVG/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click">ã€æ‰‹æŠŠæ‰‹æ•™ç¨‹ 4Gé€šä¿¡ç‰©è”ç½‘ OTAè¿œç¨‹å‡çº§ BootLoaderç¨‹åºè®¾è®¡ã€‘GD32F103C8T6å•ç‰‡æœºã€ä¸Šç¯‡ç« ã€‘_å“”å“©å“”å“©_bilibili</a></p>
<h1 id="è¡¥å……724"><a class="markdownIt-Anchor" href="#è¡¥å……724"></a> è¡¥å……ï¼ˆ7.24ï¼‰</h1>
<h2 id="bootloaderæ‰§è¡Œæµç¨‹"><a class="markdownIt-Anchor" href="#bootloaderæ‰§è¡Œæµç¨‹"></a> Bootloaderæ‰§è¡Œæµç¨‹</h2>
<ol>
<li>
<p><strong>ä¸Šç”µæˆ–å¤ä½</strong></p>
<ul>
<li>å½“ç³»ç»Ÿä¸Šç”µæˆ–å¤ä½æ—¶ï¼Œå¤„ç†å™¨ä»ä¸€ä¸ªå›ºå®šçš„åœ°å€å¼€å§‹æ‰§è¡Œï¼Œè¿™ä¸ªåœ°å€ç§°ä¸º <strong>å‘é‡è¡¨ï¼ˆVector Tableï¼‰</strong> çš„èµ·å§‹åœ°å€ã€‚</li>
</ul>
</li>
<li>
<p><strong>è¯»å–å‘é‡è¡¨åœ°å€ï¼ˆæ¯”å¦‚ Flash èµ·å§‹åœ°å€ï¼‰</strong></p>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒARM Cortex-M å¤„ç†å™¨ä¼šä»åœ°å€ <strong>0x08000000</strong>ï¼ˆå³ Flash èµ·å§‹åœ°å€ï¼‰è¯»å–ï¼š
<ul>
<li><code>0x08000000</code>ï¼šåˆå§‹ <strong>MSPï¼ˆMain Stack Pointerï¼‰</strong></li>
<li><code>0x08000004</code>ï¼š<strong>Reset Handler çš„åœ°å€</strong>ï¼Œä¹Ÿå°±æ˜¯ä¸»ç¨‹åºçš„å…¥å£ç‚¹</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>è®¾ç½® MSP</strong></p>
</li>
</ol>
<ul>
<li>å¤„ç†å™¨å°† <code>0x08000000</code> å¤„çš„å€¼åŠ è½½åˆ° MSPï¼ˆMain Stack Pointerï¼‰ï¼Œä¸ºå †æ ˆåˆå§‹åŒ–ã€‚</li>
</ul>
<ol start="4">
<li><strong>è·³è½¬åˆ° Reset Handler</strong>
<ul>
<li>å¤„ç†å™¨å°† <code>0x08000004</code> å¤„çš„å€¼ä½œä¸ºç¨‹åºè®¡æ•°å™¨ PCï¼Œå¼€å§‹æ‰§è¡Œå®é™…ç¨‹åºã€‚</li>
</ul>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®ä¸»æ ˆæŒ‡é’ˆ</span></span><br><span class="line">__ASM <span class="type">void</span> <span class="title function_">MSR_SP</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	MSR MSP, r0;</span><br><span class="line">	BX r14;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·³è½¬åˆ°AåŒºåº”ç”¨ç¨‹åº</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LOAD_A</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>((*(<span class="type">uint32_t</span> *)addr &gt;= <span class="number">0x20000000</span>) &amp;&amp; (*(<span class="type">uint32_t</span> *)addr &lt;= <span class="number">0x20004FFF</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		MSR_SP(*(<span class="type">uint32_t</span> *)addr);</span><br><span class="line">		load_A = (load_a)*(<span class="type">uint32_t</span> *)(addr + <span class="number">4</span>);</span><br><span class="line">		load_A();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		uprintf(<span class="string">&quot;Failed to jump to Area A \r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="sramåœ¨æ­¤çš„æ„ä¹‰"><a class="markdownIt-Anchor" href="#sramåœ¨æ­¤çš„æ„ä¹‰"></a> SRAMåœ¨æ­¤çš„æ„ä¹‰</h2>
<ul>
<li>
<p>SRAMï¼ˆStatic RAMï¼‰æ˜¯ MCU çš„è¿è¡Œå†…å­˜ï¼ˆRAMï¼‰ï¼Œå †æ ˆã€å…¨å±€å˜é‡ã€å±€éƒ¨å˜é‡éƒ½å­˜æ”¾åœ¨è¿™é‡Œã€‚</p>
</li>
<li>
<p>MSP æŒ‡é’ˆä¸€èˆ¬ä¼šæŒ‡å‘ SRAM çš„é¡¶ç«¯ï¼ˆä¾‹å¦‚ <code>0x20000000</code>ï¼‰ï¼Œå‘ä¸‹å¢é•¿ã€‚</p>
</li>
<li>
<p>åº”ç”¨ç¨‹åºè¿è¡ŒæœŸé—´æ‰€æœ‰åŠ¨æ€æ•°æ®ã€å †æ ˆå¸§ç­‰éƒ½å­˜åœ¨äº SRAM ä¸­ã€‚</p>
</li>
</ul>
<h2 id="appç¨‹åºé…ç½®"><a class="markdownIt-Anchor" href="#appç¨‹åºé…ç½®"></a> APPç¨‹åºé…ç½®</h2>
<ol>
<li>
<p>system_stm32f10x.cæ–‡ä»¶ä¸­çš„VECT_TAB_OFFSETï¼Œè®¾ç½®0x5000</p>
</li>
<li>
<p>é…ç½®Target</p>
</li>
</ol>
<p><img src="https://s2.loli.net/2025/07/24/r9UhFepacuX4bDy.png" alt="" /></p>
<h2 id="dmaé…ç½®rx_buffer-1é…åˆidleå®ç°æ¥æ”¶ä¸å®šé•¿æ•°æ®"><a class="markdownIt-Anchor" href="#dmaé…ç½®rx_buffer-1é…åˆidleå®ç°æ¥æ”¶ä¸å®šé•¿æ•°æ®"></a> DMAé…ç½®RX_BUFFER + 1é…åˆIDLEå®ç°æ¥æ”¶ä¸å®šé•¿æ•°æ®</h2>
<ol>
<li>
<p><strong>DMAè®¾ç½®</strong>ï¼šä¼ è¾“è®¡æ•°ä¸ºRX_BUFFER + 1</p>
</li>
<li>
<p><strong>IDLEè§¦å‘</strong>ï¼šå½“æ¥æ”¶æ•°æ®é•¿åº¦å°äºè®¾ç½®è®¡æ•°æ—¶è§¦å‘</p>
</li>
<li>
<p><strong>é•¿åº¦è®¡ç®—</strong>ï¼šé€šè¿‡å‰©ä½™è®¡æ•°è®¡ç®—å®é™…æ¥æ”¶é•¿åº¦</p>
</li>
<li>
<p><strong>é‡æ–°é…ç½®</strong>ï¼šæ¯æ¬¡IDLEä¸­æ–­åé‡æ–°é…ç½®DMA</p>
</li>
</ol>
<h2 id="ä¸ºä»€ä¹ˆdmaä¸ä½¿ç”¨å¾ªç¯æ¨¡å¼è€Œæ˜¯æ™®é€šæ¨¡å¼"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆdmaä¸ä½¿ç”¨å¾ªç¯æ¨¡å¼è€Œæ˜¯æ™®é€šæ¨¡å¼"></a> ä¸ºä»€ä¹ˆDMAä¸ä½¿ç”¨å¾ªç¯æ¨¡å¼ï¼Œè€Œæ˜¯æ™®é€šæ¨¡å¼</h2>
<p>DMAå¦‚æœ<strong>ä½¿ç”¨å¾ªç¯æ¨¡å¼</strong>ï¼Œä¼šè‡ªåŠ¨å¾ªç¯ä½¿ç”¨åŒä¸€ä¸ªç¼“å†²åŒºï¼Œ<strong>æ— æ³•åŒºåˆ†ä¸åŒæ•°æ®åŒ…çš„è¾¹ç•Œ</strong>ï¼Œæ•°æ®ä¼šè¦†ç›–ï¼Œæ— æ³•å®ç°æ•°æ®åŒ…ç®¡ç†ï¼›è€Œä½¿ç”¨<strong>æ™®é€šæ¨¡å¼+IDLE</strong>ï¼Œå¯ä»¥<strong>å‡†ç¡®è®¡ç®—æ¯ä¸ªæ•°æ®åŒ…çš„é•¿åº¦</strong>ã€‚</p>
<ul>
<li>
<p>æ•°æ®åŒ…è¾¹ç•Œè¯†åˆ«</p>
</li>
<li>
<p>å†…å­˜ç®¡ç†çµæ´»æ€§</p>
</li>
<li>
<p>æ•°æ®é•¿åº¦è®¡ç®—</p>
</li>
<li>
<p>æ•°æ®åŒ…é˜Ÿåˆ—</p>
</li>
</ul>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>STM32</tag>
      </tags>
  </entry>
  <entry>
    <title>CANé€šä¿¡å­¦ä¹ </title>
    <url>/2025/07/12/CAN%E9%80%9A%E4%BF%A1%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="cané€šä¿¡ç¬”è®°"><a class="markdownIt-Anchor" href="#cané€šä¿¡ç¬”è®°"></a> CANé€šä¿¡ç¬”è®°</h1>
<p>CANï¼ˆController Area Network Busï¼‰ï¼Œæ§åˆ¶å±€åŸŸç½‘æ€»çº¿ã€‚</p>
<h2 id="åŸºæœ¬ç‰¹å¾"><a class="markdownIt-Anchor" href="#åŸºæœ¬ç‰¹å¾"></a> åŸºæœ¬ç‰¹å¾</h2>
<ul>
<li>
<p>ä¸¤æ ¹é€šä¿¡çº¿ï¼ˆCAN_Hã€CAN_Lï¼‰ï¼Œ<strong>æ— éœ€å…±åœ°</strong></p>
</li>
<li>
<p><strong>å·®åˆ†ä¿¡å·</strong>é€šä¿¡ï¼ŒæŠ—å¹²æ‰°èƒ½åŠ›å¼º</p>
</li>
<li>
<p>é«˜é€ŸCANï¼ˆISO11898ï¼‰ï¼š125k~1Mbpsï¼Œ&lt;40m</p>
</li>
<li>
<p>ä½é€ŸCANï¼ˆISO11519ï¼‰ï¼š10k~125kbpsï¼Œ&lt;1km</p>
</li>
<li>
<p><strong>å¼‚æ­¥</strong>ï¼Œæ— éœ€æ—¶é’Ÿçº¿ï¼Œé€šä¿¡é€Ÿç‡ç”±åŒæ–¹åå®š</p>
</li>
<li>
<p><strong>åŠåŒå·¥</strong>ï¼Œå¯æŒ‚è½½å¤šè®¾å¤‡ï¼Œ<strong>å¤šè®¾å¤‡åŒæ—¶å‘é€é€šè¿‡ä»²è£åˆ¤æ–­å…ˆå</strong></p>
</li>
<li>
<p><strong>11/29ä½æŠ¥æ–‡ID</strong>ï¼Œç”¨äºåŒºåˆ†æ¶ˆæ¯åŠŸèƒ½ï¼ŒåŒæ—¶å†³å®šä¼˜å…ˆçº§**ï¼ˆå°çš„ä¼˜å…ˆï¼‰**</p>
</li>
<li>
<p>å¯é…ç½®<strong>1~8å­—èŠ‚çš„æœ‰æ•ˆè½½è·</strong></p>
</li>
<li>
<p>å¯å®ç°<strong>å¹¿æ’­å¼å’Œè¯·æ±‚å¼</strong>ä¸¤ç§ä¼ è¾“</p>
</li>
<li>
<p>åº”ç­”ã€CRCæ ¡éªŒã€ä½å¡«å……ã€ä½åŒæ­¥ã€é”™è¯¯å¤„ç†ç­‰ç‰¹æ€§</p>
</li>
</ul>
<h2 id="ç¡¬ä»¶ç”µè·¯"><a class="markdownIt-Anchor" href="#ç¡¬ä»¶ç”µè·¯"></a> ç¡¬ä»¶ç”µè·¯</h2>
<p><img src="https://s2.loli.net/2025/07/24/FydOPNIJWvxrp94.png" alt="" /></p>
<h3 id="ä¸¤ä¸ªç»ˆç«¯ç”µé˜»çš„æ„ä¹‰"><a class="markdownIt-Anchor" href="#ä¸¤ä¸ªç»ˆç«¯ç”µé˜»çš„æ„ä¹‰"></a> ä¸¤ä¸ªç»ˆç«¯ç”µé˜»çš„æ„ä¹‰</h3>
<ol>
<li>
<p><strong>é˜²æ­¢å›æ³¢åå°„</strong></p>
</li>
<li>
<p><strong>æ²¡æœ‰è®¾å¤‡æ“ä½œæ—¶</strong>ï¼Œå°†ä¸¤æ ¹å·®åˆ†çº¿ç”µå‹â€œæ”¶ç´§â€ï¼Œ<strong>ä½¿å…¶ç”µå‹ä¸€è‡´</strong></p>
</li>
</ol>
<p>ï¼ˆé«˜é€ŸCANçš„ç”µé˜»é˜»å€¼å°ï¼Œæ‰€ä»¥æ”¶ç´§æ›´å¿«ï¼Œä½†èƒ½è€—æ›´å¤§ï¼‰</p>
<h3 id="ç”µå¹³æ ‡å‡†"><a class="markdownIt-Anchor" href="#ç”µå¹³æ ‡å‡†"></a> ç”µå¹³æ ‡å‡†</h3>
<p>CANæ€»çº¿ä½¿ç”¨<strong>å·®åˆ†ä¿¡å·</strong>,å³ï¼ˆ<strong>Vcan_H - Vcan_L</strong>ï¼‰</p>
<ul>
<li><strong>é«˜é€ŸCAN</strong>è§„å®š</li>
</ul>
<p>ç”µå‹å·®ä¸º0Vè¡¨ç¤ºé€»è¾‘1ï¼ˆéšæ€§ç”µå¹³ï¼‰</p>
<p>ç”µå‹å·®ä¸º2Vè¡¨ç¤ºé€»è¾‘0ï¼ˆæ˜¾æ€§ç”µå¹³ï¼‰</p>
<ul>
<li><strong>ä½é€ŸCAN</strong>è§„å®š</li>
</ul>
<p>ç”µå‹å·®ä¸º-1.5Vè¡¨ç¤ºé€»è¾‘1ï¼ˆéšæ€§ç”µå¹³ï¼‰</p>
<p>ç”µå‹å·®ä¸º3Vè¡¨ç¤ºé€»è¾‘0ï¼ˆæ˜¾æ€§ç”µå¹³ï¼‰</p>
<h2 id="å¸§æ ¼å¼"><a class="markdownIt-Anchor" href="#å¸§æ ¼å¼"></a> å¸§æ ¼å¼</h2>
<table>
<thead>
<tr>
<th style="text-align:center">å¸§ç±»å‹</th>
<th style="text-align:center">ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ•°æ®å¸§</td>
<td style="text-align:center">å‘é€è®¾å¤‡ä¸»åŠ¨å‘é€æ•°æ®</td>
</tr>
<tr>
<td style="text-align:center">é¥æ§å¸§</td>
<td style="text-align:center">æ¥æ”¶è®¾å¤‡ä¸»åŠ¨è¯·æ±‚æ•°æ®</td>
</tr>
<tr>
<td style="text-align:center">é”™è¯¯å¸§</td>
<td style="text-align:center">æŸä¸ªè®¾å¤‡æ£€æµ‹å‡ºé”™è¯¯æ—¶å‘å…¶ä»–è®¾å¤‡é€šçŸ¥é”™è¯¯</td>
</tr>
<tr>
<td style="text-align:center">è¿‡è½½å¸§</td>
<td style="text-align:center">æ¥æ”¶è®¾å¤‡é€šçŸ¥å…¶å°šæœªåšå¥½æ¥æ”¶å‡†å¤‡</td>
</tr>
<tr>
<td style="text-align:center">å¸§é—´éš”</td>
<td style="text-align:center">ç”¨äºå°†æ•°æ®å¸§åŠé¥æ§å¸§ä¸å‰é¢çš„å¸§åˆ†éš”å¼€</td>
</tr>
</tbody>
</table>
<h3 id="æ•°æ®å¸§"><a class="markdownIt-Anchor" href="#æ•°æ®å¸§"></a> æ•°æ®å¸§</h3>
<p><img src="https://s2.loli.net/2025/07/24/NIBvbY56zMZ3LQx.png" alt="" /></p>
<p>SOFï¼ˆStart of Frameï¼‰ï¼šå¸§èµ·å§‹ï¼Œè¡¨ç¤ºåé¢ä¸€æ®µæ³¢å½¢æ˜¯ä¼ è¾“çš„æ•°æ®ä½</p>
<p>IDï¼ˆIdentifyï¼‰ï¼šæ ‡è¯†ç¬¦ï¼ŒåŒºåˆ†åŠŸèƒ½ï¼Œå†³å®šä¼˜å…ˆçº§</p>
<p>RTRï¼ˆRemote Transmission Requestï¼‰ï¼šæ•°æ®å¸§ï¼ˆ0ï¼‰ï¼Œé¥æ§å¸§ï¼ˆ1ï¼‰ã€‚</p>
<p>IDEï¼ˆIdentifier Extensionï¼‰ï¼šç”¨äºåŒºåˆ†æ ‡å‡†æ ¼å¼ï¼ˆ0ï¼‰å’Œæ‰©å±•æ ¼å¼ï¼ˆ1ï¼‰</p>
<p>r0/r1ï¼ˆReserveï¼‰ï¼šä¿ç•™ä½ï¼Œä¸ºåç»­ç•™ç©ºé—´</p>
<p>DLCï¼ˆData Length Codeï¼‰ï¼šæ•°æ®é•¿åº¦</p>
<p>ACKæ§½ï¼Œå‘é€æ–¹ï¼ˆ1ï¼‰ï¼Œæ¥æ”¶æ–¹ï¼ˆ0ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ¥æ”¶æ–¹å°±ï¼ˆ1ï¼‰ï¼Œå‘ŠçŸ¥å‘é€æ–¹</p>
<p><strong>ACKæ§½å…è®¸å¤šä¸ªæ¥æ”¶æ–¹å…±åŒæ‹‰å¼€æ€»çº¿</strong></p>
<p><strong>SRR</strong>ï¼šæ›¿ä»£RTRçš„ä½ï¼Œç”¨äº<strong>ä¿è¯æ ‡å‡†æ ¼å¼é«˜äºæ‰©å±•æ ¼å¼çš„ä¼˜å…ˆçº§</strong></p>
<p>EOFï¼ˆEnd of Frameï¼‰ï¼šå¸§ç»“æŸï¼Œè¡¨ç¤ºä¼ è¾“å®Œæ¯•</p>
<h3 id="é¥æ§å¸§"><a class="markdownIt-Anchor" href="#é¥æ§å¸§"></a> é¥æ§å¸§</h3>
<p><strong>é¥æ§å¸§æ— æ•°æ®æ®µï¼ŒRTRä¸ºéšå½¢ç”µå¹³1</strong>ï¼Œå…¶ä»–éƒ¨åˆ†ä¸æ•°æ®å¸§ç›¸åŒ</p>
<p><img src="https://s2.loli.net/2025/07/24/ivsZVrE8J4Tb5FU.png" alt="" /></p>
<h3 id="é”™è¯¯å¸§"><a class="markdownIt-Anchor" href="#é”™è¯¯å¸§"></a> é”™è¯¯å¸§</h3>
<p>æ€»çº¿ä¸Šæ‰€æœ‰è®¾å¤‡éƒ½ä¼šç›‘ç£æ€»çº¿æ•°æ®ï¼Œä¸€æ—¦å‘ç°â€œä½é”™è¯¯â€ã€â€œå¡«å……é”™è¯¯â€ã€â€œCRCé”™è¯¯â€ã€â€œæ ¼å¼é”™è¯¯â€ã€â€œåº”ç­”é”™è¯¯â€ï¼Œ<strong>è¿™äº›è®¾å¤‡å°±ä¼šå‘å‡ºé”™è¯¯å¸§æ¥ç ´åæ•°æ®ï¼ŒåŒæ—¶ç»ˆæ­¢å½“å‰çš„å‘é€è®¾å¤‡</strong>ã€‚</p>
<p><img src="https://s2.loli.net/2025/07/24/ywMD7HjAbCeGX3B.png" alt="" /></p>
<ul>
<li>ä¸»åŠ¨é”™è¯¯ä¼šç ´ååˆ«äººçš„ï¼Œè¢«åŠ¨é”™è¯¯ä¼šç ´åè‡ªå·±çš„</li>
</ul>
<h3 id="è¿‡è½½å¸§"><a class="markdownIt-Anchor" href="#è¿‡è½½å¸§"></a> è¿‡è½½å¸§</h3>
<p>æ¥æ”¶æ–¹æ”¶åˆ°å¤§é‡æ•°æ®è€Œæ— æ³•å¤„ç†æ—¶ï¼Œå…¶å¯ä»¥å‘å‡ºè¿‡è½½å¸§ï¼Œå»¶ç¼“å‘é€æ–¹çš„æ•°æ®å‘é€ï¼Œä»¥å¹³è¡¡æ€»çº¿è´Ÿæ‹…ï¼Œé¿å…æ•°æ®ä¸¢å¤±ã€‚</p>
<p><img src="https://s2.loli.net/2025/07/24/4RGkZDB1efXtS5U.png" alt="" /></p>
<h3 id="å¸§é—´éš”"><a class="markdownIt-Anchor" href="#å¸§é—´éš”"></a> å¸§é—´éš”</h3>
<p>å°†æ•°æ®å¸§å’Œè¿œç¨‹å¸§ä¸å‰é¢çš„å¸§åˆ†ç¦»å¼€</p>
<p><img src="https://s2.loli.net/2025/07/24/Au6SR5a4dLzi2br.png" alt="" /></p>
<h3 id="ä½å¡«å……"><a class="markdownIt-Anchor" href="#ä½å¡«å……"></a> ä½å¡«å……</h3>
<p><strong>è§„åˆ™</strong>ï¼šå‘é€æ–¹<strong>è¿ç»­å‘é€5ä¸ªç›¸åŒç”µå¹³</strong>åï¼Œè‡ªåŠ¨<strong>è¿½åŠ ä¸€ä¸ªç›¸åç”µå¹³</strong>çš„å¡«å……ä½ï¼›<strong>æ¥æ”¶æ–¹</strong>æ£€æµ‹åˆ°å¡«å……ä½æ—¶ï¼Œ<strong>ä¼šè‡ªåŠ¨ç§»é™¤</strong>ï¼Œæ¢å¤åŸå§‹æ•°æ®ã€‚</p>
<p>ä¾‹å¦‚ï¼š<br />
å³æ—¶å‘é€ï¼š 100000110       10000011110</p>
<p>å®é™…å‘é€ï¼š 1000001110     1000001111100</p>
<p>å®é™…æ¥æ”¶ï¼š 1000001110     1000001111100</p>
<p>ç§»é™¤å¡«å……ï¼š 100000110       10000011110</p>
<p><strong>ä½å¡«å……çš„ä½œç”¨</strong>ï¼š</p>
<ul>
<li>å¢åŠ æ³¢å½¢çš„å®šä½ä¿¡æ¯ï¼Œåˆ©äºæ¥æ”¶æ–¹æ‰§è¡Œâ€œå†åŒæ­¥â€ï¼Œé˜²æ­¢æ³¢å½¢é•¿æ—¶é—´æ— å˜åŒ–ï¼Œå½“åªæ¥æ”¶æ–¹ä¸èƒ½ç²¾å‡†æŒæ¡æ•°æ®é‡‡æ ·æ—¶æœº</li>
<li>å°†æ­£å¸¸æ•°æ®æµä¸â€œé”™è¯¯å¸§â€ã€â€œè¿‡è½½å¸§â€åŒºåˆ†å¼€</li>
<li>ä¿æŒCANæ€»çº¿åœ¨å‘é€æ­£å¸¸æ•°æ®æµæ—¶çš„æ´»è·ƒçŠ¶æ€ï¼Œé˜²æ­¢è¢«æ€»çº¿è¯¯è®¤ä¸ºç©ºé—²</li>
</ul>
<h2 id="ä½åŒæ­¥"><a class="markdownIt-Anchor" href="#ä½åŒæ­¥"></a> ä½åŒæ­¥</h2>
<ul>
<li>
<p>CANæ€»çº¿æ²¡æœ‰æ—¶é’Ÿçº¿ï¼Œæ€»çº¿ä¸Šæ‰€æœ‰è®¾å¤‡é€šè¿‡<strong>çº¦å®šæ³¢ç‰¹ç‡</strong>æ¥<strong>ç¡®å®šæ¯ä¸€ä½æ•°æ®ä½æ—¶é•¿</strong></p>
</li>
<li>
<p>å‘é€æ–¹ä»¥çº¦å®šçš„ä½æ—¶é•¿æ¯éš”å›ºå®šæ—¶é—´è¾“å‡ºä¸€ä¸ªæ•°æ®ä½</p>
</li>
<li>
<p>æ¥æ”¶æ–¹ä»¥çº¦å®šçš„ä½æ—¶é•¿æ¯ä¸ªå›ºå®šæ—¶é—´é‡‡æ ·æ€»çº¿çš„ç”µå¹³ï¼Œè¾“å…¥ä¸€ä¸ªæ•°æ®ä½</p>
</li>
<li>
<p>ç†æƒ³çŠ¶æ€ä¸‹ï¼Œæ¥æ”¶æ–¹èƒ½ä¾æ¬¡é‡‡æ ·åˆ°å‘é€æ–¹å‘å‡ºçš„æ¯ä¸ªæ•°æ®ä½ï¼Œä¸”é‡‡æ ·ç‚¹ä½äºæ•°æ®ä½ä¸­å¿ƒé™„è¿‘</p>
</li>
</ul>
<h3 id="ä½æ—¶åº"><a class="markdownIt-Anchor" href="#ä½æ—¶åº"></a> ä½æ—¶åº</h3>
<p>ä¸ºäº†èƒ½å¤Ÿçµæ´»è°ƒæ•´æ¯ä¸ªé‡‡æ ·ç‚¹çš„ä½ç½®ï¼Œä½¿é‡‡æ ·ç‚¹å¯¹é½æ•°æ®ä½ä¸­å¿ƒé™„è¿‘ï¼Œ<strong>CANæ€»çº¿å¯¹æ¯ä¸€ä¸ªæ•°æ®ä½çš„æ—¶é•¿è¿›è¡Œæ›´ç»†åˆ’åˆ†</strong>ï¼Œåˆ†ä¸ºåŒæ­¥æ®µï¼ˆSSï¼‰ã€ä¼ æ’­æ—¶é—´æ®µï¼ˆPTSï¼‰ã€ç›¸ä½ç¼“å†²æ®µ1ï¼ˆPBS1ï¼‰å’Œç›¸ä½ç¼“å†²æ®µ2ï¼ˆPBS2ï¼‰ï¼Œæ¯éš”æ®µç”±è‹¥å¹²ä¸ªæœ€å°æ—¶é—´å•ä½ï¼ˆTqï¼‰æ„æˆ</p>
<ul>
<li>SS = 1Tq</li>
<li>PTS = 1 ~ 8 Tq</li>
<li>PBS1 = 1 ~ 8 Tq</li>
<li>PBS2 = 2 ~ 8 Tq</li>
</ul>
<p><img src="https://s2.loli.net/2025/07/24/ntCflEzV3guBori.png" alt="" /></p>
<p><strong>æœ€å¼€å§‹å°±æ²¡æœ‰åŒæ­¥æ—¶åº</strong>ã€‚</p>
<h3 id="ç¡¬åŒæ­¥åˆå§‹ä½ç½®åŒæ­¥"><a class="markdownIt-Anchor" href="#ç¡¬åŒæ­¥åˆå§‹ä½ç½®åŒæ­¥"></a> ç¡¬åŒæ­¥(åˆå§‹ä½ç½®åŒæ­¥)</h3>
<p>æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªä½æ—¶åºè®¡æ—¶å‘¨æœŸï¼Œå½“æŸä¸ªè®¾å¤‡ï¼ˆå‘é€æ–¹ï¼‰ç‡å…ˆå‘é€æŠ¥æ–‡ï¼Œå…¶ä»–æ‰€æœ‰è®¾å¤‡ï¼ˆæ¥æ”¶æ–¹ï¼‰æ”¶åˆ°SOFçš„ä¸‹é™æ²¿æ—¶ï¼Œæ¥æ”¶æ–¹ä¼šå°†è‡ªå·±çš„ä½æ—¶åºè®¡æ—¶å‘¨æœŸæ‹¨åˆ°SSæ®µï¼Œä¸å‘é€æ–¹çš„ä½æ—¶åºè®¡æ—¶å‘¨æœŸä¿æŒåŒæ­¥ï¼›</p>
<p><strong>ç¡¬åŒæ­¥åªåœ¨ç¬¬ä¸€ä¸ªä¸‹é™æ²¿ï¼ˆSOFä¸‹é™æ²¿ï¼‰æœ‰æ•ˆ</strong>ï¼›</p>
<p>ç»è¿‡ç¡¬åŒæ­¥åï¼Œè‹¥å‘é€æ–¹å’Œæ¥æ”¶æ–¹çš„æ—¶é’Ÿæ²¡æœ‰è¯¯å·®ï¼Œåˆ™åç»­æ‰€æœ‰æ•°æ®ä½çš„é‡‡æ ·ç‚¹å¿…é¡»éƒ½ä¼šå¯¹é½æ•°æ®ä½ä¸­å¿ƒé™„è¿‘</p>
<p><img src="https://s2.loli.net/2025/07/24/lwtY9Hd21jNs7Zz.png" alt="" /></p>
<p><strong>æœ€å¼€å§‹æ¥æ”¶é‡‡æ ·æ­£ç¡®ï¼Œä½†å§‹ç»ˆæœ‰è¯¯å·®ï¼Œéšç€è¯¯å·®ç§¯ç´¯ï¼Œé‡‡æ ·ç‚¹é€æ¸åç¦»ã€‚</strong></p>
<h3 id="å†åŒæ­¥"><a class="markdownIt-Anchor" href="#å†åŒæ­¥"></a> å†åŒæ­¥</h3>
<ul>
<li>è‹¥å‘é€æ–¹æˆ–æ¥æ”¶æ–¹çš„æ—¶é’Ÿæœ‰è¯¯å·®ï¼Œéšç€è¯¯å·®ç§¯ç´¯ï¼Œæ•°æ®ä½è¾¹æ²¿é€æ¸åç¦»SSæ®µï¼Œåˆ™æ­¤æ—¶æ¥æ”¶æ–¹æ ¹æ®å†åŒæ­¥è¡¥å¿å®½åº¦ï¼ˆSJWï¼‰é€šè¿‡<strong>åŠ é•¿PBS1æ®µï¼Œæˆ–ç¼©çŸ­PBS2æ®µ</strong>ï¼Œè°ƒæ•´åŒæ­¥</li>
<li>å†åŒæ­¥å¯ä»¥å‘ç”Ÿåœ¨æ¯ä¸€ä¸ªä¸‹é™æ²¿ä¹‹åçš„æ¯ä¸ªæ•°æ®ä½è·³å˜è¾¹æ²¿</li>
</ul>
<p>SJW = 1 ~ 4 Tq</p>
<p><strong>å¦‚æœè¯¯å·®å€¼å°äºç­‰äºSJWæŒ‡å®šå€¼ï¼Œåˆ™è¯¯å·®å‡ ä¸ªTqï¼Œè¡¥å¿å‡ ä¸ªTqï¼Œå¦åˆ™è¡¥å¿SJW</strong></p>
<p>SJWæ˜¯è¡¥å¿çš„ä¸Šé™ï¼Œé˜²æ­¢æ³¢å½¢ä¸­çš„å™ªå£°å¯¹ä½æ—¶åºé€ æˆè¿‡å¤§å½±å“ã€‚</p>
<p><img src="https://s2.loli.net/2025/07/24/jDnNcMzGxSUtuOK.png" alt="" /></p>
<h3 id="æ³¢ç‰¹ç‡çš„è®¡ç®—"><a class="markdownIt-Anchor" href="#æ³¢ç‰¹ç‡çš„è®¡ç®—"></a> æ³¢ç‰¹ç‡çš„è®¡ç®—</h3>
<p>æ³¢ç‰¹ç‡ = 1 / (ä¸€ä¸ªæ•°æ®ä½çš„æ—¶é•¿) = 1 / (Tss + Tpts + Tpbs1 + Tpbs2)</p>
<p>ä¸¾ä¾‹</p>
<p>SS = 1 Tqï¼ŒPTS = 3 Tqï¼ŒPBS1 = 3 Tqï¼ŒPBS2 = 3 Tqï¼›Tq = 0.5 us</p>
<p>æ³¢ç‰¹ç‡ = 1 / (0.5us + 1.5us + 1.5us + 1.5us) = 200kbps</p>
<h2 id="ä»²è£"><a class="markdownIt-Anchor" href="#ä»²è£"></a> ä»²è£</h2>
<p>CANæ€»çº¿åªæœ‰ä¸€å¯¹å·®åˆ†ä¿¡å·çº¿ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªè®¾å¤‡æ“ä½œæ€»çº¿å‘é€æ•°æ®ï¼Œ<strong>å¦‚æœå¤šä¸ªè®¾å¤‡åŒæ—¶æœ‰å‘é€éœ€æ±‚ï¼Œè¯¥å¦‚ä½•åˆ†é…ï¼Ÿ</strong></p>
<h3 id="è§„åˆ™1å…ˆå å…ˆå¾—"><a class="markdownIt-Anchor" href="#è§„åˆ™1å…ˆå å…ˆå¾—"></a> è§„åˆ™1â€”â€”å…ˆå å…ˆå¾—</h3>
<ul>
<li>
<p>è‹¥å½“å‰<strong>å·²ç»æœ‰è®¾å¤‡æ“ä½œæ€»çº¿å‘é€æ•°æ®å¸§/é¥æ§å¸§</strong>ï¼Œåˆ™å…¶ä»–ä»»ä½•è®¾å¤‡ä¸èƒ½å†åŒæ—¶å‘é€æ•°æ®å¸§/é¥æ§å¸§ï¼ˆ<strong>å¯ä»¥å‘é€é”™è¯¯å¸§/è¿‡è½½å¸§ç ´åå½“å‰æ•°æ®</strong>ï¼‰</p>
</li>
<li>
<p>ä»»ä½•è®¾å¤‡æ£€æµ‹åˆ°<strong>è¿ç»­11ä¸ªéšæ€§ç”µå¹³</strong>ï¼Œå³è®¤ä¸º<strong>æ€»çº¿ç©ºé—²</strong>ï¼Œ<strong>åªæœ‰æ€»çº¿ç©ºé—²ï¼Œè®¾å¤‡æ‰å¯ä»¥å‘é€æ•°æ®å¸§/é¥æ§å¸§</strong></p>
</li>
<li>
<p>ä¸€æ—¦æœ‰è®¾å¤‡æ­£åœ¨å‘é€æ•°æ®å¸§/é¥æ§å¸§ï¼Œæ€»çº¿å°±ä¼šå˜æ´»è·ƒçŠ¶æ€ï¼Œå¿…ç„¶ä¸ä¼šå‡ºç°è¿ç»­11ä¸ªéšæ€§ç”µå¹³ï¼ˆè¿ç»­6ä¸ªå°±æ˜¯é”™è¯¯å¸§/è¿‡è½½å¸§ï¼‰ï¼Œå…¶ä»–è®¾å¤‡è‡ªç„¶ä¹Ÿä¸ä¼šç ´åå½“å‰å‘é€</p>
</li>
<li>
<p>è‹¥æ€»çº¿æ´»è·ƒï¼Œå…¶ä»–è®¾å¤‡æœ‰å‘é€éœ€æ±‚ï¼Œåˆ™éœ€è¦ç­‰å¾…æ€»çº¿å˜ç©ºé—²ï¼Œæ‰èƒ½æ‰§è¡Œå‘é€éœ€æ±‚</p>
</li>
</ul>
<h3 id="è§„åˆ™2éç ´åæ€§ä»²è£"><a class="markdownIt-Anchor" href="#è§„åˆ™2éç ´åæ€§ä»²è£"></a> è§„åˆ™2â€”â€”éç ´åæ€§ä»²è£</h3>
<p><strong>æ ¹æ®IDå·ï¼ˆä»²è£æ®µï¼‰è¿›è¡Œéç ´åæ€§ä»²è£ï¼ŒIDå·å°çš„å–åˆ°æ€»çº¿æ§åˆ¶æƒ</strong>ï¼ŒIDå·å¤§çš„ä»²è£å¤±åˆ©å°†è½¬ä¸ºæ¥æ”¶çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ€»çº¿ç©ºé—²æ—¶å†å°è¯•å‘é€ã€‚</p>
<h4 id="å®ç°éç ´åæ€§ä»²è£ä¸¤ä¸ªè¦æ±‚"><a class="markdownIt-Anchor" href="#å®ç°éç ´åæ€§ä»²è£ä¸¤ä¸ªè¦æ±‚"></a> å®ç°éç ´åæ€§ä»²è£ä¸¤ä¸ªè¦æ±‚ï¼š</h4>
<ul>
<li>
<p>çº¿ä¸ç‰¹æ€§ï¼šæ€»çº¿ä¸Šä»»ä½•ä¸€ä¸ªè®¾å¤‡å‘é€æ˜¾æ€§ç”µå¹³0æ—¶ï¼Œæ€»çº¿å°±ä¼šå‘ˆç°æ˜¾æ€§ç”µå¹³0ï¼Œåªæœ‰å½“æ‰€æœ‰è®¾å¤‡éƒ½å‘é€éšæ€§ç”µå¹³1æ—¶ï¼Œæ€»çº¿æ‰ä¼šå‘ˆç°éšæ€§ç”µå¹³1ï¼›å³0 &amp; X  = 0ï¼Œ 1 &amp; 1 = 1.</p>
</li>
<li>
<p>å›è¯»æœºåˆ¶ï¼šæ¯éš”è®¾å¤‡å‘å‡ºä¸€ä¸ªæ•°æ®ä½åï¼Œéƒ½ä¼šè¯»å›æ€»çº¿å½“å‰çš„ç”µå¹³çŠ¶æ€ï¼Œä»¥ç¡®è®¤è‡ªå·±å‘å‡ºçš„ç”µå¹³æ˜¯å¦è¢«çœŸå®å‘é€å‡ºå»äº†ã€‚æ ¹æ®çº¿ä¸ç‰¹æ€§ï¼Œå‘å‡º0ï¼Œè¯»å›å¿…ç„¶æ˜¯0ï¼Œä½†æ˜¯å‘å‡º1è¯»å›ä¸ä¸€å®šæ˜¯1.<strong>ï¼ˆæ­¤åˆ»æ˜¯è¿˜åœ¨ä»²è£æ®µï¼Œå‘å‡ºæ•°æ®1ï¼Œè¯»å›æ•°æ®0ï¼Œè¡¨ç¤ºæœ‰è®¾å¤‡åœ¨å ç”¨æ€»çº¿ï¼ŒIDå°çš„ä¼˜å…ˆï¼‰</strong></p>
</li>
</ul>
<h4 id="ä¼˜å…ˆçº§è¡¥å……"><a class="markdownIt-Anchor" href="#ä¼˜å…ˆçº§è¡¥å……"></a> ä¼˜å…ˆçº§è¡¥å……</h4>
<ul>
<li>
<p><strong>æ•°æ®å¸§å’Œé¥æ§å¸§IDå·ä¸€æ ·æ—¶ï¼Œæ•°æ®å¸§çš„ä¼˜å…ˆçº§é«˜äºé¥æ§å¸§</strong></p>
</li>
<li>
<p><strong>æ ‡å‡†æ ¼å¼çš„11ä½IDå·å’Œæ‰©å±•æ ¼å¼29ä½IDå·çš„å‰11ä½ç³»ç»Ÿï¼Œæ ‡å‡†æ ¼å¼çš„ä¼˜å…ˆçº§é«˜äºæ‰©å±•æ ¼å¼</strong>ï¼ˆSSRå¿…é¡»å§‹ç»ˆä¸º1ï¼‰</p>
</li>
</ul>
<h2 id="é”™è¯¯ç±»å‹"><a class="markdownIt-Anchor" href="#é”™è¯¯ç±»å‹"></a> é”™è¯¯ç±»å‹</h2>
<p>é”™è¯¯æœ‰5ç§ï¼šä½é”™è¯¯ã€å¡«å……é”™è¯¯ã€CRCé”™è¯¯ã€æ ¼å¼é”™è¯¯ã€åº”ç­”é”™è¯¯</p>
<p><img src="https://s2.loli.net/2025/07/24/MmE48gt5k3LKpD7.png" alt="" /></p>
<p>ä¸ºäº†é˜²æ­¢æŸä¸ªè®¾å¤‡å‘ç–¯ä¸€æ ·ï¼Œä¸€ç›´è®¤ä¸ºåˆ«çš„è®¾å¤‡å‘é€æ˜¯é”™è¯¯å¸§ï¼Œå¼•å…¥<strong>é”™è¯¯çŠ¶æ€</strong></p>
<h3 id="é”™è¯¯çŠ¶æ€"><a class="markdownIt-Anchor" href="#é”™è¯¯çŠ¶æ€"></a> é”™è¯¯çŠ¶æ€</h3>
<ul>
<li>ä¸»åŠ¨é”™è¯¯çŠ¶æ€çš„è®¾å¤‡æ­£å¸¸å‚ä¸é€šä¿¡å¹¶æ£€æµ‹åˆ°é”™è¯¯æ—¶å‘å‡ºä¸»åŠ¨é”™è¯¯å¸§ï¼ˆä¼šç ´ååˆ«çš„æ•°æ®å¸§ï¼‰</li>
<li>è¢«åŠ¨é”™è¯¯çŠ¶æ€çš„è®¾å¤‡æ­£å¸¸å‚ä¸é€šä¿¡ä½†æ£€æµ‹åˆ°é”™è¯¯æ—¶åªèƒ½å‘å‡ºè¢«åŠ¨é”™è¯¯å¸§ï¼ˆä¸ä¼šç ´ååˆ«çš„æ•°æ®å¸§ï¼‰</li>
<li>æ€»çº¿å…³é—­çŠ¶æ€çš„è®¾å¤‡ä¸èƒ½å‚ä¸é€šä¿¡</li>
<li>æ¯éš”è®¾å¤‡å†…éƒ¨ç®¡ç†ä¸€ä¸ªTECå’ŒRECï¼Œæ ¹æ®TECå’ŒRECç¡®å®šç›´æ¥çš„çŠ¶æ€</li>
</ul>
<p><img src="https://s2.loli.net/2025/07/24/SkbB8ojwI2rM1O5.png" alt="" /></p>
<p><img src="https://s2.loli.net/2025/07/24/I68snYPTvfMuiQU.png" alt="" /></p>
<h2 id="stm32-canå¤–è®¾"><a class="markdownIt-Anchor" href="#stm32-canå¤–è®¾"></a> STM32 CANå¤–è®¾</h2>
<ul>
<li>
<p>æ³¢ç‰¹ç‡æœ€é«˜å¯è¾¾1Mbps</p>
</li>
<li>
<p>3ä¸ªå¯é…ç½®ä¼˜å…ˆçº§çš„å‘é€é‚®ç®± â€”â€” å‘é€ç¼“å†²åŒº</p>
</li>
<li>
<p>2ä¸ª3çº§æ·±åº¦æ¥æ”¶FIFO â€”â€” æ¥æ”¶ç¼“å†²åŒº</p>
</li>
<li>
<p>14ä¸ªè¿‡æ»¤å™¨ç»„ â€”â€” è¿‡æ»¤æ— å…³æŠ¥æ–‡</p>
</li>
<li>
<p>æ—¶é—´è§¦å‘é€šä¿¡ã€è‡ªåŠ¨ç¦»çº¿æ¢å¤ã€è‡ªåŠ¨å”¤é†’ã€ç¦æ­¢è‡ªåŠ¨é‡ä¼ ã€æ¥æ”¶FIFOæº¢å‡ºå¤„ç†æ–¹å¼å¯é…ç½®ã€å‘é€ä¼˜å…ˆçº§å¯é…ç½®ã€åŒCANæ¨¡å¼</p>
</li>
</ul>
<p><img src="https://s2.loli.net/2025/07/24/4fXN3hrozaApKw2.png" alt="" /></p>
<h3 id="æ ‡è¯†ç¬¦è¿‡æ»¤å™¨"><a class="markdownIt-Anchor" href="#æ ‡è¯†ç¬¦è¿‡æ»¤å™¨"></a> æ ‡è¯†ç¬¦è¿‡æ»¤å™¨</h3>
<ul>
<li>
<p>æ¯ä¸ªè¿‡æ»¤å™¨çš„æ ¸å¿ƒç”±ä¸¤ä¸ª32ä½å¯„å­˜å™¨ç»„æˆï¼šR1[31:0]å’ŒR2[31:0]ï¼›x = 0,â€¦,13</p>
</li>
<li>
<p>FSCxï¼šä½å®½è®¾ç½®ï¼›ç½®0ï¼Œ16ä½ï¼›ç½®1ï¼Œ32ä½</p>
</li>
<li>
<p>FBMxï¼šæ¨¡å¼è®¾ç½®ï¼›ç½®0ï¼Œå±è”½æ¨¡å¼ï¼›ç½®1ï¼Œåˆ—è¡¨æ¨¡å¼</p>
</li>
<li>
<p>FFAxï¼šå…³è”æ¨¡å¼ï¼›ç½®0ï¼ŒFIFO 0ï¼›ç½®1ï¼ŒFIFO 1</p>
</li>
<li>
<p>FACTxï¼šæ¿€æ´»è®¾ç½®ï¼›ç½®0ï¼Œç¦ç”¨ï¼›ç½®1ï¼Œå¯ç”¨ã€</p>
</li>
</ul>
<p><img src="https://s2.loli.net/2025/07/24/D53jncszLtSyEKO.png" alt="" /></p>
<p><img src="https://s2.loli.net/2025/07/24/NzLVncImCh8sZjB.png" alt="" /></p>
<p>ï¼ˆTIPï¼šç¬¬äºŒè¡ŒMaskçš„0x700 ---- 0111 0000 0000ï¼Œè¡¨ç¤ºæ¥æ”¶çš„ç¬¬2åˆ°4ä½å¿…é¡»å’ŒIDç›¸åŒï¼‰</p>
<h3 id="æµ‹è¯•æ¨¡å¼"><a class="markdownIt-Anchor" href="#æµ‹è¯•æ¨¡å¼"></a> æµ‹è¯•æ¨¡å¼</h3>
<p><img src="https://s2.loli.net/2025/07/24/oHWz7Z3FiTdPuan.png" alt="" /></p>
<h3 id="å·¥ä½œæ¨¡å¼"><a class="markdownIt-Anchor" href="#å·¥ä½œæ¨¡å¼"></a> å·¥ä½œæ¨¡å¼</h3>
<p><img src="https://s2.loli.net/2025/07/24/l7gpX8YyLdzs21e.png" alt="" /></p>
<h3 id="ä½æ—¶é—´ç‰¹å¾"><a class="markdownIt-Anchor" href="#ä½æ—¶é—´ç‰¹å¾"></a> ä½æ—¶é—´ç‰¹å¾</h3>
<p><img src="https://s2.loli.net/2025/07/24/vFjc6RTKwbhLIXs.png" alt="" /></p>
<p>TIPï¼šSTM32é‡Œé¢PBS1å’ŒPBS2åˆå¹¶æˆä¸€ä¸ªBSæ®µ</p>
<h3 id="ä¸­æ–­"><a class="markdownIt-Anchor" href="#ä¸­æ–­"></a> ä¸­æ–­</h3>
<p><img src="https://s2.loli.net/2025/07/24/hHASOJDMRbKeBvT.png" alt="" /></p>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>CANé€šä¿¡</tag>
      </tags>
  </entry>
  <entry>
    <title>MQTTåè®®</title>
    <url>/2025/07/24/MQTT%E5%8D%8F%E8%AE%AE/</url>
    <content><![CDATA[<h1 id="mqttåè®®æ­£åœ¨loading"><a class="markdownIt-Anchor" href="#mqttåè®®æ­£åœ¨loading"></a> MQTTåè®®ï¼ˆæ­£åœ¨loadingâ€¦ï¼‰</h1>
<p>MQTTæ˜¯åº”ç”¨å±‚åè®®ï¼ŒåŸºäºä¼ è¾“å±‚çš„TCPå‘é€ã€‚</p>
<h2 id="é…ç½®ç¯å¢ƒ"><a class="markdownIt-Anchor" href="#é…ç½®ç¯å¢ƒ"></a> é…ç½®ç¯å¢ƒ</h2>
<p>ä¸‹è½½å®‰è£…åŒ…<br />
èµ„æ–™ä¸‹è½½åœ°å€: <a href="https://pan.baidu.com/s/1qFuCzYW-lj1JnuUBcbiJxg">https://pan.baidu.com/s/1qFuCzYW-lj1JnuUBcbiJxg</a> æå–ç : n25a<br />
å®‰è£…emqxï¼Œæ¥ç€æ‰“å¼€PowerShell</p>
<p><img src="https://s2.loli.net/2025/07/25/k7BpLfqRMID9568.png" alt="" /></p>
<p>è¾“å…¥**\bin\emqx start**ï¼Œæ¥ç€åœ¨æµè§ˆå™¨æ‰“å¼€<strong>127.0.0.1:18083</strong>ï¼Œç”¨æˆ·åå’Œå¯†ç æ˜¯<strong>admin/public</strong></p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<p><a href="https://www.bilibili.com/video/BV1VDdoYhEYh/?spm_id_from=333.337.search-card.all.click&amp;vd_source=2686d8279192347a7d56afcb53bb00d9">ã€2025æ–°ç‰ˆã€‘MQTTåè®®æ‰‹æŠŠæ‰‹è¯¦è§£ EMQXè‡ªå»ºæœåŠ¡å™¨ æ‰€æœ‰æŠ¥æ–‡åŠŸèƒ½ é€ä¸ªå­—èŠ‚æ„å»ºåˆ†æä¸æµ‹è¯•_å“”å“©å“”å“©_bilibili</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/421109780">(11 å°ç§ä¿¡) MQTTåè®®ï¼Œç»ˆäºæœ‰äººè®²æ¸…æ¥šäº† - çŸ¥ä¹</a></p>
<p><a href="https://blog.csdn.net/jackwmj12/article/details/129163012">MQTTåè®®è¯¦è§£(å®Œæ•´ç‰ˆ)-CSDNåšå®¢</a></p>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>MQTT</tag>
      </tags>
  </entry>
  <entry>
    <title>MarkdownåŸºç¡€ç”¨æ³•</title>
    <url>/2023/04/12/Markdown%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="markdownåŸºç¡€ç”¨æ³•"><a class="markdownIt-Anchor" href="#markdownåŸºç¡€ç”¨æ³•"></a> MarkdownåŸºç¡€ç”¨æ³•</h1>
<h3 id="å®˜ç½‘ç½‘å€httpwwwtyporaio"><a class="markdownIt-Anchor" href="#å®˜ç½‘ç½‘å€httpwwwtyporaio"></a> å®˜ç½‘ç½‘å€ï¼š<a href="http://www.typora.io/">http://www.typora.io/</a></h3>
<p>å¯ä»¥ä¸‹è½½æ’å­—æ¨¡æ¿å’Œç¼–è¾‘ä¸»é¢˜ã€‚</p>
<p><strong>ä½¿ç”¨Typoraï¼Œé€šè¿‡Ctrl+/å³å¯è¿›å…¥Markdownæºä»£ç ç¼–è¾‘æ¨¡å¼ã€‚</strong></p>
<h3 id="æ ‡é¢˜"><a class="markdownIt-Anchor" href="#æ ‡é¢˜"></a> æ ‡é¢˜</h3>
<p>#+ç©ºæ ¼+æ ‡é¢˜åç§°-----------ä¸€çº§æ ‡é¢˜<br />
##+ç©ºæ ¼+æ ‡é¢˜åç§°---------äºŒçº§æ ‡é¢˜<br />
###+ç©ºæ ¼+æ ‡é¢˜åç§°--------ä¸‰çº§æ ‡é¢˜<br />
####+ç©ºæ ¼+æ ‡é¢˜åç§°------å››çº§æ ‡é¢˜<br />
#####+ç©ºæ ¼+æ ‡é¢˜åç§°------äº”çº§æ ‡é¢˜<br />
######+ç©ºæ ¼+æ ‡é¢˜åç§°-----å…­çº§æ ‡é¢˜<br />
<em><strong>æœ€å¤§æ”¯æŒå…­çº§æ ‡é¢˜</strong></em></p>
<h3 id="å­—ä½“"><a class="markdownIt-Anchor" href="#å­—ä½“"></a> å­—ä½“</h3>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">*</span> + æ–‡å­— + *         æ–œä½“</span><br><span class="line">** + æ–‡å­— + **       åŠ ç²—</span><br><span class="line"><span class="strong">*** + æ–‡å­— + **</span>*     æ–œä½“åŠ ç²—</span><br><span class="line">~~ + æ–‡å­— + ~~       åˆ é™¤çº¿</span><br></pre></td></tr></table></figure>
<p>å¯¹äºæ ‡å‡†çš„markdownæ–‡æœ¬æ˜¯ä¸æ”¯æŒå±…ä¸­å¯¹é½çš„ã€‚ä¸è¿‡markdownåŒæ—¶å…¼å®¹HTMLï¼Œå¯ä»¥é€šè¿‡HTMLè¯­æ³•æ ¼å¼ä¹¦å†™æ¥è®©æ–‡æœ¬å±…ä¸­å¯¹é½ã€‚</p>
<h3 id="å¼•ç”¨"><a class="markdownIt-Anchor" href="#å¼•ç”¨"></a> å¼•ç”¨</h3>
<blockquote>
<p>â€˜&gt;â€™+åŠ ç©ºæ ¼+æ–‡å­—</p>
</blockquote>
<h3 id="åˆ†å‰²çº¿"><a class="markdownIt-Anchor" href="#åˆ†å‰²çº¿"></a> åˆ†å‰²çº¿</h3>
<p>1.ä¸‰ä¸ª*ç„¶åå›è½¦<br />
2.ä¸‰ä¸ª-ï¼ˆå‡å·ï¼‰å›è½¦</p>
<h3 id="æ’å…¥å›¾ç‰‡"><a class="markdownIt-Anchor" href="#æ’å…¥å›¾ç‰‡"></a> æ’å…¥å›¾ç‰‡</h3>
<p>â‘ æœ¬åœ°çš„å›¾ç‰‡ï¼šè‹±æ–‡çš„ï¼+[å›¾ç‰‡åç§°]+ï¼ˆè·¯å¾„ï¼‰<br />
â‘¡ç½‘ç»œå›¾ï¼šè‹±æ–‡çš„ï¼+[å›¾ç‰‡åç§°]+ï¼ˆç½‘ç»œå›¾ç‰‡åœ°å€ï¼‰<br />
æ¯”å¦‚ï¼š<br />
<img src="https://s2.loli.net/2025/05/07/YhvXnKTEQL4FM2j.png" alt="" /></p>
<h3 id="é“¾æ¥"><a class="markdownIt-Anchor" href="#é“¾æ¥"></a> é“¾æ¥</h3>
<p>[ç‚¹å‡»è·³è½¬åˆ°+åç§°]ï¼ˆç½‘ç«™ã€æ–‡ä»¶ç­‰åœ°å€ï¼‰<br />
æ¯”å¦‚ï¼š<a href="https://blog.csdn.net/weixin_47795024?spm=1001.2100.3001.5343">æˆ‘çš„åšå®¢</a></p>
<h3 id="åˆ—è¡¨"><a class="markdownIt-Anchor" href="#åˆ—è¡¨"></a> åˆ—è¡¨</h3>
<p>â‘ æœ‰åºåˆ—è¡¨ï¼›åºå·ï¼ˆ1ï¼Œâ‘ ï¼‰+è‹±æ–‡çš„å¥å·ï¼ˆ.ï¼‰+è¾“å…¥å¾—å†…å®¹ï¼Œç„¶åå›è½¦è‡ªåŠ¨è¡¥å‡ºä¸‹ä¸€ä¸ªåºå·<br />
â‘¡æ— åºåˆ—è¡¨ï¼›å‡å·ï¼ˆ-ï¼‰+ç©ºæ ¼+è¾“å…¥å†…å®¹        å›è½¦è‡ªåŠ¨è¡¥å‡ºä¸‹ä¸€ä¸ª</p>
<h3 id="è¡¨æ ¼"><a class="markdownIt-Anchor" href="#è¡¨æ ¼"></a> è¡¨æ ¼</h3>
<p>å³å‡»åˆ›å»ºè¡¨æ ¼</p>
<h3 id="ä»£ç "><a class="markdownIt-Anchor" href="#ä»£ç "></a> ä»£ç </h3>
<p>Tabé”®ä¸Šé¢çš„ç‚¹ï¼ˆÂ·ï¼‰ä¸‰ä¸ª + ä»£ç ç±»å‹ï¼ˆjava c++ c#ç­‰ï¼‰ç„¶åå›è½¦</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ•°å­¦å…¬å¼"><a class="markdownIt-Anchor" href="#æ•°å­¦å…¬å¼"></a> æ•°å­¦å…¬å¼</h3>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>n</mi></munderover><msup><mi>i</mi><mn>2</mn></msup><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><mi>n</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mn>6</mn></mfrac></mrow><annotation encoding="application/x-tex">
\sum_{i=0}^n i^2 = \frac{(n^2+n)(2n+1)}{6}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1771em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p><a href="https://math.meta.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">LaTeXå…¬å¼æ ¼å¼</a></p>
<h1 id="markdownå¿«æ·é”®"><a class="markdownIt-Anchor" href="#markdownå¿«æ·é”®"></a> Markdownå¿«æ·é”®</h1>
<p>æ’¤é”€ï¼šCtrl/Command + Z<br />
é‡åšï¼šCtrl/Command + Y<br />
åŠ ç²—ï¼šCtrl/Command + B<br />
æ–œä½“ï¼šCtrl/Command + I<br />
æ ‡é¢˜ï¼šCtrl/Command + Shift + H<br />
æ— åºåˆ—è¡¨ï¼šCtrl/Command + Shift + U<br />
æœ‰åºåˆ—è¡¨ï¼šCtrl/Command + Shift + O<br />
æ£€æŸ¥åˆ—è¡¨ï¼šCtrl/Command + Shift + C<br />
æ’å…¥ä»£ç ï¼šCtrl/Command + Shift + K<br />
æ’å…¥é“¾æ¥ï¼šCtrl/Command + Shift + L<br />
æ’å…¥å›¾ç‰‡ï¼šCtrl/Command + Shift + G<br />
æŸ¥æ‰¾ï¼šCtrl/Command + F<br />
mand + Shift + L<br />
æ’å…¥å›¾ç‰‡ï¼šCtrl/Command + Shift + G<br />
æŸ¥æ‰¾ï¼šCtrl/Command + F<br />
æ›¿æ¢ï¼šCtrl/Command + G</p>
]]></content>
      <categories>
        <category>Markdown</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>FreeRTOSå­¦ä¹ ç¬”è®°</title>
    <url>/2024/12/20/FreeRTOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>ä¸»è¦å­¦ä¹ éŸ¦ä¸œå±±FreeRTOSçš„æ“ä½œã€‚</p>
<h1 id="freertosæ¦‚è¿°ä¸ä½“éªŒ"><a class="markdownIt-Anchor" href="#freertosæ¦‚è¿°ä¸ä½“éªŒ"></a> FreeRTOSæ¦‚è¿°ä¸ä½“éªŒ</h1>
<h2 id="freertosä¸»è¦å†…å®¹"><a class="markdownIt-Anchor" href="#freertosä¸»è¦å†…å®¹"></a> FreeRTOSä¸»è¦å†…å®¹</h2>
<table>
<thead>
<tr>
<th style="text-align:center">FreeRTOS/Sourceä¸‹çš„æ–‡ä»¶</th>
<th style="text-align:center">ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">task.c</td>
<td style="text-align:center">ä»»åŠ¡æ“ä½œ</td>
</tr>
<tr>
<td style="text-align:center">list.c</td>
<td style="text-align:center">åˆ—è¡¨</td>
</tr>
<tr>
<td style="text-align:center">queue.c</td>
<td style="text-align:center">æä¾›é˜Ÿåˆ—æ“ä½œã€ä¿¡å·é‡æ“ä½œ</td>
</tr>
<tr>
<td style="text-align:center">timer.c</td>
<td style="text-align:center">è½¯ä»¶å®šæ—¶åŠŸèƒ½</td>
</tr>
<tr>
<td style="text-align:center">event_groups.c</td>
<td style="text-align:center">é€šè¿‡äº‹ä»¶ç»„åŠŸèƒ½</td>
</tr>
</tbody>
</table>
<h2 id="æ•°æ®ç±»å‹"><a class="markdownIt-Anchor" href="#æ•°æ®ç±»å‹"></a> æ•°æ®ç±»å‹</h2>
<ul>
<li>TickType_tï¼š
<ul>
<li><strong>FreeRTOSé…ç½®äº†ä¸€ä¸ªå‘¨æœŸæ€§çš„æ—¶é’Ÿä¸­æ–­</strong>ï¼šTick Interrupt</li>
<li>æ¯å‘ç”Ÿä¸€æ¬¡ä¸­æ–­ï¼Œä¸­æ–­æ¬¡æ•°ç´¯åŠ ï¼Œè¿™è¢«ç§°ä¸ºtick count</li>
<li>tick count<strong>è¿™ä¸ªå˜é‡çš„ç±»å‹å°±æ˜¯TickType_t</strong></li>
<li>TickType_tå¯ä»¥æ˜¯16ä½çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯32ä½çš„</li>
<li>FreeRTOSConfig.hä¸­å®šä¹‰configUSE_16_BIT_TICKSæ—¶ï¼ŒTickType_tå°±æ˜¯uint16_t</li>
<li>å¦åˆ™TickType_tå°±æ˜¯uint32_t</li>
</ul>
</li>
<li>BaseType_tï¼š
<ul>
<li><strong>è¿™æ˜¯è¯¥æ¶æ„æœ€é«˜æ•ˆçš„æ•°æ®ç±»å‹</strong></li>
<li>32ä½æ¶æ„ä¸­ï¼Œå®ƒå°±æ˜¯uint32_t</li>
<li>16ä½æ¶æ„ä¸­ï¼Œå®ƒå°±æ˜¯uint16_t</li>
<li>8ä½æ¶æ„ä¸­ï¼Œå®ƒå°±æ˜¯uint8_t</li>
<li>BaseType_té€šå¸¸ç”¨ä½œç®€å•çš„è¿”å›å€¼çš„ç±»å‹ï¼Œè¿˜æœ‰é€»è¾‘å€¼ï¼Œæ¯”å¦‚<code>pdTRUE/pdFALSE</code></li>
</ul>
</li>
</ul>
<h2 id="å˜é‡å"><a class="markdownIt-Anchor" href="#å˜é‡å"></a> å˜é‡å</h2>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>å˜é‡åå‰ç¼€</strong></th>
<th style="text-align:center"><strong>å«ä¹‰</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">c</td>
<td style="text-align:center">char</td>
</tr>
<tr>
<td style="text-align:center">s</td>
<td style="text-align:center">int16_t, short</td>
</tr>
<tr>
<td style="text-align:center">l</td>
<td style="text-align:center">int32_t, long</td>
</tr>
<tr>
<td style="text-align:center">x</td>
<td style="text-align:center">BaseType_tï¼Œç»“æ„ä½“ç­‰</td>
</tr>
<tr>
<td style="text-align:center">u</td>
<td style="text-align:center">unsigned</td>
</tr>
<tr>
<td style="text-align:center">p</td>
<td style="text-align:center">æŒ‡é’ˆ</td>
</tr>
<tr>
<td style="text-align:center">uc</td>
<td style="text-align:center">uint8_tï¼Œunsigned char</td>
</tr>
<tr>
<td style="text-align:center">pc</td>
<td style="text-align:center">charæŒ‡é’ˆ</td>
</tr>
</tbody>
</table>
<h2 id="å‡½æ•°å"><a class="markdownIt-Anchor" href="#å‡½æ•°å"></a> å‡½æ•°å</h2>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>å‡½æ•°åå‰ç¼€</strong></th>
<th style="text-align:center"><strong>å«ä¹‰</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">v<strong>Task</strong>PrioritySet</td>
<td style="text-align:center">è¿”å›å€¼ç±»å‹ï¼švoidï¼Œåœ¨<strong>task.c</strong>ä¸­å®šä¹‰</td>
</tr>
<tr>
<td style="text-align:center">x<strong>Queue</strong>Receive</td>
<td style="text-align:center">è¿”å›å€¼ç±»å‹ï¼šBaseType_tï¼Œåœ¨<strong>queue.c</strong>ä¸­å®šä¹‰</td>
</tr>
<tr>
<td style="text-align:center">pv<strong>Timer</strong>GetTimerID</td>
<td style="text-align:center">è¿”å›å€¼ç±»å‹ï¼špointer to voidï¼Œåœ¨<strong>timer.c</strong>ä¸­å®šä¹‰</td>
</tr>
</tbody>
</table>
<h2 id="å®å"><a class="markdownIt-Anchor" href="#å®å"></a> å®å</h2>
<table>
<thead>
<tr>
<th style="text-align:center">å®çš„å‰ç¼€</th>
<th style="text-align:center">åœ¨å“ªä¸ªæ–‡ä»¶å®šä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">port (æ¯”å¦‚portMAX_DELAY)</td>
<td style="text-align:center">portable.hæˆ–portmacro.h</td>
</tr>
<tr>
<td style="text-align:center">task (æ¯”å¦‚taskENTER_CRITICAL())</td>
<td style="text-align:center">task.h</td>
</tr>
<tr>
<td style="text-align:center">pd (æ¯”å¦‚pdTRUE)</td>
<td style="text-align:center">projdefs.h</td>
</tr>
<tr>
<td style="text-align:center">config (æ¯”å¦‚configUSE_PREEMPTION)</td>
<td style="text-align:center">FreeRTOSConfig.h</td>
</tr>
<tr>
<td style="text-align:center">err (æ¯”å¦‚errQUEUE_FULL)</td>
<td style="text-align:center">projdefs.h</td>
</tr>
</tbody>
</table>
<p>ä¸€èˆ¬çš„å®å®šä¹‰</p>
<table>
<thead>
<tr>
<th style="text-align:center">å®</th>
<th style="text-align:center">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">pdTRUE</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">pdFALSE</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">pdPASS</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">pdFAIL</td>
<td style="text-align:center">0</td>
</tr>
</tbody>
</table>
<h1 id="å†…å­˜ç®¡ç†"><a class="markdownIt-Anchor" href="#å†…å­˜ç®¡ç†"></a> å†…å­˜ç®¡ç†</h1>
<ul>
<li>å †ï¼šheapï¼Œç”±ç¨‹åºå‘˜è‡ªå·±mallocä¸€å—ç©ºé—´ï¼Œç”¨å®Œåfreeæ ‡è®°ä¸º&quot;ç©ºé—²&quot;</li>
<li>æ ˆï¼šstackï¼Œå‡½æ•°è°ƒç”¨æ—¶å±€éƒ¨å˜é‡ä¿å­˜åœ¨æ ˆä¸­ï¼Œå½“å‰ç¨‹åºç¯å¢ƒä¹Ÿæ˜¯ä¿å­˜åœ¨æ ˆä¸­ã€‚</li>
</ul>
<h2 id="äº”ç§å†…å­˜ç®¡ç†æ–¹æ³•"><a class="markdownIt-Anchor" href="#äº”ç§å†…å­˜ç®¡ç†æ–¹æ³•"></a> äº”ç§å†…å­˜ç®¡ç†æ–¹æ³•</h2>
<table>
<thead>
<tr>
<th style="text-align:center">æ–‡ä»¶</th>
<th style="text-align:center">ä¼˜ç‚¹</th>
<th style="text-align:center">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">heap_1.c</td>
<td style="text-align:center">åˆ†é…ç®€å•ï¼Œæ—¶é—´ç¡®å®šï¼Œæ²¡æœ‰ç¢ç‰‡</td>
<td style="text-align:center">åªåˆ†é…ï¼Œä¸å›æ”¶</td>
</tr>
<tr>
<td style="text-align:center">heap_2.c</td>
<td style="text-align:center">åŠ¨æ€åˆ†é…ï¼Œæœ€ä½³åŒ¹é…</td>
<td style="text-align:center">æœ‰ç¢ç‰‡ã€æ—¶é—´ä¸æ‡‚</td>
</tr>
<tr>
<td style="text-align:center">heap_3.c</td>
<td style="text-align:center">è°ƒç”¨æ ‡å‡†åº“å‡½æ•°</td>
<td style="text-align:center">é€Ÿåº¦æ…¢ã€æ—¶é—´ä¸å®š</td>
</tr>
<tr>
<td style="text-align:center">heap_4.c</td>
<td style="text-align:center">ç›¸é‚»çš„ç©ºé—²ç¢ç‰‡å¯åˆå¹¶</td>
<td style="text-align:center">æ—¶é—´ä¸å®š</td>
</tr>
<tr>
<td style="text-align:center">heap_5.c</td>
<td style="text-align:center">åœ¨heap_4.cåŸºç¡€ä¸Šæ”¯æŒåˆ†éš”çš„å†…å­˜å—</td>
<td style="text-align:center">æ—¶é—´ä¸å®š</td>
</tr>
</tbody>
</table>
<p>FreeRTOSåœ¨åˆ›å»ºä»»åŠ¡æ—¶ï¼Œéœ€è¦2ä¸ªå†…æ ¸å¯¹è±¡ï¼š<strong>task control block(TCB)ã€stack</strong>ã€‚</p>
<h3 id="heap_1"><a class="markdownIt-Anchor" href="#heap_1"></a> heap_1</h3>
<ul>
<li>
<p>åª<strong>å®ç°äº†pvPortMalloc</strong>ï¼Œå¹¶<strong>æ²¡æœ‰å®ç°vPortFree</strong>ã€‚</p>
</li>
<li>
<p>å¦‚æœç¨‹åº<strong>ä¸éœ€è¦åˆ é™¤å†…æ ¸å¯¹è±¡</strong>ï¼Œå¯ä»¥ä½¿ç”¨å®ƒ</p>
</li>
</ul>
<h3 id="heap_2"><a class="markdownIt-Anchor" href="#heap_2"></a> heap_2</h3>
<p>ç›¸è¾ƒäºheap_1</p>
<ul>
<li>Heap_2ä½¿ç”¨<strong>æœ€ä½³åŒ¹é…ç®—æ³•</strong>(best fit)æ¥åˆ†é…å†…å­˜</li>
<li>å®ƒ<strong>æ”¯æŒvPortFree</strong></li>
</ul>
<h4 id="qè¿™é‡Œçš„æœ€ä½³åŒ¹é…æ˜¯æ€ä¹ˆæ“ä½œçš„"><a class="markdownIt-Anchor" href="#qè¿™é‡Œçš„æœ€ä½³åŒ¹é…æ˜¯æ€ä¹ˆæ“ä½œçš„"></a> Qï¼šè¿™é‡Œçš„æœ€ä½³åŒ¹é…æ˜¯æ€ä¹ˆæ“ä½œçš„ï¼Ÿ</h4>
<p>ä¸¾ä¾‹ï¼Œä¸€ä¸ª5 10 15å†…å­˜çš„ç©ºé—´ï¼Œæ­¤æ—¶éœ€è¦å­˜å…¥ä¸€ä¸ª6å¤§å°çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±å­˜æ”¾åœ¨10é‡Œé¢ï¼Œå˜æˆ5 4 15ï¼›åç»­åˆéœ€è¦å­˜æ”¾ä¸€ä¸ª4å¤§å°çš„æ•°æ®ï¼Œå°±å˜æˆ5 0 15ã€‚</p>
<h3 id="heap_3"><a class="markdownIt-Anchor" href="#heap_3"></a> heap_3</h3>
<ul>
<li>ä½¿ç”¨æ ‡å‡†Cåº“é‡Œçš„mallocã€freeå‡½æ•°</li>
</ul>
<h4 id="q-heap_3çº¿ç¨‹å®‰å…¨å—"><a class="markdownIt-Anchor" href="#q-heap_3çº¿ç¨‹å®‰å…¨å—"></a> Qï¼š heap_3çº¿ç¨‹å®‰å…¨å—?</h4>
<p>Cåº“é‡Œçš„mallocã€freeå‡½æ•°å¹¶éçº¿ç¨‹å®‰å…¨çš„ï¼ŒHeap_3ä¸­å…ˆæš‚åœFreeRTOSçš„è°ƒåº¦å™¨ï¼Œå†å»è°ƒç”¨è¿™äº›å‡½æ•°ï¼Œä½¿ç”¨<strong>è¿™ç§æ–¹æ³•å®ç°äº†çº¿ç¨‹å®‰å…¨</strong>ã€‚</p>
<h3 id="heap_4"><a class="markdownIt-Anchor" href="#heap_4"></a> heap_4</h3>
<ul>
<li>Heap_4ä½¿ç”¨<strong>é¦–æ¬¡é€‚åº”ç®—æ³•</strong>(first fit)æ¥åˆ†é…å†…å­˜ã€‚å®ƒè¿˜ä¼šæŠŠç›¸é‚»çš„ç©ºé—²å†…å­˜åˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§çš„ç©ºé—²å†…å­˜ï¼Œè¿™æœ‰åŠ©äºè¾ƒå°‘å†…å­˜çš„ç¢ç‰‡é—®é¢˜ã€‚</li>
</ul>
<h4 id="qè¿™é‡Œçš„é¦–æ¬¡åŒ¹é…æ˜¯æ€ä¹ˆæ“ä½œçš„"><a class="markdownIt-Anchor" href="#qè¿™é‡Œçš„é¦–æ¬¡åŒ¹é…æ˜¯æ€ä¹ˆæ“ä½œçš„"></a> Qï¼šè¿™é‡Œçš„é¦–æ¬¡åŒ¹é…æ˜¯æ€ä¹ˆæ“ä½œçš„ï¼Ÿ</h4>
<p>ä¸¾ä¾‹ï¼Œä¸€ä¸ª10 5 3å†…å­˜çš„ç©ºé—´ï¼Œæ­¤æ—¶éœ€è¦å­˜å…¥ä¸€ä¸ª6å¤§å°çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±å­˜æ”¾åœ¨10é‡Œé¢ï¼Œå˜æˆ4 5 3ï¼›åç»­åˆéœ€è¦å­˜æ”¾ä¸€ä¸ª3å¤§å°çš„æ•°æ®ï¼Œå°±å˜æˆ1 5 3ã€‚</p>
<h3 id="heap_5"><a class="markdownIt-Anchor" href="#heap_5"></a> heap_5</h3>
<ul>
<li>ç›¸æ¯”äºHeap_4ï¼ŒHeap_5å¹¶ä¸å±€é™äºç®¡ç†ä¸€ä¸ªå¤§æ•°ç»„ï¼š<strong>å®ƒå¯ä»¥ç®¡ç†å¤šå—ã€åˆ†éš”å¼€çš„å†…å­˜</strong>ã€‚</li>
</ul>
<h2 id="heapç›¸å…³çš„å‡½æ•°"><a class="markdownIt-Anchor" href="#heapç›¸å…³çš„å‡½æ•°"></a> heapç›¸å…³çš„å‡½æ•°</h2>
<h3 id="pvportmallocvportfree"><a class="markdownIt-Anchor" href="#pvportmallocvportfree"></a> pvPortMalloc/vPortFree</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> * <span class="title function_">pvPortMalloc</span><span class="params">( <span class="type">size_t</span> xWantedSize )</span>;	<span class="comment">// åˆ†é…å†…å­˜ï¼Œå¦‚æœåˆ†é…å†…å­˜ä¸æˆåŠŸï¼Œåˆ™è¿”å›å€¼ä¸ºNULLã€‚</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vPortFree</span><span class="params">( <span class="type">void</span> * pv )</span>;	<span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼š<strong>åˆ†é…å†…å­˜ã€é‡Šæ”¾å†…å­˜</strong>ã€‚</p>
<p>å¦‚æœåˆ†é…å†…å­˜ä¸æˆåŠŸï¼Œåˆ™è¿”å›å€¼ä¸ºNULLã€‚</p>
<h3 id="xportgetfreeheapsize"><a class="markdownIt-Anchor" href="#xportgetfreeheapsize"></a> xPortGetFreeHeapSize</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">xPortGetFreeHeapSize</span><span class="params">( <span class="type">void</span> )</span>;</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼š<strong>å½“å‰è¿˜æœ‰å¤šå°‘ç©ºé—²å†…å­˜</strong>ï¼Œheap_3ä¸­æ— æ³•ä½¿ç”¨ã€‚</p>
<h3 id="xportgetminimumeverfreeheapsize"><a class="markdownIt-Anchor" href="#xportgetminimumeverfreeheapsize"></a> xPortGetMinimumEverFreeHeapSize</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">xPortGetMinimumEverFreeHeapSize</span><span class="params">( <span class="type">void</span> )</span>;</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šç©ºé—²å†…å­˜å®¹é‡çš„æœ€å°å€¼ã€‚</p>
<p>æ³¨æ„ï¼šåªæœ‰heap_4ã€heap_5æ”¯æŒæ­¤å‡½æ•°</p>
<h1 id="ä»»åŠ¡ç®¡ç†"><a class="markdownIt-Anchor" href="#ä»»åŠ¡ç®¡ç†"></a> ä»»åŠ¡ç®¡ç†</h1>
<p><strong>ä»»åŠ¡çŠ¶æ€</strong>ï¼šå°±ç»ªæ€ã€é˜»å¡æ€ã€æŒ‚èµ·æ€</p>
<h2 id="ä»»åŠ¡åˆ›å»º"><a class="markdownIt-Anchor" href="#ä»»åŠ¡åˆ›å»º"></a> ä»»åŠ¡åˆ›å»º</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">BaseType_t <span class="title function_">xTaskCreate</span><span class="params">( TaskFunction_t pxTaskCode, <span class="comment">// å‡½æ•°æŒ‡é’ˆ, ä»»åŠ¡å‡½æ•°</span></span></span><br><span class="line"><span class="params">                        <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> pcName, <span class="comment">// ä»»åŠ¡çš„åå­—ï¼Œä¸ç”¨å¤ªåœ¨æ„</span></span></span><br><span class="line"><span class="params">                        <span class="type">const</span> configSTACK_DEPTH_TYPE usStackDepth, <span class="comment">// æ ˆå¤§å°,å•ä½ä¸ºword,10è¡¨ç¤º40å­—èŠ‚</span></span></span><br><span class="line"><span class="params">                        <span class="type">void</span> * <span class="type">const</span> pvParameters, <span class="comment">// è°ƒç”¨ä»»åŠ¡å‡½æ•°æ—¶ä¼ å…¥çš„å‚æ•°</span></span></span><br><span class="line"><span class="params">                        UBaseType_t uxPriority,    <span class="comment">// ä¼˜å…ˆçº§</span></span></span><br><span class="line"><span class="params">                        TaskHandle_t * <span class="type">const</span> pxCreatedTask )</span>; <span class="comment">// ä»»åŠ¡å¥æŸ„, ä»¥åä½¿ç”¨å®ƒæ¥æ“ä½œè¿™ä¸ªä»»åŠ¡</span></span><br><span class="line"><span class="comment">//	æˆåŠŸï¼špdPASSï¼›</span></span><br><span class="line"><span class="comment">//	å¤±è´¥ï¼šerrCOULD_NOT_ALLOCATE_REQUIRED_MEMORY(å¤±è´¥åŸå› åªæœ‰å†…å­˜ä¸è¶³)</span></span><br></pre></td></tr></table></figure>
<p><strong>åŒæ—¶åˆ›å»ºä¸¤ä¸ªç¨‹åºï¼ŒåŒä¼˜å…ˆçº§ä¸‹ï¼Œå…ˆæ‰§è¡Œæœ€ååˆ›å»ºçš„ã€‚</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">xTaskCreate(vTask1, <span class="string">&quot;Task 1&quot;</span>, <span class="number">1000</span>, <span class="literal">NULL</span>, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">xTaskCreate(vTask2, <span class="string">&quot;Task 2&quot;</span>, <span class="number">1000</span>, <span class="literal">NULL</span>, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// åœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œå…ˆæ‰§è¡ŒvTask2ï¼Œå†åˆ°Task1ï¼Œä»»åŠ¡æœ¬è´¨æ˜¯ä¸€ç§é“¾è¡¨ç»“æ„ã€‚</span></span><br></pre></td></tr></table></figure>
<p><strong>å¤šä¸ªä»»åŠ¡å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªå‡½æ•°</strong>ï¼Œæ€ä¹ˆä½“ç°å®ƒä»¬çš„å·®åˆ«ï¼Ÿ</p>
<ul>
<li><strong>æ ˆä¸åŒ</strong></li>
<li>åˆ›å»ºä»»åŠ¡æ—¶å¯ä»¥ä¼ å…¥ä¸åŒçš„å‚æ•°</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *pcTextForTask1 = <span class="string">&quot;T1 run\r\n&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *pcTextForTask2 = <span class="string">&quot;T2 run\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">( <span class="type">void</span> )</span></span><br><span class="line">&#123;</span><br><span class="line">	prvSetupHardware();</span><br><span class="line">	</span><br><span class="line">	xTaskCreate(vTaskFunction, <span class="string">&quot;Task 1&quot;</span>, <span class="number">1000</span>, (<span class="type">void</span> *)pcTextForTask1, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	xTaskCreate(vTaskFunction, <span class="string">&quot;Task 2&quot;</span>, <span class="number">1000</span>, (<span class="type">void</span> *)pcTextForTask2, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* å¯åŠ¨è°ƒåº¦å™¨ */</span></span><br><span class="line">	vTaskStartScheduler();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* å¦‚æœç¨‹åºè¿è¡Œåˆ°äº†è¿™é‡Œå°±è¡¨ç¤ºå‡ºé”™äº†, ä¸€èˆ¬æ˜¯å†…å­˜ä¸è¶³ */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä»»åŠ¡åˆ é™¤"><a class="markdownIt-Anchor" href="#ä»»åŠ¡åˆ é™¤"></a> ä»»åŠ¡åˆ é™¤</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vTaskDelete</span><span class="params">( TaskHandle_t xTaskToDelete )</span>;</span><br></pre></td></tr></table></figure>
<p><strong>Qï¼šæ€ä¹ˆåˆ é™¤ä»»åŠ¡ï¼Ÿ</strong></p>
<ol>
<li><strong>è‡ªæ€</strong>ï¼švTaskDelete(NULL)</li>
<li><strong>è¢«æ€</strong>ï¼šåˆ«çš„ä»»åŠ¡æ‰§è¡ŒvTaskDelete(pvTaskCode)ï¼ŒpvTaskCodeæ˜¯è‡ªå·±çš„å¥æŸ„</li>
<li><strong>æ€äºº</strong>ï¼šæ‰§è¡ŒvTaskDelete(pvTaskCode)ï¼ŒpvTaskCodeæ˜¯åˆ«çš„ä»»åŠ¡çš„å¥æŸ„</li>
</ol>
<h2 id="ä»»åŠ¡ä¼˜å…ˆçº§ä¸tick"><a class="markdownIt-Anchor" href="#ä»»åŠ¡ä¼˜å…ˆçº§ä¸tick"></a> ä»»åŠ¡ä¼˜å…ˆçº§ä¸Tick</h2>
<p><strong>é«˜ä¼˜å…ˆçº§</strong>çš„ä»»åŠ¡<strong>å…ˆè¿è¡Œ</strong>ï¼Œå¯é€‰æ‹©<strong>0 ~ (configMAX_PRIORITIES â€“ 1)</strong></p>
<ul>
<li>FreeRTOSä¼šç¡®ä¿<strong>æœ€é«˜ä¼˜å…ˆçº§</strong>çš„ã€å¯è¿è¡Œçš„ä»»åŠ¡ç«‹é©¬<strong>æ‰§è¡Œ</strong></li>
<li>å¯¹äº<strong>ç›¸åŒä¼˜å…ˆçº§</strong>çš„å¯æ‰§è¡Œä»»åŠ¡ï¼Œ<strong>è½®æµæ‰§è¡Œ</strong></li>
</ul>
<p>å¯¹äº<strong>ç›¸åŒä¼˜å…ˆçº§</strong>çš„ï¼Œé€šè¿‡<strong>Tickï¼ˆæ»´ç­”ï¼‰ä¸­æ–­</strong>å®ç°ï¼Œä½†<strong>å®ƒå¹¶ä¸ç²¾ç¡®</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">vTaskDelay(<span class="number">2</span>);  <span class="comment">// ç­‰å¾…2ä¸ªTickï¼Œå‡è®¾configTICK_RATE_HZ=100, Tickå‘¨æœŸæ—¶10ms, ç­‰å¾…20ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿˜å¯ä»¥ä½¿ç”¨pdMS_TO_TICKSå®æŠŠmsè½¬æ¢ä¸ºtick</span></span><br><span class="line">vTaskDelay(pdMS_TO_TICKS(<span class="number">100</span>));	 <span class="comment">// ç­‰å¾…100ms</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨<strong>uxTaskPriorityGetæ¥è·å¾—ä»»åŠ¡çš„ä¼˜å…ˆçº§</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">UBaseType_t <span class="title function_">uxTaskPriorityGet</span><span class="params">( <span class="type">const</span> TaskHandle_t xTask )</span>;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<strong>vTaskPrioritySet æ¥è®¾ç½®ä»»åŠ¡çš„ä¼˜å…ˆçº§</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vTaskPrioritySet</span><span class="params">( TaskHandle_t xTask,				<span class="comment">//å…·ä½“ä»»åŠ¡</span></span></span><br><span class="line"><span class="params">                       UBaseType_t uxNewPriority )</span>;		<span class="comment">//æ–°çš„ä¼˜å…ˆçº§</span></span><br></pre></td></tr></table></figure>
<h2 id="ä»»åŠ¡çŠ¶æ€"><a class="markdownIt-Anchor" href="#ä»»åŠ¡çŠ¶æ€"></a> ä»»åŠ¡çŠ¶æ€</h2>
<img src="https://s2.loli.net/2025/05/08/UseZF9RQ5Y1kwAt.png" style="zoom: 60%;" />
<h2 id="delayå‡½æ•°"><a class="markdownIt-Anchor" href="#delayå‡½æ•°"></a> Delayå‡½æ•°</h2>
<ul>
<li><strong>vTaskDelay</strong>ï¼š<strong>è‡³å°‘ç­‰å¾…æŒ‡å®šä¸ªæ•°çš„Tick Interrupt</strong>æ‰èƒ½å˜ä¸ºå°±ç»ªçŠ¶æ€</li>
<li><strong>vTaskDelayUntil</strong>ï¼š<strong>ç­‰å¾…åˆ°æŒ‡å®šçš„ç»å¯¹æ—¶åˆ»</strong>ï¼Œæ‰èƒ½å˜ä¸ºå°±ç»ªæ€ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vTaskDelay</span><span class="params">( <span class="type">const</span> TickType_t xTicksToDelay )</span>; <span class="comment">/* xTicksToDelay: ç­‰å¾…å¤šå°‘ç»™Tick */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* pxPreviousWakeTime: ä¸Šä¸€æ¬¡è¢«å”¤é†’çš„æ—¶é—´</span></span><br><span class="line"><span class="comment"> * xTimeIncrement: è¦é˜»å¡åˆ°(pxPreviousWakeTime + xTimeIncrement)</span></span><br><span class="line"><span class="comment"> * å•ä½éƒ½æ˜¯Tick Count</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTaskDelayUntil</span><span class="params">( TickType_t * <span class="type">const</span> pxPreviousWakeTime,</span></span><br><span class="line"><span class="params">                            <span class="type">const</span> TickType_t xTimeIncrement )</span>;</span><br></pre></td></tr></table></figure>
<h2 id="ç©ºé—²ä»»åŠ¡åŠå…¶é’©å­å‡½æ•°"><a class="markdownIt-Anchor" href="#ç©ºé—²ä»»åŠ¡åŠå…¶é’©å­å‡½æ•°"></a> ç©ºé—²ä»»åŠ¡åŠå…¶é’©å­å‡½æ•°</h2>
<p><strong>ç©ºé—²ä»»åŠ¡</strong>(Idleä»»åŠ¡)çš„ä½œç”¨ï¼š<strong>é‡Šæ”¾è¢«åˆ é™¤çš„ä»»åŠ¡çš„å†…å­˜</strong></p>
<p>åœ¨ä½¿ç”¨<code>vTaskStartScheduler() </code>å‡½æ•°æ¥åˆ›å»ºã€å¯åŠ¨è°ƒåº¦å™¨æ—¶ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šåˆ›å»ºç©ºé—²ä»»åŠ¡ï¼š</p>
<ul>
<li>ç©ºé—²<strong>ä»»åŠ¡ä¼˜å…ˆçº§ä¸º0</strong>ï¼šå®ƒä¸èƒ½é˜»ç¢ç”¨æˆ·ä»»åŠ¡è¿è¡Œ</li>
<li>ç©ºé—²ä»»åŠ¡è¦ä¹ˆå¤„äºå°±ç»ªæ€ï¼Œè¦ä¹ˆå¤„äºè¿è¡Œæ€ï¼Œ<strong>æ°¸è¿œä¸ä¼šé˜»å¡</strong></li>
</ul>
<p>å¦‚æœä½¿ç”¨<code>vTaskDelete() </code>æ¥åˆ é™¤ä»»åŠ¡ï¼Œé‚£ä¹ˆä½ å°±è¦<strong>ç¡®ä¿ç©ºé—²ä»»åŠ¡æœ‰æœºä¼šæ‰§è¡Œ</strong>ï¼Œå¦åˆ™å°±<strong>æ— æ³•é‡Šæ”¾è¢«åˆ é™¤ä»»åŠ¡çš„å†…å­˜</strong>ã€‚</p>
<p>å¯ä»¥<strong>æ·»åŠ ä¸€ä¸ªç©ºé—²ä»»åŠ¡çš„é’©å­å‡½æ•°</strong>(Idle Task Hook Functions)ï¼Œç©ºé—²ä»»åŠ¡çš„å¾ªç¯æ¯æ‰§è¡Œä¸€æ¬¡ï¼Œå°±ä¼šè°ƒç”¨ä¸€æ¬¡é’©å­å‡½æ•°ã€‚</p>
<p><strong>é’©å­å‡½æ•°ä½œç”¨</strong></p>
<ul>
<li><strong>æ‰§è¡Œä¸€äº›ä½ä¼˜å…ˆçº§çš„ã€åå°çš„ã€éœ€è¦è¿ç»­æ‰§è¡Œçš„å‡½æ•°</strong></li>
<li><strong>æµ‹é‡ç³»ç»Ÿçš„ç©ºé—²æ—¶é—´</strong>ï¼šç©ºé—²ä»»åŠ¡èƒ½è¢«æ‰§è¡Œå°±æ„å‘³ç€æ‰€æœ‰çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡éƒ½åœæ­¢äº†ï¼Œæ‰€ä»¥æµ‹é‡ç©ºé—²ä»»åŠ¡å æ®çš„æ—¶é—´ï¼Œå°±å¯ä»¥ç®—å‡ºå¤„ç†å™¨å ç”¨ç‡ã€‚</li>
<li><strong>è®©ç³»ç»Ÿè¿›å…¥çœç”µæ¨¡å¼</strong>ï¼šç©ºé—²ä»»åŠ¡èƒ½è¢«æ‰§è¡Œå°±æ„å‘³ç€æ²¡æœ‰é‡è¦çš„äº‹æƒ…è¦åšï¼Œå½“ç„¶å¯ä»¥è¿›å…¥çœç”µæ¨¡å¼äº†ã€‚</li>
</ul>
<p><strong>é’©å­å‡½æ•°é™åˆ¶</strong></p>
<ul>
<li>ä¸èƒ½å¯¼è‡´ç©ºé—²ä»»åŠ¡è¿›å…¥é˜»å¡çŠ¶æ€ã€æš‚åœçŠ¶æ€</li>
<li>å¦‚æœä½ ä¼šä½¿ç”¨<code>vTaskDelete() </code>æ¥åˆ é™¤ä»»åŠ¡ï¼Œé‚£ä¹ˆé’©å­å‡½æ•°è¦éå¸¸é«˜æ•ˆåœ°æ‰§è¡Œã€‚å¦‚æœç©ºé—²ä»»åŠ¡ç§»æ¤å¡åœ¨é’©å­å‡½æ•°é‡Œçš„è¯ï¼Œå®ƒå°±æ— æ³•é‡Šæ”¾å†…å­˜ã€‚</li>
</ul>
<p><strong>å¦‚ä½•ä½¿ç”¨é’©å­å‡½æ•°</strong></p>
<p><code>FreeRTOS\Source\tasks.c</code>ä¸­è®¾ç½®<strong>configUSE_IDLE_HOOK = 1</strong>ï¼Œå®ç°<code>vApplicationIdleHook</code>å‡½æ•°ã€‚</p>
<h2 id="è°ƒåº¦ç®—æ³•"><a class="markdownIt-Anchor" href="#è°ƒåº¦ç®—æ³•"></a> è°ƒåº¦ç®—æ³•</h2>
<table>
<thead>
<tr>
<th style="text-align:center">é…ç½®é¡¹</th>
<th style="text-align:center">A</th>
<th style="text-align:center">B</th>
<th style="text-align:center">C</th>
<th style="text-align:center">D</th>
<th style="text-align:center">E</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">configUSE_PREEMPTION</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">configUSE_TIME_SLICING</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">x</td>
</tr>
<tr>
<td style="text-align:center">configIDLE_SHOULD_YIELD</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">x</td>
</tr>
<tr>
<td style="text-align:center">è¯´æ˜</td>
<td style="text-align:center">å¸¸ç”¨</td>
<td style="text-align:center">å¾ˆå°‘ç”¨</td>
<td style="text-align:center">å¾ˆå°‘ç”¨</td>
<td style="text-align:center">å¾ˆå°‘ç”¨</td>
<td style="text-align:center">å‡ ä¹ä¸ç”¨</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Aï¼šå¯æŠ¢å +æ—¶é—´ç‰‡è½®è½¬+ç©ºé—²ä»»åŠ¡è®©æ­¥</strong></li>
<li>Bï¼šå¯æŠ¢å +æ—¶é—´ç‰‡è½®è½¬+ç©ºé—²ä»»åŠ¡ä¸è®©æ­¥</li>
<li>Cï¼šå¯æŠ¢å +éæ—¶é—´ç‰‡è½®è½¬+ç©ºé—²ä»»åŠ¡è®©æ­¥</li>
<li>Dï¼šå¯æŠ¢å +éæ—¶é—´ç‰‡è½®è½¬+ç©ºé—²ä»»åŠ¡ä¸è®©æ­¥</li>
<li>Eï¼šåˆä½œè°ƒåº¦</li>
</ul>
<h1 id="åŒæ­¥äº’æ–¥ä¸é€šä¿¡"><a class="markdownIt-Anchor" href="#åŒæ­¥äº’æ–¥ä¸é€šä¿¡"></a> åŒæ­¥äº’æ–¥ä¸é€šä¿¡</h1>
<p>èƒ½å®ç°åŒæ­¥ã€äº’æ–¥çš„å†…æ ¸æ–¹æ³•æœ‰ï¼š<strong>ä»»åŠ¡é€šçŸ¥</strong>(task notification)ã€<strong>é˜Ÿåˆ—</strong>(queue)ã€<strong>äº‹ä»¶ç»„</strong>(event group)ã€<strong>ä¿¡å·é‡</strong>(semaphoe)ã€<strong>äº’æ–¥é‡</strong>(mutex)</p>
<ul>
<li>é˜Ÿåˆ—ï¼š
<ul>
<li>é‡Œé¢å¯ä»¥æ”¾ä»»æ„æ•°æ®ï¼Œå¯ä»¥æ”¾å¤šä¸ªæ•°æ®</li>
<li>ä»»åŠ¡ã€ISRéƒ½å¯ä»¥æ”¾å…¥æ•°æ®ï¼›ä»»åŠ¡ã€ISRéƒ½å¯ä»¥ä»ä¸­è¯»å‡ºæ•°æ®</li>
</ul>
</li>
<li>äº‹ä»¶ç»„ï¼š
<ul>
<li>ä¸€ä¸ªäº‹ä»¶ç”¨ä¸€bitè¡¨ç¤ºï¼Œ1è¡¨ç¤ºäº‹ä»¶å‘ç”Ÿäº†ï¼Œ0è¡¨ç¤ºäº‹ä»¶æ²¡å‘ç”Ÿ</li>
<li>å¯ä»¥ç”¨æ¥è¡¨ç¤ºäº‹ä»¶ã€äº‹ä»¶çš„ç»„åˆå‘ç”Ÿäº†ï¼Œä¸èƒ½ä¼ é€’æ•°æ®</li>
<li>æœ‰å¹¿æ’­æ•ˆæœï¼šäº‹ä»¶æˆ–äº‹ä»¶çš„ç»„åˆå‘ç”Ÿäº†ï¼Œç­‰å¾…å®ƒçš„å¤šä¸ªä»»åŠ¡éƒ½ä¼šè¢«å”¤é†’</li>
</ul>
</li>
<li>ä¿¡å·é‡ï¼š
<ul>
<li>æ ¸å¿ƒæ˜¯&quot;è®¡æ•°å€¼&quot;</li>
<li>ä»»åŠ¡ã€ISRé‡Šæ”¾ä¿¡å·é‡æ—¶è®©è®¡æ•°å€¼åŠ 1</li>
<li>ä»»åŠ¡ã€ISRè·å¾—ä¿¡å·é‡æ—¶ï¼Œè®©è®¡æ•°å€¼å‡1</li>
</ul>
</li>
<li>ä»»åŠ¡é€šçŸ¥ï¼š
<ul>
<li>æ ¸å¿ƒæ˜¯ä»»åŠ¡çš„TCBé‡Œçš„æ•°å€¼</li>
<li>ä¼šè¢«è¦†ç›–</li>
<li>å‘é€šçŸ¥ç»™è°ï¼Ÿå¿…é¡»æŒ‡å®šæ¥æ”¶ä»»åŠ¡</li>
<li>åªèƒ½ç”±æ¥æ”¶ä»»åŠ¡æœ¬èº«è·å–è¯¥é€šçŸ¥</li>
</ul>
</li>
<li>äº’æ–¥é‡ï¼š
<ul>
<li>æ•°å€¼åªæœ‰0æˆ–1</li>
<li>è°è·å¾—äº’æ–¥é‡ï¼Œå°±å¿…é¡»ç”±è°é‡Šæ”¾åŒä¸€ä¸ªäº’æ–¥é‡</li>
</ul>
</li>
</ul>
<img src="https://s2.loli.net/2025/05/08/xI27PMC63fymOVl.png" style="zoom: 60%;" />
<h1 id="é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#é˜Ÿåˆ—"></a> é˜Ÿåˆ—</h1>
<h2 id="ç‰¹æ€§"><a class="markdownIt-Anchor" href="#ç‰¹æ€§"></a> ç‰¹æ€§</h2>
<ul>
<li>é˜Ÿåˆ—å¯ä»¥åŒ…å«è‹¥å¹²ä¸ªæ•°æ®ï¼šé˜Ÿåˆ—ä¸­æœ‰è‹¥å¹²é¡¹ï¼Œè¿™è¢«ç§°ä¸º&quot;é•¿åº¦&quot;(length)</li>
<li>åˆ›å»ºé˜Ÿåˆ—æ—¶å°±è¦æŒ‡å®šé•¿åº¦ã€æ•°æ®å¤§å°ï¼ˆå¤§å°å›ºå®šï¼‰</li>
<li>æ•°æ®çš„æ“ä½œé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„æ–¹æ³•(FIFOï¼ŒFirst In First Out)ï¼šå†™æ•°æ®æ—¶æ”¾åˆ°å°¾éƒ¨ï¼Œè¯»æ•°æ®æ—¶ä»å¤´éƒ¨è¯»</li>
<li>ä¹Ÿå¯ä»¥å¼ºåˆ¶å†™é˜Ÿåˆ—å¤´éƒ¨ï¼šè¦†ç›–å¤´éƒ¨æ•°æ®</li>
</ul>
<img src="https://s2.loli.net/2025/05/08/kEh7UwuB9b2PZYO.png" style="zoom: 25%;" />
<p>é˜Ÿåˆ—ä¼ è¾“æ•°æ®ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>æ‹·è´ï¼šæŠŠ<strong>æ•°æ®ã€æŠŠå˜é‡çš„å€¼</strong>å¤åˆ¶è¿›é˜Ÿåˆ—</li>
<li>å¼•ç”¨ï¼šæŠŠ<strong>æ•°æ®ã€æŠŠå˜é‡çš„åœ°å€</strong>å¤åˆ¶è¿›é˜Ÿåˆ—</li>
</ul>
<p>æœ‰<strong>å¤šä¸ªä»»åŠ¡åœ¨ç­‰å¾…åŒä¸€ä¸ªé˜Ÿåˆ—çš„æ•°æ®</strong>ã€‚å½“<strong>é˜Ÿåˆ—ä¸­æœ‰æ•°æ®</strong>æ—¶ï¼Œ<strong>å“ªä¸ªä»»åŠ¡ä¼šè¿›å…¥å°±ç»ªæ€</strong>ï¼Ÿ</p>
<ul>
<li><strong>ä¼˜å…ˆçº§æœ€é«˜</strong>çš„ä»»åŠ¡</li>
<li>å¦‚æœå¤§å®¶çš„<strong>ä¼˜å…ˆçº§ç›¸åŒ</strong>ï¼Œé‚£<strong>ç­‰å¾…æ—¶é—´æœ€ä¹…</strong>çš„ä»»åŠ¡ä¼šè¿›å…¥å°±ç»ªæ€</li>
</ul>
<h2 id="é˜Ÿåˆ—å‡½æ•°"><a class="markdownIt-Anchor" href="#é˜Ÿåˆ—å‡½æ•°"></a> é˜Ÿåˆ—å‡½æ•°</h2>
<h3 id="åˆ›å»ºé˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#åˆ›å»ºé˜Ÿåˆ—"></a> åˆ›å»ºé˜Ÿåˆ—</h3>
<ul>
<li><strong>åŠ¨æ€</strong>åˆ†é…å†…å­˜ï¼š<strong>xQueueCreate</strong>ï¼Œé˜Ÿåˆ—çš„å†…å­˜åœ¨å‡½æ•°å†…éƒ¨åŠ¨æ€åˆ†é…</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">QueueHandle_t <span class="title function_">xQueueCreate</span><span class="params">( UBaseType_t uxQueueLength, UBaseType_t uxItemSize )</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">å‚æ•°</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">uxQueueLength</td>
<td style="text-align:center">é˜Ÿåˆ—é•¿åº¦ï¼Œæœ€å¤šèƒ½å­˜æ”¾å¤šå°‘ä¸ªæ•°æ®(item)</td>
</tr>
<tr>
<td style="text-align:center">uxItemSize</td>
<td style="text-align:center">æ¯ä¸ªæ•°æ®(item)çš„å¤§å°ï¼šä»¥å­—èŠ‚ä¸ºå•ä½</td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">é0ï¼šæˆåŠŸï¼Œè¿”å›å¥æŸ„ï¼Œä»¥åä½¿ç”¨å¥æŸ„æ¥æ“ä½œé˜Ÿåˆ— NULLï¼šå¤±è´¥ï¼Œå› ä¸ºå†…å­˜ä¸è¶³</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>é™æ€</strong>åˆ†é…å†…å­˜ï¼š<strong>xQueueCreateStatic</strong>ï¼Œé˜Ÿåˆ—çš„å†…å­˜è¦äº‹å…ˆåˆ†é…å¥½</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">QueueHandle_t <span class="title function_">xQueueCreateStatic</span><span class="params">(UBaseType_t uxQueueLength,</span></span><br><span class="line"><span class="params">                           UBaseType_t uxItemSize, <span class="type">uint8_t</span> *pucQueueStorageBuffer,</span></span><br><span class="line"><span class="params">                           StaticQueue_t *pxQueueBuffer)</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">å‚æ•°</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">uxQueueLength</td>
<td style="text-align:center">é˜Ÿåˆ—é•¿åº¦ï¼Œæœ€å¤šèƒ½å­˜æ”¾å¤šå°‘ä¸ªæ•°æ®(item)</td>
</tr>
<tr>
<td style="text-align:center">uxItemSize</td>
<td style="text-align:center">æ¯ä¸ªæ•°æ®(item)çš„å¤§å°ï¼šä»¥å­—èŠ‚ä¸ºå•ä½</td>
</tr>
<tr>
<td style="text-align:center">pucQueueStorageBuffer</td>
<td style="text-align:center">å¦‚æœuxItemSizeé0ï¼ŒpucQueueStorageBufferå¿…é¡»æŒ‡å‘ä¸€ä¸ªuint8_tæ•°ç»„ï¼Œ æ­¤æ•°ç»„å¤§å°è‡³å°‘ä¸º&quot;uxQueueLength * uxItemSize&quot;</td>
</tr>
<tr>
<td style="text-align:center">pxQueueBuffer</td>
<td style="text-align:center">å¿…é¡»æ‰§è¡Œä¸€ä¸ªStaticQueue_tç»“æ„ä½“ï¼Œç”¨æ¥ä¿å­˜é˜Ÿåˆ—çš„æ•°æ®ç»“æ„</td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">é0ï¼šæˆåŠŸï¼Œè¿”å›å¥æŸ„ï¼Œä»¥åä½¿ç”¨å¥æŸ„æ¥æ“ä½œé˜Ÿåˆ— NULLï¼šå¤±è´¥ï¼Œå› ä¸ºpxQueueBufferä¸ºNULL</td>
</tr>
</tbody>
</table>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ä»£ç </span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> QUEUE_LENGTH 10</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> ITEM_SIZE sizeof( uint32_t )</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// xQueueBufferç”¨æ¥ä¿å­˜é˜Ÿåˆ—ç»“æ„ä½“</span></span><br><span class="line"> StaticQueue_t xQueueBuffer;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// ucQueueStorage ç”¨æ¥ä¿å­˜é˜Ÿåˆ—çš„æ•°æ®</span></span><br><span class="line"> <span class="comment">// å¤§å°ä¸ºï¼šé˜Ÿåˆ—é•¿åº¦ * æ•°æ®å¤§å°</span></span><br><span class="line"> <span class="type">uint8_t</span> ucQueueStorage[QUEUE_LENGTH * ITEM_SIZE];</span><br><span class="line"> </span><br><span class="line"> <span class="type">void</span> <span class="title function_">vATask</span><span class="params">( <span class="type">void</span> *pvParameters )</span></span><br><span class="line"> &#123;</span><br><span class="line">	QueueHandle_t xQueue1;</span><br><span class="line">	<span class="comment">// åˆ›å»ºé˜Ÿåˆ—: å¯ä»¥å®¹çº³QUEUE_LENGTHä¸ªæ•°æ®ï¼Œæ¯ä¸ªæ•°æ®å¤§å°æ˜¯ITEM_SIZE</span></span><br><span class="line">	xQueue1 = xQueueCreateStatic( QUEUE_LENGTH,</span><br><span class="line">						  ITEM_SIZE,ucQueueStorage,</span><br><span class="line">						  &amp;xQueueBuffer); </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¤ä½"><a class="markdownIt-Anchor" href="#å¤ä½"></a> å¤ä½</h3>
<p>ä½¿ç”¨è¿‡ç¨‹ä¸­å¯ä»¥è°ƒç”¨<code>xQueueReset()</code>æŠŠé˜Ÿåˆ—æ¢å¤ä¸ºåˆå§‹çŠ¶æ€</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* pxQueue : å¤ä½å“ªä¸ªé˜Ÿåˆ—;</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdPASS(å¿…å®šæˆåŠŸ)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueReset</span><span class="params">( QueueHandle_t pxQueue)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ é™¤"><a class="markdownIt-Anchor" href="#åˆ é™¤"></a> åˆ é™¤</h3>
<p>åˆ é™¤é˜Ÿåˆ—çš„å‡½æ•°ä¸º<code>vQueueDelete()</code>ï¼Œ<strong>åªèƒ½åˆ é™¤ä½¿ç”¨åŠ¨æ€æ–¹æ³•åˆ›å»ºçš„é˜Ÿåˆ—</strong>ï¼Œå®ƒä¼šé‡Šæ”¾å†…å­˜</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vQueueDelete</span><span class="params">( QueueHandle_t xQueue )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="å†™é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#å†™é˜Ÿåˆ—"></a> å†™é˜Ÿåˆ—</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å¾€é˜Ÿåˆ—å°¾éƒ¨å†™å…¥æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—´ï¼Œé˜»å¡æ—¶é—´ä¸ºxTicksToWait */</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueSendToBack</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                            <span class="type">const</span> <span class="type">void</span> *pvItemToQueue,</span></span><br><span class="line"><span class="params">                            TickType_t xTicksToWait)</span>;</span><br><span class="line"><span class="comment">/* ç­‰åŒäºxQueueSendToBackï¼Œå¾€é˜Ÿåˆ—å°¾éƒ¨å†™å…¥æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—´ï¼Œé˜»å¡æ—¶é—´ä¸ºxTicksToWait */</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueSend</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                      <span class="type">const</span> <span class="type">void</span> *pvItemToQueue,</span></span><br><span class="line"><span class="params">                      TickType_t xTicksToWait)</span>;</span><br><span class="line"><span class="comment">/* å¾€é˜Ÿåˆ—å°¾éƒ¨å†™å…¥æ•°æ®ï¼Œæ­¤å‡½æ•°å¯ä»¥åœ¨ä¸­æ–­å‡½æ•°ä¸­ä½¿ç”¨ï¼Œä¸å¯é˜»å¡ */</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueSendToBackFromISR</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                                   <span class="type">const</span> <span class="type">void</span> *pvItemToQueue,</span></span><br><span class="line"><span class="params">                                   BaseType_t *pxHigherPriorityTaskWoken)</span>;</span><br><span class="line"><span class="comment">/* å¾€é˜Ÿåˆ—å¤´éƒ¨å†™å…¥æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—´ï¼Œé˜»å¡æ—¶é—´ä¸ºxTicksToWait */</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueSendToFront</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                             <span class="type">const</span> <span class="type">void</span> *pvItemToQueue,</span></span><br><span class="line"><span class="params">                             TickType_t xTicksToWait)</span>;</span><br><span class="line"><span class="comment">/* å¾€é˜Ÿåˆ—å¤´éƒ¨å†™å…¥æ•°æ®ï¼Œæ­¤å‡½æ•°å¯ä»¥åœ¨ä¸­æ–­å‡½æ•°ä¸­ä½¿ç”¨ï¼Œä¸å¯é˜»å¡ */</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueSendToFrontFromISR</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                                    <span class="type">const</span> <span class="type">void</span> *pvItemToQueue,</span></span><br><span class="line"><span class="params">                                    BaseType_t *pxHigherPriorityTaskWoken)</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">å‚æ•°</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">xQueue</td>
<td style="text-align:center">é˜Ÿåˆ—å¥æŸ„ï¼Œè¦å†™å“ªä¸ªé˜Ÿåˆ—</td>
</tr>
<tr>
<td style="text-align:center">pvItemToQueue</td>
<td style="text-align:center">æ•°æ®æŒ‡é’ˆï¼Œè¿™ä¸ªæ•°æ®çš„å€¼ä¼šè¢«å¤åˆ¶è¿›é˜Ÿåˆ—ï¼Œ å¤åˆ¶å¤šå¤§çš„æ•°æ®ï¼Ÿåœ¨åˆ›å»ºé˜Ÿåˆ—æ—¶å·²ç»æŒ‡å®šäº†æ•°æ®å¤§å°</td>
</tr>
<tr>
<td style="text-align:center">xTicksToWait</td>
<td style="text-align:center">å¦‚æœé˜Ÿåˆ—æ»¡åˆ™æ— æ³•å†™å…¥æ–°æ•°æ®ï¼Œå¯ä»¥è®©ä»»åŠ¡è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ xTicksToWaitè¡¨ç¤ºé˜»å¡çš„æœ€å¤§æ—¶é—´(Tick Count)ã€‚ å¦‚æœè¢«è®¾ä¸º0ï¼Œæ— æ³•å†™å…¥æ•°æ®æ—¶å‡½æ•°ä¼šç«‹åˆ»è¿”å›ï¼› å¦‚æœè¢«è®¾ä¸ºportMAX_DELAYï¼Œåˆ™ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æœ‰ç©ºé—´å¯å†™</td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">pdPASSï¼šæ•°æ®æˆåŠŸå†™å…¥äº†é˜Ÿåˆ— errQUEUE_FULLï¼šå†™å…¥å¤±è´¥ï¼Œå› ä¸ºé˜Ÿåˆ—æ»¡äº†ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="è¯»é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#è¯»é˜Ÿåˆ—"></a> è¯»é˜Ÿåˆ—</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueReceive</span><span class="params">( QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                          <span class="type">void</span> * <span class="type">const</span> pvBuffer,</span></span><br><span class="line"><span class="params">                          TickType_t xTicksToWait)</span>;</span><br><span class="line"><span class="comment">// åœ¨ISRä¸­ä½¿ç”¨</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueReceiveFromISR</span><span class="params">(QueueHandle_t    xQueue,</span></span><br><span class="line"><span class="params">                                <span class="type">void</span>             *pvBuffer,</span></span><br><span class="line"><span class="params">                                BaseType_t       *pxTaskWoken)</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">å‚æ•°</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">xQueue</td>
<td style="text-align:center">é˜Ÿåˆ—å¥æŸ„ï¼Œè¦è¯»å“ªä¸ªé˜Ÿåˆ—</td>
</tr>
<tr>
<td style="text-align:center">pvBuffer</td>
<td style="text-align:center">buferæŒ‡é’ˆï¼Œé˜Ÿåˆ—çš„æ•°æ®ä¼šè¢«å¤åˆ¶åˆ°è¿™ä¸ªbuffer å¤åˆ¶å¤šå¤§çš„æ•°æ®ï¼Ÿåœ¨åˆ›å»ºé˜Ÿåˆ—æ—¶å·²ç»æŒ‡å®šäº†æ•°æ®å¤§å°</td>
</tr>
<tr>
<td style="text-align:center">xTicksToWait</td>
<td style="text-align:center">æœé˜Ÿåˆ—ç©ºåˆ™æ— æ³•è¯»å‡ºæ•°æ®ï¼Œå¯ä»¥è®©ä»»åŠ¡è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ xTicksToWaitè¡¨ç¤ºé˜»å¡çš„æœ€å¤§æ—¶é—´(Tick Count)ã€‚ å¦‚æœè¢«è®¾ä¸º0ï¼Œæ— æ³•è¯»å‡ºæ•°æ®æ—¶å‡½æ•°ä¼šç«‹åˆ»è¿”å›ï¼› å¦‚æœè¢«è®¾ä¸ºportMAX_DELAYï¼Œåˆ™ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æœ‰æ•°æ®å¯å†™</td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">pdPASSï¼šä»é˜Ÿåˆ—è¯»å‡ºæ•°æ®å…¥ errQUEUE_EMPTYï¼šè¯»å–å¤±è´¥ï¼Œå› ä¸ºé˜Ÿåˆ—ç©ºäº†ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="æŸ¥è¯¢"><a class="markdownIt-Anchor" href="#æŸ¥è¯¢"></a> æŸ¥è¯¢</h3>
<p>å¯ä»¥æŸ¥è¯¢é˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ªæ•°æ®ã€æœ‰å¤šå°‘ç©ºä½™ç©ºé—´</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*è¿”å›é˜Ÿåˆ—ä¸­å¯ç”¨æ•°æ®çš„ä¸ªæ•°*/</span></span><br><span class="line">UBaseType_t <span class="title function_">uxQueueMessagesWaiting</span><span class="params">( <span class="type">const</span> QueueHandle_t xQueue )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*è¿”å›é˜Ÿåˆ—ä¸­å¯ç”¨ç©ºé—´çš„ä¸ªæ•°*/</span></span><br><span class="line">UBaseType_t <span class="title function_">uxQueueSpacesAvailable</span><span class="params">( <span class="type">const</span> QueueHandle_t xQueue )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="è¦†ç›–å·çœ‹"><a class="markdownIt-Anchor" href="#è¦†ç›–å·çœ‹"></a> è¦†ç›–/å·çœ‹</h3>
<p><strong>å½“é˜Ÿåˆ—é•¿åº¦ä¸º1</strong>æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>xQueueOverwrite()</code>æˆ–<code>xQueueOverwriteFromISR()</code>æ¥<strong>è¦†ç›–æ•°æ®</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è¦†ç›–é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * xQueue: å†™å“ªä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * pvItemToQueue: æ•°æ®åœ°å€</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdTRUEè¡¨ç¤ºæˆåŠŸ, pdFALSEè¡¨ç¤ºå¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xQueueOverwrite</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                           <span class="type">const</span> <span class="type">void</span> * pvItemToQueue)</span>;</span><br><span class="line">BaseType_t <span class="title function_">xQueueOverwriteFromISR</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                           		  <span class="type">const</span> <span class="type">void</span> * pvItemToQueue,</span></span><br><span class="line"><span class="params">                           		  BaseType_t *pxHigherPriorityTaskWoken)</span>;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³è®©<strong>é˜Ÿåˆ—ä¸­çš„æ•°æ®ä¾›å¤šæ–¹è¯»å–</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>è¯»å–æ—¶ä¸è¦ç§»é™¤æ•°æ®</strong>ï¼Œé‚£ä¹ˆå¯ä»¥<strong>ä½¿ç”¨&quot;çª¥è§†&quot;</strong>ï¼Œä¹Ÿå°±æ˜¯<code>xQueuePeek()</code>æˆ–<code>xQueuePeekFromISR()</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å·çœ‹é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * xQueue: å·çœ‹å“ªä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * pvItemToQueue: æ•°æ®åœ°å€, ç”¨æ¥ä¿å­˜å¤åˆ¶å‡ºæ¥çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> * xTicksToWait: æ²¡æœ‰æ•°æ®çš„è¯é˜»å¡ä¸€ä¼š</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdTRUEè¡¨ç¤ºæˆåŠŸ, pdFALSEè¡¨ç¤ºå¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xQueuePeek</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                      <span class="type">void</span> * <span class="type">const</span> pvBuffer,</span></span><br><span class="line"><span class="params">                      TickType_t xTicksToWait)</span>;</span><br><span class="line"></span><br><span class="line">BaseType_t <span class="title function_">xQueuePeekFromISR</span><span class="params">(QueueHandle_t xQueue,</span></span><br><span class="line"><span class="params">                             <span class="type">void</span> *pvBuffer,</span></span><br><span class="line"><span class="params">                             TickType_t xTicksToWait)</span>;</span><br></pre></td></tr></table></figure>
<h1 id="ä¿¡æ¯é‡"><a class="markdownIt-Anchor" href="#ä¿¡æ¯é‡"></a> ä¿¡æ¯é‡</h1>
<h2 id="ç‰¹æ€§-2"><a class="markdownIt-Anchor" href="#ç‰¹æ€§-2"></a> ç‰¹æ€§</h2>
<ul>
<li>ä¿¡å·ï¼šèµ·é€šçŸ¥ä½œç”¨</li>
<li>é‡ï¼šè¿˜å¯ä»¥ç”¨æ¥è¡¨ç¤ºèµ„æºçš„æ•°é‡
<ul>
<li>å½“&quot;é‡&quot;åªæœ‰0ã€1ä¸¤ä¸ªå–å€¼æ—¶ï¼Œå®ƒå°±æ˜¯&quot;<strong>äºŒè¿›åˆ¶</strong>ä¿¡å·é‡&quot;(Binary Semaphores)</li>
<li>å½“&quot;é‡&quot;æ²¡æœ‰é™åˆ¶æ—¶ï¼Œå®ƒå°±æ˜¯&quot;<strong>è®¡æ•°å‹</strong>ä¿¡å·é‡&quot;(Counting Semaphores)</li>
</ul>
</li>
<li>æ”¯æŒçš„åŠ¨ä½œï¼š&quot;give&quot;ç»™å‡ºèµ„æºï¼Œè®¡æ•°å€¼åŠ 1ï¼›&quot;take&quot;è·å¾—èµ„æºï¼Œè®¡æ•°å€¼å‡1</li>
</ul>
<h2 id="å‡½æ•°"><a class="markdownIt-Anchor" href="#å‡½æ•°"></a> å‡½æ•°</h2>
<h3 id="åˆ›å»º"><a class="markdownIt-Anchor" href="#åˆ›å»º"></a> åˆ›å»º</h3>
<p>åˆ›å»º<strong>äºŒè¿›åˆ¶ä¿¡å·é‡</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªäºŒè¿›åˆ¶ä¿¡å·é‡ï¼Œè¿”å›å®ƒçš„å¥æŸ„ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°å†…éƒ¨ä¼šåˆ†é…ä¿¡å·é‡ç»“æ„ä½“ </span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SemaphoreHandle_t <span class="title function_">xSemaphoreCreateBinary</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªäºŒè¿›åˆ¶ä¿¡å·é‡ï¼Œè¿”å›å®ƒçš„å¥æŸ„ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°æ— éœ€åŠ¨æ€åˆ†é…å†…å­˜ï¼Œæ‰€ä»¥éœ€è¦å…ˆæœ‰ä¸€ä¸ªStaticSemaphore_tç»“æ„ä½“ï¼Œå¹¶ä¼ å…¥å®ƒçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SemaphoreHandle_t <span class="title function_">xSemaphoreCreateBinaryStatic</span><span class="params">(StaticSemaphore_t *pxSemaphoreBuffer)</span>;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»º<strong>è®¡æ•°å‹ä¿¡å·é‡</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªè®¡æ•°å‹ä¿¡å·é‡ï¼Œè¿”å›å®ƒçš„å¥æŸ„ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°å†…éƒ¨ä¼šåˆ†é…ä¿¡å·é‡ç»“æ„ä½“ </span></span><br><span class="line"><span class="comment"> * uxMaxCount: æœ€å¤§è®¡æ•°å€¼</span></span><br><span class="line"><span class="comment"> * uxInitialCount: åˆå§‹è®¡æ•°å€¼</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SemaphoreHandle_t <span class="title function_">xSemaphoreCreateCounting</span><span class="params">(UBaseType_t uxMaxCount, UBaseType_t uxInitialCount)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªè®¡æ•°å‹ä¿¡å·é‡ï¼Œè¿”å›å®ƒçš„å¥æŸ„ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°æ— éœ€åŠ¨æ€åˆ†é…å†…å­˜ï¼Œæ‰€ä»¥éœ€è¦å…ˆæœ‰ä¸€ä¸ªStaticSemaphore_tç»“æ„ä½“ï¼Œå¹¶ä¼ å…¥å®ƒçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * uxMaxCount: æœ€å¤§è®¡æ•°å€¼</span></span><br><span class="line"><span class="comment"> * uxInitialCount: åˆå§‹è®¡æ•°å€¼</span></span><br><span class="line"><span class="comment"> * pxSemaphoreBuffer: StaticSemaphore_tç»“æ„ä½“æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SemaphoreHandle_t <span class="title function_">xSemaphoreCreateCountingStatic</span><span class="params">( UBaseType_t uxMaxCount, </span></span><br><span class="line"><span class="params">                                                 UBaseType_t uxInitialCount, </span></span><br><span class="line"><span class="params">                                                 StaticSemaphore_t *pxSemaphoreBuffer )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ é™¤-2"><a class="markdownIt-Anchor" href="#åˆ é™¤-2"></a> åˆ é™¤</h3>
<p><strong>åŠ¨æ€åˆ›å»ºçš„ä¿¡å·é‡</strong>ï¼Œä¸å†éœ€è¦å®ƒä»¬æ—¶ï¼Œå¯ä»¥åˆ é™¤å®ƒä»¬ä»¥å›æ”¶å†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* xSemaphore: ä¿¡å·é‡å¥æŸ„ï¼Œä½ è¦åˆ é™¤å“ªä¸ªä¿¡å·é‡ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vSemaphoreDelete</span><span class="params">( SemaphoreHandle_t xSemaphore )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="givetake"><a class="markdownIt-Anchor" href="#givetake"></a> give/take</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨</span></span><br><span class="line"><span class="comment">// xSemaphoreä¿¡å·é‡å¥æŸ„ï¼Œé‡Šæ”¾å“ªä¸ªä¿¡å·é‡</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreGive</span><span class="params">( SemaphoreHandle_t xSemaphore )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// xSemaphoreä¿¡å·é‡å¥æŸ„ï¼Œè·å–å“ªä¸ªä¿¡å·é‡</span></span><br><span class="line"><span class="comment">//å¦‚æœæ— æ³•é©¬ä¸Šè·å¾—ä¿¡å·é‡ï¼Œé˜»å¡ä¸€ä¼šã€‚	  0ï¼šä¸é˜»å¡ï¼Œé©¬ä¸Šè¿”å›</span></span><br><span class="line"><span class="comment">//								portMAX_DELAY: ä¸€ç›´é˜»å¡ç›´åˆ°æˆåŠŸ</span></span><br><span class="line"><span class="comment">//								å…¶ä»–å€¼: é˜»å¡çš„Tickä¸ªæ•°</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreTake</span><span class="params">(SemaphoreHandle_t xSemaphore, TickType_t xTicksToWait)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ISRä¸­ä½¿ç”¨</span></span><br><span class="line"><span class="comment">// xSemaphoreä¿¡å·é‡å¥æŸ„ï¼Œé‡Šæ”¾å“ªä¸ªä¿¡å·é‡;</span></span><br><span class="line"><span class="comment">// å¦‚æœé‡Šæ”¾ä¿¡å·é‡å¯¼è‡´æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å˜ä¸ºäº†å°±ç»ªæ€ï¼Œåˆ™*pxHigherPriorityTaskWoken = pdTRUE</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreGiveFromISR</span><span class="params">(SemaphoreHandle_t xSemaphore,</span></span><br><span class="line"><span class="params">                        		 BaseType_t *pxHigherPriorityTaskWoken)</span>;</span><br><span class="line"><span class="comment">// xSemaphoreä¿¡å·é‡å¥æŸ„ï¼Œè·å–å“ªä¸ªä¿¡å·é‡</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreTakeFromISR</span><span class="params">(SemaphoreHandle_t xSemaphore,</span></span><br><span class="line"><span class="params">                        		 BaseType_t *pxHigherPriorityTaskWoken)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="äº’æ–¥å€¼"><a class="markdownIt-Anchor" href="#äº’æ–¥å€¼"></a> äº’æ–¥å€¼</h1>
<h2 id="ç‰¹æ€§-3"><a class="markdownIt-Anchor" href="#ç‰¹æ€§-3"></a> ç‰¹æ€§</h2>
<p><strong>FreeRTOSçš„äº’æ–¥é”ï¼Œå¹¶æ²¡æœ‰åœ¨ä»£ç ä¸Šå®ç°è°ä¸Šé”ï¼Œå°±åªèƒ½ç”±è°å¼€é”ï¼Œåªæ˜¯çº¦å®šã€‚</strong></p>
<ul>
<li>äº’æ–¥é‡åˆå§‹å€¼ä¸º1</li>
<li>ä»»åŠ¡Aæƒ³è®¿é—®ä¸´ç•Œèµ„æºï¼Œå…ˆè·å¾—å¹¶å æœ‰äº’æ–¥é‡ï¼Œç„¶åå¼€å§‹è®¿é—®</li>
<li>ä»»åŠ¡Bä¹Ÿæƒ³è®¿é—®ä¸´ç•Œèµ„æºï¼Œä¹Ÿè¦å…ˆè·å¾—äº’æ–¥é‡ï¼šè¢«åˆ«äººå æœ‰äº†ï¼Œäºæ˜¯é˜»å¡</li>
<li>ä»»åŠ¡Aä½¿ç”¨å®Œæ¯•ï¼Œé‡Šæ”¾äº’æ–¥é‡ï¼›ä»»åŠ¡Bè¢«å”¤é†’ã€å¾—åˆ°å¹¶å æœ‰äº’æ–¥é‡ï¼Œç„¶åå¼€å§‹è®¿é—®ä¸´ç•Œèµ„æº</li>
<li>ä»»åŠ¡Bä½¿ç”¨å®Œæ¯•ï¼Œé‡Šæ”¾äº’æ–¥é‡</li>
</ul>
<h2 id="å‡½æ•°-2"><a class="markdownIt-Anchor" href="#å‡½æ•°-2"></a> å‡½æ•°</h2>
<p>è¦æƒ³ä½¿ç”¨äº’æ–¥é‡ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶FreeRTOSConfig.hä¸­å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_MUTEXES 1</span></span><br></pre></td></tr></table></figure>
<h3 id="åˆ›å»º-2"><a class="markdownIt-Anchor" href="#åˆ›å»º-2"></a> åˆ›å»º</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªäº’æ–¥é‡ï¼Œè¿”å›å®ƒçš„å¥æŸ„ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°å†…éƒ¨ä¼šåˆ†é…äº’æ–¥é‡ç»“æ„ä½“ </span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ */</span></span><br><span class="line">SemaphoreHandle_t <span class="title function_">xSemaphoreCreateMutex</span><span class="params">( <span class="type">void</span> )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªäº’æ–¥é‡ï¼Œè¿”å›å®ƒçš„å¥æŸ„ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°æ— éœ€åŠ¨æ€åˆ†é…å†…å­˜ï¼Œæ‰€ä»¥éœ€è¦å…ˆæœ‰ä¸€ä¸ªStaticSemaphore_tç»“æ„ä½“ï¼Œå¹¶ä¼ å…¥å®ƒçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ */</span></span><br><span class="line">SemaphoreHandle_t <span class="title function_">xSemaphoreCreateMutexStatic</span><span class="params">( StaticSemaphore_t *pxMutexBuffer )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="å…¶ä»–å‡½æ•°"><a class="markdownIt-Anchor" href="#å…¶ä»–å‡½æ•°"></a> å…¶ä»–å‡½æ•°</h3>
<p><strong>äº’æ–¥é‡ä¸èƒ½åœ¨ISRä¸­ä½¿ç”¨</strong>ï¼ŒISRéœ€è¦å¿«é€Ÿè¿è¡Œï¼Œä¸èƒ½é˜»å¡å¤ªä¹…ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* xSemaphore: ä¿¡å·é‡å¥æŸ„ï¼Œä½ è¦åˆ é™¤å“ªä¸ªä¿¡å·é‡, äº’æ–¥é‡ä¹Ÿæ˜¯ä¸€ç§ä¿¡å·é‡ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vSemaphoreDelete</span><span class="params">( SemaphoreHandle_t xSemaphore )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡Šæ”¾ */</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreGive</span><span class="params">( SemaphoreHandle_t xSemaphore )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡Šæ”¾(ISRç‰ˆæœ¬) */</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreGiveFromISR</span><span class="params">(SemaphoreHandle_t xSemaphore,</span></span><br><span class="line"><span class="params">                       			 BaseType_t *pxHigherPriorityTaskWoken)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è·å¾— */</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreTake</span><span class="params">(SemaphoreHandle_t xSemaphore,</span></span><br><span class="line"><span class="params">                   		  TickType_t xTicksToWait)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è·å¾—(ISRç‰ˆæœ¬) */</span></span><br><span class="line">xSemaphoreGiveFromISR(SemaphoreHandle_t xSemaphore,</span><br><span class="line">                      BaseType_t *pxHigherPriorityTaskWoken);</span><br></pre></td></tr></table></figure>
<h2 id="ä¼˜å…ˆçº§åè½¬"><a class="markdownIt-Anchor" href="#ä¼˜å…ˆçº§åè½¬"></a> ä¼˜å…ˆçº§åè½¬</h2>
<p>å‡è®¾ä»»åŠ¡Aã€Béƒ½æƒ³ä½¿ç”¨ä¸²å£ï¼ŒAä¼˜å…ˆçº§æ¯”Bä½ï¼š</p>
<ul>
<li>ä»»åŠ¡Aè·å¾—äº†ä¸²å£çš„äº’æ–¥é‡</li>
<li>ä»»åŠ¡Bä¹Ÿæƒ³ä½¿ç”¨ä¸²å£ï¼Œå®ƒå°†ä¼šé˜»å¡ã€ç­‰å¾…Aé‡Šæ”¾äº’æ–¥é‡</li>
<li><strong>é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¢«ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡å»¶è¿Ÿï¼Œè¿™è¢«ç§°ä¸º&quot;ä¼˜å…ˆçº§åè½¬&quot;</strong>(priority inversion)</li>
</ul>
<p><strong>äº’æ–¥é‡å¯ä»¥é€šè¿‡&quot;ä¼˜å…ˆçº§ç»§æ‰¿&quot;</strong>ï¼Œä¸´æ—¶æé«˜<strong>æœ‰é”ä¸”ä½ä¼˜å…ˆçº§çš„ç¨‹åº</strong>ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦**è§£å†³&quot;ä¼˜å…ˆçº§åè½¬&quot;**çš„é—®é¢˜</p>
<h2 id="é€’å½’é”"><a class="markdownIt-Anchor" href="#é€’å½’é”"></a> é€’å½’é”</h2>
<p><strong>é€’å½’é”å®ç°äº†ï¼šè°ä¸Šé”å°±ç”±è°è§£é”</strong></p>
<h3 id="æ­»é”"><a class="markdownIt-Anchor" href="#æ­»é”"></a> æ­»é”</h3>
<p>å‡è®¾æœ‰2ä¸ªäº’æ–¥é‡M1ã€M2ï¼Œ2ä¸ªä»»åŠ¡Aã€Bï¼š</p>
<ul>
<li>Aè·å¾—äº†äº’æ–¥é‡M1</li>
<li>Bè·å¾—äº†äº’æ–¥é‡M2</li>
<li>Aè¿˜è¦è·å¾—äº’æ–¥é‡M2æ‰èƒ½è¿è¡Œï¼Œç»“æœAé˜»å¡</li>
<li>Bè¿˜è¦è·å¾—äº’æ–¥é‡M1æ‰èƒ½è¿è¡Œï¼Œç»“æœBé˜»å¡</li>
<li>Aã€Béƒ½é˜»å¡ï¼Œå†æ— æ³•é‡Šæ”¾å®ƒä»¬æŒæœ‰çš„äº’æ–¥é‡</li>
<li>æ­»é”å‘ç”Ÿï¼</li>
</ul>
<p>è§£å†³è¿™æ ·é—®é¢˜å¯ä»¥ä½¿ç”¨é€’å½’é”</p>
<ul>
<li>ä»»åŠ¡Aè·å¾—é€’å½’é”Måï¼Œå®ƒè¿˜å¯ä»¥å¤šæ¬¡å»è·å¾—è¿™ä¸ªé”</li>
<li>&quot;take&quot;äº†Næ¬¡ï¼Œè¦&quot;give&quot;Næ¬¡ï¼Œè¿™ä¸ªé”æ‰ä¼šè¢«é‡Šæ”¾</li>
</ul>
<h3 id="å‡½æ•°-3"><a class="markdownIt-Anchor" href="#å‡½æ•°-3"></a> å‡½æ•°</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªé€’å½’é”ï¼Œè¿”å›å®ƒçš„å¥æŸ„ï¼Œæ­¤å‡½æ•°å†…éƒ¨ä¼šåˆ†é…äº’æ–¥é‡ç»“æ„ä½“ </span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ	*/</span></span><br><span class="line">SemaphoreHandle_t <span class="title function_">xSemaphoreCreateRecursiveMutex</span><span class="params">( <span class="type">void</span> )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡Šæ”¾ */</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreGiveRecursive</span><span class="params">( SemaphoreHandle_t xSemaphore )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è·å¾— */</span></span><br><span class="line">BaseType_t <span class="title function_">xSemaphoreTakeRecursive</span><span class="params">(SemaphoreHandle_t xSemaphore,</span></span><br><span class="line"><span class="params">                   				   TickType_t xTicksToWait)</span>;</span><br></pre></td></tr></table></figure>
<h1 id="äº‹ä»¶ç»„"><a class="markdownIt-Anchor" href="#äº‹ä»¶ç»„"></a> äº‹ä»¶ç»„</h1>
<h2 id="æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#æ¦‚å¿µ"></a> æ¦‚å¿µ</h2>
<ul>
<li>äº‹ä»¶ç»„çš„æ¯ä¸€ä½è¡¨ç¤ºä¸€ä¸ªäº‹ä»¶</li>
<li>æ¯ä¸€ä½äº‹ä»¶çš„å«ä¹‰ç”±ç¨‹åºå‘˜å†³å®šï¼Œæ¯”å¦‚ï¼šBit0è¡¨ç¤ºç”¨æ¥ä¸²å£æ˜¯å¦å°±ç»ªï¼ŒBit1è¡¨ç¤ºæŒ‰é”®æ˜¯å¦è¢«æŒ‰ä¸‹</li>
<li>è¿™äº›ä½ï¼Œå€¼ä¸º1è¡¨ç¤ºäº‹ä»¶å‘ç”Ÿäº†ï¼Œå€¼ä¸º0è¡¨ç¤ºäº‹ä»¶æ²¡å‘ç”Ÿ</li>
<li>ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ã€ISRéƒ½å¯ä»¥å»å†™è¿™äº›ä½ï¼›ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ã€ISRéƒ½å¯ä»¥å»è¯»è¿™äº›ä½</li>
<li>å¯ä»¥ç­‰å¾…æŸä¸€ä½ã€æŸäº›ä½ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥ç­‰å¾…å¤šä½</li>
</ul>
<img src="https://s2.loli.net/2025/05/08/BFbDhSE5m76Cjx2.png" style="zoom: 67%;" />
<p>äº‹ä»¶ç»„ç”¨ä¸€ä¸ªæ•´æ•°æ¥è¡¨ç¤ºï¼Œ<strong>é«˜8ä½ç•™ç»™å†…æ ¸ä½¿ç”¨</strong>ï¼Œåªèƒ½ç”¨å…¶ä»–çš„ä½æ¥è¡¨ç¤ºäº‹ä»¶</p>
<ul>
<li>
<p>å¦‚æœconfigUSE_16_BIT_TICKSæ˜¯1ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•´æ•°å°±æ˜¯16ä½çš„ï¼Œä½8ä½ç”¨æ¥è¡¨ç¤ºäº‹ä»¶</p>
</li>
<li>
<p>å¦‚æœconfigUSE_16_BIT_TICKSæ˜¯0ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•´æ•°å°±æ˜¯32ä½çš„ï¼Œä½24ä½ç”¨æ¥è¡¨ç¤ºäº‹ä»¶</p>
</li>
<li>
<p>configUSE_16_BIT_TICKSæ˜¯ç”¨æ¥è¡¨ç¤ºTick Countçš„ï¼Œæ€ä¹ˆä¼šå½±å“äº‹ä»¶ç»„ï¼Ÿè¿™åªæ˜¯åŸºäºæ•ˆç‡æ¥è€ƒè™‘</p>
<ul>
<li>å¦‚æœconfigUSE_16_BIT_TICKSæ˜¯1ï¼Œå°±è¡¨ç¤ºè¯¥å¤„ç†å™¨ä½¿ç”¨16ä½æ›´é«˜æ•ˆï¼Œæ‰€ä»¥äº‹ä»¶ç»„ä¹Ÿä½¿ç”¨16ä½</li>
<li>å¦‚æœconfigUSE_16_BIT_TICKSæ˜¯0ï¼Œå°±è¡¨ç¤ºè¯¥å¤„ç†å™¨ä½¿ç”¨32ä½æ›´é«˜æ•ˆï¼Œæ‰€ä»¥äº‹ä»¶ç»„ä¹Ÿä½¿ç”¨32ä½</li>
</ul>
</li>
</ul>
<h2 id="å‡½æ•°-4"><a class="markdownIt-Anchor" href="#å‡½æ•°-4"></a> å‡½æ•°</h2>
<h3 id="åˆ›å»º-3"><a class="markdownIt-Anchor" href="#åˆ›å»º-3"></a> åˆ›å»º</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªäº‹ä»¶ç»„ï¼Œè¿”å›å®ƒçš„å¥æŸ„ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°å†…éƒ¨ä¼šåˆ†é…äº‹ä»¶ç»„ç»“æ„ä½“ </span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">EventGroupHandle_t <span class="title function_">xEventGroupCreate</span><span class="params">( <span class="type">void</span> )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªäº‹ä»¶ç»„ï¼Œè¿”å›å®ƒçš„å¥æŸ„ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°æ— éœ€åŠ¨æ€åˆ†é…å†…å­˜ï¼Œæ‰€ä»¥éœ€è¦å…ˆæœ‰ä¸€ä¸ªStaticEventGroup_tç»“æ„ä½“ï¼Œå¹¶ä¼ å…¥å®ƒçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›å¥æŸ„ï¼ŒéNULLè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">EventGroupHandle_t <span class="title function_">xEventGroupCreateStatic</span><span class="params">( StaticEventGroup_t * pxEventGroupBuffer)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ é™¤-3"><a class="markdownIt-Anchor" href="#åˆ é™¤-3"></a> åˆ é™¤</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*	xEventGroup: äº‹ä»¶ç»„å¥æŸ„ï¼Œä½ è¦åˆ é™¤å“ªä¸ªäº‹ä»¶ç»„	*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vEventGroupDelete</span><span class="params">( EventGroupHandle_t xEventGroup )</span></span><br></pre></td></tr></table></figure>
<h3 id="è®¾ç½®äº‹ä»¶"><a class="markdownIt-Anchor" href="#è®¾ç½®äº‹ä»¶"></a> è®¾ç½®äº‹ä»¶</h3>
<ul>
<li>åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨<code>xEventGroupSetBits()</code></li>
<li>åœ¨ISRä¸­ä½¿ç”¨<code>xEventGroupSetBitsFromISR()</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è®¾ç½®äº‹ä»¶ç»„ä¸­çš„ä½</span></span><br><span class="line"><span class="comment"> * xEventGroup: å“ªä¸ªäº‹ä»¶ç»„</span></span><br><span class="line"><span class="comment"> * uxBitsToSet: è®¾ç½®å“ªäº›ä½? </span></span><br><span class="line"><span class="comment"> *              å¦‚æœuxBitsToSetçš„bitX, bitYä¸º1, é‚£ä¹ˆäº‹ä»¶ç»„ä¸­çš„bitX, bitYè¢«è®¾ç½®ä¸º1</span></span><br><span class="line"><span class="comment"> *              å¯ä»¥ç”¨æ¥è®¾ç½®å¤šä¸ªä½ï¼Œæ¯”å¦‚ 0x15 å°±è¡¨ç¤ºè®¾ç½®bit4, bit2, bit0</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: è¿”å›åŸæ¥çš„äº‹ä»¶å€¼(æ²¡ä»€ä¹ˆæ„ä¹‰, å› ä¸ºå¾ˆå¯èƒ½å·²ç»è¢«å…¶ä»–ä»»åŠ¡ä¿®æ”¹äº†)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">EventBits_t <span class="title function_">xEventGroupSetBits</span><span class="params">(EventGroupHandle_t xEventGroup,</span></span><br><span class="line"><span class="params">                               <span class="type">const</span> EventBits_t uxBitsToSet)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾ç½®äº‹ä»¶ç»„ä¸­çš„ä½</span></span><br><span class="line"><span class="comment"> * xEventGroup: å“ªä¸ªäº‹ä»¶ç»„</span></span><br><span class="line"><span class="comment"> * uxBitsToSet: è®¾ç½®å“ªäº›ä½? </span></span><br><span class="line"><span class="comment"> *              å¦‚æœuxBitsToSetçš„bitX, bitYä¸º1, é‚£ä¹ˆäº‹ä»¶ç»„ä¸­çš„bitX, bitYè¢«è®¾ç½®ä¸º1</span></span><br><span class="line"><span class="comment"> *              å¯ä»¥ç”¨æ¥è®¾ç½®å¤šä¸ªä½ï¼Œæ¯”å¦‚ 0x15 å°±è¡¨ç¤ºè®¾ç½®bit4, bit2, bit0</span></span><br><span class="line"><span class="comment"> * pxHigherPriorityTaskWoken: æœ‰æ²¡æœ‰å¯¼è‡´æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡è¿›å…¥å°±ç»ªæ€? pdTRUE-æœ‰, pdFALSE-æ²¡æœ‰</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdPASS-æˆåŠŸ, pdFALSE-å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xEventGroupSetBitsFromISR</span><span class="params">( EventGroupHandle_t xEventGroup,</span></span><br><span class="line"><span class="params">									  <span class="type">const</span> EventBits_t uxBitsToSet,</span></span><br><span class="line"><span class="params">									  BaseType_t * pxHigherPriorityTaskWoken )</span>;</span><br></pre></td></tr></table></figure>
<p><code>xEventGroupSetBitsFromISR</code>å‡½æ•°<strong>ä¸æ˜¯ç›´æ¥å»è®¾ç½®äº‹ä»¶ç»„</strong>ï¼Œè€Œæ˜¯ç»™ä¸€ä¸ªFreeRTOSåå°ä»»åŠ¡(daemon task)å‘é€é˜Ÿåˆ—æ•°æ®ï¼Œç”±è¿™ä¸ªä»»åŠ¡æ¥è®¾ç½®äº‹ä»¶ç»„ã€‚</p>
<h3 id="ç­‰å¾…äº‹ä»¶"><a class="markdownIt-Anchor" href="#ç­‰å¾…äº‹ä»¶"></a> ç­‰å¾…äº‹ä»¶</h3>
<p>ä½¿ç”¨<code>xEventGroupWaitBits</code>æ¥ç­‰å¾…äº‹ä»¶ï¼Œå¯ä»¥ç­‰å¾…æŸä¸€ä½ã€æŸäº›ä½ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥ç­‰å¾…å¤šä½ï¼›ç­‰åˆ°æœŸæœ›çš„äº‹ä»¶åï¼Œè¿˜å¯ä»¥æ¸…é™¤æŸäº›ä½ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">EventBits_t <span class="title function_">xEventGroupWaitBits</span><span class="params">( EventGroupHandle_t xEventGroup,</span></span><br><span class="line"><span class="params">                                 <span class="type">const</span> EventBits_t uxBitsToWaitFor,</span></span><br><span class="line"><span class="params">                                 <span class="type">const</span> BaseType_t xClearOnExit,</span></span><br><span class="line"><span class="params">                                 <span class="type">const</span> BaseType_t xWaitForAllBits,</span></span><br><span class="line"><span class="params">                                 TickType_t xTicksToWait )</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">å‚æ•°</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">xEventGroup</td>
<td style="text-align:center">ç­‰å¾…å“ªä¸ªäº‹ä»¶ç»„ï¼Ÿ</td>
</tr>
<tr>
<td style="text-align:center">uxBitsToWaitFor</td>
<td style="text-align:center">ç­‰å¾…å“ªäº›ä½ï¼Ÿå“ªäº›ä½è¦è¢«æµ‹è¯•ï¼Ÿ</td>
</tr>
<tr>
<td style="text-align:center">xWaitForAllBits</td>
<td style="text-align:center">æ€ä¹ˆæµ‹è¯•ï¼Ÿæ˜¯&quot;AND&quot;è¿˜æ˜¯&quot;OR&quot;ï¼Ÿ pdTRUE: ç­‰å¾…çš„ä½ï¼Œå…¨éƒ¨ä¸º1; pdFALSE: ç­‰å¾…çš„ä½ï¼ŒæŸä¸€ä¸ªä¸º1å³å¯</td>
</tr>
<tr>
<td style="text-align:center">xClearOnExit</td>
<td style="text-align:center">å‡½æ•°æå‡ºå‰æ˜¯å¦è¦æ¸…é™¤äº‹ä»¶ï¼Ÿ pdTRUE: æ¸…é™¤uxBitsToWaitForæŒ‡å®šçš„ä½ pdFALSE: ä¸æ¸…é™¤</td>
</tr>
<tr>
<td style="text-align:center">xTicksToWait</td>
<td style="text-align:center">å¦‚æœæœŸå¾…çš„äº‹ä»¶æœªå‘ç”Ÿï¼Œé˜»å¡å¤šä¹…ã€‚ å¯ä»¥è®¾ç½®ä¸º0ï¼šåˆ¤æ–­åå³åˆ»è¿”å›ï¼› å¯è®¾ç½®ä¸ºportMAX_DELAYï¼šä¸€å®šç­‰åˆ°æˆåŠŸæ‰è¿”å›ï¼› å¯ä»¥è®¾ç½®ä¸ºæœŸæœ›çš„Tick Countï¼Œä¸€èˆ¬ç”¨<code>pdMS_TO_TICKS()</code>æŠŠmsè½¬æ¢ä¸ºTick Count</td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">è¿”å›çš„æ˜¯äº‹ä»¶å€¼ï¼Œ å¦‚æœæœŸå¾…çš„äº‹ä»¶å‘ç”Ÿäº†ï¼Œè¿”å›çš„æ˜¯&quot;éé˜»å¡æ¡ä»¶æˆç«‹&quot;æ—¶çš„äº‹ä»¶å€¼ï¼› å¦‚æœæ˜¯è¶…æ—¶é€€å‡ºï¼Œè¿”å›çš„æ˜¯è¶…æ—¶æ—¶åˆ»çš„äº‹ä»¶å€¼ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="åŒæ­¥ç‚¹"><a class="markdownIt-Anchor" href="#åŒæ­¥ç‚¹"></a> åŒæ­¥ç‚¹</h3>
<p>ä½¿ç”¨<code>xEventGroupSync()</code>å‡½æ•°å¯ä»¥åŒæ­¥å¤šä¸ªä»»åŠ¡ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">EventBits_t <span class="title function_">xEventGroupSync</span><span class="params">(    EventGroupHandle_t xEventGroup,</span></span><br><span class="line"><span class="params">                                <span class="type">const</span> EventBits_t uxBitsToSet,</span></span><br><span class="line"><span class="params">                                <span class="type">const</span> EventBits_t uxBitsToWaitFor,</span></span><br><span class="line"><span class="params">                                TickType_t xTicksToWait )</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">å‚æ•°</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">xEventGroup</td>
<td style="text-align:center">å“ªä¸ªäº‹ä»¶ç»„</td>
</tr>
<tr>
<td style="text-align:center">uxBitsToSet</td>
<td style="text-align:center">è¦è®¾ç½®å“ªäº›äº‹ä»¶ï¼Œå·²ç»å®Œæˆäº†å“ªäº›äº‹ä»¶ï¼Ÿ æ¯”å¦‚0x05(äºŒè¿›åˆ¶ä¸º0101)ä¼šå¯¼è‡´äº‹ä»¶ç»„çš„bit0,bit2è¢«è®¾ç½®ä¸º1</td>
</tr>
<tr>
<td style="text-align:center">uxBitsToWaitFor</td>
<td style="text-align:center">ç­‰å¾…é‚£ä¸ªä½ã€å“ªäº›ä½ï¼Ÿ æ¯”å¦‚0x15(äºŒçº§åˆ¶10101)ï¼Œè¡¨ç¤ºè¦ç­‰å¾…bit0,bit2,bit4éƒ½ä¸º1</td>
</tr>
<tr>
<td style="text-align:center">xTicksToWait</td>
<td style="text-align:center">å¦‚æœæœŸå¾…çš„äº‹ä»¶æœªå‘ç”Ÿï¼Œé˜»å¡å¤šä¹…ã€‚ å¯ä»¥è®¾ç½®ä¸º0ï¼šåˆ¤æ–­åå³åˆ»è¿”å›ï¼› å¯è®¾ç½®ä¸ºportMAX_DELAYï¼šä¸€å®šç­‰åˆ°æˆåŠŸæ‰è¿”å›ï¼› å¯ä»¥è®¾ç½®ä¸ºæœŸæœ›çš„Tick Countï¼Œä¸€èˆ¬ç”¨<code>pdMS_TO_TICKS()</code>æŠŠmsè½¬æ¢ä¸ºTick Count</td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">è¿”å›çš„æ˜¯äº‹ä»¶å€¼ï¼Œ å¦‚æœæœŸå¾…çš„äº‹ä»¶å‘ç”Ÿäº†ï¼Œè¿”å›çš„æ˜¯&quot;éé˜»å¡æ¡ä»¶æˆç«‹&quot;æ—¶çš„äº‹ä»¶å€¼ï¼› å¦‚æœæ˜¯è¶…æ—¶é€€å‡ºï¼Œè¿”å›çš„æ˜¯è¶…æ—¶æ—¶åˆ»çš„äº‹ä»¶å€¼ã€‚</td>
</tr>
</tbody>
</table>
<h1 id="ä»»åŠ¡é€šçŸ¥"><a class="markdownIt-Anchor" href="#ä»»åŠ¡é€šçŸ¥"></a> ä»»åŠ¡é€šçŸ¥</h1>
<h2 id="ç‰¹æ€§-4"><a class="markdownIt-Anchor" href="#ç‰¹æ€§-4"></a> ç‰¹æ€§</h2>
<h3 id="ä¼˜åŠ¿"><a class="markdownIt-Anchor" href="#ä¼˜åŠ¿"></a> ä¼˜åŠ¿</h3>
<ul>
<li><strong>æ•ˆç‡æ›´é«˜</strong>ï¼šä½¿ç”¨ä»»åŠ¡é€šçŸ¥æ¥å‘é€äº‹ä»¶ã€æ•°æ®ç»™æŸä¸ªä»»åŠ¡æ—¶ï¼Œæ•ˆç‡æ›´é«˜ã€‚æ¯”é˜Ÿåˆ—ã€ä¿¡å·é‡ã€äº‹ä»¶ç»„éƒ½æœ‰å¤§çš„ä¼˜åŠ¿ã€‚</li>
<li><strong>æ›´èŠ‚çœå†…å­˜</strong>ï¼šä½¿ç”¨å…¶ä»–æ–¹æ³•æ—¶éƒ½è¦å…ˆåˆ›å»ºå¯¹åº”çš„ç»“æ„ä½“ï¼Œä½¿ç”¨ä»»åŠ¡é€šçŸ¥æ—¶æ— éœ€é¢å¤–åˆ›å»ºç»“æ„ä½“ã€‚</li>
</ul>
<h3 id="é™åˆ¶"><a class="markdownIt-Anchor" href="#é™åˆ¶"></a> é™åˆ¶</h3>
<ul>
<li><strong>ä¸èƒ½å‘é€æ•°æ®ç»™ISR</strong>ï¼š ISRå¹¶æ²¡æœ‰ä»»åŠ¡ç»“æ„ä½“ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ä»»åŠ¡é€šçŸ¥çš„åŠŸèƒ½ç»™ISRå‘é€æ•°æ®ã€‚ä½†æ˜¯ISRå¯ä»¥ä½¿ç”¨ä»»åŠ¡é€šçŸ¥çš„åŠŸèƒ½ï¼Œå‘æ•°æ®ç»™ä»»åŠ¡ã€‚</li>
<li><strong>æ•°æ®åªèƒ½ç»™è¯¥ä»»åŠ¡ç‹¬äº«</strong>ï¼š ä½¿ç”¨é˜Ÿåˆ—ã€ä¿¡å·é‡ã€äº‹ä»¶ç»„æ—¶ï¼Œæ•°æ®ä¿å­˜åœ¨è¿™äº›ç»“æ„ä½“ä¸­ï¼Œå…¶ä»–ä»»åŠ¡ã€ISRéƒ½å¯ä»¥è®¿é—®è¿™äº›æ•°æ®ã€‚ä½¿ç”¨ä»»åŠ¡é€šçŸ¥æ—¶ï¼Œæ•°æ®å­˜æ”¾å…¥ç›®æ ‡ä»»åŠ¡ä¸­ï¼Œåªæœ‰å®ƒå¯ä»¥è®¿é—®è¿™äº›æ•°æ®ã€‚ åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œè¿™ä¸ªé™åˆ¶å½±å“ä¸å¤§ã€‚å› ä¸ºå¾ˆå¤šåœºåˆæ˜¯ä»å¤šä¸ªæ•°æ®æºæŠŠæ•°æ®å‘ç»™æŸä¸ªä»»åŠ¡ï¼Œè€Œä¸æ˜¯æŠŠä¸€ä¸ªæ•°æ®æºçš„æ•°æ®å‘ç»™å¤šä¸ªä»»åŠ¡ã€‚</li>
<li><strong>æ— æ³•ç¼“å†²æ•°æ®</strong> ï¼šä½¿ç”¨é˜Ÿåˆ—æ—¶ï¼Œå‡è®¾é˜Ÿåˆ—æ·±åº¦ä¸ºNï¼Œé‚£ä¹ˆå®ƒå¯ä»¥ä¿æŒNä¸ªæ•°æ®ã€‚ ä½¿ç”¨ä»»åŠ¡é€šçŸ¥æ—¶ï¼Œä»»åŠ¡ç»“æ„ä½“ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡é€šçŸ¥å€¼ï¼Œåªèƒ½ä¿æŒä¸€ä¸ªæ•°æ®ã€‚</li>
<li><strong>æ— æ³•å¹¿æ’­ç»™å¤šä¸ªä»»åŠ¡</strong> ï¼šä½¿ç”¨äº‹ä»¶ç»„å¯ä»¥åŒæ—¶ç»™å¤šä¸ªä»»åŠ¡å‘é€äº‹ä»¶ã€‚ ä½¿ç”¨ä»»åŠ¡é€šçŸ¥ï¼Œåªèƒ½å‘ä¸ªä¸€ä¸ªä»»åŠ¡ã€‚</li>
<li><strong>å¦‚æœå‘é€å—é˜»ï¼Œå‘é€æ–¹æ— æ³•è¿›å…¥é˜»å¡çŠ¶æ€ç­‰å¾…</strong>ï¼š å‡è®¾é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œä½¿ç”¨<code>xQueueSendToBack()</code>ç»™é˜Ÿåˆ—å‘é€æ•°æ®æ—¶ï¼Œä»»åŠ¡å¯ä»¥è¿›å…¥é˜»å¡çŠ¶æ€ç­‰å¾…å‘é€å®Œæˆã€‚ ä½¿ç”¨ä»»åŠ¡é€šçŸ¥æ—¶ï¼Œå³ä½¿å¯¹æ–¹æ— æ³•æ¥æ”¶æ•°æ®ï¼Œå‘é€æ–¹ä¹Ÿæ— æ³•é˜»å¡ç­‰å¾…ï¼Œåªèƒ½å³åˆ»è¿”å›é”™è¯¯ã€‚</li>
</ul>
<h3 id="é€šçŸ¥çŠ¶æ€å’Œé€šçŸ¥å€¼"><a class="markdownIt-Anchor" href="#é€šçŸ¥çŠ¶æ€å’Œé€šçŸ¥å€¼"></a> é€šçŸ¥çŠ¶æ€å’Œé€šçŸ¥å€¼</h3>
<p>æ¯ä¸ªäººç‰©éƒ½æœ‰ä¸€ä¸ªç»“æ„ä½“ï¼šTCBï¼Œé‡Œé¢å­˜åœ¨2ä¸ªæˆå‘˜ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ˜¯uint8_tç±»å‹ï¼Œç”¨æ¥è¡¨ç¤ºé€šçŸ¥<strong>çŠ¶æ€</strong></li>
<li>ä¸€ä¸ªæ˜¯uint32_tç±»å‹ï¼Œç”¨æ¥è¡¨ç¤ºé€šçŸ¥<strong>å€¼</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tskTaskControlBlock</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* configTASK_NOTIFICATION_ARRAY_ENTRIES = 1 */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">uint32_t</span> ulNotifiedValue[configTASK_NOTIFICATION_ARRAY_ENTRIES ];</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">uint8_t</span> ucNotifyState[configTASK_NOTIFICATION_ARRAY_ENTRIES ];</span><br><span class="line">    ......</span><br><span class="line">&#125; tskTCB;</span><br></pre></td></tr></table></figure>
<p>é€šçŸ¥çŠ¶æ€æœ‰3ç§å–å€¼ï¼š</p>
<ul>
<li><strong>taskNOT_WAITING_NOTIFICATION</strong>ï¼šä»»åŠ¡æ²¡æœ‰åœ¨ç­‰å¾…é€šçŸ¥</li>
<li><strong>taskWAITING_NOTIFICATION</strong>ï¼šä»»åŠ¡åœ¨ç­‰å¾…é€šçŸ¥</li>
<li><strong>taskNOTIFICATION_RECEIVED</strong>ï¼šä»»åŠ¡æ¥æ”¶åˆ°äº†é€šçŸ¥ï¼Œä¹Ÿè¢«ç§°ä¸ºpending(æœ‰æ•°æ®äº†ï¼Œå¾…å¤„ç†)</li>
</ul>
<h2 id="ä»»åŠ¡é€šçŸ¥çš„ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ä»»åŠ¡é€šçŸ¥çš„ä½¿ç”¨"></a> ä»»åŠ¡é€šçŸ¥çš„ä½¿ç”¨</h2>
<p>ä½¿ç”¨ä»»åŠ¡é€šçŸ¥ï¼Œå¯ä»¥å®ç°<strong>è½»é‡çº§çš„é˜Ÿåˆ—(é•¿åº¦ä¸º1)ã€é‚®ç®±(è¦†ç›–çš„é˜Ÿåˆ—)ã€è®¡æ•°å‹ä¿¡å·é‡ã€äºŒè¿›åˆ¶ä¿¡å·é‡ã€äº‹ä»¶ç»„</strong>ã€‚</p>
<h3 id="å‡½æ•°-5"><a class="markdownIt-Anchor" href="#å‡½æ•°-5"></a> å‡½æ•°</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// xTaskToNotifyå’ŒxTaskHandleä¸ºä»»åŠ¡å¥æŸ„(åˆ›å»ºä»»åŠ¡æ—¶å¾—åˆ°)ï¼Œç»™å“ªä¸ªä»»åŠ¡å‘é€šçŸ¥</span></span><br><span class="line">BaseType_t <span class="title function_">xTaskNotifyGive</span><span class="params">( TaskHandle_t xTaskToNotify )</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vTaskNotifyGiveFromISR</span><span class="params">( TaskHandle_t xTaskHandle, BaseType_t *pxHigherPriorityTaskWoken )</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">ulTaskNotifyTake</span><span class="params">( BaseType_t xClearCountOnExit, TickType_t xTicksToWait )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// xTaskNotify å‡½æ•°åŠŸèƒ½æ›´å¼ºå¤§ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒå‚æ•°å®ç°å„ç±»åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®©æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼åŠ ä¸€ï¼šè¿™æ—¶xTaskNotify()ç­‰åŒäºxTaskNotifyGive()</span></span><br><span class="line"><span class="comment">// è®¾ç½®æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼çš„æŸä¸€ä½ã€æŸäº›ä½ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€æ›´é«˜æ•ˆçš„äº‹ä»¶ç»„</span></span><br><span class="line"><span class="comment">// æŠŠä¸€ä¸ªæ–°å€¼å†™å…¥æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼ï¼šä¸Šä¸€æ¬¡çš„é€šçŸ¥å€¼è¢«è¯»èµ°åï¼Œå†™å…¥æ‰æˆåŠŸã€‚è¿™å°±æ˜¯è½»é‡çº§çš„ã€é•¿åº¦ä¸º1çš„é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">// ç”¨ä¸€ä¸ªæ–°å€¼è¦†ç›–æ¥æ”¶ä»»åŠ¡çš„é€šçŸ¥å€¼ï¼šæ— è®ºä¸Šä¸€æ¬¡çš„é€šçŸ¥å€¼æ˜¯å¦è¢«è¯»èµ°ï¼Œè¦†ç›–éƒ½æˆåŠŸã€‚ç±»ä¼¼xQueueOverwrite()å‡½æ•°ï¼Œè¿™å°±æ˜¯è½»é‡çº§çš„é‚®ç®±</span></span><br><span class="line"></span><br><span class="line">BaseType_t <span class="title function_">xTaskNotify</span><span class="params">( TaskHandle_t xTaskToNotify, <span class="type">uint32_t</span> ulValue, eNotifyAction eAction )</span>;</span><br><span class="line"></span><br><span class="line">BaseType_t <span class="title function_">xTaskNotifyFromISR</span><span class="params">( TaskHandle_t xTaskToNotify,</span></span><br><span class="line"><span class="params">                               <span class="type">uint32_t</span> ulValue, </span></span><br><span class="line"><span class="params">                               eNotifyAction eAction, </span></span><br><span class="line"><span class="params">                               BaseType_t *pxHigherPriorityTaskWoken )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨xTaskNotifyWait()å‡½æ•°ï¼å®ƒæ¯”ulTaskNotifyTake()æ›´å¤æ‚ï¼š</span></span><br><span class="line"><span class="comment">// å¯ä»¥è®©ä»»åŠ¡ç­‰å¾…(å¯ä»¥åŠ ä¸Šè¶…æ—¶æ—¶é—´)ï¼Œç­‰åˆ°ä»»åŠ¡çŠ¶æ€ä¸º&quot;pending&quot;(ä¹Ÿå°±æ˜¯æœ‰æ•°æ®)</span></span><br><span class="line"><span class="comment">// è¿˜å¯ä»¥åœ¨å‡½æ•°è¿›å…¥ã€é€€å‡ºæ—¶ï¼Œæ¸…é™¤é€šçŸ¥å€¼çš„æŒ‡å®šä½</span></span><br><span class="line"></span><br><span class="line">BaseType_t <span class="title function_">xTaskNotifyWait</span><span class="params">( <span class="type">uint32_t</span> ulBitsToClearOnEntry, </span></span><br><span class="line"><span class="params">                            <span class="type">uint32_t</span> ulBitsToClearOnExit, </span></span><br><span class="line"><span class="params">                            <span class="type">uint32_t</span> *pulNotificationValue, </span></span><br><span class="line"><span class="params">                            TickType_t xTicksToWait )</span>;</span><br></pre></td></tr></table></figure>
<p><strong>eNotifyActionå‚æ•°è¯´æ˜</strong>ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">eNotifyActionå–å€¼</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">eNoAction</td>
<td style="text-align:center">ä»…ä»…æ˜¯æ›´æ–°é€šçŸ¥çŠ¶æ€ä¸º&quot;pending&quot;ï¼Œæœªä½¿ç”¨ulValueã€‚ è¿™ä¸ªé€‰é¡¹ç›¸å½“äºè½»é‡çº§çš„ã€æ›´é«˜æ•ˆçš„äºŒè¿›åˆ¶ä¿¡å·é‡ã€‚</td>
</tr>
<tr>
<td style="text-align:center">eSetBits</td>
<td style="text-align:center">é€šçŸ¥å€¼ = åŸæ¥çš„é€šçŸ¥å€¼ | ulValueï¼ŒæŒ‰ä½æˆ–ã€‚ ç›¸å½“äºè½»é‡çº§çš„ã€æ›´é«˜æ•ˆçš„äº‹ä»¶ç»„ã€‚</td>
</tr>
<tr>
<td style="text-align:center">eIncrement</td>
<td style="text-align:center">é€šçŸ¥å€¼ = åŸæ¥çš„é€šçŸ¥å€¼ + 1ï¼Œæœªä½¿ç”¨ulValueã€‚ ç›¸å½“äºè½»é‡çº§çš„ã€æ›´é«˜æ•ˆçš„äºŒè¿›åˆ¶ä¿¡å·é‡ã€è®¡æ•°å‹ä¿¡å·é‡ã€‚ ç›¸å½“äº<code>xTaskNotifyGive()</code>å‡½æ•°ã€‚</td>
</tr>
<tr>
<td style="text-align:center">eSetValueWithoutOverwrite</td>
<td style="text-align:center">ä¸è¦†ç›–ã€‚ å¦‚æœé€šçŸ¥çŠ¶æ€ä¸º&quot;pending&quot;(è¡¨ç¤ºæœ‰æ•°æ®æœªè¯»)ï¼Œ åˆ™æ­¤æ¬¡è°ƒç”¨xTaskNotifyä¸åšä»»ä½•äº‹ï¼Œè¿”å›pdFAILã€‚ å¦‚æœé€šçŸ¥çŠ¶æ€ä¸æ˜¯&quot;pending&quot;(è¡¨ç¤ºæ²¡æœ‰æ–°æ•°æ®)ï¼Œ åˆ™ï¼šé€šçŸ¥å€¼ = ulValueã€‚</td>
</tr>
<tr>
<td style="text-align:center">eSetValueWithOverwrite</td>
<td style="text-align:center">è¦†ç›–ã€‚ æ— è®ºå¦‚ä½•ï¼Œä¸ç®¡é€šçŸ¥çŠ¶æ€æ˜¯å¦ä¸º&quot;pendng&quot;ï¼Œ é€šçŸ¥å€¼ = ulValueã€‚</td>
</tr>
</tbody>
</table>
<h1 id="è½¯ä»¶å®šæ—¶å™¨"><a class="markdownIt-Anchor" href="#è½¯ä»¶å®šæ—¶å™¨"></a> è½¯ä»¶å®šæ—¶å™¨</h1>
<h2 id="ç‰¹æ€§-5"><a class="markdownIt-Anchor" href="#ç‰¹æ€§-5"></a> ç‰¹æ€§</h2>
<p>è·Ÿé—¹é’Ÿç±»ä¼¼ï¼Œ<strong>åªå“ä¸€æ¬¡/æ¯éš”å¤šå°‘æ—¶é—´å°±è‡ªåŠ¨æ“ä½œ</strong>ã€‚</p>
<p><strong>ä¸¤ç§çŠ¶æ€</strong></p>
<ul>
<li><strong>è¿è¡Œ</strong>(Runningã€Active)ï¼šè¿è¡Œæ€çš„å®šæ—¶å™¨ï¼Œå½“æŒ‡å®šæ—¶é—´åˆ°è¾¾ä¹‹åï¼Œå®ƒçš„å›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨</li>
<li><strong>å†¬çœ </strong>(Dormant)ï¼šå†¬çœ æ€çš„å®šæ—¶å™¨è¿˜å¯ä»¥é€šè¿‡å¥æŸ„æ¥è®¿é—®å®ƒï¼Œä½†æ˜¯å®ƒä¸å†è¿è¡Œï¼Œå®ƒçš„å›è°ƒå‡½æ•°ä¸ä¼šè¢«è°ƒç”¨</li>
</ul>
<h2 id="è½¯ä»¶å®šæ—¶å™¨çš„ä¸Šä¸‹æ–‡"><a class="markdownIt-Anchor" href="#è½¯ä»¶å®šæ—¶å™¨çš„ä¸Šä¸‹æ–‡"></a> è½¯ä»¶å®šæ—¶å™¨çš„ä¸Šä¸‹æ–‡</h2>
<h3 id="å®ˆæŠ¤ä»»åŠ¡"><a class="markdownIt-Anchor" href="#å®ˆæŠ¤ä»»åŠ¡"></a> å®ˆæŠ¤ä»»åŠ¡</h3>
<p>FreeRTOSä¸­æœ‰ä¸€ä¸ªTickä¸­æ–­ï¼Œè½¯ä»¶å®šæ—¶å™¨<strong>åŸºäºTickæ¥è¿è¡Œ</strong>ï¼Œä½†<strong>ä¸åœ¨Tickä¸­æ–­ä¸­æ‰§è¡Œå®šæ—¶å™¨å‡½æ•°</strong>ï¼Œè€Œæ˜¯åœ¨<strong>RTOS Damemon Task</strong>ä¸­æ‰§è¡Œï¼Œå³<strong>å®ˆæŠ¤ä»»åŠ¡</strong>ã€‚</p>
<p>å®ˆæŠ¤ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼šconfigTIMER_TASK_PRIORITY</p>
<p>å®šæ—¶å™¨å‘½ä»¤é˜Ÿåˆ—çš„é•¿åº¦ï¼šconfigTIMER_QUEUE_LENGTH</p>
<h3 id="å›è°ƒå‡½æ•°"><a class="markdownIt-Anchor" href="#å›è°ƒå‡½æ•°"></a> å›è°ƒå‡½æ•°</h3>
<p>å¦‚ä¸‹æ˜¯å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°åŸå‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">ATimerCallback</span><span class="params">( TimerHandle_t xTimer )</span>;</span><br></pre></td></tr></table></figure>
<p>å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°æ˜¯åœ¨å®ˆæŠ¤ä»»åŠ¡ä¸­è¢«è°ƒç”¨çš„ï¼Œ<strong>å®ˆæŠ¤ä»»åŠ¡ä¸æ˜¯ä¸“ä¸ºæŸä¸ªå®šæ—¶å™¨æœåŠ¡çš„</strong>ï¼Œå®ƒè¿˜è¦å¤„ç†å…¶ä»–å®šæ—¶å™¨ã€‚</p>
<p>å› æ­¤å›è°ƒä»»åŠ¡ä¸èƒ½å½±å“å…¶ä»–äººï¼š</p>
<ul>
<li><strong>å›è°ƒå‡½æ•°è¦å°½å¿«å®è¡Œ</strong>ï¼Œä¸èƒ½è¿›å…¥é˜»å¡çŠ¶æ€</li>
<li><strong>ä¸è¦è°ƒç”¨ä¼šå¯¼è‡´é˜»å¡çš„APIå‡½æ•°</strong>ï¼Œæ¯”å¦‚<code>vTaskDelay()</code></li>
<li>å¯ä»¥è°ƒç”¨<code>xQueueReceive()</code>ä¹‹ç±»çš„å‡½æ•°ï¼Œä½†æ˜¯è¶…æ—¶æ—¶é—´è¦è®¾ä¸º0ï¼šå³åˆ»è¿”å›ï¼Œä¸å¯é˜»å¡</li>
</ul>
<h2 id="å‡½æ•°-6"><a class="markdownIt-Anchor" href="#å‡½æ•°-6"></a> å‡½æ•°</h2>
<img src="https://s2.loli.net/2025/05/08/angVbmzSiAKhTML.png" style="zoom:50%;" />
<h3 id="åˆ›å»º-4"><a class="markdownIt-Anchor" href="#åˆ›å»º-4"></a> åˆ›å»º</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ä½¿ç”¨åŠ¨æ€åˆ†é…å†…å­˜çš„æ–¹æ³•åˆ›å»ºå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * pcTimerName:å®šæ—¶å™¨åå­—, ç”¨å¤„ä¸å¤§, å°½åœ¨è°ƒè¯•æ—¶ç”¨åˆ°</span></span><br><span class="line"><span class="comment"> * xTimerPeriodInTicks: å‘¨æœŸ, ä»¥Tickä¸ºå•ä½</span></span><br><span class="line"><span class="comment"> * uxAutoReload: ç±»å‹, pdTRUEè¡¨ç¤ºè‡ªåŠ¨åŠ è½½, pdFALSEè¡¨ç¤ºä¸€æ¬¡æ€§</span></span><br><span class="line"><span class="comment"> * pvTimerID: å›è°ƒå‡½æ•°å¯ä»¥ä½¿ç”¨æ­¤å‚æ•°, æ¯”å¦‚åˆ†è¾¨æ˜¯å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * pxCallbackFunction: å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: æˆåŠŸåˆ™è¿”å›TimerHandle_t, å¦åˆ™è¿”å›NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">TimerHandle_t <span class="title function_">xTimerCreate</span><span class="params">( <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> pcTimerName, </span></span><br><span class="line"><span class="params">							<span class="type">const</span> TickType_t xTimerPeriodInTicks,</span></span><br><span class="line"><span class="params">							<span class="type">const</span> UBaseType_t uxAutoReload,</span></span><br><span class="line"><span class="params">							<span class="type">void</span> * <span class="type">const</span> pvTimerID,</span></span><br><span class="line"><span class="params">							TimerCallbackFunction_t pxCallbackFunction )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä½¿ç”¨é™æ€åˆ†é…å†…å­˜çš„æ–¹æ³•åˆ›å»ºå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * pcTimerName:å®šæ—¶å™¨åå­—, ç”¨å¤„ä¸å¤§, å°½åœ¨è°ƒè¯•æ—¶ç”¨åˆ°</span></span><br><span class="line"><span class="comment"> * xTimerPeriodInTicks: å‘¨æœŸ, ä»¥Tickä¸ºå•ä½</span></span><br><span class="line"><span class="comment"> * uxAutoReload: ç±»å‹, pdTRUEè¡¨ç¤ºè‡ªåŠ¨åŠ è½½, pdFALSEè¡¨ç¤ºä¸€æ¬¡æ€§</span></span><br><span class="line"><span class="comment"> * pvTimerID: å›è°ƒå‡½æ•°å¯ä»¥ä½¿ç”¨æ­¤å‚æ•°, æ¯”å¦‚åˆ†è¾¨æ˜¯å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * pxCallbackFunction: å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> * pxTimerBuffer: ä¼ å…¥ä¸€ä¸ªStaticTimer_tç»“æ„ä½“, å°†åœ¨ä¸Šé¢æ„é€ å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: æˆåŠŸåˆ™è¿”å›TimerHandle_t, å¦åˆ™è¿”å›NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">TimerHandle_t <span class="title function_">xTimerCreateStatic</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> pcTimerName,</span></span><br><span class="line"><span class="params">                                 TickType_t xTimerPeriodInTicks,</span></span><br><span class="line"><span class="params">                                 UBaseType_t uxAutoReload,</span></span><br><span class="line"><span class="params">                                 <span class="type">void</span> * pvTimerID,</span></span><br><span class="line"><span class="params">                                 TimerCallbackFunction_t pxCallbackFunction,</span></span><br><span class="line"><span class="params">                                 StaticTimer_t *pxTimerBuffer )</span>;</span><br></pre></td></tr></table></figure>
<p>å›è°ƒå‡½æ•°çš„ç±»å‹æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">ATimerCallback</span><span class="params">( TimerHandle_t xTimer )</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(* TimerCallbackFunction_t)</span><span class="params">( TimerHandle_t xTimer )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ é™¤-4"><a class="markdownIt-Anchor" href="#åˆ é™¤-4"></a> åˆ é™¤</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åˆ é™¤å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xTimer: è¦åˆ é™¤å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xTicksToWait: è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;åˆ é™¤å‘½ä»¤&quot;åœ¨xTicksToWaitä¸ªTickå†…æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerDelete</span><span class="params">( TimerHandle_t xTimer, TickType_t xTicksToWait )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="å¯åŠ¨åœæ­¢"><a class="markdownIt-Anchor" href="#å¯åŠ¨åœæ­¢"></a> å¯åŠ¨/åœæ­¢</h3>
<p><strong>å¯åŠ¨</strong>å®šæ—¶å™¨å°±æ˜¯è®¾ç½®å®ƒçš„çŠ¶æ€ä¸º<strong>è¿è¡Œæ€</strong>(Runningã€Active)ã€‚</p>
<p><strong>åœæ­¢</strong>å®šæ—¶å™¨å°±æ˜¯è®¾ç½®å®ƒçš„çŠ¶æ€ä¸º<strong>å†¬çœ </strong>(Dormant)ï¼Œè®©å®ƒä¸èƒ½è¿è¡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å¯åŠ¨å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xTicksToWait: è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;å¯åŠ¨å‘½ä»¤&quot;åœ¨xTicksToWaitä¸ªTickå†…æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerStart</span><span class="params">( TimerHandle_t xTimer, TickType_t xTicksToWait )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¯åŠ¨å®šæ—¶å™¨(ISRç‰ˆæœ¬)</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * pxHigherPriorityTaskWoken: å‘é˜Ÿåˆ—å‘å‡ºå‘½ä»¤ä½¿å¾—å®ˆæŠ¤ä»»åŠ¡è¢«å”¤é†’,</span></span><br><span class="line"><span class="comment"> *                            å¦‚æœå®ˆæŠ¤ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”å½“å‰ä»»åŠ¡çš„é«˜,</span></span><br><span class="line"><span class="comment"> *                            åˆ™&quot;*pxHigherPriorityTaskWoken = pdTRUE&quot;,</span></span><br><span class="line"><span class="comment"> *                            è¡¨ç¤ºéœ€è¦è¿›è¡Œä»»åŠ¡è°ƒåº¦</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;å¯åŠ¨å‘½ä»¤&quot;æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerStartFromISR</span><span class="params">(   TimerHandle_t xTimer,</span></span><br><span class="line"><span class="params">                                 BaseType_t *pxHigherPriorityTaskWoken )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åœæ­¢å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xTicksToWait: è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;åœæ­¢å‘½ä»¤&quot;åœ¨xTicksToWaitä¸ªTickå†…æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerStop</span><span class="params">( TimerHandle_t xTimer, TickType_t xTicksToWait )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åœæ­¢å®šæ—¶å™¨(ISRç‰ˆæœ¬)</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * pxHigherPriorityTaskWoken: å‘é˜Ÿåˆ—å‘å‡ºå‘½ä»¤ä½¿å¾—å®ˆæŠ¤ä»»åŠ¡è¢«å”¤é†’,</span></span><br><span class="line"><span class="comment"> *                            å¦‚æœå®ˆæŠ¤ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”å½“å‰ä»»åŠ¡çš„é«˜,</span></span><br><span class="line"><span class="comment"> *                            åˆ™&quot;*pxHigherPriorityTaskWoken = pdTRUE&quot;,</span></span><br><span class="line"><span class="comment"> *                            è¡¨ç¤ºéœ€è¦è¿›è¡Œä»»åŠ¡è°ƒåº¦</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;åœæ­¢å‘½ä»¤&quot;æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerStopFromISR</span><span class="params">(    TimerHandle_t xTimer,</span></span><br><span class="line"><span class="params">                                 BaseType_t *pxHigherPriorityTaskWoken )</span>;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå®šæ—¶å™¨æ—¶ï¼Œè®¾ç½®äº†å®ƒçš„å‘¨æœŸ(period)ã€‚<code>xTimerStart()</code>å‡½æ•°æ˜¯ç”¨æ¥å¯åŠ¨å®šæ—¶å™¨ã€‚å‡è®¾è°ƒç”¨<code>xTimerStart()</code>çš„æ—¶åˆ»æ˜¯tXï¼Œå®šæ—¶å™¨çš„å‘¨æœŸæ˜¯nï¼Œé‚£ä¹ˆåœ¨<code>tX+n</code>æ—¶åˆ»å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°è¢«è°ƒç”¨ã€‚</p>
<p>å¦‚æœå®šæ—¶å™¨å·²ç»è¢«å¯åŠ¨ï¼Œä½†æ˜¯å®ƒçš„å‡½æ•°å°šæœªè¢«æ‰§è¡Œï¼Œå†æ¬¡æ‰§è¡Œ<code>xTimerStart()</code>å‡½æ•°ç›¸å½“äºæ‰§è¡Œ<code>xTimerReset()</code>ï¼Œé‡æ–°è®¾å®šå®ƒçš„å¯åŠ¨æ—¶é—´ã€‚</p>
<h2 id="å¤ä½-2"><a class="markdownIt-Anchor" href="#å¤ä½-2"></a> å¤ä½</h2>
<p>ä»å®šæ—¶å™¨çš„çŠ¶æ€è½¬æ¢å›¾å¯ä»¥çŸ¥é“ï¼Œä½¿ç”¨<code>xTimerReset()</code>å‡½æ•°å¯ä»¥è®©å®šæ—¶å™¨çš„çŠ¶æ€ä»å†¬çœ æ€è½¬æ¢ä¸ºè¿è¡Œæ€ï¼Œç›¸å½“äºä½¿ç”¨<code>xTimerStart()</code>å‡½æ•°ã€‚</p>
<p>å¦‚æœå®šæ—¶å™¨å·²ç»å¤„äºè¿è¡Œæ€ï¼Œä½¿ç”¨<code>xTimerReset()</code>å‡½æ•°å°±ç›¸å½“äºé‡æ–°ç¡®å®šè¶…æ—¶æ—¶é—´ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å¤ä½å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xTicksToWait: è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;å¤ä½å‘½ä»¤&quot;åœ¨xTicksToWaitä¸ªTickå†…æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerReset</span><span class="params">( TimerHandle_t xTimer, TickType_t xTicksToWait )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¤ä½å®šæ—¶å™¨(ISRç‰ˆæœ¬)</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * pxHigherPriorityTaskWoken: å‘é˜Ÿåˆ—å‘å‡ºå‘½ä»¤ä½¿å¾—å®ˆæŠ¤ä»»åŠ¡è¢«å”¤é†’,</span></span><br><span class="line"><span class="comment"> *                            å¦‚æœå®ˆæŠ¤ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”å½“å‰ä»»åŠ¡çš„é«˜,</span></span><br><span class="line"><span class="comment"> *                            åˆ™&quot;*pxHigherPriorityTaskWoken = pdTRUE&quot;,</span></span><br><span class="line"><span class="comment"> *                            è¡¨ç¤ºéœ€è¦è¿›è¡Œä»»åŠ¡è°ƒåº¦</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;åœæ­¢å‘½ä»¤&quot;æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerResetFromISR</span><span class="params">(   TimerHandle_t xTimer,</span></span><br><span class="line"><span class="params">                                 BaseType_t *pxHigherPriorityTaskWoken )</span>;</span><br></pre></td></tr></table></figure>
<h2 id="ä¿®æ”¹å‘¨æœŸ"><a class="markdownIt-Anchor" href="#ä¿®æ”¹å‘¨æœŸ"></a> ä¿®æ”¹å‘¨æœŸ</h2>
<p>ä»å®šæ—¶å™¨çš„çŠ¶æ€è½¬æ¢å›¾å¯ä»¥çŸ¥é“ï¼Œä½¿ç”¨<code>xTimerChangePeriod()</code>å‡½æ•°ï¼Œå¤„ç†èƒ½ä¿®æ”¹å®ƒçš„å‘¨æœŸå¤–ï¼Œè¿˜å¯ä»¥è®©å®šæ—¶å™¨çš„çŠ¶æ€ä»å†¬çœ æ€è½¬æ¢ä¸ºè¿è¡Œæ€ã€‚</p>
<p><strong>ä¿®æ”¹å®šæ—¶å™¨çš„å‘¨æœŸæ—¶ï¼Œä¼šä½¿ç”¨æ–°çš„å‘¨æœŸé‡æ–°è®¡ç®—å®ƒçš„è¶…æ—¶æ—¶é—´</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ä¿®æ”¹å®šæ—¶å™¨çš„å‘¨æœŸ</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xNewPeriod: æ–°å‘¨æœŸ</span></span><br><span class="line"><span class="comment"> * xTicksToWait: è¶…æ—¶æ—¶é—´, å‘½ä»¤å†™å…¥é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´ </span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;ä¿®æ”¹å‘¨æœŸå‘½ä»¤&quot;åœ¨xTicksToWaitä¸ªTickå†…æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerChangePeriod</span><span class="params">(   TimerHandle_t xTimer,</span></span><br><span class="line"><span class="params">                                 TickType_t xNewPeriod,</span></span><br><span class="line"><span class="params">                                 TickType_t xTicksToWait )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä¿®æ”¹å®šæ—¶å™¨çš„å‘¨æœŸ</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * xNewPeriod: æ–°å‘¨æœŸ</span></span><br><span class="line"><span class="comment"> * pxHigherPriorityTaskWoken: å‘é˜Ÿåˆ—å‘å‡ºå‘½ä»¤ä½¿å¾—å®ˆæŠ¤ä»»åŠ¡è¢«å”¤é†’,</span></span><br><span class="line"><span class="comment"> *                            å¦‚æœå®ˆæŠ¤ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”å½“å‰ä»»åŠ¡çš„é«˜,</span></span><br><span class="line"><span class="comment"> *                            åˆ™&quot;*pxHigherPriorityTaskWoken = pdTRUE&quot;,</span></span><br><span class="line"><span class="comment"> *                            è¡¨ç¤ºéœ€è¦è¿›è¡Œä»»åŠ¡è°ƒåº¦</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdFAILè¡¨ç¤º&quot;ä¿®æ”¹å‘¨æœŸå‘½ä»¤&quot;åœ¨xTicksToWaitä¸ªTickå†…æ— æ³•å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> *        pdPASSè¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BaseType_t <span class="title function_">xTimerChangePeriodFromISR</span><span class="params">( TimerHandle_t xTimer,</span></span><br><span class="line"><span class="params">                                      TickType_t xNewPeriod,</span></span><br><span class="line"><span class="params">                                      BaseType_t *pxHigherPriorityTaskWoken )</span>;</span><br></pre></td></tr></table></figure>
<h2 id="å®šæ—¶å™¨id"><a class="markdownIt-Anchor" href="#å®šæ—¶å™¨id"></a> å®šæ—¶å™¨ID</h2>
<ul>
<li>å¯ä»¥ç”¨æ¥æ ‡è®°å®šæ—¶å™¨ï¼Œè¡¨ç¤ºè‡ªå·±æ˜¯ä»€ä¹ˆå®šæ—¶å™¨</li>
<li>å¯ä»¥ç”¨æ¥ä¿å­˜å‚æ•°ï¼Œç»™å›è°ƒå‡½æ•°ä½¿ç”¨</li>
</ul>
<p>å®ƒçš„åˆå§‹å€¼åœ¨åˆ›å»ºå®šæ—¶å™¨æ—¶ç”±<code>xTimerCreate()</code>è¿™ç±»å‡½æ•°ä¼ å…¥ã€‚</p>
<ul>
<li>æ›´æ–°IDï¼šä½¿ç”¨<code>vTimerSetTimerID()</code>å‡½æ•°</li>
<li>æŸ¥è¯¢IDï¼šæŸ¥è¯¢<code>pvTimerGetTimerID()</code>å‡½æ•°</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è·å¾—å®šæ—¶å™¨çš„ID</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: å®šæ—¶å™¨çš„ID	*/</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">pvTimerGetTimerID</span><span class="params">( TimerHandle_t xTimer )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾ç½®å®šæ—¶å™¨çš„ID</span></span><br><span class="line"><span class="comment"> * xTimer: å“ªä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * pvNewID: æ–°ID</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: æ— 	 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vTimerSetTimerID</span><span class="params">( TimerHandle_t xTimer, <span class="type">void</span> *pvNewID )</span>;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸€èˆ¬ä½¿ç”¨é…ç½®"><a class="markdownIt-Anchor" href="#ä¸€èˆ¬ä½¿ç”¨é…ç½®"></a> ä¸€èˆ¬ä½¿ç”¨é…ç½®</h2>
<p>è¦ä½¿ç”¨å®šæ—¶å™¨ï¼Œéœ€è¦åšäº›å‡†å¤‡å·¥ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 1. å·¥ç¨‹ä¸­ */</span></span><br><span class="line"><span class="comment">//	æ·»åŠ  timer.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2. é…ç½®æ–‡ä»¶FreeRTOSConfig.hä¸­ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TIMERS			 1   <span class="comment">/* ä½¿èƒ½å®šæ—¶å™¨ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_TASK_PRIORITY    31  <span class="comment">/* å®ˆæŠ¤ä»»åŠ¡çš„ä¼˜å…ˆçº§, å°½å¯èƒ½é«˜ä¸€äº› */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_QUEUE_LENGTH     5   <span class="comment">/* å‘½ä»¤é˜Ÿåˆ—é•¿åº¦ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_TASK_STACK_DEPTH 32  <span class="comment">/* å®ˆæŠ¤ä»»åŠ¡çš„æ ˆå¤§å° */</span></span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 3. æºç ä¸­ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;timers.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<h1 id="ä¸­æ–­ç®¡ç†"><a class="markdownIt-Anchor" href="#ä¸­æ–­ç®¡ç†"></a> ä¸­æ–­ç®¡ç†</h1>
<h2 id="ç‰¹æ€§-6"><a class="markdownIt-Anchor" href="#ç‰¹æ€§-6"></a> ç‰¹æ€§</h2>
<p>ä¸­æ–­æµç¨‹ï¼Œ<strong>ISRè¦å°½é‡å¿«</strong></p>
<ul>
<li><strong>ä¿å­˜ç°åœº</strong>ï¼šTask1è¢«æ‰“æ–­ï¼Œéœ€è¦å…ˆä¿å­˜Task1çš„è¿è¡Œç¯å¢ƒï¼Œæ¯”å¦‚å„ç±»å¯„å­˜å™¨çš„å€¼</li>
<li><strong>åˆ†è¾¨ä¸­æ–­ã€è°ƒç”¨å¤„ç†å‡½æ•°</strong>(è¿™ä¸ªå‡½æ•°å°±è¢«ç§°ä¸ºISRï¼Œinterrupt service routine)</li>
<li><strong>æ¢å¤ç°åœº</strong>ï¼šç»§ç»­è¿è¡ŒTask1ï¼Œæˆ–è€…è¿è¡Œå…¶ä»–ä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡</li>
</ul>
<p>ISRçš„ä¼˜å…ˆçº§é«˜äºä»»åŠ¡ï¼šå³ä½¿æ˜¯ä¼˜å…ˆçº§æœ€ä½çš„ä¸­æ–­ï¼Œå®ƒçš„ä¼˜å…ˆçº§ä¹Ÿé«˜äºä»»åŠ¡ã€‚ä»»åŠ¡åªæœ‰åœ¨æ²¡æœ‰ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½æ‰§è¡Œã€‚</p>
<p><strong>Qï¼šä¸ºä»€ä¹ˆè¦å¼•å…¥ä¸¤å¥—APIå‡½æ•°ï¼Ÿ</strong></p>
<ol>
<li>
<p>å¾ˆå¤šAPIå‡½æ•°ä¼š<strong>å¯¼è‡´ä»»åŠ¡è®¡å…¥é˜»å¡çŠ¶æ€</strong>ï¼š</p>
</li>
<li>
<p>ISRè°ƒç”¨APIå‡½æ•°æ—¶ï¼Œ<strong>ISRä¸æ˜¯&quot;ä»»åŠ¡&quot;ï¼ŒISRä¸èƒ½è¿›å…¥é˜»å¡çŠ¶æ€</strong></p>
</li>
<li>
<p>æ‰€ä»¥ï¼Œåœ¨ä»»åŠ¡ä¸­ã€åœ¨ISRä¸­ï¼Œè¿™äº›å‡½æ•°çš„åŠŸèƒ½æ˜¯æœ‰å·®åˆ«çš„</p>
</li>
</ol>
<h2 id="ä¸¤å¥—apiå‡½æ•°åˆ—è¡¨"><a class="markdownIt-Anchor" href="#ä¸¤å¥—apiå‡½æ•°åˆ—è¡¨"></a> ä¸¤å¥—APIå‡½æ•°åˆ—è¡¨</h2>
<table>
<thead>
<tr>
<th style="text-align:center">ç±»å‹</th>
<th style="text-align:center">åœ¨ä»»åŠ¡ä¸­</th>
<th style="text-align:center">åœ¨ISRä¸­</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">é˜Ÿåˆ—(queue)</td>
<td style="text-align:center">xQueueSendToBack</td>
<td style="text-align:center">xQueueSendToBackFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xQueueSendToFront</td>
<td style="text-align:center">xQueueSendToFrontFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xQueueReceive</td>
<td style="text-align:center">xQueueReceiveFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xQueueOverwrite</td>
<td style="text-align:center">xQueueOverwriteFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xQueuePeek</td>
<td style="text-align:center">xQueuePeekFromISR</td>
</tr>
<tr>
<td style="text-align:center">ä¿¡å·é‡(semaphore)</td>
<td style="text-align:center">xSemaphoreGive</td>
<td style="text-align:center">xSemaphoreGiveFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xSemaphoreTake</td>
<td style="text-align:center">xSemaphoreTakeFromISR</td>
</tr>
<tr>
<td style="text-align:center">äº‹ä»¶ç»„(event group)</td>
<td style="text-align:center">xEventGroupSetBits</td>
<td style="text-align:center">xEventGroupSetBitsFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xEventGroupGetBits</td>
<td style="text-align:center">xEventGroupGetBitsFromISR</td>
</tr>
<tr>
<td style="text-align:center">ä»»åŠ¡é€šçŸ¥(task notification)</td>
<td style="text-align:center">xTaskNotifyGive</td>
<td style="text-align:center">vTaskNotifyGiveFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xTaskNotify</td>
<td style="text-align:center">xTaskNotifyFromISR</td>
</tr>
<tr>
<td style="text-align:center">è½¯ä»¶å®šæ—¶å™¨(software timer)</td>
<td style="text-align:center">xTimerStart</td>
<td style="text-align:center">xTimerStartFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xTimerStop</td>
<td style="text-align:center">xTimerStopFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xTimerReset</td>
<td style="text-align:center">xTimerResetFromISR</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">xTimerChangePeriod</td>
<td style="text-align:center">xTimerChangePeriodFromISR</td>
</tr>
</tbody>
</table>
<h2 id="æ€ä¹ˆåˆ‡æ¢ä»»åŠ¡"><a class="markdownIt-Anchor" href="#æ€ä¹ˆåˆ‡æ¢ä»»åŠ¡"></a> æ€ä¹ˆåˆ‡æ¢ä»»åŠ¡</h2>
<p>FreeRTOSçš„ISRå‡½æ•°ä¸­ï¼Œä½¿ç”¨ä¸¤ä¸ªå®è¿›è¡Œä»»åŠ¡åˆ‡æ¢ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">portEND_SWITCHING_ISR( xHigherPriorityTaskWoken ); 	<span class="comment">//æ±‡ç¼–å®ç°</span></span><br><span class="line">æˆ–</span><br><span class="line">portYIELD_FROM_ISR( xHigherPriorityTaskWoken );		<span class="comment">//Cè¯­è¨€å®ç°</span></span><br></pre></td></tr></table></figure>
<h2 id="ä¸­æ–­ä¸ä»»åŠ¡é—´çš„é€šä¿¡"><a class="markdownIt-Anchor" href="#ä¸­æ–­ä¸ä»»åŠ¡é—´çš„é€šä¿¡"></a> ä¸­æ–­ä¸ä»»åŠ¡é—´çš„é€šä¿¡</h2>
<p><strong>é˜Ÿåˆ—ã€ä¿¡å·é‡ã€äº’æ–¥é‡ã€äº‹ä»¶ç»„ã€ä»»åŠ¡é€šçŸ¥</strong>ç­‰ç­‰æ–¹æ³•ï¼Œéƒ½å¯ä½¿ç”¨ã€‚</p>
<p>è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ISRä¸­ä½¿ç”¨çš„å‡½æ•°è¦æœ‰&quot;FromISR&quot;åç¼€ã€‚</p>
<h1 id="èµ„æºç®¡ç†"><a class="markdownIt-Anchor" href="#èµ„æºç®¡ç†"></a> èµ„æºç®¡ç†</h1>
<p>è¦ç‹¬å å¼åœ°è®¿é—®ä¸´ç•Œèµ„æºï¼Œæœ‰3ç§æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>å…¬å¹³ç«äº‰ï¼šæ¯”å¦‚ä½¿ç”¨<strong>äº’æ–¥é‡</strong>ç­‰</p>
</li>
<li>
<p>è°è¦è·Ÿæˆ‘æŠ¢ï¼Œæˆ‘å°±ç­æ‰è°ï¼š</p>
<ul>
<li>
<p>ä¸­æ–­è¦è·Ÿæˆ‘æŠ¢ï¼Ÿæˆ‘<strong>å±è”½ä¸­æ–­</strong></p>
</li>
<li>
<p>å…¶ä»–ä»»åŠ¡è¦è·Ÿæˆ‘æŠ¢ï¼Ÿæˆ‘<strong>ç¦æ­¢è°ƒåº¦å™¨</strong>ï¼Œä¸è¿è¡Œä»»åŠ¡åˆ‡æ¢</p>
</li>
</ul>
</li>
</ul>
<h2 id="å±è”½ä¸­æ–­"><a class="markdownIt-Anchor" href="#å±è”½ä¸­æ–­"></a> å±è”½ä¸­æ–­</h2>
<ul>
<li>ä»»åŠ¡ä¸­ä½¿ç”¨ï¼š<code>taskENTER_CRITICA()/taskEXIT_CRITICAL()</code></li>
<li>ISRä¸­ä½¿ç”¨ï¼š<code>taskENTER_CRITICAL_FROM_ISR()/taskEXIT_CRITICAL_FROM_ISR()</code></li>
</ul>
<h3 id="ä»»åŠ¡ä¸­å±è”½ä¸­æ–­"><a class="markdownIt-Anchor" href="#ä»»åŠ¡ä¸­å±è”½ä¸­æ–­"></a> ä»»åŠ¡ä¸­å±è”½ä¸­æ–­</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åœ¨ä»»åŠ¡ä¸­ï¼Œå½“å‰æ—¶åˆ»ä¸­æ–­æ˜¯ä½¿èƒ½çš„</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œè¿™å¥ä»£ç åï¼Œå±è”½ä¸­æ–­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">taskENTER_CRITICAL();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¿é—®ä¸´ç•Œèµ„æº */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡æ–°ä½¿èƒ½ä¸­æ–­ */</span></span><br><span class="line">taskEXIT_CRITICAL();</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>taskENTER_CRITICA()</code>å’Œ<code>taskEXIT_CRITICAL()</code>ä¹‹é—´ï¼š</p>
<ul>
<li>
<p>ä½ä¼˜å…ˆçº§çš„ä¸­æ–­è¢«å±è”½äº†ï¼šä¼˜å…ˆçº§ä½äºç­‰äº<code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code></p>
</li>
<li>
<p>é«˜ä¼˜å…ˆçº§çš„ä¸­æ–­å¯ä»¥äº§ç”Ÿï¼šä¼˜å…ˆçº§é«˜äº<code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code></p>
<ul>
<li>ä½†æ˜¯ï¼Œè¿™äº›ä¸­æ–­ISRé‡Œï¼Œä¸å…è®¸ä½¿ç”¨FreeRTOSçš„APIå‡½æ•°</li>
</ul>
</li>
<li>
<p>ä»»åŠ¡è°ƒåº¦ä¾èµ–äºä¸­æ–­ã€ä¾èµ–äºAPIå‡½æ•°ï¼Œæ‰€ä»¥ï¼šè¿™ä¸¤æ®µä»£ç ä¹‹é—´ï¼Œä¸ä¼šæœ‰ä»»åŠ¡è°ƒåº¦äº§ç”Ÿ</p>
</li>
</ul>
<h3 id="åœ¨isrä¸­å±è”½ä¸­æ–­"><a class="markdownIt-Anchor" href="#åœ¨isrä¸­å±è”½ä¸­æ–­"></a> åœ¨ISRä¸­å±è”½ä¸­æ–­</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vAnInterruptServiceRoutine</span><span class="params">( <span class="type">void</span> )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* ç”¨æ¥è®°å½•å½“å‰ä¸­æ–­æ˜¯å¦ä½¿èƒ½ */</span></span><br><span class="line">    UBaseType_t uxSavedInterruptStatus;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* åœ¨ISRä¸­ï¼Œå½“å‰æ—¶åˆ»ä¸­æ–­å¯èƒ½æ˜¯ä½¿èƒ½çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¦æ­¢çš„</span></span><br><span class="line"><span class="comment">     * æ‰€ä»¥è¦è®°å½•å½“å‰çŠ¶æ€, åé¢è¦æ¢å¤ä¸ºåŸå…ˆçš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">     * æ‰§è¡Œè¿™å¥ä»£ç åï¼Œå±è”½ä¸­æ–­	*/</span></span><br><span class="line">    uxSavedInterruptStatus = taskENTER_CRITICAL_FROM_ISR();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è®¿é—®ä¸´ç•Œèµ„æº */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¢å¤ä¸­æ–­çŠ¶æ€ */</span></span><br><span class="line">    taskEXIT_CRITICAL_FROM_ISR( uxSavedInterruptStatus );</span><br><span class="line">    <span class="comment">/* ç°åœ¨ï¼Œå½“å‰ISRå¯ä»¥è¢«æ›´é«˜ä¼˜å…ˆçº§çš„ä¸­æ–­æ‰“æ–­äº† */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>taskENTER_CRITICA_FROM_ISR()</code>å’Œ<code>taskEXIT_CRITICAL_FROM_ISR()</code>ä¹‹é—´ï¼š</p>
<ul>
<li>
<p>ä½ä¼˜å…ˆçº§çš„ä¸­æ–­è¢«å±è”½äº†ï¼šä¼˜å…ˆçº§ä½äºã€ç­‰äº<code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code></p>
</li>
<li>
<p>é«˜ä¼˜å…ˆçº§çš„ä¸­æ–­å¯ä»¥äº§ç”Ÿï¼šä¼˜å…ˆçº§é«˜äº<code>configMAX_SYSCALL_INTERRUPT_PRIORITY</code></p>
<ul>
<li>ä½†æ˜¯ï¼Œè¿™äº›ä¸­æ–­ISRé‡Œï¼Œä¸å…è®¸ä½¿ç”¨FreeRTOSçš„APIå‡½æ•°</li>
</ul>
</li>
<li>
<p>ä»»åŠ¡è°ƒåº¦ä¾èµ–äºä¸­æ–­ã€ä¾èµ–äºAPIå‡½æ•°ï¼Œæ‰€ä»¥ï¼šè¿™ä¸¤æ®µä»£ç ä¹‹é—´ï¼Œä¸ä¼šæœ‰ä»»åŠ¡è°ƒåº¦äº§ç”Ÿ</p>
</li>
</ul>
<h2 id="æš‚åœè°ƒåº¦å™¨"><a class="markdownIt-Anchor" href="#æš‚åœè°ƒåº¦å™¨"></a> æš‚åœè°ƒåº¦å™¨</h2>
<p>å¦‚æœ<strong>æœ‰åˆ«çš„ä»»åŠ¡æ¥è·Ÿä½ ç«äº‰ä¸´ç•Œèµ„æº</strong>ï¼Œå¯ä»¥<strong>æŠŠä¸­æ–­å…³æ‰</strong>ï¼šè¿™å½“ç„¶å¯ä»¥ç¦æ­¢åˆ«çš„ä»»åŠ¡è¿è¡Œï¼Œä½†æ˜¯è¿™ä»£ä»·å¤ªå¤§äº†ã€‚å®ƒä¼šå½±å“åˆ°ä¸­æ–­çš„å¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* æš‚åœè°ƒåº¦å™¨ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vTaskSuspendAll</span><span class="params">( <span class="type">void</span> )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¢å¤è°ƒåº¦å™¨</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼: pdTRUEè¡¨ç¤ºåœ¨æš‚å®šæœŸé—´æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å°±ç»ªäº†</span></span><br><span class="line"><span class="comment"> *        å¯ä»¥ä¸ç†ä¼šè¿™ä¸ªè¿”å›å€¼	*/</span></span><br><span class="line">BaseType_t <span class="title function_">xTaskResumeAll</span><span class="params">( <span class="type">void</span> )</span>;</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹æ“ä½œï¼Œä¸‹é¢å¯ä»¥<strong>é€’å½’ä½¿ç”¨</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">vTaskSuspendScheduler();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¿é—®ä¸´ç•Œèµ„æº */</span></span><br><span class="line"></span><br><span class="line">xTaskResumeScheduler();</span><br></pre></td></tr></table></figure>
<h1 id="è°ƒè¯•æ–¹æ³•"><a class="markdownIt-Anchor" href="#è°ƒè¯•æ–¹æ³•"></a> è°ƒè¯•æ–¹æ³•</h1>
<h2 id="è°ƒè¯•"><a class="markdownIt-Anchor" href="#è°ƒè¯•"></a> è°ƒè¯•</h2>
<ul>
<li>æ‰“å°</li>
<li>æ–­è¨€ï¼š<code>configASSERT</code></li>
<li>Trace</li>
<li>Hookå‡½æ•°(å›è°ƒå‡½æ•°)</li>
</ul>
<h3 id="æ‰“å°"><a class="markdownIt-Anchor" href="#æ‰“å°"></a> æ‰“å°</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">fputc</span><span class="params">( <span class="type">int</span> ch, FILE *f )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="æ–­è¨€"><a class="markdownIt-Anchor" href="#æ–­è¨€"></a> æ–­è¨€</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> configASSERT(x)  <span class="keyword">if</span> (!x) while(1);</span></span><br></pre></td></tr></table></figure>
<h3 id="trace"><a class="markdownIt-Anchor" href="#trace"></a> Trace</h3>
<table>
<thead>
<tr>
<th>traceå®</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>traceTASK_INCREMENT_TICK(xTickCount)</td>
<td>å½“tickè®¡æ•°è‡ªå¢ä¹‹å‰æ­¤å®å‡½æ•°è¢«è°ƒç”¨ã€‚å‚æ•°xTickCountå½“å‰çš„Tickå€¼ï¼Œå®ƒè¿˜æ²¡æœ‰å¢åŠ ã€‚</td>
</tr>
<tr>
<td>traceTASK_SWITCHED_OUT()</td>
<td>vTaskSwitchContextä¸­ï¼ŒæŠŠå½“å‰ä»»åŠ¡åˆ‡æ¢å‡ºå»ä¹‹å‰è°ƒç”¨æ­¤å®å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>traceTASK_SWITCHED_IN()</td>
<td>vTaskSwitchContextä¸­ï¼Œæ–°çš„ä»»åŠ¡å·²ç»è¢«åˆ‡æ¢è¿›æ¥äº†ï¼Œå°±è°ƒç”¨æ­¤å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>traceBLOCKING_ON_QUEUE_RECEIVE(pxQueue)</td>
<td>å½“æ­£åœ¨æ‰§è¡Œçš„å½“å‰ä»»åŠ¡å› ä¸ºè¯•å›¾å»è¯»å–ä¸€ä¸ªç©ºçš„é˜Ÿåˆ—ã€ä¿¡å·æˆ–è€…äº’æ–¥é‡è€Œè¿›å…¥é˜»å¡çŠ¶æ€æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«ç«‹å³è°ƒç”¨ã€‚å‚æ•°pxQueueä¿å­˜çš„æ˜¯è¯•å›¾è¯»å–çš„ç›®æ ‡é˜Ÿåˆ—ã€ä¿¡å·æˆ–è€…äº’æ–¥é‡çš„å¥æŸ„ï¼Œä¼ é€’ç»™æ­¤å®å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>traceBLOCKING_ON_QUEUE_SEND(pxQueue)</td>
<td>å½“æ­£åœ¨æ‰§è¡Œçš„å½“å‰ä»»åŠ¡å› ä¸ºè¯•å›¾å¾€ä¸€ä¸ªå·²ç»å†™æ»¡çš„é˜Ÿåˆ—æˆ–è€…ä¿¡å·æˆ–è€…äº’æ–¥é‡è€Œè¿›å…¥äº†é˜»å¡çŠ¶æ€æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«ç«‹å³è°ƒç”¨ã€‚å‚æ•°pxQueueä¿å­˜çš„æ˜¯è¯•å›¾å†™å…¥çš„ç›®æ ‡é˜Ÿåˆ—ã€ä¿¡å·æˆ–è€…äº’æ–¥é‡çš„å¥æŸ„ï¼Œä¼ é€’ç»™æ­¤å®å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>traceQUEUE_SEND(pxQueue)</td>
<td>å½“ä¸€ä¸ªé˜Ÿåˆ—æˆ–è€…ä¿¡å·å‘é€æˆåŠŸæ—¶ï¼Œæ­¤å®å‡½æ•°ä¼šåœ¨å†…æ ¸å‡½æ•°xQueueSend(),xQueueSendToFront(),xQueueSendToBack(),ä»¥åŠæ‰€æœ‰çš„ä¿¡å·giveå‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œå‚æ•°pxQueueæ˜¯è¦å‘é€çš„ç›®æ ‡é˜Ÿåˆ—æˆ–ä¿¡å·çš„å¥æŸ„ï¼Œä¼ é€’ç»™æ­¤å®å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>traceQUEUE_SEND_FAILED(pxQueue)</td>
<td>å½“ä¸€ä¸ªé˜Ÿåˆ—æˆ–è€…ä¿¡å·å‘é€å¤±è´¥æ—¶ï¼Œæ­¤å®å‡½æ•°ä¼šåœ¨å†…æ ¸å‡½æ•°xQueueSend(),xQueueSendToFront(),xQueueSendToBack(),ä»¥åŠæ‰€æœ‰çš„ä¿¡å·giveå‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œå‚æ•°pxQueueæ˜¯è¦å‘é€çš„ç›®æ ‡é˜Ÿåˆ—æˆ–ä¿¡å·çš„å¥æŸ„ï¼Œä¼ é€’ç»™æ­¤å®å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>traceQUEUE_RECEIVE(pxQueue)</td>
<td>å½“è¯»å–ä¸€ä¸ªé˜Ÿåˆ—æˆ–è€…æ¥æ”¶ä¿¡å·æˆåŠŸæ—¶ï¼Œæ­¤å®å‡½æ•°ä¼šåœ¨å†…æ ¸å‡½æ•°xQueueReceive()ä»¥åŠæ‰€æœ‰çš„ä¿¡å·takeå‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œå‚æ•°pxQueueæ˜¯è¦æ¥æ”¶çš„ç›®æ ‡é˜Ÿåˆ—æˆ–ä¿¡å·çš„å¥æŸ„ï¼Œä¼ é€’ç»™æ­¤å®å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>traceQUEUE_RECEIVE_FAILED(pxQueue)</td>
<td>å½“è¯»å–ä¸€ä¸ªé˜Ÿåˆ—æˆ–è€…æ¥æ”¶ä¿¡å·å¤±è´¥æ—¶ï¼Œæ­¤å®å‡½æ•°ä¼šåœ¨å†…æ ¸å‡½æ•°xQueueReceive()ä»¥åŠæ‰€æœ‰çš„ä¿¡å·takeå‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œå‚æ•°pxQueueæ˜¯è¦æ¥æ”¶çš„ç›®æ ‡é˜Ÿåˆ—æˆ–ä¿¡å·çš„å¥æŸ„ï¼Œä¼ é€’ç»™æ­¤å®å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>traceQUEUE_SEND_FROM_ISR(pxQueue)</td>
<td>å½“åœ¨ä¸­æ–­ä¸­å‘é€ä¸€ä¸ªé˜Ÿåˆ—æˆåŠŸæ—¶ï¼Œæ­¤å‡½æ•°ä¼šåœ¨xQueueSendFromISR()ä¸­è¢«è°ƒç”¨ã€‚å‚æ•°pxQueueæ˜¯è¦å‘é€çš„ç›®æ ‡é˜Ÿåˆ—çš„å¥æŸ„ã€‚</td>
</tr>
<tr>
<td>traceQUEUE_SEND_FROM_ISR_FAILED(pxQueue)</td>
<td>å½“åœ¨ä¸­æ–­ä¸­å‘é€ä¸€ä¸ªé˜Ÿåˆ—å¤±è´¥æ—¶ï¼Œæ­¤å‡½æ•°ä¼šåœ¨xQueueSendFromISR()ä¸­è¢«è°ƒç”¨ã€‚å‚æ•°pxQueueæ˜¯è¦å‘é€çš„ç›®æ ‡é˜Ÿåˆ—çš„å¥æŸ„ã€‚</td>
</tr>
<tr>
<td>traceQUEUE_RECEIVE_FROM_ISR(pxQueue)</td>
<td>å½“åœ¨ä¸­æ–­ä¸­è¯»å–ä¸€ä¸ªé˜Ÿåˆ—æˆåŠŸæ—¶ï¼Œæ­¤å‡½æ•°ä¼šåœ¨xQueueReceiveFromISR()ä¸­è¢«è°ƒç”¨ã€‚å‚æ•°pxQueueæ˜¯è¦å‘é€çš„ç›®æ ‡é˜Ÿåˆ—çš„å¥æŸ„ã€‚</td>
</tr>
<tr>
<td>traceQUEUE_RECEIVE_FROM_ISR_FAILED(pxQueue)</td>
<td>å½“åœ¨ä¸­æ–­ä¸­è¯»å–ä¸€ä¸ªé˜Ÿåˆ—å¤±è´¥æ—¶ï¼Œæ­¤å‡½æ•°ä¼šåœ¨xQueueReceiveFromISR()ä¸­è¢«è°ƒç”¨ã€‚å‚æ•°pxQueueæ˜¯è¦å‘é€çš„ç›®æ ‡é˜Ÿåˆ—çš„å¥æŸ„ã€‚</td>
</tr>
<tr>
<td>traceTASK_DELAY_UNTIL()</td>
<td>å½“ä¸€ä¸ªä»»åŠ¡å› ä¸ºè°ƒç”¨äº†vTaskDelayUntil()è¿›å…¥äº†é˜»å¡çŠ¶æ€çš„å‰ä¸€åˆ»æ­¤å®å‡½æ•°ä¼šåœ¨vTaskDelayUntil()ä¸­è¢«ç«‹å³è°ƒç”¨ã€‚</td>
</tr>
<tr>
<td>traceTASK_DELAY()</td>
<td>å½“ä¸€ä¸ªä»»åŠ¡å› ä¸ºè°ƒç”¨äº†vTaskDelay()è¿›å…¥äº†é˜»å¡çŠ¶æ€çš„å‰ä¸€åˆ»æ­¤å®å‡½æ•°ä¼šåœ¨vTaskDelayä¸­è¢«ç«‹å³è°ƒç”¨ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="malloc-hookå‡½æ•°"><a class="markdownIt-Anchor" href="#malloc-hookå‡½æ•°"></a> Malloc Hookå‡½æ•°</h3>
<p>ç¼–ç¨‹æ—¶ï¼Œä¸€èˆ¬çš„é€»è¾‘é”™è¯¯éƒ½å®¹æ˜“è§£å†³ã€‚éš¾ä»¥å¤„ç†çš„æ˜¯å†…å­˜è¶Šç•Œã€æ ˆæº¢å‡ºç­‰ã€‚</p>
<p>å†…å­˜è¶Šç•Œç»å¸¸å‘ç”Ÿåœ¨å †çš„ä½¿ç”¨è¿‡ç¨‹æ€»ï¼šå †ï¼Œå°±æ˜¯ä½¿ç”¨mallocå¾—åˆ°çš„å†…å­˜ã€‚</p>
<p>å¹¶æ²¡æœ‰å¾ˆå¥½çš„æ–¹æ³•æ£€æµ‹å†…å­˜è¶Šç•Œï¼Œä½†æ˜¯å¯ä»¥æä¾›ä¸€äº›å›è°ƒå‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vApplicationMallocFailedHook</span><span class="params">( <span class="type">void</span> )</span>;</span><br></pre></td></tr></table></figure>
<h3 id="æ ˆæº¢å‡ºhookå‡½æ•°"><a class="markdownIt-Anchor" href="#æ ˆæº¢å‡ºhookå‡½æ•°"></a> æ ˆæº¢å‡ºHookå‡½æ•°</h3>
<p>åœ¨åˆ‡æ¢ä»»åŠ¡(vTaskSwitchContext)æ—¶è°ƒç”¨taskCHECK_FOR_STACK_OVERFLOWæ¥æ£€æµ‹æ ˆæ˜¯å¦æº¢å‡ºï¼Œå¦‚æœæº¢å‡ºä¼šè°ƒç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vApplicationStackOverflowHook</span><span class="params">( TaskHandle_t xTask, <span class="type">char</span> * pcTaskName )</span>;</span><br></pre></td></tr></table></figure>
<p>æ€ä¹ˆåˆ¤æ–­æ ˆæº¢å‡ºï¼Ÿ</p>
<p>æ–¹æ³•1ï¼š</p>
<ul>
<li>å½“å‰ä»»åŠ¡è¢«åˆ‡æ¢å‡ºå»ä¹‹å‰ï¼Œå®ƒçš„æ•´ä¸ªè¿è¡Œç°åœºéƒ½è¢«ä¿å­˜åœ¨æ ˆé‡Œï¼Œè¿™æ—¶<strong>å¾ˆå¯èƒ½</strong>å°±æ˜¯å®ƒå¯¹æ ˆçš„ä½¿ç”¨åˆ°è¾¾äº†å³°å€¼ã€‚</li>
<li>è¿™æ–¹æ³•å¾ˆé«˜æ•ˆï¼Œä½†æ˜¯å¹¶ä¸ç²¾ç¡®</li>
<li>æ¯”å¦‚ï¼šä»»åŠ¡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨äº†å‡½æ•°Aå¤§é‡åœ°ä½¿ç”¨äº†æ ˆï¼Œè°ƒç”¨å®Œå‡½æ•°Aåæ‰è¢«è°ƒåº¦ã€‚</li>
</ul>
<p><img src="https://s2.loli.net/2025/05/08/3qzi8OMJFeAfYh2.png" alt="" /></p>
<p>æ–¹æ³•2ï¼š</p>
<ul>
<li>åˆ›å»ºä»»åŠ¡æ—¶ï¼Œå®ƒçš„æ ˆè¢«å¡«å…¥å›ºå®šçš„å€¼ï¼Œæ¯”å¦‚ï¼š0xa5</li>
<li>æ£€æµ‹æ ˆé‡Œæœ€å16å­—èŠ‚çš„æ•°æ®ï¼Œå¦‚æœä¸æ˜¯0xa5çš„è¯è¡¨ç¤ºæ ˆå³å°†ã€æˆ–è€…å·²ç»è¢«ç”¨å®Œäº†</li>
<li>æ²¡æœ‰æ–¹æ³•1å¿«é€Ÿï¼Œä½†æ˜¯ä¹Ÿè¶³å¤Ÿå¿«</li>
<li>èƒ½æ•è·<strong>å‡ ä¹æ‰€æœ‰</strong>çš„æ ˆæº¢å‡º</li>
<li>ä¸ºä»€ä¹ˆæ˜¯å‡ ä¹æ‰€æœ‰ï¼Ÿå¯èƒ½æœ‰äº›å‡½æ•°ä½¿ç”¨æ ˆæ—¶ï¼Œéå¸¸å‡‘å·§åœ°æŠŠæ ˆè®¾ç½®ä¸º0xa5ï¼šå‡ ä¹ä¸å¯èƒ½</li>
</ul>
<p><img src="https://s2.loli.net/2025/05/08/FaGJVURZPSEdCnq.png" alt="" /></p>
<h2 id="ä¼˜åŒ–"><a class="markdownIt-Anchor" href="#ä¼˜åŒ–"></a> ä¼˜åŒ–</h2>
<h3 id="æ ˆä½¿ç”¨æƒ…å†µ"><a class="markdownIt-Anchor" href="#æ ˆä½¿ç”¨æƒ…å†µ"></a> æ ˆä½¿ç”¨æƒ…å†µ</h3>
<p>åœ¨åˆ›å»ºä»»åŠ¡æ—¶åˆ†é…äº†æ ˆï¼Œå¯ä»¥å¡«å…¥å›ºå®šçš„æ•°å€¼æ¯”å¦‚0xa5ï¼Œä»¥åå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°æŸ¥çœ‹&quot;æ ˆçš„é«˜æ°´ä½&quot;ï¼Œä¹Ÿå°±æ˜¯è¿˜æœ‰å¤šå°‘ç©ºä½™çš„æ ˆç©ºé—´ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">UBaseType_t <span class="title function_">uxTaskGetStackHighWaterMark</span><span class="params">( TaskHandle_t xTask )</span>;</span><br></pre></td></tr></table></figure>
<p><strong>åŸç†</strong>ï¼šä»æ ˆåº•å¾€æ ˆé¡¶é€ä¸ªå­—èŠ‚åœ°åˆ¤æ–­ï¼Œå®ƒä»¬çš„å€¼æŒç»­æ˜¯0xa5å°±è¡¨ç¤ºå®ƒæ˜¯ç©ºé—²çš„ã€‚</p>
<h3 id="ä½¿ç”¨è¿è¡Œæ—¶é—´ç»Ÿè®¡"><a class="markdownIt-Anchor" href="#ä½¿ç”¨è¿è¡Œæ—¶é—´ç»Ÿè®¡"></a> ä½¿ç”¨è¿è¡Œæ—¶é—´ç»Ÿè®¡</h3>
<h3 id="æ¶‰åŠçš„å®å®šä¹‰å¤´"><a class="markdownIt-Anchor" href="#æ¶‰åŠçš„å®å®šä¹‰å¤´"></a> æ¶‰åŠçš„å®å®šä¹‰å¤´</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> configGENERATE_RUN_TIME_STATS 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TRACE_FACILITY    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_STATS_FORMATTING_FUNCTIONS  1</span></span><br></pre></td></tr></table></figure>
<h3 id="å‡½æ•°è¯´æ˜"><a class="markdownIt-Anchor" href="#å‡½æ•°è¯´æ˜"></a> å‡½æ•°è¯´æ˜</h3>
<ul>
<li>uxTaskGetSystemStateï¼šè·å¾—ä»»åŠ¡çš„ç»Ÿè®¡ä¿¡æ¯</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">UBaseType_t <span class="title function_">uxTaskGetSystemState</span><span class="params">( TaskStatus_t * <span class="type">const</span> pxTaskStatusArray,</span></span><br><span class="line"><span class="params">                                        <span class="type">const</span> UBaseType_t uxArraySize,</span></span><br><span class="line"><span class="params">                                        <span class="type">uint32_t</span> * <span class="type">const</span> pulTotalRunTime )</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">å‚æ•°</th>
<th style="text-align:center">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">pxTaskStatusArray</td>
<td style="text-align:center">æŒ‡å‘ä¸€ä¸ªTaskStatus_tç»“æ„ä½“æ•°ç»„ï¼Œç”¨æ¥ä¿å­˜ä»»åŠ¡çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ æœ‰å¤šå°‘ä¸ªä»»åŠ¡ï¼Ÿå¯ä»¥ç”¨<code>uxTaskGetNumberOfTasks()</code>æ¥è·å¾—ã€‚</td>
</tr>
<tr>
<td style="text-align:center">uxArraySize</td>
<td style="text-align:center">æ•°ç»„å¤§å°ã€æ•°ç»„é¡¹ä¸ªæ•°ï¼Œå¿…é¡»å¤§äºæˆ–ç­‰äº<code>uxTaskGetNumberOfTasks()</code></td>
</tr>
<tr>
<td style="text-align:center">pulTotalRunTime</td>
<td style="text-align:center">ç”¨æ¥ä¿å­˜å½“å‰æ€»çš„è¿è¡Œæ—¶é—´(æ›´å¿«çš„å®šæ—¶å™¨)ï¼Œå¯ä»¥ä¼ å…¥NULL</td>
</tr>
<tr>
<td style="text-align:center">è¿”å›å€¼</td>
<td style="text-align:center">ä¼ å…¥çš„pxTaskStatusArrayæ•°ç»„ï¼Œè¢«è®¾ç½®äº†å‡ ä¸ªæ•°ç»„é¡¹ã€‚ æ³¨æ„ï¼šå¦‚æœä¼ å…¥çš„uxArraySizeå°äº<code>uxTaskGetNumberOfTasks()</code>ï¼Œè¿”å›å€¼å°±æ˜¯0</td>
</tr>
</tbody>
</table>
<ul>
<li>vTaskList ï¼šè·å¾—ä»»åŠ¡çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå½¢å¼ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ã€‚æ³¨æ„ï¼ŒpcWriteBufferå¿…é¡»è¶³å¤Ÿå¤§ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vTaskList</span><span class="params">( <span class="type">signed</span> <span class="type">char</span> *pcWriteBuffer )</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2025/05/08/irBOM9YKgcWPveJ.png" alt="" /></p>
<ul>
<li>vTaskGetRunTimeStatsï¼šè·å¾—ä»»åŠ¡çš„è¿è¡Œä¿¡æ¯ï¼Œå½¢å¼ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ã€‚æ³¨æ„ï¼ŒpcWriteBufferå¿…é¡»è¶³å¤Ÿå¤§ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vTaskGetRunTimeStats</span><span class="params">( <span class="type">signed</span> <span class="type">char</span> *pcWriteBuffer )</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2025/05/08/tTabdjAKB98SeWY.png" alt="" /></p>
<p><strong>è‡³æ­¤ï¼Œå®Œç»“</strong>ï¼</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<p><a href="https://rtos.100ask.net/zh/FreeRTOS/simulator/chapter1.html#_1-1-freertos%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">ç¬¬ä¸€ç«  FreeRTOSæ¦‚è¿°ä¸ä½“éªŒ | ç™¾é—®ç½‘</a></p>
<p><a href="https://rtos.100ask.net/zh/FreeRTOS/DShanMCU-F103/">ç™¾é—®ç½‘ã€ŠFreeRTOSå…¥é—¨ä¸å·¥ç¨‹å®è·µ-åŸºäºSTM32F103ã€‹æ•™ç¨‹-åŸºäºDShanMCU-103(STM32F103) | ç™¾é—®ç½‘</a></p>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>STM32</tag>
      </tags>
  </entry>
  <entry>
    <title>STM32å­¦ä¹ ç¬”è®°</title>
    <url>/2024/06/12/STM32%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>ä¸»è¦å­¦ä¹ STM32C8T6çš„åŸºæœ¬é…ç½®ä»¥åŠå„éƒ¨ä»¶æ“ä½œã€‚</p>
<p><strong>Qï¼šå“ˆå¸Œä½“ç³»å’Œå†¯æ´›ä¼Šæ›¼ä½“ç³»åŒºåˆ«</strong>ï¼šå‰è€…æ˜¯æŒ‡ä»¤é›†å’Œæ•°æ®å­˜å‚¨åœ¨<strong>ä¸åŒå­˜å‚¨å™¨</strong>ï¼Œåè€…æ˜¯å°†ä¸¤è€…å­˜å‚¨<strong>åœ¨åŒä¸€ä¸ªå­˜å‚¨å™¨</strong></p>
<p><strong>è®¡ç®—æœºäº”å¤§ç»„æˆéƒ¨åˆ†</strong>ï¼šæ§åˆ¶å™¨ã€è¿ç®—å™¨ã€å­˜å‚¨å™¨ã€è¾“å…¥è®¾å¤‡ã€è¾“å‡ºè®¾å¤‡</p>
<p><strong>32ä½</strong>å¤„ç†å™¨ï¼Œä¸€ä¸ªæŒ‡é’ˆ<strong>4å­—èŠ‚</strong>ï¼›<strong>64ä½</strong>å¤„ç†å™¨ï¼Œä¸€ä¸ªæŒ‡é’ˆ<strong>8å­—èŠ‚</strong></p>
<h2 id="stm32f103c8t6åŸºæœ¬é…ç½®"><a class="markdownIt-Anchor" href="#stm32f103c8t6åŸºæœ¬é…ç½®"></a> STM32F103C8T6åŸºæœ¬é…ç½®</h2>
<p><strong>STM32æ˜¯å°ç«¯å­˜å‚¨ï¼Œä½åœ°å€çš„æ•°æ®æ”¾åœ¨ä½å­—èŠ‚ä¸Š</strong></p>
<p><strong>å †ä»ä½åœ°å€å‘ä¸Šå¢é•¿ï¼Œæ ˆä»é«˜åœ°å€å‘ä¸‹å¢é•¿</strong></p>
<h3 id="å†…å®¹"><a class="markdownIt-Anchor" href="#å†…å®¹"></a> å†…å®¹</h3>
<p><strong>STM32F103C8T6æœ€å°ç³»ç»Ÿç‰ˆç»„æˆ</strong>ï¼šMCUã€æ—¶é’Ÿç”µè·¯ã€å¤ä½ç”µè·¯ã€å¤–éƒ¨æ¥å£ç”µè·¯ã€ç”µæºç”µè·¯ï¼Œå¯åŠ¨ç”µè·¯ã€‚</p>
<ul>
<li>
<p>å†…æ ¸ï¼š<strong>Cortex-M3</strong>ï¼Œ<strong>32ä½</strong>å¤„ç†å™¨å†…æ ¸ï¼Œæœ€å¤§å¯»å€ä½<strong>2^32=4GB</strong>å­—èŠ‚ï¼›</p>
</li>
<li>
<p><strong>Flashï¼š64Kå­—èŠ‚ï¼›</strong></p>
</li>
<li>
<p><strong>SRAMï¼š20Kå­—èŠ‚ï¼›</strong></p>
</li>
</ul>
<p>2ä¸ªADCã€4ä¸ªå®šæ—¶å™¨ã€2ä¸ªIICã€2ä¸ªSPIã€3ä¸ªUSARTã€1ä¸ªCAN</p>
<h3 id="qcotex-m3å¯„å­˜å™¨ç»„çš„ç”¨æ³•"><a class="markdownIt-Anchor" href="#qcotex-m3å¯„å­˜å™¨ç»„çš„ç”¨æ³•"></a> Qï¼šCotex-M3å¯„å­˜å™¨ç»„çš„ç”¨æ³•</h3>
<p><strong>R0~R12ä¸ºé€šç”¨å¯„å­˜å™¨ï¼›R13æ˜¯ä¸»å †æ ˆæŒ‡é’ˆï¼ˆMSPï¼‰å’Œè¿›ç¨‹å †æ ˆï¼ˆPSPï¼‰ï¼›R14æ˜¯è¿æ¥å¯„å­˜å™¨ï¼ˆLRï¼‰ï¼ŒR15æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰</strong></p>
<ul>
<li><strong>R0â€”R3</strong>ç”¨äº<strong>ä¼ å‚å’Œè¡¨è¾¾å¼è®¡ç®—</strong>ï¼›</li>
<li><strong>R4â€”R11</strong>ç”¨äº<strong>ä¿å­˜å±€éƒ¨å˜é‡</strong>ï¼›</li>
<li>R12æ˜¯ä¸´æ—¶å¯„å­˜å™¨ï¼›</li>
<li><strong>R13æ˜¯å †æ ˆæŒ‡é’ˆï¼Œåˆ«åï¼šSP</strong>ï¼›
<ul>
<li>MSPï¼ˆMain Stack Pointerï¼‰:ä¸»æ¨¡å¼ä¸‹ä½¿ç”¨</li>
<li>PSPï¼ˆProcess Stack Pointerï¼‰ï¼šæ“ä½œç³»ç»Ÿ/çº¿ç¨‹åˆ‡æ¢ä½¿ç”¨</li>
</ul>
</li>
<li><strong>R14æ˜¯é“¾æ¥å¯„å­˜å™¨ï¼Œç”¨äºä¿å­˜å‡½æ•°è¿”å›åœ°å€ï¼Œåˆ«åï¼šLR</strong>ï¼›</li>
<li><strong>R15æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼Œç”¨äºè·³è½¬åˆ°ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„å‘½ä»¤ï¼Œåˆ«åï¼šPC</strong>ï¼›</li>
</ul>
<h3 id="qstm32f1ä¸f4çš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#qstm32f1ä¸f4çš„åŒºåˆ«"></a> Qï¼šSTM32F1ä¸F4çš„åŒºåˆ«ï¼Ÿ</h3>
<ul>
<li>
<p><strong>å†…æ ¸</strong> ï¼šF1æ˜¯M3ï¼ŒF4æ˜¯M4</p>
</li>
<li>
<p><strong>ä¸»é¢‘</strong>ï¼šF1æœ€å¤§ä¸»é¢‘æ˜¯72MHzï¼ŒF4æœ€å¤§ä¸»é¢‘æ˜¯168MHz</p>
</li>
<li>
<p><strong>æµ®ç‚¹</strong>ï¼šF1æ— æµ®ç‚¹è®¡ç®—ï¼ŒF4æœ‰</p>
</li>
<li>
<p><strong>åŠŸèƒ½</strong>ï¼šF4å¤–è®¾æ¯”F1åŠŸèƒ½æ›´å¼ºå¤§</p>
</li>
</ul>
<h2 id="stm32çš„äº”ä¸ªæ—¶é’Ÿæº"><a class="markdownIt-Anchor" href="#stm32çš„äº”ä¸ªæ—¶é’Ÿæº"></a> STM32çš„äº”ä¸ªæ—¶é’Ÿæº</h2>
<ul>
<li>
<p>HSIæ˜¯é«˜é€Ÿå†…éƒ¨æ—¶é’Ÿï¼ŒRCæŒ¯è¡å™¨ï¼Œé¢‘ç‡8MHzï¼Œç²¾åº¦ä¸é«˜</p>
</li>
<li>
<p><strong>HSEæ˜¯é«˜é€Ÿå¤–éƒ¨æ—¶é’Ÿ</strong>ï¼Œå¯æ¥çŸ³è‹±/é™¶ç“·è°æŒ¯å™¨ï¼Œé¢‘ç‡4~16MHzï¼Œ<strong>å¸¸ç”¨ä½œä¸»ç³»ç»Ÿæ—¶é’Ÿæº</strong></p>
</li>
<li>
<p>LSIæ˜¯ä½é€Ÿå†…éƒ¨æ—¶é’Ÿï¼ŒRCæŒ¯è¡å™¨ï¼Œé¢‘ç‡40KHzï¼Œé€šè¿‡ä½åŠŸè€—æ—¶é’Ÿ</p>
</li>
<li>
<p>LSEæ˜¯ä½é€Ÿå¤–éƒ¨æ—¶é’Ÿï¼ŒçŸ³è‹±æ™¶ä½“ï¼Œé¢‘ç‡32.768KHz</p>
</li>
<li>
<p><strong>PLLæ˜¯é”ç›¸ç¯å€é¢‘è¾“å‡ºï¼Œæ—¶é’Ÿæºå¯ä»¥ä¸ºHSI / 2ã€HSEæˆ–HSE / 2ï¼Œå€é¢‘èŒƒå›´æ˜¯2~16å€ï¼Œæœ€å¤§72MHz</strong></p>
</li>
</ul>
<p><strong>æ—¶é’Ÿæ ‘</strong>ï¼šç³»ç»Ÿæ—¶é’Ÿ SYSCLK â†’ AHBï¼ˆHCLKï¼‰â†’ APB1/PCLK1ã€APB2/PCLK2</p>
<h3 id="qè®¾ç½®ç³»ç»Ÿæ—¶é’Ÿçš„åŸºæœ¬æµç¨‹"><a class="markdownIt-Anchor" href="#qè®¾ç½®ç³»ç»Ÿæ—¶é’Ÿçš„åŸºæœ¬æµç¨‹"></a> Qï¼šè®¾ç½®ç³»ç»Ÿæ—¶é’Ÿçš„åŸºæœ¬æµç¨‹ï¼Ÿ</h3>
<ol>
<li>å¼€å¯å¤–éƒ¨é«˜é€Ÿæ—¶é’ŸHSE</li>
<li>è®¾ç½®Flashçš„ç­‰å¾…å‘¨æœŸ</li>
<li>è®¾ç½®APB1ã€APB2ã€AHBåˆ†é¢‘ç³»æ•°ï¼ˆRCC_CFGRå¯„å­˜å™¨ï¼‰</li>
<li>è®¾ç½®PLLçš„æ—¶é’Ÿæ¥æºå’Œå€é¢‘ç³»æ•°</li>
<li>ä½¿èƒ½PLL</li>
<li>å°†ç³»ç»Ÿæ—¶é’Ÿåˆ‡æ¢åˆ°PLL</li>
</ol>
<h2 id="stm32å¯åŠ¨è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#stm32å¯åŠ¨è¿‡ç¨‹"></a> STM32å¯åŠ¨è¿‡ç¨‹</h2>
<ol>
<li>
<p><strong>é€šè¿‡Bootå¼•è„šå†³å®šå¯åŠ¨æ–¹å¼</strong>ï¼ˆFlashã€ç³»ç»Ÿå†…å­˜ã€SRAMï¼‰</p>
</li>
<li>
<p><strong>åŠ è½½ä¸­æ–­å‘é‡è¡¨</strong>ï¼ˆä»èµ·å§‹åœ°å€è¯»å–ï¼Œæ¯”å¦‚0x0800 0000ï¼‰</p>
</li>
<li>
<p><strong>åˆå§‹åŒ–æ ˆæŒ‡é’ˆ</strong>ï¼ˆåŠ è½½__initial_spï¼Œè¿™æ˜¯å‘é‡è¡¨çš„ç¬¬0é¡¹ï¼Œ0x0800 0000ï¼‰</p>
</li>
<li>
<p><strong>æŒ‡å‘å¤ä½ç¨‹åº</strong>ï¼ˆæ‰§è¡ŒReset_Handlerï¼Œè¿™æ˜¯å‘é‡è¡¨çš„ç¬¬1é¡¹ï¼Œ0x0800 0004ï¼‰</p>
</li>
<li>
<p>åœ¨Reset_Handlerä¸­</p>
<ul>
<li>å¤åˆ¶æ•°æ®æ®µï¼ˆdataï¼‰åˆ°RAM</li>
<li>æ¸…ç©ºBSSæ®µ</li>
<li>è°ƒç”¨SystemInitè®¾ç½®ç³»ç»Ÿæ—¶é’Ÿ</li>
<li>è°ƒç”¨ __main ----&gt; main()</li>
</ul>
</li>
<li>
<p><strong>è®¾ç½®å¼‚å¸¸ä¸­æ–­</strong> 	HardFault_Handler</p>
</li>
</ol>
<h2 id="gpio"><a class="markdownIt-Anchor" href="#gpio"></a> GPIO</h2>
<ul>
<li>
<p><strong>å››ç§è¾“å…¥</strong>ï¼šä¸Šæ‹‰è¾“å…¥ã€ä¸‹æ‹‰è¾“å…¥ã€æµ®ç©ºè¾“å…¥ã€æ¨¡æ‹Ÿè¾“å…¥</p>
</li>
<li>
<p><strong>å››ç§è¾“å‡º</strong>ï¼šé€šç”¨æ¨æŒ½ã€å¤ç”¨æ¨æŒ½ã€é€šç”¨å¼€æ¼ã€å¤ç”¨å¼€æ¼</p>
</li>
</ul>
<p><strong>APB1æ€»çº¿æ§åˆ¶DACã€USBã€I2Cã€SPIã€CANã€ä¸²å£2345ã€æ™®é€šTIM</strong></p>
<p><strong>APB2æ€»çº¿æ§åˆ¶ADCã€USART1ã€GPIOã€TIM1ï¼ˆé«˜çº§å®šæ—¶å™¨ï¼‰ã€AFIOï¼ˆå¤ç”¨åŠŸèƒ½ï¼‰</strong></p>
<h3 id="qå¼€æ¼ä¸æ¨æŒ½çš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#qå¼€æ¼ä¸æ¨æŒ½çš„åŒºåˆ«"></a> Qï¼šå¼€æ¼ä¸æ¨æŒ½çš„åŒºåˆ«ï¼Ÿ</h3>
<p>æ¨æŒ½å¯ä»¥æ­£å¸¸è¾“å‡ºé«˜ä½ç”µå¹³ï¼Œ<strong>å¼€æ¼</strong>åªèƒ½è¾“å‡ºä½ç”µå¹³ï¼Œ<strong>é«˜ç”µå¹³å‘ˆç°é«˜é˜»æ€</strong>ï¼Œå¹¶ä¸”éœ€è¦ä¸Šæ‹‰ç”µé˜»ã€‚</p>
<h3 id="qé€šç”¨å’Œå¤ç”¨çš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#qé€šç”¨å’Œå¤ç”¨çš„åŒºåˆ«"></a> Qï¼šé€šç”¨å’Œå¤ç”¨çš„åŒºåˆ«ï¼Ÿ</h3>
<p><strong>é€šç”¨</strong>æ˜¯å•çº¯åš<strong>è¾“å…¥æˆ–è¾“å‡º</strong>ï¼Œ<strong>å¤ç”¨</strong>æ˜¯ç”¨ä½œ<strong>å¤–è®¾åŠŸèƒ½å¼•è„š</strong></p>
<h2 id="èœ‚é¸£å™¨"><a class="markdownIt-Anchor" href="#èœ‚é¸£å™¨"></a> èœ‚é¸£å™¨</h2>
<h3 id="å†…å®¹-2"><a class="markdownIt-Anchor" href="#å†…å®¹-2"></a> å†…å®¹</h3>
<p><strong>æœ‰æº</strong>èœ‚é¸£å™¨ï¼šå†…éƒ¨<strong>è‡ªå¸¦æŒ¯è¡ç”µè·¯</strong>ï¼Œå°†æ­£è´Ÿææ¥ä¸Šç›´æµç”µå‹å³å¯å‘å£°ï¼Œ<strong>é¢‘ç‡å›ºå®š</strong>ã€‚</p>
<p><strong>æ— æº</strong>èœ‚é¸£å™¨ï¼šå†…éƒ¨<strong>ä¸å¸¦</strong>æŒ¯è¡ç”µè·¯ï¼Œéœ€è¦æ§åˆ¶å™¨æä¾›æŒ¯è¡è„‰å†²å‘ç”Ÿï¼Œ<strong>é¢‘ç‡ä¸å›ºå®š</strong>ã€‚</p>
<h2 id="ä¸­æ–­"><a class="markdownIt-Anchor" href="#ä¸­æ–­"></a> ä¸­æ–­</h2>
<h3 id="å†…å®¹-3"><a class="markdownIt-Anchor" href="#å†…å®¹-3"></a> å†…å®¹</h3>
<p><strong>EXIT</strong>(Extern Interrupt)ï¼šå¤–éƒ¨ä¸­æ–­æ§åˆ¶å™¨ï¼Œ<strong>ç›‘å¬GPIOå¼•è„šçš„ç”µå¹³å˜åŒ–</strong></p>
<p><strong>NVIC</strong>(Nested Vector Interrupt Control)ï¼šåµŒå¥—å‘é‡ä¸­æ–­æ§åˆ¶å™¨ï¼Œ<strong>è´Ÿè´£ä¸­æ–­å“åº”ï¼Œä¼˜å…ˆçº§ç®¡ç†</strong></p>
<p><strong>æœ¬è´¨</strong>ï¼šç¨‹åºè¿è¡Œæ—¶ï¼ŒEXITç›‘å¬æŒ‡å®šGPIOç”µå¹³ï¼Œä¸€æ—¦å‘ç”Ÿæ”¹å˜ï¼ŒCPUä¼šæš‚åœå½“å‰ä»»åŠ¡å¹¶ä¿å­˜ç°åœºï¼Œå‘NVICå‘å‡ºä¸­æ–­è¯·æ±‚ï¼Œå»å¤„ç†ä¸­æ–­ç¨‹åºï¼›å½“ä¸­æ–­ç¨‹åºå¤„ç†å®Œæˆåï¼Œè‡ªè¡Œæ¢å¤ç°åœºï¼Œç»§ç»­æ‰§è¡Œã€‚</p>
<p>GPIO â€”&gt; EXTIæ˜ å°„ä½¿ç”¨AFIO</p>
<p>è§¦å‘æ–¹å¼ï¼šä¸Šå‡æ²¿/ä¸‹é™æ²¿/åŒè¾¹æ²¿</p>
<h3 id="qstm32æ”¯æŒå¤šå°‘ä¸ªå¤–éƒ¨ä¸­æ–­"><a class="markdownIt-Anchor" href="#qstm32æ”¯æŒå¤šå°‘ä¸ªå¤–éƒ¨ä¸­æ–­"></a> Qï¼šSTM32æ”¯æŒå¤šå°‘ä¸ªå¤–éƒ¨ä¸­æ–­ï¼Ÿ</h3>
<p>19ä¸ªå¤–éƒ¨ä¸­æ–­ï¼Œä½†åªæœ‰7ä¸ªä¸­æ–­æœåŠ¡å‡½æ•°ã€‚</p>
<h3 id="qä¸­æ–­å’Œå¼‚å¸¸"><a class="markdownIt-Anchor" href="#qä¸­æ–­å’Œå¼‚å¸¸"></a> Qï¼šä¸­æ–­å’Œå¼‚å¸¸ï¼Ÿ</h3>
<p>ä¸­æ–­é€šå¸¸ç”±å¤–éƒ¨ç¡¬ä»¶è®¾å¤‡äº§ç”Ÿï¼Œå¦‚IOä¸­æ–­ï¼Œæ—¶é’Ÿä¸­æ–­ç­‰ï¼›å¼‚å¸¸é€šå¸¸ç”±CPUå†…éƒ¨äº§ç”Ÿï¼Œå¦‚æ•°ç»„è¶Šç•Œï¼Œé™¤é›¶æ“ä½œç­‰ã€‚</p>
<p>TIPï¼š<strong>ä¸­æ–­çš„ä¼˜å…ˆçº§æ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</strong>ï¼Œæ¯”å¦‚æŠ¢å ä¼˜å…ˆçº§å’Œå“åº”ä¼˜å…ˆçº§ã€‚</p>
<h2 id="timer"><a class="markdownIt-Anchor" href="#timer"></a> TIMER</h2>
<p><strong>16ä½è®¡æ•°å™¨ã€é¢„åˆ†é¢‘å™¨ã€è‡ªåŠ¨é‡è£…å¯„å­˜å™¨çš„æ—¶åŸºå•å…ƒ</strong>ï¼Œåœ¨72MHzæ—¶é’Ÿå¯ä»¥å®ç°æœ€å¤§59.65sçš„å®šæ—¶ã€‚</p>
<ul>
<li>
<p><strong>åŸºç¡€</strong>å®šæ—¶å™¨ï¼š<strong>ä»…æ”¯æŒè®¡æ•°</strong></p>
</li>
<li>
<p><strong>é€šç”¨/é«˜çº§</strong>å®šæ—¶å™¨ï¼š<strong>æ”¯æŒå‘ä¸Šè®¡æ•°ã€å‘ä¸‹è®¡æ•°ã€ä¸­å¤®å¯¹é½</strong></p>
</li>
</ul>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>å®šæ—¶å™¨è®¡æ•°é¢‘ç‡ï¼š</mtext><mi>C</mi><mi>K</mi><mi mathvariant="normal">_</mi><mi>C</mi><mi>N</mi><mi>T</mi><mo>=</mo><mfrac><mrow><mi>C</mi><mi>L</mi><mi>C</mi><mi>K</mi></mrow><mrow><mi>P</mi><mi>S</mi><mi>C</mi><mo>+</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">
å®šæ—¶å™¨è®¡æ•°é¢‘ç‡ï¼šCK\_CNT = \frac{CLCK}{PSC + 1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9933em;vertical-align:-0.31em;"></span><span class="mord cjk_fallback">å®šæ—¶å™¨è®¡æ•°é¢‘ç‡ï¼š</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.13889em;">CNT</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1297em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">PSC</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>CLCKæ˜¯å®šæ—¶å™¨è¾“å…¥æ—¶é’Ÿï¼ˆä¸€èˆ¬æ˜¯APBæ—¶é’Ÿï¼‰ï¼ŒPSCæ˜¯é¢„åˆ†é¢‘å™¨æ•°å€¼ã€‚</p>
<p><img src="https://s2.loli.net/2025/05/07/EjZKNokdDmv8YpH.png" alt="" /></p>
<h3 id="qå¦‚ä½•è®¾ç½®ä¸€ä¸ª20mså®šæ—¶å™¨"><a class="markdownIt-Anchor" href="#qå¦‚ä½•è®¾ç½®ä¸€ä¸ª20mså®šæ—¶å™¨"></a> Qï¼šå¦‚ä½•è®¾ç½®ä¸€ä¸ª20mså®šæ—¶å™¨ï¼Ÿ</h3>
<p>ç»™å®šHCLK = 72MHzï¼Œé€‰æ‹©é¢„åˆ†é¢‘ç³»æ•°PSC = 7199ï¼Œè®¡ç®—CK_CNT = 10KHz = 0.1msï¼Œåªéœ€è¦è®¡æ•°200æ¬¡å³å¯ã€‚</p>
<h3 id="qå¦‚ä½•å¼€å¯å®šæ—¶å™¨"><a class="markdownIt-Anchor" href="#qå¦‚ä½•å¼€å¯å®šæ—¶å™¨"></a> Qï¼šå¦‚ä½•å¼€å¯å®šæ—¶å™¨ï¼Ÿ</h3>
<ol>
<li>å¼€å¯RCCæ—¶é’Ÿ</li>
<li>é…ç½®æ—¶åŸºå•å…ƒçš„æ—¶é’Ÿæº</li>
<li>é…ç½®é¢„åˆ†é¢‘ç³»æ•°å’Œè‡ªåŠ¨é‡è£…è½½å€¼</li>
<li>é…ç½®ä¸­æ–­æ§åˆ¶å’ŒNVICä¸­æ–­ä¼˜å…ˆçº§</li>
<li>ä½¿èƒ½å®šæ—¶å™¨</li>
</ol>
<h2 id="adc"><a class="markdownIt-Anchor" href="#adc"></a> ADC</h2>
<p><strong>Analog - Digital Converter</strong>ï¼šæ¨¡æ‹Ÿ - æ•°å­—è½¬æ¢å™¨</p>
<p><strong>12ä½é€æ¬¡é€¼è¿‘å‹ADC</strong>ï¼Œè½¬æ¢æ—¶é—´çº¦1us</p>
<p>è¾“å…¥ç”µå‹ï¼š0 ~ 3.3Vï¼Œè½¬æ¢èŒƒå›´ï¼š0 ~ 4095</p>
<p><strong>ADCè½¬æ¢çš„æ­¥éª¤ï¼šé‡‡æ · â€”&gt; ä¿æŒ â€”&gt;é‡åŒ– â€”&gt; ç¼–ç </strong></p>
<h3 id="qstm32-adcçš„æ€»è½¬æ¢æ—¶é—´å¦‚ä½•è®¡ç®—"><a class="markdownIt-Anchor" href="#qstm32-adcçš„æ€»è½¬æ¢æ—¶é—´å¦‚ä½•è®¡ç®—"></a> Qï¼šSTM32 ADCçš„æ€»è½¬æ¢æ—¶é—´å¦‚ä½•è®¡ç®—</h3>
<p>T = é‡‡æ ·æ—¶é—´ + 12.5ä¸ªADCå‘¨æœŸ</p>
<p>ï¼ˆ12ä¸ªå‘¨æœŸé‡åŒ–ï¼Œ0.5å‘¨æœŸä½é‡‡æ ·ä¿æŒè½¬æ¢çš„å‡†å¤‡æ—¶é—´ï¼‰</p>
<h2 id="stm32çš„flash"><a class="markdownIt-Anchor" href="#stm32çš„flash"></a> STM32çš„Flash</h2>
<ul>
<li><strong>Flashå†™å…¥åªèƒ½å°†1å†™æˆ0ï¼Œä¸èƒ½å°†0å†™æˆ1</strong>ï¼Œå› æ­¤è¦å†™æ–°æ•°æ®ï¼Œå¿…é¡»å…ˆæ“¦é™¤ï¼ˆæ“¦é™¤æ˜¯å°†0æ¢å¤æˆ1ï¼‰</li>
<li>ç»“æ„å±‚çº§ï¼š<strong>é¡µ &lt; æ‰‡åŒº &lt; å— &lt; èŠ¯ç‰‡</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">æ¯å—</th>
<th style="text-align:center">æ¯æ‰‡é¡µ</th>
<th style="text-align:center">æ¯é¡µ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">16æ‰‡é¡µ</td>
<td style="text-align:center">16é¡µ</td>
<td style="text-align:center">256 Byte</td>
</tr>
</tbody>
</table>
<p><strong>å¸¸ç”¨çš„Flashæ“¦å†™è§„åˆ™</strong></p>
<ul>
<li>æœ€å°æ“¦é™¤ï¼šæ‰‡åŒº</li>
<li>å¯é€‰æ‹©æ“¦é™¤ï¼šæ‰‡åŒºã€å—ã€å…¨ç‰‡</li>
<li>æœ€å¤§å†™å…¥å•ä½ï¼šé¡µï¼ˆä¸èƒ½è·¨é¡µå†™å…¥ï¼‰</li>
<li>æœ€å°å†™å…¥å•ä½ï¼š1 å­—èŠ‚</li>
<li><strong>æœªå†™å…¥æ—¶é»˜è®¤FLASHå…¨ä¸º1ï¼ˆ0xFFï¼‰</strong></li>
<li>å†™æ“ä½œåªèƒ½æŠŠ1å˜æˆ0ï¼Œè‹¥éœ€æ¢å¤0å˜1ï¼Œåˆ™å¿…é¡»å…ˆæ“¦é™¤</li>
</ul>
<h3 id="qnor-flashå’Œnand-flashåŒºåˆ«"><a class="markdownIt-Anchor" href="#qnor-flashå’Œnand-flashåŒºåˆ«"></a> Qï¼šNOR Flashå’ŒNAND FlashåŒºåˆ«ï¼Ÿ</h3>
<ul>
<li>
<p><strong>NOR Flashæ”¯æŒéšæœºè¯»å–ï¼ŒNAND Flashå—è¯»å–</strong></p>
</li>
<li>
<p>NOR<strong>è¯»</strong>å¾—æ¯”NAND<strong>å¿«</strong></p>
</li>
<li>
<p>NOR<strong>å†™å’Œæ“¦æ…¢ï¼Œå®¹é‡å°ï¼Œä»·æ ¼è´µ</strong></p>
</li>
</ul>
<h2 id="å­˜å‚¨å™¨ä¹‹é—´å¯¹ç…§"><a class="markdownIt-Anchor" href="#å­˜å‚¨å™¨ä¹‹é—´å¯¹ç…§"></a> å­˜å‚¨å™¨ä¹‹é—´å¯¹ç…§</h2>
<ul>
<li>
<p><strong>SRAM</strong>ï¼šé™æ€éšæœºå­˜å‚¨ï¼Œä¸éœ€è¦å®šæ—¶åˆ·æ–°å……ç”µï¼Œå­˜å‚¨é€Ÿåº¦å¿«ï¼Œå®¹é‡å°ï¼Œ<strong>æ–­ç”µä¸¢å¤±</strong></p>
</li>
<li>
<p><strong>DRAM</strong>ï¼šåŠ¨æ€éšæœºå­˜å‚¨ï¼Œéœ€è¦å®šæ—¶åˆ·æ–°å……ç”µï¼Œä»·æ ¼æ¯”SRAMä¾¿å®œï¼Œä½†è®¿é—®é€Ÿåº¦æ…¢ï¼Œè€—ç”µé‡å¤§</p>
</li>
<li>
<p><strong>E2PROM</strong>ï¼šå¸¦ç”µå¯æ“¦é™¤å¯ç¼–è¾‘åªè¯»å­˜å‚¨å™¨ï¼Œ<strong>æ–­ç”µåä»èƒ½ä¿å­˜ä¿¡æ¯ï¼Œå¯ä»¥å•å­—èŠ‚æ“¦é™¤</strong></p>
</li>
<li>
<p><strong>FLASHï¼ˆROMï¼‰</strong>ï¼šé—ªå­˜ï¼Œå­˜å–é€Ÿåº¦æ…¢ï¼Œå®¹é‡å¤§ï¼Œ<strong>æ‰ç”µä¸ä¸¢å¤±ï¼ŒæŒ‰æ‰‡åŒº/å—æ“¦é™¤</strong></p>
</li>
</ul>
<h2 id="dma"><a class="markdownIt-Anchor" href="#dma"></a> DMA</h2>
<p><strong>Direct Memory Access</strong>ï¼šç›´æ¥å­˜å‚¨å™¨è®¿é—®æ§åˆ¶å™¨</p>
<p><strong>ç”¨é€”</strong>ï¼šå…è®¸å¤–è®¾æˆ–å­˜å‚¨å™¨å’Œå­˜å‚¨å™¨ä¹‹é—´é«˜é€Ÿæ•°æ®ä¼ è¾“ï¼Œ<strong>æ— éœ€CPUå¹²é¢„ï¼ŒèŠ‚çœCPUèµ„æº</strong></p>
<p><em>ä½¿ç”¨å°å¯„å·§ï¼šDMAå¯ä»¥è·å–å½“å‰å‰©ä½™æ•°æ®é‡ï¼Œæ ¹æ®è®¾ç½®çš„æ¥æ”¶bufferå¤§å°å‡å»å½“å‰å‰©ä½™æ•°æ®é‡ï¼Œå¾—åˆ°<strong>å½“å‰æ¥æ”¶æ•°æ®å¤§å°</strong></em></p>
<p>STM32F103C8T6 DMAèµ„æºï¼š DMA1</p>
<p><strong>Qï¼šDMAçš„ä¼ è¾“æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ</strong></p>
<ul>
<li>
<p><strong>DMA_Mode_Normal</strong>ï¼Œæ­£å¸¸ç¼“å­˜æ¨¡å¼ï¼Œ<strong>å®ŒæˆæŒ‡å®šå¤§å°ä¼ è¾“ååœæ­¢</strong></p>
</li>
<li>
<p><strong>DMA_Mode_Circle</strong>ï¼Œ å¾ªç¯æ¨¡å¼ï¼Œ<strong>ä¼ è¾“å®Œæˆåè‡ªåŠ¨é‡æ–°åŠ è½½ï¼Œè¿ç»­ä¼ è¾“</strong></p>
</li>
</ul>
<h2 id="é€šä¿¡åè®®æ€»è§ˆ"><a class="markdownIt-Anchor" href="#é€šä¿¡åè®®æ€»è§ˆ"></a> é€šä¿¡åè®®æ€»è§ˆ</h2>
<table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">åŒå·¥</th>
<th style="text-align:center">æ—¶é’Ÿ</th>
<th style="text-align:center">ç”µå¹³</th>
<th style="text-align:center">è®¾å¤‡</th>
<th style="text-align:center">å¼•è„š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">UART</td>
<td style="text-align:center">å…¨åŒå·¥</td>
<td style="text-align:center">å¼‚æ­¥</td>
<td style="text-align:center">å•ç«¯</td>
<td style="text-align:center">ç‚¹å¯¹ç‚¹</td>
<td style="text-align:center">TXã€RX</td>
</tr>
<tr>
<td style="text-align:center">I2C</td>
<td style="text-align:center">åŠåŒå·¥</td>
<td style="text-align:center">åŒæ­¥</td>
<td style="text-align:center">å•ç«¯</td>
<td style="text-align:center">å¤šè®¾å¤‡</td>
<td style="text-align:center">SCLã€SDA</td>
</tr>
<tr>
<td style="text-align:center">SPI</td>
<td style="text-align:center">å…¨åŒå·¥</td>
<td style="text-align:center">åŒæ­¥</td>
<td style="text-align:center">å•ç«¯</td>
<td style="text-align:center">å¤šè®¾å¤‡</td>
<td style="text-align:center">CSã€SCLKã€MOSIã€MISO</td>
</tr>
<tr>
<td style="text-align:center">CAN</td>
<td style="text-align:center">åŠåŒå·¥</td>
<td style="text-align:center">å¼‚æ­¥</td>
<td style="text-align:center">å·®åˆ†</td>
<td style="text-align:center">å¤šè®¾å¤‡</td>
<td style="text-align:center">CAN_Hã€CAN_L</td>
</tr>
<tr>
<td style="text-align:center">USB</td>
<td style="text-align:center">åŠåŒå·¥</td>
<td style="text-align:center">å¼‚æ­¥</td>
<td style="text-align:center">å·®åˆ†</td>
<td style="text-align:center">ç‚¹å¯¹ç‚¹</td>
<td style="text-align:center">DPã€DM</td>
</tr>
</tbody>
</table>
<h2 id="uart"><a class="markdownIt-Anchor" href="#uart"></a> UART</h2>
<p><strong>ä¸²å£é€šä¿¡</strong></p>
<p><img src="https://s2.loli.net/2025/05/07/yfZ6Hv5uq1SL8m9.png" alt="" /></p>
<p><strong>ä½ä½å…ˆè¡Œ</strong>ï¼šè‹¥å‘é€ä¿¡æ¯0X0Fï¼Œåˆ™ä¼ è¾“æ•°æ®ä½æ˜¯1111 0000ï¼Œæœ€ç»ˆæ¥æ”¶ä¿¡æ¯0X0F</p>
<p>æ³¢ç‰¹ç‡å¯¹é½ï¼ˆæ¯”ç‰¹ç‡=æ³¢ç‰¹ç‡ * log2ï¼ˆN)ï¼ŒNæ˜¯äºŒè¿›åˆ¶ä½æ•°ï¼‰ï¼›</p>
<p><strong>è¿‡ç¨‹</strong>ï¼šèµ·å§‹ä¸€ä¸ª<strong>ä½ç”µå¹³</strong>ä¿¡å·è¡¨ç¤º<strong>å¼€å§‹å‘é€æ•°æ®</strong>ï¼Œæ¥ç€æ˜¯<strong>8ä¸ªæ•°æ®ä½</strong>ï¼Œç„¶åæ˜¯æ ¡éªŒä½ï¼ˆå¥‡/å¶/NONEï¼‰ï¼Œæœ€åæ˜¯<strong>é«˜ç”µå¹³</strong>è¡¨ç¤ºåœæ­¢ä½ï¼ˆ0.5/1/1.5/2ï¼‰</p>
<p><img src="https://s2.loli.net/2025/05/07/NJ3RueE5X7DtIoj.png" alt="" /></p>
<h3 id="qä¸²å£é€šä¿¡å¦‚ä½•é…ç½®"><a class="markdownIt-Anchor" href="#qä¸²å£é€šä¿¡å¦‚ä½•é…ç½®"></a> Qï¼šä¸²å£é€šä¿¡å¦‚ä½•é…ç½®ï¼Ÿ</h3>
<ol>
<li>ä¸²å£<strong>æ—¶é’Ÿä½¿èƒ½</strong>ï¼ŒGPIOæ—¶é’Ÿä½¿èƒ½</li>
<li><strong>å¤ä½</strong>ä¸²å£å¤–è®¾</li>
<li>é…ç½®GPIO
<ul>
<li><strong>TX</strong>ä¸º<strong>å¤ç”¨æ¨æŒ½</strong>ï¼Œ<strong>RX</strong>ä¸º<strong>æµ®ç©ºè¾“å…¥</strong></li>
</ul>
</li>
<li>åˆå§‹åŒ–ä¸²å£å‚æ•°ï¼ˆæ³¢ç‰¹ç‡ï¼Œæ•°æ®ä½ï¼Œæ ¡éªŒä½ï¼Œæ”¶å‘æ¨¡å¼ï¼‰</li>
<li><strong>å¼€å¯ä¸­æ–­å¹¶åˆå§‹åŒ–NVIC</strong></li>
<li><strong>ä½¿èƒ½ä¸²å£å¤–è®¾</strong></li>
<li><strong>ç¼–å†™ä¸²å£å‡½æ•°</strong></li>
</ol>
<h3 id="qæè¿°ä¸‹rs232å’Œrs485çš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#qæè¿°ä¸‹rs232å’Œrs485çš„åŒºåˆ«"></a> Qï¼šæè¿°ä¸‹RS232å’ŒRS485çš„åŒºåˆ«ï¼Ÿ</h3>
<p><strong>TTLï¼ˆå…¨åŒå·¥ï¼‰</strong>ï¼š0Vè¡¨ç¤º0ï¼Œ+3.3V~+5Vè¡¨ç¤º1</p>
<p><strong>RS232ï¼ˆå…¨åŒå·¥ï¼‰</strong>ï¼š+3V ~ +15Vè¡¨ç¤º0ï¼Œ-3V ~ -15Vè¡¨ç¤º1ï¼Œï¼ˆTTLé€šè¿‡RS232èŠ¯ç‰‡ï¼‰</p>
<p><strong>RS485ï¼ˆåŠåŒå·¥ï¼‰</strong>ï¼šä¸¤çº¿ç”µå‹å·®-2V ~ -6Vè¡¨ç¤º0ï¼Œ+2V ~ +6Vè¡¨ç¤º1ï¼ˆTTLé€šè¿‡RS485èŠ¯ç‰‡ï¼‰</p>
<h2 id="i2c"><a class="markdownIt-Anchor" href="#i2c"></a> I2C</h2>
<p>Inter IC BUSï¼ˆ<strong>åŒæ­¥ã€åŠåŒå·¥</strong>ï¼‰ï¼Œæ”¯æŒ<strong>ä¸€ä¸»å¤šä»å’Œå¤šä¸»å¤šä»</strong>ï¼ˆMSBé«˜ä½å…ˆè¡Œï¼‰</p>
<p>ä¸¤æ ¹é€šä¿¡çº¿ï¼šSCLï¼ˆSerial Clockï¼‰ã€SDAï¼ˆSerial Dataï¼‰ï¼Œä¸Šæ‹‰ç”µé˜»ä¸€èˆ¬4.7K~10K</p>
<p><strong>STM32æ”¯æŒ7/10ä½åœ°å€æ¨¡å¼</strong></p>
<p><img src="https://s2.loli.net/2025/05/07/Lh49pJTuEyxrFGB.png" alt="" /></p>
<h3 id="qi2cæ€»çº¿åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æœ‰å“ªäº›ç±»å‹ä¿¡å·"><a class="markdownIt-Anchor" href="#qi2cæ€»çº¿åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æœ‰å“ªäº›ç±»å‹ä¿¡å·"></a> Qï¼šI2Cæ€»çº¿åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æœ‰å“ªäº›ç±»å‹ä¿¡å·ï¼Ÿ</h3>
<ul>
<li><strong>å¼€å§‹ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAç”±é«˜åˆ°ä½ï¼Œå¼€å§‹å‘é€æ•°æ®</li>
<li><strong>ç»“æŸä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAç”±ä½åˆ°é«˜ï¼Œç»“æŸå‘é€æ•°æ®</li>
<li><strong>åº”ç­”ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼Œå‘é€8Bitæ•°æ®ï¼Œ<strong>æ¥æ”¶ç«¯</strong>å‘<strong>å‘é€ç«¯</strong>å‘<strong>ä½ç”µå¹³</strong>ï¼Œè¡¨ç¤º<strong>æˆåŠŸæ¥æ”¶</strong>ï¼ˆåœ¨æ¥æ”¶å‰éœ€è¦é‡Šæ”¾SDAï¼‰</li>
</ul>
<p><em><strong>TIPï¼šä¸€æ—¦ å¼€å§‹ä¿¡å·äº§ç”Ÿåï¼Œæ•°æ®ä¼ è¾“å¿…é¡»åœ¨ SCL ä¸ºä½æ—¶å¼€å§‹ã€‚</strong></em></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½œå›¾ï¼Œè®°å¾—SCLå…ˆè¡Œï¼Œä»–å†³å®šäº†æ­¤æ—¶çš„ä¿¡å·çŠ¶æ€ï¼Œæƒ³ä¸€æƒ³Startå’ŒStop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* SCLé«˜ç”µå¹³ï¼ŒSDAä»é«˜åˆ°ä½ï¼Œè®°å¾—æ‹‰ä½SCLï¼Œé˜²æ­¢è¢«é”™è¯¯è®¤ä¸ºæ˜¯å¦ä¸€ä¸ªèµ·å§‹æ¡ä»¶ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SCL_H;			<span class="comment">//	SCLé«˜</span></span><br><span class="line">    SDA_H;			<span class="comment">//	SDAé«˜</span></span><br><span class="line">    Delay_us(<span class="number">2</span>);</span><br><span class="line">    SDA_L;			<span class="comment">//	SDAä½</span></span><br><span class="line">    SCL_L;			<span class="comment">//	SCLä½</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Endä¿¡å·ï¼ŒSCLé«˜ç”µå¹³ï¼ŒSDAä»ä½åˆ°é«˜ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Stop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SCL_L;</span><br><span class="line">    SDA_L;</span><br><span class="line">    SCL_H;</span><br><span class="line">    SDA_H;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em><strong>TIPï¼šè½¯ä»¶æ¨¡æ‹ŸI2Cæ—¶ï¼ŒSDAç”µå¹³åˆ‡æ¢åªå‡ºç°åœ¨SCLä½ç”µå¹³é˜¶æ®µï¼Œä¸è¦ææ··</strong></em></p>
<h3 id="qi2cçš„è½¯ç¡¬ä»¶æ¨¡å¼æ€ä¹ˆé…ç½®"><a class="markdownIt-Anchor" href="#qi2cçš„è½¯ç¡¬ä»¶æ¨¡å¼æ€ä¹ˆé…ç½®"></a> Qï¼šI2Cçš„è½¯ç¡¬ä»¶æ¨¡å¼æ€ä¹ˆé…ç½®ï¼Ÿ</h3>
<p><strong>ç¡¬ä»¶æ¨¡å¼ï¼šå¤ç”¨å¼€æ¼è¾“å‡º+ä¸Šæ‹‰ç”µé˜»</strong>ï¼›å†…éƒ¨æœ‰å›ºå®šI2Cç»“æ„ï¼›æœ‰é€šä¿¡é€Ÿç‡è®¾ç½®ï¼Œ400Kbps</p>
<p><strong>è½¯ä»¶æ¨¡å¼ï¼šé€šç”¨å¼€æ¼è¾“å‡º+ä¸Šæ‹‰ç”µé˜»</strong>ï¼›é€šè¿‡GPIOæ¨¡æ‹ŸI2Cä¿¡å·ï¼›æ²¡æœ‰é€šä¿¡é€Ÿç‡é…ç½®ï¼Œ<strong>éœ€è¦è‡ªå·±å†™ä¸€ä¸ªdelay</strong>ï¼Œ100Kbps</p>
<p>TIPï¼šæœ‰äº›äººå·æ‡’ç”¨ <code>GPIO_MODE_OUTPUT_PP</code>ï¼ˆæ¨æŒ½ï¼‰æ¥æ¨¡æ‹Ÿï¼Œä½†å¿…é¡»è‡ªå·±æ‰‹åŠ¨é‡Šæ”¾SDAå˜é«˜</p>
<h3 id="qi2cçš„ä»²è£æœºåˆ¶"><a class="markdownIt-Anchor" href="#qi2cçš„ä»²è£æœºåˆ¶"></a> Qï¼šI2Cçš„ä»²è£æœºåˆ¶ï¼Ÿ</h3>
<p><strong>â€œçº¿ä¸â€<strong>æ“ä½œï¼ˆ&amp;&amp;ï¼‰ï¼Œå³</strong>ä½ç”µå¹³ä¼˜å…ˆ</strong>ï¼Œè°å…ˆå‘é€ä½ç”µå¹³ï¼Œè°å°±å¯¹æ€»çº¿å æœ‰æ§åˆ¶æƒã€‚</p>
<h3 id="qi2cçš„ä»æœºè®¾å¤‡åœ°å€id-å†™åœ°å€-è¯»åœ°å€"><a class="markdownIt-Anchor" href="#qi2cçš„ä»æœºè®¾å¤‡åœ°å€id-å†™åœ°å€-è¯»åœ°å€"></a> Qï¼šI2Cçš„ä»æœºè®¾å¤‡åœ°å€IDã€å†™åœ°å€ã€è¯»åœ°å€ï¼Ÿ</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">è¯¥éƒ¨åˆ†éœ€è¦æŸ¥è¯¢å¯¹åº”èŠ¯ç‰‡æ‰‹å†Œ!</span><br><span class="line">ä¸¾ä¾‹AT24C02ï¼Œåœ°å€ADDR = <span class="number">1010</span>ï¼Œæ§åˆ¶æ ¼å¼<span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> A2 A1 A0 R/Wã€‚</span><br><span class="line">è‹¥A2 = <span class="number">0</span>ï¼ŒA1 = <span class="number">0</span>ï¼ŒA0 = <span class="number">0</span>ï¼Œå†™æ“ä½œR/W=<span class="number">0</span>ï¼Œè¯»æ“ä½œR/W=<span class="number">1</span></span><br><span class="line">    <span class="comment">// TIP: æ­£å¸¸I2Cå‘é€7ä½ï¼Œæ˜¯ä¸å¸¦R/Wï¼Œæ‰€ä»¥è®¾å¤‡åœ°å€æœ‰å˜åŒ–ï¼Œè¯¦ç»†å¯ä»¥å»é—®ä¸‹GPT</span></span><br><span class="line">    è®¾å¤‡åœ°å€ <span class="number">0101</span> <span class="number">0000</span> <span class="number">0X50</span>ï¼ˆæ§åˆ¶æ ¼å¼å»æ‰R/Wåå³ç§»ï¼Œé«˜ä½è¡¥<span class="number">0</span>ï¼‰</span><br><span class="line">    å†™åœ°å€ä¸º <span class="number">1010</span> <span class="number">0000</span> <span class="number">0XA0</span>ï¼ˆè®¾å¤‡åœ°å€&lt;&lt;<span class="number">1</span> | <span class="number">0</span>ï¼‰</span><br><span class="line">    è¯»åœ°å€ä¸º <span class="number">1010</span> <span class="number">0001</span> <span class="number">0XA1</span>ï¼ˆè®¾å¤‡åœ°å€&lt;&lt;<span class="number">1</span> | <span class="number">1</span>ï¼‰</span><br></pre></td></tr></table></figure>
<h4 id="ç‰¹å®šåœ°å€å†™"><a class="markdownIt-Anchor" href="#ç‰¹å®šåœ°å€å†™"></a> ç‰¹å®šåœ°å€å†™</h4>
<p><img src="https://s2.loli.net/2025/05/07/rdzHou5UOhMECKZ.png" alt="" /></p>
<h4 id="å½“å‰åœ°å€è¯»"><a class="markdownIt-Anchor" href="#å½“å‰åœ°å€è¯»"></a> å½“å‰åœ°å€è¯»</h4>
<p><img src="https://s2.loli.net/2025/05/07/2uT3q6VhUWELOZy.png" alt="" /></p>
<h2 id="spi"><a class="markdownIt-Anchor" href="#spi"></a> SPI</h2>
<p><strong>Serial Peripheral Interface</strong>ï¼šä¸²è¡Œå¤–è®¾æ¥å£ï¼ˆ<strong>MSBå…ˆè¡Œ</strong>ï¼‰ï¼Œ<strong>é€Ÿåº¦æ¯”I2Cå¿«å¾ˆå¤š</strong></p>
<p>å››æ ¹é€šä¿¡çº¿ï¼š</p>
<ul>
<li><strong>SCLKï¼ˆSerial Clockï¼‰</strong></li>
<li><strong>MOSIï¼ˆMaster Output Slave Inputï¼‰</strong></li>
<li><strong>MISOï¼ˆMaster Input Slave Outputï¼‰</strong></li>
<li><strong>CS</strong></li>
</ul>
<p><strong>MISOè¾“å…¥ä¸ºä¸Šæ‹‰æˆ–æµ®ç©ºè¾“å…¥ï¼ŒSCLKã€MOSIè¾“å‡ºé…ç½®ä¸ºå¤ç”¨æ¨æŒ½è¾“å‡ºã€CSé…ç½®ä½æ¨æŒ½è¾“å‡ºã€‚</strong></p>
<ul>
<li>
<p><strong>èµ·æ­¢æ¡ä»¶</strong>ï¼šCSé«˜ç”µå¹³åˆ‡æ¢åˆ°ä½ç”µå¹³</p>
</li>
<li>
<p><strong>ç»ˆæ­¢æ¡ä»¶</strong>ï¼šCSä½ç”µå¹³åˆ‡æ¢åˆ°é«˜ç”µå¹³</p>
</li>
<li>
<p><strong>å‘é€ä¿¡æ¯</strong>ï¼š<strong>CSä¸€ç›´ä¸ºä½ç”µå¹³</strong></p>
</li>
</ul>
<h3 id="qå››ç§å·¥ä½œæ¨¡å¼"><a class="markdownIt-Anchor" href="#qå››ç§å·¥ä½œæ¨¡å¼"></a> Qï¼šå››ç§å·¥ä½œæ¨¡å¼</h3>
<p>æ—¶é’Ÿææ€§CPOLï¼ˆä¸Šå‡æ²¿/ä¸‹é™æ²¿ï¼‰ï¼›æ—¶é’Ÿç›¸ä½CPHAï¼ˆç¬¬ä¸€ä¸ªè¾¹æ²¿/ç¬¬äºŒä¸ªè¾¹æ²¿ï¼‰</p>
<ul>
<li><strong>CPOL = 0 ------&gt;ä¸Šå‡æ²¿</strong></li>
<li><strong>CPOL = 1 ------&gt; ä¸‹é™æ²¿</strong></li>
<li><strong>CPHA = 0 ------&gt;ç¬¬ä¸€ä¸ªè¾¹æ²¿</strong></li>
<li><strong>CPHA = 1 ------&gt; ç¬¬äºŒä¸ªè¾¹æ²¿</strong></li>
</ul>
<h3 id="qå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸ªæ¨¡å¼"><a class="markdownIt-Anchor" href="#qå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸ªæ¨¡å¼"></a> Qï¼šå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸ªæ¨¡å¼</h3>
<p>çœ‹<strong>ä»æœºç©ºé—²çŠ¶æ€</strong>æ˜¯ä½ç”µå¹³è¿˜æ˜¯é«˜ç”µå¹³ï¼Œæ¥ç¡®è®¤CPOLï¼›å†ä»<strong>ä»æœºèŠ¯ç‰‡æ—¶åºå›¾é‡Œç¡®è®¤ä½•æ—¶é‡‡å–æ•°æ®</strong>ã€‚</p>
<p><strong>ä¸‹å›¾è§£é‡Šï¼šåœ¨æ²¡æœ‰è¿›å…¥Cycleæ—¶ï¼Œé€šè¿‡SPICLKæ˜¯é«˜ä½ç”µå¹³æ¥åˆ¤æ–­CPOLï¼›CPHAé€šè¿‡æ­£ä¸­é—´çš„é‚£ä¸ªè¾¹æ²¿åˆ¤æ–­ã€‚</strong></p>
<p><img src="https://s2.loli.net/2025/05/07/SEBAmWquCTYNJaZ.png" alt="" /></p>
<h3 id="qé™€èºä»ªå¯ä»¥ç”¨spié€šä¿¡å—æœ‰ä»€ä¹ˆå¥½å¤„"><a class="markdownIt-Anchor" href="#qé™€èºä»ªå¯ä»¥ç”¨spié€šä¿¡å—æœ‰ä»€ä¹ˆå¥½å¤„"></a> Qï¼šé™€èºä»ªå¯ä»¥ç”¨SPIé€šä¿¡å—ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</h3>
<p>æœ‰çš„æ—¢å¯ä»¥ä½¿ç”¨SPIï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨I2Cï¼Œå½“ç„¶SPIçš„ä¼ è¾“é€Ÿåº¦ä¼šæ›´å¿«<br />
<strong>MPU6050åªèƒ½I2Cï¼ŒMPU9250å¯ä»¥I2Cå’ŒSPI</strong></p>
<h2 id="çœ‹é—¨ç‹—"><a class="markdownIt-Anchor" href="#çœ‹é—¨ç‹—"></a> çœ‹é—¨ç‹—</h2>
<p>çœ‹é—¨ç‹—ç›‘æ§ç¨‹åºè¿è¡ŒçŠ¶æ€ï¼Œå½“ç¨‹åºå› ä¸ºè®¾è®¡æ¼æ´ã€ç¡¬ä»¶æ•…éšœå¯¼è‡´å‡ºç°å¡æ­»ç­‰é—®é¢˜æ—¶ï¼Œçœ‹é—¨ç‹—å¯ä»¥åŠæ—¶å¤ä½ç¨‹åºï¼›<strong>æœ¬è´¨æ˜¯å®šæ—¶å™¨</strong>ï¼Œåœ¨æŒ‡å®šèŒƒå›´å†…ï¼Œ<strong>ç¨‹åºæ²¡æœ‰æ‰§è¡Œå–‚ç‹—</strong>ï¼ˆé‡ç½®è®¡æ•°å™¨ï¼‰ï¼Œçœ‹é—¨ç‹—ç¡¬ä»¶<strong>ä¼šè‡ªåŠ¨äº§ç”Ÿå¤ä½</strong>ä¿¡å·ã€‚</p>
<p><strong>ç‹¬ç«‹çœ‹é—¨ç‹—ï¼ˆIWDGï¼‰</strong>ï¼šç‹¬ç«‹äºä¸»ç³»ç»Ÿæ—¶é’Ÿï¼Œæ—¶é—´ç²¾åº¦ä½ï¼Œ<strong>å¼€å¯å°±æ— æ³•å…³é—­</strong>ã€‚</p>
<p><strong>çª—å£çœ‹é—¨ç‹—ï¼ˆWWDGï¼‰</strong>ï¼šèƒ½äº§ç”Ÿ<strong>ç³»ç»Ÿå¤ä½ä¿¡å·å’Œæå‰å”¤é†’ä¸­æ–­</strong>ã€‚</p>
<h2 id="i2s"><a class="markdownIt-Anchor" href="#i2s"></a> I2S</h2>
<p>I2Sï¼ˆInter-IC Soundï¼‰æ˜¯ä¸€ç§å¹¿æ³›åº”ç”¨äºæ•°å­—éŸ³é¢‘ä¼ è¾“çš„ä¸²è¡Œæ¥å£æ ‡å‡†</p>
<p>åº”ç”¨åœºæ™¯å¦‚ä¸‹</p>
<p><strong>I2S RXæ–¹å‘</strong>ï¼šéº¦å…‹é£åœ¨æœºæ¢°æŒ¯åŠ¨ä¸‹å°†å£°éŸ³ä¿¡å·è½¬å˜ä¸ºç”µå‹ä¿¡å·ï¼Œç”µå‹ä¿¡å·ç»è¿‡æ”¾å¤§ç­‰å¤„ç†ï¼Œç»™åˆ°ADCé‡‡æ ·ï¼Œå°†æ¨¡æ‹Ÿä¿¡å·è½¬åŒ–ä¸ºæ•°å­—ä¿¡å·ï¼›éŸ³é¢‘åœ¨ADCä¸DSPä¹‹é—´çš„ä¼ è¾“åè®®å°±æ˜¯ä½¿ç”¨çš„I2Såè®®ã€‚</p>
<p><strong>I2S TXæ–¹å‘</strong>ï¼šæ•°å­—ä¿¡å·ç»è¿‡ç¼–ç ã€å­˜å‚¨ã€å‹ç¼©ç­‰æŠ€æœ¯åï¼Œå‘é€ç»™è§£ç å™¨DACï¼ˆDSPã€ä¸“ç”¨è§£ç å™¨ï¼‰ï¼Œå°†æ•°å­—ä¿¡å·è¿˜åŸä¸ºæ¨¡æ‹Ÿä¿¡å·ï¼Œæœ€åç»™åˆ°å–‡å­å®Œæˆå£°éŸ³/éŸ³é¢‘çš„æ’­æ”¾ã€‚éŸ³é¢‘åœ¨DACä¸DSPä¹‹é—´çš„ä¼ è¾“å°±æ˜¯ä½¿ç”¨I2Såè®®ã€‚</p>
<p><img src="https://s2.loli.net/2025/07/24/VeDQ5lg7JZ1WLHE.png" alt="" /></p>
<h3 id="åŸºæœ¬ä¿¡å·çº¿"><a class="markdownIt-Anchor" href="#åŸºæœ¬ä¿¡å·çº¿"></a> åŸºæœ¬ä¿¡å·çº¿</h3>
<p><img src="https://s2.loli.net/2025/07/24/rmOP4cp9dV7i5ka.png" alt="" /></p>
<p><strong>æ—¶é’Ÿçº¿ï¼ˆContinues Serial Clockï¼ŒSCKï¼‰</strong>ï¼šSCKæä¾›ä¼ è¾“æ—¶çš„æ—¶é’Ÿä¿¡å·ï¼Œç¡®å®šäº†æ•°æ®ä¼ è¾“çš„é€Ÿåº¦å’Œæ—¶åºï¼Œä¹Ÿç§°ä¹‹ä¸ºBCLKï¼›<strong>SCKçš„é¢‘ç‡ = 2 x é‡‡æ ·é¢‘ç‡ x ä½å®½</strong></p>
<p><strong>å·¦/å³å£°é“çº¿ï¼ˆLeft-Right Clockï¼ŒLRCKï¼‰</strong>ï¼šLRCKçº¿æŒ‡ç¤ºäº†å½“å‰ä¼ è¾“çš„æ˜¯å·¦å£°é“çš„éŸ³é¢‘æ•°æ®è¿˜æ˜¯å³å£°é“çš„éŸ³é¢‘æ•°æ®ã€‚åˆç§°<strong>å¸§åŒæ­¥ä¿¡å·</strong>ã€‚<strong>LRCKçš„é¢‘ç‡ = é‡‡æ ·é¢‘ç‡</strong></p>
<p><strong>æ•°æ®çº¿ï¼ˆSerial Dataï¼ŒSDï¼‰</strong>ï¼šSDçº¿ç”¨äºä¼ è¾“å®é™…çš„éŸ³é¢‘æ•°æ®ã€‚æ•°æ®çš„ä½å®½å¯ä»¥æ ¹æ®å…·ä½“åº”ç”¨è€Œå˜åŒ–ï¼Œé€šå¸¸ä¸º16ä½æˆ–32ä½ã€‚TXæ–¹å‘ä¸ºï¼šSerial Data Outï¼ˆSDOUTï¼‰ï¼›RXæ–¹å‘ä¸ºï¼šSerial Data Inï¼ˆSDINï¼‰ã€‚</p>
<h3 id="å¸¸è§å‚æ•°è¯´æ˜"><a class="markdownIt-Anchor" href="#å¸¸è§å‚æ•°è¯´æ˜"></a> å¸¸è§å‚æ•°è¯´æ˜</h3>
<ul>
<li><strong>ä½å®½</strong>ï¼ˆWord Lengthï¼‰ï¼šä½å®½æŒ‡å®š<strong>æ¯ä¸ªé‡‡æ ·æ•°æ®çš„ä½æ•°</strong>ï¼Œé€šå¸¸ä¸º16ä½æˆ–32ä½ã€‚è¾ƒå¤§çš„ä½å®½å¯ä»¥æä¾›æ›´é«˜çš„åˆ†è¾¨ç‡å’ŒåŠ¨æ€èŒƒå›´ã€‚</li>
<li><strong>æ—¶é’Ÿææ€§</strong>ï¼ˆClock Polarityï¼‰ï¼šæ—¶é’Ÿææ€§ç¡®å®šäº†<strong>æ•°æ®ä½ä¼ è¾“çš„æ—¶é’Ÿæ²¿</strong>ã€‚æ ¹æ®å…·ä½“çš„I2Sè®¾å¤‡å’Œç³»ç»Ÿè®¾ç½®ï¼Œå¯ä»¥å®šä¹‰åœ¨æ—¶é’Ÿä¸Šå‡æ²¿æˆ–ä¸‹é™æ²¿å¼€å§‹æ•°æ®ä¼ è¾“</li>
<li><strong>å¸§åŒæ­¥ææ€§</strong>ï¼ˆFrame Sync Polarityï¼‰ï¼šå¸§åŒæ­¥ææ€§ç¡®å®šäº†<strong>å¸§åŒæ­¥ä¿¡å·çš„æœ‰æ•ˆç”µå¹³</strong>ã€‚å¸§åŒæ­¥ä¿¡å·æŒ‡ç¤ºéŸ³é¢‘æ•°æ®çš„å¸§èµ·å§‹å’Œç»“æŸä½ç½®ã€‚</li>
<li><strong>ä¼ è¾“æ ¼å¼</strong>ï¼ˆData Formatï¼‰ï¼šä¼ è¾“æ ¼å¼å®šä¹‰äº†<strong>éŸ³é¢‘æ•°æ®çš„ç¼–ç æ–¹å¼</strong>ï¼Œä¼ è¾“æ ¼å¼è¿˜å¯ä»¥æŒ‡å®šæ•°æ®çš„é¡ºåºï¼Œå¦‚å·¦å£°é“å…ˆä¼ è¾“è¿˜æ˜¯å³å£°é“å…ˆä¼ è¾“</li>
</ul>
<h3 id="ä¸»ä»æ¨¡å¼"><a class="markdownIt-Anchor" href="#ä¸»ä»æ¨¡å¼"></a> ä¸»ä»æ¨¡å¼</h3>
<p>I2Så·¥ä½œæ¨¡å¼å¯ä»¥æ˜¯ä¸»æ¨¡å¼ï¼ˆMaster Modeï¼‰æˆ–ä»æ¨¡å¼ï¼ˆSlave Modeï¼‰ã€‚ä¸¤è€…å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼šMaster Modeæä¾›æ—¶é’Ÿä¿¡å·ï¼ˆSCKï¼‰å’Œå¸§åŒæ­¥ä¿¡å·ï¼ˆLRCKï¼‰</p>
<p><img src="https://s2.loli.net/2025/07/24/NtylZ6xkdAULSzc.png" alt="" /></p>
<h3 id="æ•°æ®ä¼ è¾“æ¨¡å¼"><a class="markdownIt-Anchor" href="#æ•°æ®ä¼ è¾“æ¨¡å¼"></a> æ•°æ®ä¼ è¾“æ¨¡å¼</h3>
<p>I2Sæ¥å£æ ‡å‡†ä¸­ï¼Œå­˜åœ¨ä¸‰ç§æ•°æ®ä¼ è¾“æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ï¼š**é£åˆ©æµ¦æ ‡å‡†æ¨¡å¼ï¼ˆI2S modeï¼‰ï¼Œå·¦å¯¹é½ï¼ˆLeft Justifiedï¼‰å’Œå³å¯¹é½ï¼ˆRight Justifiedï¼‰**ä¸‰ç§ä¼ è¾“æ¨¡å¼ã€‚</p>
<ul>
<li><strong>é£åˆ©æµ¦æ ‡å‡†æ¨¡å¼</strong></li>
</ul>
<p><img src="https://s2.loli.net/2025/07/24/vDoh63pXNgzyTSf.png" alt="" /></p>
<p>ï¼ˆ1ï¼‰LRCKï¼ˆå·¦å³å£°é“é€‰æ‹©ä¿¡å·ï¼‰ï¼šLRCKä¿¡å·ç”¨äºæŒ‡ç¤ºå½“å‰æ•°æ®å¸§æ˜¯å·¦å£°é“æ•°æ®è¿˜æ˜¯å³å£°é“æ•°æ®ã€‚<strong>é£åˆ©æµ¦æ ¼å¼ä¸­</strong>ï¼Œå½“<strong>LRCKä¸ºä½</strong>æ—¶ï¼Œè¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ•°æ®æ˜¯<strong>å·¦å£°é“</strong>æ•°æ®ï¼›å½“<strong>LRCKä¸ºé«˜</strong>æ—¶ï¼Œè¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ•°æ®ä¸º<strong>å³å£°é“</strong>æ•°æ®</p>
<p>ï¼ˆ2ï¼‰SCKï¼ˆä½æ—¶é’Ÿï¼‰ï¼šæ•°æ®ä¼ è¾“çš„æ—¶é’Ÿä¿¡å·ã€‚<strong>åœ¨SCKä¸‹é™æ²¿å‘é€æ•°æ®ï¼Œåœ¨SCKä¸Šå‡æ²¿é‡‡æ ·æ•°æ®</strong></p>
<p>ï¼ˆ3ï¼‰<strong>Data Delay</strong>ï¼šå‘é€çš„æœ‰æ•ˆæ•°æ®ç›¸å¯¹äºLRCKçš„è·³å˜æ²¿ï¼ˆä»0åˆ°1æˆ–ä»1åˆ°0ï¼‰å»¶è¿Ÿä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸ</p>
<p>ï¼ˆ4ï¼‰æ•°æ®å‘é€ä»MSBå¼€å§‹ï¼›<strong>æ•°æ®MSBä¸LRCK delay 1ä¸ªSCKçš„è¾¹æ²¿å¯¹é½</strong></p>
<ul>
<li><strong>å·¦å¯¹é½æ¨¡å¼</strong></li>
</ul>
<p><img src="https://s2.loli.net/2025/07/24/MDc5SaFyL4WjPQN.png" alt="" /></p>
<p>ï¼ˆ1ï¼‰åœ¨å·¦å¯¹é½æ ¼å¼ä¸­ï¼Œ<strong>LRCKä¸ºé«˜</strong>æ—¶ï¼Œè¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ•°æ®ä¸º<strong>å·¦å£°é“æ•°æ®</strong>ï¼›å½“<strong>LRCKä¸ºä½</strong>æ—¶ï¼Œè¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ•°æ®ä¸º<strong>å³å£°é“</strong>æ•°æ®</p>
<p>ï¼ˆ2ï¼‰<strong>åœ¨SCKä¸‹é™æ²¿å‘é€æ•°æ®ï¼Œåœ¨SCKä¸Šå‡æ²¿æ¥æ”¶æ•°æ®</strong></p>
<p>ï¼ˆ3ï¼‰<strong>æ— data delay</strong>ï¼šå‘é€çš„æœ‰æ•ˆæ•°æ®ç›¸å½“äºLRCKè·³å˜æ²¿ï¼ˆä»0åˆ°1æˆ–ä»1åˆ°0ï¼‰ä¸å»¶è¿Ÿ</p>
<p>ï¼ˆ4ï¼‰æ•°æ®å‘é€ä»MSBå¼€å§‹ï¼›<strong>æ•°æ®MSBä¸LRCKè·³å˜æ²¿å¯¹é½</strong></p>
<ul>
<li>å³å¯¹é½æ¨¡å¼</li>
</ul>
<p><img src="https://s2.loli.net/2025/07/24/86L1tIylvoDk3R2.png" alt="" /></p>
<p>ï¼ˆ1ï¼‰å³å¯¹é½æ ¼å¼ä¸­ï¼Œ<strong>LRCKä¸ºé«˜</strong>æ—¶ï¼Œè¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ•°æ®ä¸º<strong>å³å£°é“</strong>æ•°æ®ï¼›å½“<strong>LRCKä¸ºä½</strong>æ—¶ï¼Œè¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ•°æ®ä¸º<strong>å·¦å£°é“</strong>æ•°æ®</p>
<p>ï¼ˆ2ï¼‰<strong>åœ¨SCKä¸‹é™æ²¿å‘é€æ•°æ®ï¼Œåœ¨SCKä¸Šå‡æ²¿æ¥æ”¶æ•°æ®</strong></p>
<p>ï¼ˆ3ï¼‰<strong>æ— Data delay</strong>ï¼šå‘é€çš„æœ‰æ•ˆæ•°æ®ç›¸å½“äºLRCKè·³å˜æ²¿ï¼ˆä»0åˆ°1æˆ–ä»1åˆ°0ï¼‰ä¸å»¶è¿Ÿ</p>
<p>ï¼ˆ4ï¼‰æ•°æ®å‘é€ä»MSBå¼€å§‹ï¼›<strong>æ•°æ®LSBä¸LRCKè·³å˜æ²¿å¯¹é½</strong></p>
<h3 id="æ•°æ®ä½å®½ä¸ä½æ·±"><a class="markdownIt-Anchor" href="#æ•°æ®ä½å®½ä¸ä½æ·±"></a> æ•°æ®ä½å®½ä¸ä½æ·±</h3>
<p><strong>ä½å®½è®¡ç®—è¿‡ç¨‹</strong>ï¼š</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mi>C</mi><mi>K</mi><mo>=</mo><mn>2</mn><mo>âˆ—</mo><mtext>é‡‡æ ·é¢‘ç‡</mtext><mo>âˆ—</mo><mtext>ä½å®½</mtext><mo>=</mo><mn>2</mn><mo>âˆ—</mo><mi>L</mi><mi>R</mi><mi>C</mi><mi>K</mi><mo>âˆ—</mo><mtext>ä½å®½</mtext><mspace linebreak="newline"></mspace><mtext>ä½å®½</mtext><mo>=</mo><mi>S</mi><mi>C</mi><mi>K</mi><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><mo>âˆ—</mo><mi>L</mi><mi>R</mi><mi>C</mi><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
SCK = 2 * é‡‡æ ·é¢‘ç‡ * ä½å®½ = 2 * LRCK * ä½å®½ \\

ä½å®½ = SCK / (2 * LRCK)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">SC</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">é‡‡æ ·é¢‘ç‡</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">ä½å®½</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">RC</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">ä½å®½</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">ä½å®½</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">SC</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord">/</span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">RC</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span></span>
<p><strong>ä½æ·±</strong>ï¼šè¡¨ç¤ºéŸ³é¢‘æ•°æ®é‡åŒ–åçš„ç²¾åº¦ï¼ˆ<strong>I2Sä¸­ä½å®½å’Œä½æ·±éƒ½æ˜¯ç”±Masterå†³å®šçš„</strong>ï¼‰</p>
<p>ä¸‹é¢æ˜¯<strong>32ä½ä½å®½ï¼Œ20ä½ä½æ·±</strong></p>
<p><img src="https://s2.loli.net/2025/07/24/CA15xFE6yzMKtvb.png" alt="" /></p>
<h2 id="canä»¥ä¸‹çš„ä¸å»ºè®®çœ‹å»çœ‹å¦å¤–ä¸€ç¯‡å§"><a class="markdownIt-Anchor" href="#canä»¥ä¸‹çš„ä¸å»ºè®®çœ‹å»çœ‹å¦å¤–ä¸€ç¯‡å§"></a> CANï¼ˆä»¥ä¸‹çš„ä¸å»ºè®®çœ‹ï¼Œå»çœ‹å¦å¤–ä¸€ç¯‡å§ï¼‰</h2>
<h3 id="å†…å®¹-4"><a class="markdownIt-Anchor" href="#å†…å®¹-4"></a> å†…å®¹</h3>
<p>CANæ€»çº¿ï¼ˆ<strong>Controller Area Network Bus</strong>ï¼‰æ§åˆ¶å™¨å±€åŸŸç½‘æ€»çº¿ã€‚</p>
<p>ä¸€ä¸ªèŠ‚ç‚¹åŒ…æ‹¬3ä¸ªéƒ¨åˆ†ï¼š<strong>å¾®å¤„ç†MCUã€CANæ§åˆ¶å™¨ã€CANæ”¶å‘å™¨ã€‚</strong>ï¼ˆCAN_Hã€CAN_Lä¸ºåŒç»çº¿ï¼‰</p>
<p><strong>å¼€ç¯ç½‘ç»œä¸¤ç«¯</strong>å¿…é¡»æœ‰<strong>2.2KÎ©çš„ç»ˆç«¯ç”µé˜»</strong>ï¼›<strong>é—­ç¯ç½‘ç»œä¸¤ç«¯</strong>å¿…é¡»æœ‰<strong>120Î©çš„ç»ˆç«¯ç”µé˜»ï¼ˆæŠ—å¹²æ‰°ä½œç”¨ï¼‰</strong>ï¼›</p>
<p>ï¼ˆä¿¡å·åˆ°ç»ˆç«¯è¢«ç”µé˜»å¸æ”¶ï¼Œé¿å…åå°„å›å¹²æ‰°ä¸‹ä¸€æ¬¡ä¿¡å·ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯æ”¾ä¸¤ç«¯ï¼‰</p>
<p><img src="https://s2.loli.net/2025/05/07/iQW4DOth8NynmJC.png" alt="" /></p>
<p><strong>CAN BUS</strong>ï¼ˆå³è¾¹é‚£ä¸€å—ï¼‰ä¸Šçš„æ€»çº¿ç”µå¹³ç§°ä¸º<strong>éšå½¢ç”µå¹³å’Œæ˜¾æ€§ç”µå¹³</strong>ã€‚</p>
<h3 id="ios11898æ ‡å‡†"><a class="markdownIt-Anchor" href="#ios11898æ ‡å‡†"></a> <strong>IOS11898æ ‡å‡†</strong></h3>
<table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">æ€§è´¨</th>
<th style="text-align:center">é€»è¾‘</th>
<th style="text-align:center">CAN_H</th>
<th style="text-align:center">CAN_L</th>
<th style="text-align:center">ä¸¤æ¡çº¿ä¸Šçš„ç”µå‹å·®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Recessive</td>
<td style="text-align:center">éšæ€§</td>
<td style="text-align:center">é€»è¾‘1</td>
<td style="text-align:center">2.5V</td>
<td style="text-align:center">2.5V</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">Dominant</td>
<td style="text-align:center">æ˜¾æ€§</td>
<td style="text-align:center">é€»è¾‘0</td>
<td style="text-align:center">3.5V</td>
<td style="text-align:center">1.5V</td>
<td style="text-align:center">2V</td>
</tr>
</tbody>
</table>
<p>å¤šä¸ªèŠ‚ç‚¹ä¸€èµ·å¼€å§‹å‘é€ï¼Œä¼šæ¶‰åŠåˆ°<strong>æ€»çº¿ä»²è£</strong>ã€‚</p>
<h3 id="canå¸§çš„ç§ç±»"><a class="markdownIt-Anchor" href="#canå¸§çš„ç§ç±»"></a> CANå¸§çš„ç§ç±»</h3>
<table>
<thead>
<tr>
<th style="text-align:center">åºå·</th>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">å¸§ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">æ•°æ®å¸§</td>
<td style="text-align:center">ç”¨äºå‘é€å•å…ƒå‘æ¥æ”¶å•å…ƒä¼ é€æ•°æ®çš„å¸§ã€‚</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">é¥æ§å¸§</td>
<td style="text-align:center">ç”¨äºæ¥æ”¶å•å…ƒå‘å…·æœ‰ç›¸åŒ ID çš„å‘é€å•å…ƒè¯·æ±‚æ•°æ®çš„å¸§ã€‚</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">é”™è¯¯å¸§</td>
<td style="text-align:center">ç”¨äºå½“æ£€æµ‹å‡ºé”™è¯¯æ—¶å‘å…¶å®ƒå•å…ƒé€šçŸ¥é”™è¯¯çš„å¸§ã€‚ ï¼ˆç¡¬ä»¶è‡ªåŠ¨å®Œæˆï¼‰</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">è¿‡è½½å¸§</td>
<td style="text-align:center">å½“ä¸€ä¸ªèŠ‚ç‚¹æ­£å¿™äºå¤„ç†æ¥æ”¶çš„ä¿¡æ¯,å¯ä»¥é€šçŸ¥å…¶å®ƒèŠ‚ç‚¹æš‚ç¼“å‘é€æ–°æŠ¥æ–‡ã€‚ï¼ˆç¡¬ä»¶è‡ªåŠ¨å®Œæˆï¼‰</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">å¸§é—´éš”</td>
<td style="text-align:center">ç”¨äºå°†æ•°æ®å¸§åŠè¿œç¨‹å¸§ä¸å‰é¢çš„å¸§åˆ†ç¦»å¼€æ¥çš„å¸§ï¼ˆç¡¬ä»¶è‡ªåŠ¨å®Œæˆï¼‰</td>
</tr>
</tbody>
</table>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è‡ªå·±å‘é€å¸§ï¼ˆ<strong>å¸§æ˜¯CANåè®®è§„å®šå‘é€æˆ–æ¥æ”¶çš„å•ä½</strong>ï¼‰</p>
<p><img src="https://s2.loli.net/2025/05/07/zBLUehdCMscOtR3.png" alt="" /></p>
<p><img src="https://s2.loli.net/2025/05/07/El7tqDN9u3SCAs5.png" alt="" /></p>
<table>
<thead>
<tr>
<th>åºå·</th>
<th>åç§°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>å¸§èµ·å§‹</td>
<td>è¡¨ç¤ºå¸§çš„å¼€å§‹ï¼Œäº§ç”Ÿä¸€ä¸ªbitçš„æ˜¾æ€§ç”µå¹³</td>
</tr>
<tr>
<td>2</td>
<td>ä»²è£æ®µ</td>
<td>è¡¨ç¤ºå¸§çš„ä¼˜å…ˆçº§ï¼Œ ç”±æ ‡è¯†ç¬¦ï¼ˆIDï¼‰å’Œä¼ é€å¸§ç±»å‹(RTR)ç»„æˆ</td>
</tr>
<tr>
<td>3</td>
<td>æ§åˆ¶æ®µ</td>
<td>è¡¨ç¤ºæ•°æ®çš„å­—èŠ‚æ•°ï¼Œç”±6ä¸ªbitæ„æˆ</td>
</tr>
<tr>
<td>4</td>
<td>æ•°æ®æ®µ</td>
<td>æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œå¯å‘é€0ï½8 ä¸ªå­—èŠ‚çš„æ•°æ®</td>
</tr>
<tr>
<td>5</td>
<td>CRCæ®µ</td>
<td>ç”¨äºæ ¡éªŒä¼ è¾“æ˜¯å¦æ­£ç¡®</td>
</tr>
<tr>
<td>6</td>
<td>ACKæ®µ</td>
<td>è¡¨ç¤ºç¡®è®¤æ˜¯å¦æ­£å¸¸æ¥æ”¶ï¼ˆ0ä¸ºåº”ç­”ï¼‰</td>
</tr>
<tr>
<td>7</td>
<td>å¸§ç»“æŸ</td>
<td>è¡¨ç¤ºæ­¤å¸§ç»“æŸ</td>
</tr>
</tbody>
</table>
<p><img src="https://s2.loli.net/2025/05/07/QPHtCxUK7IW2z4c.png" alt="" /></p>
<ul>
<li>
<p><strong>ä»²è£æ®µ</strong>ï¼šå¯ä»¥æ ¹æ®é…ç½®å¥½çš„è®¾ç½®ï¼Œè‡ªåŠ¨åˆ¤æ–­è¦ä¸è¦æ¥æ”¶æŠ¥æ–‡ï¼Œè¯¥æ–¹æ¡ˆä¹Ÿå«ä½œè¿‡æ»¤ï¼Œåˆ¤æ–­ä¾æ®æ˜¯æ¯ä¸ªæŠ¥æ–‡çš„IDã€‚</p>
</li>
<li>
<p>æ ‡å‡†æ ¼å¼çš„æ ‡è¯†ç¬¦é•¿åº¦ä¸º11ä½ï¼Œæ‹“å±•æ ¼å¼æ˜¯29ä½</p>
</li>
<li>
<p><strong>RTR</strong>ä½ï¼Œå®ƒæ¥<strong>è¡¨æ˜æ˜¯æ•°æ®å¸§ï¼ˆ0ï¼‰è¿˜æ˜¯è¿œç¨‹å¸§ï¼ˆ1ï¼‰</strong></p>
</li>
<li>
<p><strong>IDE</strong>è¡¨æ˜<strong>æ­¤å¸§æ˜¯æ ‡å‡†å¸§ï¼ˆ0ï¼‰è¿˜æ˜¯æ‹“å±•å¸§ï¼ˆ1ï¼‰</strong>ã€‚</p>
</li>
<li>
<p><strong>æ§åˆ¶æ®µ</strong>ï¼šæ§åˆ¶æ®µè¡¨ç¤ºæ•°æ®æ®µçš„å­—èŠ‚æ•°ã€‚</p>
</li>
<li>
<p><strong>ä¿ç•™ä½ï¼ˆr0ã€r1ï¼‰</strong>ï¼Œå¿…é¡»<strong>å…¨éƒ¨ä»¥æ˜¾æ€§ç”µå¹³å‘é€</strong>ï¼Œä½†æ¥æ”¶æ–¹å¯ä»¥æ¥æ”¶æ˜¾æ€§ã€éšæ€§çš„å„ç§ç»„åˆã€‚</p>
</li>
<li>
<p><strong>æ•°æ®é•¿åº¦ç ï¼ˆData Link Controlï¼‰</strong>ï¼Œæ•°æ®å­—èŠ‚å¿…é¡»ä¸º0-8å­—èŠ‚ï¼Œä½†æ¥æ”¶æ–¹å¯¹æ•°æ®å­—èŠ‚æ•°=9~15çš„æƒ…å†µå¹¶ä¸è§†ä¸ºé”™è¯¯ã€‚</p>
</li>
</ul>
<p><img src="https://s2.loli.net/2025/05/07/s74bY1mifvpLBSP.png" alt="" /></p>
<p><strong>æ•°æ®æ®µ</strong>ï¼š0-8ä¸ªå­—èŠ‚æ•°æ®ï¼ŒCANæ§åˆ¶å™¨æœ‰å¯¹åº”çš„å¯„å­˜å™¨ã€‚</p>
<p><strong>ä½å¡«å……æœºåˆ¶ï¼š<strong>å½“æ£€æµ‹åˆ°</strong>äº”ä¸ªè¿ç»­ç›¸åŒçš„ä½ä¿¡å·</strong>ï¼Œå®é™…å‘é€ä¼š<strong>è‡ªåŠ¨æ’å…¥ä¸€ä¸ªè¡¥ç </strong>ï¼Œ<strong>ä½å¡«å……åŒºåŸŸä¸ºSOFåˆ°CRCç»“æŸä¹‹é—´</strong></p>
<h3 id="ä»²è£æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#ä»²è£æ–¹æ¡ˆ"></a> ä»²è£æ–¹æ¡ˆ</h3>
<ol>
<li>
<p><strong>åœ¨æ€»çº¿ç©ºé—²æ—¶ï¼Œæœ€å…ˆå¼€å§‹å‘é€çš„èŠ‚ç‚¹è·å¾—å‘é€æƒ</strong>ï¼Œä¸€æ—¦å¼€å§‹å‘é€ï¼Œä¸ä¼šè¢«å…¶ä»–èŠ‚ç‚¹æŠ¢å ã€‚</p>
</li>
<li>
<p><strong>å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å¼€å§‹å‘é€æ—¶ï¼Œå„å‘é€èŠ‚ç‚¹ä»ä»²è£æ®µçš„ç¬¬ä¸€ä½å¼€å§‹è¿›è¡Œä»²è£ã€‚è¿ç»­è¾“å‡ºæ˜¾æ€§ç”µå¹³æœ€å¤šçš„èŠ‚ç‚¹å¯ç»§ç»­å‘é€</strong>ã€‚(ä»å·¦åˆ°å³ï¼ŒDominant ï¼šæ˜¾æ€§ä¼˜å…ˆ)</p>
</li>
<li>
<p><strong>å…·æœ‰ç›¸åŒIDçš„æ•°æ®å¸§å’Œè¿œç¨‹å¸§åœ¨æ€»çº¿ä¸Šç«äº‰æ—¶ï¼Œä»²è£æ®µçš„æœ€åä¸€ä½ï¼ˆRTRï¼‰ä¸ºæ˜¾æ€§ä½çš„æ•°æ®å¸§å…·æœ‰ä¼˜å…ˆæƒå¯ç»§ç»­å‘é€ã€‚</strong></p>
</li>
<li>
<p><strong>æ ‡å‡†æ ¼å¼IDä¸å…·æœ‰ç›¸åŒIDçš„è¿œç¨‹å¸§æˆ–è€…æ‰©å±•æ ¼å¼çš„æ•°æ®å¸§åœ¨æ€»çº¿ä¸Šç«äº‰æ—¶ï¼Œæ ‡å‡†æ ¼å¼çš„RTR ä½ä¸ºæ˜¾æ€§ä½çš„å…·æœ‰ä¼˜å…ˆæƒå¯ç»§ç»­å‘é€ã€‚</strong></p>
</li>
</ol>
<h3 id="canè¿‡æ»¤å™¨é…ç½®"><a class="markdownIt-Anchor" href="#canè¿‡æ»¤å™¨é…ç½®"></a> CANè¿‡æ»¤å™¨é…ç½®</h3>
<p>è¿‡æ»¤æ¨¡å¼ï¼š<strong>åˆ—è¡¨æ¨¡å¼å’Œæ©ç æ¨¡å¼</strong></p>
<p><strong>åˆ—è¡¨æ¨¡å¼</strong>ï¼š<strong>åˆ—å‡ºIDåç§°</strong>ï¼Œåˆ¤æ–­IDæ˜¯å¦ä¸€è‡´æ¥åˆ¤æ–­æ˜¯å¦æ¥å—æˆ–è€…ä¸¢å¼ƒï¼Œ<strong>å—åˆ°åˆ—è¡¨å®¹é‡å¤§å°é™åˆ¶</strong>ã€‚</p>
<p><strong>æ©ç æ¨¡å¼</strong>ï¼šç¡®å®šIDç‰¹å®šä½çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦æ¥å—æˆ–ä¸¢å¼ƒï¼Œ<strong>ä¸å—åˆ—è¡¨å®¹é‡å¤§å°é™åˆ¶</strong>ã€‚</p>
<p>é…ç½®è¿‡æ»¤å™¨ï¼Œæœ‰ä¸‰ä¸ªé‡è¦çš„å¯„å­˜å™¨ï¼šCAN_FSIRã€CAN_FxR1ã€CAN_FxR2</p>
<h3 id="canæ€»çº¿é”™è¯¯åˆ†ç±»"><a class="markdownIt-Anchor" href="#canæ€»çº¿é”™è¯¯åˆ†ç±»"></a> CANæ€»çº¿é”™è¯¯åˆ†ç±»</h3>
<p><img src="https://s2.loli.net/2025/05/07/sMQwR1hOJdrpWy6.png" alt="" /></p>
<h3 id="cubemxé…ç½®"><a class="markdownIt-Anchor" href="#cubemxé…ç½®"></a> CubeMXé…ç½®</h3>
<p>1ã€é…ç½®æ³¢ç‰¹ç‡</p>
<p>ä½æ•°æ®æ®µï¼šåŒæ­¥æ®µ----ä¼ æ’­æ®µï¼ˆè¡¥å¿CANç½‘ç»œçš„ç‰©ç†å»¶è¿Ÿï¼‰----ç›¸ä½ç¼“å†²æ®µ1----ç›¸ä½ç¼“å†²æ®µ2ï¼ˆè¡¥å¿ç›¸ä½è¯¯å·®ï¼‰</p>
<p>å¯èƒ½ä¼šæœ‰æ—©åˆ°çš„ï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰æ™šåˆ°çš„ï¼Œé€šè¿‡ä¸Šé¢çš„å››æ®µå¯ä»¥è¿›è¡Œæ‹‰é•¿ç¼©å°æ¥æ“ä½œã€‚</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mi>A</mi><mi>N</mi><mtext>æ³¢ç‰¹ç‡</mtext><mo>=</mo><mi>T</mi><mi>Q</mi><mo>âˆ—</mo><mo stretchy="false">(</mo><mi>T</mi><mi>B</mi><mi>S</mi><mn>1</mn><mo>+</mo><mi>T</mi><mi>B</mi><mi>S</mi><mn>2</mn><mo>+</mo><mi>S</mi><mi>J</mi><mi>Y</mi><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mo>=</mo><mfrac><mrow><mi>A</mi><mi>P</mi><mi>B</mi><mtext>æ€»çº¿é¢‘ç‡</mtext><mo>âˆ—</mo><mo stretchy="false">(</mo><mi>T</mi><mi>B</mi><mi>S</mi><mn>1</mn><mo>+</mo><mi>T</mi><mi>B</mi><mi>S</mi><mn>2</mn><mo>+</mo><mi>S</mi><mi>J</mi><mi>Y</mi><mo stretchy="false">)</mo></mrow><mtext>åˆ†é¢‘ç³»æ•°</mtext></mfrac></mrow><annotation encoding="application/x-tex">
CANæ³¢ç‰¹ç‡=TQ*(TBS1 + TBS2 + SJY)   \\
\\
= \frac{APBæ€»çº¿é¢‘ç‡ * (TBS1 + TBS2 + SJY)}{åˆ†é¢‘ç³»æ•°}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord cjk_fallback">æ³¢ç‰¹ç‡</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">TQ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">TBS</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">TBS</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord cjk_fallback">åˆ†é¢‘ç³»æ•°</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05017em;">PB</span><span class="mord cjk_fallback">æ€»çº¿é¢‘ç‡</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">TBS</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">TBS</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>2ã€æ‰“å¼€CANçš„æ¥å—ä¸­æ–­ï¼Œä¸¤ä¸ªæ¥æ”¶é‚®ç®±ã€ä¸‰ä¸ªå‘é€é‚®ç®±ã€‚</p>
<h2 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h2>
<p><a href="https://blog.csdn.net/w237838/article/details/133916583">Stm32æœ€å°ç³»ç»Ÿæ¿çš„æ„æˆè¯¦è§£-CSDNåšå®¢</a></p>
<p><a href="https://blog.csdn.net/qq_29350001/article/details/116021595">åµŒå…¥å¼é¢è¯•çŸ¥è¯†ç‚¹æ€»ç»“ â€“ STM32ç¯‡_stm32 112+16+64-CSDNåšå®¢</a></p>
<p><a href="https://blog.csdn.net/weixin_51084418/article/details/141829654?spm=1001.2101.3001.6650.3&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-3-141829654-blog-116021595.235%5Ev43%5Epc_blog_bottom_relevance_base9&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-3-141829654-blog-116021595.235%5Ev43%5Epc_blog_bottom_relevance_base9&amp;utm_relevant_index=6">åµŒå…¥å¼çŸ¥è¯†ç‚¹ï¼ˆSTM32ã€uartã€spiã€iicç­‰æ€»çº¿ï¼‰_i2c dma hardfault-CSDNåšå®¢</a></p>
<p><a href="https://blog.csdn.net/weixin_56102526/article/details/128368370">flashåŸºç¡€çŸ¥è¯†_flashæ“¦é™¤æœ€å°å•ä½-CSDNåšå®¢</a></p>
<p><a href="https://blog.csdn.net/laifengyuan1/article/details/107481945">STM32: ADCé‡‡æ ·é¢‘ç‡åŠç›¸åº”æ—¶é—´çš„ç¡®å®š_adcé‡‡æ ·é¢‘ç‡è®¡ç®—å…¬å¼-CSDNåšå®¢</a></p>
<p><a href="https://blog.csdn.net/qq_39829913/article/details/104718185">åŸºç¡€é€šä¿¡åè®®ä¹‹ IIC (I2C) è¯¦ç»†è®²è§£_i2cé€šä¿¡çš„è¯¦ç»†è®²è§£-CSDNåšå®¢</a></p>
<p><a href="https://blog.csdn.net/as480133937/article/details/105764119">SPIåŸç†è¶…è¯¦ç»†è®²è§£â€”å€¼å¾—ä¸€çœ‹-CSDNåšå®¢</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/678943329">(11 å°ç§ä¿¡) ã€I2Sã€‘æ•°å­—éŸ³é¢‘æ¥å£â€”I2Sæ€»çº¿åè®®åŸºæœ¬æ¦‚å¿µ - çŸ¥ä¹</a></p>
<p><a href="https://blog.csdn.net/qq_35057766/article/details/135580884">ä¸€æ–‡è¯»æ‡‚CANæ€»çº¿åè®® (è¶…è¯¦ç»†é…34å¼ é«˜æ¸…å›¾)_canæ€»çº¿åè®®è¯¦è§£-CSDNåšå®¢</a></p>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>STM32</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨æ–°åŸŸååä¸åŠ è½½ä¸»é¢˜</title>
    <url>/2022/05/15/%E4%BD%BF%E7%94%A8%E6%96%B0%E5%9F%9F%E5%90%8D%E5%90%8E%E4%B8%8D%E5%8A%A0%E8%BD%BD%E4%B8%BB%E9%A2%98/</url>
    <content><![CDATA[<h3 id="å¿ƒè·¯å†ç¨‹"><a class="markdownIt-Anchor" href="#å¿ƒè·¯å†ç¨‹"></a> <strong>å¿ƒè·¯å†ç¨‹</strong></h3>
<p>çœ‹äº†ä¸€åœˆCSDNï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æŠ„æŠ„æ”¹æ”¹ï¼Œåªæœ‰å‡ ä¸ªè¿˜æœ‰ç‚¹è´Ÿè´£å¿ƒï¼Œä½†ä¾ç„¶æ²¡æœ‰è§£å†³æˆ‘çš„é—®é¢˜ï¼Œå·®ç‚¹å°±æ”¾å¼ƒäº†ï¼Œä¸è¿‡å¥½åœ¨é€šè¿‡è¯•é”™ç»™è¯•å‡ºæ¥äº†ã€‚</p>
<h3 id="è§£å†³æ–¹æ³•"><a class="markdownIt-Anchor" href="#è§£å†³æ–¹æ³•"></a> è§£å†³æ–¹æ³•</h3>
<p>ä½¿ç”¨äº†æ–°åŸŸååï¼Œå‘ç°ç½‘é¡µçš„CSSå’ŒJSéƒ½æ²¡ç”¨äº†ï¼Œä½†æœ¬åœ°é™æ€å¯ä»¥æ­£å¸¸è¿è¡Œã€‚è¿™ä¸ªæ—¶å€™éœ€è¦ä¿®æ”¹ä¸ªäººåšå®¢åº•ä¸‹çš„_config.ymlæ–‡ä»¶ï¼Œå…ˆæ‰¾åˆ°è¿™ä¸ªåœ°æ–¹ï¼š</p>
<p><img src="https://s2.loli.net/2025/05/07/KCLeSkUBlQGursV.png" alt="" /></p>
<p>å°†urlæ”¹ä¸º<strong><a href="http://githubname.github.io">githubname.github.io</a></strong>ï¼Œ<strong>ä¸è¦å‡ºç°ä¸‹ä¸€å±‚ä»“åº“å</strong>ã€‚</p>
<p><strong>è¯´æ˜</strong>ï¼šCSDNä¸Šåˆ«äººçš„è§£å†³æ–¹æ³•ä¸é€‚ç”¨ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬è¿™ä¸ªæ²¡æœ‰å•ç‹¬ç»™å‡ºrootï¼Œåˆ‡è®°åˆ‡è®°ã€‚</p>
]]></content>
      <categories>
        <category>ç½‘é¡µ</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ </tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºBootloaderçš„ç®€æ˜“æ¡Œé¢é—¹é’Ÿ</title>
    <url>/2025/07/27/%E5%9F%BA%E4%BA%8EBootloader%E7%9A%84%E7%AE%80%E6%98%93%E6%A1%8C%E9%9D%A2%E9%97%B9%E9%92%9F/</url>
    <content><![CDATA[<p>åœ¨è¿™ä»½é¡¹ç›®é‡Œï¼ŒBootloaderä½¿ç”¨ä¹‹å‰Bootloaderå­¦ä¹ ç¬”è®°é‡Œåšçš„æ ·ä¾‹ã€‚</p>
<p><s><strong>å¯ä»¥è¯´æ˜¯ä¸ºäº†è¿™ç¢—é†‹ï¼ŒåŒ…äº†è¿™ç¢—é¥ºå­</strong></s></p>
<h1 id="æ–°æ·»å†…å®¹"><a class="markdownIt-Anchor" href="#æ–°æ·»å†…å®¹"></a> æ–°æ·»å†…å®¹</h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä»AT24C02æœ€åä¸€é¡µè¯»å–OTA_flagï¼ˆ4å­—èŠ‚ï¼‰</span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">AT24C02_ReadOTAFlag</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> addr = <span class="number">0xF0</span>; <span class="comment">// æœ€åä¸€é¡µå¼€å§‹åœ°å€</span></span><br><span class="line">	<span class="type">uint32_t</span> flag = <span class="number">0</span>;</span><br><span class="line">	<span class="type">uint8_t</span> *pflag = (<span class="type">uint8_t</span> *)&amp;flag;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// è¯»å–4å­—èŠ‚çš„OTA_flag</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">uint8_t</span> data = <span class="number">0</span>;</span><br><span class="line">		AT24C02_ReadData(addr + i, &amp;data, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(data == <span class="number">0xFF</span>) <span class="comment">// è¯»å–å¤±è´¥</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// è¿”å›0è¡¨ç¤ºè¯»å–å¤±è´¥</span></span><br><span class="line">		&#125;</span><br><span class="line">		pflag[i] = data;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Bootloaderè·³è½¬é€»è¾‘æ§åˆ¶</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Bootloader_Jump</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// è¯»å–å¹¶æ‰“å°OTA_flag</span></span><br><span class="line">	<span class="type">uint32_t</span> OTA_flag = AT24C02_ReadOTAFlag();<span class="comment">//å¤„åœ¨AT24C02çš„æœ€åä¸€é¡µ</span></span><br><span class="line">	uprintf(<span class="string">&quot;OTA_flag: %d \r\n&quot;</span>, OTA_flag);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å¦‚æœOTA_flag == 1ï¼Œç›´æ¥è·³è½¬APP</span></span><br><span class="line">	<span class="keyword">if</span>(OTA_flag == <span class="number">1</span>) &#123;</span><br><span class="line">		uprintf(<span class="string">&quot;Direct jump to APP\r\n&quot;</span>);</span><br><span class="line">		LOAD_A(FLASH_A_SADDR);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ç»§ç»­åŸæœ‰Bootloaderé€»è¾‘</span></span><br><span class="line">	<span class="keyword">if</span>(Bootloader_Enter(<span class="number">20</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(OTA_flag == OTA_SET_FLAG)</span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;OTA update \r\n&quot;</span>);</span><br><span class="line">			BootState |= UPDATA_A_FLAG;</span><br><span class="line">			Updata_A.W25Q64_BlockNM = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;Jump to Area A \r\n&quot;</span>);</span><br><span class="line">			LOAD_A(FLASH_A_SADDR);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	uprintf(<span class="string">&quot;Enter Bootloader command line \r\n&quot;</span>);</span><br><span class="line">	Bootloader_Info();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ç®€æ˜“æ¡Œé¢é—¹é’Ÿ"><a class="markdownIt-Anchor" href="#ç®€æ˜“æ¡Œé¢é—¹é’Ÿ"></a> ç®€æ˜“æ¡Œé¢é—¹é’Ÿ</h1>
<p>FreeRTOSç§»æ¤ï¼š<a href="https://blog.csdn.net/ba_wang_mao/article/details/127628185">è¶…è¯¦ç»†çš„FreeRTOSç§»æ¤å…¨æ•™ç¨‹â€”â€”åŸºäºstm32_freertosç§»æ¤æ•™ç¨‹-CSDNåšå®¢</a></p>
<p><strong>æ—¶é’Ÿæ–¹é¢éœ€è¦æ”¹ç”¨FreeRTOSçš„SysTickï¼Œå¦åˆ™ç³»ç»Ÿä¼šå¡æ­»</strong></p>
<h2 id="å®ç‰©"><a class="markdownIt-Anchor" href="#å®ç‰©"></a> å®ç‰©</h2>
<p><img src="https://s2.loli.net/2025/07/27/W3SZJCmjdYwkrbf.png" alt="" /></p>
<h2 id="æ•´ä½“ç»“æ„"><a class="markdownIt-Anchor" href="#æ•´ä½“ç»“æ„"></a> æ•´ä½“ç»“æ„</h2>
<p><img src="https://s2.loli.net/2025/07/27/ilGDFK1mO96fJkz.png" alt="" /></p>
<h2 id="systick-svc-pendsv"><a class="markdownIt-Anchor" href="#systick-svc-pendsv"></a> SysTickã€SVCã€PendSV</h2>
<h4 id="systick_handler-ç³»ç»Ÿæ—¶é’Ÿ"><a class="markdownIt-Anchor" href="#systick_handler-ç³»ç»Ÿæ—¶é’Ÿ"></a> SysTick_Handler - ç³»ç»Ÿæ—¶é’Ÿ</h4>
<ul>
<li>
<p>å°±åƒå¿ƒè·³ï¼Œå®šæœŸæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢ä»»åŠ¡</p>
</li>
<li>
<p>é¢‘ç‡å›ºå®šï¼Œç³»ç»Ÿè¿è¡ŒæœŸé—´æŒç»­å·¥ä½œ</p>
</li>
<li>
<p>è´Ÿè´£æ—¶é—´ç®¡ç†å’Œè°ƒåº¦è§¦å‘</p>
</li>
</ul>
<h4 id="svc_handler-ç³»ç»Ÿå¯åŠ¨å™¨"><a class="markdownIt-Anchor" href="#svc_handler-ç³»ç»Ÿå¯åŠ¨å™¨"></a> SVC_Handler - ç³»ç»Ÿå¯åŠ¨å™¨</h4>
<ul>
<li>
<p>å°±åƒç‚¹ç«å™¨ï¼Œåªè´Ÿè´£å¯åŠ¨ç¬¬ä¸€ä¸ªä»»åŠ¡</p>
</li>
<li>
<p>åªè°ƒç”¨ä¸€æ¬¡ï¼Œå¯åŠ¨åå°±ä¸å·¥ä½œäº†</p>
</li>
<li>
<p>ä»ç‰¹æƒæ¨¡å¼åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼</p>
</li>
</ul>
<h4 id="pendsv_handler-ä»»åŠ¡åˆ‡æ¢å™¨"><a class="markdownIt-Anchor" href="#pendsv_handler-ä»»åŠ¡åˆ‡æ¢å™¨"></a> PendSV_Handler - ä»»åŠ¡åˆ‡æ¢å™¨</h4>
<ul>
<li>
<p>å°±åƒäº¤é€šæŒ‡æŒ¥å‘˜ï¼Œè´Ÿè´£å®‰æ’å“ªä¸ªä»»åŠ¡å…ˆè¿è¡Œ</p>
</li>
<li>
<p>éœ€è¦åˆ‡æ¢æ—¶æ‰å·¥ä½œï¼Œä¼˜å…ˆçº§æœ€ä½</p>
</li>
<li>
<p>åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿›è¡Œä»»åŠ¡åˆ‡æ¢</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">ç‰¹æ€§</th>
<th style="text-align:center">SysTick_Handler</th>
<th style="text-align:center">SVC_Handler</th>
<th style="text-align:center">PendSV_Handler</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å…¨ç§°</td>
<td style="text-align:center">System Tick Handler</td>
<td style="text-align:center">Supervisor Call Handler</td>
<td style="text-align:center">Pending Service Handler</td>
</tr>
<tr>
<td style="text-align:center">ä¸­æ–‡å</td>
<td style="text-align:center">ç³»ç»Ÿæ»´ç­”ä¸­æ–­</td>
<td style="text-align:center">è¶…çº§è°ƒç”¨ä¸­æ–­</td>
<td style="text-align:center">æŒ‚èµ·æœåŠ¡ä¸­æ–­</td>
</tr>
<tr>
<td style="text-align:center">è§¦å‘æ–¹å¼</td>
<td style="text-align:center">ç¡¬ä»¶å®šæ—¶å™¨</td>
<td style="text-align:center">è½¯ä»¶è°ƒç”¨SVCæŒ‡ä»¤</td>
<td style="text-align:center">è½¯ä»¶è§¦å‘PendSV</td>
</tr>
</tbody>
</table>
<h2 id="delay"><a class="markdownIt-Anchor" href="#delay"></a> delay</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> fac_us = <span class="number">0</span>;  <span class="comment">// uså»¶æ—¶å€ä¹˜æ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> fac_ms = <span class="number">0</span>; <span class="comment">// mså»¶æ—¶å€ä¹˜æ•°,åœ¨RTOSä¸‹,ä»£è¡¨æ¯ä¸ªèŠ‚æ‹çš„msæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief æ—¶é’Ÿåˆå§‹åŒ– - å‚è€ƒä¾‹ç¨‹ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> reload;</span><br><span class="line">    SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK); <span class="comment">// é€‰æ‹©å¤–éƒ¨æ—¶é’Ÿ  HCLK</span></span><br><span class="line">    fac_us = SystemCoreClock / <span class="number">1000000</span>;              <span class="comment">// ä¸è®ºæ˜¯å¦ä½¿ç”¨OS,fac_uséƒ½éœ€è¦ä½¿ç”¨</span></span><br><span class="line">    reload = SystemCoreClock / <span class="number">1000000</span>;              <span class="comment">// æ¯ç§’é’Ÿçš„è®¡æ•°æ¬¡æ•° å•ä½ä¸ºM</span></span><br><span class="line">    reload *= <span class="number">1000000</span> / configTICK_RATE_HZ;          <span class="comment">// æ ¹æ®configTICK_RATE_HZè®¾å®šæº¢å‡ºæ—¶é—´</span></span><br><span class="line">                                                     <span class="comment">// reloadä¸º24ä½å¯„å­˜å™¨,æœ€å¤§å€¼:16777216,åœ¨72Mä¸‹,çº¦åˆ0.233så·¦å³</span></span><br><span class="line">    fac_ms = <span class="number">1000</span> / configTICK_RATE_HZ;              <span class="comment">// ä»£è¡¨OSå¯ä»¥å»¶æ—¶çš„æœ€å°‘å•ä½</span></span><br><span class="line"></span><br><span class="line">    SysTick-&gt;CTRL |= SysTick_CTRL_TICKINT_Msk; <span class="comment">// å¼€å¯SYSTICKä¸­æ–­</span></span><br><span class="line">    SysTick-&gt;LOAD = reload;                    <span class="comment">// æ¯1/configTICK_RATE_HZç§’ä¸­æ–­ä¸€æ¬¡</span></span><br><span class="line">    SysTick-&gt;CTRL |= SysTick_CTRL_ENABLE_Msk;  <span class="comment">// å¼€å¯SYSTICK</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief å»¶æ—¶å¾®å¦™</span></span><br><span class="line"><span class="comment"> * @param us å»¶æ—¶0~65536å¾®ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_us</span><span class="params">(<span class="type">uint32_t</span> us)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> ticks;</span><br><span class="line">    <span class="type">uint32_t</span> told, tnow, tcnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint32_t</span> reload = SysTick-&gt;LOAD; <span class="comment">// LOADçš„å€¼</span></span><br><span class="line">    ticks = us * fac_us;            <span class="comment">// éœ€è¦çš„èŠ‚æ‹æ•°</span></span><br><span class="line">    told = SysTick-&gt;VAL;            <span class="comment">// åˆšè¿›å…¥æ—¶çš„è®¡æ•°å™¨å€¼</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        tnow = SysTick-&gt;VAL;</span><br><span class="line">        <span class="keyword">if</span> (tnow != told)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tnow &lt; told)</span><br><span class="line">                tcnt += told - tnow; <span class="comment">// è¿™é‡Œæ³¨æ„ä¸€ä¸‹SYSTICKæ˜¯ä¸€ä¸ªé€’å‡çš„è®¡æ•°å™¨å°±å¯ä»¥äº†.</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                tcnt += reload - tnow + told;</span><br><span class="line">            told = tnow;</span><br><span class="line">            <span class="keyword">if</span> (tcnt &gt;= ticks)</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// æ—¶é—´è¶…è¿‡/ç­‰äºè¦å»¶è¿Ÿçš„æ—¶é—´,åˆ™é€€å‡º.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief å»¶æ—¶æ¯«ç§’</span></span><br><span class="line"><span class="comment"> * @param ms å»¶æ—¶0~65536æ¯«ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_ms</span><span class="params">(<span class="type">uint32_t</span> ms)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (xTaskGetSchedulerState() != taskSCHEDULER_NOT_STARTED) <span class="comment">// ç³»ç»Ÿå·²ç»è¿è¡Œ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ms &gt;= fac_ms) <span class="comment">// å»¶æ—¶çš„æ—¶é—´å¤§äºOSçš„æœ€å°‘æ—¶é—´å‘¨æœŸ</span></span><br><span class="line">        &#123;</span><br><span class="line">            vTaskDelay(ms / fac_ms); <span class="comment">// FreeRTOSå»¶æ—¶</span></span><br><span class="line">        &#125;</span><br><span class="line">        ms %= fac_ms; <span class="comment">// OSå·²ç»æ— æ³•æä¾›è¿™ä¹ˆå°çš„å»¶æ—¶äº†,é‡‡ç”¨æ™®é€šæ–¹å¼å»¶æ—¶</span></span><br><span class="line">    &#125;</span><br><span class="line">    Delay_us((<span class="type">uint32_t</span>)(ms * <span class="number">1000</span>)); <span class="comment">// æ™®é€šæ–¹å¼å»¶æ—¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_s</span><span class="params">(<span class="type">uint32_t</span> s)</span></span><br><span class="line">&#123;</span><br><span class="line">    Delay_ms(s * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief å»¶æ—¶ms,ä¸ä¼šå¼•èµ·ä»»åŠ¡è°ƒåº¦</span></span><br><span class="line"><span class="comment"> * @param ms è¦å»¶æ—¶çš„msæ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_xms</span><span class="params">(<span class="type">uint16_t</span> ms)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ms; i++)</span><br><span class="line">        Delay_us(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="è£å‰ªfreertos"><a class="markdownIt-Anchor" href="#è£å‰ªfreertos"></a> è£å‰ªFreeRTOS</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FREERTOS_CONFIG_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREERTOS_CONFIG_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é’ˆå¯¹ä¸åŒçš„ç¼–è¯‘å™¨ï¼Œè°ƒç”¨ä¸åŒçš„stdint.hæ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ICCARM__) || defined(__CC_ARM) || defined(__GNUC__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">uint32_t</span> SystemCoreClock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–­è¨€é…ç½® - ç”¨äºè°ƒè¯•ï¼Œå½“æ¡ä»¶ä¸ºå‡æ—¶åœæ­¢ç¨‹åº</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configASSERT(x)           \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((x) == 0)                 \</span></span><br><span class="line"><span class="meta">    &#123;                             \</span></span><br><span class="line"><span class="meta">        taskDISABLE_INTERRUPTS(); \</span></span><br><span class="line"><span class="meta">        while (1)                 \</span></span><br><span class="line"><span class="meta">            ;                     \</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************</span></span><br><span class="line"><span class="comment"> *               FreeRTOSåŸºç¡€é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment"> *********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è°ƒåº¦å™¨ç±»å‹é€‰æ‹©</span></span><br><span class="line"><span class="comment"> * 1: æŠ¢å å¼è°ƒåº¦å™¨ - é«˜ä¼˜å…ˆçº§ä»»åŠ¡å¯ä»¥æŠ¢å ä½ä¼˜å…ˆçº§ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> * 0: åä½œå¼è°ƒåº¦å™¨ - ä»»åŠ¡å¿…é¡»ä¸»åŠ¨é‡Šæ”¾CPUæ‰èƒ½åˆ‡æ¢</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * æŠ¢å å¼ï¼šå°±åƒæ€¥è¯Šç—…äººå¯ä»¥æ’é˜Ÿï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡ç«‹å³æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> * åä½œå¼ï¼šå°±åƒæ’é˜Ÿï¼Œå¿…é¡»ç­‰å‰é¢çš„äººåŠå®Œäº‹æ‰èƒ½è½®åˆ°ä¸‹ä¸€ä¸ª</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_PREEMPTION 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ—¶é—´ç‰‡è°ƒåº¦</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨æ—¶é—´ç‰‡ - åŒä¼˜å…ˆçº§ä»»åŠ¡è½®æµæ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨æ—¶é—´ç‰‡ - åŒä¼˜å…ˆçº§ä»»åŠ¡éœ€è¦ä¸»åŠ¨è®©å‡ºCPU</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TIME_SLICING 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡é€‰æ‹©ä¼˜åŒ–</span></span><br><span class="line"><span class="comment"> * 1: ä½¿ç”¨ç¡¬ä»¶ä¼˜åŒ– - æ›´å¿«æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> * 0: ä½¿ç”¨è½¯ä»¶æŸ¥æ‰¾ - å…¼å®¹æ€§æ›´å¥½ä½†é€Ÿåº¦è¾ƒæ…¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_PORT_OPTIMISED_TASK_SELECTION 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ— æ»´ç­”ç©ºé—²æ¨¡å¼</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - ç©ºé—²æ—¶åœæ­¢ç³»ç»Ÿæ»´ç­”ï¼Œçœç”µ</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - å§‹ç»ˆä¿æŒç³»ç»Ÿæ»´ç­”è¿è¡Œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TICKLESS_IDLE 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CPUæ—¶é’Ÿé¢‘ç‡</span></span><br><span class="line"><span class="comment"> * å†™å…¥å®é™…çš„CPUä¸»é¢‘ï¼Œç”¨äºè®¡ç®—å»¶æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼š72MHz = 72000000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configCPU_CLOCK_HZ (SystemCoreClock)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç³»ç»Ÿæ»´ç­”é¢‘ç‡</span></span><br><span class="line"><span class="comment"> * æ¯ç§’ä¸­æ–­æ¬¡æ•°ï¼Œå†³å®šä»»åŠ¡è°ƒåº¦çš„ç²¾åº¦</span></span><br><span class="line"><span class="comment"> * 1000 = 1msä¸€æ¬¡ä¸­æ–­ï¼Œç²¾åº¦è¾ƒé«˜</span></span><br><span class="line"><span class="comment"> * 100 = 10msä¸€æ¬¡ä¸­æ–­ï¼Œç²¾åº¦è¾ƒä½ä½†çœç”µ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTICK_RATE_HZ ((TickType_t)1000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€å¤§ä¼˜å…ˆçº§æ•°é‡</span></span><br><span class="line"><span class="comment"> * ä¼˜å…ˆçº§èŒƒå›´ï¼š0 ~ (configMAX_PRIORITIES-1)</span></span><br><span class="line"><span class="comment"> * æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œ0ä¸ºæœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> * å»ºè®®ï¼šæ ¹æ®å®é™…ä»»åŠ¡æ•°é‡è®¾ç½®ï¼Œä¸è¦è®¾ç½®è¿‡å¤§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMAX_PRIORITIES (16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç©ºé—²ä»»åŠ¡æ ˆå¤§å°</span></span><br><span class="line"><span class="comment"> * ç©ºé—²ä»»åŠ¡ç”¨äºç³»ç»Ÿç©ºé—²æ—¶çš„å¤„ç†</span></span><br><span class="line"><span class="comment"> * å•ä½ï¼šå­—ï¼ˆ4å­—èŠ‚ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMINIMAL_STACK_SIZE ((unsigned short)64)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡åç§°æœ€å¤§é•¿åº¦</span></span><br><span class="line"><span class="comment"> * ç”¨äºè°ƒè¯•æ—¶æ˜¾ç¤ºä»»åŠ¡åç§°</span></span><br><span class="line"><span class="comment"> * å»ºè®®ï¼š8-16ä¸ªå­—ç¬¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMAX_TASK_NAME_LEN (12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ»´ç­”è®¡æ•°å™¨æ•°æ®ç±»å‹</span></span><br><span class="line"><span class="comment"> * 1: 16ä½ - æœ€å¤§65535ä¸ªæ»´ç­”ï¼ˆçº¦65ç§’ï¼‰</span></span><br><span class="line"><span class="comment"> * 0: 32ä½ - æœ€å¤§4294967295ä¸ªæ»´ç­”ï¼ˆçº¦49å¤©ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_16_BIT_TICKS 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç©ºé—²ä»»åŠ¡è®©å‡ºCPU</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - ç©ºé—²æ—¶è®©å‡ºCPUç»™åŒä¼˜å…ˆçº§ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - ç©ºé—²ä»»åŠ¡ä¸€ç›´è¿è¡Œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configIDLE_SHOULD_YIELD 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜Ÿåˆ—é›†åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ç­‰å¾…å¤šä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - åªèƒ½ç­‰å¾…å•ä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_QUEUE_SETS 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡é€šçŸ¥åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - è½»é‡çº§ä»»åŠ¡é—´é€šä¿¡</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - åªèƒ½ä½¿ç”¨é˜Ÿåˆ—å’Œä¿¡å·é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TASK_NOTIFICATIONS 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº’æ–¥é‡åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - ç”¨äºä¿æŠ¤å…±äº«èµ„æº</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨äº’æ–¥é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_MUTEXES 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€’å½’äº’æ–¥é‡åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - åŒä¸€ä»»åŠ¡å¯ä»¥å¤šæ¬¡è·å–åŒä¸€ä¸ªäº’æ–¥é‡</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - åªèƒ½è·å–ä¸€æ¬¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_RECURSIVE_MUTEXES 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¡æ•°ä¿¡å·é‡åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - ç”¨äºèµ„æºè®¡æ•°</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨è®¡æ•°ä¿¡å·é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_COUNTING_SEMAPHORES 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº‹ä»¶ç»„åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - ç”¨äºå¤šä»»åŠ¡åŒæ­¥</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨äº‹ä»¶ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_EVENT_GROUPS 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜Ÿåˆ—æ³¨å†Œè¡¨å¤§å°</span></span><br><span class="line"><span class="comment"> * ç”¨äºè°ƒè¯•æ—¶è·Ÿè¸ªé˜Ÿåˆ—å’Œä¿¡å·é‡</span></span><br><span class="line"><span class="comment"> * å»ºè®®ï¼šæ ¹æ®å®é™…ä½¿ç”¨çš„é˜Ÿåˆ—æ•°é‡è®¾ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configQUEUE_REGISTRY_SIZE 6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡æ ‡ç­¾åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä¸ºä»»åŠ¡è®¾ç½®æ ‡ç­¾</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨ä»»åŠ¡æ ‡ç­¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_APPLICATION_TASK_TAG 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************************</span></span><br><span class="line"><span class="comment">              FreeRTOSå†…å­˜ç®¡ç†é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment">*****************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŠ¨æ€å†…å­˜åˆ†é…</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨xTaskCreateç­‰åŠ¨æ€åˆ›å»ºå‡½æ•°</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - åªèƒ½ä½¿ç”¨é™æ€åˆ›å»ºå‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configSUPPORT_DYNAMIC_ALLOCATION 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é™æ€å†…å­˜åˆ†é…</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨xTaskCreateStaticç­‰é™æ€åˆ›å»ºå‡½æ•°</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - åªèƒ½ä½¿ç”¨åŠ¨æ€åˆ›å»ºå‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configSUPPORT_STATIC_ALLOCATION 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å †å†…å­˜å¤§å°</span></span><br><span class="line"><span class="comment"> * ç”¨äºåŠ¨æ€å†…å­˜åˆ†é…ï¼ŒåŒ…æ‹¬ä»»åŠ¡æ ˆã€é˜Ÿåˆ—ç­‰</span></span><br><span class="line"><span class="comment"> * å•ä½ï¼šå­—èŠ‚</span></span><br><span class="line"><span class="comment"> * å»ºè®®ï¼šæ ¹æ®å®é™…å†…å­˜ä½¿ç”¨æƒ…å†µè®¾ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTOTAL_HEAP_SIZE ((size_t)(14 * 1024))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************************************</span></span><br><span class="line"><span class="comment">             FreeRTOSé’©å­å‡½æ•°é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment">**************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç©ºé—²é’©å­å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - ç©ºé—²æ—¶è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - ä¸è°ƒç”¨é’©å­å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_IDLE_HOOK 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ»´ç­”é’©å­å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - æ¯æ¬¡ç³»ç»Ÿæ»´ç­”æ—¶è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - ä¸è°ƒç”¨é’©å­å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TICK_HOOK 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†…å­˜åˆ†é…å¤±è´¥é’©å­å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å†…å­˜åˆ†é…å¤±è´¥æ—¶è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - ä¸è°ƒç”¨é’©å­å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_MALLOC_FAILED_HOOK 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ˆæº¢å‡ºæ£€æŸ¥</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - ä¸æ£€æŸ¥æ ˆæº¢å‡º</span></span><br><span class="line"><span class="comment"> * 1: æ–¹æ³•1 - æ£€æŸ¥æ ˆé¡¶æ˜¯å¦è¢«è¦†ç›–</span></span><br><span class="line"><span class="comment"> * 2: æ–¹æ³•2 - æ£€æŸ¥æ ˆåº•æ˜¯å¦è¢«è¦†ç›–ï¼ˆæ›´ä¸¥æ ¼ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configCHECK_FOR_STACK_OVERFLOW 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************************************</span></span><br><span class="line"><span class="comment">          FreeRTOSè¿è¡Œæ—¶é—´å’Œä»»åŠ¡çŠ¶æ€æ”¶é›†é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿è¡Œæ—¶é—´ç»Ÿè®¡</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ç»Ÿè®¡ä»»åŠ¡è¿è¡Œæ—¶é—´</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - ä¸ç»Ÿè®¡è¿è¡Œæ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configGENERATE_RUN_TIME_STATS 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯è§†åŒ–è·Ÿè¸ªè°ƒè¯•</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - æ”¯æŒFreeRTOS+Traceç­‰è°ƒè¯•å·¥å…·</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - ä¸æ”¯æŒè·Ÿè¸ªè°ƒè¯•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TRACE_FACILITY 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»Ÿè®¡æ ¼å¼åŒ–å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - æä¾›æ ¼å¼åŒ–ç»Ÿè®¡ä¿¡æ¯çš„å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - ä¸æä¾›æ ¼å¼åŒ–å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_STATS_FORMATTING_FUNCTIONS 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************************************</span></span><br><span class="line"><span class="comment">                FreeRTOSåç¨‹é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment">*********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åç¨‹åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨åç¨‹ï¼ˆè½»é‡çº§ä»»åŠ¡ï¼‰</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨åç¨‹</span></span><br><span class="line"><span class="comment"> * æ³¨æ„ï¼šå¯ç”¨åå¿…é¡»æ·»åŠ croutine.cæ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_CO_ROUTINES 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åç¨‹ä¼˜å…ˆçº§æ•°é‡</span></span><br><span class="line"><span class="comment"> * åç¨‹çš„ä¼˜å…ˆçº§èŒƒå›´ï¼š0 ~ (configMAX_CO_ROUTINE_PRIORITIES-1)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMAX_CO_ROUTINE_PRIORITIES (2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">                FreeRTOSè½¯ä»¶å®šæ—¶å™¨é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è½¯ä»¶å®šæ—¶å™¨åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨è½¯ä»¶å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨è½¯ä»¶å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TIMERS 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è½¯ä»¶å®šæ—¶å™¨ä»»åŠ¡ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> * å»ºè®®ï¼šè®¾ç½®ä¸ºè¾ƒé«˜ä¼˜å…ˆçº§ï¼Œç¡®ä¿å®šæ—¶å™¨åŠæ—¶å¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_TASK_PRIORITY (configMAX_PRIORITIES - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è½¯ä»¶å®šæ—¶å™¨é˜Ÿåˆ—é•¿åº¦</span></span><br><span class="line"><span class="comment"> * ç”¨äºå­˜å‚¨å®šæ—¶å™¨å‘½ä»¤çš„é˜Ÿåˆ—å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_QUEUE_LENGTH 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è½¯ä»¶å®šæ—¶å™¨ä»»åŠ¡æ ˆå¤§å°</span></span><br><span class="line"><span class="comment"> * è½¯ä»¶å®šæ—¶å™¨æœåŠ¡ä»»åŠ¡çš„æ ˆå¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_TASK_STACK_DEPTH (configMINIMAL_STACK_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">            FreeRTOSå¯é€‰å‡½æ•°é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment">************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡è°ƒåº¦å™¨çŠ¶æ€æŸ¥è¯¢å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨xTaskGetSchedulerState()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•æŸ¥è¯¢è°ƒåº¦å™¨çŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_xTaskGetSchedulerState 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡ä¼˜å…ˆçº§è®¾ç½®å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨vTaskPrioritySet()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•åŠ¨æ€ä¿®æ”¹ä»»åŠ¡ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskPrioritySet 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡ä¼˜å…ˆçº§è·å–å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨uxTaskPriorityGet()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•è·å–ä»»åŠ¡ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_uxTaskPriorityGet 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡åˆ é™¤å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨vTaskDelete()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•åˆ é™¤ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskDelete 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡æ¸…ç†èµ„æºå‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨vTaskCleanUpResources()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•æ¸…ç†ä»»åŠ¡èµ„æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskCleanUpResources 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡æŒ‚èµ·å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨vTaskSuspend()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•æŒ‚èµ·ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskSuspend 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡å»¶æ—¶ç›´åˆ°æŒ‡å®šæ—¶é—´å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨vTaskDelayUntil()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨ç»å¯¹å»¶æ—¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskDelayUntil 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡å»¶æ—¶å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨vTaskDelay()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨ç›¸å¯¹å»¶æ—¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskDelay 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡çŠ¶æ€è·å–å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨eTaskGetState()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•è·å–ä»»åŠ¡çŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_eTaskGetState 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šæ—¶å™¨æŒ‚èµ·å‡½æ•°è°ƒç”¨</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨xTimerPendFunctionCall()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•ä½¿ç”¨å®šæ—¶å™¨æŒ‚èµ·å‡½æ•°è°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_xTimerPendFunctionCall 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡æ ˆé«˜æ°´ä½æ ‡è®°å‡½æ•°</span></span><br><span class="line"><span class="comment"> * 1: å¯ç”¨ - å¯ä»¥ä½¿ç”¨uxTaskGetStackHighWaterMark()</span></span><br><span class="line"><span class="comment"> * 0: ç¦ç”¨ - æ— æ³•æ£€æŸ¥æ ˆä½¿ç”¨æƒ…å†µ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_uxTaskGetStackHighWaterMark 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************</span></span><br><span class="line"><span class="comment">            FreeRTOSä¸­æ–­é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment">******************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸­æ–­ä¼˜å…ˆçº§ä½æ•°</span></span><br><span class="line"><span class="comment"> * STM32F103ä½¿ç”¨4ä½ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __NVIC_PRIO_BITS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configPRIO_BITS __NVIC_PRIO_BITS</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configPRIO_BITS 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸­æ–­æœ€ä½ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> * æ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šä½</span></span><br><span class="line"><span class="comment"> * 15 = æœ€ä½ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configLIBRARY_LOWEST_INTERRUPT_PRIORITY 15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç³»ç»Ÿå¯ç®¡ç†çš„æœ€é«˜ä¸­æ–­ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> * æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span></span><br><span class="line"><span class="comment"> * 1 = è¾ƒé«˜ä¼˜å…ˆçº§ï¼Œå¯ä»¥è¢«FreeRTOSç®¡ç†</span></span><br><span class="line"><span class="comment"> * 0 = æœ€é«˜ä¼˜å…ˆçº§ï¼Œä¸èƒ½è¢«FreeRTOSç®¡ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†…æ ¸ä¸­æ–­ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> * ç”¨äºFreeRTOSå†…æ ¸çš„ä¸­æ–­ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configKERNEL_INTERRUPT_PRIORITY (configLIBRARY_LOWEST_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS)) <span class="comment">/* 240 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç³»ç»Ÿè°ƒç”¨æœ€é«˜ä¸­æ–­ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> * å¯ä»¥è¢«FreeRTOSç®¡ç†çš„ä¸­æ–­æœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMAX_SYSCALL_INTERRUPT_PRIORITY (configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************</span></span><br><span class="line"><span class="comment">            FreeRTOSä¸­æ–­æœåŠ¡å‡½æ•°é…ç½®é€‰é¡¹</span></span><br><span class="line"><span class="comment">****************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PendSVä¸­æ–­å¤„ç†å‡½æ•°æ˜ å°„</span></span><br><span class="line"><span class="comment"> * ç”¨äºä»»åŠ¡åˆ‡æ¢çš„ä¸­æ–­å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> xPortPendSVHandler PendSV_Handler</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SVCä¸­æ–­å¤„ç†å‡½æ•°æ˜ å°„</span></span><br><span class="line"><span class="comment"> * ç”¨äºå¯åŠ¨ç¬¬ä¸€ä¸ªä»»åŠ¡çš„ä¸­æ–­å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vPortSVCHandler SVC_Handler</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* FREERTOS_CONFIG_H */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>èµ·åºŠäº†å†æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰èµ·åºŠï¼Œé‚£å¤§æ¦‚æ˜¯å¤ªå¿™äº†ã€‚ã€‚ã€‚ã€‚</p>
<p>0727 â€” 3:54</p>
]]></content>
      <categories>
        <category>é¡¹ç›®</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>é¡¹ç›®</tag>
        <tag>Bootloader</tag>
        <tag>FreeRTOS</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºESP32S3çš„æ™ºèƒ½ç»ˆç«¯ç³»ç»Ÿ</title>
    <url>/2025/02/22/%E5%9F%BA%E4%BA%8EESP32%E7%9A%84%E6%99%BA%E8%83%BD%E7%BB%88%E7%AB%AF%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h1 id="å®ç‰©"><a class="markdownIt-Anchor" href="#å®ç‰©"></a> å®ç‰©</h1>
<p>æš‚æ—¶æ²¡ç©ºï¼Œåç»­æ•´ç†ã€‚</p>
]]></content>
      <categories>
        <category>é¡¹ç›®</category>
      </categories>
      <tags>
        <tag>é¡¹ç›®</tag>
        <tag>ESP32</tag>
        <tag>LVGL</tag>
        <tag>ç‰©è”ç½‘</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºSTM32F103çš„æ™ºèƒ½å¹³è¡¡è½¦</title>
    <url>/2024/10/22/%E5%9F%BA%E4%BA%8ESTM32%E7%9A%84%E6%99%BA%E8%83%BD%E5%B9%B3%E8%A1%A1%E8%BD%A6/</url>
    <content><![CDATA[<p>ä¸»è¦å®ç°åŸºäºSTM32F103C8T6çš„HALåº“ç¼–ç¨‹PIDå¹³è¡¡è½¦é¡¹ç›®ã€‚</p>
<h3 id="å®ç‰©"><a class="markdownIt-Anchor" href="#å®ç‰©"></a> å®ç‰©</h3>
<img src="https://s2.loli.net/2025/05/07/TxMlaK1JXH9bkht.png" style="zoom: 50%;" />
<img src="https://s2.loli.net/2025/05/07/mQK57dbLgnp2hDH.png" style="zoom: 67%;" />
<h3 id="stm32-cubemxé…ç½®"><a class="markdownIt-Anchor" href="#stm32-cubemxé…ç½®"></a> STM32 CubeMXé…ç½®</h3>
<img src="https://s2.loli.net/2025/05/07/WnLqhDk8pCvemtO.png" style="zoom:67%;" />
<p>ä½¿ç”¨å¤–éƒ¨é«˜é€Ÿæ—¶é’Ÿ8MHzï¼Œé€šè¿‡PLLå€é¢‘åˆ°72MHzã€‚</p>
<p>RCC----&gt;HSEã€LSE = Crystal/Ceramic Resonatorï¼ˆæ™¶æŒ¯ï¼‰----&gt;HCLK = 72MHz</p>
<h3 id="ç‚¹äº®led"><a class="markdownIt-Anchor" href="#ç‚¹äº®led"></a> ç‚¹äº®LED</h3>
<table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">IO</th>
<th style="text-align:center">HALé…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">LED</td>
<td style="text-align:center">PC13</td>
<td style="text-align:center">GPIO_OUTPUT</td>
</tr>
</tbody>
</table>
<p>SYS----&gt;Debug = Serial Wire(ä¸‹è½½å™¨å°±æ˜¯ç”¨çš„SWæ–¹å¼)</p>
<p>Keilä¸­ï¼šHAL_GPIO_Write(GPIOC, GPIO_PIN_13, GPIO_PIN_SET);</p>
<h3 id="oled"><a class="markdownIt-Anchor" href="#oled"></a> OLED</h3>
<p>å±çš„å¤§å°ä¸º0.96å¯¸ï¼Œåƒç´ ç‚¹ä¸º128*64ã€‚</p>
<p>4PINåˆ†åˆ«ä¸ºGNDã€VCC(3.3V/5V)ã€SCL(IICçš„æ—¶é’Ÿä¿¡å·)ã€SDA(IICçš„æ•°æ®æ€»çº¿)ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">IO</th>
<th style="text-align:center">HALé…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">I2C1_SDA</td>
<td style="text-align:center">PB9</td>
<td style="text-align:center">I2C1_SCL,ODæ¨¡å¼</td>
</tr>
<tr>
<td style="text-align:center">I2C1_SCL</td>
<td style="text-align:center">PB8</td>
<td style="text-align:center">I2C1_SDA,ODæ¨¡å¼</td>
</tr>
</tbody>
</table>
<h4 id="iic"><a class="markdownIt-Anchor" href="#iic"></a> IIC</h4>
<p><strong>ç¡¬ä»¶IICï¼šä¸Šæ‹‰è¾“å…¥ï¼Œå¼€æ¼è¾“å‡ºã€‚</strong>(ç›´æ¥ç”¨STM32çš„çœŸå®å¤–è®¾)</p>
<p><strong>è½¯ä»¶IICï¼šä¸Šæ‹‰è¾“å…¥ï¼Œæ¨æŒ½/å¼€æ¼è¾“å‡ºã€‚</strong>ï¼ˆGPIOå®ç°æ—¶åºï¼‰</p>
<p>IICæ”¯æŒä¸€ä¸»å¤šä»ï¼ŒåŒæ­¥ï¼ŒåŠåŒå·¥ï¼Œæ¯ä¸ªä»æœºéƒ½æœ‰å…¶è®¾å¤‡åœ°å€ã€‚</p>
<p><strong>èµ·å§‹ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»é«˜ç”µå¹³è·³åˆ°ä½ç”µå¹³</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">IIC_Start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* å½“SCLé«˜ç”µå¹³æ—¶ï¼ŒSDAå‡ºç°ä¸€ä¸ªä¸‹è·³æ²¿è¡¨ç¤ºIICæ€»çº¿å¯åŠ¨ä¿¡å· */</span></span><br><span class="line">    IIC_SDA_1();</span><br><span class="line">    IIC_SCL_1();</span><br><span class="line">    IIC_Delay();</span><br><span class="line">    IIC_SDA_0();</span><br><span class="line">    IIC_Delay();</span><br><span class="line">    IIC_SCL_0();</span><br><span class="line">    IIC_Delay();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åœæ­¢ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»ä½ç”µå¹³è·³åˆ°é«˜ç”µå¹³</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">IIC_Stop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* å½“SCLé«˜ç”µå¹³æ—¶ï¼ŒSDAå‡ºç°ä¸€ä¸ªä¸Šè·³æ²¿è¡¨ç¤ºIICæ€»çº¿åœæ­¢ä¿¡å· */</span></span><br><span class="line">    IIC_SDA_0();</span><br><span class="line">    IIC_SCL_1();</span><br><span class="line">    IIC_Delay();</span><br><span class="line">    IIC_SDA_1();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ACKä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä¸º<strong>ä½ï¼ˆACKï¼‰</strong>ï¼ŒSDAä¸º<strong>é«˜ï¼ˆNACKï¼‰</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">IIC_Ack</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IIC_SDA_0();	<span class="comment">/* CPUé©±åŠ¨SDA = 0 */</span></span><br><span class="line">    IIC_Delay();</span><br><span class="line">    IIC_SCL_1();	<span class="comment">/* CPUäº§ç”Ÿ1ä¸ªæ—¶é’Ÿ */</span></span><br><span class="line">    IIC_Delay();</span><br><span class="line">    IIC_SCL_0();</span><br><span class="line">    IIC_Delay();</span><br><span class="line">    IIC_SDA_1();	<span class="comment">/* CPUé‡Šæ”¾SDAæ€»çº¿ */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">IIC_NAck</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IIC_SDA_1();	<span class="comment">/* CPUé©±åŠ¨SDA = 1 */</span></span><br><span class="line">    IIC_Delay();</span><br><span class="line">    IIC_SCL_1();	<span class="comment">/* CPUäº§ç”Ÿ1ä¸ªæ—¶é’Ÿ */</span></span><br><span class="line">    IIC_Delay();</span><br><span class="line">    IIC_SCL_0();</span><br><span class="line">    IIC_Delay();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å–æ¨¡è½¯ä»¶pctolcd"><a class="markdownIt-Anchor" href="#å–æ¨¡è½¯ä»¶pctolcd"></a> å–æ¨¡è½¯ä»¶ï¼ˆPCtoLCDï¼‰</h4>
<p>è®¾ç½®ï¼šâ€œå®‹ä½“â€ï¼Œ 16 * 16ï¼Œé˜´ç ï¼Œåˆ—è¡Œå¼ï¼Œé€†å‘ï¼Œå†ä¿®æ”¹å‰ç¼€ã€‚</p>
<p><img src="https://s2.loli.net/2025/05/07/p7LobrlzdxPy6wW.png" alt="" /></p>
<h3 id="mpu6050"><a class="markdownIt-Anchor" href="#mpu6050"></a> MPU6050</h3>
<p><strong>MPU6050ä¼ æ„Ÿå™¨</strong>å¯ä»¥åŒæ—¶æ£€æµ‹å‡º<strong>ä¸‰è½´åŠ é€Ÿåº¦</strong>ã€<strong>ä¸‰è½´è§’é€Ÿåº¦</strong>ä»¥åŠæ¸©åº¦æ•°æ®ï¼Œ<strong>å†…éƒ¨</strong>é›†æˆ<strong>DMP</strong>ï¼ˆDigital Motion Processoræ•°å­—è¿åŠ¨å¤„ç†å™¨ï¼‰æ¨¡å—ï¼Œå¯ä»¥å®ç°<strong>æ»¤æ³¢</strong>ã€èåˆå¤„ç†ã€‚</p>
<p>ç»•IMUçš„Zè½´æ—‹è½¬ï¼šèˆªå‘è§’yawï¼Œè½¬åŠ¨yè§’åº¦</p>
<p>ç»•IMUçš„Yè½´æ—‹è½¬ï¼šèˆªå‘è§’pitchï¼Œè½¬åŠ¨pè§’åº¦</p>
<p>ç»•IMUçš„Xè½´æ—‹è½¬ï¼šèˆªå‘è§’rowï¼Œè½¬åŠ¨rè§’åº¦</p>
<p><strong>é€šè¿‡IICé€šä¿¡</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">IO</th>
<th style="text-align:center">HALé…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SDA</td>
<td style="text-align:center">PB3</td>
<td style="text-align:center">GPIO_OUTPUT</td>
</tr>
<tr>
<td style="text-align:center">SCL</td>
<td style="text-align:center">PB4</td>
<td style="text-align:center">GPIO_OUTPUT</td>
</tr>
<tr>
<td style="text-align:center">INT</td>
<td style="text-align:center">PB5</td>
<td style="text-align:center">GPIO_EXIT5</td>
</tr>
</tbody>
</table>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">float</span> pitch, roll, yaw;</span><br><span class="line"><span class="type">uint8_t</span> display_buf[<span class="number">20</span>];</span><br><span class="line">mpu_dmp_get_data(&amp;pitch, &amp;roll, &amp;yaw);</span><br><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span>*)display_buf, <span class="string">&quot;row:%.2f&quot;</span>,row);</span><br></pre></td></tr></table></figure>
<p><em><strong>TIP:ä¸ç”¨å¼€æ¼çš„åŸå› æ˜¯MPU6050å†…éƒ¨æœ‰ä¸Šæ‹‰ç”µé˜»ã€‚</strong></em></p>
<p>MPU6050å¦‚æœæ²¡æ”¾å¹³ç¨³ï¼Œè‡ªæ£€æµ‹åå‡ºç°returnï¼Œå¯¼è‡´å¤±æ•ˆï¼›æ³¨é‡Šæ‰å…¶è‡ªæ£€åçš„returnï¼Œå¯ä¸´æ—¶è§£å†³é—®é¢˜</p>
<img src="https://s2.loli.net/2025/05/09/EGamhDHOqgJVLF9.png" style="zoom: 80%;" />
<h3 id="è¶…å£°æ³¢"><a class="markdownIt-Anchor" href="#è¶…å£°æ³¢"></a> è¶…å£°æ³¢</h3>
<p><strong>HC-SR04 è¶…å£°æ³¢æµ‹è·æ¨¡å—</strong>å¯æä¾›<code>2cm-400cm</code>çš„éæ¥è§¦å¼è·ç¦»æ„Ÿæµ‹åŠŸèƒ½ï¼Œç²¾åº¦å¯è¾¾åˆ°3mmï¼Œæ¨¡å—åŒ…æ‹¬<strong>è¶…å£°æ³¢å‘å°„å™¨ã€æ¥æ”¶å™¨å’Œæ§åˆ¶ç”µè·¯</strong>ã€‚</p>
<h4 id="å·¥ä½œåŸç†"><a class="markdownIt-Anchor" href="#å·¥ä½œåŸç†"></a> å·¥ä½œåŸç†</h4>
<table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:center">IO</th>
<th style="text-align:right">HALé…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">TRIGï¼ˆè¾“å…¥è§¦å‘ï¼Œæµ‹è·ï¼‰</td>
<td style="text-align:center">PA3</td>
<td style="text-align:right">GPIO_OUTPUT</td>
</tr>
<tr>
<td style="text-align:left">ECHOï¼ˆä¼ å›ä¿¡å·ã€è®¡ç®—æ—¶é—´å·®ï¼‰</td>
<td style="text-align:center">PA2</td>
<td style="text-align:right">GPIO_EXTI2(å¤–éƒ¨ä¸­æ–­2)ï¼ŒTIM3è®¡æ•°</td>
</tr>
</tbody>
</table>
<p><em>TIPï¼šä¸ºä»€ä¹ˆä¸Šå‡æ²¿å’Œä¸‹é™æ²¿éƒ½ä¸­æ–­ï¼ˆ<strong>ä¸Šå‡æ—¶å¼€å§‹è®¡æ—¶ï¼Œä¸‹é™æ—¶ç»“æŸè®¡æ—¶</strong>ï¼‰ã€‚</em></p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>a</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>C</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo>=</mo><mfrac><mrow><mi>H</mi><mi>C</mi><mi>L</mi><mi>K</mi></mrow><mrow><mi>P</mi><mi>S</mi><mi>C</mi><mo>+</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">
Internal\_Clock=\frac{HCLK}{PSC + 1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">na</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">Cl</span><span class="mord mathnormal">oc</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1297em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">PSC</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>NVIC----&gt;EXTI line2 interrupt = ENABLE</p>
<p><strong>TIM3----&gt;PSC = 71ï¼Œ1MHz = 1us</strong></p>
<p>ä½¿ç”¨çš„è‡ªåŠ¨é‡è½½å™¨ARRæ˜¯16ä½ï¼Œå› æ­¤65535us=0.065535sï¼Œå†ä¹˜ä¸Š340m/s  / 2è¿œè¿œè¶…è¿‡4mï¼Œå¯ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1ã€IOå£TRIGè§¦å‘æµ‹è·ï¼Œç»™æœ€å°‘10usçš„é«˜ç”µå¹³ä¿¡å‘ˆ</span></span><br><span class="line"><span class="comment">//2ã€æ¨¡å—è‡ªåŠ¨å‘é€8ä¸ª40KHzçš„æ–¹æ³¢ï¼Œè‡ªåŠ¨æ£€æµ‹ä¿¡å·æ˜¯å¦è¿”å›</span></span><br><span class="line"><span class="comment">//3ã€æœ‰ä¿¡å·è¿”å›ï¼Œé€šè¿‡IOå£ECHOè¾“å‡ºä¸€ä¸ªé«˜ç”µå¹³ï¼Œé«˜ç”µå¹³æŒç»­çš„æ—¶é—´æ˜¯è¶…å£°æ³¢ä»å‘é€åˆ°è¿”å›çš„æ—¶é—´</span></span><br><span class="line"><span class="comment">//æµ‹è¯•è·ç¦» = (é«˜ç”µå¹³æ—¶é—´ * å£°é€Ÿ (340m/s) / 2</span></span><br><span class="line"><span class="comment">//æµ‹é‡å‘¨æœŸ &gt; 60msï¼Œé˜²æ­¢ä¸Šä¸€ä¸ªè¶…å£°æ³¢ä¸ç°åœ¨çš„æœ‰å¹²æ‰°</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint16_t</span> count;</span><br><span class="line"><span class="type">float</span> distance;</span><br><span class="line"><span class="keyword">extern</span> TIM_HandleTypeDef htim3;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è§¦å‘ä¿¡å·ï¼Œè·å–è·ç¦»</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Get_Dist</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_3, GPIO_PIN_SET);			<span class="comment">//è®¾ç½®Trigå¼€å¯</span></span><br><span class="line">	RCCdelay_us(<span class="number">12</span>);</span><br><span class="line">	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_3, GPIO_PIN_RESET);		<span class="comment">//è®¾ç½®Trigå…³é—­</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¤–éƒ¨ä¸­æ–­2å’Œä¸­æ–­5å‡½æ•°é‡å†™ï¼Œé€šè¿‡PINå£åˆ¤æ–­</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == GPIO_PIN_5)</span><br><span class="line">	&#123;</span><br><span class="line">		Control();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == GPIO_PIN_2)									<span class="comment">//æ­¤ä¸ºè¶…å£°æ³¢æ¥æ”¶åˆ°ä¿¡å·</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_2)==GPIO_PIN_SET)	<span class="comment">//Trigå¼€å¯</span></span><br><span class="line">		&#123;</span><br><span class="line">			__HAL_TIM_SetCounter(&amp;htim3, <span class="number">0</span>);					<span class="comment">//è®¾ç½®htim3å®šæ—¶å™¨å€¼ä¸º0</span></span><br><span class="line">			HAL_TIM_Base_Start(&amp;htim3);							<span class="comment">//å¼€å¯htim3å®šæ—¶å™¨</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>													<span class="comment">//Trigå…³é—­</span></span><br><span class="line">		&#123;</span><br><span class="line">			HAL_TIM_Base_Stop(&amp;htim3);							<span class="comment">//åœæ­¢htim3å®šæ—¶å™¨</span></span><br><span class="line">			count = __HAL_TIM_GetCounter(&amp;htim3);				<span class="comment">//è·å–å…¶å€¼</span></span><br><span class="line">			distance = count * <span class="number">0.017</span>;							<span class="comment">//è®¡ç®—è·ç¦»</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è®¡æ—¶å‡½æ•°ï¼Œä½¿ç”¨ç½‘ä¸Šåˆ«äººå†™çš„</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RCCdelay_us</span><span class="params">(<span class="type">uint32_t</span> udelay)</span></span><br><span class="line">&#123;</span><br><span class="line">	__IO <span class="type">uint32_t</span> Delay = udelay * <span class="number">72</span> / <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		__NOP();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>(Delay--);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç”µæœºé©±åŠ¨"><a class="markdownIt-Anchor" href="#ç”µæœºé©±åŠ¨"></a> ç”µæœºé©±åŠ¨</h3>
<h4 id="tb6612ç”µæœº"><a class="markdownIt-Anchor" href="#tb6612ç”µæœº"></a> TB6612ç”µæœº</h4>
<table>
<thead>
<tr>
<th style="text-align:center">IN1</th>
<th style="text-align:center">IN2</th>
<th style="text-align:center">ç›´æµç”µæœºçš„çŠ¶æ€</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">åˆ¶åŠ¨</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">æ­£è½¬</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">åè½¬</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">åˆ¶åŠ¨</td>
</tr>
</tbody>
</table>
<h4 id="pwm"><a class="markdownIt-Anchor" href="#pwm"></a> PWM</h4>
<p>å…¨ç§°<strong>Pulse Width Modulation</strong>(è„‰å®½è°ƒåˆ¶)ï¼›å®è´¨æ˜¯åœ¨ä¸€ä¸ªæ–¹æ³¢ä¸­ï¼Œé«˜ç”µå¹³çš„å æ¯”ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">IO</th>
<th style="text-align:center">HALé…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">PWMA</td>
<td style="text-align:center">PA11</td>
<td style="text-align:center">TIM1_CH4ï¼ŒPulse = 7200</td>
</tr>
<tr>
<td style="text-align:center">AIN2</td>
<td style="text-align:center">PB12</td>
<td style="text-align:center">GPIO_OUTPUT</td>
</tr>
<tr>
<td style="text-align:center">AIN1</td>
<td style="text-align:center">PB13</td>
<td style="text-align:center">GPIO_OUTPUT</td>
</tr>
<tr>
<td style="text-align:center">BIN1</td>
<td style="text-align:center">PB14</td>
<td style="text-align:center">GPIO_OUTPUT</td>
</tr>
<tr>
<td style="text-align:center">BIN2</td>
<td style="text-align:center">PB15</td>
<td style="text-align:center">GPIO_OUTPUT</td>
</tr>
<tr>
<td style="text-align:center">PWMB</td>
<td style="text-align:center">PA8</td>
<td style="text-align:center">TIM1_CH1ï¼ŒPulse = 7200</td>
</tr>
</tbody>
</table>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mspace linebreak="newline"></mspace><mi>P</mi><mi>W</mi><mi>M</mi><mtext>çš„é¢‘ç‡</mtext><mi>f</mi><mo>=</mo><mfrac><mrow><mi>H</mi><mi>C</mi><mi>L</mi><mi>K</mi></mrow><mrow><mo stretchy="false">(</mo><mi>P</mi><mi>S</mi><mi>C</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>A</mi><mi>R</mi><mi>R</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mtext>å ç©ºæ¯”</mtext><mi>D</mi><mi>u</mi><mi>t</mi><mi>y</mi><mo>=</mo><mfrac><mrow><mi>P</mi><mi>u</mi><mi>l</mi><mi>s</mi><mi>e</mi></mrow><mrow><mi>A</mi><mi>R</mi><mi>R</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mi>f</mi><mo>=</mo><mn>10</mn><mi>K</mi><mi>H</mi><mi>z</mi><mtext>ï¼Œ</mtext><mi>H</mi><mi>C</mi><mi>L</mi><mi>K</mi><mo>=</mo><mn>72</mn><mi>M</mi><mi>H</mi><mi>z</mi><mtext>ï¼Œåˆ™</mtext><mi>P</mi><mi>S</mi><mi>C</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mi>A</mi><mi>R</mi><mi>R</mi><mo>=</mo><mn>7199</mn><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex">
\\
PWMçš„é¢‘ç‡f = \frac{HCLK}{(PSC + 1)(ARR + 1)}\\
\\
å ç©ºæ¯”Duty=\frac{Pulse}{ARR + 1}\\
\\
f=10KHzï¼ŒHCLK=72MHzï¼Œåˆ™PSC=1,ARR=7199 \\
\\
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord cjk_fallback">çš„é¢‘ç‡</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">PSC</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">RR</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord cjk_fallback">å ç©ºæ¯”</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1408em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">RR</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">se</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">10</span><span class="mord mathnormal" style="margin-right:0.04398em;">KHz</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">72</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.04398em;">Hz</span><span class="mord cjk_fallback">ï¼Œåˆ™</span><span class="mord mathnormal" style="margin-right:0.07153em;">PSC</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">RR</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">7199</span></span><span class="mspace newline"></span><span class="mspace newline"></span></span></span></span>
<h4 id="å®ç°å‡½æ•°"><a class="markdownIt-Anchor" href="#å®ç°å‡½æ•°"></a> å®ç°å‡½æ•°</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å ç©ºæ¯”è®¾ç½®</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_MAX 7200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_MIN -7200</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Load</span><span class="params">(<span class="type">int</span> motorL, <span class="type">int</span> motorR)</span>			<span class="comment">//-7200 ---- 7200</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(motorL &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		HAL_GPIO_WritePin(GPIOB, GPIO_PIN_13, GPIO_PIN_SET);</span><br><span class="line">		HAL_GPIO_WritePin(GPIOB, GPIO_PIN_12, GPIO_PIN_RESET);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		HAL_GPIO_WritePin(GPIOB, GPIO_PIN_13, GPIO_PIN_RESET);</span><br><span class="line">		HAL_GPIO_WritePin(GPIOB, GPIO_PIN_12, GPIO_PIN_SET);</span><br><span class="line">	&#125;</span><br><span class="line">	__HAL_TIM_SetCompare(&amp;htim1, TIM_CHANNEL_4, <span class="built_in">abs</span>(motorL));		<span class="comment">//åŠ è½½å ç©ºæ¯”</span></span><br><span class="line">	<span class="keyword">if</span>(motorR &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		HAL_GPIO_WritePin(GPIOB, GPIO_PIN_14, GPIO_PIN_SET);</span><br><span class="line">		HAL_GPIO_WritePin(GPIOB, GPIO_PIN_15, GPIO_PIN_RESET);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		HAL_GPIO_WritePin(GPIOB, GPIO_PIN_14, GPIO_PIN_RESET);</span><br><span class="line">		HAL_GPIO_WritePin(GPIOB, GPIO_PIN_15, GPIO_PIN_SET);</span><br><span class="line">	&#125;</span><br><span class="line">	__HAL_TIM_SetCompare(&amp;htim1, TIM_CHANNEL_1, <span class="built_in">abs</span>(motorL));		<span class="comment">//åŠ è½½å ç©ºæ¯”</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// éœ€è¦é™å¹…ï¼Œé˜²æ­¢è·‘é£</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Limit</span><span class="params">(<span class="type">int</span> *Motor1, <span class="type">int</span>* Motor2)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(*Motor1 &gt; PWM_MAX) *Motor1 = PWM_MAX;</span><br><span class="line">	<span class="keyword">if</span>(*Motor1 &lt; PWM_MIN) *Motor1 = PWM_MIN;</span><br><span class="line">	<span class="keyword">if</span>(*Motor2 &gt; PWM_MAX) *Motor2 = PWM_MAX;</span><br><span class="line">	<span class="keyword">if</span>(*Motor2 &lt; PWM_MIN) *Motor2 = PWM_MIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¼–ç å™¨"><a class="markdownIt-Anchor" href="#ç¼–ç å™¨"></a> ç¼–ç å™¨</h3>
<p>é€Ÿåº¦é€šè¿‡è„‰å†²æ³¢çš„æ–¹å¼æµ‹é‡ï¼Œæ—‹è½¬ä¸€åœˆ11ä¸ªè„‰å†²ï¼›ä¸¤ä¸ªéœå°”ä¼ æ„Ÿå™¨<strong>Aç›¸ã€Bç›¸ï¼Œå¯ä»¥åˆ¤æ–­æ—‹è½¬æ–¹å‘</strong>ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">IO</th>
<th style="text-align:center">HALé…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ç¼–ç å™¨1</td>
<td style="text-align:center">PA0ã€PA1</td>
<td style="text-align:center">TIM2â€”Encoder Mode TI1 and TI2</td>
</tr>
<tr>
<td style="text-align:center">ç¼–ç å™¨2</td>
<td style="text-align:center">PB6ã€PB7</td>
<td style="text-align:center">TIM4â€”Encoder Mode TI1 and TI2</td>
</tr>
</tbody>
</table>
<p>Encoder Mode TI1åªè®¡ç®—Aç›¸ä¸Šå‡æ²¿</p>
<p>Encoder Mode TI2åªè®¡ç®—Bç›¸ä¸Šå‡æ²¿</p>
<p>Encoder Mode TI1 and TI2ä¸Šå‡æ²¿å°±è®¡ç®—</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Read_Speed</span><span class="params">(TIM_HandleTypeDef* htim)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> tmp;</span><br><span class="line">	<span class="comment">// </span></span><br><span class="line">	tmp = (<span class="type">short</span>)__HAL_TIM_GetCounter(htim);</span><br><span class="line">	__HAL_TIM_SetCounter(htim, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”¨ç³»ç»Ÿè‡ªå¸¦uwTickï¼ˆ1sè‡ªåŠ ï¼‰æ¯10msè¯»å–æ•°å€¼</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Read</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(uwTick-sys_tic&lt;<span class="number">10</span>)			</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	sys_tic=uwTick;</span><br><span class="line">	Encoder_Left = Read_Speed(&amp;htim2);					<span class="comment">//è¯»å–htim2çš„å€¼</span></span><br><span class="line">	Encoder_Right = -Read_Speed(&amp;htim4);				<span class="comment">//è¯»å–htim4çš„å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em><strong>TIPï¼šç¼–ç å™¨ä¸ä¼šå‡ºç°è´Ÿæ•°ï¼Œ16ä½----&gt;-32768~32767ï¼Œéœ€è¦ç”¨shortå‹ï¼Œæ­£æ•°ä¸ºnï¼Œè´Ÿæ•°ä¸º32767 - nã€‚</strong></em></p>
<h3 id="è“ç‰™"><a class="markdownIt-Anchor" href="#è“ç‰™"></a> è“ç‰™</h3>
<p>ä½¿ç”¨<strong>JDY-31è“ç‰™æ¨¡å—ï¼ˆä»æœºï¼‰</strong>ï¼Œé€šè¿‡è“ç‰™è½¬ä¸²å£é€šä¿¡ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">IO</th>
<th style="text-align:center">HALé…ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">RXD</td>
<td style="text-align:center">PB10</td>
<td style="text-align:center">USART3_TX</td>
</tr>
<tr>
<td style="text-align:center">TXD</td>
<td style="text-align:center">PB11</td>
<td style="text-align:center">USART3_RX</td>
</tr>
</tbody>
</table>
<p>USART3è®¾ç½®MODE = Asynchronousï¼Œæ³¢ç‰¹ç‡ä½9600Bits/sï¼Œ8ä½ï¼Œæ— æ ¡éªŒä½ï¼Œåœæ­¢ä½1ä½</p>
<p>USART3 global interrupt = ENABLE</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">uint8_t</span> rx_buf[<span class="number">2</span>];</span><br><span class="line">HAL_UART_Receive_IT(&amp;huart3, rx_buf, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// USART3ä¸­æ–­å‡½æ•°ï¼Œå°ç«¯å­˜å‚¨</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">USART3_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	HAL_UART_IRQHandler(&amp;huart3);</span><br><span class="line">	Bluetooth_data = rx_buf[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">if</span>(Bluetooth_data == <span class="number">0x00</span>) 		Fore=<span class="number">0</span>,Back=<span class="number">0</span>,Left=<span class="number">0</span>,Right=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Bluetooth_data == <span class="number">0x01</span>) Fore=<span class="number">1</span>,Back=<span class="number">0</span>,Left=<span class="number">0</span>,Right=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Bluetooth_data == <span class="number">0x05</span>) Fore=<span class="number">0</span>,Back=<span class="number">1</span>,Left=<span class="number">0</span>,Right=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Bluetooth_data == <span class="number">0x03</span>) Fore=<span class="number">0</span>,Back=<span class="number">0</span>,Left=<span class="number">0</span>,Right=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Bluetooth_data == <span class="number">0x07</span>) Fore=<span class="number">0</span>,Back=<span class="number">0</span>,Left=<span class="number">1</span>,Right=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span>														Fore=<span class="number">0</span>,Back=<span class="number">0</span>,Left=<span class="number">0</span>,Right=<span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//HAL_UART_Transmit(&amp;huart3, rx_buf, 1, 1000);</span></span><br><span class="line">	HAL_UART_Receive_IT(&amp;huart3, rx_buf, <span class="number">1</span>);</span><br><span class="line">  <span class="comment">/* USER CODE END USART3_IRQn 1 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="pid"><a class="markdownIt-Anchor" href="#pid"></a> PID</h3>
<h4 id="åŸç†"><a class="markdownIt-Anchor" href="#åŸç†"></a> åŸç†</h4>
<p><img src="https://s2.loli.net/2025/05/07/mRJjfuqcPXVnWY1.png" alt="" /></p>
<p>æœ¬é¡¹ç›®ä½¿ç”¨ä¸²çº§PIDï¼Œ<strong>é€Ÿåº¦ç¯PI+ç›´ç«‹ç¯PD</strong>ã€‚</p>
<img src="https://s2.loli.net/2025/05/07/ost2fcr4yH5AkqT.png" style="zoom:67%;" />
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Î¸</mi><mtext>ä¸ºå½“å‰å°è½¦çš„å€¾è§’</mtext><mspace linebreak="newline"></mspace><msup><mi>Î¸</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">â€²</mo></msup></msup><mtext>ä¸ºå€¾è§’å¾®åˆ†ï¼Œå³è§’é€Ÿåº¦</mtext><mspace linebreak="newline"></mspace><mi>e</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mtext>æ˜¯é€Ÿåº¦ç¯ä¸­ç›®æ ‡é€Ÿåº¦ä¸å½“å‰é€Ÿåº¦çš„åå·®</mtext><mspace linebreak="newline"></mspace><mo>âˆ‘</mo><mrow><mi>e</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><mtext>ä¸ºåå·®çš„ç§¯åˆ†é¡¹ã€‚</mtext><mspace linebreak="newline"></mspace><mtext>å‡å¦‚é€Ÿåº¦ç¯è¾“å‡ºä¸º</mtext><msub><mi>Î¸</mi><mn>1</mn></msub><mtext>ï¼Œä½œä¸ºç›®æ ‡è§’åº¦è¾“å…¥ç›´ç«‹ç¯ï¼Œ</mtext><mspace linebreak="newline"></mspace><mtext>ç›´ç«‹ç¯çš„è¾“å‡º</mtext><mi>a</mi><mtext>ç›´æ¥ä½œç”¨äºç”µæœºï¼Œæœ‰å¦‚ä¸‹å…³ç³»å¼ã€‚</mtext><mspace linebreak="newline"></mspace><mtext>ç›´ç«‹ç¯è¾“å‡º</mtext><mi>a</mi><mo>=</mo><mi>k</mi><mi>p</mi><mo>âˆ—</mo><mo stretchy="false">(</mo><mi>Î¸</mi><mo>âˆ’</mo><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mi>k</mi><mi>d</mi><mo>âˆ—</mo><msup><mi>Î¸</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">â€²</mo></msup></msup><mspace linebreak="newline"></mspace><mtext>é€Ÿåº¦ç¯è¾“å‡º</mtext><msub><mi>Î¸</mi><mn>1</mn></msub><mo>=</mo><mi>k</mi><msub><mi>p</mi><mn>1</mn></msub><mo>âˆ—</mo><mi>e</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mo>+</mo><mi>k</mi><msub><mi>i</mi><mn>1</mn></msub><mo>âˆ—</mo><mo>âˆ‘</mo><mrow><mi>e</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><mspace linebreak="newline"></mspace><mtext>å› æ­¤</mtext><mi>a</mi><mo>=</mo><mi>k</mi><mi>p</mi><mo>âˆ—</mo><mi>Î¸</mi><mo>+</mo><mi>k</mi><mi>d</mi><mo>âˆ—</mo><msup><mi>Î¸</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">â€²</mo></msup></msup><mo>âˆ’</mo><mi>k</mi><mi>p</mi><mo>âˆ—</mo><mo stretchy="false">[</mo><mi>k</mi><msub><mi>p</mi><mn>1</mn></msub><mo>âˆ—</mo><mi>e</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mo>+</mo><mi>k</mi><msub><mi>i</mi><mn>1</mn></msub><mo>âˆ—</mo><mo>âˆ‘</mo><mrow><mi>e</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><mo stretchy="false">]</mo><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex">
\thetaä¸ºå½“å‰å°è½¦çš„å€¾è§’ \\
\theta^{&#x27;}ä¸ºå€¾è§’å¾®åˆ†ï¼Œå³è§’é€Ÿåº¦ \\
e(k)æ˜¯é€Ÿåº¦ç¯ä¸­ç›®æ ‡é€Ÿåº¦ä¸å½“å‰é€Ÿåº¦çš„åå·® \\ 
\sum{e(k)}ä¸ºåå·®çš„ç§¯åˆ†é¡¹ã€‚\\
å‡å¦‚é€Ÿåº¦ç¯è¾“å‡ºä¸º\theta_1ï¼Œä½œä¸ºç›®æ ‡è§’åº¦è¾“å…¥ç›´ç«‹ç¯ï¼Œ\\
ç›´ç«‹ç¯çš„è¾“å‡ºaç›´æ¥ä½œç”¨äºç”µæœºï¼Œæœ‰å¦‚ä¸‹å…³ç³»å¼ã€‚\\
ç›´ç«‹ç¯è¾“å‡º a= kp * (\theta - \theta_1) + kd *\theta^{&#x27;} \\
é€Ÿåº¦ç¯è¾“å‡º\theta_1 = kp_1 * e(k) + ki_1 * \sum{e(k)}\\
å› æ­¤a= kp * \theta + kd *\theta^{&#x27;} - kp * [kp_1 * e(k) + ki_1 * \sum{e(k)}] \\
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mord cjk_fallback">ä¸ºå½“å‰å°è½¦çš„å€¾è§’</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.9925em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.9925em;margin-right:0.05em;"><span class="pstrut" style="height:2.5795em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord cjk_fallback">ä¸ºå€¾è§’å¾®åˆ†ï¼Œå³è§’é€Ÿåº¦</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mord cjk_fallback">æ˜¯é€Ÿåº¦ç¯ä¸­ç›®æ ‡é€Ÿåº¦ä¸å½“å‰é€Ÿåº¦çš„åå·®</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.6em;vertical-align:-0.55em;"></span><span class="mop op-symbol large-op" style="position:relative;top:0em;">âˆ‘</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span><span class="mord cjk_fallback">ä¸ºåå·®çš„ç§¯åˆ†é¡¹ã€‚</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord cjk_fallback">å‡å¦‚é€Ÿåº¦ç¯è¾“å‡ºä¸º</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord cjk_fallback">ï¼Œä½œä¸ºç›®æ ‡è§’åº¦è¾“å…¥ç›´ç«‹ç¯ï¼Œ</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">ç›´ç«‹ç¯çš„è¾“å‡º</span><span class="mord mathnormal">a</span><span class="mord cjk_fallback">ç›´æ¥ä½œç”¨äºç”µæœºï¼Œæœ‰å¦‚ä¸‹å…³ç³»å¼ã€‚</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">ç›´ç«‹ç¯è¾“å‡º</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9925em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.9925em;margin-right:0.05em;"><span class="pstrut" style="height:2.5795em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord cjk_fallback">é€Ÿåº¦ç¯è¾“å‡º</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.6em;vertical-align:-0.55em;"></span><span class="mop op-symbol large-op" style="position:relative;top:0em;">âˆ‘</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">å› æ­¤</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0758em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.9925em;margin-right:0.05em;"><span class="pstrut" style="height:2.5795em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.6em;vertical-align:-0.55em;"></span><span class="mop op-symbol large-op" style="position:relative;top:0em;">âˆ‘</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span><span class="mclose">]</span></span><span class="mspace newline"></span></span></span></span>
<h4 id="è°ƒæ•´p-i-dçš„æ•ˆæœ"><a class="markdownIt-Anchor" href="#è°ƒæ•´p-i-dçš„æ•ˆæœ"></a> è°ƒæ•´Pã€Iã€Dçš„æ•ˆæœ</h4>
<p><strong>è°ƒæ•´æ¯”ä¾‹Pçœ‹ä»€ä¹ˆæ—¶å€™è·Œå€’ï¼Œä¸»è¦ä¾é å€¾æ–œè§’åº¦ã€‚</strong></p>
<p><strong>è°ƒæ•´å¾®åˆ†Dçœ‹ä»€ä¹ˆæ—¶å€™æŒ¯è¡ï¼Œè‹¥KDè¿‡å¤§ï¼Œåˆ™ä¼šæŒ¯è¡åœ°ä¸¥é‡ã€‚å…¶æ•ˆæœå°±æ˜¯é˜»å°¼ï¼Œè¶Šå¤§è¶Šæ…¢ã€‚</strong></p>
<p><strong>è°ƒæ•´ç§¯åˆ†Içœ‹ä»€ä¹ˆæƒ…å†µä¸‹å¹³è¡¡åœ°å¿«ï¼Œå…¶ä¸»è¦ç”¨äºæ¶ˆé™¤ç¨³æ€è¯¯å·®ï¼Œæé«˜æ§åˆ¶ç²¾åº¦ã€‚</strong></p>
<h4 id="è°ƒæ•´pid"><a class="markdownIt-Anchor" href="#è°ƒæ•´pid"></a> è°ƒæ•´PID</h4>
<p>1ã€ç¡®å®š<strong>æœºæ¢°ä¸­å€¼</strong>ï¼Œé€šè¿‡å®ƒæ¥ä¸­å’Œè®¡ç®—å‡ºçš„thetaï¼Œè¿™ä¸ªéœ€è¦è‡ªå·±<strong>æ‰‹åŠ¨æµ‹é‡</strong>ã€‚</p>
<p>2ã€è°ƒå‚Pã€Iã€D</p>
<h5 id="ç›´ç«‹ç¯pd"><a class="markdownIt-Anchor" href="#ç›´ç«‹ç¯pd"></a> ç›´ç«‹ç¯PD</h5>
<p>ï¼ˆè¾“å…¥æœŸæœ›è§’åº¦ã€çœŸå®è§’åº¦å’Œè§’é€Ÿåº¦ï¼‰</p>
<p>ç›´ç«‹ç¯ç›´æ¥è°ƒç”¨å…¬å¼ã€‚</p>
<p>é¦–è¦è¦çœ‹ä¸‹å¸Œæœ›åœ¨ä»€ä¹ˆè§’åº¦è®©å¹³è¡¡è½¦è¿”å›ï¼Œä»¥æ­¤ä¿æŒå¹³è¡¡ï¼Œè®¡ç®—å‡ºKPçš„èŒƒå›´ï¼ˆ7200 / 30ï¼‰ï¼›é€šè¿‡å°†KPç½®0åï¼Œå¾—åˆ°æ­¤æ—¶çš„gyro_xï¼Œè®¡ç®—å‡ºKDï¼ˆ7200/2000ï¼‰</p>
<p><strong>ç¡®å®šææ€§ï¼šå‘å‰å€¾æ–œæ—¶ï¼Œè½®å­ä¹Ÿå‘å‰ï¼Œåˆ™ä¸ºæ­£ç¡®ææ€§ã€‚</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> Vertical_Kp = <span class="number">-120</span>, Vertical_Kd = <span class="number">-0.6</span>;</span><br><span class="line"><span class="comment">//ä¸æ»¤æ³¢çš„åŸå› æ˜¯MPU6050æ»¤è¿‡äº†ã€‚</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">Vertical_PD</span><span class="params">(<span class="type">float</span> Med, <span class="type">float</span> Angle, <span class="type">float</span> gyro_y)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> tmp = Vertical_Kp * (Angle - Med) + Vertical_Kd * gyro_y;</span><br><span class="line">	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="é€Ÿåº¦ç¯pi"><a class="markdownIt-Anchor" href="#é€Ÿåº¦ç¯pi"></a> é€Ÿåº¦ç¯PI</h5>
<p>ï¼ˆè¾“å…¥æœŸæœ›é€Ÿåº¦ã€å·¦ç¼–ç å™¨ã€å³ç¼–ç å™¨ï¼‰</p>
<p>1ã€è®¡ç®—åå·®å€¼ï¼šè¯¯å·®å€¼ = ï¼ˆå·¦+å³ï¼‰- æœŸæœ›é€Ÿåº¦</p>
<p>2ã€ä½é€šæ»¤æ³¢ï¼šè¯¯å·®A = (1-a)Ã—åå·®å€¼ + aÃ—ä¸Šä¸€æ¬¡çš„åå·®å€¼ï¼Œå†æ›´æ–°ä¸Šä¸€æ¬¡çš„åå·®å€¼</p>
<p>3ã€ç§¯åˆ†ï¼šEncoder_S += è¯¯å·®A ï¼ˆSTM32æ˜¯ç¦»æ•£çš„æ•°å­—ä¿¡å·ï¼Œæ±‚ç§¯åˆ†å°±æ˜¯æ±‚å’Œï¼‰</p>
<p>4ã€é™å¹…Encoder_S</p>
<p>5ã€é€Ÿåº¦ç¯å¥—ç”¨å…¬å¼</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é€Ÿåº¦ç¯PIæ§åˆ¶å™¨</span></span><br><span class="line"><span class="comment">//è¾“å…¥ï¼šæœŸæœ›é€Ÿåº¦ã€çœŸå®é€Ÿåº¦ï¼ˆå·¦ç¼–ç ã€å³ç¼–ç ï¼‰</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">Velocity_PI</span><span class="params">(<span class="type">int</span> Target, <span class="type">int</span> Left_Encoder, <span class="type">int</span> Right_Encoder)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Encoder_Sæ˜¯åå·®ç´¯åŠ </span></span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> Err_Lowout_Last, Encoder_S;</span><br><span class="line">	<span class="type">static</span> <span class="type">float</span> a = <span class="number">0.7</span>;</span><br><span class="line">	<span class="comment">//1ã€è®¡ç®—åå·®å€¼</span></span><br><span class="line">	<span class="type">int</span> Err, Err_Lowout;</span><br><span class="line">	Err = (Left_Encoder + Right_Encoder) - Target;</span><br><span class="line">	<span class="comment">//2ã€ä½é€šæ»¤æ³¢</span></span><br><span class="line">	Err_Lowout = (<span class="number">1</span> - a) * Err + a * Err_Lowout_Last;</span><br><span class="line">	Err_Lowout_Last = Err_Lowout;</span><br><span class="line">	<span class="comment">//3ã€ç§¯åˆ†</span></span><br><span class="line">	Encoder_S += Err_Lowout;</span><br><span class="line">	<span class="comment">//4ã€é™å¹…</span></span><br><span class="line">	Encoder_S = Encoder_S &gt; <span class="number">10000</span> ? <span class="number">10000</span> : (Encoder_S &lt; (<span class="number">-10000</span>) ? (<span class="number">-10000</span>) : Encoder_S);</span><br><span class="line">	<span class="keyword">if</span>(stop == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Encoder_S=<span class="number">0</span>;</span><br><span class="line">		stop=<span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//5ã€é€Ÿåº¦ç¯è®¡ç®—</span></span><br><span class="line">	Velocity_Ki = Velocity_Kp / <span class="number">200</span>;</span><br><span class="line">	<span class="type">int</span> tmp = Velocity_Kp * Err_Lowout + Velocity_Ki * Encoder_S;</span><br><span class="line">	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>KPé€šè¿‡å…¬å¼æ¢ç®—ï¼ŒKIä¸€èˆ¬ä¸ºKP/200ï¼›</p>
<p><strong>ç¡®å®šææ€§ï¼šå‘å‰å€¾æ–œæ—¶ï¼Œè½®å­é€Ÿåº¦åŠ å¿«ï¼Œåˆ™ä¸ºæ­£ç¡®ææ€§ï¼Œåä¹‹é€Ÿåº¦å‡ä¸ä¸Šå»ï¼Œåˆ™ä¸ºé”™è¯¯ææ€§ã€‚</strong></p>
<h5 id="è½¬å‘ç¯pd"><a class="markdownIt-Anchor" href="#è½¬å‘ç¯pd"></a> è½¬å‘ç¯PD</h5>
<p>ï¼ˆç”¨äºè½¬å‘æ“ä½œï¼Œè¾“å…¥è§’é€Ÿåº¦ã€è§’åº¦å€¼ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Turn_PD</span><span class="params">(<span class="type">int</span> gyro_Z, <span class="type">int</span> Target_Turn)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> tmp = Turn_Kp * Target_Turn + Turn_Kd * gyro_Z;</span><br><span class="line">	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è“ç‰™æ§åˆ¶"><a class="markdownIt-Anchor" href="#è“ç‰™æ§åˆ¶"></a> è“ç‰™æ§åˆ¶</h4>
<p>é€šè¿‡è“ç‰™APPå‘é€0x01ï¼ˆä¸Šï¼‰ã€0x05ï¼ˆå·¦ï¼‰ã€0x03ï¼ˆå³ï¼‰ã€0x07ï¼ˆä¸‹ï¼‰ç­‰æ•°æ®åˆ†åˆ«æ§åˆ¶æ–¹å‘ã€‚</p>
<h4 id="è·Œå€’ä¿æŠ¤"><a class="markdownIt-Anchor" href="#è·Œå€’ä¿æŠ¤"></a> è·Œå€’ä¿æŠ¤</h4>
<p>é€šè¿‡MPU6050çš„rollå€¼ï¼Œè‹¥å…¶å€¼è¶…è¿‡è®¾å®šçš„ç•Œé™ï¼Œåˆ™å°†PWMè®¾ä¸º0ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Stop</span><span class="params">(<span class="type">float</span> *Med_Jiaodu,<span class="type">float</span> *Jiaodu)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">abs</span>((<span class="type">int</span>)(*Jiaodu-*Med_Jiaodu))&gt;<span class="number">60</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Load(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">		stop=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç‰©ä½“è·Ÿéš"><a class="markdownIt-Anchor" href="#ç‰©ä½“è·Ÿéš"></a> ç‰©ä½“è·Ÿéš</h4>
<p><strong>ä»…å®ç°ç›´çº¿è·Ÿéš</strong>ï¼Œæ–¹æ¡ˆæ˜¯å€ŸåŠ©è¶…å£°æ³¢ä¼ å›çš„è·ç¦»ï¼Œè®¾ç½®åœ¨10-20mmæ—¶å¯ä»¥è·Ÿéšï¼Œè‹¥è¶…è¿‡ï¼Œåˆ™å°è½¦ä¿æŒå¹³è¡¡ä¸åŠ¨ã€‚</p>
<h3 id="å…¶ä»–"><a class="markdownIt-Anchor" href="#å…¶ä»–"></a> å…¶ä»–</h3>
<p><em><strong>TIP1:TIM1-TIM4ç”¨å®Œäº†ï¼Œå¦‚ä½•10msè°ƒç”¨ä¸€æ¬¡å‘¢ï¼Ÿç­”ï¼šMPU6050ä¸­çš„INTå¼•è„šï¼Œä¿®æ”¹å…¶é‡‡æ ·ç‡ä¸º100HZå³å¯</strong></em></p>
<p><em><strong>TIP2:MPU6050ä¼šè¿›è¡Œè‡ªæ£€ï¼Œè‹¥é™€èºä»ªä¸åœ¨æ°´å¹³çŠ¶æ€æœ€åˆçŠ¶æ€ä¸ä¸ºå¹³è¡¡ï¼Œåˆ™ä¸é€šè¿‡ï¼Œå¯¼è‡´å…¶è®¡ç®—ç»“æœä¸€ç›´ä¸º0ï¼Œæ³¨é‡Šæ‰</strong></em></p>
<h4 id="pidå„ç§ç®—æ³•"><a class="markdownIt-Anchor" href="#pidå„ç§ç®—æ³•"></a> PIDå„ç§ç®—æ³•</h4>
<p>1ã€<strong>ä½ç½®å¼PID</strong>ï¼ˆæœ¬æ–¹å¼å®é™…åº”ç”¨ï¼‰</p>
<p>ä¼˜ç‚¹ï¼šé™æ€è¯¯å·®å°ï¼Œæº¢å‡ºçš„å½±å“å°ã€‚</p>
<p>ç¼ºç‚¹ï¼šè®¡ç®—é‡å¾ˆå¤§ï¼Œç´¯ç§¯è¯¯å·®ç›¸å¯¹å¤§ï¼Œåœ¨ç³»ç»Ÿå‡ºç°é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œå®¹æ˜“ä½¿ç³»ç»Ÿå¤±æ§ï¼Œç§¯åˆ†é¥±å’Œã€‚</p>
<p>ä½¿ç”¨ï¼šä¸€èˆ¬éœ€è¦ç»“åˆè¾“å‡ºé™å¹…å’Œç§¯åˆ†é™å¹…ä½¿ç”¨ã€‚</p>
<p>2ã€<strong>å¢é‡å¼PID</strong></p>
<p>ä¼˜ç‚¹ï¼šæº¢å‡ºçš„å½±å“å°ï¼Œåœ¨ç³»ç»Ÿå‡ºç°é”™è¯¯çš„æƒ…å†µä¸‹,å½±å“ç›¸å¯¹è¾ƒå°ï¼ˆå› ä¸ºåªä¸è¿‡å»çš„ä¸‰æ¬¡è¯¯å·®æœ‰å…³ï¼‰,è¿ç®—é‡ä¹Ÿç›¸å¯¹è¾ƒå°ã€‚</p>
<p>ç¼ºç‚¹ï¼šæœ‰é™æ€è¯¯å·®ï¼ˆå› ä¸ºæ²¡æœ‰ç´¯ç§¯è¯¯å·®ï¼‰ã€‚</p>
<p>3ã€<strong>ç§¯åˆ†åˆ†ç¦»å¼PID</strong></p>
<p>ç§¯åˆ†åˆ†ç¦»å¼PIDä¸»è¦æ˜¯é’ˆå¯¹<strong>ä½ç½®å¼PIDçš„ç§¯åˆ†</strong>ï¼Œ<strong>å¼•å…¥åˆ¤æ–­è¯¯å·®å¤§å°æ¡ä»¶ï¼Œæ˜¯å¦ä½¿ç”¨ç§¯åˆ†é¡¹ã€‚</strong></p>
<p>4ã€<strong>å˜é€Ÿç§¯åˆ†PID</strong></p>
<p><strong>ç§¯åˆ†åˆ†ç¦»å¼</strong>PID ç§¯åˆ†çš„çš„<strong>æƒé‡æ˜¯1æˆ–è€…0</strong>ï¼Œè€Œ<strong>å˜ç§¯åˆ†PIDç§¯åˆ†çš„æƒé‡ä¼šåŠ¨æ€å˜åŒ–</strong>ã€‚å–å†³äºåå·®ï¼Œåå·®è¶Šå¤§ï¼Œç§¯åˆ†è¶Šæ…¢ã€‚</p>
<p>5ã€ä¸å®Œå…¨å¾®åˆ†PID</p>
<p><strong>å¾®åˆ†é€šè¿‡ä½é€šæ»¤æ³¢ã€‚</strong></p>
<p>6ã€<strong>å¾®åˆ†å…ˆè¡Œ</strong></p>
<p>å¾®åˆ†çš„ä½œç”¨æ˜¯é¢„æµ‹æœªæ¥ï¼Œèƒ½å¤Ÿé¢„çŸ¥å˜åŒ–ï¼Œåšå‡ºè°ƒæ•´ã€‚å…¶å®å°±æ˜¯<strong>å…ˆæ“ä½œå¾®åˆ†ã€‚</strong></p>
<p>7ã€<strong>æ­»åŒº</strong></p>
<p>è¾“å‡ºäº†é‡ï¼Œä½†æ˜¯ä¸æ‰§è¡Œä»»ä½•åŠ¨ä½œï¼Œä¹Ÿå°±æ˜¯è¾“å‡ºçš„é‡ä¸èµ·ä½œç”¨ã€‚</p>
<p>8ã€<strong>æ¢¯å½¢ç§¯åˆ†</strong></p>
<p><strong>ç§¯åˆ†æœ‰ä½™å·®ï¼Œæ¶ˆé™¤ä¸äº†ï¼Œä¸ºäº†å‡å°‘ä½™å·®</strong>ï¼Œæé«˜è¿ç®—çš„ç²¾åº¦ï¼Œä¾¿æœ‰äº†<strong>æ¢¯å½¢ç§¯åˆ†PID</strong>ã€‚</p>
<h3 id="æŸ¥æ¼è¡¥ç¼º"><a class="markdownIt-Anchor" href="#æŸ¥æ¼è¡¥ç¼º"></a> æŸ¥æ¼è¡¥ç¼º</h3>
<p>æŸæ¬¡é¢è¯•ï¼ŒHRé—®æˆ‘åœ¨æ“ä½œIICæ—¶ï¼ŒMPU6050çš„åœ°å€æ˜¯å¤šå°‘ï¼Œç»™æˆ‘ä¸€ä¸‹æ•´æ‡µäº†ï¼Œå¹³å¸¸æ“ä½œåªæƒ³ç€ç”¨å°è£…åº“ï¼Œåè€Œå¿˜äº†æœ€åŸºç¡€çš„ä¸œè¥¿ï¼Œç»“æŸåå°±ç«‹é©¬å»é€Ÿé€Ÿå­¦ä¹ ã€‚</p>
<p><strong>I2Cè®¾å¤‡çš„å†™åœ°å€ = I2Cè®¾å¤‡åœ°å€ &lt;&lt; 1 + 0</strong><br />
<strong>I2Cè®¾å¤‡çš„è¯»åœ°å€ = (I2Cè®¾å¤‡åœ°å€ &lt;&lt; 1) + 1</strong></p>
<p>å¦‚æœAD0è„š(9è„š)æ¥åœ°,è®¾å¤‡åœ°å€ä¸º<strong>0x68</strong><br />
å¦‚æœæ¥V3.3,åˆ™è®¾å¤‡åœ°å€ä¸º<strong>0x69</strong></p>
<p><strong>ä½¿ç”¨0x68å¥—ç”¨å¼å­</strong><br />
<strong>MPU6050å†™åœ°å€ï¼ˆ0110 1000&lt;&lt;1 ï¼‰ =1101 0000ï¼Œå³0xD0</strong><br />
<strong>MPU6050è¯»åœ°å€ï¼ˆ0110 1000&lt;&lt;1+1ï¼‰ =1101 0001ï¼Œå³0xD1</strong></p>
]]></content>
      <categories>
        <category>é¡¹ç›®</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>é¡¹ç›®</tag>
        <tag>PID</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•åšä¸€ä¸ªè¿™æ ·çš„ç½‘ç«™</title>
    <url>/2024/01/15/%E5%A6%82%E4%BD%95%E5%81%9A%E4%B8%80%E4%B8%AA%E8%BF%99%E6%A0%B7%E7%9A%84%E7%BD%91%E7%AB%99/</url>
    <content><![CDATA[<h2 id="è¿™ä¸ªäººå¤ªæ‡’äº†æ ¹æœ¬å°±å¦¹å†™æ­£æ–‡å‘€è¿˜æ˜¯æ¥çœ‹çœ‹å¯çˆ±çŒ«çŒ«å§"><a class="markdownIt-Anchor" href="#è¿™ä¸ªäººå¤ªæ‡’äº†æ ¹æœ¬å°±å¦¹å†™æ­£æ–‡å‘€è¿˜æ˜¯æ¥çœ‹çœ‹å¯çˆ±çŒ«çŒ«å§"></a> è¿™ä¸ªäººå¤ªæ‡’äº†ï¼Œæ ¹æœ¬å°±å¦¹å†™æ­£æ–‡å‘€ï¼è¿˜æ˜¯æ¥çœ‹çœ‹å¯çˆ±çŒ«çŒ«å§ï¼</h2>
<p><img src="https://s2.loli.net/2025/05/07/ytoMgCnpV7PU4wm.png" alt="" /></p>
<h2 id="å­¦ä¹ å‚è€ƒ"><a class="markdownIt-Anchor" href="#å­¦ä¹ å‚è€ƒ"></a> å­¦ä¹ å‚è€ƒ</h2>
<ul>
<li>æ­å»º1ï¼š<a href="https://blog.csdn.net/sinat_37781304/article/details/82729029">hexoå²ä¸Šæœ€å…¨æ­å»ºæ•™ç¨‹-CSDNåšå®¢</a></li>
<li>æ­å»º2ï¼š<a href="https://www.jianshu.com/p/c9295bacd98b">ä½¿ç”¨Hexoåœ¨GitHub Pagesä¸Šæ­å»ºéƒ¨ç½²å…è´¹çš„ä¸ªäººåšå®¢ç½‘ç«™ï¼ˆä¸‹ï¼šHexoéƒ¨ç½²ï¼‰â€”â€”æœ€è¯¦ç»†å…¨é¢è§£è¯»æ•™ç¨‹ï¼ˆæ²¡æœ‰ä¹‹ä¸€ï¼‰ - ç®€ä¹¦</a></li>
<li>hexoä¸»é¢˜ï¼š<a href="https://hexo.io/themes/">Themes | Hexo</a></li>
<li>å¤„ç†å…¬å¼é—®é¢˜ï¼š<a href="https://blog.luzy.top/posts/2968289947/">HexoæŠ˜è…¾ç³»åˆ—ï¼ˆå…­ï¼‰æ•°å­¦å…¬å¼æ¸²æŸ“ä¼˜åŒ– - æ±Ÿé£å¼•é›¨ã®å°poç«™</a></li>
<li>å›¾åºŠå·¥å…·å‚è€ƒ1ï¼š<a href="https://sm.ms/home/">Home - SM.MS | Dashboard</a></li>
<li>å›¾åºŠå·¥å…·å‚è€ƒ2ï¼š<a href="https://blog.csdn.net/qq_38140292/article/details/118885686?spm=1001.2014.3001.5501">ã€Typoraã€‘github-ä¸PicGOæ­å»ºå›¾åºŠ-CSDNåšå®¢</a></li>
<li>æ·»åŠ éŸ³ä¹ï¼š<a href="https://yelog.org/2019/10/08/3-hexo-add-music/">3-hexo æ·»åŠ éŸ³ä¹æ’ä»¶ | å¶è½é˜</a></li>
<li><strong>è¡¨æ ¼æœªå±…ä¸­é—®é¢˜æš‚æœªè§£å†³ï¼ŒCSSç¾åŒ–ï¼Ÿ</strong></li>
</ul>
<h2 id="å…³äºä¸Šä¼ hexo-då‡ºç°err-error-spawn-failedæŠ¥é”™é—®é¢˜"><a class="markdownIt-Anchor" href="#å…³äºä¸Šä¼ hexo-då‡ºç°err-error-spawn-failedæŠ¥é”™é—®é¢˜"></a> å…³äºä¸Šä¼ hexo då‡ºç°err: Error: Spawn failedæŠ¥é”™é—®é¢˜</h2>
<p>æ‰“å¼€åšå®¢ç›®å½•å†…çš„_config.ymlé…ç½®æ–‡ä»¶ï¼Œå°†<strong>è‡ªå·±çš„githubçš„httpsä»“åº“åœ°å€</strong>ä¿®æ”¹ä¸º<strong>è‡ªå·±githubçš„SSHåœ°å€</strong></p>
<h2 id="æ€ä¹ˆæ›´æ–°blog"><a class="markdownIt-Anchor" href="#æ€ä¹ˆæ›´æ–°blog"></a> æ€ä¹ˆæ›´æ–°BLOG</h2>
<p>2025.7.24ç•™ï¼Œå¥½ä¹…æ²¡ç”¨ï¼ŒæŠŠæ›´æ–°æ–‡ç« çš„å‘½ä»¤å¿˜å®Œï¼Œè®°å½•ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¼ ä¸ŠæœåŠ¡å™¨</span></span><br><span class="line">hexo g -d</span><br><span class="line"><span class="comment">// æœ¬åœ° localhost:4000</span></span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ç½‘é¡µ</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>è“æ¡¥æ¯ç¬¬åäºŒå±Šå¿ƒå¾—</title>
    <url>/2022/04/28/%E8%93%9D%E6%A1%A5%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%B1%8A%E5%8D%95%E7%89%87%E6%9C%BA%E5%BF%83%E5%BE%97/</url>
    <content><![CDATA[<h1 id="æ„Ÿæ‚Ÿ"><a class="markdownIt-Anchor" href="#æ„Ÿæ‚Ÿ"></a> æ„Ÿæ‚Ÿ</h1>
<p>ä»Šå¹´çš„è“æ¡¥æ¯å•ç‰‡æœºéš¾å—ï¼Œä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ³¨é‡ç»†å¿ƒã€‚ä¸€åˆ†ä»˜å‡ºï¼Œä¸€åˆ†æ”¶è·ã€‚ä»Šå¹´æˆ‘æœ‰å¹¸å‚åŠ äº†ç¬¬åäºŒå±Šçš„æ¯”èµ›ï¼Œä½†å› ä¸ºè‡ªå·±æ“ä½œä¸å½“ï¼Œä¼˜åŒ–ä»£ç çš„è¿‡ç¨‹ä¸­åˆ äº†å®šæ—¶å™¨ï¼Œæ²¡åœ¨ä¸»å‡½æ•°åˆ äº†è°ƒç”¨å‡½æ•°ï¼Œå¯¼è‡´å·²ç»å®Œæˆçš„å¤§å¦è½°ç„¶å€’å¡Œã€‚è‡ªå·±ä¹Ÿå¾ˆéš¾å—ï¼Œä½†æ²¡åŠæ³•ï¼Œå¸Œæœ›çœ‹åˆ°æ–‡ç« çš„ä½ ä»¬ä¸è¦çŠ¯è¿™ç§ä½çº§é—®é¢˜ã€‚<br />
Emmmmâ€¦ï¼Œä¸è¿‡åæ¥æ‹¿äº†çœä¸€ï¼ŒæŒºæ„å¤–çš„ã€‚</p>
<h1 id="æ–°æ‰‹ä¸Šè·¯"><a class="markdownIt-Anchor" href="#æ–°æ‰‹ä¸Šè·¯"></a> æ–°æ‰‹ä¸Šè·¯</h1>
<p>åŸºç¡€éƒ¨åˆ†çš„å†…å®¹ï¼Œæ¨èå¤§å®¶å»çœ‹å°èœœèœ‚è€å¸ˆçš„è§†é¢‘ï¼Œè®²çš„å¾ˆå¥½ï¼Œç½‘å€: <a href="https://www.xmf393.com/2019/06/11/2019061103">https://www.xmf393.com/2019/06/11/2019061103</a>.</p>
<h1 id="å­¦ä¹ æ€è·¯"><a class="markdownIt-Anchor" href="#å­¦ä¹ æ€è·¯"></a> å­¦ä¹ æ€è·¯</h1>
<p>ä»¥ä¸‹æ˜¯æˆ‘çš„å­¦ä¹ æ€è·¯<br />
é¦–å…ˆï¼šå…ˆå­¦ä¼šLEDã€èœ‚é¸£å™¨ã€ç»§ç”µå™¨ã€æŒ‰é”®ã€æ•°ç ç®¡ã€æ•°ç ç®¡ä½é€‰ã€ä¸²å£ç­‰åŸºæœ¬æ“ä½œã€‚<br />
å…¶æ¬¡ï¼šds1302ï¼Œds18b20ï¼Œeeprom(24C02)ï¼ŒPCF8591ç­‰ã€‚<br />
ç„¶åï¼šPWMå‘¼å¸ç¯ï¼ŒDA(å› ä¸ºæˆ‘åˆšå¼€å§‹ä¸€ç›´æ²¡æ‰¾åˆ°)ã€è¶…å£°æ³¢ã€‚<br />
æœ€å…³é”®çš„æ˜¯ä¸€å®šè¦åšçœèµ›é¢˜ï¼å®æ“å¾ˆé‡è¦ï¼</p>
<p>èµ›é¢˜é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1ULZzd9nSA8l21VQQiDYvuQ">https://pan.baidu.com/s/1ULZzd9nSA8l21VQQiDYvuQ </a>.<br />
æå–ç ï¼š1234</p>
<h1 id="ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹"><a class="markdownIt-Anchor" href="#ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹"></a> ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼ï¼</h1>
<h2 id="led"><a class="markdownIt-Anchor" href="#led"></a> LED</h2>
<p>é¦–å…ˆè¦è¯´çš„æ˜¯LEDç¯ï¼Œæ¯”å¦‚ç¬¬10å±Šçœèµ›é¢˜ç›®ä¸­ï¼Œå¦‚æœå•ç‹¬ç‚¹äº®LEDï¼Œä¼šå‡ºç°åŸå…ˆæ²¡æœ‰å®šä¹‰çš„ç¯è·Ÿç€ä¸€èµ·äº®ï¼Œæˆ‘çš„è§£å†³æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">led</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> key1,key2,key3,key4;</span><br><span class="line">	<span class="keyword">if</span>(s4_stat == <span class="number">0</span>)										key1 = <span class="number">0x01</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(s4_stat == <span class="number">1</span>)									key1 = <span class="number">0x02</span>;</span><br><span class="line">	<span class="keyword">if</span>((dat_sz&gt;=<span class="number">0</span>&amp;&amp;dat_sz&lt;<span class="number">150</span>)||(dat_sz&gt;=<span class="number">250</span>&amp;&amp;dat_sz&lt;<span class="number">350</span>))	key2 = <span class="number">0x04</span>;</span><br><span class="line">	<span class="keyword">else</span>													key2 = <span class="number">0x00</span>;</span><br><span class="line">	<span class="keyword">if</span>(dat_f&gt;=<span class="number">0</span>&amp;&amp;dat_f&lt;<span class="number">1000</span>||dat_f&gt;=<span class="number">5000</span>&amp;&amp;dat_f&lt;<span class="number">10000</span>)		key3 = <span class="number">0x08</span>;</span><br><span class="line">	<span class="keyword">else</span>													key3 = <span class="number">0x00</span>;</span><br><span class="line">	<span class="keyword">if</span>(DA_dy == <span class="number">103</span>)										key4 = <span class="number">0x10</span>;</span><br><span class="line">	<span class="keyword">else</span>													key4 = <span class="number">0x00</span>;</span><br><span class="line">	P2 = (P2 &amp; <span class="number">0x1f</span>) | <span class="number">0x80</span>;P0 = ~(key1|key2|key3|key4);P2 = <span class="number">0x00</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å»¶è¿Ÿdelay"><a class="markdownIt-Anchor" href="#å»¶è¿Ÿdelay"></a> å»¶è¿Ÿdelay</h2>
<p>æœ¬æ¥ä¸æƒ³å•ç‹¬æ‹¿å‡ºæ¥è®²çš„ï¼Œå®åœ¨æ˜¯åˆå­¦è€…è¿™é‡Œå‡ºé—®é¢˜çš„å¤ªå¤šäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¿™ä¸ªtæ˜¯0-255</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> t)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">while</span>(t--)ï¼›</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™ä¸ªtæ˜¯0-65536</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> t)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">while</span>(t--)ï¼›</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™ä¸ªä¸å½±å“æ•°ç ç®¡æ˜¾ç¤º</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> t)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">while</span>(t--)</span><br><span class="line">	&#123;æ•°ç ç®¡æ˜¾ç¤º&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æŒ‰é”®æ¶ˆæŠ–"><a class="markdownIt-Anchor" href="#æŒ‰é”®æ¶ˆæŠ–"></a> æŒ‰é”®æ¶ˆæŠ–</h2>
<p>æœ‰æ—¶å€™é¢˜ç›®ä¼šè®©ä½ åªåŠ 1ï¼Œä½†ä½ æŒ‰äº†æŒ‰é”®ä¼šå‡ºç°åŠ çš„å¥½å¤šï¼Œè¿™é‡Œæ¨èä¸€ç§è§£å†³æ–¹æ³•</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(key == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	delay(<span class="number">100</span>);</span><br><span class="line">	<span class="keyword">if</span>(key == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ç›¸å…³æ“ä½œ;</span><br><span class="line">		<span class="keyword">while</span>(key == <span class="number">0</span>)&#123;æ•°ç ç®¡æ“ä½œ;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="çŸ©é˜µæŒ‰é”®"><a class="markdownIt-Anchor" href="#çŸ©é˜µæŒ‰é”®"></a> çŸ©é˜µæŒ‰é”®</h2>
<p>æˆ‘å‚è€ƒçš„Bç«™ä¸€ä½UPä¸»ï¼Œå†™çš„å¾ˆå¥½ï¼Œè¿™é‡Œç”¨çš„æ˜¯reg52</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sbit P42 = P4^<span class="number">2</span>;</span><br><span class="line">sbit P44 = P4^<span class="number">4</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> key_value;</span><br><span class="line"><span class="type">void</span> <span class="title function_">scan_key</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	P3 = <span class="number">0x0f</span>;P42 = <span class="number">0</span>;P44 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(P3 != <span class="number">0x0f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		delay(<span class="number">100</span>);</span><br><span class="line">		<span class="keyword">if</span>(P3 != <span class="number">0x0f</span>)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">switch</span>(P3)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x0e</span>:key_value = <span class="number">0</span>;<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x0d</span>:key_value = <span class="number">4</span>;<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x0b</span>:key_value = <span class="number">8</span>;<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x07</span>:key_value = <span class="number">12</span>;<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		P3 = <span class="number">0xf0</span>;P42 = <span class="number">1</span>;P44 = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">switch</span>(P3)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xe0</span>:key_value += <span class="number">3</span>;<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xd0</span>:key_value += <span class="number">2</span>;<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(P42 == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			key_value += <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">//	ï¼ï¼è¿™é‡Œå¯ä»¥æ ¹æ®key_valueçš„å€¼åšå…¶ä»–çš„æŒ‰é”®æ“ä½œï¼ï¼</span></span><br><span class="line">		<span class="keyword">while</span>(P3 != <span class="number">0xf0</span>);</span><br><span class="line">		<span class="keyword">while</span>(P42 != <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">while</span>(P44 != <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ds13b20"><a class="markdownIt-Anchor" href="#ds13b20"></a> DS13B20</h2>
<p>å…³äºds13b20è¯»å–æ¸©åº¦ï¼Œonewireé‡Œé¢çš„å»¶è¿Ÿéƒ½è¦å¢å¤§10-12å€ã€‚ç‰¹åˆ«æ³¨æ„çš„å°±æ˜¯ï¼Œèœœèœ‚è€å¸ˆé‚£çš„tempæ˜¯16ä½çš„ï¼ŒLSBã€MSBæ˜¯8ä½çš„ï¼Œè¿˜æœ‰å°±æ˜¯è€å¸ˆé‚£çš„delay(700)æ˜¯unsigned intçš„è€Œä¸æ˜¯unsigned charï¼Œè¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹ã€‚ä¸¤ä½å°æ•°çš„è¯»æ³•æˆ‘å»ºè®®å¤§å®¶å»æ‰¾æ‰¾ç›¸å…³å†…å®¹çœ‹çœ‹ï¼Œä»¥å…è€ƒåˆ°ã€‚</p>
<h2 id="iic"><a class="markdownIt-Anchor" href="#iic"></a> IIC</h2>
<p>IICè¿™ä¸€å—é™¤äº†DAè¾“å‡ºï¼Œå…¶ä»–æ²¡å•¥å¯è¯´çš„ï¼ŒDAè¾“å‡ºå‚è€ƒä»£ç å¦‚ä¸‹(åªéœ€è¦è¿™æ ·ç„¶åä¸»å‡½æ•°è°ƒç”¨å°±è¡Œï¼Œæ¥ç€ä½ å»æ‹¿ä¸‡ç”¨è¡¨æµ‹J3çš„D/Aä¸GNDä¸¤ä¸ªä½ç½®å°±å¯ä»¥å¾—åˆ°å·®ä¸å¤šçš„æ•°å€¼)ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">write_DA</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	IIC_Start(); </span><br><span class="line">	IIC_SendByte(<span class="number">0x90</span>);</span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(<span class="number">0x40</span>);		<span class="comment">//0100 0000 è¿™é‡Œçš„ç¬¬äºŒä½ç½®ä¸º1ä¸ºDAï¼Œ0ä¸ºAD</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(DA_dy1);	<span class="comment">//DA_dy1çš„å€¼æ˜¯0-255ï¼Œæ¢ç®—5Vç”µå‹</span></span><br><span class="line">	IIC_WaitAck();			<span class="comment">//ä½ åªéœ€è¦ä¹˜ä»¥500/255.0f = 1.96å¯åˆ°å°±è¡Œ</span></span><br><span class="line">	IIC_Stop(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ä¸ªç‚¹å°±æ˜¯åº”ç­”å’Œéåº”ç­”ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">IIC_SendAck(x);	<span class="comment">//0çš„è¯å€¼0-128,1çš„è¯å€¼æ˜¯0-255.</span></span><br></pre></td></tr></table></figure>
<h2 id="pwm"><a class="markdownIt-Anchor" href="#pwm"></a> PWM</h2>
<p>æœ‰äº›å°ä¼™ä¼´å¯èƒ½å­¦äº†å¾ˆä¹…éƒ½æ²¡ææ‡‚PWMæ˜¯æ€ä¹ˆæçš„ï¼Œæˆ‘ä¸¾ä¸ªä¾‹å­ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> count,time,pwm_duty,led_light;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Init</span><span class="params">()</span>				<span class="comment">//å®šæ—¶å™¨</span></span><br><span class="line">&#123;</span><br><span class="line">	TMOD = <span class="number">0x01</span>;</span><br><span class="line">	TH0 = (<span class="number">65536</span> - <span class="number">100</span>) / <span class="number">256</span>;</span><br><span class="line">	TL0 = (<span class="number">65536</span> - <span class="number">100</span>) % <span class="number">256</span>;</span><br><span class="line">	TR0 = <span class="number">1</span>;</span><br><span class="line">	ET0 = <span class="number">1</span>;</span><br><span class="line">	EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> å‡½æ•°å() interrupt <span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">	TH0 = (<span class="number">65536</span> - <span class="number">100</span>) / <span class="number">256</span>;</span><br><span class="line">	TL0 = (<span class="number">65536</span> - <span class="number">100</span>) % <span class="number">256</span>;</span><br><span class="line">	count++;</span><br><span class="line">	<span class="keyword">if</span>(count &lt;= pwm_duty)</span><br><span class="line">	&#123;P2 = (P2 &amp; <span class="number">0x1f</span>) | <span class="number">0x80</span>;P0 = <span class="number">0xfe</span>;P2 = <span class="number">0x00</span>;&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(count &lt; <span class="number">10</span>)</span><br><span class="line">	&#123;P2 = (P2 &amp; <span class="number">0x1f</span>) | <span class="number">0x80</span>;P0 = <span class="number">0xff</span>;P2 = <span class="number">0x00</span>;&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;count = <span class="number">0</span>;time++;P2 = (P2 &amp; <span class="number">0x1f</span>) | <span class="number">0x80</span>;P0 = <span class="number">0xfe</span>;P2 = <span class="number">0x00</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(time == <span class="number">5</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		time = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(led_light == <span class="number">0</span>) <span class="comment">//0æ˜¯äº®ã€1æ˜¯æš—</span></span><br><span class="line">		<span class="keyword">if</span>(pwm_duty == <span class="number">10</span>)	pwm_duty = <span class="number">10</span>,led_light = <span class="number">1</span>;	<span class="keyword">else</span>	pwm_duty++;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(led_light == <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">if</span>(pwm_duty == <span class="number">0</span>)   pwm_duty = <span class="number">0</span>,led_light = <span class="number">0</span>;		<span class="keyword">else</span> 	pwm_duty--;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬è¦çš„æ˜¯å°ç¯ç¼“æ…¢äº®0.5sï¼Œç¼“æ…¢ç­0.5sï¼Œå…ˆå®šä¹‰ä¸€ä¸ª100usçš„å®šæ—¶å™¨ï¼Œå…ˆç»è¿‡countèµ°äº†10æ¬¡åï¼Œtime++äº†ï¼Œäº”æ¬¡åä¹Ÿå°±æ˜¯countåŠ äº†50æ¬¡(æ¢ç®—ä¹Ÿå°±æ˜¯50ms)ï¼Œç„¶åledç¯ä¼šå˜ä¸€æ¬¡pwm_dutyï¼Œä¹Ÿå°±æ˜¯å°ç¯çš„äº®åº¦ï¼Œæ€»å…±è¦å˜10æ¬¡ï¼Œä¹Ÿå°±æ˜¯0.5sï¼Œè¾¾åˆ°æ•ˆæœã€‚</p>
<h2 id="ioå’Œmmæ¨¡å¼"><a class="markdownIt-Anchor" href="#ioå’Œmmæ¨¡å¼"></a> IOå’ŒMMæ¨¡å¼</h2>
<p>çœèµ›æˆ‘è¿˜æ²¡çœ‹åˆ°è¦æ±‚ç”¨MMæ¨¡å¼çš„ï¼Œå¤§å¤šæ•°éƒ½æ˜¯è¦æ±‚IOæ¨¡å¼ï¼Œæœ€å¥½éƒ½å­¦ä¸€ä¸‹ï¼ŒMMæ¨¡å¼æ¯”IOæ¨¡å¼å¤šç”¨ä¸€ä¸ªabsacc.hçš„å¤´æ–‡ä»¶ã€‚</p>
<h1 id="ç»“å°¾"><a class="markdownIt-Anchor" href="#ç»“å°¾"></a> ç»“å°¾</h1>
<p>å¸Œæœ›çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„ä½ ï¼Œä¸ä¼šå’Œæˆ‘åˆšè€ƒå®Œä¸€æ ·ï¼Œæ„Ÿè§‰è‡ªå·±çš„ä»˜å‡ºå’Œå›æŠ¥ä¸æˆæ­£æ¯”ï¼Œè‡ªå·±çš„å¿ƒæ€å¾ˆå—æ‰“å‡»ã€‚å½“æˆ‘çŸ¥é“æ²¡åˆ é‚£ä¸ªçš„æ—¶å€™ï¼Œæˆ‘å½“æ—¶äººç›´æ¥æ‡µäº†ï¼Œæ‰‹æœºä¹Ÿæ‘”åœ°ä¸Šç¢å±äº†ï¼Œè‡ªå·±ä»˜å‡ºäº†å¾ˆå¤šï¼Œå’Œè€å¸ˆä¸é™ªè‡ªå·±ä¸€èµ·èµ°è¿‡æ¥ç»å¸¸äº¤æµçš„èµ›å‹ä»¬å­¦åˆ°äº†å¾ˆå¤šï¼Œä½†æœ€åå› ä¸ºä¸€ä¸ªå¾ˆå°çš„é—®é¢˜å¯¼è‡´è¿™æ ·ï¼Œè‡ªå·±çœŸçš„å®Œå…¨æ¥å—ä¸äº†ã€‚ä¸è¿‡äººç”Ÿæ€»æœ‰å¾—æœ‰å¤±å§ï¼Œå”‰ï¼Œå¤§å®¶å›½èµ›åŠ æ²¹ï¼<br />
æœ€åè®°å¾—æ ¹æ®é¢˜ç›®æ„æ€äº¤å‹ç¼©åŒ…ï¼Œè€Œä¸æ˜¯åªäº¤äº†ä¸€ä»½hexæ–‡ä»¶ï¼ï¼ï¼</p>
<h1 id="æœ€åé’å±±ä¸æ”¹ç¢§æ°´é•¿æµ"><a class="markdownIt-Anchor" href="#æœ€åé’å±±ä¸æ”¹ç¢§æ°´é•¿æµ"></a> æœ€åï¼Œé’å±±ä¸æ”¹ï¼Œç¢§æ°´é•¿æµ</h1>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>æ¯”èµ›</tag>
      </tags>
  </entry>
  <entry>
    <title>è°ƒè¯•BUGä¸ä¸€äº›è¯´æ˜</title>
    <url>/2025/05/08/%E8%B0%83%E8%AF%95BUG%E4%B8%8E%E4%B8%80%E4%BA%9B%E8%AF%B4%E6%98%8E/</url>
    <content><![CDATA[<p>è¿™é‡Œè®°å½•äº†è°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›è°ƒè¯•é—®é¢˜ï¼Œå¾€å¾€ä¸€å›°å°±æ˜¯å‡ å¤©ï¼Œäººéº»äº†ã€‚</p>
<h1 id="è°ƒè¯•bug"><a class="markdownIt-Anchor" href="#è°ƒè¯•bug"></a> è°ƒè¯•BUG</h1>
<h2 id="stm32èŠ¯ç‰‡è¢«é”"><a class="markdownIt-Anchor" href="#stm32èŠ¯ç‰‡è¢«é”"></a> STM32èŠ¯ç‰‡è¢«é”</h2>
<p>æœ‰ä¸€æ®µæ—¶é—´æ²¡ç”¨STM32èŠ¯ç‰‡ï¼Œå‘ç°<strong>ST-LINKè¯»ä¸åˆ°</strong>ï¼Œæ¯«æ— å¤´ç»ªã€‚</p>
<p><strong>è§£å†³åŠæ³•</strong>ï¼šä½¿ç”¨è½¯ä»¶<strong>STM32 ST-LINK Utility</strong>ï¼Œ<strong>ç‚¹å‡»Connect + æŒ‰ä½STM32ä¸ŠèŠ¯ç‰‡å¤ä½é”®</strong>æ‰èƒ½è¿æ¥ï¼Œè¿æ¥åå°†ç¨‹åºç»™æ¸…é™¤æ‰ï¼ŒæˆåŠŸè§£å†³ã€‚</p>
<h2 id="ä¸²å£é€šä¿¡å‡ºç°ä¹±ç "><a class="markdownIt-Anchor" href="#ä¸²å£é€šä¿¡å‡ºç°ä¹±ç "></a> ä¸²å£é€šä¿¡å‡ºç°ä¹±ç </h2>
<p>ç¼–ç æ ¼å¼ã€æ³¢ç‰¹ç‡ã€ä¸»é¢‘éƒ½å¯èƒ½æ˜¯é—®é¢˜åŸå› ï¼›</p>
<p><strong>å¦‚æœè¾“å…¥è‹±æ–‡å’Œæ•°å­—éƒ½å‡ºç°é—®é¢˜ï¼Œé‚£å¤§æ¦‚ç‡æ™¶æŒ¯é—®é¢˜ï¼Œçœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯ç„Šé”™äº†ã€‚</strong></p>
<h2 id="esp32çš„æ–°ç‰ˆi2cé©±åŠ¨ä¸äº†æ‘„åƒå¤´"><a class="markdownIt-Anchor" href="#esp32çš„æ–°ç‰ˆi2cé©±åŠ¨ä¸äº†æ‘„åƒå¤´"></a> ESP32çš„æ–°ç‰ˆI2Cé©±åŠ¨ä¸äº†æ‘„åƒå¤´</h2>
<p>è¿™ä¸ªé—®é¢˜æ¥è‡ªäº<strong>æ—§I2Cä¸æ”¯æŒæ–°ç‰ˆæ‘„åƒå¤´é©±åŠ¨</strong>ï¼Œä¸€ç›´æŠ¥é”™ï¼ŒESP IDF 5.4<strong>é™ä½</strong>åˆ°ESP IDF 5.2å³å¯ã€‚</p>
<p>æ›´æ–°è¿‡é©±åŠ¨ï¼Œä¹Ÿå®ç°äº†æ‘„åƒå¤´ï¼Œä½†æ˜¯é…åˆå…¶ä»–å¤–è®¾ä¹Ÿéœ€è¦ä¿®æ”¹å¯¹åº”çš„æ—§ç‰ˆI2Cï¼ˆæ¶²æ™¶å±è§¦æ‘¸ç­‰ï¼‰ï¼Œæš‚ä¸æ“ä½œã€‚</p>
<h1 id="ä¸€äº›è¯´æ˜"><a class="markdownIt-Anchor" href="#ä¸€äº›è¯´æ˜"></a> ä¸€äº›è¯´æ˜</h1>
<ul>
<li><code>#pragma once</code>ï¼Œè¡¨ç¤ºæœ¬å¤´æ–‡ä»¶åªå¯ä»¥åŒ…å«ä¸€æ¬¡ï¼Œç›¸å½“äº <code>#ifndef #define #endif</code></li>
</ul>
<h2 id="ä¸ºä»€ä¹ˆç¼–ç å™¨è¦ç”¨shortæ¥è¡¨ç¤º16ä½"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆç¼–ç å™¨è¦ç”¨shortæ¥è¡¨ç¤º16ä½"></a> ä¸ºä»€ä¹ˆç¼–ç å™¨è¦ç”¨shortæ¥è¡¨ç¤º16ä½</h2>
<p>STM32å¹³è¡¡è½¦é¡¹ç›®ä¸­å¤„ç†ç¼–ç å™¨çš„è®¡æ•°ä½¿ç”¨shortï¼›</p>
<p><strong>è®¡ç®—æœºå­˜çš„æ˜¯è¡¥ç </strong>ï¼Œshortå­—èŠ‚èŒƒå›´ï¼š-32768~ 32767ï¼Œè´Ÿæ•°ä¼šå˜æˆ32768 - n</p>
<p><strong>æ­£æ•°çš„åŸç  = åç  = è¡¥ç </strong></p>
<p><strong>è´Ÿæ•°çš„åç æ˜¯åŸç é™¤äº†ç¬¦å·ä½å…¶ä»–ä½å–åï¼Œè¡¥ç æ˜¯åç åŠ 1</strong></p>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>é¢œè‰²ã€å›¾ç‰‡ã€æ–‡å­—ã€å›¾æ ‡è®¾ç½®</title>
    <url>/2025/01/10/%E9%A2%9C%E8%89%B2%E3%80%81%E5%9B%BE%E7%89%87%E3%80%81%E6%96%87%E5%AD%97%E3%80%81%E5%9B%BE%E6%A0%87%E8%AE%BE%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="é¢œè‰²-å›¾ç‰‡-æ–‡å­—-å›¾æ ‡"><a class="markdownIt-Anchor" href="#é¢œè‰²-å›¾ç‰‡-æ–‡å­—-å›¾æ ‡"></a> é¢œè‰²ã€å›¾ç‰‡ã€æ–‡å­—ã€å›¾æ ‡</h1>
<h2 id="è®¾ç½®é¢œè‰²"><a class="markdownIt-Anchor" href="#è®¾ç½®é¢œè‰²"></a> è®¾ç½®é¢œè‰²</h2>
<ol>
<li><a href="https://vuetifyjs.com/en/styles/colors/#material-colors">Material color palette â€” Vuetify</a></li>
</ol>
<h2 id="è®¾ç½®å›¾ç‰‡"><a class="markdownIt-Anchor" href="#è®¾ç½®å›¾ç‰‡"></a> è®¾ç½®å›¾ç‰‡</h2>
<ol>
<li>å€ŸåŠ©<strong>Image2LCD</strong>è½¯ä»¶ï¼ŒæŒ‰ç…§å¦‚ä¸‹å›¾é…ç½®</li>
</ol>
<p><img src="https://s2.loli.net/2025/05/09/AV3Xr4FYEbSt1pL.png" style="zoom: 80%;" />å°†è¾“å‡ºçš„æ•°ç»„å­˜å…¥.hä¸­ï¼ŒåŠ ä¸Šstaticï¼Œåœ¨ä¸»å‡½æ•°è°ƒç”¨ã€‚</p>
<ol start="2">
<li><a href="https://lvgl.io/tools/imageconverter">Image Converter â€” LVGL</a></li>
</ol>
<h2 id="è®¾ç½®æ–‡å­—"><a class="markdownIt-Anchor" href="#è®¾ç½®æ–‡å­—"></a> è®¾ç½®æ–‡å­—</h2>
<ol>
<li>
<p><a href="https://www.zitijia.com/i/250417369808129081.html">é˜¿é‡Œå·´å·´æ™®æƒ ä½“ç³»åˆ—æ‰“åŒ…å…è´¹å­—ä½“ä¸‹è½½ - å­—ä½“æ‰“åŒ…å…è´¹ä¸‹è½½å°½åœ¨å­—ä½“å®¶</a></p>
</li>
<li>
<p><a href="https://fontconverter.com/zh/">å­—ä½“è½¬æ¢å™¨ â€“ å…è´¹åœ¨çº¿è½¬æ¢å­—ä½“</a></p>
</li>
<li>
<p><a href="https://lvgl.io/tools/fontconverter">Font Converter â€” LVGL</a></p>
</li>
</ol>
<h2 id="è®¾ç½®å›¾æ ‡"><a class="markdownIt-Anchor" href="#è®¾ç½®å›¾æ ‡"></a> è®¾ç½®å›¾æ ‡</h2>
<ol>
<li>
<p><a href="https://fontawesome.com/">Font Awesome</a></p>
</li>
<li>
<p><a href="https://www.iconfont.cn/">iconfont-é˜¿é‡Œå·´å·´çŸ¢é‡å›¾æ ‡åº“</a></p>
</li>
</ol>
]]></content>
      <categories>
        <category>åµŒå…¥å¼</category>
      </categories>
      <tags>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
</search>
