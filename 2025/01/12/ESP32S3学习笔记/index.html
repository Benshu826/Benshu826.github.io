<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="shortcut icon" href="/icons/favicon.ico">
    
     
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet">
    
<link rel="stylesheet" href="/css/main.css">

    
    







    
    
          

    
    
    
    
    <title>
        
            ESP32S3学习笔记 | Ben Shu &#39;s Blog
        
    </title>
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="app">
        <v-app>
            <v-content id="page">
                <v-container fluid>
                    <v-row>
                        <v-col cols="2" class="d-none d-md-block">
                            <div id="sidebar" class="float-right">
    <a href="/" rel="home">
        <v-avatar size=96>
            <img id="logo" src="/image/pic.jpg">     
        </v-avatar> 
    </a>
    <v-divider></v-divider>
    <div class="mini-menu">
        <v-btn icon href="/">
            <v-icon>home</v-icon>
        </v-btn>
        <v-btn icon href="/categories/">
            <v-icon>folder</v-icon>
        </v-btn>
        <v-btn icon href="/tags/">
            <v-icon>bookmark</v-icon>
        </v-btn>
        <v-btn icon @click="SetNightMode">
            <v-icon>{{ nightMode }}</v-icon>
        </v-btn>
    </div>
    <v-list id="main-menu" class="font-weight-bold" flat>
        
            
            <v-list-item href="/archives/" link>
            <v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon>
            <v-list-item-content>
                Archives
            </v-list-item-content>
            </v-list-item>
        
            
            <v-list-item href="/about/" link>
            <v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon>
            <v-list-item-content>
                About
            </v-list-item-content>
            </v-list-item>
        
    </v-list>
    <v-divider></v-divider>
    
        <div class="post-toc">
            <a href="/2025/01/12/ESP32S3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="toc-header">Table of Contents</a>
            <div class="toc-content">
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text"> 组成结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%A4%96%E8%AE%BE"><span class="toc-number">2.</span> <span class="toc-text"> 基础外设</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%89%E9%94%AEkey"><span class="toc-number">2.1.</span> <span class="toc-text"> 按键Key</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E4%BE%8B"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 样例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A7%BF%E6%80%81%E4%BC%A0%E6%84%9F%E5%99%A8qmi8658"><span class="toc-number">2.2.</span> <span class="toc-text"> 姿态传感器（QMI8658）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#io%E6%8B%93%E5%B1%95pac9557"><span class="toc-number">2.3.</span> <span class="toc-text"> IO拓展（PAC9557）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E8%BE%93%E5%85%A5es7210"><span class="toc-number">2.4.</span> <span class="toc-text"> 音频输入（ES7210）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#i2s%E7%9A%84io%E5%92%8C%E5%AF%84%E5%AD%98%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.1.</span> <span class="toc-text"> I2S的IO和寄存器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E5%87%86i2s%E5%92%8Ctdm_i2s%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.4.2.</span> <span class="toc-text"> 标准I2S和TDM_I2S模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E8%BE%93%E5%87%BAes8311"><span class="toc-number">2.5.</span> <span class="toc-text"> 音频输出（ES8311）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%B2%E6%99%B6%E6%98%BE%E7%A4%BAst7789ft6557"><span class="toc-number">2.6.</span> <span class="toc-text"> 液晶显示（ST7789+FT6557）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C"><span class="toc-number">2.6.1.</span> <span class="toc-text"> 实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%84%E5%83%8F%E5%A4%B4gc0308"><span class="toc-number">2.7.</span> <span class="toc-text"> 摄像头（GC0308）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C-2"><span class="toc-number">2.7.1.</span> <span class="toc-text"> 实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lvgl"><span class="toc-number">2.8.</span> <span class="toc-text"> LVGL</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text"> 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text"> 基础配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yml%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text"> yml文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text"> 参考</span></a></li></ol>
            </div>
        </div>
    

    <div id="footer">
        <div class="footer-social">
            
                
                <v-btn icon href="mailto:kb1000fx@gmail.com" target="_blank">
                    <v-icon>fas fa-envelope</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://github.com/kb1000fx" target="_blank">
                    <v-icon>fab fa-github</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://steamcommunity.com/profiles/76561198346798163" target="_blank">
                    <v-icon>fab fa-steam</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://weibo.com/kb1000fx" target="_blank">
                    <v-icon>fab fa-weibo</v-icon>
                </v-btn>
            
        </div>
        <v-divider></v-divider>
        <div class="footer-content">
            
                <span id="busuanzi_container_site_uv" style="display: none;"> 
                    Total Visitors <span id="busuanzi_value_site_uv"></span>
                </span>
                <br>
            
            <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a></span><br>
            <span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
            <span>
                &copy; 2021 - 2025 
                Big Ben
            </span>
        </div>
    </div>
</div>

                        </v-col>
                        <v-col cols="12" md="10">
                            <v-row>
  <v-col cols="12" md="8" align-self="end">
    <div id="site-header">
      <div id="site-title">
        <a href="/" rel="home">Ben Shu &#39;s Blog</a>
      </div>
      <div id="site-description"></div>
      <div id="mobile-menu" class="d-block d-md-none">
        <v-text-field label="请输入关键字" data-src="/search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field>
        <div class="mobile-mini-menu">
          <v-btn icon href="/">
              <v-icon>home</v-icon>
          </v-btn>
          <v-btn icon href="/categories/">
              <v-icon>folder</v-icon>
          </v-btn>
          <v-btn icon href="/tags/">
              <v-icon>bookmark</v-icon>
          </v-btn>
          <v-btn icon @click="SetNightMode">
              <v-icon>{{ nightMode }}</v-icon>
          </v-btn>
          
            
            <v-btn icon href="/archives/">
              <v-icon>archive</v-icon>
            </v-btn>
          
            
            <v-btn icon href="/about/">
              <v-icon>account_circle</v-icon>
            </v-btn>
          
        </div>
      </div>    
    </div>
  </v-col>  
  <v-col cols="4" align-self="end" class="d-none d-md-block">
    <v-col align-self="end">
      <v-text-field label="请输入关键字" data-src="/search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,true)"></v-text-field>
    </v-col> 
  </v-col>
</v-row>

                            <v-card class="elevation-2 post-card">
    
    
        <div class="post-header">
  <a class="post-header-title font-weight-medium" href="/2025/01/12/ESP32S3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">ESP32S3学习笔记</a>
  <div class="post-header-meta">   
    <span>
      <v-icon color="">event</v-icon>
      Posted on:&nbsp;2025-01-12
    </span>
    <span>
      <v-icon color="">event_available</v-icon>
      Edited on:&nbsp;2025-07-24
    </span>
    <span>
      <v-icon color="">folder</v-icon>
      In:&nbsp;<a class="category-link" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a>
    </span>
    
    <span>
      <v-icon color="">visibility</v-icon>
      Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
    </span>
    
  </div>
</div>

    
    
    
    
    <div class="post-content typo">
        <p>主要学习立创<strong>ESP32S3 N16R8</strong>的基本配置以及其各部件组成</p>
<h1 id="组成结构"><a class="markdownIt-Anchor" href="#组成结构"></a> 组成结构</h1>
<img src="https://s2.loli.net/2025/05/08/1dog3h8nKRCOMPW.png" style="zoom: 50%;" />
<img src="https://s2.loli.net/2025/05/08/DCTorxL4l6cPMYz.png" style="zoom:50%;" />
<table>
<thead>
<tr>
<th style="text-align:center">类别</th>
<th style="text-align:center">型号</th>
<th style="text-align:center">参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">模组</td>
<td style="text-align:center"><strong>ESP32-S3-WROOM-1-N16R8</strong></td>
<td style="text-align:center">搭载 Xtensa® 32 位 LX7 双核处理器，主频高达 <strong>240 MHz</strong>，内置<strong>SRAM 512kB</strong>，外置<strong>PSRAM 8MB</strong>，外置<strong>FLASH 16MB</strong>，2.4 GHz Wi-Fi (802.11 b/g/n) 40MHz带宽，Bluetooth 5 (LE) 和 Bluetooth Mesh，集成AI向量指令，加速神经网络计算和信号处理</td>
</tr>
<tr>
<td style="text-align:center">显示屏</td>
<td style="text-align:center"><strong>ST7789</strong></td>
<td style="text-align:center">2.0寸、IPS全视角、分辨率320*240、<strong>SPI接口</strong></td>
</tr>
<tr>
<td style="text-align:center">触摸屏</td>
<td style="text-align:center"><strong>FT6336</strong></td>
<td style="text-align:center">电容触摸、<strong>I2C接口</strong></td>
</tr>
<tr>
<td style="text-align:center">姿态传感器</td>
<td style="text-align:center"><strong>QMI8658</strong></td>
<td style="text-align:center">三轴加速度+三轴陀螺仪、<strong>I2C接口</strong></td>
</tr>
<tr>
<td style="text-align:center">音频DAC</td>
<td style="text-align:center"><strong>ES8311</strong></td>
<td style="text-align:center">单通道、<strong>I2C接口</strong></td>
</tr>
<tr>
<td style="text-align:center">音频ADC</td>
<td style="text-align:center"><strong>ES7210</strong></td>
<td style="text-align:center">四通道(开发板用三个通道)、<strong>I2C接口</strong></td>
</tr>
<tr>
<td style="text-align:center">音频功放</td>
<td style="text-align:center">NS4150B</td>
<td style="text-align:center">单声道D类音频放大器</td>
</tr>
<tr>
<td style="text-align:center">麦克风</td>
<td style="text-align:center">ZTS6216</td>
<td style="text-align:center">配套双路麦克风、模拟输出</td>
</tr>
<tr>
<td style="text-align:center">喇叭</td>
<td style="text-align:center">DB1811AB50</td>
<td style="text-align:center">1811音腔喇叭、1W</td>
</tr>
<tr>
<td style="text-align:center">USB HUB</td>
<td style="text-align:center">CH334F</td>
<td style="text-align:center">USB2.0 HUB</td>
</tr>
<tr>
<td style="text-align:center">USB转串口</td>
<td style="text-align:center">CH340K</td>
<td style="text-align:center">波特率最大2Mbps</td>
</tr>
<tr>
<td style="text-align:center">电源芯片</td>
<td style="text-align:center">SY8088AAC</td>
<td style="text-align:center">提供双路、每路1A</td>
</tr>
<tr>
<td style="text-align:center">GH1.25接口</td>
<td style="text-align:center"></td>
<td style="text-align:center">两路外拓传感器接口，可以给外部传感器供电5V和3.3V，可以作为GPIO、CAN、I2C、UART、PWM等接口</td>
</tr>
<tr>
<td style="text-align:center">TF卡接口</td>
<td style="text-align:center"></td>
<td style="text-align:center">采用1-SD模式与ESP32连接</td>
</tr>
<tr>
<td style="text-align:center">Type-C接口</td>
<td style="text-align:center"></td>
<td style="text-align:center">用于供电、程序下载、程序调试，以及USB数据通信</td>
</tr>
<tr>
<td style="text-align:center">按键</td>
<td style="text-align:center"></td>
<td style="text-align:center">一个复位按键、一个用户自定义按键</td>
</tr>
</tbody>
</table>
<h1 id="基础外设"><a class="markdownIt-Anchor" href="#基础外设"></a> 基础外设</h1>
<h2 id="按键key"><a class="markdownIt-Anchor" href="#按键key"></a> 按键Key</h2>
<h3 id="样例"><a class="markdownIt-Anchor" href="#样例"></a> 样例</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/FreeRTOS.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/task.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/queue.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;driver/gpio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> QueueHandle_t gpio_evt_queue = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> IRAM_ATTR <span class="title function_">gpio_isr_handler</span><span class="params">(<span class="type">void</span>* arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> gpio_num = (<span class="type">uint32_t</span>) arg;</span><br><span class="line">    xQueueSendFromISR(gpio_evt_queue, &amp;gpio_num, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gpio_task_example</span><span class="params">(<span class="type">void</span>* arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> io_num;</span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">        <span class="keyword">if</span>(xQueueReceive(gpio_evt_queue, &amp;io_num, portMAX_DELAY)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;GPIO[%&quot;</span>PRIu32<span class="string">&quot;] intr, val: %d\n&quot;</span>, io_num, gpio_get_level(io_num));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">gpio_config_t</span> io_conf = &#123;</span><br><span class="line">        .intr_type = GPIO_INTR_NEGEDGE, <span class="comment">//falling edge interrupt</span></span><br><span class="line">        .mode = GPIO_MODE_INPUT, <span class="comment">//set as input mode</span></span><br><span class="line">        .pin_bit_mask = <span class="number">1</span>&lt;&lt;GPIO_NUM_0, <span class="comment">//bit mask of the pins GPIO0</span></span><br><span class="line">        .pull_down_en = <span class="number">0</span>, <span class="comment">//disable pull-down mode</span></span><br><span class="line">        .pull_up_en = <span class="number">1</span> <span class="comment">//enable pull-up mode</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//configure GPIO with the given settings</span></span><br><span class="line">    gpio_config(&amp;io_conf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create a queue to handle gpio event from isr</span></span><br><span class="line">    gpio_evt_queue = xQueueCreate(<span class="number">10</span>, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">    <span class="comment">//start gpio task</span></span><br><span class="line">    xTaskCreate(gpio_task_example, <span class="string">&quot;gpio_task_example&quot;</span>, <span class="number">2048</span>, <span class="literal">NULL</span>, <span class="number">10</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//install gpio isr service</span></span><br><span class="line">    gpio_install_isr_service(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//hook isr handler for specific gpio pin</span></span><br><span class="line">    gpio_isr_handler_add(GPIO_NUM_0, gpio_isr_handler, (<span class="type">void</span>*) GPIO_NUM_0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="姿态传感器qmi8658"><a class="markdownIt-Anchor" href="#姿态传感器qmi8658"></a> 姿态传感器（QMI8658）</h2>
<p>I2C控制，地址<strong>QMI8658_SENSOR_ADDR= 0x6A</strong></p>
<p>内部集成 3 轴加速度传感器和 3 轴陀螺仪传感器，支持 <strong>SPI 和 I2C</strong> 通信</p>
<p><strong>I2C的频率</strong>为<strong>100000</strong></p>
<p>BSP_I2C_NUM为0</p>
<table>
<thead>
<tr>
<th style="text-align:center">说明</th>
<th style="text-align:center">PIN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">I2C_SCL</td>
<td style="text-align:center">GPIO_NUM_1</td>
</tr>
<tr>
<td style="text-align:center">I2C_SDA</td>
<td style="text-align:center">GPIO_NUM_2</td>
</tr>
</tbody>
</table>
<p><strong>计算倾斜角度</strong></p>
<p><img src="https://s2.loli.net/2025/05/08/lGz1Uq5tER89fs4.png" alt="" /></p>
<p><strong>配置qmi8658</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>  QMI8658_SENSOR_ADDR       0x6A</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">qmi8658_reg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    QMI8658_WHO_AM_I,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_I2CM_STATUS = <span class="number">44</span>,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_dQW_L = <span class="number">73</span>,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_RESET = <span class="number">96</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="type">void</span> qmi8658_init(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    qmi8658_register_read(QMI8658_WHO_AM_I, &amp;id ,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span> (id != <span class="number">0x05</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        vTaskDelay(<span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">        qmi8658_register_read(QMI8658_WHO_AM_I, &amp;id ,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ESP_LOGI(TAG, <span class="string">&quot;QMI8658 OK!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_RESET, <span class="number">0xb0</span>);  <span class="comment">// 复位</span></span><br><span class="line">    vTaskDelay(<span class="number">10</span> / portTICK_PERIOD_MS);</span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL1, <span class="number">0x40</span>); <span class="comment">// CTRL1 设置地址自动增加</span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL7, <span class="number">0x03</span>); <span class="comment">// CTRL7 允许加速度和陀螺仪</span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL2, <span class="number">0x95</span>); <span class="comment">// CTRL2 设置ACC 4g 250Hz</span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL3, <span class="number">0xd5</span>); <span class="comment">// CTRL3 设置GRY 512dps 250Hz</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读操作</span></span><br><span class="line"><span class="type">esp_err_t</span> <span class="title function_">qmi8658_register_read</span><span class="params">(<span class="type">uint8_t</span> reg_addr, <span class="type">uint8_t</span> *data, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> i2c_master_write_read_device(BSP_I2C_NUM, QMI8658_SENSOR_ADDR,  &amp;reg_addr, <span class="number">1</span>, data, len, <span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 写操作</span></span><br><span class="line"><span class="type">esp_err_t</span> <span class="title function_">qmi8658_register_write_byte</span><span class="params">(<span class="type">uint8_t</span> reg_addr, <span class="type">uint8_t</span> data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> write_buf[<span class="number">2</span>] = &#123;reg_addr, data&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i2c_master_write_to_device(BSP_I2C_NUM, QMI8658_SENSOR_ADDR, write_buf, <span class="keyword">sizeof</span>(write_buf), <span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>求取姿态数值</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">int16_t</span> acc_y;</span><br><span class="line">    <span class="type">int16_t</span> acc_x;</span><br><span class="line">    <span class="type">int16_t</span> acc_z;</span><br><span class="line">    <span class="type">int16_t</span> gyr_y;</span><br><span class="line">    <span class="type">int16_t</span> gyr_x;</span><br><span class="line">    <span class="type">int16_t</span> gyr_z;</span><br><span class="line">    <span class="type">float</span> AngleX;</span><br><span class="line">    <span class="type">float</span> AngleY;</span><br><span class="line">    <span class="type">float</span> AngleZ;</span><br><span class="line">&#125;t_sQMI8658;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取加速度和陀螺仪寄存器值</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">qmi8658_Read_AccAndGry</span><span class="params">(t_sQMI8658 *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> status, data_ready=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int16_t</span> buf[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">    qmi8658_register_read(QMI8658_STATUS0, &amp;status, <span class="number">1</span>); <span class="comment">// 读状态寄存器</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; <span class="number">0x03</span>) 					<span class="comment">// 判断加速度和陀螺仪数据是否可读</span></span><br><span class="line">        data_ready = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (data_ready == <span class="number">1</span>)&#123;  				<span class="comment">// 如果数据可读</span></span><br><span class="line">        data_ready = <span class="number">0</span>;</span><br><span class="line">        qmi8658_register_read(QMI8658_AX_L, (<span class="type">uint8_t</span> *)buf, <span class="number">12</span>); <span class="comment">// 读加速度和陀螺仪值</span></span><br><span class="line">        p-&gt;acc_x = buf[<span class="number">0</span>];</span><br><span class="line">        p-&gt;acc_y = buf[<span class="number">1</span>];</span><br><span class="line">        p-&gt;acc_z = buf[<span class="number">2</span>];</span><br><span class="line">        p-&gt;gyr_x = buf[<span class="number">3</span>];</span><br><span class="line">        p-&gt;gyr_y = buf[<span class="number">4</span>];</span><br><span class="line">        p-&gt;gyr_z = buf[<span class="number">5</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取XYZ轴的倾角值</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">qmi8658_fetch_angleFromAcc</span><span class="params">(t_sQMI8658 *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> temp;</span><br><span class="line"></span><br><span class="line">    qmi8658_Read_AccAndGry(p); <span class="comment">// 读取加速度和陀螺仪的寄存器值</span></span><br><span class="line">    <span class="comment">// 根据寄存器值 计算倾角值 并把弧度转换成角度</span></span><br><span class="line">    temp = (<span class="type">float</span>)p-&gt;acc_x / <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_y * (<span class="type">float</span>)p-&gt;acc_y + (<span class="type">float</span>)p-&gt;acc_z * (<span class="type">float</span>)p-&gt;acc_z) );</span><br><span class="line">    p-&gt;AngleX = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/π=57.29578</span></span><br><span class="line">    temp = (<span class="type">float</span>)p-&gt;acc_y / <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_x * (<span class="type">float</span>)p-&gt;acc_x + (<span class="type">float</span>)p-&gt;acc_z * (<span class="type">float</span>)p-&gt;acc_z) );</span><br><span class="line">    p-&gt;AngleY = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/π=57.29578</span></span><br><span class="line">    temp = <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_x * (<span class="type">float</span>)p-&gt;acc_x + (<span class="type">float</span>)p-&gt;acc_y * (<span class="type">float</span>)p-&gt;acc_y) ) / (<span class="type">float</span>)p-&gt;acc_z;</span><br><span class="line">    p-&gt;AngleZ = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/π=57.29578</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="io拓展pac9557"><a class="markdownIt-Anchor" href="#io拓展pac9557"></a> IO拓展（PAC9557）</h2>
<p>外设拓展口，由<strong>I2C控制</strong>，地址<strong>PCA9557_SENSOR_ADDR = 0x19</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LCD_CS 对应 PCA9557 的 IO0 引脚，PA_EN 对应 IO1 引脚，DVP_PWDN 对应 IO2 引脚</span></span><br></pre></td></tr></table></figure>
<h2 id="音频输入es7210"><a class="markdownIt-Anchor" href="#音频输入es7210"></a> 音频输入（ES7210）</h2>
<p>AD0接高电平，AD1接低电平，<strong>I2C地址为0x41</strong></p>
<p><strong>ES7210</strong> 连接 MIC <strong>负责音频输入</strong>，<strong>ES8311</strong> 只负责<strong>音频输出</strong></p>
<p><strong>ES7210 可以连接 4 个 MIC</strong>，开发板上连接了 3 个 MIC，<strong>MIC1 和 MIC2 接收人说话的声音</strong>， <strong>MIC3 连接了 ES8311 的输出</strong>，用于回声消除。</p>
<p>S3芯片会做回声消除，<strong>音响在播放声音的时候，可以说话打断它</strong>。</p>
<p>这个原理就是 ES8311 输出的信号，不仅给了喇叭，还给了 ES7210 的 MIC3 输入，ESP32 在接收到 MIC1 MIC2 和 MIC3 的声音后，可以分离出 MIC3，从而进行识别。</p>
<p><strong>本部分例程</strong></p>
<ol>
<li>
<p>初始化I2S总线</p>
</li>
<li>
<p>初始化ES7120芯片</p>
</li>
<li>
<p>加载SD卡</p>
</li>
<li>
<p>录制声音</p>
</li>
</ol>
<h3 id="i2s的io和寄存器配置"><a class="markdownIt-Anchor" href="#i2s的io和寄存器配置"></a> I2S的IO和寄存器配置</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_ES7210_I2C_ADDR    (0x41)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2C port and GPIOs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_NUM            (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_SDA_IO         (1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_SCL_IO         (2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2S port and GPIOs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_NUM            (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_MCK_IO         (38)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_BCK_IO         (14)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_WS_IO          (13)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_DI_IO          (12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2S configurations */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_TDM_FORMAT     (ES7210_I2S_FMT_I2S)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_CHAN_NUM       (2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_SAMPLE_RATE    (48000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_MCLK_MULTIPLE  (I2S_MCLK_MULTIPLE_256)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_SAMPLE_BITS    (I2S_DATA_BIT_WIDTH_16BIT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_TDM_SLOT_MASK  (I2S_TDM_SLOT0 | I2S_TDM_SLOT1)</span></span><br></pre></td></tr></table></figure>
<h3 id="标准i2s和tdm_i2s模式"><a class="markdownIt-Anchor" href="#标准i2s和tdm_i2s模式"></a> 标准I2S和TDM_I2S模式</h3>
<p>I2S模式</p>
<img src="https://s2.loli.net/2025/05/08/ejG41dOuWKL8rUX.png" style="zoom: 67%;" />
<p><strong>TDM_I2S模式</strong></p>
<img src="https://s2.loli.net/2025/05/08/oLIKBUTzCDepwHG.png" style="zoom:67%;" />
<p>ES7210工作在<strong>I2S模式</strong>时，只能<strong>采集2个通道</strong>，而工作在<strong>TDM_I2S</strong>模式时，可以<strong>采集4个通道</strong></p>
<h2 id="音频输出es8311"><a class="markdownIt-Anchor" href="#音频输出es8311"></a> 音频输出（ES8311）</h2>
<p>主函数包括：</p>
<ol>
<li><code>i2s_driver_init()</code> 函数初始化 i2s 接口</li>
<li><code>es8311_codec_init()</code> 函数初始化 <strong>i2c 接口并初始化 es8311 芯片</strong></li>
<li><code>pca9557_init()</code> 函数初始化 IO 扩展芯片 pca9557</li>
<li><code>pa_en()</code> 函数用于控制音频功放的打开和关闭，IO1引脚</li>
<li><code>i2s_music()</code> 函数是创建的任务函数，用于播放音乐</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_INPUT_PORT              0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_OUTPUT_PORT             0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_POLARITY_INVERSION_PORT 0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_CONFIGURATION_PORT      0x03</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_CS_GPIO                 BIT(0)    <span class="comment">// PCA9557_GPIO_NUM_1</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PA_EN_GPIO                  BIT(1)    <span class="comment">// PCA9557_GPIO_NUM_2</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DVP_PWDN_GPIO               BIT(2)    <span class="comment">// PCA9557_GPIO_NUM_3</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_SENSOR_ADDR   0x19        <span class="comment">/*!&lt; Slave address of the MPU9250 sensor */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_BITS(_m, _s, _v)  ((_v) ? (_m)|((_s)) : (_m)&amp;~((_s)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pca9557_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lcd_cs</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pa_en</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dvp_pwdn</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="comment">// 初始化PCA9557 IO扩展芯片</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pca9557_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 写入控制引脚默认值 DVP_PWDN=1  PA_EN = 0  LCD_CS = 1</span></span><br><span class="line">    pca9557_register_write_byte(PCA9557_OUTPUT_PORT, <span class="number">0x05</span>);</span><br><span class="line">    <span class="comment">// 把PCA9557芯片的IO1 IO1 IO2设置为输出(0) 其它引脚保持默认的输入(1)</span></span><br><span class="line">    pca9557_register_write_byte(PCA9557_CONFIGURATION_PORT, <span class="number">0xf8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="液晶显示st7789ft6557"><a class="markdownIt-Anchor" href="#液晶显示st7789ft6557"></a> 液晶显示（ST7789+FT6557）</h2>
<p><strong>使用SPI驱动</strong>，存储到SPIRAM中</p>
<p>液晶屏显示的开关有两个，一个是 <code>esp_lcd_panel_disp_on_off()</code>，一个是 <code>bsp_display_backlight_on()</code></p>
<p>区别：</p>
<p><code>esp_lcd_panel_disp_on_off()</code> 用来控制的是液晶屏的驱动芯片 ST7789 中的寄存器，这个寄存器<strong>控制液晶屏显示</strong>与否。</p>
<p><code>bsp_display_backlight_on()</code> 用来控制液晶屏 LED 背光，通过<strong>调节 PWM 占空比调节亮度</strong>，使用的是 LEDC 外设产生的 PWM 信号。</p>
<p><code>esp_lcd_panel_swap_xy()</code> 函数控制 xy 坐标翻转，第 2 个参数，true 表示翻转，false 表示不翻转。</p>
<p><code>esp_lcd_panel_mirror()</code> 函数控制 xy 方向是否镜像。第 2 个参数控制 x 方向，第 3 个参数控制 y 方向，true 表示镜像，false 表示不镜像。</p>
<h3 id="实验"><a class="markdownIt-Anchor" href="#实验"></a> 实验</h3>
<p>IO42 引脚控制液晶屏的背光，<strong>低电平亮</strong>，如果 <strong>IO42 引脚输出 PWM 信号</strong>，就可以通过调节占空比，均匀的<strong>控制液晶屏的背光亮度</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_BACKLIGHT     (GPIO_NUM_42)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_LEDC_CH          LEDC_CHANNEL_0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_PIXEL_CLOCK_HZ     (80 * 1000 * 1000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_NUM            (SPI3_HOST)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_CMD_BITS               (8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_PARAM_BITS             (8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_BITS_PER_PIXEL     (16)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_MOSI      (GPIO_NUM_40)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_CLK       (GPIO_NUM_41)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_CS        (GPIO_NUM_NC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_DC            (GPIO_NUM_39)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_RST           (GPIO_NUM_NC)</span></span><br></pre></td></tr></table></figure>
<p><strong>亮度调节函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">esp_err_t</span> <span class="title function_">bsp_display_brightness_set</span><span class="params">(<span class="type">int</span> brightness_percent)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (brightness_percent &gt; <span class="number">100</span>) &#123;</span><br><span class="line">        brightness_percent = <span class="number">100</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (brightness_percent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        brightness_percent = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ESP_LOGI(TAG, <span class="string">&quot;Setting LCD backlight: %d%%&quot;</span>, brightness_percent);</span><br><span class="line">    <span class="comment">// LEDC resolution set to 10bits, thus: 100% = 1023</span></span><br><span class="line">    <span class="type">uint32_t</span> duty_cycle = (<span class="number">1023</span> * brightness_percent) / <span class="number">100</span>;</span><br><span class="line">    BSP_ERROR_CHECK_RETURN_ERR(ledc_set_duty(LEDC_LOW_SPEED_MODE, LCD_LEDC_CH, duty_cycle));</span><br><span class="line">    BSP_ERROR_CHECK_RETURN_ERR(ledc_update_duty(LEDC_LOW_SPEED_MODE, LCD_LEDC_CH));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ESP_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="摄像头gc0308"><a class="markdownIt-Anchor" href="#摄像头gc0308"></a> 摄像头（GC0308）</h2>
<p>一般 <strong>500W 像素以下</strong>的摄像头模块，使用 <strong>DVP 接口</strong>，<strong>以上的使用 MIPI 接口</strong>。MIPI 接口速度要高于 DVP 接口。</p>
<p>GC0308 摄像头最大分辨率 640 * 480，30W 像素，工作在 24MHz 频率下，输出 240 *320 分辨率时，可达 30 帧。</p>
<h3 id="实验-2"><a class="markdownIt-Anchor" href="#实验-2"></a> 实验</h3>
<p>PWDN 引脚控制摄像头进入待机模式和工作模式，<strong>高电平进入待机模式</strong>，<strong>低电平进入工作模式</strong></p>
<p><code>.ledc_channel</code> 和 <code>.ledc_timer</code>中，LEDC 外设用来给某个引脚产生 PWM 信号，这里可以用来产生时钟信号给摄像头的 XCLK 引脚。但是 <strong>S3 芯片用不着</strong>，因为 S3 芯片的 CAM 外设会产生 XCLK 信号。关于这一点，看 ESP32-S3 的技术参考手册可以了解到。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让摄像头显示到LCD</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_camera_lcd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    xQueueLCDFrame = xQueueCreate(<span class="number">2</span>, <span class="keyword">sizeof</span>(<span class="type">camera_fb_t</span> *));</span><br><span class="line">    xTaskCreatePinnedToCore(task_process_camera, <span class="string">&quot;task_process_camera&quot;</span>, <span class="number">3</span> * <span class="number">1024</span>, <span class="literal">NULL</span>, <span class="number">5</span>, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">    xTaskCreatePinnedToCore(task_process_lcd, <span class="string">&quot;task_process_lcd&quot;</span>, <span class="number">4</span> * <span class="number">1024</span>, <span class="literal">NULL</span>, <span class="number">5</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建了两个任务，一个任务是摄像头获取画面的任务，一个是液晶屏显示画面的任务。其中，还创建了一个队列信号，摄像头获取到画面，发送队列信号通知 LCD 显示。<strong>ESP32S3 是双核处理器</strong>，这两个任务，一个定义在 CPU0 上运行，一个定义在 CPU1 上运行，这样可以提高运行速度。xTaskCreatePinnedToCore()函数的最后一个参数，用来定义在哪个 CPU 上运行。</p>
<p><strong>esp_camera_fb_get()函数</strong>用来获取一帧摄像头图像，并把获取到的一帧信息返回</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_PWDN -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_RESET -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_XCLK 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_SIOD 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_SIOC 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D7 9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D6 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D5 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D4 15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D3 17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D2 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D1 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D0 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_VSYNC 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_HREF 46</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_PCLK 7</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XCLK_FREQ_HZ 24000000</span></span><br></pre></td></tr></table></figure>
<h2 id="lvgl"><a class="markdownIt-Anchor" href="#lvgl"></a> LVGL</h2>
<p>LVGL（Light and Versatile Graphics Library）是一个开源的图形用户界面库，旨在为嵌入式系统提供轻量级、可移植、灵活且易于使用的图形用户界面解决方案</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发板显示初始化</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bsp_lvgl_start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 初始化LVGL */</span></span><br><span class="line">    <span class="type">lvgl_port_cfg_t</span> lvgl_cfg = ESP_LVGL_PORT_INIT_CONFIG();</span><br><span class="line">    lvgl_port_init(&amp;lvgl_cfg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化液晶屏 并添加LVGL接口，自己写 */</span></span><br><span class="line">    disp = bsp_display_lcd_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化触摸屏 并添加LVGL接口，自己写 */</span></span><br><span class="line">    disp_indev = bsp_display_indev_init(disp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 打开液晶屏背光 */</span></span><br><span class="line">    bsp_display_backlight_on();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    bsp_i2c_init();  		<span class="comment">// I2C初始化</span></span><br><span class="line">    pca9557_init();  		<span class="comment">// IO扩展芯片初始化</span></span><br><span class="line"></span><br><span class="line">    bsp_lvgl_start(); 		<span class="comment">// 初始化lvgl显示</span></span><br><span class="line">    lv_demo_benchmark(); 	<span class="comment">// 调用lvgl demo</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h1>
<h2 id="基础配置"><a class="markdownIt-Anchor" href="#基础配置"></a> 基础配置</h2>
<ul>
<li>
<p><strong>Flash = 16MB</strong></p>
</li>
<li>
<p>要存储MP3文件，需要设置FAT文件系统，<strong>Default block size = 4096</strong></p>
</li>
<li>
<p>使用SPI，需要设置SPIRAM，<strong>应用外存，Octal（8线SPI） Mode PSRAM，80MHz clock speed</strong></p>
</li>
<li>
<p>调用摄像头，设置<strong>CPU频率为240MHz</strong>，还有如下</p>
<img src="https://s2.loli.net/2025/05/09/zKmQhEqObg7tDY4.png" style="zoom:67%;" />
</li>
<li>
<p>使用LVGL，需要<strong>设置反转颜色</strong>，Color settings下的Swap the 2 bytes of…<strong>打勾</strong></p>
</li>
<li>
<p>设置其他字体，Font usage可以开启 <strong>Enable Monserrat 24</strong>等</p>
</li>
</ul>
<h2 id="yml文件"><a class="markdownIt-Anchor" href="#yml文件"></a> yml文件</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">lvgl/lvgl:</span> <span class="string">~8.3.0</span></span><br><span class="line">  <span class="attr">espressif/esp_lvgl_port:</span> <span class="string">~1.4.0</span>             <span class="comment"># LVGL接口</span></span><br><span class="line">  <span class="attr">espressif/esp_lcd_touch_ft5x06:</span> <span class="string">~1.0.6</span>      <span class="comment"># 触摸屏驱动</span></span><br><span class="line">  <span class="attr">chmorgan/esp-audio-player:</span> <span class="string">~1.0.7</span>           <span class="comment"># 音频播放</span></span><br><span class="line">  <span class="attr">chmorgan/esp-file-iterator:</span> <span class="number">1.0</span><span class="number">.0</span>           <span class="comment"># 获取文件</span></span><br><span class="line">  <span class="attr">espressif/esp_codec_dev:</span> <span class="string">~1.3.0</span>             <span class="comment"># 音频驱动</span></span><br><span class="line">  <span class="attr">espressif/esp-sr:</span> <span class="string">~1.6.0</span>                    <span class="comment"># 语音识别</span></span><br><span class="line">  <span class="attr">espressif/zlib:</span> <span class="string">^1.3.0</span></span><br><span class="line">  <span class="attr">espressif/esp32-camera:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="comment">## Required IDF version</span></span><br><span class="line">  <span class="attr">idf:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">~5.2.5</span></span><br></pre></td></tr></table></figure>
<h1 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h1>
<p><a target="_blank" rel="noopener" href="https://wiki.lckfb.com/zh-hans/szpi-esp32s3/download-center.html">【下载中心】实战派 | 立创开发板技术文档中心</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/MJiarong_personal/article/details/121726585">【ESP32-S3的开发】| 1.初识 ESP32-S3_esp32s3引脚图详细解释-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/gsm-wheather-project/gsm-weather-esp32s3-esp-idf5.0/tree/master/components">components · GSM-Weather-project/gsm-weather-esp32s3-esp-idf5.0 - 码云 - 开源中国</a></p>

    </div>
    <!--文末结束语-->
    
        <div style="text-align:center;color: #ccc;font-size:24px;"> --- 本文结束 <i class="fas fa-heart"></i> The End --- </div>
    
    <!--页脚广告-->
    
    <v-divider></v-divider>
    
    <div class="post-nav">             
        
            <div class="post-nav-button float-left">
                <v-icon>chevron_left</v-icon>
                <a class="font-weight-bold text-left" href="/2025/02/22/%E5%9F%BA%E4%BA%8EESP32%E7%9A%84%E6%99%BA%E8%83%BD%E7%BB%88%E7%AB%AF%E7%B3%BB%E7%BB%9F/">
                    基于ESP32S3的智能终端系统
                </a>
            </div>
              
          
            <div class="post-nav-button float-right">
                <a class="font-weight-bold text-right" href="/2025/01/10/%E9%A2%9C%E8%89%B2%E3%80%81%E5%9B%BE%E7%89%87%E3%80%81%E6%96%87%E5%AD%97%E3%80%81%E5%9B%BE%E6%A0%87%E8%AE%BE%E7%BD%AE/">      
                    颜色、图片、文字、图标设置
                </a>
                <v-icon>chevron_right</v-icon>
            </div>
        
    </div>
</v-card>



        
                            <div id="mobile-footer" class="d-block d-md-none">
                                <v-divider></v-divider>
                                <div id="mobile-footer-content">
                                    <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a> &nbsp; Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
                                    <span> &copy; 2021 - 2025 Big Ben</span>
                                </div>
                            </div>                   
                        </v-col>                                            
                    </v-row>
                </v-container>
            </v-content>
        </v-app>
    </div>
    
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script>

<script src="/js/main.js"></script>




    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>





</body>
</html>