<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    
    <link rel="apple-touch-icon" sizes="76x76" href="/null">
    <link rel="icon" type="image/png" href="/null">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>ESP32S3学习笔记 - Ben Shu &#39;s Blog</title>
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    
    <meta name="description" content="">
    <meta name="author" content="Big Ben">
    <meta name="keywords" content="">
    <meta property="og:title" content="ESP32S3学习笔记"/>
    <style>


    
    :root{
        --shadow-color: rgba(0,0,0,0.2);
        --sec-shadow: rgba(0,0,0,0.03);
        --shadow-hover-color: rgba(0,0,0,0.28);
        --first-text-color: #475b6d;
        --second-text-color: #37475b;
        --third-text-color: #858585;
        --default-text-color: #505050;
        --default-link-color: #007bff;
        --link-color: #000000;
        --second-link-color: #4F9BFA;
        --code-color:rgba(27,31,35,.05);
        --post-bkg-color: #fff;
        --page-bkg-color: #f2f5f8;
        --nav-a-hover-color: #3498db;
        --post-sec-text-color: #718096;
        --sec-bkg: #f2f5f8;
        --color-mode: 'light';
        --bkg-h: rgba(255,255,255,0.6);
        --bkg-m: #e1e4e8;
        --home-title-color: #4169E1;
        --shadow: 0 4px 10px rgba(0,2,4,0.06),0 0 1px rgba(0,2,4,0.11);
        --hr-color: #ddd;
        --bg-t: #f4f4f4;
        --nav-bkg: rgba(255,255,255,0.6);
    }

@media (prefers-color-scheme: dark) {
  :root {
    --color-mode: 'dark';
  }

  :root:not([data-theme]) {
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
  }
}

[data-theme='dark'] {
    --shadow-color: rgba(0,0,0,0.2);
    --shadow-hover-color: rgba(0,0,0,0.28);
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
}

</style>



<style>
#page-main,footer,.p-btn{
    display: none;
}
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
}
body {
    background-color: var(--page-bkg-color);
    color: var(--second-text-color);
    overflow-y: scroll;
    overflow-x: hidden;
    transition: all .3s;
}
a {
    color: var(--default-link-color);
    text-decoration: none;
    background-color: transparent;
}
a:hover{
    color: var(--second-link-color);
}
.main-content,.post-card-main{
    margin: 30px;
}



@media (max-width: 410px){
    .post-card-main{
        max-width: 350px!important;
    }
}

@media (max-width: 980px){
    .post-card-main{
        max-width: 520px!important;
    }
}


@media (min-width: 780px){ 
    h3{
        font-size: 1.5rem;
        line-height: 1.5em;
    }
}
@media (min-width: 1280px){ 
    h3{
        font-size: 1.7rem;
        line-height: 1.5em;
    }
}
@media (min-width: 2096px){ 
    h3{
        font-size: 1.8rem;
        line-height: 1.5em;
    }
}

.text-center{
    text-align: center!important;
}
.middle-center{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    height: 100%;
}
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    height: 54px;
    padding: 0 1.25rem;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    border-bottom: 1px solid var(--bkg-m);
    background-color: var(--nav-bkg);
    backdrop-filter: blur(4px);
    transition: all .3s;
}
header .header__left, header .header__right {
    display: flex;
    align-items: center;
    font-family: rubik,sans-serif,Varela Round;
}
header .header__left .logo__text {
    font-size: 18px;
    font-weight: 450;
    padding: 14.5px 10px;
    border-radius: 5px;
    color: var(--second-text-color);
}
header .header__right .navbar__menus {
    height: 54px;
    padding: 0 0 0 15px;
}
header .header__right .button {
    color: var(--second-text-color);
}
header .header__right .navbar__menus .navbar-menu {
    display: inline-block;
    align-items: center;
    height: 54px;
    padding: 0 10px;
    font-size: 16px;
    line-height: 54px;
}
header .header__right .dropdown-icon {
    display: none;
    height: 54px;
    padding: 15px 10px;
    border: 0;
    background-color: transparent;
}
header .header__right .dropdown-menus {
    line-height: 2rem;
    animation: slide-in .15s ease 1;
    display: none;
    position: absolute;
    left: 12px;
    right: 12px;
    top: calc(54px + 10px);
    border-radius: 6px;
    padding: 24px;
    background-color: var(--page-bkg-color);
    border: 1px solid var(--bkg-m);
    z-index: 9999;
    justify-items: center;
    justify-content: center;
    flex-direction: column;
}
header .header__right #btn-search, header .header__right #btn-toggle-dark{
    display: inline-block;
    padding:  18px 10px;
    height: 25px;
}
header .header__right #btn-dropdown{
  display: inline-block;
  padding:  13.5px 0;
}
header .header__right .dropdown-menus .dropdown-menu {
    padding: 10px;
    color: var(--second-text-color);
}
@media screen and (max-width: 764px){
.navbar__menus {
    display: none!important;
}
.dropdown-icon {
    display: inline-block!important;
}
}
.p-btn{
    position: fixed;
    bottom: 1.2rem;
    right: 1.2rem;
    contain: layout;
}
.toc-btn,.click-btn{
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    align-items: center;
    margin-top: .5rem;
    font-size: .75rem;
    background-color: var(--sec-bkg);
    display: block;
    padding: 0.9rem;
    box-shadow: 0 0.3rem 0.6rem rgba(48,55,66,.15);
    border: none;
    border-radius: 0.5rem;
    line-height: 1;
    color: var(--first-text-color);
}
.toc-link{
    color: var(--second-text-color);
}

#css-loading h3{
    font-weight: 500;
    font-size: 1.4rem;
    text-align: center;
    position: fixed;
    top: 200px;
    left: 0;
    right: 0;
    opacity: 0;
    animation: cssLoad;
    animation-delay: 0.3s;
    -webkit-animation: cssLoad;
    -webkit-animation-delay: 0.3s;
}
@keyframes cssLoad {
    from {
        opacity: 0;
    }
    to {
        opacity: 0.9;
    }
}


.memorial {
    -webkit-filter: grayscale(100%);
    -moz-filter: grayscale(100%);
    -ms-filter: grayscale(100%);
    -o-filter: grayscale(100%);
    filter: grayscale(100%);
    filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1); filter:gray;
}


    .post-copyright:after {
        position: absolute;
        color: #fff;
        background: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");
        content: ' ';
        height: 10rem;
        width: 10rem;
        right: -2rem;
        top: -2rem;
        opacity: .1;
    }

</style>

    

    
        <!--
        <link rel="stylesheet" href="/css/page.css" media="print"
            onload="this.media='all';this.onload=null">
        <noscript>-->
            <link rel="stylesheet" href="/css/page.css">
        <!--</noscript>-->
    
    
    <link rel="stylesheet" href="/css/main.css" media="print" onload="this.media='all';this.onload=null">
    <noscript>
        <link rel="stylesheet" href="/css/main.css">
    </noscript>

    
    <script src="/js/main.js"></script>
    
      
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

    <body>
        <header>
            
<div class="header__left">
	<a href="/" class="button"><span class="logo__text">主页</span></a>
</div>
<div class="header__right">
	<div class="navbar__menus">
		
		<a href="/" class="button">
			<div class="navbar-menu">首页</div>
		</a>
		
		<a href="/archives/" class="button">
			<div class="navbar-menu">归档</div>
		</a>
		
		<a href="/categories/" class="button">
			<div class="navbar-menu">分类</div>
		</a>
		
		<a href="/tags/" class="button">
			<div class="navbar-menu">标签</div>
		</a>
		
		<a href="/about/" class="button">
			<div class="navbar-menu">关于</div>
		</a>
		
	</div>
	
	<a href="/search/" class="button">
		<div id="btn-search">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32">
				<path
					d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z">
				</path>
			</svg>
		</div>
	</a>
	
	<a href="javaScript:void(0);" class="button" id="btn-toggle-dark">
		<div>
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none"
				stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
			</svg>
		</div>
	</a>
	<a href="javaScript:void(0);" class="dropdown-icon button">
		<div id="btn-dropdown">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32" stroke-linecap="round">
				<path
					d="M903.43 561.52H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 204.31H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 918.73H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24z"
					fill="currentColor"></path>
			</svg>
		</div>
	</a>
	<div class="dropdown-menus" id="dropdown-menus">
		
		<a href="/" class="dropdown-menu button">首页</a>
		<br>
		
		<a href="/archives/" class="dropdown-menu button">归档</a>
		<br>
		
		<a href="/categories/" class="dropdown-menu button">分类</a>
		<br>
		
		<a href="/tags/" class="dropdown-menu button">标签</a>
		<br>
		
		<a href="/about/" class="dropdown-menu button">关于</a>
		<br>
		
	</div>
</div>

        </header>
        <div id="top"></div>
        <div id="page-main" class="main-content">
        <div class="mg-top">
            

<article class="page">
<div id="post-meta-m">
    <div class="post-meta" id="post-meta">
  <h3>ESP32S3学习笔记</h3>
    
      <span class="post-meta-label">
        Big Ben
      </span>
    
    
      <span class="post-meta-label">
        <span class="p-dot"></span>
        <time datetime="2025-01-12 09:50" pubdate>
          2025-01-12
        </time>
      </span>
    
    
      
      <span class="post-meta">
        <span class="p-dot"></span>
        共 2.8k 字
      </span>
    
    
    
  </div>
  
</div>
<div class="article-m">
  <div class="post-toc">
    
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text"> 组成结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%A4%96%E8%AE%BE"><span class="toc-number">2.</span> <span class="toc-text"> 基础外设</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%89%E9%94%AEkey"><span class="toc-number">2.1.</span> <span class="toc-text"> 按键Key</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E4%BE%8B"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 样例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A7%BF%E6%80%81%E4%BC%A0%E6%84%9F%E5%99%A8qmi8658"><span class="toc-number">2.2.</span> <span class="toc-text"> 姿态传感器（QMI8658）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#io%E6%8B%93%E5%B1%95pac9557"><span class="toc-number">2.3.</span> <span class="toc-text"> IO拓展（PAC9557）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E8%BE%93%E5%85%A5es7210"><span class="toc-number">2.4.</span> <span class="toc-text"> 音频输入（ES7210）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#i2s%E7%9A%84io%E5%92%8C%E5%AF%84%E5%AD%98%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.1.</span> <span class="toc-text"> I2S的IO和寄存器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E5%87%86i2s%E5%92%8Ctdm_i2s%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.4.2.</span> <span class="toc-text"> 标准I2S和TDM_I2S模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E8%BE%93%E5%87%BAes8311"><span class="toc-number">2.5.</span> <span class="toc-text"> 音频输出（ES8311）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%B2%E6%99%B6%E6%98%BE%E7%A4%BAst7789ft6557"><span class="toc-number">2.6.</span> <span class="toc-text"> 液晶显示（ST7789+FT6557）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C"><span class="toc-number">2.6.1.</span> <span class="toc-text"> 实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%84%E5%83%8F%E5%A4%B4gc0308"><span class="toc-number">2.7.</span> <span class="toc-text"> 摄像头（GC0308）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C-2"><span class="toc-number">2.7.1.</span> <span class="toc-text"> 实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lvgl"><span class="toc-number">2.8.</span> <span class="toc-text"> LVGL</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text"> 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text"> 基础配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yml%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text"> yml文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text"> 参考</span></a></li></ol>
    
  </div>
    <div id="article">
      <div id="post-content" class="markdown-body textretty">
        <p>主要学习立创<strong>ESP32S3 N16R8</strong>的基本配置以及其各部件组成</p>
<h1 id="组成结构"><a class="markdownIt-Anchor" href="#组成结构"></a> 组成结构</h1>
<img src="https://s2.loli.net/2025/05/08/1dog3h8nKRCOMPW.png" style="zoom: 50%;" />
<img src="https://s2.loli.net/2025/05/08/DCTorxL4l6cPMYz.png" style="zoom:50%;" />
<table>
<thead>
<tr>
<th style="text-align:center">类别</th>
<th style="text-align:center">型号</th>
<th style="text-align:center">参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">模组</td>
<td style="text-align:center"><strong>ESP32-S3-WROOM-1-N16R8</strong></td>
<td style="text-align:center">搭载 Xtensa® 32 位 LX7 双核处理器，主频高达 <strong>240 MHz</strong>，内置<strong>SRAM 512kB</strong>，外置<strong>PSRAM 8MB</strong>，外置<strong>FLASH 16MB</strong>，2.4 GHz Wi-Fi (802.11 b/g/n) 40MHz带宽，Bluetooth 5 (LE) 和 Bluetooth Mesh，集成AI向量指令，加速神经网络计算和信号处理</td>
</tr>
<tr>
<td style="text-align:center">显示屏</td>
<td style="text-align:center"><strong>ST7789</strong></td>
<td style="text-align:center">2.0寸、IPS全视角、分辨率320*240、<strong>SPI接口</strong></td>
</tr>
<tr>
<td style="text-align:center">触摸屏</td>
<td style="text-align:center"><strong>FT6336</strong></td>
<td style="text-align:center">电容触摸、<strong>I2C接口</strong></td>
</tr>
<tr>
<td style="text-align:center">姿态传感器</td>
<td style="text-align:center"><strong>QMI8658</strong></td>
<td style="text-align:center">三轴加速度+三轴陀螺仪、<strong>I2C接口</strong></td>
</tr>
<tr>
<td style="text-align:center">音频DAC</td>
<td style="text-align:center"><strong>ES8311</strong></td>
<td style="text-align:center">单通道、<strong>I2C接口</strong></td>
</tr>
<tr>
<td style="text-align:center">音频ADC</td>
<td style="text-align:center"><strong>ES7210</strong></td>
<td style="text-align:center">四通道(开发板用三个通道)、<strong>I2C接口</strong></td>
</tr>
<tr>
<td style="text-align:center">音频功放</td>
<td style="text-align:center">NS4150B</td>
<td style="text-align:center">单声道D类音频放大器</td>
</tr>
<tr>
<td style="text-align:center">麦克风</td>
<td style="text-align:center">ZTS6216</td>
<td style="text-align:center">配套双路麦克风、模拟输出</td>
</tr>
<tr>
<td style="text-align:center">喇叭</td>
<td style="text-align:center">DB1811AB50</td>
<td style="text-align:center">1811音腔喇叭、1W</td>
</tr>
<tr>
<td style="text-align:center">USB HUB</td>
<td style="text-align:center">CH334F</td>
<td style="text-align:center">USB2.0 HUB</td>
</tr>
<tr>
<td style="text-align:center">USB转串口</td>
<td style="text-align:center">CH340K</td>
<td style="text-align:center">波特率最大2Mbps</td>
</tr>
<tr>
<td style="text-align:center">电源芯片</td>
<td style="text-align:center">SY8088AAC</td>
<td style="text-align:center">提供双路、每路1A</td>
</tr>
<tr>
<td style="text-align:center">GH1.25接口</td>
<td style="text-align:center"></td>
<td style="text-align:center">两路外拓传感器接口，可以给外部传感器供电5V和3.3V，可以作为GPIO、CAN、I2C、UART、PWM等接口</td>
</tr>
<tr>
<td style="text-align:center">TF卡接口</td>
<td style="text-align:center"></td>
<td style="text-align:center">采用1-SD模式与ESP32连接</td>
</tr>
<tr>
<td style="text-align:center">Type-C接口</td>
<td style="text-align:center"></td>
<td style="text-align:center">用于供电、程序下载、程序调试，以及USB数据通信</td>
</tr>
<tr>
<td style="text-align:center">按键</td>
<td style="text-align:center"></td>
<td style="text-align:center">一个复位按键、一个用户自定义按键</td>
</tr>
</tbody>
</table>
<h1 id="基础外设"><a class="markdownIt-Anchor" href="#基础外设"></a> 基础外设</h1>
<h2 id="按键key"><a class="markdownIt-Anchor" href="#按键key"></a> 按键Key</h2>
<h3 id="样例"><a class="markdownIt-Anchor" href="#样例"></a> 样例</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/FreeRTOS.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/task.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/queue.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;driver/gpio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> QueueHandle_t gpio_evt_queue = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> IRAM_ATTR <span class="title function_">gpio_isr_handler</span><span class="params">(<span class="type">void</span>* arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> gpio_num = (<span class="type">uint32_t</span>) arg;</span><br><span class="line">    xQueueSendFromISR(gpio_evt_queue, &amp;gpio_num, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gpio_task_example</span><span class="params">(<span class="type">void</span>* arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> io_num;</span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">        <span class="keyword">if</span>(xQueueReceive(gpio_evt_queue, &amp;io_num, portMAX_DELAY)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;GPIO[%&quot;</span>PRIu32<span class="string">&quot;] intr, val: %d\n&quot;</span>, io_num, gpio_get_level(io_num));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">gpio_config_t</span> io_conf = &#123;</span><br><span class="line">        .intr_type = GPIO_INTR_NEGEDGE, <span class="comment">//falling edge interrupt</span></span><br><span class="line">        .mode = GPIO_MODE_INPUT, <span class="comment">//set as input mode</span></span><br><span class="line">        .pin_bit_mask = <span class="number">1</span>&lt;&lt;GPIO_NUM_0, <span class="comment">//bit mask of the pins GPIO0</span></span><br><span class="line">        .pull_down_en = <span class="number">0</span>, <span class="comment">//disable pull-down mode</span></span><br><span class="line">        .pull_up_en = <span class="number">1</span> <span class="comment">//enable pull-up mode</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//configure GPIO with the given settings</span></span><br><span class="line">    gpio_config(&amp;io_conf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create a queue to handle gpio event from isr</span></span><br><span class="line">    gpio_evt_queue = xQueueCreate(<span class="number">10</span>, <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">    <span class="comment">//start gpio task</span></span><br><span class="line">    xTaskCreate(gpio_task_example, <span class="string">&quot;gpio_task_example&quot;</span>, <span class="number">2048</span>, <span class="literal">NULL</span>, <span class="number">10</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//install gpio isr service</span></span><br><span class="line">    gpio_install_isr_service(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//hook isr handler for specific gpio pin</span></span><br><span class="line">    gpio_isr_handler_add(GPIO_NUM_0, gpio_isr_handler, (<span class="type">void</span>*) GPIO_NUM_0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="姿态传感器qmi8658"><a class="markdownIt-Anchor" href="#姿态传感器qmi8658"></a> 姿态传感器（QMI8658）</h2>
<p>I2C控制，地址<strong>QMI8658_SENSOR_ADDR= 0x6A</strong></p>
<p>内部集成 3 轴加速度传感器和 3 轴陀螺仪传感器，支持 <strong>SPI 和 I2C</strong> 通信</p>
<p><strong>I2C的频率</strong>为<strong>100000</strong></p>
<p>BSP_I2C_NUM为0</p>
<table>
<thead>
<tr>
<th style="text-align:center">说明</th>
<th style="text-align:center">PIN</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">I2C_SCL</td>
<td style="text-align:center">GPIO_NUM_1</td>
</tr>
<tr>
<td style="text-align:center">I2C_SDA</td>
<td style="text-align:center">GPIO_NUM_2</td>
</tr>
</tbody>
</table>
<p><strong>计算倾斜角度</strong>（四元法）</p>
<p><img src="https://s2.loli.net/2025/05/08/lGz1Uq5tER89fs4.png" alt="" /></p>
<p><strong>配置qmi8658</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>  QMI8658_SENSOR_ADDR       0x6A</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">qmi8658_reg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    QMI8658_WHO_AM_I,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_I2CM_STATUS = <span class="number">44</span>,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_dQW_L = <span class="number">73</span>,</span><br><span class="line">    ......</span><br><span class="line">    QMI8658_RESET = <span class="number">96</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="type">void</span> qmi8658_init(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    qmi8658_register_read(QMI8658_WHO_AM_I, &amp;id ,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span> (id != <span class="number">0x05</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        vTaskDelay(<span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">        qmi8658_register_read(QMI8658_WHO_AM_I, &amp;id ,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ESP_LOGI(TAG, <span class="string">&quot;QMI8658 OK!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_RESET, <span class="number">0xb0</span>);  <span class="comment">// 复位</span></span><br><span class="line">    vTaskDelay(<span class="number">10</span> / portTICK_PERIOD_MS);</span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL1, <span class="number">0x40</span>); <span class="comment">// CTRL1 设置地址自动增加</span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL7, <span class="number">0x03</span>); <span class="comment">// CTRL7 允许加速度和陀螺仪</span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL2, <span class="number">0x95</span>); <span class="comment">// CTRL2 设置ACC 4g 250Hz</span></span><br><span class="line">    qmi8658_register_write_byte(QMI8658_CTRL3, <span class="number">0xd5</span>); <span class="comment">// CTRL3 设置GRY 512dps 250Hz</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读操作</span></span><br><span class="line"><span class="type">esp_err_t</span> <span class="title function_">qmi8658_register_read</span><span class="params">(<span class="type">uint8_t</span> reg_addr, <span class="type">uint8_t</span> *data, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> i2c_master_write_read_device(BSP_I2C_NUM, QMI8658_SENSOR_ADDR,  &amp;reg_addr, <span class="number">1</span>, data, len, <span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 写操作</span></span><br><span class="line"><span class="type">esp_err_t</span> <span class="title function_">qmi8658_register_write_byte</span><span class="params">(<span class="type">uint8_t</span> reg_addr, <span class="type">uint8_t</span> data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> write_buf[<span class="number">2</span>] = &#123;reg_addr, data&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i2c_master_write_to_device(BSP_I2C_NUM, QMI8658_SENSOR_ADDR, write_buf, <span class="keyword">sizeof</span>(write_buf), <span class="number">1000</span> / portTICK_PERIOD_MS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>求取姿态数值</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">int16_t</span> acc_y;</span><br><span class="line">    <span class="type">int16_t</span> acc_x;</span><br><span class="line">    <span class="type">int16_t</span> acc_z;</span><br><span class="line">    <span class="type">int16_t</span> gyr_y;</span><br><span class="line">    <span class="type">int16_t</span> gyr_x;</span><br><span class="line">    <span class="type">int16_t</span> gyr_z;</span><br><span class="line">    <span class="type">float</span> AngleX;</span><br><span class="line">    <span class="type">float</span> AngleY;</span><br><span class="line">    <span class="type">float</span> AngleZ;</span><br><span class="line">&#125;t_sQMI8658;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取加速度和陀螺仪寄存器值</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">qmi8658_Read_AccAndGry</span><span class="params">(t_sQMI8658 *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> status, data_ready=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int16_t</span> buf[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">    qmi8658_register_read(QMI8658_STATUS0, &amp;status, <span class="number">1</span>); <span class="comment">// 读状态寄存器</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; <span class="number">0x03</span>) 					<span class="comment">// 判断加速度和陀螺仪数据是否可读</span></span><br><span class="line">        data_ready = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (data_ready == <span class="number">1</span>)&#123;  				<span class="comment">// 如果数据可读</span></span><br><span class="line">        data_ready = <span class="number">0</span>;</span><br><span class="line">        qmi8658_register_read(QMI8658_AX_L, (<span class="type">uint8_t</span> *)buf, <span class="number">12</span>); <span class="comment">// 读加速度和陀螺仪值</span></span><br><span class="line">        p-&gt;acc_x = buf[<span class="number">0</span>];</span><br><span class="line">        p-&gt;acc_y = buf[<span class="number">1</span>];</span><br><span class="line">        p-&gt;acc_z = buf[<span class="number">2</span>];</span><br><span class="line">        p-&gt;gyr_x = buf[<span class="number">3</span>];</span><br><span class="line">        p-&gt;gyr_y = buf[<span class="number">4</span>];</span><br><span class="line">        p-&gt;gyr_z = buf[<span class="number">5</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取XYZ轴的倾角值</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">qmi8658_fetch_angleFromAcc</span><span class="params">(t_sQMI8658 *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> temp;</span><br><span class="line"></span><br><span class="line">    qmi8658_Read_AccAndGry(p); <span class="comment">// 读取加速度和陀螺仪的寄存器值</span></span><br><span class="line">    <span class="comment">// 根据寄存器值 计算倾角值 并把弧度转换成角度</span></span><br><span class="line">    temp = (<span class="type">float</span>)p-&gt;acc_x / <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_y * (<span class="type">float</span>)p-&gt;acc_y + (<span class="type">float</span>)p-&gt;acc_z * (<span class="type">float</span>)p-&gt;acc_z) );</span><br><span class="line">    p-&gt;AngleX = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/π=57.29578</span></span><br><span class="line">    temp = (<span class="type">float</span>)p-&gt;acc_y / <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_x * (<span class="type">float</span>)p-&gt;acc_x + (<span class="type">float</span>)p-&gt;acc_z * (<span class="type">float</span>)p-&gt;acc_z) );</span><br><span class="line">    p-&gt;AngleY = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/π=57.29578</span></span><br><span class="line">    temp = <span class="built_in">sqrt</span>( ((<span class="type">float</span>)p-&gt;acc_x * (<span class="type">float</span>)p-&gt;acc_x + (<span class="type">float</span>)p-&gt;acc_y * (<span class="type">float</span>)p-&gt;acc_y) ) / (<span class="type">float</span>)p-&gt;acc_z;</span><br><span class="line">    p-&gt;AngleZ = <span class="built_in">atan</span>(temp)*<span class="number">57.29578f</span>; <span class="comment">// 180/π=57.29578</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="io拓展pac9557"><a class="markdownIt-Anchor" href="#io拓展pac9557"></a> IO拓展（PAC9557）</h2>
<p>外设拓展口，由<strong>I2C控制</strong>，地址<strong>PCA9557_SENSOR_ADDR = 0x19</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LCD_CS 对应 PCA9557 的 IO0 引脚，PA_EN 对应 IO1 引脚，DVP_PWDN 对应 IO2 引脚</span></span><br></pre></td></tr></table></figure>
<h2 id="音频输入es7210"><a class="markdownIt-Anchor" href="#音频输入es7210"></a> 音频输入（ES7210）</h2>
<p>AD0接高电平，AD1接低电平，<strong>I2C地址为0x41</strong></p>
<p><strong>ES7210</strong> 连接 MIC <strong>负责音频输入</strong>，<strong>ES8311</strong> 只负责<strong>音频输出</strong></p>
<p><strong>ES7210 可以连接 4 个 MIC</strong>，开发板上连接了 3 个 MIC，<strong>MIC1 和 MIC2 接收人说话的声音</strong>， <strong>MIC3 连接了 ES8311 的输出</strong>，用于回声消除。</p>
<p>S3芯片会做回声消除，<strong>音响在播放声音的时候，可以说话打断它</strong>。</p>
<p>这个原理就是 ES8311 输出的信号，不仅给了喇叭，还给了 ES7210 的 MIC3 输入，ESP32 在接收到 MIC1 MIC2 和 MIC3 的声音后，可以分离出 MIC3，从而进行识别。</p>
<p><strong>本部分例程</strong></p>
<ol>
<li>
<p>初始化I2S总线</p>
</li>
<li>
<p>初始化ES7120芯片</p>
</li>
<li>
<p>加载SD卡</p>
</li>
<li>
<p>录制声音</p>
</li>
</ol>
<h3 id="i2s的io和寄存器配置"><a class="markdownIt-Anchor" href="#i2s的io和寄存器配置"></a> I2S的IO和寄存器配置</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_ES7210_I2C_ADDR    (0x41)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2C port and GPIOs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_NUM            (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_SDA_IO         (1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2C_SCL_IO         (2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2S port and GPIOs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_NUM            (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_MCK_IO         (38)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_BCK_IO         (14)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_WS_IO          (13)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_DI_IO          (12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2S configurations */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_TDM_FORMAT     (ES7210_I2S_FMT_I2S)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_CHAN_NUM       (2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_SAMPLE_RATE    (48000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_MCLK_MULTIPLE  (I2S_MCLK_MULTIPLE_256)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_SAMPLE_BITS    (I2S_DATA_BIT_WIDTH_16BIT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXAMPLE_I2S_TDM_SLOT_MASK  (I2S_TDM_SLOT0 | I2S_TDM_SLOT1)</span></span><br></pre></td></tr></table></figure>
<h3 id="标准i2s和tdm_i2s模式"><a class="markdownIt-Anchor" href="#标准i2s和tdm_i2s模式"></a> 标准I2S和TDM_I2S模式</h3>
<p>I2S模式</p>
<img src="https://s2.loli.net/2025/05/08/ejG41dOuWKL8rUX.png" style="zoom: 67%;" />
<p><strong>TDM_I2S模式</strong></p>
<img src="https://s2.loli.net/2025/05/08/oLIKBUTzCDepwHG.png" style="zoom:67%;" />
<p>ES7210工作在<strong>I2S模式</strong>时，只能<strong>采集2个通道</strong>，而工作在<strong>TDM_I2S</strong>模式时，可以<strong>采集4个通道</strong></p>
<h2 id="音频输出es8311"><a class="markdownIt-Anchor" href="#音频输出es8311"></a> 音频输出（ES8311）</h2>
<p>主函数包括：</p>
<ol>
<li><code>i2s_driver_init()</code> 函数初始化 i2s 接口</li>
<li><code>es8311_codec_init()</code> 函数初始化 <strong>i2c 接口并初始化 es8311 芯片</strong></li>
<li><code>pca9557_init()</code> 函数初始化 IO 扩展芯片 pca9557</li>
<li><code>pa_en()</code> 函数用于控制音频功放的打开和关闭，IO1引脚</li>
<li><code>i2s_music()</code> 函数是创建的任务函数，用于播放音乐</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_INPUT_PORT              0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_OUTPUT_PORT             0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_POLARITY_INVERSION_PORT 0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_CONFIGURATION_PORT      0x03</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_CS_GPIO                 BIT(0)    <span class="comment">// PCA9557_GPIO_NUM_1</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PA_EN_GPIO                  BIT(1)    <span class="comment">// PCA9557_GPIO_NUM_2</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DVP_PWDN_GPIO               BIT(2)    <span class="comment">// PCA9557_GPIO_NUM_3</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCA9557_SENSOR_ADDR   0x19        <span class="comment">/*!&lt; Slave address of the MPU9250 sensor */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_BITS(_m, _s, _v)  ((_v) ? (_m)|((_s)) : (_m)&amp;~((_s)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pca9557_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lcd_cs</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pa_en</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dvp_pwdn</span><span class="params">(<span class="type">uint8_t</span> level)</span>;</span><br><span class="line"><span class="comment">// 初始化PCA9557 IO扩展芯片</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pca9557_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 写入控制引脚默认值 DVP_PWDN=1  PA_EN = 0  LCD_CS = 1</span></span><br><span class="line">    pca9557_register_write_byte(PCA9557_OUTPUT_PORT, <span class="number">0x05</span>);</span><br><span class="line">    <span class="comment">// 把PCA9557芯片的IO1 IO1 IO2设置为输出(0) 其它引脚保持默认的输入(1)</span></span><br><span class="line">    pca9557_register_write_byte(PCA9557_CONFIGURATION_PORT, <span class="number">0xf8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="液晶显示st7789ft6557"><a class="markdownIt-Anchor" href="#液晶显示st7789ft6557"></a> 液晶显示（ST7789+FT6557）</h2>
<p><strong>使用SPI驱动</strong>，存储到SPIRAM中</p>
<p>液晶屏显示的开关有两个，一个是 <code>esp_lcd_panel_disp_on_off()</code>，一个是 <code>bsp_display_backlight_on()</code></p>
<p>区别：</p>
<p><code>esp_lcd_panel_disp_on_off()</code> 用来控制的是液晶屏的驱动芯片 ST7789 中的寄存器，这个寄存器<strong>控制液晶屏显示</strong>与否。</p>
<p><code>bsp_display_backlight_on()</code> 用来控制液晶屏 LED 背光，通过<strong>调节 PWM 占空比调节亮度</strong>，使用的是 LEDC 外设产生的 PWM 信号。</p>
<p><code>esp_lcd_panel_swap_xy()</code> 函数控制 xy 坐标翻转，第 2 个参数，true 表示翻转，false 表示不翻转。</p>
<p><code>esp_lcd_panel_mirror()</code> 函数控制 xy 方向是否镜像。第 2 个参数控制 x 方向，第 3 个参数控制 y 方向，true 表示镜像，false 表示不镜像。</p>
<h3 id="实验"><a class="markdownIt-Anchor" href="#实验"></a> 实验</h3>
<p>IO42 引脚控制液晶屏的背光，<strong>低电平亮</strong>，如果 <strong>IO42 引脚输出 PWM 信号</strong>，就可以通过调节占空比，均匀的<strong>控制液晶屏的背光亮度</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_BACKLIGHT     (GPIO_NUM_42)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_LEDC_CH          LEDC_CHANNEL_0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_PIXEL_CLOCK_HZ     (80 * 1000 * 1000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_NUM            (SPI3_HOST)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_CMD_BITS               (8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_PARAM_BITS             (8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_BITS_PER_PIXEL     (16)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_MOSI      (GPIO_NUM_40)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_CLK       (GPIO_NUM_41)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_SPI_CS        (GPIO_NUM_NC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_DC            (GPIO_NUM_39)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSP_LCD_RST           (GPIO_NUM_NC)</span></span><br></pre></td></tr></table></figure>
<p><strong>亮度调节函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">esp_err_t</span> <span class="title function_">bsp_display_brightness_set</span><span class="params">(<span class="type">int</span> brightness_percent)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (brightness_percent &gt; <span class="number">100</span>) &#123;</span><br><span class="line">        brightness_percent = <span class="number">100</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (brightness_percent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        brightness_percent = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ESP_LOGI(TAG, <span class="string">&quot;Setting LCD backlight: %d%%&quot;</span>, brightness_percent);</span><br><span class="line">    <span class="comment">// LEDC resolution set to 10bits, thus: 100% = 1023</span></span><br><span class="line">    <span class="type">uint32_t</span> duty_cycle = (<span class="number">1023</span> * brightness_percent) / <span class="number">100</span>;</span><br><span class="line">    BSP_ERROR_CHECK_RETURN_ERR(ledc_set_duty(LEDC_LOW_SPEED_MODE, LCD_LEDC_CH, duty_cycle));</span><br><span class="line">    BSP_ERROR_CHECK_RETURN_ERR(ledc_update_duty(LEDC_LOW_SPEED_MODE, LCD_LEDC_CH));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ESP_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="摄像头gc0308"><a class="markdownIt-Anchor" href="#摄像头gc0308"></a> 摄像头（GC0308）</h2>
<p>一般 <strong>500W 像素以下</strong>的摄像头模块，使用 <strong>DVP 接口</strong>，<strong>以上的使用 MIPI 接口</strong>。MIPI 接口速度要高于 DVP 接口。</p>
<p>GC0308 摄像头最大分辨率 640 * 480，30W 像素，工作在 24MHz 频率下，输出 240 *320 分辨率时，可达 30 帧。</p>
<h3 id="实验-2"><a class="markdownIt-Anchor" href="#实验-2"></a> 实验</h3>
<p>PWDN 引脚控制摄像头进入待机模式和工作模式，<strong>高电平进入待机模式</strong>，<strong>低电平进入工作模式</strong></p>
<p><code>.ledc_channel</code> 和 <code>.ledc_timer</code>中，LEDC 外设用来给某个引脚产生 PWM 信号，这里可以用来产生时钟信号给摄像头的 XCLK 引脚。但是 <strong>S3 芯片用不着</strong>，因为 S3 芯片的 CAM 外设会产生 XCLK 信号。关于这一点，看 ESP32-S3 的技术参考手册可以了解到。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让摄像头显示到LCD</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_camera_lcd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    xQueueLCDFrame = xQueueCreate(<span class="number">2</span>, <span class="keyword">sizeof</span>(<span class="type">camera_fb_t</span> *));</span><br><span class="line">    xTaskCreatePinnedToCore(task_process_camera, <span class="string">&quot;task_process_camera&quot;</span>, <span class="number">3</span> * <span class="number">1024</span>, <span class="literal">NULL</span>, <span class="number">5</span>, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">    xTaskCreatePinnedToCore(task_process_lcd, <span class="string">&quot;task_process_lcd&quot;</span>, <span class="number">4</span> * <span class="number">1024</span>, <span class="literal">NULL</span>, <span class="number">5</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建了两个任务，一个任务是摄像头获取画面的任务，一个是液晶屏显示画面的任务。其中，还创建了一个队列信号，摄像头获取到画面，发送队列信号通知 LCD 显示。<strong>ESP32S3 是双核处理器</strong>，这两个任务，一个定义在 CPU0 上运行，一个定义在 CPU1 上运行，这样可以提高运行速度。xTaskCreatePinnedToCore()函数的最后一个参数，用来定义在哪个 CPU 上运行。</p>
<p><strong>esp_camera_fb_get()函数</strong>用来获取一帧摄像头图像，并把获取到的一帧信息返回</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_PWDN -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_RESET -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_XCLK 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_SIOD 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_SIOC 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D7 9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D6 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D5 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D4 15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D3 17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D2 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D1 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_D0 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_VSYNC 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_HREF 46</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_PIN_PCLK 7</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XCLK_FREQ_HZ 24000000</span></span><br></pre></td></tr></table></figure>
<h2 id="lvgl"><a class="markdownIt-Anchor" href="#lvgl"></a> LVGL</h2>
<p>LVGL（Light and Versatile Graphics Library）是一个开源的图形用户界面库，旨在为嵌入式系统提供轻量级、可移植、灵活且易于使用的图形用户界面解决方案</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发板显示初始化</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bsp_lvgl_start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 初始化LVGL */</span></span><br><span class="line">    <span class="type">lvgl_port_cfg_t</span> lvgl_cfg = ESP_LVGL_PORT_INIT_CONFIG();</span><br><span class="line">    lvgl_port_init(&amp;lvgl_cfg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化液晶屏 并添加LVGL接口，自己写 */</span></span><br><span class="line">    disp = bsp_display_lcd_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化触摸屏 并添加LVGL接口，自己写 */</span></span><br><span class="line">    disp_indev = bsp_display_indev_init(disp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 打开液晶屏背光 */</span></span><br><span class="line">    bsp_display_backlight_on();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    bsp_i2c_init();  		<span class="comment">// I2C初始化</span></span><br><span class="line">    pca9557_init();  		<span class="comment">// IO扩展芯片初始化</span></span><br><span class="line"></span><br><span class="line">    bsp_lvgl_start(); 		<span class="comment">// 初始化lvgl显示</span></span><br><span class="line">    lv_demo_benchmark(); 	<span class="comment">// 调用lvgl demo</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h1>
<h2 id="基础配置"><a class="markdownIt-Anchor" href="#基础配置"></a> 基础配置</h2>
<ul>
<li>
<p><strong>Flash = 16MB</strong></p>
</li>
<li>
<p>要存储MP3文件，需要设置FAT文件系统，<strong>Default block size = 4096</strong></p>
</li>
<li>
<p>使用SPI，需要设置SPIRAM，<strong>应用外存，Octal（8线SPI） Mode PSRAM，80MHz clock speed</strong></p>
</li>
<li>
<p>调用摄像头，设置<strong>CPU频率为240MHz</strong>，还有如下</p>
<img src="https://s2.loli.net/2025/05/09/zKmQhEqObg7tDY4.png" style="zoom:67%;" />
</li>
<li>
<p>使用LVGL，需要<strong>设置反转颜色</strong>，Color settings下的Swap the 2 bytes of…<strong>打勾</strong></p>
</li>
<li>
<p>设置其他字体，Font usage可以开启 <strong>Enable Monserrat 24</strong>等</p>
</li>
</ul>
<h2 id="yml文件"><a class="markdownIt-Anchor" href="#yml文件"></a> yml文件</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">lvgl/lvgl:</span> <span class="string">~8.3.0</span></span><br><span class="line">  <span class="attr">espressif/esp_lvgl_port:</span> <span class="string">~1.4.0</span>             <span class="comment"># LVGL接口</span></span><br><span class="line">  <span class="attr">espressif/esp_lcd_touch_ft5x06:</span> <span class="string">~1.0.6</span>      <span class="comment"># 触摸屏驱动</span></span><br><span class="line">  <span class="attr">chmorgan/esp-audio-player:</span> <span class="string">~1.0.7</span>           <span class="comment"># 音频播放</span></span><br><span class="line">  <span class="attr">chmorgan/esp-file-iterator:</span> <span class="number">1.0</span><span class="number">.0</span>           <span class="comment"># 获取文件</span></span><br><span class="line">  <span class="attr">espressif/esp_codec_dev:</span> <span class="string">~1.3.0</span>             <span class="comment"># 音频驱动</span></span><br><span class="line">  <span class="attr">espressif/esp-sr:</span> <span class="string">~1.6.0</span>                    <span class="comment"># 语音识别</span></span><br><span class="line">  <span class="attr">espressif/zlib:</span> <span class="string">^1.3.0</span></span><br><span class="line">  <span class="attr">espressif/esp32-camera:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="comment">## Required IDF version</span></span><br><span class="line">  <span class="attr">idf:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">~5.2.5</span></span><br></pre></td></tr></table></figure>
<h1 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h1>
<p><a target="_blank" rel="noopener" href="https://wiki.lckfb.com/zh-hans/szpi-esp32s3/download-center.html">【下载中心】实战派 | 立创开发板技术文档中心</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/MJiarong_personal/article/details/121726585">【ESP32-S3的开发】| 1.初识 ESP32-S3_esp32s3引脚图详细解释-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/gsm-wheather-project/gsm-weather-esp32s3-esp-idf5.0/tree/master/components">components · GSM-Weather-project/gsm-weather-esp32s3-esp-idf5.0 - 码云 - 开源中国</a></p>

      </div>
    </div>
</div>

<div class="post-category">

    <div id="p-meta-i">
        
              
                <a class="hover-with-bg" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a>
              
          
          
              
                <a class="hover-with-bg" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"># 学习笔记</a>
              
                <a class="hover-with-bg" href="/tags/ESP/"># ESP</a>
              
          
    </div>
</div>


<div class="post-footer">
  

</div>

</article>


        </div>
        
<footer class="text-center">
    
    
    
    
    
    <p>&copy;  2022 - 2025&nbsp;&nbsp;本书</p>
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme by <a href="https://github.com/oCoke/hexo-theme-miracle" target="_blank">Miracle</a></p>
    
    
</footer>

<div class="p-btn">
    
        <a class="toc-btn" id="toc-btn"><i id="i-menu"></i></a>
    
    
      <a class="toc-btn" id="share-btn"><i>
        <svg t="1670124379155" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2683" width="25" height="25"><path d="M395.946667 234.666667v64H256v469.333333h512V522.666667h64V768a64 64 0 0 1-64 64H256a64 64 0 0 1-64-64V298.666667a64 64 0 0 1 64-64h139.946667z m335.850666-87.914667l150.848 150.826667-158.378666 158.4-45.269334-45.248L748.394667 341.333333H672c-121.685333 0-220.714667 97.024-223.914667 217.941334L448 565.333333v85.333334h-64v-85.333334C384 406.272 512.938667 277.333333 672 277.333333h99.861333l-85.312-85.333333 45.248-45.248z" p-id="2684" fill="var(--first-text-color)"></path></svg>
      </i></a>
    
    <a href="javascript:window.scrollTo({top:0,behavior:'smooth'});" class="click-btn">
      <i id="i-up"></i>
    </a>
</div>

<!-- SCRIPTS -->






<script>
    document.getElementById("btn-dropdown").addEventListener('click', () => {
      toggleClass("#dropdown-menus","display-inline");
    });
    console.log('\n' + ' %c Powered by Hexo Theme Miracle ' + ' %c https://github.com/oCoke/hexo-theme-miracle ' + '\n' + '\n', 'color: #fff; background: #4F9BFA; padding:5px 0;', 'background: #FFF; padding:5px 0;');

    

    
  /* 小彩蛋: 饮茶先啦 */
  setTimeout(() => {
    var time = new Date();
    if (time.getHours() == 15) {
      let comment = document.createComment(' 三点几嚟！饮茶先啦！ ');
      document.body.insertBefore(comment, document.getElementsByTagName('header')[0]);
    }
  },1);
    
</script>


<script>
    var postImg = document.querySelectorAll("article[class=page] img");
    for (let imgi = 0; imgi < postImg.length; imgi++) {
        postImg[imgi].onclick = () => {
            let zoomImg = document.createElement("div");
            zoomImg.id = "zoomImg";
            zoomImg.innerHTML = `<div id="zoom-picture"></div>
    <div class="poptrox-overlay"
        style="position: fixed; left: 0px; top: 0px; z-index: 20000; width: 100%; height: 100%; text-align: center; cursor: zoom-out; opacity: 1;">
        <div style="display:inline-block;height:100%;vertical-align:middle;"></div>
        <div
            style="position:absolute;left:0;top:0;width:100%;height:100%;background:#000000;opacity:0;filter:alpha(opacity=0);">
        </div>
        <div class="poptrox-popup"
            style="display: inline-block; vertical-align: middle; position: relative; z-index: 1; cursor: zoom-out; min-width: 10px; min-height: 10px; width: auto; height: auto;">
            <div class="loader" style="display: none;"></div>
            <div class="pic" style="text-indent: 0px;"><img
                    src="${ postImg[imgi].srcset || postImg[imgi].src }" alt="Loading..."
                    style="vertical-align: bottom; max-width: 85vw; max-height: 85vh;"></div>
        </div>
    </div>`;
            document.body.appendChild(zoomImg);
                document.querySelector("#zoomImg").onclick = () => {
                    document.querySelector("#zoomImg").remove();
                }
        }
    }
    
</script>




    <script>
        query("#toc-btn")[0].onclick = () => {
            if (query(".post-toc")[0].innerHTML) {
                toggleClass(".post-toc", "display-inline");
            }
        }

        if (!query(".post-toc")[0].innerHTML) {
            addClass("#toc-btn","display-none");
        }
    </script>



    <script>
        query("#share-btn")[0].onclick = async () => {
            let url = `${location.protocol}//${location.hostname}${location.port ? ":"+location.port:location.port}${location.pathname}#read=${sessionStorage.getItem(location.pathname+"_read_y") || ""}`;
            try {
                await navigator.clipboard.writeText(url);
                prompt_core("分享链接已经复制至剪贴板", 4800, true);
            } catch(e) {
                prompt_core("分享链接复制失败，请手动复制<br/>"+url, 4800, false);
            }
        }
    </script>







    <script>
        const getScrollPosition = (el = window) => ({
            x: el.pageXOffset !== undefined ? el.pageXOffset : el.scrollLeft,
            y: el.pageYOffset !== undefined ? el.pageYOffset : el.scrollTop
        });
        // 此处的 750 是「页面元素的最大宽度」
        var wx = document.getElementsByClassName("article-m")[0].clientWidth;
        var wy = document.getElementsByClassName("article-m")[0].clientHeight;
        function windowScroll() {
            // 反复修改 确保页面尺寸不改变
            wx = document.getElementsByClassName("article-m")[0].clientWidth;
            wy = document.getElementsByClassName("article-m")[0].clientHeight;
            let y = Math.round(getScrollPosition().y);
            // console.log(y);
            // 组合字符串，同时记录页面坐标，页面宽度和高度
            let p = `${y}:${wx}:${wy}`;
            // 写入到 sessionStorage 中
            sessionStorage.setItem(location.pathname + "_read_y", p);
        }
        // URL 中是否包含传递的坐标信息
        setTimeout(() => {
            if (location.hash.split("#read=").length > 1) {
                prompt_core("已有阅读进度，正在跳转", 4800, true);
                // 分离字符串
                let read_y = location.hash.split("#read=")[1];
                read_y = read_y.split(":");
                // 组合乘积，顺滑移动至坐标
                window.scrollTo({top: Math.round(Number(read_y[0]) * Number(read_y[1] * Number(read_y[2] / wx / wy))), behavior: "smooth"});
            } else {
                // 从 sessionStorage 中获取
                let read_y = sessionStorage.getItem(location.pathname + "_read_y") || "0:0:0";
                read_y = read_y.split(":");
                if (read_y[0] != "0") prompt_core("已有阅读进度，正在跳转", 4800, true);
                window.scrollTo({top: Math.round(Number(read_y[0]) * Number(read_y[1] * Number(read_y[2] / wx / wy))), behavior: "smooth"});
            }
        }, 500);
        window.onscroll = windowScroll;
    </script>





        </div>
        <div id="css-loading">
            <h3 class="text-center">加载中...</h3>
        </div>
        
    </body>
</html>
