<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    
    <link rel="apple-touch-icon" sizes="76x76" href="/null">
    <link rel="icon" type="image/png" href="/null">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>基于Bootloader的简易桌面闹钟 - Ben Shu &#39;s Blog</title>
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    
    <meta name="description" content="">
    <meta name="author" content="Big Ben">
    <meta name="keywords" content="">
    <meta property="og:title" content="基于Bootloader的简易桌面闹钟"/>
    <style>


    
    :root{
        --shadow-color: rgba(0,0,0,0.2);
        --sec-shadow: rgba(0,0,0,0.03);
        --shadow-hover-color: rgba(0,0,0,0.28);
        --first-text-color: #475b6d;
        --second-text-color: #37475b;
        --third-text-color: #858585;
        --default-text-color: #505050;
        --default-link-color: #007bff;
        --link-color: #000000;
        --second-link-color: #4F9BFA;
        --code-color:rgba(27,31,35,.05);
        --post-bkg-color: #fff;
        --page-bkg-color: #f2f5f8;
        --nav-a-hover-color: #3498db;
        --post-sec-text-color: #718096;
        --sec-bkg: #f2f5f8;
        --color-mode: 'light';
        --bkg-h: rgba(255,255,255,0.6);
        --bkg-m: #e1e4e8;
        --home-title-color: #4169E1;
        --shadow: 0 4px 10px rgba(0,2,4,0.06),0 0 1px rgba(0,2,4,0.11);
        --hr-color: #ddd;
        --bg-t: #f4f4f4;
        --nav-bkg: rgba(255,255,255,0.6);
    }

@media (prefers-color-scheme: dark) {
  :root {
    --color-mode: 'dark';
  }

  :root:not([data-theme]) {
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
  }
}

[data-theme='dark'] {
    --shadow-color: rgba(0,0,0,0.2);
    --shadow-hover-color: rgba(0,0,0,0.28);
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
}

</style>



<style>
#page-main,footer,.p-btn{
    display: none;
}
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
}
body {
    background-color: var(--page-bkg-color);
    color: var(--second-text-color);
    overflow-y: scroll;
    overflow-x: hidden;
    transition: all .3s;
}
a {
    color: var(--default-link-color);
    text-decoration: none;
    background-color: transparent;
}
a:hover{
    color: var(--second-link-color);
}
.main-content,.post-card-main{
    margin: 30px;
}



@media (max-width: 410px){
    .post-card-main{
        max-width: 350px!important;
    }
}

@media (max-width: 980px){
    .post-card-main{
        max-width: 520px!important;
    }
}


@media (min-width: 780px){ 
    h3{
        font-size: 1.5rem;
        line-height: 1.5em;
    }
}
@media (min-width: 1280px){ 
    h3{
        font-size: 1.7rem;
        line-height: 1.5em;
    }
}
@media (min-width: 2096px){ 
    h3{
        font-size: 1.8rem;
        line-height: 1.5em;
    }
}

.text-center{
    text-align: center!important;
}
.middle-center{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    height: 100%;
}
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    height: 54px;
    padding: 0 1.25rem;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    border-bottom: 1px solid var(--bkg-m);
    background-color: var(--nav-bkg);
    backdrop-filter: blur(4px);
    transition: all .3s;
}
header .header__left, header .header__right {
    display: flex;
    align-items: center;
    font-family: rubik,sans-serif,Varela Round;
}
header .header__left .logo__text {
    font-size: 18px;
    font-weight: 450;
    padding: 14.5px 10px;
    border-radius: 5px;
    color: var(--second-text-color);
}
header .header__right .navbar__menus {
    height: 54px;
    padding: 0 0 0 15px;
}
header .header__right .button {
    color: var(--second-text-color);
}
header .header__right .navbar__menus .navbar-menu {
    display: inline-block;
    align-items: center;
    height: 54px;
    padding: 0 10px;
    font-size: 16px;
    line-height: 54px;
}
header .header__right .dropdown-icon {
    display: none;
    height: 54px;
    padding: 15px 10px;
    border: 0;
    background-color: transparent;
}
header .header__right .dropdown-menus {
    line-height: 2rem;
    animation: slide-in .15s ease 1;
    display: none;
    position: absolute;
    left: 12px;
    right: 12px;
    top: calc(54px + 10px);
    border-radius: 6px;
    padding: 24px;
    background-color: var(--page-bkg-color);
    border: 1px solid var(--bkg-m);
    z-index: 9999;
    justify-items: center;
    justify-content: center;
    flex-direction: column;
}
header .header__right #btn-search, header .header__right #btn-toggle-dark{
    display: inline-block;
    padding:  18px 10px;
    height: 25px;
}
header .header__right #btn-dropdown{
  display: inline-block;
  padding:  13.5px 0;
}
header .header__right .dropdown-menus .dropdown-menu {
    padding: 10px;
    color: var(--second-text-color);
}
@media screen and (max-width: 764px){
.navbar__menus {
    display: none!important;
}
.dropdown-icon {
    display: inline-block!important;
}
}
.p-btn{
    position: fixed;
    bottom: 1.2rem;
    right: 1.2rem;
    contain: layout;
}
.toc-btn,.click-btn{
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    align-items: center;
    margin-top: .5rem;
    font-size: .75rem;
    background-color: var(--sec-bkg);
    display: block;
    padding: 0.9rem;
    box-shadow: 0 0.3rem 0.6rem rgba(48,55,66,.15);
    border: none;
    border-radius: 0.5rem;
    line-height: 1;
    color: var(--first-text-color);
}
.toc-link{
    color: var(--second-text-color);
}

#css-loading h3{
    font-weight: 500;
    font-size: 1.4rem;
    text-align: center;
    position: fixed;
    top: 200px;
    left: 0;
    right: 0;
    opacity: 0;
    animation: cssLoad;
    animation-delay: 0.3s;
    -webkit-animation: cssLoad;
    -webkit-animation-delay: 0.3s;
}
@keyframes cssLoad {
    from {
        opacity: 0;
    }
    to {
        opacity: 0.9;
    }
}


.memorial {
    -webkit-filter: grayscale(100%);
    -moz-filter: grayscale(100%);
    -ms-filter: grayscale(100%);
    -o-filter: grayscale(100%);
    filter: grayscale(100%);
    filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1); filter:gray;
}


    .post-copyright:after {
        position: absolute;
        color: #fff;
        background: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");
        content: ' ';
        height: 10rem;
        width: 10rem;
        right: -2rem;
        top: -2rem;
        opacity: .1;
    }

</style>

    

    
        <!--
        <link rel="stylesheet" href="/css/page.css" media="print"
            onload="this.media='all';this.onload=null">
        <noscript>-->
            <link rel="stylesheet" href="/css/page.css">
        <!--</noscript>-->
    
    
    <link rel="stylesheet" href="/css/main.css" media="print" onload="this.media='all';this.onload=null">
    <noscript>
        <link rel="stylesheet" href="/css/main.css">
    </noscript>

    
    <script src="/js/main.js"></script>
    
      
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

    <body>
        <header>
            
<div class="header__left">
	<a href="/" class="button"><span class="logo__text">主页</span></a>
</div>
<div class="header__right">
	<div class="navbar__menus">
		
		<a href="/" class="button">
			<div class="navbar-menu">首页</div>
		</a>
		
		<a href="/archives/" class="button">
			<div class="navbar-menu">归档</div>
		</a>
		
		<a href="/categories/" class="button">
			<div class="navbar-menu">分类</div>
		</a>
		
		<a href="/tags/" class="button">
			<div class="navbar-menu">标签</div>
		</a>
		
		<a href="/about/" class="button">
			<div class="navbar-menu">关于</div>
		</a>
		
	</div>
	
	<a href="/search/" class="button">
		<div id="btn-search">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32">
				<path
					d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z">
				</path>
			</svg>
		</div>
	</a>
	
	<a href="javaScript:void(0);" class="button" id="btn-toggle-dark">
		<div>
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none"
				stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
			</svg>
		</div>
	</a>
	<a href="javaScript:void(0);" class="dropdown-icon button">
		<div id="btn-dropdown">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32" stroke-linecap="round">
				<path
					d="M903.43 561.52H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 204.31H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 918.73H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24z"
					fill="currentColor"></path>
			</svg>
		</div>
	</a>
	<div class="dropdown-menus" id="dropdown-menus">
		
		<a href="/" class="dropdown-menu button">首页</a>
		<br>
		
		<a href="/archives/" class="dropdown-menu button">归档</a>
		<br>
		
		<a href="/categories/" class="dropdown-menu button">分类</a>
		<br>
		
		<a href="/tags/" class="dropdown-menu button">标签</a>
		<br>
		
		<a href="/about/" class="dropdown-menu button">关于</a>
		<br>
		
	</div>
</div>

        </header>
        <div id="top"></div>
        <div id="page-main" class="main-content">
        <div class="mg-top">
            

<article class="page">
<div id="post-meta-m">
    <div class="post-meta" id="post-meta">
  <h3>基于Bootloader的简易桌面闹钟</h3>
    
      <span class="post-meta-label">
        Big Ben
      </span>
    
    
      <span class="post-meta-label">
        <span class="p-dot"></span>
        <time datetime="2025-07-27 11:30" pubdate>
          2025-07-27
        </time>
      </span>
    
    
      
      <span class="post-meta">
        <span class="p-dot"></span>
        共 3.4k 字
      </span>
    
    
    
  </div>
  
</div>
<div class="article-m">
  <div class="post-toc">
    
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">简易桌面闹钟</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%89%A9"><span class="toc-number">1.1.</span> <span class="toc-text">实物</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">整体结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OLED%E7%A4%BA%E6%84%8F%E5%9B%BE"><span class="toc-number">1.3.</span> <span class="toc-text">OLED示意图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E6%98%93%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.1.</span> <span class="toc-text">简易模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">多功能模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SysTick%E3%80%81SVC%E3%80%81PendSV"><span class="toc-number">1.5.</span> <span class="toc-text">SysTick、SVC、PendSV</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SysTick-Handler-%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%92%9F"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">SysTick_Handler - 系统时钟</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SVC-Handler-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E5%99%A8"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">SVC_Handler - 系统启动器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PendSV-Handler-%E4%BB%BB%E5%8A%A1%E5%88%87%E6%8D%A2%E5%99%A8"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">PendSV_Handler - 任务切换器</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">新添内容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#one-wire%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.1.</span> <span class="toc-text">one-wire协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#delay"><span class="toc-number">2.2.</span> <span class="toc-text">delay</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%81%E5%89%AAFreeRTOS"><span class="toc-number">2.3.</span> <span class="toc-text">裁剪FreeRTOS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FreeRTOS"><span class="toc-number">2.4.</span> <span class="toc-text">FreeRTOS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E8%B7%AF%E5%BE%84%E8%A1%A8"><span class="toc-number">2.4.1.</span> <span class="toc-text">通信路径表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C"><span class="toc-number">2.5.</span> <span class="toc-text">运行效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.6.</span> <span class="toc-text">总结</span></a></li></ol></li></ol>
    
  </div>
    <div id="article">
      <div id="post-content" class="markdown-body textretty">
        <p>在这份项目里，Bootloader使用之前Bootloader学习笔记里做的样例。</p>
<p><s><strong>可以说是为了这碗醋，包了这碗饺子</strong></s></p>
<h1>简易桌面闹钟</h1>
<p>FreeRTOS移植：<a target="_blank" rel="noopener" href="https://blog.csdn.net/ba_wang_mao/article/details/127628185">超详细的FreeRTOS移植全教程——基于stm32_freertos移植教程-CSDN博客</a></p>
<p><strong>时钟方面需要改用FreeRTOS的SysTick，否则系统会卡死</strong></p>
<h2 id="实物">实物</h2>
<p><img src="https://s2.loli.net/2025/07/27/W3SZJCmjdYwkrbf.png" alt=""></p>
<h2 id="整体结构">整体结构</h2>
<p><img src="https://s2.loli.net/2025/07/27/TY6NcmgS7hrGL4b.png" alt=""></p>
<h2 id="OLED示意图">OLED示意图</h2>
<p>此处OTA的值存储在AT24C02的0xF0-0XF3字节处（AT24C02总共256字节）</p>
<h3 id="简易模式">简易模式</h3>
<p><img src="https://s2.loli.net/2025/07/27/mhzNLnT6D4JRYyt.png" alt=""></p>
<ul>
<li>PA2进入多功能模式</li>
<li>PA0调整城市显示</li>
<li>PC13调整OTA状态</li>
<li>PB10可以重启设备</li>
<li><strong>支持震动自动切换多功能模式</strong></li>
</ul>
<h2 id="多功能模式">多功能模式</h2>
<p><img src="https://s2.loli.net/2025/07/27/VsqnLypYDSm1iGO.png" alt=""></p>
<ul>
<li>
<p>PA0进入简易模式</p>
</li>
<li>
<p>温湿度数据1s刷新一次</p>
</li>
<li>
<p>加速度0.5s刷新一次</p>
</li>
<li>
<p><strong>10s无操作自动进入简易模式</strong></p>
</li>
</ul>
<h2 id="SysTick、SVC、PendSV">SysTick、SVC、PendSV</h2>
<h4 id="SysTick-Handler-系统时钟">SysTick_Handler - 系统时钟</h4>
<ul>
<li>
<p>就像心跳，定期检查是否需要切换任务</p>
</li>
<li>
<p>频率固定，系统运行期间持续工作</p>
</li>
<li>
<p>负责时间管理和调度触发</p>
</li>
</ul>
<h4 id="SVC-Handler-系统启动器">SVC_Handler - 系统启动器</h4>
<ul>
<li>
<p>就像点火器，只负责启动第一个任务</p>
</li>
<li>
<p>只调用一次，启动后就不工作了</p>
</li>
<li>
<p>从特权模式切换到用户模式</p>
</li>
</ul>
<h4 id="PendSV-Handler-任务切换器">PendSV_Handler - 任务切换器</h4>
<ul>
<li>
<p>就像交通指挥员，负责安排哪个任务先运行</p>
</li>
<li>
<p>需要切换时才工作，优先级最低</p>
</li>
<li>
<p>在用户模式下进行任务切换</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">特性</th>
<th style="text-align:center">SysTick_Handler</th>
<th style="text-align:center">SVC_Handler</th>
<th style="text-align:center">PendSV_Handler</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">全称</td>
<td style="text-align:center">System Tick Handler</td>
<td style="text-align:center">Supervisor Call Handler</td>
<td style="text-align:center">Pending Service Handler</td>
</tr>
<tr>
<td style="text-align:center">中文名</td>
<td style="text-align:center">系统滴答中断</td>
<td style="text-align:center">超级调用中断</td>
<td style="text-align:center">挂起服务中断</td>
</tr>
<tr>
<td style="text-align:center">触发方式</td>
<td style="text-align:center">硬件定时器</td>
<td style="text-align:center">软件调用SVC指令</td>
<td style="text-align:center">软件触发PendSV</td>
</tr>
</tbody>
</table>
<h1>新添内容</h1>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从AT24C02最后一页读取OTA_flag（4字节）</span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">AT24C02_ReadOTAFlag</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> addr = <span class="number">0xF0</span>; <span class="comment">// 最后一页开始地址</span></span><br><span class="line">	<span class="type">uint32_t</span> flag = <span class="number">0</span>;</span><br><span class="line">	<span class="type">uint8_t</span> *pflag = (<span class="type">uint8_t</span> *)&amp;flag;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 读取4字节的OTA_flag</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">uint8_t</span> data = <span class="number">0</span>;</span><br><span class="line">		AT24C02_ReadData(addr + i, &amp;data, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(data == <span class="number">0xFF</span>) <span class="comment">// 读取失败</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 返回0表示读取失败</span></span><br><span class="line">		&#125;</span><br><span class="line">		pflag[i] = data;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Bootloader跳转逻辑控制</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Bootloader_Jump</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 读取并打印OTA_flag</span></span><br><span class="line">	<span class="type">uint32_t</span> OTA_flag = AT24C02_ReadOTAFlag();<span class="comment">//处在AT24C02的最后一页</span></span><br><span class="line">	uprintf(<span class="string">&quot;OTA_flag: %d \r\n&quot;</span>, OTA_flag);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果OTA_flag == 1，直接跳转APP</span></span><br><span class="line">	<span class="keyword">if</span>(OTA_flag == <span class="number">1</span>) &#123;</span><br><span class="line">		uprintf(<span class="string">&quot;Direct jump to APP\r\n&quot;</span>);</span><br><span class="line">		LOAD_A(FLASH_A_SADDR);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 继续原有Bootloader逻辑</span></span><br><span class="line">	<span class="keyword">if</span>(Bootloader_Enter(<span class="number">20</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(OTA_flag == OTA_SET_FLAG)</span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;OTA update \r\n&quot;</span>);</span><br><span class="line">			BootState |= UPDATA_A_FLAG;</span><br><span class="line">			Updata_A.W25Q64_BlockNM = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;Jump to Area A \r\n&quot;</span>);</span><br><span class="line">			LOAD_A(FLASH_A_SADDR);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	uprintf(<span class="string">&quot;Enter Bootloader command line \r\n&quot;</span>);</span><br><span class="line">	Bootloader_Info();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="one-wire协议">one-wire协议</h2>
<p>One Wire（单线）总线协议，<strong>它只需要一根数据线就能实现双向通信</strong>，大大简化了硬件连接。</p>
<ul>
<li>
<p><strong>上拉电阻</strong>： 通常4.7kΩ，确保总线空闲时为高电平</p>
</li>
<li>
<p><strong>开漏输出</strong>： <strong>支持线与逻辑</strong></p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_53918631/article/details/124957478">【通信协议】单总线协议详解——以DHT11为例_单总线通信协议-CSDN博客</a></p>
<h2 id="delay">delay</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> fac_us = <span class="number">0</span>;  <span class="comment">// us延时倍乘数</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> fac_ms = <span class="number">0</span>; <span class="comment">// ms延时倍乘数,在RTOS下,代表每个节拍的ms数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 时钟初始化 - 参考例程版本</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> reload;</span><br><span class="line">    SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK); <span class="comment">// 选择外部时钟  HCLK</span></span><br><span class="line">    fac_us = SystemCoreClock / <span class="number">1000000</span>;              <span class="comment">// 不论是否使用OS,fac_us都需要使用</span></span><br><span class="line">    reload = SystemCoreClock / <span class="number">1000000</span>;              <span class="comment">// 每秒钟的计数次数 单位为M</span></span><br><span class="line">    reload *= <span class="number">1000000</span> / configTICK_RATE_HZ;          <span class="comment">// 根据configTICK_RATE_HZ设定溢出时间</span></span><br><span class="line">                                                     <span class="comment">// reload为24位寄存器,最大值:16777216,在72M下,约合0.233s左右</span></span><br><span class="line">    fac_ms = <span class="number">1000</span> / configTICK_RATE_HZ;              <span class="comment">// 代表OS可以延时的最少单位</span></span><br><span class="line"></span><br><span class="line">    SysTick-&gt;CTRL |= SysTick_CTRL_TICKINT_Msk; <span class="comment">// 开启SYSTICK中断</span></span><br><span class="line">    SysTick-&gt;LOAD = reload;                    <span class="comment">// 每1/configTICK_RATE_HZ秒中断一次</span></span><br><span class="line">    SysTick-&gt;CTRL |= SysTick_CTRL_ENABLE_Msk;  <span class="comment">// 开启SYSTICK</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 延时微妙</span></span><br><span class="line"><span class="comment"> * @param us 延时0~65536微秒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_us</span><span class="params">(<span class="type">uint32_t</span> us)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> ticks;</span><br><span class="line">    <span class="type">uint32_t</span> told, tnow, tcnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint32_t</span> reload = SysTick-&gt;LOAD; <span class="comment">// LOAD的值</span></span><br><span class="line">    ticks = us * fac_us;            <span class="comment">// 需要的节拍数</span></span><br><span class="line">    told = SysTick-&gt;VAL;            <span class="comment">// 刚进入时的计数器值</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        tnow = SysTick-&gt;VAL;</span><br><span class="line">        <span class="keyword">if</span> (tnow != told)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tnow &lt; told)</span><br><span class="line">                tcnt += told - tnow; <span class="comment">// 这里注意一下SYSTICK是一个递减的计数器就可以了.</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                tcnt += reload - tnow + told;</span><br><span class="line">            told = tnow;</span><br><span class="line">            <span class="keyword">if</span> (tcnt &gt;= ticks)</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// 时间超过/等于要延迟的时间,则退出.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 延时毫秒</span></span><br><span class="line"><span class="comment"> * @param ms 延时0~65536毫秒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_ms</span><span class="params">(<span class="type">uint32_t</span> ms)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (xTaskGetSchedulerState() != taskSCHEDULER_NOT_STARTED) <span class="comment">// 系统已经运行</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ms &gt;= fac_ms) <span class="comment">// 延时的时间大于OS的最少时间周期</span></span><br><span class="line">        &#123;</span><br><span class="line">            vTaskDelay(ms / fac_ms); <span class="comment">// FreeRTOS延时</span></span><br><span class="line">        &#125;</span><br><span class="line">        ms %= fac_ms; <span class="comment">// OS已经无法提供这么小的延时了,采用普通方式延时</span></span><br><span class="line">    &#125;</span><br><span class="line">    Delay_us((<span class="type">uint32_t</span>)(ms * <span class="number">1000</span>)); <span class="comment">// 普通方式延时</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_s</span><span class="params">(<span class="type">uint32_t</span> s)</span></span><br><span class="line">&#123;</span><br><span class="line">    Delay_ms(s * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 延时ms,不会引起任务调度</span></span><br><span class="line"><span class="comment"> * @param ms 要延时的ms数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_xms</span><span class="params">(<span class="type">uint16_t</span> ms)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ms; i++)</span><br><span class="line">        Delay_us(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="裁剪FreeRTOS">裁剪FreeRTOS</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FREERTOS_CONFIG_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREERTOS_CONFIG_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 针对不同的编译器，调用不同的stdint.h文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ICCARM__) || defined(__CC_ARM) || defined(__GNUC__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">uint32_t</span> SystemCoreClock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 断言配置 - 用于调试，当条件为假时停止程序</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configASSERT(x)           \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((x) == 0)                 \</span></span><br><span class="line"><span class="meta">    &#123;                             \</span></span><br><span class="line"><span class="meta">        taskDISABLE_INTERRUPTS(); \</span></span><br><span class="line"><span class="meta">        while (1)                 \</span></span><br><span class="line"><span class="meta">            ;                     \</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************</span></span><br><span class="line"><span class="comment"> *               FreeRTOS基础配置选项</span></span><br><span class="line"><span class="comment"> *********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调度器类型选择</span></span><br><span class="line"><span class="comment"> * 1: 抢占式调度器 - 高优先级任务可以抢占低优先级任务</span></span><br><span class="line"><span class="comment"> * 0: 协作式调度器 - 任务必须主动释放CPU才能切换</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 抢占式：就像急诊病人可以插队，高优先级任务立即执行</span></span><br><span class="line"><span class="comment"> * 协作式：就像排队，必须等前面的人办完事才能轮到下一个</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_PREEMPTION 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 时间片调度</span></span><br><span class="line"><span class="comment"> * 1: 启用时间片 - 同优先级任务轮流执行</span></span><br><span class="line"><span class="comment"> * 0: 禁用时间片 - 同优先级任务需要主动让出CPU</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TIME_SLICING 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务选择优化</span></span><br><span class="line"><span class="comment"> * 1: 使用硬件优化 - 更快找到最高优先级任务</span></span><br><span class="line"><span class="comment"> * 0: 使用软件查找 - 兼容性更好但速度较慢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_PORT_OPTIMISED_TASK_SELECTION 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 无滴答空闲模式</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 空闲时停止系统滴答，省电</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 始终保持系统滴答运行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TICKLESS_IDLE 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CPU时钟频率</span></span><br><span class="line"><span class="comment"> * 写入实际的CPU主频，用于计算延时时间</span></span><br><span class="line"><span class="comment"> * 例如：72MHz = 72000000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configCPU_CLOCK_HZ (SystemCoreClock)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统滴答频率</span></span><br><span class="line"><span class="comment"> * 每秒中断次数，决定任务调度的精度</span></span><br><span class="line"><span class="comment"> * 1000 = 1ms一次中断，精度较高</span></span><br><span class="line"><span class="comment"> * 100 = 10ms一次中断，精度较低但省电</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTICK_RATE_HZ ((TickType_t)1000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最大优先级数量</span></span><br><span class="line"><span class="comment"> * 优先级范围：0 ~ (configMAX_PRIORITIES-1)</span></span><br><span class="line"><span class="comment"> * 数字越小优先级越高，0为最高优先级</span></span><br><span class="line"><span class="comment"> * 建议：根据实际任务数量设置，不要设置过大</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMAX_PRIORITIES (16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 空闲任务栈大小</span></span><br><span class="line"><span class="comment"> * 空闲任务用于系统空闲时的处理</span></span><br><span class="line"><span class="comment"> * 单位：字（4字节）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMINIMAL_STACK_SIZE ((unsigned short)64)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务名称最大长度</span></span><br><span class="line"><span class="comment"> * 用于调试时显示任务名称</span></span><br><span class="line"><span class="comment"> * 建议：8-16个字符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMAX_TASK_NAME_LEN (12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 滴答计数器数据类型</span></span><br><span class="line"><span class="comment"> * 1: 16位 - 最大65535个滴答（约65秒）</span></span><br><span class="line"><span class="comment"> * 0: 32位 - 最大4294967295个滴答（约49天）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_16_BIT_TICKS 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 空闲任务让出CPU</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 空闲时让出CPU给同优先级任务</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 空闲任务一直运行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configIDLE_SHOULD_YIELD 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 队列集功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以等待多个队列</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 只能等待单个队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_QUEUE_SETS 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务通知功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 轻量级任务间通信</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 只能使用队列和信号量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TASK_NOTIFICATIONS 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 互斥量功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 用于保护共享资源</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用互斥量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_MUTEXES 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归互斥量功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 同一任务可以多次获取同一个互斥量</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 只能获取一次</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_RECURSIVE_MUTEXES 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计数信号量功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 用于资源计数</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用计数信号量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_COUNTING_SEMAPHORES 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 事件组功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 用于多任务同步</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用事件组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_EVENT_GROUPS 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 队列注册表大小</span></span><br><span class="line"><span class="comment"> * 用于调试时跟踪队列和信号量</span></span><br><span class="line"><span class="comment"> * 建议：根据实际使用的队列数量设置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configQUEUE_REGISTRY_SIZE 6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务标签功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以为任务设置标签</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用任务标签</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_APPLICATION_TASK_TAG 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************************</span></span><br><span class="line"><span class="comment">              FreeRTOS内存管理配置选项</span></span><br><span class="line"><span class="comment">*****************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态内存分配</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用xTaskCreate等动态创建函数</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 只能使用静态创建函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configSUPPORT_DYNAMIC_ALLOCATION 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 静态内存分配</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用xTaskCreateStatic等静态创建函数</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 只能使用动态创建函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configSUPPORT_STATIC_ALLOCATION 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 堆内存大小</span></span><br><span class="line"><span class="comment"> * 用于动态内存分配，包括任务栈、队列等</span></span><br><span class="line"><span class="comment"> * 单位：字节</span></span><br><span class="line"><span class="comment"> * 建议：根据实际内存使用情况设置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTOTAL_HEAP_SIZE ((size_t)(14 * 1024))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************************************</span></span><br><span class="line"><span class="comment">             FreeRTOS钩子函数配置选项</span></span><br><span class="line"><span class="comment">**************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 空闲钩子函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 空闲时调用用户定义的函数</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 不调用钩子函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_IDLE_HOOK 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 滴答钩子函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 每次系统滴答时调用用户定义的函数</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 不调用钩子函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TICK_HOOK 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 内存分配失败钩子函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 内存分配失败时调用用户定义的函数</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 不调用钩子函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_MALLOC_FAILED_HOOK 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 栈溢出检查</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 不检查栈溢出</span></span><br><span class="line"><span class="comment"> * 1: 方法1 - 检查栈顶是否被覆盖</span></span><br><span class="line"><span class="comment"> * 2: 方法2 - 检查栈底是否被覆盖（更严格）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configCHECK_FOR_STACK_OVERFLOW 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************************************</span></span><br><span class="line"><span class="comment">          FreeRTOS运行时间和任务状态收集配置选项</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 运行时间统计</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以统计任务运行时间</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 不统计运行时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configGENERATE_RUN_TIME_STATS 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 可视化跟踪调试</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 支持FreeRTOS+Trace等调试工具</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 不支持跟踪调试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TRACE_FACILITY 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计格式化函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 提供格式化统计信息的函数</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 不提供格式化函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_STATS_FORMATTING_FUNCTIONS 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************************************</span></span><br><span class="line"><span class="comment">                FreeRTOS协程配置选项</span></span><br><span class="line"><span class="comment">*********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 协程功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用协程（轻量级任务）</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用协程</span></span><br><span class="line"><span class="comment"> * 注意：启用后必须添加croutine.c文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_CO_ROUTINES 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 协程优先级数量</span></span><br><span class="line"><span class="comment"> * 协程的优先级范围：0 ~ (configMAX_CO_ROUTINE_PRIORITIES-1)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMAX_CO_ROUTINE_PRIORITIES (2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">                FreeRTOS软件定时器配置选项</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 软件定时器功能</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用软件定时器</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用软件定时器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configUSE_TIMERS 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 软件定时器任务优先级</span></span><br><span class="line"><span class="comment"> * 建议：设置为较高优先级，确保定时器及时处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_TASK_PRIORITY (configMAX_PRIORITIES - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 软件定时器队列长度</span></span><br><span class="line"><span class="comment"> * 用于存储定时器命令的队列大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_QUEUE_LENGTH 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 软件定时器任务栈大小</span></span><br><span class="line"><span class="comment"> * 软件定时器服务任务的栈大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configTIMER_TASK_STACK_DEPTH (configMINIMAL_STACK_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">            FreeRTOS可选函数配置选项</span></span><br><span class="line"><span class="comment">************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务调度器状态查询函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用xTaskGetSchedulerState()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法查询调度器状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_xTaskGetSchedulerState 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务优先级设置函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用vTaskPrioritySet()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法动态修改任务优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskPrioritySet 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务优先级获取函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用uxTaskPriorityGet()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法获取任务优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_uxTaskPriorityGet 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务删除函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用vTaskDelete()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法删除任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskDelete 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务清理资源函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用vTaskCleanUpResources()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法清理任务资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskCleanUpResources 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务挂起函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用vTaskSuspend()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法挂起任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskSuspend 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务延时直到指定时间函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用vTaskDelayUntil()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用绝对延时</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskDelayUntil 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务延时函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用vTaskDelay()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用相对延时</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_vTaskDelay 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务状态获取函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用eTaskGetState()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法获取任务状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_eTaskGetState 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定时器挂起函数调用</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用xTimerPendFunctionCall()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法使用定时器挂起函数调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_xTimerPendFunctionCall 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务栈高水位标记函数</span></span><br><span class="line"><span class="comment"> * 1: 启用 - 可以使用uxTaskGetStackHighWaterMark()</span></span><br><span class="line"><span class="comment"> * 0: 禁用 - 无法检查栈使用情况</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INCLUDE_uxTaskGetStackHighWaterMark 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************</span></span><br><span class="line"><span class="comment">            FreeRTOS中断配置选项</span></span><br><span class="line"><span class="comment">******************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 中断优先级位数</span></span><br><span class="line"><span class="comment"> * STM32F103使用4位优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __NVIC_PRIO_BITS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configPRIO_BITS __NVIC_PRIO_BITS</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configPRIO_BITS 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 中断最低优先级</span></span><br><span class="line"><span class="comment"> * 数值越大优先级越低</span></span><br><span class="line"><span class="comment"> * 15 = 最低优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configLIBRARY_LOWEST_INTERRUPT_PRIORITY 15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统可管理的最高中断优先级</span></span><br><span class="line"><span class="comment"> * 数值越小优先级越高</span></span><br><span class="line"><span class="comment"> * 1 = 较高优先级，可以被FreeRTOS管理</span></span><br><span class="line"><span class="comment"> * 0 = 最高优先级，不能被FreeRTOS管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 内核中断优先级</span></span><br><span class="line"><span class="comment"> * 用于FreeRTOS内核的中断优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configKERNEL_INTERRUPT_PRIORITY (configLIBRARY_LOWEST_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS)) <span class="comment">/* 240 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统调用最高中断优先级</span></span><br><span class="line"><span class="comment"> * 可以被FreeRTOS管理的中断最高优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> configMAX_SYSCALL_INTERRUPT_PRIORITY (configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************</span></span><br><span class="line"><span class="comment">            FreeRTOS中断服务函数配置选项</span></span><br><span class="line"><span class="comment">****************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PendSV中断处理函数映射</span></span><br><span class="line"><span class="comment"> * 用于任务切换的中断处理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> xPortPendSVHandler PendSV_Handler</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SVC中断处理函数映射</span></span><br><span class="line"><span class="comment"> * 用于启动第一个任务的中断处理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vPortSVCHandler SVC_Handler</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* FREERTOS_CONFIG_H */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="FreeRTOS">FreeRTOS</h2>
<p>FreeRTOS<strong>高优先级优先，具有优先级反转机制</strong>，注意<strong>config里的总优先级不能低于4</strong>。</p>
<p><strong>Ucos和RT-Thread是低优先级优先</strong></p>
<p><img src="https://s2.loli.net/2025/07/27/cAtqrPeFfKxLyVU.png" alt=""></p>
<h3 id="通信路径表">通信路径表</h3>
<p><img src="https://s2.loli.net/2025/07/27/69KnvkIZ34uawCV.png" alt=""></p>
<h2 id="运行效果">运行效果</h2>
<p><strong>Xmodem工具使用xcom</strong>（这东西老是丢包，下载操作还有BUG，丢包了再下载进去的是错的，以后再修改吧）</p>
<p>在简易模式和多功能模式均可以调整OTA_flag；<strong>若为0，可以进行OTA更新，若为1，则自动进入系统</strong>。</p>
<p>本实验通过【5】向外部FLASH的第1块下载简易模式（MODE=0），第2块下载简易+多功能模式（MODE=1）</p>
<p>后续借助【7】重启、PB10重启和【6】下载外部FLASH等功能，对第1块和第2块外部Flash片区内容进行实验测试，均符合预期效果。</p>
<p>【1】擦除和【2】下载，测得没有问题；【3】和【4】也是测试通过。</p>
<p><img src="https://s2.loli.net/2025/07/27/fQsLjGKltcuAvBa.png" alt=""></p>
<h2 id="总结">总结</h2>
<p>整体代码太冗长了，这里就只把核心部分贴上去了。</p>
<p>还有，记得调整两个0x5000，不然程序是运行不了的。</p>

      </div>
    </div>
</div>

<div class="post-category">

    <div id="p-meta-i">
        
              
                <a class="hover-with-bg" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a>
              
          
          
              
                <a class="hover-with-bg" href="/tags/STM32/"># STM32</a>
              
                <a class="hover-with-bg" href="/tags/Bootloader/"># Bootloader</a>
              
                <a class="hover-with-bg" href="/tags/%E9%A1%B9%E7%9B%AE/"># 项目</a>
              
                <a class="hover-with-bg" href="/tags/FreeRTOS/"># FreeRTOS</a>
              
          
    </div>
</div>


<div class="post-footer">
  

</div>

</article>


        </div>
        
<footer class="text-center">
    
    
    
    
    
    <p>&copy;  2022 - 2025&nbsp;&nbsp;本书</p>
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme by <a href="https://github.com/oCoke/hexo-theme-miracle" target="_blank">Miracle</a></p>
    
    
</footer>

<div class="p-btn">
    
        <a class="toc-btn" id="toc-btn"><i id="i-menu"></i></a>
    
    
      <a class="toc-btn" id="share-btn"><i>
        <svg t="1670124379155" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2683" width="25" height="25"><path d="M395.946667 234.666667v64H256v469.333333h512V522.666667h64V768a64 64 0 0 1-64 64H256a64 64 0 0 1-64-64V298.666667a64 64 0 0 1 64-64h139.946667z m335.850666-87.914667l150.848 150.826667-158.378666 158.4-45.269334-45.248L748.394667 341.333333H672c-121.685333 0-220.714667 97.024-223.914667 217.941334L448 565.333333v85.333334h-64v-85.333334C384 406.272 512.938667 277.333333 672 277.333333h99.861333l-85.312-85.333333 45.248-45.248z" p-id="2684" fill="var(--first-text-color)"></path></svg>
      </i></a>
    
    <a href="javascript:window.scrollTo({top:0,behavior:'smooth'});" class="click-btn">
      <i id="i-up"></i>
    </a>
</div>

<!-- SCRIPTS -->






<script>
    document.getElementById("btn-dropdown").addEventListener('click', () => {
      toggleClass("#dropdown-menus","display-inline");
    });
    console.log('\n' + ' %c Powered by Hexo Theme Miracle ' + ' %c https://github.com/oCoke/hexo-theme-miracle ' + '\n' + '\n', 'color: #fff; background: #4F9BFA; padding:5px 0;', 'background: #FFF; padding:5px 0;');

    

    
  /* 小彩蛋: 饮茶先啦 */
  setTimeout(() => {
    var time = new Date();
    if (time.getHours() == 15) {
      let comment = document.createComment(' 三点几嚟！饮茶先啦！ ');
      document.body.insertBefore(comment, document.getElementsByTagName('header')[0]);
    }
  },1);
    
</script>


<script>
    var postImg = document.querySelectorAll("article[class=page] img");
    for (let imgi = 0; imgi < postImg.length; imgi++) {
        postImg[imgi].onclick = () => {
            let zoomImg = document.createElement("div");
            zoomImg.id = "zoomImg";
            zoomImg.innerHTML = `<div id="zoom-picture"></div>
    <div class="poptrox-overlay"
        style="position: fixed; left: 0px; top: 0px; z-index: 20000; width: 100%; height: 100%; text-align: center; cursor: zoom-out; opacity: 1;">
        <div style="display:inline-block;height:100%;vertical-align:middle;"></div>
        <div
            style="position:absolute;left:0;top:0;width:100%;height:100%;background:#000000;opacity:0;filter:alpha(opacity=0);">
        </div>
        <div class="poptrox-popup"
            style="display: inline-block; vertical-align: middle; position: relative; z-index: 1; cursor: zoom-out; min-width: 10px; min-height: 10px; width: auto; height: auto;">
            <div class="loader" style="display: none;"></div>
            <div class="pic" style="text-indent: 0px;"><img
                    src="${ postImg[imgi].srcset || postImg[imgi].src }" alt="Loading..."
                    style="vertical-align: bottom; max-width: 85vw; max-height: 85vh;"></div>
        </div>
    </div>`;
            document.body.appendChild(zoomImg);
                document.querySelector("#zoomImg").onclick = () => {
                    document.querySelector("#zoomImg").remove();
                }
        }
    }
    
</script>




    <script>
        query("#toc-btn")[0].onclick = () => {
            if (query(".post-toc")[0].innerHTML) {
                toggleClass(".post-toc", "display-inline");
            }
        }

        if (!query(".post-toc")[0].innerHTML) {
            addClass("#toc-btn","display-none");
        }
    </script>



    <script>
        query("#share-btn")[0].onclick = async () => {
            let url = `${location.protocol}//${location.hostname}${location.port ? ":"+location.port:location.port}${location.pathname}#read=${sessionStorage.getItem(location.pathname+"_read_y") || ""}`;
            try {
                await navigator.clipboard.writeText(url);
                prompt_core("分享链接已经复制至剪贴板", 4800, true);
            } catch(e) {
                prompt_core("分享链接复制失败，请手动复制<br/>"+url, 4800, false);
            }
        }
    </script>







    <script>
        const getScrollPosition = (el = window) => ({
            x: el.pageXOffset !== undefined ? el.pageXOffset : el.scrollLeft,
            y: el.pageYOffset !== undefined ? el.pageYOffset : el.scrollTop
        });
        // 此处的 750 是「页面元素的最大宽度」
        var wx = document.getElementsByClassName("article-m")[0].clientWidth;
        var wy = document.getElementsByClassName("article-m")[0].clientHeight;
        function windowScroll() {
            // 反复修改 确保页面尺寸不改变
            wx = document.getElementsByClassName("article-m")[0].clientWidth;
            wy = document.getElementsByClassName("article-m")[0].clientHeight;
            let y = Math.round(getScrollPosition().y);
            // console.log(y);
            // 组合字符串，同时记录页面坐标，页面宽度和高度
            let p = `${y}:${wx}:${wy}`;
            // 写入到 sessionStorage 中
            sessionStorage.setItem(location.pathname + "_read_y", p);
        }
        // URL 中是否包含传递的坐标信息
        setTimeout(() => {
            if (location.hash.split("#read=").length > 1) {
                prompt_core("已有阅读进度，正在跳转", 4800, true);
                // 分离字符串
                let read_y = location.hash.split("#read=")[1];
                read_y = read_y.split(":");
                // 组合乘积，顺滑移动至坐标
                window.scrollTo({top: Math.round(Number(read_y[0]) * Number(read_y[1] * Number(read_y[2] / wx / wy))), behavior: "smooth"});
            } else {
                // 从 sessionStorage 中获取
                let read_y = sessionStorage.getItem(location.pathname + "_read_y") || "0:0:0";
                read_y = read_y.split(":");
                if (read_y[0] != "0") prompt_core("已有阅读进度，正在跳转", 4800, true);
                window.scrollTo({top: Math.round(Number(read_y[0]) * Number(read_y[1] * Number(read_y[2] / wx / wy))), behavior: "smooth"});
            }
        }, 500);
        window.onscroll = windowScroll;
    </script>





        </div>
        <div id="css-loading">
            <h3 class="text-center">加载中...</h3>
        </div>
        
    </body>
</html>
