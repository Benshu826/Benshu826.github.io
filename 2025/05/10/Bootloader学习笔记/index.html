<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    
    <link rel="apple-touch-icon" sizes="76x76" href="/null">
    <link rel="icon" type="image/png" href="/null">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>Bootloaderå­¦ä¹ ç¬”è®° - Ben Shu &#39;s Blog</title>
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    
    <meta name="description" content="">
    <meta name="author" content="Big Ben">
    <meta name="keywords" content="">
    <meta property="og:title" content="Bootloaderå­¦ä¹ ç¬”è®°"/>
    <style>


    
    :root{
        --shadow-color: rgba(0,0,0,0.2);
        --sec-shadow: rgba(0,0,0,0.03);
        --shadow-hover-color: rgba(0,0,0,0.28);
        --first-text-color: #475b6d;
        --second-text-color: #37475b;
        --third-text-color: #858585;
        --default-text-color: #505050;
        --default-link-color: #007bff;
        --link-color: #000000;
        --second-link-color: #4F9BFA;
        --code-color:rgba(27,31,35,.05);
        --post-bkg-color: #fff;
        --page-bkg-color: #f2f5f8;
        --nav-a-hover-color: #3498db;
        --post-sec-text-color: #718096;
        --sec-bkg: #f2f5f8;
        --color-mode: 'light';
        --bkg-h: rgba(255,255,255,0.6);
        --bkg-m: #e1e4e8;
        --home-title-color: #4169E1;
        --shadow: 0 4px 10px rgba(0,2,4,0.06),0 0 1px rgba(0,2,4,0.11);
        --hr-color: #ddd;
        --bg-t: #f4f4f4;
        --nav-bkg: rgba(255,255,255,0.6);
    }

@media (prefers-color-scheme: dark) {
  :root {
    --color-mode: 'dark';
  }

  :root:not([data-theme]) {
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
  }
}

[data-theme='dark'] {
    --shadow-color: rgba(0,0,0,0.2);
    --shadow-hover-color: rgba(0,0,0,0.28);
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
}

</style>



<style>
#page-main,footer,.p-btn{
    display: none;
}
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
}
body {
    background-color: var(--page-bkg-color);
    color: var(--second-text-color);
    overflow-y: scroll;
    overflow-x: hidden;
    transition: all .3s;
}
a {
    color: var(--default-link-color);
    text-decoration: none;
    background-color: transparent;
}
a:hover{
    color: var(--second-link-color);
}
.main-content,.post-card-main{
    margin: 30px;
}



@media (max-width: 410px){
    .post-card-main{
        max-width: 350px!important;
    }
}

@media (max-width: 980px){
    .post-card-main{
        max-width: 520px!important;
    }
}


@media (min-width: 780px){ 
    h3{
        font-size: 1.5rem;
        line-height: 1.5em;
    }
}
@media (min-width: 1280px){ 
    h3{
        font-size: 1.7rem;
        line-height: 1.5em;
    }
}
@media (min-width: 2096px){ 
    h3{
        font-size: 1.8rem;
        line-height: 1.5em;
    }
}

.text-center{
    text-align: center!important;
}
.middle-center{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    height: 100%;
}
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    height: 54px;
    padding: 0 1.25rem;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    border-bottom: 1px solid var(--bkg-m);
    background-color: var(--nav-bkg);
    backdrop-filter: blur(4px);
    transition: all .3s;
}
header .header__left, header .header__right {
    display: flex;
    align-items: center;
    font-family: rubik,sans-serif,Varela Round;
}
header .header__left .logo__text {
    font-size: 18px;
    font-weight: 450;
    padding: 14.5px 10px;
    border-radius: 5px;
    color: var(--second-text-color);
}
header .header__right .navbar__menus {
    height: 54px;
    padding: 0 0 0 15px;
}
header .header__right .button {
    color: var(--second-text-color);
}
header .header__right .navbar__menus .navbar-menu {
    display: inline-block;
    align-items: center;
    height: 54px;
    padding: 0 10px;
    font-size: 16px;
    line-height: 54px;
}
header .header__right .dropdown-icon {
    display: none;
    height: 54px;
    padding: 15px 10px;
    border: 0;
    background-color: transparent;
}
header .header__right .dropdown-menus {
    line-height: 2rem;
    animation: slide-in .15s ease 1;
    display: none;
    position: absolute;
    left: 12px;
    right: 12px;
    top: calc(54px + 10px);
    border-radius: 6px;
    padding: 24px;
    background-color: var(--page-bkg-color);
    border: 1px solid var(--bkg-m);
    z-index: 9999;
    justify-items: center;
    justify-content: center;
    flex-direction: column;
}
header .header__right #btn-search, header .header__right #btn-toggle-dark{
    display: inline-block;
    padding:  18px 10px;
    height: 25px;
}
header .header__right #btn-dropdown{
  display: inline-block;
  padding:  13.5px 0;
}
header .header__right .dropdown-menus .dropdown-menu {
    padding: 10px;
    color: var(--second-text-color);
}
@media screen and (max-width: 764px){
.navbar__menus {
    display: none!important;
}
.dropdown-icon {
    display: inline-block!important;
}
}
.p-btn{
    position: fixed;
    bottom: 1.2rem;
    right: 1.2rem;
    contain: layout;
}
.toc-btn,.click-btn{
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    align-items: center;
    margin-top: .5rem;
    font-size: .75rem;
    background-color: var(--sec-bkg);
    display: block;
    padding: 0.9rem;
    box-shadow: 0 0.3rem 0.6rem rgba(48,55,66,.15);
    border: none;
    border-radius: 0.5rem;
    line-height: 1;
    color: var(--first-text-color);
}
.toc-link{
    color: var(--second-text-color);
}

#css-loading h3{
    font-weight: 500;
    font-size: 1.4rem;
    text-align: center;
    position: fixed;
    top: 200px;
    left: 0;
    right: 0;
    opacity: 0;
    animation: cssLoad;
    animation-delay: 0.3s;
    -webkit-animation: cssLoad;
    -webkit-animation-delay: 0.3s;
}
@keyframes cssLoad {
    from {
        opacity: 0;
    }
    to {
        opacity: 0.9;
    }
}


.memorial {
    -webkit-filter: grayscale(100%);
    -moz-filter: grayscale(100%);
    -ms-filter: grayscale(100%);
    -o-filter: grayscale(100%);
    filter: grayscale(100%);
    filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1); filter:gray;
}


    .post-copyright:after {
        position: absolute;
        color: #fff;
        background: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");
        content: ' ';
        height: 10rem;
        width: 10rem;
        right: -2rem;
        top: -2rem;
        opacity: .1;
    }

</style>

    

    
        <!--
        <link rel="stylesheet" href="/css/page.css" media="print"
            onload="this.media='all';this.onload=null">
        <noscript>-->
            <link rel="stylesheet" href="/css/page.css">
        <!--</noscript>-->
    
    
    <link rel="stylesheet" href="/css/main.css" media="print" onload="this.media='all';this.onload=null">
    <noscript>
        <link rel="stylesheet" href="/css/main.css">
    </noscript>

    
    <script src="/js/main.js"></script>
    
      
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

    <body>
        <header>
            
<div class="header__left">
	<a href="/" class="button"><span class="logo__text">ä¸»é¡µ</span></a>
</div>
<div class="header__right">
	<div class="navbar__menus">
		
		<a href="/" class="button">
			<div class="navbar-menu">é¦–é¡µ</div>
		</a>
		
		<a href="/archives/" class="button">
			<div class="navbar-menu">å½’æ¡£</div>
		</a>
		
		<a href="/categories/" class="button">
			<div class="navbar-menu">åˆ†ç±»</div>
		</a>
		
		<a href="/tags/" class="button">
			<div class="navbar-menu">æ ‡ç­¾</div>
		</a>
		
		<a href="/about/" class="button">
			<div class="navbar-menu">å…³äº</div>
		</a>
		
	</div>
	
	<a href="/search/" class="button">
		<div id="btn-search">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32">
				<path
					d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z">
				</path>
			</svg>
		</div>
	</a>
	
	<a href="javaScript:void(0);" class="button" id="btn-toggle-dark">
		<div>
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none"
				stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
			</svg>
		</div>
	</a>
	<a href="javaScript:void(0);" class="dropdown-icon button">
		<div id="btn-dropdown">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32" stroke-linecap="round">
				<path
					d="M903.43 561.52H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 204.31H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 918.73H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24z"
					fill="currentColor"></path>
			</svg>
		</div>
	</a>
	<div class="dropdown-menus" id="dropdown-menus">
		
		<a href="/" class="dropdown-menu button">é¦–é¡µ</a>
		<br>
		
		<a href="/archives/" class="dropdown-menu button">å½’æ¡£</a>
		<br>
		
		<a href="/categories/" class="dropdown-menu button">åˆ†ç±»</a>
		<br>
		
		<a href="/tags/" class="dropdown-menu button">æ ‡ç­¾</a>
		<br>
		
		<a href="/about/" class="dropdown-menu button">å…³äº</a>
		<br>
		
	</div>
</div>

        </header>
        <div id="top"></div>
        <div id="page-main" class="main-content">
        <div class="mg-top">
            

<article class="page">
<div id="post-meta-m">
    <div class="post-meta" id="post-meta">
  <h3>Bootloaderå­¦ä¹ ç¬”è®°</h3>
    
      <span class="post-meta-label">
        Big Ben
      </span>
    
    
      <span class="post-meta-label">
        <span class="p-dot"></span>
        <time datetime="2025-05-10 03:07" pubdate>
          2025-05-10
        </time>
      </span>
    
    
      
      <span class="post-meta">
        <span class="p-dot"></span>
        å…± 8.8k å­—
      </span>
    
    
    
  </div>
  
</div>
<div class="article-m">
  <div class="post-toc">
    
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bootloaderiap"><span class="toc-number">1.</span> <span class="toc-text"> Bootloader+IAP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E8%A6%81%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.</span> <span class="toc-text"> ç®€è¦è¯´æ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.1.</span> <span class="toc-text"> è¯´æ˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.2.</span> <span class="toc-text"> æ•´ä½“æµç¨‹å›¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%8C%BA"><span class="toc-number">1.3.</span> <span class="toc-text"> åˆ†åŒº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%88"><span class="toc-number">1.4.</span> <span class="toc-text"> æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B"><span class="toc-number">1.5.</span> <span class="toc-text"> ç¼–ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E4%B8%8Edma"><span class="toc-number">1.5.1.</span> <span class="toc-text"> ä¸²å£ä¸DMA</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#h%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.5.1.0.1.</span> <span class="toc-text"> .hç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%B2%E5%8F%A3%E5%92%8Cdma"><span class="toc-number">1.5.1.1.</span> <span class="toc-text"> é…ç½®ä¸²å£å’ŒDMA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E7%A9%BA%E9%97%B2%E4%B8%AD%E6%96%AD%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.1.2.</span> <span class="toc-text"> ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%96%B0%E7%9A%84printf%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.1.3.</span> <span class="toc-text"> ç¼–å†™æ–°çš„Printfå‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#i2c"><span class="toc-number">1.5.2.</span> <span class="toc-text"> I2C</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#h%E7%A8%8B%E5%BA%8F-2"><span class="toc-number">1.5.2.1.</span> <span class="toc-text"> .hç¨‹åº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#delay"><span class="toc-number">1.5.2.2.</span> <span class="toc-text"> Delay</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-start%E5%92%8Cstop%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.5.2.3.</span> <span class="toc-text"> åˆå§‹åŒ–ã€STARTå’ŒSTOPä¿¡å·</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82"><span class="toc-number">1.5.2.4.</span> <span class="toc-text"> å‘é€ä¸€ä¸ªå­—èŠ‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82"><span class="toc-number">1.5.2.5.</span> <span class="toc-text"> è¯»å–ä¸€ä¸ªå­—èŠ‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%89%E5%BE%85%E4%BB%8E%E6%9C%BAack"><span class="toc-number">1.5.2.6.</span> <span class="toc-text"> ç­‰å¾…ä»æœºACK</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#at24c02"><span class="toc-number">1.5.3.</span> <span class="toc-text"> AT24C02</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5"><span class="toc-number">1.5.3.1.</span> <span class="toc-text"> å†™å…¥</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#byte-write"><span class="toc-number">1.5.3.1.1.</span> <span class="toc-text"> Byte Write</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#page-write"><span class="toc-number">1.5.3.1.2.</span> <span class="toc-text"> Page Write</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96"><span class="toc-number">1.5.3.2.</span> <span class="toc-text"> è¯»å–</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spi"><span class="toc-number">1.5.4.</span> <span class="toc-text"> SPI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%94%B6%E5%8F%91"><span class="toc-number">1.5.4.1.</span> <span class="toc-text"> æ•°æ®æ”¶å‘</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#w25q64"><span class="toc-number">1.5.5.</span> <span class="toc-text"> W25Q64</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.5.5.1.</span> <span class="toc-text"> çŠ¶æ€å¯„å­˜å™¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E8%A1%A8"><span class="toc-number">1.5.5.2.</span> <span class="toc-text"> æŒ‡ä»¤è¡¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.5.5.3.</span> <span class="toc-text"> ç›¸å…³ç¨‹åº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%A6%E9%99%A464kb"><span class="toc-number">1.5.5.4.</span> <span class="toc-text"> æ“¦é™¤64KB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B5%E5%86%99%E5%85%A5256byte"><span class="toc-number">1.5.5.5.</span> <span class="toc-text"> é¡µå†™å…¥256Byte</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">1.5.5.6.</span> <span class="toc-text"> è¯»å–æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stm32%E7%9A%84flash"><span class="toc-number">1.5.6.</span> <span class="toc-text"> STM32çš„FLASH</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%A6%E9%99%A4flash"><span class="toc-number">1.5.6.1.</span> <span class="toc-text"> æ“¦é™¤Flash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5flash"><span class="toc-number">1.5.6.2.</span> <span class="toc-text"> å†™å…¥Flash</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bootloader%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.</span> <span class="toc-text"> BootloaderåŠŸèƒ½å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ab%E5%88%86%E5%8C%BA%E8%A7%84%E5%88%92"><span class="toc-number">1.6.1.</span> <span class="toc-text"> ABåˆ†åŒºè§„åˆ’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-number">1.6.2.</span> <span class="toc-text"> æ³¨æ„ç‚¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ota%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="toc-number">1.6.3.</span> <span class="toc-text"> OTAå®å®šä¹‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ota%E8%AF%BB%E5%8F%96%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="toc-number">1.6.4.</span> <span class="toc-text"> OTAè¯»å–æ ‡å¿—ä½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ota%E4%BF%9D%E5%AD%98%E5%85%B3%E9%94%AE%E5%8F%98%E9%87%8F%E5%88%B0at24c02"><span class="toc-number">1.6.5.</span> <span class="toc-text"> OTAä¿å­˜å…³é”®å˜é‡åˆ°AT24C02</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%AF%BC%E6%9B%B4%E6%96%B0ota"><span class="toc-number">1.6.6.</span> <span class="toc-text"> å¼•å¯¼æ›´æ–°OTA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bootloader%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.6.7.</span> <span class="toc-text"> BootLoaderäº‹ä»¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.7.</span> <span class="toc-text"> ä¸»ç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#xmodem%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text"> Xmodemåè®®</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text"> æ ¼å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text"> æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">2.3.</span> <span class="toc-text"> ä¾‹å­</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#crc16%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.4.</span> <span class="toc-text"> CRC16ç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text"> å‚è€ƒ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A1%A5%E5%85%85724"><span class="toc-number">4.</span> <span class="toc-text"> è¡¥å……ï¼ˆ7.24ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#bootloader%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text"> Bootloaderæ‰§è¡Œæµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sram%E5%9C%A8%E6%AD%A4%E7%9A%84%E6%84%8F%E4%B9%89"><span class="toc-number">4.2.</span> <span class="toc-text"> SRAMåœ¨æ­¤çš„æ„ä¹‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#app%E7%A8%8B%E5%BA%8F%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.</span> <span class="toc-text"> APPç¨‹åºé…ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dma%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AErx_buffer-1%E9%85%8D%E5%90%88idle%E5%AE%9E%E7%8E%B0%E6%8E%A5%E6%94%B6%E4%B8%8D%E5%AE%9A%E9%95%BF%E6%95%B0%E6%8D%AE"><span class="toc-number">4.4.</span> <span class="toc-text"> DMAå¦‚ä½•é…ç½®RX_BUFFER + 1é…åˆIDLEå®ç°æ¥æ”¶ä¸å®šé•¿æ•°æ®</span></a></li></ol></li></ol>
    
  </div>
    <div id="article">
      <div id="post-content" class="markdown-body textretty">
        <h1 id="bootloaderiap"><a class="markdownIt-Anchor" href="#bootloaderiap"></a> Bootloader+IAP</h1>
<h2 id="ç®€è¦è¯´æ˜"><a class="markdownIt-Anchor" href="#ç®€è¦è¯´æ˜"></a> ç®€è¦è¯´æ˜</h2>
<p>æœ¬å­¦ä¹ ç¬”è®°ä¸»è¦åŒ…æ‹¬<strong>STM32F103C8T6</strong>ä¸‹çš„Bootloader+IAP</p>
<p><strong>Bootloader</strong>ï¼šç”¨äºæ›´æ–°APPçš„ç¨‹åº</p>
<p><strong>IAP</strong>ï¼šåœ¨è®¾å¤‡è¿è¡Œæ—¶ï¼Œç”±Bootloaderå¼•å¯¼å¯¹è‡ªèº«ç¨‹åºæ“¦å†™</p>
<p><strong>OTA</strong>ï¼šæ— çº¿é€šä¿¡å°†æ–°çš„å›ºä»¶ä¸‹è½½åˆ°è®¾å¤‡ä¸­ï¼ˆOver The Airï¼‰</p>
<h3 id="è¯´æ˜"><a class="markdownIt-Anchor" href="#è¯´æ˜"></a> è¯´æ˜</h3>
<p><strong>ä½¿ç”¨çš„APPæ•°æ®ï¼ŒOTAæ ‡å¿—ä½ï¼Œç‰ˆæœ¬å·å­˜å‚¨åœ¨AT24C02</strong></p>
<p><strong>å¤šä¸ªå¤‡ä»½APPæ•°æ®å­˜å‚¨åœ¨W25Q64</strong></p>
<blockquote>
<p>Qï¼šå·²ç»æ“ä½œäº†AT24C02å’ŒW25Q64ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æ“ä½œå•ç‰‡æœºä¸Šçš„SRAMï¼Ÿ</p>
<p>AT24C02å’ŒFlashè¯»å†™å¤ªæ…¢ï¼Œè·Ÿä¸ä¸ŠCPUçš„é€Ÿåº¦ï¼Œ<strong>SRAMæ˜¯ä¸´æ—¶ã€é«˜é€Ÿçš„æ•°æ®äº¤æ¢åŒº</strong>ã€‚</p>
</blockquote>
<h2 id="æ•´ä½“æµç¨‹å›¾"><a class="markdownIt-Anchor" href="#æ•´ä½“æµç¨‹å›¾"></a> æ•´ä½“æµç¨‹å›¾</h2>
<p><img src="https://s2.loli.net/2025/05/10/ADCErlteIk9JBR4.png" alt="" /></p>
<blockquote>
<p>è¿™é‡Œè¯´æ˜ä¸‹æ²¡æœ‰Running APPé‚£ä¸€ç¯ï¼ŒVisioæºæ–‡ä»¶æ‰¾ä¸åˆ°äº†</p>
</blockquote>
<h2 id="åˆ†åŒº"><a class="markdownIt-Anchor" href="#åˆ†åŒº"></a> åˆ†åŒº</h2>
<p>AåŒºå­˜æ”¾APPï¼ŒBåŒºå­˜æ”¾Bootloaderç¨‹åºã€‚<strong>OTA_Flagè¡¨ç¤ºæ˜¯å¦æ›´æ–°APPï¼Œå­˜æ”¾åœ¨AT24C02ä¸­</strong></p>
<ol>
<li>
<p>âŒï¸ <strong>| A | B |</strong> ------&gt;ç¨‹åºè¿è¡Œåï¼Œå…ˆè¿›å…¥AåŒºï¼›è‹¥OTA_Flag=1å¼€å§‹æ›´æ–°æ•°æ®ï¼Œå½“æ­£åœ¨æ›´æ–°çš„AåŒºå‡ºç°å¼‚å¸¸é€€å‡ºï¼Œä¸‹ä¸€æ¬¡ä¸Šç”µåè¿è¡ŒAå‘ç°ç¨‹åºä¸å…¨ï¼Œæ— æ³•å†è¿›å…¥BåŒºè¿›è¡Œåç»­æ›´æ–°AåŒºçš„æ“ä½œï¼Œå¹¶ä¸”ä¹‹å‰çš„AåŒºç¨‹åºæœ‰å‡ºç°é—®é¢˜ï¼Œ<strong>æ‚²æŠ¥ï¼Œæˆç –å¤´äº†</strong>ã€‚</p>
</li>
<li>
<p>âœ”ï¸ <strong>| B | A |</strong> ------&gt;ç¨‹åºè¿è¡Œåï¼Œå…ˆè¿›å…¥BåŒºï¼Œè§‚æµ‹åˆ°OTA_Flag=1åå¯¹AåŒºè¿›è¡Œæ•°æ®æ›´æ–°ï¼Œå³ä½¿å¼‚å¸¸é€€å‡ºï¼Œåç»­ä»ç„¶å¯ä»¥è¿›å…¥BåŒºå¯¹AåŒºè¿›è¡Œæ›´æ–°ï¼Œæ›´æ–°å®Œæˆåç½®OTA_Flag=0ã€‚</p>
</li>
</ol>
<h2 id="æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆ"></a> æ–¹æ¡ˆ</h2>
<p>ğŸ¦<strong>DMA + ç©ºé—²ä¸­æ–­</strong></p>
<p>åœ¨æ— éœ€CPUå¸®åŠ©ä¸‹ï¼Œ<strong>DMA</strong>è´Ÿè´£å¤–è®¾ä¸å¯„å­˜å™¨ä¹‹é—´<strong>æ•°æ®ä¼ è¾“</strong></p>
<p><strong>ç©ºé—²ä¸­æ–­</strong>ï¼ˆIDLEï¼‰æ˜¯ä¸²å£é€šä¿¡ä¸­<strong>åˆ¤æ–­â€œæ¥æ”¶å®Œæˆâ€çš„ç»å…¸æ–¹å¼</strong></p>
<blockquote>
<p><strong>Qï¼šå¦‚ä½•æ¶ˆé™¤ç©ºé—²ä¸­æ–­ï¼Ÿ</strong></p>
<p>è¯»ä¸€æ¬¡æ ‡å¿—ä½å¯„å­˜å™¨ï¼Œå†è¯»ä¸€æ¬¡æ•°æ®å¯„å­˜å™¨ï¼Œå³å¯æ¶ˆé™¤ç©ºé—²ä¸­æ–­</p>
</blockquote>
<p><strong>ç¯å½¢ç¼“å†²åŒº</strong>ï¼š<strong>æ•°æ®ä¼ è¾“</strong>è¿‡ç¨‹ä¸­ï¼Œ<strong>æ¥æ”¶é€Ÿåº¦å’Œå¤„ç†é€Ÿåº¦å¯èƒ½ä¸ä¸€è‡´</strong>ï¼Œå› æ­¤<strong>éœ€è¦ç¼“å†²åŒºå…ˆä¿å­˜æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±</strong>ï¼›ä¸€ç»´æ•°ç»„ï¼Œç¡®è®¤<strong>å•æ¬¡æ¥æ”¶æœ€å¤§é‡</strong>ï¼Œé˜²æ­¢å‡ºç°è¶Šç•Œé—®é¢˜</p>
<blockquote>
<p><strong>Qï¼šå¦‚ä½•åˆ¤æ–­Readå’ŒWriteçš„çŠ¶æ€é—®é¢˜ï¼Ÿ</strong></p>
<ol>
<li>
<p><strong>é¢„ç•™ä¸€ä¸ªç©ºä½ã€‚Read == Writeï¼Œå³ç©ºï¼›ï¼ˆWrite + 1ï¼‰% N == Rï¼Œå³æ»¡ï¼›</strong></p>
</li>
<li>
<p>é€šè¿‡ä¸€ä¸ªcountè®¡æ•°ï¼ŒWæ˜¯ç”Ÿäº§è€…ï¼ŒRæ˜¯æ¶ˆè´¹è€…ï¼›æ¯æ¬¡Wå°±count+1ï¼Œæ¯æ¬¡Rå°±count-1ï¼›0&lt;=count&lt;=Max_Countã€‚</p>
</li>
</ol>
</blockquote>
<p><strong>SEæŒ‡é’ˆå¯¹ï¼ˆç¯å½¢ç¼“å†²ï¼‰</strong>ï¼šç¼“å†²åŒºæ˜¯ä¸€ç»´æ•°ç»„ï¼Œæ€»é•¿åº¦ä¸º 2048 Byteï¼Œåˆ’åˆ†ä¸º10ä¸ªæ•°æ®å—ï¼Œæ¯ä¸ªæ•°æ®å—200 Byteã€‚é€šè¿‡ä¸¤ä¸ªæŒ‡é’ˆ INï¼ˆç”Ÿäº§è€…æŒ‡é’ˆï¼‰å’Œ OUTï¼ˆæ¶ˆè´¹è€…æŒ‡é’ˆï¼‰ç®¡ç†ç¼“å†²åŒºçš„è¯»å†™æ“ä½œã€‚å½“ IN â‰  OUT æ—¶ï¼Œè¡¨ç¤ºç¼“å†²åŒºä¸­å­˜åœ¨å¾…å¤„ç†çš„æ•°æ®åŒ…ã€‚æŒ‡é’ˆæ¯æ¬¡ç§»åŠ¨ä¸€ä¸ªæ•°æ®å—ï¼ˆ200å­—èŠ‚ï¼‰ï¼Œå½“æŒ‡é’ˆåˆ°è¾¾ç¼“å†²åŒºæœ«å°¾æ—¶è‡ªåŠ¨å›å·åˆ°èµ·å§‹ä½ç½®ï¼Œå®ç°ç¯å½¢ç¼“å†²æœºåˆ¶ã€‚</p>
<img src="https://s2.loli.net/2025/08/22/Mg31NUZXFtv5TCk.png" style="zoom:50%;" />
<p>â—TIPï¼šæ¯æ¬¡æ¥æ”¶åï¼Œéƒ½<strong>éœ€è¦åˆ¤æ–­å‰©ä½™ç©ºé—´</strong>ï¼Œä»¥é˜²å†…å­˜ä¸è¶³ï¼ŒåŠæ—¶å›å·ï¼›éœ€è¦è®°å½•å·²ç»å­˜æ”¾çš„<strong>ç´¯åŠ å€¼</strong></p>
<h2 id="ç¼–ç¨‹"><a class="markdownIt-Anchor" href="#ç¼–ç¨‹"></a> ç¼–ç¨‹</h2>
<p>STM32F103C8T6ä½¿ç”¨å¤–éƒ¨é«˜é€Ÿæ—¶é’ŸHSEï¼Œ8MHzï¼›é€šè¿‡PLLï¼ˆå€é¢‘é”ç›¸ç¯ï¼‰å¯ä»¥è¾¾åˆ°72MHz</p>
<h3 id="ä¸²å£ä¸dma"><a class="markdownIt-Anchor" href="#ä¸²å£ä¸dma"></a> ä¸²å£ä¸DMA</h3>
<h5 id="hç¨‹åº"><a class="markdownIt-Anchor" href="#hç¨‹åº"></a> .hç¨‹åº</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼“å†²åŒºå¤§å°å®šä¹‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> URx_SIZE 2048           <span class="comment">// æ¥æ”¶ç¼“å†²åŒºæ€»å¤§å°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UTx_SIZE 2048           <span class="comment">// å‘é€ç¼“å†²åŒºå¤§å°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> URx_MAX 200             <span class="comment">// å•æ¬¡DMAæ¥æ”¶æœ€å¤§å­—èŠ‚æ•°</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 10                  <span class="comment">// æ¥æ”¶æ•°æ®åŒ…é˜Ÿåˆ—æ·±åº¦</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> URx_Buff[URx_SIZE];</span><br><span class="line"><span class="type">uint8_t</span> UTx_Buff[UTx_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸä¸€ç»„æ•°æ®æ¥æ”¶å¼€å§‹ä¸ç»“æŸï¼Œ startï¼šå¼€å§‹ï¼Œ endï¼šç»“å°¾</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">uint8_t</span> *start;             <span class="comment">// æ•°æ®åŒ…èµ·å§‹åœ°å€</span></span><br><span class="line">	<span class="type">uint8_t</span> *end;               <span class="comment">// æ•°æ®åŒ…ç»“æŸåœ°å€</span></span><br><span class="line">&#125;UCB_URxBuff;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç®¡ç†ä¸²å£æ¥æ”¶æ•°æ®</span></span><br><span class="line"><span class="comment">   URxCounter	å½“å‰ç¼“å†²åŒºä¸­æœªå¤„ç†çš„æ•°æ®é‡</span></span><br><span class="line"><span class="comment">   URxDataPtr	ç¼“å†²åŒºå­˜å‚¨æ•°ç»„åºå·</span></span><br><span class="line"><span class="comment">   URxDataIN	æŒ‡å‘ä¸‹ä¸€ç»„å¯å†™å…¥æ•°æ®çš„ä½ç½®</span></span><br><span class="line"><span class="comment">   URxDataOUT	æŒ‡å‘ä¸‹ä¸€ä¸ªå¾…è¯»å–æ•°æ®çš„ä½ç½®</span></span><br><span class="line"><span class="comment">   URxDataEND	æŒ‡å‘æ•°ç»„æœ«å°¾	*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">uint16_t</span> URxCounter;        <span class="comment">// æ¥æ”¶è®¡æ•°å™¨ï¼Œè®°å½•å½“å‰æ¥æ”¶ä½ç½®</span></span><br><span class="line">	UCB_URxBuff URxDataPtr[NUM]; <span class="comment">// æ•°æ®åŒ…æŒ‡é’ˆæ•°ç»„ï¼ˆç¯å½¢é˜Ÿåˆ—ï¼‰</span></span><br><span class="line">	UCB_URxBuff *URxDataIN;     <span class="comment">// è¾“å…¥æŒ‡é’ˆï¼ˆç”Ÿäº§è€…ï¼‰</span></span><br><span class="line">	UCB_URxBuff *URxDataOUT;    <span class="comment">// è¾“å‡ºæŒ‡é’ˆï¼ˆæ¶ˆè´¹è€…ï¼‰</span></span><br><span class="line">	UCB_URxBuff *URxDataEND;    <span class="comment">// é˜Ÿåˆ—æœ«å°¾æŒ‡é’ˆ</span></span><br><span class="line">&#125;UCB_CB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> UCB_CB UCB;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">uint8_t</span> URx_Buff[URx_SIZE];</span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®ä¸²å£å’Œdma"><a class="markdownIt-Anchor" href="#é…ç½®ä¸²å£å’Œdma"></a> é…ç½®ä¸²å£å’ŒDMA</h4>
<ol>
<li>è®¾ç½®ç›¸å…³<strong>å¤–è®¾æ—¶é’Ÿ</strong></li>
<li>åˆå§‹åŒ–<strong>GPIO(IOåˆ†åŒº,MODE,é¢‘ç‡,IOå£)</strong></li>
<li>é…ç½®<strong>ä¸²å£ï¼ˆåˆå§‹åŒ–ï¼Œæ³¢ç‰¹ç‡ï¼Œæ ¡éªŒï¼Œæ•°æ®ä½é•¿åº¦ï¼Œåœæ­¢ä½ä¸ªæ•°ï¼Œæ¥æ”¶å‘æƒ…å†µï¼‰</strong></li>
<li>é…ç½®<strong>ä¸²å£DMA</strong></li>
<li>æ‰“å¼€<strong>ä¸²å£ä¸­æ–­ï¼ˆIDLEä¸ºç©ºé—²ä¸­æ–­ï¼‰</strong></li>
<li><strong>è°ƒç”¨å…¶ä»–åŠŸèƒ½å‡½æ•°</strong></li>
<li><strong>ä½¿èƒ½ä¸²å£</strong></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">RCC_USART_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_USART1, ENABLE);</span><br><span class="line">	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1, ENABLE);		<span class="comment">// é…ç½®DMA</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">GPIO_USART_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;<span class="comment">// é…ç½®PA9ä¸ºTXï¼ˆå¤ç”¨æ¨æŒ½è¾“å‡ºï¼‰</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;</span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;<span class="comment">// é…ç½®PA10ä¸ºRXï¼ˆæµ®ç©ºè¾“å…¥ï¼‰</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">NVIC_USART_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// é…ç½®ä¸­æ–­</span></span><br><span class="line">	NVIC_SetPriorityGrouping(NVIC_PriorityGroup_2);</span><br><span class="line">		</span><br><span class="line">	NVIC_InitTypeDef NVIC_InitStructure;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = <span class="number">0</span>;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = <span class="number">0</span>;</span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DMA_USART_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	DMA_InitTypeDef DMA_InitStructure;</span><br><span class="line">    <span class="comment">//URx_Buffé•¿åº¦ä¸ºURx_MAXï¼Œæ­¤å¤„+1æ˜¯ä¸ºäº†é…åˆIDLEå®ç°ä¸­æ–­</span></span><br><span class="line">	DMA_InitStructure.DMA_BufferSize = URx_MAX + <span class="number">1</span>;</span><br><span class="line">	DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralSRC;</span><br><span class="line">	DMA_InitStructure.DMA_M2M = DMA_M2M_Disable;</span><br><span class="line">	DMA_InitStructure.DMA_MemoryBaseAddr = (<span class="type">uint32_t</span>)URx_Buff;</span><br><span class="line">	DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_Byte;</span><br><span class="line">	DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable;</span><br><span class="line">	DMA_InitStructure.DMA_Mode = DMA_Mode_Normal;</span><br><span class="line">	DMA_InitStructure.DMA_PeripheralBaseAddr = (<span class="type">uint32_t</span>)&amp;USART1-&gt;DR;</span><br><span class="line">	DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_Byte;</span><br><span class="line">	DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable;</span><br><span class="line">	DMA_InitStructure.DMA_Priority = DMA_Priority_High;</span><br><span class="line">	DMA_Init(DMA1_Channel5, &amp;DMA_InitStructure);</span><br><span class="line">	</span><br><span class="line">	DMA_Cmd(DMA1_Channel5, ENABLE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// USART1åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">USART1_Init</span><span class="params">(<span class="type">uint32_t</span> band)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ä½¿èƒ½æ—¶é’Ÿ</span></span><br><span class="line">	RCC_USART_Init();</span><br><span class="line">	GPIO_USART_Init();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// é…ç½®USART1å‚æ•°</span></span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line">	USART_InitStructure.USART_BaudRate = band;</span><br><span class="line">	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;</span><br><span class="line">	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;</span><br><span class="line">	USART_InitStructure.USART_Parity = USART_Parity_No;</span><br><span class="line">	USART_InitStructure.USART_StopBits = USART_StopBits_1;</span><br><span class="line">	USART_InitStructure.USART_WordLength = USART_WordLength_8b;</span><br><span class="line">	USART_Init(USART1, &amp;USART_InitStructure);</span><br><span class="line">	</span><br><span class="line">	USART_DMACmd(USART1, USART_DMAReq_Rx, ENABLE);</span><br><span class="line">	USART_ITConfig(USART1, USART_IT_IDLE, ENABLE);</span><br><span class="line">	</span><br><span class="line">	NVIC_USART_Init();</span><br><span class="line">	DMA_USART_Init();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// åˆå§‹åŒ–ä¸²å£æ§åˆ¶å—</span></span><br><span class="line">	UCB.URxCounter = <span class="number">0</span>;</span><br><span class="line">	UCB.URxDataIN = &amp;UCB.URxDataPtr[<span class="number">0</span>];</span><br><span class="line">	UCB.URxDataOUT = &amp;UCB.URxDataPtr[<span class="number">0</span>];</span><br><span class="line">	UCB.URxDataEND = &amp;UCB.URxDataPtr[NUM - <span class="number">1</span>];</span><br><span class="line">	UCB.URxDataIN-&gt;start = URx_Buff;</span><br><span class="line">	</span><br><span class="line">	USART_Cmd(USART1, ENABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°"><a class="markdownIt-Anchor" href="#ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°"></a> ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°</h4>
<ol>
<li><strong>æ£€æµ‹ç©ºé—²ä¸­æ–­</strong></li>
<li><strong>æ¶ˆé™¤ç©ºé—²ä¸­æ–­æ ‡å¿—ä½</strong>ï¼ˆåªæœ‰è¯»æ ‡å¿—ä½å¯„å­˜å™¨å’Œæ•°æ®ä½å¯„å­˜å™¨æ‰èƒ½å°†ç©ºé—²æ ‡å¿—ä½æ¸…é™¤ï¼‰</li>
<li>åœ¨ç©ºé—²ä¸­æ–­ä¸­<strong>è¯»å–ä¸²å£DMAå¢æ·»æ•°æ®çš„é•¿åº¦</strong>(DMA,é€šé“) â€” counter += (æ€»é‡ - å‰©ä½™ç©ºé—²å€¼)</li>
<li><strong>è®¾ç½®ç¼“å†²åŒºçš„INæŒ‡é’ˆ</strong></li>
<li>Disable DMAï¼Œé‡æ–°é…ç½®DMAï¼ˆDMAï¼Œé€šé“ï¼Œå¤§å°ï¼Œåœ°å€ï¼‰ï¼Œä¿è¯ä¸å‡ºç°å®ŒæˆçŠ¶æ€ï¼Œå†ä½¿èƒ½DMA</li>
</ol>
<p><strong>è¦ä¸€ç›´è®©DMAè¯»å–æ•°æ®ï¼Œç›´åˆ°å‡ºç°ç©ºé—²ä¸­æ–­æ‰ä¼šåœæ­¢ï¼Œå› æ­¤ä¸ä¼šå‡ºç°å®ŒæˆçŠ¶æ€</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief USART1ä¸­æ–­å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param æ— </span></span><br><span class="line"><span class="comment"> * @return æ— </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * å¤„ç†USART1çš„IDLEï¼ˆç©ºé—²ï¼‰ä¸­æ–­ï¼š</span></span><br><span class="line"><span class="comment"> * 1. æ£€æµ‹åˆ°ä¸²å£ç©ºé—²æ—¶ï¼Œè¡¨ç¤ºä¸€ä¸ªæ•°æ®åŒ…æ¥æ”¶å®Œæˆ</span></span><br><span class="line"><span class="comment"> * 2. è®¡ç®—å®é™…æ¥æ”¶çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment"> * 3. æ›´æ–°ç¯å½¢ç¼“å†²åŒºæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * 4. é‡æ–°é…ç½®DMAä¸ºä¸‹ä¸€æ¬¡æ¥æ”¶åšå‡†å¤‡</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * å·¥ä½œæµç¨‹ï¼š</span></span><br><span class="line"><span class="comment"> * - IDLEä¸­æ–­è§¦å‘ -&gt; æ•°æ®åŒ…æ¥æ”¶å®Œæˆ</span></span><br><span class="line"><span class="comment"> * - è®¡ç®—æ¥æ”¶é•¿åº¦ -&gt; æ›´æ–°æ•°æ®åŒ…ç»“æŸæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * - ç§»åŠ¨è¾“å…¥æŒ‡é’ˆ -&gt; å¤„ç†ç¯å½¢ç¼“å†²åŒºç»•å›</span></span><br><span class="line"><span class="comment"> * - é‡å¯DMAæ¥æ”¶ -&gt; å‡†å¤‡æ¥æ”¶ä¸‹ä¸€ä¸ªæ•°æ®åŒ…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">USART1_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// æ£€æŸ¥IDLEä¸­æ–­æ ‡å¿—ä½</span></span><br><span class="line">	<span class="keyword">if</span>(USART_GetFlagStatus(USART1, USART_FLAG_IDLE) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// æ¸…é™¤IDLEä¸­æ–­æ ‡å¿—ä½</span></span><br><span class="line">		USART_ClearFlag(USART1, USART_FLAG_IDLE);</span><br><span class="line">		<span class="comment">// è¯»å–æ•°æ®å¯„å­˜å™¨ä»¥æ¸…é™¤IDLEæ ‡å¿—ï¼ˆå¿…é¡»æ“ä½œï¼‰</span></span><br><span class="line">		USART_ReceiveData(USART1);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// è®¡ç®—æœ¬æ¬¡æ¥æ”¶çš„æ•°æ®é•¿åº¦å¹¶æ›´æ–°æ¥æ”¶è®¡æ•°å™¨</span></span><br><span class="line">		UCB.URxCounter += (URx_MAX + <span class="number">1</span>) - DMA_GetCurrDataCounter(DMA1_Channel5);</span><br><span class="line">		<span class="comment">// è®¾ç½®å½“å‰æ•°æ®åŒ…çš„ç»“æŸåœ°å€</span></span><br><span class="line">		UCB.URxDataIN-&gt;end = &amp;URx_Buff[UCB.URxCounter - <span class="number">1</span>];</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// ç§»åŠ¨è¾“å…¥æŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªæ•°æ®åŒ…ä½ç½®</span></span><br><span class="line">		UCB.URxDataIN++;</span><br><span class="line">		<span class="comment">// æ£€æŸ¥æ˜¯å¦åˆ°è¾¾é˜Ÿåˆ—æœ«å°¾ï¼Œè¿›è¡Œç¯å½¢å¤„ç†</span></span><br><span class="line">		<span class="keyword">if</span>(UCB.URxDataIN == UCB.URxDataEND)</span><br><span class="line">		&#123;</span><br><span class="line">			UCB.URxDataIN = &amp;UCB.URxDataPtr[<span class="number">0</span>];     <span class="comment">// å›åˆ°é˜Ÿåˆ—å¼€å¤´</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// æ£€æŸ¥å‰©ä½™ç¼“å†²åŒºç©ºé—´ï¼Œå†³å®šä¸‹ä¸€æ¬¡DMAæ¥æ”¶çš„èµ·å§‹åœ°å€</span></span><br><span class="line">		<span class="keyword">if</span>(URx_SIZE - UCB.URxCounter &gt;= URx_MAX)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// å‰©ä½™ç©ºé—´è¶³å¤Ÿï¼Œç»§ç»­åœ¨å½“å‰ä½ç½®æ¥æ”¶</span></span><br><span class="line">			UCB.URxDataIN-&gt;start = &amp;URx_Buff[UCB.URxCounter];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// å‰©ä½™ç©ºé—´ä¸è¶³ï¼Œå›åˆ°ç¼“å†²åŒºå¼€å¤´</span></span><br><span class="line">			UCB.URxDataIN-&gt;start = URx_Buff;</span><br><span class="line">			UCB.URxCounter = <span class="number">0</span>;                     <span class="comment">// é‡ç½®æ¥æ”¶è®¡æ•°å™¨</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// é‡æ–°é…ç½®DMAä¸ºä¸‹ä¸€æ¬¡æ¥æ”¶</span></span><br><span class="line">		DMA_Cmd(DMA1_Channel5, DISABLE);                           <span class="comment">// ç¦ç”¨DMA</span></span><br><span class="line">		DMA_SetCurrDataCounter(DMA1_Channel5, URx_MAX + <span class="number">1</span>);        <span class="comment">// è®¾ç½®ä¼ è¾“è®¡æ•°</span></span><br><span class="line">		DMA1_Channel5-&gt;CMAR = (<span class="type">uint32_t</span>)UCB.URxDataIN-&gt;start;      <span class="comment">// è®¾ç½®å†…å­˜åœ°å€</span></span><br><span class="line">		DMA_Cmd(DMA1_Channel5, ENABLE);                            <span class="comment">// é‡æ–°å¯ç”¨DMA</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç¼–å†™æ–°çš„printfå‡½æ•°"><a class="markdownIt-Anchor" href="#ç¼–å†™æ–°çš„printfå‡½æ•°"></a> ç¼–å†™æ–°çš„Printfå‡½æ•°</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¼å¼åŒ–æ‰“å°å‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">uprintf</span><span class="params">(<span class="type">char</span> *format, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    va_list list_data;</span><br><span class="line">    va_start(list_data, format);</span><br><span class="line"></span><br><span class="line">    vsnprintf((<span class="type">char</span> *)UTx_Buff, <span class="keyword">sizeof</span>(UTx_Buff), format, list_data);</span><br><span class="line">    va_end(list_data);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint16_t</span> len = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)UTx_Buff);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (USART_GetFlagStatus(USART1, USART_FLAG_TXE) != <span class="number">1</span>);</span><br><span class="line">        USART_SendData(USART1, UTx_Buff[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (USART_GetFlagStatus(USART1, USART_FLAG_TC) != <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="i2c"><a class="markdownIt-Anchor" href="#i2c"></a> I2C</h3>
<p><strong>è½¯ä»¶I2C</strong>ï¼Œå»¶æ—¶éƒ¨åˆ†éœ€è¦è‡ªå·±é‡æ–°è®¾è®¡</p>
<h4 id="hç¨‹åº-2"><a class="markdownIt-Anchor" href="#hç¨‹åº-2"></a> .hç¨‹åº</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SCL_H GPIO_SetBits(GPIOB, GPIO_Pin_3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCL_L GPIO_ResetBits(GPIOB, GPIO_Pin_3)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDA_H GPIO_SetBits(GPIOB, GPIO_Pin_4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDA_L GPIO_ResetBits(GPIOB, GPIO_Pin_4)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Read_SDA GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_4)</span></span><br></pre></td></tr></table></figure>
<h4 id="delay"><a class="markdownIt-Anchor" href="#delay"></a> Delay</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å»¶æ—¶åŠŸèƒ½åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾®ç§’çº§å»¶æ—¶</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(<span class="type">uint16_t</span> us)</span></span><br><span class="line">&#123;</span><br><span class="line">	SysTick_Config(SystemCoreClock / <span class="number">1000000</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(us--)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(!((SysTick-&gt;CTRL) &amp; (SysTick_CTRL_COUNTFLAG)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	SysTick-&gt;CTRL &amp;= ~SysTick_CTRL_ENABLE_Msk;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯«ç§’çº§å»¶æ—¶</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(<span class="type">uint16_t</span> ms)</span></span><br><span class="line">&#123;</span><br><span class="line">	SysTick_Config(SystemCoreClock / <span class="number">1000</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(ms--)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(!((SysTick-&gt;CTRL) &amp; (SysTick_CTRL_COUNTFLAG)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	SysTick-&gt;CTRL &amp;= ~SysTick_CTRL_ENABLE_Msk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åˆå§‹åŒ–-startå’Œstopä¿¡å·"><a class="markdownIt-Anchor" href="#åˆå§‹åŒ–-startå’Œstopä¿¡å·"></a> åˆå§‹åŒ–ã€STARTå’ŒSTOPä¿¡å·</h4>
<ol>
<li>
<p>ç¡¬ä»¶I2Cï¼Œå¼€å¯<strong>æ—¶é’Ÿ</strong></p>
</li>
<li>
<p>é…ç½®<strong>GPIO</strong>ï¼ˆPB6ï¼ŒPB7ï¼Œå¼€æ¼æ¨¡å¼ï¼‰</p>
</li>
<li>
<p>é…ç½®<strong>SCLå’ŒSDA</strong>ä¸¤æ¡çº¿</p>
</li>
</ol>
<p><strong>èµ·å§‹ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»é«˜ç”µå¹³å˜ä¸ºä½ç”µå¹³</p>
<p><strong>åœæ­¢ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»ä½ç”µå¹³å˜ä¸ºé«˜ç”µå¹³</p>
<p><strong>æ•°æ®ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä¿æŒä¸å˜ï¼›<strong>SCLä½ç”µå¹³ï¼ŒSDAç”µå¹³å¯ä»¥ä¿®æ”¹</strong></p>
<p><strong>åº”ç­”ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDA<strong>ä½ç”µå¹³</strong>ï¼Œ<strong>åº”ç­”</strong>ï¼Œå¦åˆ™ï¼Œéåº”ç­”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">I2C1_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ä½¿èƒ½GPIOBæ—¶é’Ÿ</span></span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);</span><br><span class="line">	</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// é…ç½®SCLå¼•è„šï¼ˆPB3ï¼‰ä¸ºå¼€æ¼è¾“å‡º</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD;   <span class="comment">// å¼€æ¼è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_3;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// é…ç½®SDAå¼•è„šï¼ˆPB4ï¼‰ä¸ºå¼€æ¼è¾“å‡º</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD;   <span class="comment">// å¼€æ¼è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// è®¾ç½®æ€»çº¿åˆå§‹çŠ¶æ€ä¸ºé«˜ç”µå¹³ï¼ˆç©ºé—²çŠ¶æ€ï¼‰</span></span><br><span class="line">	SCL_H;</span><br><span class="line">	SDA_H;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Startä¿¡å· */</span></span><br><span class="line"><span class="comment">// ä¸€æ—¦ Start äº§ç”Ÿåï¼Œæ•°æ®ä¼ è¾“å¿…é¡»åœ¨ SCL ä¸ºä½æ—¶å¼€å§‹ã€‚</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	SCL_H;                              <span class="comment">// ç¡®ä¿SCLä¸ºé«˜ç”µå¹³</span></span><br><span class="line">	SDA_H;                              <span class="comment">// ç¡®ä¿SDAä¸ºé«˜ç”µå¹³</span></span><br><span class="line">	delay_us(<span class="number">2</span>);                        <span class="comment">// å»¶æ—¶ç­‰å¾…ä¿¡å·ç¨³å®š</span></span><br><span class="line">	SDA_L;                              <span class="comment">// SDAå˜ä¸ºä½ç”µå¹³ï¼ˆèµ·å§‹æ¡ä»¶ï¼‰</span></span><br><span class="line">	SCL_L;                              <span class="comment">// SCLå˜ä¸ºä½ç”µå¹³ï¼Œå‡†å¤‡å‘é€æ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Endä¿¡å· */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Stop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	SCL_L;                              <span class="comment">// ç¡®ä¿SCLä¸ºä½ç”µå¹³</span></span><br><span class="line">	SDA_L;                              <span class="comment">// ç¡®ä¿SDAä¸ºä½ç”µå¹³</span></span><br><span class="line">	delay_us(<span class="number">2</span>);                        <span class="comment">// å»¶æ—¶ç­‰å¾…ä¿¡å·ç¨³å®š</span></span><br><span class="line">	SCL_H;                              <span class="comment">// SCLå˜ä¸ºé«˜ç”µå¹³</span></span><br><span class="line">	SDA_H;                              <span class="comment">// SDAå˜ä¸ºé«˜ç”µå¹³ï¼ˆåœæ­¢æ¡ä»¶ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å‘é€ä¸€ä¸ªå­—èŠ‚"><a class="markdownIt-Anchor" href="#å‘é€ä¸€ä¸ªå­—èŠ‚"></a> å‘é€ä¸€ä¸ªå­—èŠ‚</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendByte</span><span class="params">(<span class="type">uint8_t</span> tx)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ä»æœ€é«˜ä½å¼€å§‹å‘é€ï¼ˆMSB firstï¼‰</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int8_t</span> i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">	&#123;</span><br><span class="line">		SCL_L;                              <span class="comment">// SCLç½®ä½ï¼Œå‡†å¤‡è®¾ç½®æ•°æ®</span></span><br><span class="line">		<span class="keyword">if</span>(tx &amp; (<span class="number">1</span> &lt;&lt; i))                   <span class="comment">// æ£€æŸ¥å½“å‰ä½æ˜¯å¦ä¸º1</span></span><br><span class="line">		&#123;</span><br><span class="line">			SDA_H;                          <span class="comment">// å‘é€é€»è¾‘1</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			SDA_L;                          <span class="comment">// å‘é€é€»è¾‘0</span></span><br><span class="line">		&#125;</span><br><span class="line">		delay_us(<span class="number">2</span>);                        <span class="comment">// å»¶æ—¶ç­‰å¾…æ•°æ®ç¨³å®š</span></span><br><span class="line">		SCL_H;                              <span class="comment">// SCLç½®é«˜ï¼Œè®©ä»æœºè¯»å–æ•°æ®</span></span><br><span class="line">		delay_us(<span class="number">2</span>);                        <span class="comment">// å»¶æ—¶ä¿æŒæ—¶é’Ÿé«˜ç”µå¹³</span></span><br><span class="line">	&#125;</span><br><span class="line">	SCL_L;                                  <span class="comment">// å‘é€å®Œæˆï¼ŒSCLç½®ä½</span></span><br><span class="line">	SDA_H;                                  <span class="comment">// é‡Šæ”¾SDAçº¿ï¼Œå‡†å¤‡æ¥æ”¶ACK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯»å–ä¸€ä¸ªå­—èŠ‚"><a class="markdownIt-Anchor" href="#è¯»å–ä¸€ä¸ªå­—èŠ‚"></a> è¯»å–ä¸€ä¸ªå­—èŠ‚</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> <span class="title function_">I2C_ReadByte</span><span class="params">(<span class="type">uint8_t</span> ack)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> rx = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// ä»æœ€é«˜ä½å¼€å§‹æ¥æ”¶ï¼ˆMSB firstï¼‰</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int8_t</span> i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">	&#123;</span><br><span class="line">		SCL_L;                              <span class="comment">// SCLç½®ä½ï¼Œå‡†å¤‡è¯»å–æ•°æ®</span></span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">		SCL_H;                              <span class="comment">// SCLç½®é«˜ï¼Œè¯»å–æ•°æ®</span></span><br><span class="line">		<span class="keyword">if</span>(Read_SDA)                        <span class="comment">// è¯»å–SDAä¸Šçš„æ•°æ®</span></span><br><span class="line">		&#123;</span><br><span class="line">			rx |= (<span class="number">1</span> &lt;&lt; i);                 <span class="comment">// å¦‚æœSDAä¸ºé«˜ï¼Œè®¾ç½®å¯¹åº”ä½</span></span><br><span class="line">		&#125;</span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	SCL_L;                                  <span class="comment">// æ•°æ®æ¥æ”¶å®Œæˆï¼ŒSCLç½®ä½</span></span><br><span class="line">	<span class="comment">// å‘é€åº”ç­”æˆ–éåº”ç­”</span></span><br><span class="line">	<span class="keyword">if</span>(ack)</span><br><span class="line">	&#123;</span><br><span class="line">		SDA_L;                              <span class="comment">// å‘é€ACKï¼ˆåº”ç­”ï¼‰</span></span><br><span class="line">		SCL_H;</span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">		SCL_L;</span><br><span class="line">		SDA_H;                              <span class="comment">// é‡Šæ”¾SDAçº¿</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		SDA_H;</span><br><span class="line">		SCL_H;</span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">		SCL_L;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç­‰å¾…ä»æœºack"><a class="markdownIt-Anchor" href="#ç­‰å¾…ä»æœºack"></a> ç­‰å¾…ä»æœºACK</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> <span class="title function_">I2C_Wait_ACK</span><span class="params">(<span class="type">int16_t</span> timeout)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ç­‰å¾…SDAå˜ä¸ºä½ç”µå¹³ï¼ˆä»æœºåº”ç­”ï¼‰</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		timeout--;</span><br><span class="line">		delay_us(<span class="number">2</span>);</span><br><span class="line">	&#125;<span class="keyword">while</span>(Read_SDA &amp;&amp; timeout &gt;= <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(timeout &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;                           <span class="comment">// ç­‰å¾…è¶…æ—¶</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	SCL_H;                                  <span class="comment">// SCLç½®é«˜ï¼Œè¯»å–åº”ç­”ä¿¡å·</span></span><br><span class="line">	delay_us(<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span>(Read_SDA != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;                           <span class="comment">// åº”ç­”ä¿¡å·æ— æ•ˆ</span></span><br><span class="line">	&#125;</span><br><span class="line">	SCL_L;                                  <span class="comment">// SCLç½®ä½ï¼Œåº”ç­”è¯»å–å®Œæˆ</span></span><br><span class="line">	delay_us(<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;                               <span class="comment">// æˆåŠŸæ¥æ”¶åº”ç­”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="at24c02"><a class="markdownIt-Anchor" href="#at24c02"></a> AT24C02</h3>
<p><strong>I2Cé€šä¿¡</strong>ï¼Œè®¾å¤‡åœ°å€ï¼š1 0 1 0  E2 E1 E0 R/éWï¼›</p>
<p>è¯»R=1ï¼Œ0XA1ï¼›</p>
<p>å†™W=0ï¼Œ0XA0ï¼›</p>
<p><strong>æŒ‰å­—èŠ‚å†™å…¥</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> AT24C02_WADDR 0xA0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AT24C02_RADDR 0xA1</span></span><br></pre></td></tr></table></figure>
<p>AT24C02å…±<strong>32é¡µ</strong>ï¼Œ<strong>ä¸€é¡µ8å­—èŠ‚</strong>ï¼Œå…±256å­—èŠ‚ï¼›<strong>å­˜åœ¨å›å·é—®é¢˜</strong></p>
<h4 id="å†™å…¥"><a class="markdownIt-Anchor" href="#å†™å…¥"></a> å†™å…¥</h4>
<img src="https://s2.loli.net/2025/05/09/4LQS8qFYM3cmdbp.png" style="zoom:80%;" />
<h5 id="byte-write"><a class="markdownIt-Anchor" href="#byte-write"></a> Byte Write</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addr:å†™å…¥çš„EEPROMå†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment">// wdata:å†™å…¥çš„æ•°æ®</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_WriteByte</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> wdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)  			<span class="comment">// 100ä¸ºç­‰å¾…åº”ç­”çš„ä¿¡å·</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;                			<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line">    </span><br><span class="line">    I2C_SendByte(addr);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥åœ°å€å¤±è´¥</span></span><br><span class="line">    </span><br><span class="line">    I2C_SendByte(wdata);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥æ•°æ®å¤±è´¥</span></span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="page-write"><a class="markdownIt-Anchor" href="#page-write"></a> Page Write</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addrï¼šå†™å…¥åœ°å€</span></span><br><span class="line"><span class="comment">// wdataï¼šå†™å…¥æ•°æ®</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_WritePage</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> *wdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; 							<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line"></span><br><span class="line">    I2C_SendByte(addr);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥åœ°å€å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        I2C_SendByte(wdata[i]);</span><br><span class="line">        <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span> + i; 					<span class="comment">// å†™å…¥æ•°æ®å¤±è´¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯»å–"><a class="markdownIt-Anchor" href="#è¯»å–"></a> è¯»å–</h4>
<img src="https://s2.loli.net/2025/05/09/74nb8woeaplzTcr.png" style="zoom:67%;" />
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addrï¼šè¯»å–çš„èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="comment">// rdataï¼šæŒ‡å‘å­˜å‚¨è¯»å–æ•°æ®çš„ç¼“å†²åŒºçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// datalen:è¯»å–æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_ReadData</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> *rdata, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; 							<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line"></span><br><span class="line">    I2C_SendByte(addr); 					<span class="comment">// å†™å…¥è¯»å–åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥è¯»å–åœ°å€å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_RADDR); 			<span class="comment">// å‘é€è¯»å–ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>; 							<span class="comment">// åˆ‡æ¢è¯»æ¨¡å¼æ—¶èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; datalen - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rdata[i] = I2C_ReadByte(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    rdata[datalen - <span class="number">1</span>] = I2C_ReadByte(<span class="number">0</span>); 	<span class="comment">// è¯»å–æœ€åä¸€ä¸ªå­—èŠ‚æ—¶ä¸å‘é€ACKä¿¡å·</span></span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="spi"><a class="markdownIt-Anchor" href="#spi"></a> SPI</h3>
<p>å¤–éƒ¨FLASHå‹å·ä¸ºW25Q64ï¼Œä½¿ç”¨<strong>ç¡¬ä»¶SPI</strong></p>
<img src="https://s2.loli.net/2025/05/09/WoTtsqaOecy1FAw.png" style="zoom:50%;" />
<ol>
<li>
<p>é…ç½®<strong>SPI0æ—¶é’Ÿ</strong>ï¼Œç›¸å…³<strong>GPIOå¼€å¯</strong></p>
</li>
<li>
<p><strong>å¤ä½SPIå¤–è®¾</strong></p>
</li>
<li>
<p>é…ç½®<strong>SPIç»“æ„ä½“æˆå‘˜ï¼ˆä¸»ä»æ¨¡å¼ï¼Œå‘é€ç±»å‹ï¼ˆå…¨åŒå·¥ï¼‰ï¼Œä¸€å¸§å¤§å°ï¼Œç¡¬ä»¶/è½¯ä»¶ï¼Œå¤§ç«¯/å°ç«¯ï¼ˆå¤§ç«¯ï¼‰ï¼Œå·¥ä½œæ–¹å¼ï¼ˆææ€§ï¼ˆä¸Šä¸‹ï¼‰/ç›¸ä½ï¼ˆä¸€äºŒï¼‰ï¼Œä»æœºå†³å®šï¼‰ï¼Œä¼ è¾“é€Ÿåº¦ï¼‰</strong></p>
</li>
<li>
<p><strong>åˆå§‹åŒ–SPI</strong></p>
</li>
<li>
<p><strong>ä½¿èƒ½SPI</strong></p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–SPI1</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SPI1_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ä½¿èƒ½GPIOAå’ŒSPI1æ—¶é’Ÿ</span></span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_SPI1, ENABLE);</span><br><span class="line"></span><br><span class="line">    GPIO_InitTypeDef GPIO_StructInit;</span><br><span class="line">    GPIO_StructInit.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_7;	<span class="comment">// é…ç½®SCKå’ŒMOSIå¼•è„š(PA5,PA7)</span></span><br><span class="line">    GPIO_StructInit.GPIO_Mode = GPIO_Mode_AF_PP; 		<span class="comment">// å¤ç”¨æ¨æŒ½è¾“å‡º</span></span><br><span class="line">    GPIO_StructInit.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_StructInit);</span><br><span class="line"></span><br><span class="line">    GPIO_StructInit.GPIO_Pin = GPIO_Pin_6;				<span class="comment">// é…ç½®MISOå¼•è„š(PA6)</span></span><br><span class="line">    GPIO_StructInit.GPIO_Mode = GPIO_Mode_IN_FLOATING;	<span class="comment">// æµ®ç©ºè¾“å…¥</span></span><br><span class="line">    GPIO_StructInit.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_StructInit);</span><br><span class="line">    </span><br><span class="line">    SPI_I2S_DeInit(SPI1);					<span class="comment">// å¤ä½SPI1å¤–è®¾</span></span><br><span class="line">    </span><br><span class="line">    SPI_InitTypeDef SPI_InitStructure;		<span class="comment">// é…ç½®SPIå‚æ•°</span></span><br><span class="line">    <span class="comment">/* SPIåˆå§‹åŒ–ç»“æ„ä½“é…ç½® */</span></span><br><span class="line">    <span class="comment">// SPIå·¥ä½œæ¨¡å¼ï¼šä¸»æ¨¡å¼ï¼ˆæ§åˆ¶æ—¶é’Ÿä¿¡å·ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_Mode = SPI_Mode_Master;</span><br><span class="line">    <span class="comment">// SPIé€šä¿¡æ–¹å‘ï¼šåŒçº¿å…¨åŒå·¥ï¼ˆåŒæ—¶å‘é€å’Œæ¥æ”¶ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;</span><br><span class="line">    <span class="comment">// æ•°æ®å¸§æ ¼å¼ï¼š8ä½æ•°æ®</span></span><br><span class="line">    SPI_InitStructure.SPI_DataSize = SPI_DataSize_8b;</span><br><span class="line">    <span class="comment">// æ—¶é’Ÿææ€§ï¼šé«˜ç”µå¹³ç©ºé—²ï¼ˆCPOL=1ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_CPOL = SPI_CPOL_High;</span><br><span class="line">    <span class="comment">// æ—¶é’Ÿç›¸ä½ï¼šç¬¬äºŒä¸ªè¾¹æ²¿é‡‡æ ·ï¼ˆCPHA=1ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_CPHA = SPI_CPHA_2Edge;</span><br><span class="line">    <span class="comment">// ç‰‡é€‰æ§åˆ¶ï¼šè½¯ä»¶NSSç®¡ç†ï¼ˆæ‰‹åŠ¨æ§åˆ¶ç‰‡é€‰ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_NSS = SPI_NSS_Soft;</span><br><span class="line">    <span class="comment">// æ³¢ç‰¹ç‡é¢„åˆ†é¢‘ï¼šç³»ç»Ÿæ—¶é’Ÿ2åˆ†é¢‘ï¼ˆfPCLK/2ï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_2;</span><br><span class="line">    <span class="comment">// æ•°æ®ä¼ è¾“é¡ºåºï¼šé«˜ä½å…ˆå‘é€ï¼ˆMSB firstï¼‰</span></span><br><span class="line">    SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;</span><br><span class="line">    <span class="comment">// CRCå¤šé¡¹å¼ï¼š7,å¤§éƒ¨åˆ†SPIè®¾å¤‡ç”¨ä¸åˆ°ï¼Œéšä¾¿ç»™ä¸ªå€¼</span></span><br><span class="line">    SPI_InitStructure.SPI_CRCPolynomial = <span class="number">7</span>;</span><br><span class="line">    SPI_Init(SPI1, &amp;SPI_InitStructure);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿èƒ½SPI1</span></span><br><span class="line">    SPI_Cmd(SPI1, ENABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="https://s2.loli.net/2025/05/09/TlW7HSEm5eXfPBD.png" style="zoom: 50%;" />
<h4 id="æ•°æ®æ”¶å‘"><a class="markdownIt-Anchor" href="#æ•°æ®æ”¶å‘"></a> æ•°æ®æ”¶å‘</h4>
<p><strong>SPI_I2S_FLAG_TXE</strong>è¡¨ç¤º<strong>å‘é€åŒºç©ºäº†</strong>ï¼Œ<strong>SPI_SPI_FLAG_RXNE</strong>è¡¨ç¤º<strong>æ¥æ”¶åŒºä¸ä¸ºç©º</strong>ã€‚åˆ‡è®°<strong>å…¨åŒå·¥ï¼Œæœ‰å‘å°±æœ‰æ”¶ï¼</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPIå•å­—èŠ‚è¯»å†™ï¼Œtxæ˜¯è¦å‘é€çš„æ•°æ®å­—èŠ‚</span></span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">SPI1_ReadWrite_Byte</span><span class="params">(<span class="type">uint16_t</span> tx)</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">while</span> (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_TXE) != <span class="number">1</span>);	<span class="comment">// ç­‰å¾…å‘é€ç¼“å†²åŒºç©º</span></span><br><span class="line">    SPI_I2S_SendData(SPI1, tx);									<span class="comment">// å‘é€æ•°æ®</span></span><br><span class="line">    <span class="keyword">while</span> (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_RXNE) != <span class="number">1</span>);<span class="comment">// ç­‰å¾…æ¥æ”¶ç¼“å†²åŒºéç©º</span></span><br><span class="line">    <span class="keyword">return</span> SPI_I2S_ReceiveData(SPI1);							<span class="comment">// è¿”å›æ¥æ”¶åˆ°çš„æ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¤šå­—èŠ‚å†™å…¥SPIï¼Œwdataè¦å‘é€çš„æ•°æ®ç¼“å†²åŒºæŒ‡é’ˆï¼Œdatalenè¦å‘é€çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SPI1_Write</span><span class="params">(<span class="type">uint8_t</span> *wdata, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; datalen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        SPI1_ReadWrite_Byte(wdata[i]); 			<span class="comment">// åªå‘é€æ•°æ®ï¼Œå¿½ç•¥æ¥æ”¶å†…å®¹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¤šå­—èŠ‚è¯»å–SPIï¼Œrdataæ¥æ”¶æ•°æ®ç¼“å†²åŒºæŒ‡é’ˆï¼Œdatalenè¦è¯»å–çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SPI1_Read</span><span class="params">(<span class="type">uint8_t</span> *rdata, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; datalen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rdata[i] = SPI1_ReadWrite_Byte(<span class="number">0xff</span>); <span class="comment">// å‘é€dummyæ•°æ®(0xFF)æ¥è¯»å–ï¼Œæƒ³æƒ³Flashæ¸…é›¶</span></span><br><span class="line">    &#125;							</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="w25q64"><a class="markdownIt-Anchor" href="#w25q64"></a> W25Q64</h3>
<h4 id="çŠ¶æ€å¯„å­˜å™¨"><a class="markdownIt-Anchor" href="#çŠ¶æ€å¯„å­˜å™¨"></a> <strong>çŠ¶æ€å¯„å­˜å™¨</strong></h4>
<p>ä¸»è¦çœ‹<strong>S0 â€” BUSY</strong></p>
<img src="https://s2.loli.net/2025/05/09/KWenVOwYPLpoXaz.png" style="zoom:67%;" />
<h4 id="æŒ‡ä»¤è¡¨"><a class="markdownIt-Anchor" href="#æŒ‡ä»¤è¡¨"></a> <strong>æŒ‡ä»¤è¡¨</strong></h4>
<img src="https://s2.loli.net/2025/05/09/piZ37vGDV6htqL8.png" style="zoom: 80%;" />
<h4 id="ç›¸å…³ç¨‹åº"><a class="markdownIt-Anchor" href="#ç›¸å…³ç¨‹åº"></a> <strong>ç›¸å…³ç¨‹åº</strong></h4>
<p>SPI+Flashéœ€ç­‰å¾…<strong>BusyçŠ¶æ€</strong>ï¼Œå…ˆè¯»å–çŠ¶æ€å¯„å­˜å™¨åœ°å€ï¼Œåéšä¾¿å†™å…¥å…¶å®ƒï¼ˆæ­¤æ—¶å†™å…¥ä»€ä¹ˆéƒ½ä¸é‡è¦ï¼Œä¸»è¦è·å–å¯„å­˜å™¨ä¸­çš„æ•°å€¼ï¼‰ï¼Œ<strong>æ‰“å¼€ç‰‡é€‰ï¼Œä½¿èƒ½Writeå†å…³é—­</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CS_ENABLE GPIO_ResetBits(GPIOA, GPIO_Pin_4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CS_DISABLE GPIO_SetBits(GPIOA, GPIO_Pin_4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// W25Q64åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);</span><br><span class="line">    GPIO_InitTypeDef GPIO_StructInit;</span><br><span class="line">    GPIO_StructInit.GPIO_Pin = GPIO_Pin_4;         	<span class="comment">// CSç‰‡é€‰å¼•è„šï¼ˆä½ç”µå¹³æœ‰æ•ˆï¼‰</span></span><br><span class="line">    GPIO_StructInit.GPIO_Mode = GPIO_Mode_Out_PP;  	<span class="comment">// æ¨æŒ½è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">    GPIO_StructInit.GPIO_Speed = GPIO_Speed_50MHz; 	<span class="comment">// 50MHzé€Ÿåº¦</span></span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_StructInit);</span><br><span class="line">    CS_DISABLE;  									<span class="comment">// é»˜è®¤ç¦ç”¨ç‰‡é€‰</span></span><br><span class="line">    SPI1_Init(); 									<span class="comment">// åˆå§‹åŒ–SPI1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç­‰å¾…èŠ¯ç‰‡ç©ºé—²</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_WaitBusy</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> res;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        CS_ENABLE;                       			<span class="comment">// ä½¿èƒ½ç‰‡é€‰</span></span><br><span class="line">        SPI1_ReadWrite_Byte(<span class="number">0x05</span>);       			<span class="comment">// å‘é€è¯»å–çŠ¶æ€å¯„å­˜å™¨å‘½ä»¤</span></span><br><span class="line">        res = SPI1_ReadWrite_Byte(<span class="number">0xff</span>); 			<span class="comment">// è¯»å–çŠ¶æ€å¯„å­˜å™¨å€¼</span></span><br><span class="line">        CS_DISABLE;                      			<span class="comment">// ç¦ç”¨ç‰‡é€‰</span></span><br><span class="line">    &#125; <span class="keyword">while</span> ((res &amp; <span class="number">0x01</span>) == <span class="number">0x01</span>); 				<span class="comment">// æ£€æŸ¥BUSYä½ï¼ˆbit0ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿èƒ½å†™æ“ä½œ</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_Enable</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    W25Q64_WaitBusy(); 								<span class="comment">// ç­‰å¾…ç©ºé—²</span></span><br><span class="line">    CS_ENABLE;</span><br><span class="line">    SPI1_ReadWrite_Byte(<span class="number">0x06</span>); 						<span class="comment">// å‘é€å†™ä½¿èƒ½æŒ‡ä»¤</span></span><br><span class="line">    CS_DISABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ“¦é™¤64kb"><a class="markdownIt-Anchor" href="#æ“¦é™¤64kb"></a> æ“¦é™¤64KB</h4>
<p>W25Q64æ€»å…±<strong>8MB</strong> = 8 * 1024KBï¼Œ<strong>ä¸€æ¬¡æ“¦é™¤64KB</strong>ï¼Œå¯å¾—å…±è®¡8 * 1024 / 64 = <strong>128ä¸ªBlock</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ“¦é™¤64KBçš„å—ï¼Œblock: è¦æ“¦é™¤çš„å—ç¼–å·</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_Erase_64k</span><span class="params">(<span class="type">uint8_t</span> block)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> wdata[<span class="number">4</span>];</span><br><span class="line">    wdata[<span class="number">0</span>] = <span class="number">0xD8</span>;                      		<span class="comment">// å—æ“¦é™¤æŒ‡ä»¤</span></span><br><span class="line">    wdata[<span class="number">1</span>] = (block * <span class="number">64</span> * <span class="number">1024</span>) &gt;&gt; <span class="number">16</span>; 		<span class="comment">// è®¡ç®—å—èµ·å§‹åœ°å€ï¼ˆé«˜å­—èŠ‚ï¼‰</span></span><br><span class="line">    wdata[<span class="number">2</span>] = (block * <span class="number">64</span> * <span class="number">1024</span>) &gt;&gt; <span class="number">8</span>;  		<span class="comment">// ä¸­å­—èŠ‚</span></span><br><span class="line">    wdata[<span class="number">3</span>] = (block * <span class="number">64</span> * <span class="number">1024</span>) &gt;&gt; <span class="number">0</span>;  		<span class="comment">// ä½å­—èŠ‚</span></span><br><span class="line">    W25Q64_WaitBusy();							<span class="comment">// ç­‰å¾…BUSY</span></span><br><span class="line">    W25Q64_Enable(); 							<span class="comment">// ä½¿èƒ½å†™æ“ä½œ</span></span><br><span class="line">    CS_ENABLE;</span><br><span class="line">    SPI1_Write(wdata, <span class="number">4</span>); 						<span class="comment">// å‘é€æ“¦é™¤æŒ‡ä»¤å’Œåœ°å€</span></span><br><span class="line">    CS_DISABLE;</span><br><span class="line">    W25Q64_WaitBusy(); 							<span class="comment">// ç­‰å¾…æ“¦é™¤å®Œæˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é¡µå†™å…¥256byte"><a class="markdownIt-Anchor" href="#é¡µå†™å…¥256byte"></a> é¡µå†™å…¥256Byte</h4>
<p><strong>é¡µåœ°å€ = page * 256 Byteï¼Œæ¯æ¬¡ä»é¡µåœ°å€å¼€å§‹å†™å…¥256 Byteï¼Œé¡µåœ°å€æ€»é•¿24ä½</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‰é¡µå†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">// wbuff: å¾…å†™å…¥æ•°æ®çš„ç¼“å†²åŒºæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// page: ç›®æ ‡é¡µå·</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_PageWrite</span><span class="params">(<span class="type">uint8_t</span> *wbuff, <span class="type">uint16_t</span> page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> wdata[<span class="number">4</span>];</span><br><span class="line">    wdata[<span class="number">0</span>] = <span class="number">0x02</span>;               				<span class="comment">// é¡µå†™æŒ‡ä»¤</span></span><br><span class="line">    wdata[<span class="number">1</span>] = (page * <span class="number">256</span>) &gt;&gt; <span class="number">16</span>; 				<span class="comment">// è®¡ç®—é¡µèµ·å§‹åœ°å€ï¼ˆé«˜å­—èŠ‚ï¼‰</span></span><br><span class="line">    wdata[<span class="number">2</span>] = (page * <span class="number">256</span>) &gt;&gt; <span class="number">8</span>;  				<span class="comment">// ä¸­å­—èŠ‚</span></span><br><span class="line">    wdata[<span class="number">3</span>] = (page * <span class="number">256</span>) &gt;&gt; <span class="number">0</span>;  				<span class="comment">// ä½å­—èŠ‚</span></span><br><span class="line">    W25Q64_WaitBusy();</span><br><span class="line">    W25Q64_Enable(); 							<span class="comment">// ä½¿èƒ½å†™æ“ä½œ</span></span><br><span class="line">    CS_ENABLE;</span><br><span class="line">    SPI1_Write(wdata, <span class="number">4</span>);   					<span class="comment">// å‘é€å†™æŒ‡ä»¤å’Œåœ°å€</span></span><br><span class="line">    SPI1_Write(wbuff, <span class="number">256</span>); 					<span class="comment">// å†™å…¥256å­—èŠ‚æ•°æ®</span></span><br><span class="line">    CS_DISABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯»å–æ•°æ®"><a class="markdownIt-Anchor" href="#è¯»å–æ•°æ®"></a> è¯»å–æ•°æ®</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">// rbuff: æ•°æ®è¯»å–ç¼“å†²åŒºæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// addr: èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="comment">// datalen: è¦è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">W25Q64_Read</span><span class="params">(<span class="type">uint8_t</span> *rbuff, <span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> datalen)</span> <span class="comment">// åœ°å€åªç”¨24ä½</span></span><br><span class="line">&#123;</span><br><span class="line">    W25Q64_WaitBusy();</span><br><span class="line">    CS_ENABLE;</span><br><span class="line">    SPI1_ReadWrite_Byte(<span class="number">0x03</span>);</span><br><span class="line">    SPI1_ReadWrite_Byte((<span class="type">uint16_t</span>)(addr &gt;&gt; <span class="number">16</span>));</span><br><span class="line">    SPI1_ReadWrite_Byte((<span class="type">uint16_t</span>)(addr &gt;&gt; <span class="number">8</span>));</span><br><span class="line">    SPI1_ReadWrite_Byte((<span class="type">uint16_t</span>)(addr &gt;&gt; <span class="number">0</span>));</span><br><span class="line">    SPI1_Read(rbuff, datalen);</span><br><span class="line">    CS_DISABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="stm32çš„flash"><a class="markdownIt-Anchor" href="#stm32çš„flash"></a> STM32çš„FLASH</h3>
<p>Flash<strong>æ“¦é™¤åä¸º0xFF</strong></p>
<h4 id="æ“¦é™¤flash"><a class="markdownIt-Anchor" href="#æ“¦é™¤flash"></a> æ“¦é™¤Flash</h4>
<p>Flash<strong>ä¸€é¡µ1KB</strong>ï¼Œä¸‹é¢å‡½æ•°å®ç°<strong>ä¸€æ¬¡æ“¦é™¤numé¡µ</strong>æ•°æ®</p>
<p><strong>æµç¨‹</strong>ï¼š</p>
<ol>
<li>
<p>Flashå¼€é”</p>
</li>
<li>
<p><strong>ç¡®è®¤åœ°å€ï¼Œæ“¦é™¤åœ°å€æ•°æ®</strong></p>
</li>
<li>
<p>Flashé”å®š</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// start	èµ·å§‹é¡µå·</span></span><br><span class="line"><span class="comment">// num		éœ€è¦æ“¦é™¤çš„é¡µæ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FLASH_Erase</span><span class="params">(<span class="type">uint16_t</span> start, <span class="type">uint16_t</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint16_t</span> i;</span><br><span class="line">    FLASH_Unlock(); 					<span class="comment">// è§£é”FLASHæ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—ç›®æ ‡é¡µåœ°å€ï¼šFLASHèµ·å§‹åœ°å€ + èµ·å§‹é¡µå· * é¡µå¤§å° + å½“å‰é¡µåç§»</span></span><br><span class="line">        FLASH_ErasePage((FLASH_SADDR + start * <span class="number">1024</span>) + (<span class="number">1024</span> * i));</span><br><span class="line">    &#125;</span><br><span class="line">    FLASH_Lock(); 						<span class="comment">// é”å®šFLASH</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å†™å…¥flash"><a class="markdownIt-Anchor" href="#å†™å…¥flash"></a> å†™å…¥Flash</h4>
<p>ä¸€æ¬¡å†™å…¥<strong>numä¸ª4å­—èŠ‚æ•°æ®</strong>ï¼Œåœ°å€è‡ªåŠ¨é€’å¢</p>
<p><strong>æµç¨‹</strong>ï¼š</p>
<ol>
<li>
<p>Flashå¼€é”</p>
</li>
<li>
<p><strong>å°†æ•°æ®å†™å…¥å¯¹åº”åœ°å€</strong></p>
</li>
<li>
<p>Flashé”å®š</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	saddr	ç›®æ ‡èµ·å§‹åœ°å€ï¼ˆå¿…é¡»ä¸º4çš„å€æ•°ï¼‰</span></span><br><span class="line"><span class="comment">//	wdata	å¾…å†™å…¥æ•°æ®çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">//	wnum	éœ€è¦å†™å…¥çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FLASH_Write</span><span class="params">(<span class="type">uint32_t</span> saddr, <span class="type">uint32_t</span> *wdata, <span class="type">uint32_t</span> wnum)</span></span><br><span class="line">&#123;</span><br><span class="line">    FLASH_Unlock(); 						<span class="comment">// è§£é”FLASHæ“ä½œ</span></span><br><span class="line">    <span class="keyword">while</span> (wnum)</span><br><span class="line">    &#123;</span><br><span class="line">        FLASH_ProgramWord(saddr, *wdata); 	<span class="comment">// æŒ‰uint32_tå†™å…¥æ•°æ®</span></span><br><span class="line">        wnum -= <span class="number">4</span>;                        	<span class="comment">// å‰©ä½™å­—èŠ‚æ•°å‡4</span></span><br><span class="line">        saddr += <span class="number">4</span>;                       	<span class="comment">// åœ°å€æŒ‡é’ˆé€’å¢4å­—èŠ‚</span></span><br><span class="line">        wdata++;                          	<span class="comment">// æ•°æ®æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ª32ä½æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line">    FLASH_Lock(); 							<span class="comment">// é”å®šFLASH</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bootloaderåŠŸèƒ½å®ç°"><a class="markdownIt-Anchor" href="#bootloaderåŠŸèƒ½å®ç°"></a> BootloaderåŠŸèƒ½å®ç°</h2>
<img src="https://s2.loli.net/2025/05/10/NkZvJ52acX16gfT.png" style="zoom:50%;" />
<h3 id="abåˆ†åŒºè§„åˆ’"><a class="markdownIt-Anchor" href="#abåˆ†åŒºè§„åˆ’"></a> ABåˆ†åŒºè§„åˆ’</h3>
<p><strong>1ä¸ªæ‰‡é¡µ1KB</strong>ï¼ŒAåŒºèµ·å§‹ä½ç½®ï¼š0x 0800 5000ï¼Œ å•ç‰‡æœºRAMä½ç½®ï¼š0x20000000 ~ 0x20004FFF</p>
<table>
<thead>
<tr>
<th style="text-align:center">STM32F103C8T6</th>
<th style="text-align:center">64KB</th>
<th style="text-align:center">æ‰‡é¡µ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">BåŒº</td>
<td style="text-align:center">20KB</td>
<td style="text-align:center">0 ~ 19</td>
</tr>
<tr>
<td style="text-align:center">AåŒº</td>
<td style="text-align:center">44KB</td>
<td style="text-align:center">20 ~ 63</td>
</tr>
</tbody>
</table>
<h3 id="æ³¨æ„ç‚¹"><a class="markdownIt-Anchor" href="#æ³¨æ„ç‚¹"></a> æ³¨æ„ç‚¹</h3>
<table>
<thead>
<tr>
<th style="text-align:center">é—®é¢˜</th>
<th style="text-align:center">è§£ç­”</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>è°å°†OTA_Flagæ‰“å‹¾ï¼Ÿ</strong></td>
<td style="text-align:center">AåŒºè´Ÿè´£æ§åˆ¶ï¼Œæ ‡å¿—ä½å­˜æ”¾åœ¨AT24C02</td>
</tr>
<tr>
<td style="text-align:center"><strong>ä»€ä¹ˆæ—¶å€™OTA_flagæ‰“å‹¾</strong></td>
<td style="text-align:center">AåŒºä¸‹è½½å®Œæ¯•ä¹‹å</td>
</tr>
<tr>
<td style="text-align:center"><strong>OTAæ—¶ï¼Œæœ€æ–°ç‰ˆæœ¬çš„ç¨‹åºæ–‡ä»¶ä¸‹è½½åˆ°å“ªï¼Ÿ</strong></td>
<td style="text-align:center">åˆ†ç‰‡ä¸‹è½½ï¼Œå…±è®¡256ç‰‡å¡å…¥W25Q64ï¼ˆä¸€é¡µ256Byteï¼Œå…±256é¡µï¼‰</td>
</tr>
<tr>
<td style="text-align:center"><strong>OTAæ—¶ï¼Œæœ€æ–°ç‰ˆæœ¬çš„ç¨‹åºæ–‡ä»¶å¦‚ä½•ä¸‹è½½ï¼Ÿä¸‹è½½å¤šå°‘ï¼Ÿ</strong></td>
<td style="text-align:center">æœåŠ¡å™¨ä¸‹å‘ç¨‹åºå¤§å°ï¼Œåˆ†ç‰‡ä¸‹è½½åˆ°W25Q64</td>
</tr>
<tr>
<td style="text-align:center"><strong>ä¸‹è½½å¤šå°‘è¿™ä¸ªå˜é‡ç”¨ä¸ç”¨ä¿å­˜ï¼Ÿ</strong></td>
<td style="text-align:center">éœ€è¦ï¼Œä¿å­˜åˆ°AT24C02ä¹‹ä¸­</td>
</tr>
<tr>
<td style="text-align:center"><strong>å‘ç”ŸOTAäº‹ä»¶æ—¶ï¼ŒBåŒºå¦‚ä½•æ›´æ–°AåŒº</strong></td>
<td style="text-align:center">ä»W25Q64è¯»å–æ•°æ®ï¼Œå†™å…¥AåŒºFlash</td>
</tr>
</tbody>
</table>
<h3 id="otaå®å®šä¹‰"><a class="markdownIt-Anchor" href="#otaå®å®šä¹‰"></a> OTAå®å®šä¹‰</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_SADDR 0x08000000                                     <span class="comment">// FLASHèµ·å§‹åœ°å€</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_PAGE_SIZE 1024                                       <span class="comment">// Flashé¡µå¤§å°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_NUM 64                                               <span class="comment">// FLASHæ€»é¡µæ•°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_B_NUM 20                                             <span class="comment">// BåŒºé¡µæ•°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_A_NUM FLASH_NUM - FLASH_B_NUM                        <span class="comment">// AåŒºé¡µæ•°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_A_SPAGE FLASH_B_NUM                                  <span class="comment">// AåŒºèµ·å§‹é¡µæ•°</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_A_SADDR FLASH_SADDR + FLASH_A_SPAGE *FLASH_PAGE_SIZE <span class="comment">// AåŒºèµ·å§‹åœ°å€</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPDATA_A_FLAG 0x00000001     <span class="comment">// AåŒºæ›´æ–°æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IAP_XMODEM_FLAG 0x00000002   <span class="comment">// ä½¿ç”¨Xmodemåè®®çš„æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IAP_XMODEMD_FLAG 0x00000004  <span class="comment">// Xmodemåè®®ä¼ è¾“æ•°æ®çš„æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_VERSION_FLAG 0x00000008  <span class="comment">// è®¾ç½®ç‰ˆæœ¬å·çš„å‘½ä»¤æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_5_FLAG 0x000000010       <span class="comment">// å‘å¤–éƒ¨FLASHä¸‹è½½ç¨‹åºçš„å‘½ä»¤æ ‡å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD5_XMODEM_FLAG 0x000000020 <span class="comment">// æ ‡è®°ä½¿ç”¨å‘½ä»¤5åï¼ŒXmodemåè®®ä¼ è¾“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_6_FLAG 0x000000040       <span class="comment">// ä½¿ç”¨å¤–éƒ¨FLASHå†…ç¨‹åº</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OTA_SET_FLAG 0xAABBCCDD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³äºæ•°ç»„å¤§å°æ˜¯11çš„åŸå› ï¼Œä¸€ä¸ªuint32_tä¸º4ä½ï¼Œ(1+11)*4=48 Byteï¼Œå¯¹åº”24C02å­˜å‚¨ä¸­æ¯é¡µ16Byteï¼Œåªéœ€è¦3é¡µå°±èƒ½å­˜å‚¨</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> OTA_flag;    			<span class="comment">// OTAæ ‡å¿—ä½</span></span><br><span class="line">    <span class="type">uint32_t</span> FireLen[<span class="number">11</span>]; 			<span class="comment">// ç”¨äºå­˜å‚¨å›ºä»¶å„éƒ¨åˆ†çš„å¤§å°,0å·æˆå‘˜å›ºå®šW25Q64</span></span><br><span class="line">    <span class="type">uint8_t</span> OTA_Ver[<span class="number">32</span>];  			<span class="comment">// ç‰ˆæœ¬å·</span></span><br><span class="line">&#125; OTA_CB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> UpDataBuff[FLASH_PAGE_SIZE]; <span class="comment">// ä¸´æ—¶å­˜å‚¨å¤–éƒ¨æ¥æ”¶çš„å›ºä»¶æ•°æ®å—</span></span><br><span class="line">    <span class="type">uint32_t</span> W25Q64_BlockNM;             <span class="comment">// è®°å½•å½“å‰å›ºä»¶å†™å…¥å“ªä¸ªå—</span></span><br><span class="line">    <span class="type">uint32_t</span> XmodemTimer;                <span class="comment">// è®°å½•å»¶æ—¶</span></span><br><span class="line">    <span class="type">uint32_t</span> XmodemNB;                   <span class="comment">// æ•°æ®åŒ…æ¥æ”¶æ•°é‡</span></span><br><span class="line">    <span class="type">uint32_t</span> XmodemCRC;                  <span class="comment">// å­˜æ”¾CRCæ ¡éªŒ</span></span><br><span class="line">&#125; UpData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> OTA_CB OTA;</span><br><span class="line"><span class="keyword">extern</span> UpData Updata_A;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OTA_INFO_SIZE sizeof(OTA_CB)</span></span><br></pre></td></tr></table></figure>
<h3 id="otaè¯»å–æ ‡å¿—ä½"><a class="markdownIt-Anchor" href="#otaè¯»å–æ ‡å¿—ä½"></a> OTAè¯»å–æ ‡å¿—ä½</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–OTAæ ‡å¿—ä½,åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®éœ€è¦æ›´æ–°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">AT24C02_ReadOTA</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;OTA, <span class="number">0</span>, OTA_INFO_SIZE); 	<span class="comment">// å¼€è¾Ÿä¸€ä¸ªOTA_INFO_SIZEå¤§å°çš„åœ°å€ï¼Œåˆå§‹åŒ–ä¸º0</span></span><br><span class="line">    <span class="comment">// ä»AT24C02è¯»å–OTA_INFO_SIZEçš„æ•°æ®åˆ°ç»“æ„ä½“ä¸­</span></span><br><span class="line">    AT24C02_ReadData(<span class="number">0</span>, (<span class="type">uint8_t</span> *)&amp;OTA, OTA_INFO_SIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="otaä¿å­˜å…³é”®å˜é‡åˆ°at24c02"><a class="markdownIt-Anchor" href="#otaä¿å­˜å…³é”®å˜é‡åˆ°at24c02"></a> OTAä¿å­˜å…³é”®å˜é‡åˆ°AT24C02</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™å…¥OTAé…ç½®åˆ°EEPROM</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">AT24C02_WriteOTA</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> *pdata = (<span class="type">uint8_t</span> *)&amp;OTA;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; (OTA_INFO_SIZE + <span class="number">7</span>) / <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		AT24C02_WritePage(i * <span class="number">8</span>, pdata + i * <span class="number">8</span>);</span><br><span class="line">    	delay_ms(<span class="number">10</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼•å¯¼æ›´æ–°ota"><a class="markdownIt-Anchor" href="#å¼•å¯¼æ›´æ–°ota"></a> å¼•å¯¼æ›´æ–°OTA</h3>
<p><strong>(ä»ä¸‹é¢å‘ä¸Šçœ‹)</strong></p>
<p><strong>åˆ†åŒºè·³è½¬</strong>ä¸¤å¤§å…³é”®<strong>SPã€PC</strong>è®¾å®š</p>
<p>Cortex-M3æœ‰<strong>R0-R12é€šç”¨å¯„å­˜å™¨ï¼ŒR13æœ‰MSPï¼ˆä¸»å †æ ˆæŒ‡é’ˆï¼‰å’ŒPSPï¼ˆè¿›ç¨‹å †æ ˆæŒ‡é’ˆï¼‰(ä¿å­˜ç°åœºå’Œæ¢å¤ç°åœºçš„æŒ‡é’ˆ)ï¼ŒR14æ˜¯LRï¼ˆè¿æ¥å¯„å­˜å™¨ï¼Œä¿å­˜å­å‡½æ•°ä¹‹é—´è·³è½¬çš„è¿”å›å€¼ï¼‰ï¼ŒR15æ˜¯PCï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰</strong></p>
<blockquote>
<p>Qï¼šMSPæŒ‡é’ˆå’ŒPSPæŒ‡é’ˆï¼Œåˆ†åˆ«åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨ï¼Ÿ</p>
<p><strong>MSP (Main Stack Pointer)</strong></p>
<ul>
<li>ç³»ç»Ÿé»˜è®¤çš„æ ˆæŒ‡é’ˆã€‚</li>
<li>ä¸Šç”µå¤ä½åï¼ŒCPU <strong>è‡ªåŠ¨æŠŠ MSP å½“æ ˆæŒ‡é’ˆ</strong>ã€‚</li>
<li>é€šå¸¸ç”¨æ¥å¤„ç† <strong>å¼‚å¸¸ / ä¸­æ–­ / å†…æ ¸çº§ä»»åŠ¡</strong>ã€‚</li>
</ul>
<p><strong>PSP (Process Stack Pointer)</strong></p>
<ul>
<li>éœ€è¦è½¯ä»¶è®¾ç½®ï¼ˆCONTROL å¯„å­˜å™¨é‡Œåˆ‡æ¢ï¼‰ã€‚</li>
<li>é€šå¸¸ç”¨æ¥è·‘ <strong>ç”¨æˆ·çº¿ç¨‹ / æ™®é€šä»»åŠ¡</strong>ã€‚ï¼ˆFreeRTOSé‡Œçš„æ¯ä¸ªä»»åŠ¡æ ˆï¼‰</li>
</ul>
</blockquote>
<ul>
<li>
<p>20(AåŒºèµ·å§‹é¡µ) * 1024 = 20480 â€”&gt; 0x00005000 + 0x08000000 = <strong>0x08005000</strong>ï¼Œæ­¤ä¸ºAåŒºå¼€å§‹æ—¶SP<strong>åœ°å€</strong></p>
</li>
<li>
<p>AåŒºèµ·å§‹ä½ç½®<strong>0x08005000 + 4</strong>(32ä½çš„æŒ‡é’ˆæ˜¯4Byte)ï¼Œæ­¤ä¸ºAåŒºå¼€å§‹æ—¶<strong>PCåœ°å€</strong></p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RAM ï¼š 0x20000000 ~ 0x20004FFF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLASH_A_SADDR FLASH_SADDR + FLASH_A_SPAGE * FLASH_PAGE_SIZE <span class="comment">// AåŒºèµ·å§‹åœ°å€</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*load_a)</span><span class="params">(<span class="type">void</span>)</span>; 	<span class="comment">// å›è°ƒå‡½æ•°ï¼Œå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªæ— å‚æ•°ã€æ— è¿”å›å€¼çš„å‡½æ•°</span></span><br><span class="line">load_a load_A;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºä¿®æ”¹ä¸»å †æ ˆæŒ‡é’ˆ(MSP)</span></span><br><span class="line">__ASM <span class="type">void</span> <span class="title function_">MSR_SP</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;				 				</span><br><span class="line">	MSR MSP, r0;<span class="comment">// MSRæŒ‡ä»¤ç”¨äºå°†ç¨‹åºçŠ¶æ€å¯„å­˜å™¨çš„å†…å®¹ä¼ é€åˆ°é€šç”¨å¯„å­˜å™¨ä¸­ï¼ŒR0=addr</span></span><br><span class="line">	BX r14;<span class="comment">// é€šè¿‡é“¾æ¥å¯„å­˜å™¨LR(r14)è¿”å›è°ƒç”¨è€…ï¼Œç­‰åŒäºreturn</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·³è½¬åˆ°AåŒºåº”ç”¨ç¨‹åº</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LOAD_A</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((*(<span class="type">uint32_t</span> *)addr &gt;= <span class="number">0x20000000</span>) &amp;&amp; (*(<span class="type">uint32_t</span> *)addr &lt;= <span class="number">0x20004FFF</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// è®¾ç½®AåŒºèµ·å§‹åœ°å€,å› ä¸ºMSR_SPå‡½æ•°æ¥æ”¶uint32_tçš„æ•°æ®ï¼Œæ‰€ä»¥å…ˆå¼ºåˆ¶è½¬æ¢ï¼Œå†æŒ‡é’ˆå–åœ°å€</span></span><br><span class="line">		MSR_SP(*(<span class="type">uint32_t</span> *)addr);</span><br><span class="line">		load_A = (load_a) * (<span class="type">uint32_t</span> *)(addr + <span class="number">4</span>); <span class="comment">// è·å–å¤ä½ä¸­æ–­å¤„ç†ç¨‹åºåœ°å€</span></span><br><span class="line">		load_A();									<span class="comment">// å®é™…æ‰§è¡Œçš„æ˜¯Reset_Handler</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		uprintf(<span class="string">&quot;è·³è½¬Aåˆ†åŒºå¤±è´¥\r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•å¯¼OTAå‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BootLoader_Jump</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ç­‰å¾…20*100msæ£€æµ‹æ˜¯å¦è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼</span></span><br><span class="line">	<span class="keyword">if</span> (BootLoader_Enter(<span class="number">20</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// æ£€æŸ¥OTAæ›´æ–°æ ‡å¿—</span></span><br><span class="line">		<span class="keyword">if</span> (OTA.OTA_flag == OTA_SET_FLAG)</span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;OTAæ›´æ–° \r\n&quot;</span>);</span><br><span class="line">			BootState |= UPDATA_A_FLAG;	 <span class="comment">// è®¾ç½®AåŒºæ›´æ–°æ ‡å¿—</span></span><br><span class="line">			UpDATA_A.W25Q64_BlockNM = <span class="number">0</span>; <span class="comment">// é»˜è®¤ä½¿ç”¨W25Q64çš„å—0</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;è·³è½¬Aåˆ†åŒº \r\n&quot;</span>);</span><br><span class="line">			LOAD_A(FLASH_A_SADDR); <span class="comment">// è·³è½¬åˆ°AåŒºåº”ç”¨ç¨‹åº</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	uprintf(<span class="string">&quot;è¿›å…¥BootLoaderå‘½ä»¤è¡Œ \r\n&quot;</span>);</span><br><span class="line">	BootLoader_Info();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¤ä½å¤–è®¾ï¼Œæ²¡ç”¨åˆ°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BootLoader_Clear</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	USART_DeInit(USART1);</span><br><span class="line">	GPIO_DeInit(GPIOA);</span><br><span class="line">	GPIO_DeInit(GPIOB);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bootloaderäº‹ä»¶"><a class="markdownIt-Anchor" href="#bootloaderäº‹ä»¶"></a> BootLoaderäº‹ä»¶</h3>
<p><strong>(ä»ä¸Šé¢å‘ä¸‹çœ‹)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> BootState; 			<span class="comment">// ç³»ç»Ÿå¯åŠ¨çŠ¶æ€æ ‡å¿—ä½</span></span><br><span class="line"><span class="type">uint8_t</span> wdata[<span class="number">2048</span>];</span><br><span class="line"><span class="type">uint8_t</span> rdata[<span class="number">2048</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*	æ˜¾ç¤ºBootLoaderå‘½ä»¤è¡Œå¸®åŠ©ä¿¡æ¯	*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BootLoader_Info</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	uprintf(<span class="string">&quot; \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[1]æ“¦é™¤AåŒº \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[2]ä¸²å£IAPä¸‹è½½AåŒº \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[3]è®¾ç½®OTAç‰ˆæœ¬å· \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[4]æŸ¥è¯¢OTAç‰ˆæœ¬å· \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[5]å‘å¤–éƒ¨FLASHä¸‹è½½ç¨‹åº \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[6]ä½¿ç”¨å¤–éƒ¨FLASHå†…ç¨‹åº \r\n&quot;</span>);</span><br><span class="line">	uprintf(<span class="string">&quot;[7]é‡å¯ \r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*	æ£€æµ‹æ˜¯å¦è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼ï¼Œtimeout è¶…æ—¶æ—¶é—´ï¼Œ1-è¿›å…¥å‘½ä»¤è¡Œï¼Œ0-ä¸è¿›å…¥	*/</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">BootLoader_Enter</span><span class="params">(<span class="type">uint8_t</span> timeout)</span></span><br><span class="line">&#123;</span><br><span class="line">	uprintf(<span class="string">&quot;è¾“å…¥å°å†™å­—æ¯w,è¿›å…¥BootLoaderå‘½ä»¤è¡Œ \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">while</span> (timeout--)</span><br><span class="line">	&#123;</span><br><span class="line">		Delay_ms(<span class="number">200</span>);</span><br><span class="line">		<span class="keyword">if</span> (U1_RX_Buff[<span class="number">0</span>] == <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>; 							<span class="comment">// è¿›å…¥å‘½ä»¤è¡Œ</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>; 									<span class="comment">// ä¸è¿›å…¥</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Bootloaderäº‹ä»¶ç»„</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BootLoader_Event</span><span class="params">(<span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> temp, i;</span><br><span class="line">	<span class="keyword">if</span> (BootState == <span class="number">0</span>)<span class="comment">// BootState=0ï¼šä¸è¿›è¡Œå…¶ä»–æ“ä½œï¼Œæ˜¾ç¤ºç•Œé¢</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;1&#x27;</span>))<span class="comment">//	æ“¦é™¤AåŒº</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;[1]æ“¦é™¤AåŒº \r\n&quot;</span>);</span><br><span class="line">			FLASH_Erase(FLASH_A_SPAGE, FLASH_A_NUM);</span><br><span class="line">			Delay_ms(<span class="number">100</span>);</span><br><span class="line">			BootLoader_Info();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;2&#x27;</span>))<span class="comment">//	é€šè¿‡Xmodemä¸‹è½½å›ºä»¶åˆ°AåŒº</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;é€šè¿‡Xmodemåè®®,ä¸²å£IAPä¸‹è½½AåŒºç¨‹åº,ä½¿ç”¨binæ–‡ä»¶ \r\n&quot;</span>);</span><br><span class="line">			FLASH_Erase(FLASH_A_SPAGE, FLASH_A_NUM);		   <span class="comment">// æ“¦é™¤ç›®æ ‡åŒºåŸŸ</span></span><br><span class="line">			BootState |= (IAP_XMODEM_FLAG | IAP_XMODEMD_FLAG); <span class="comment">// è®¾ç½®Xmodemæ ‡å¿—</span></span><br><span class="line">			UpDATA_A.XmodemTimer = <span class="number">0</span>;						   <span class="comment">// é‡ç½®è®¡æ—¶å™¨</span></span><br><span class="line">			UpDATA_A.XmodemNB = <span class="number">0</span>;							   <span class="comment">// é‡ç½®æ•°æ®åŒ…è®¡æ•°å™¨</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;3&#x27;</span>))	<span class="comment">//	è®¾ç½®ç‰ˆæœ¬å·</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;è®¾ç½®ç‰ˆæœ¬å· \r\n&quot;</span>);</span><br><span class="line">			BootState |= SET_VERSION_FLAG;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;4&#x27;</span>))	<span class="comment">//	æŸ¥è¯¢ç‰ˆæœ¬å·</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;æŸ¥è¯¢ç‰ˆæœ¬å· \r\n&quot;</span>);</span><br><span class="line">			AT24C02_ReadOTA();							</span><br><span class="line">			uprintf(<span class="string">&quot;ç‰ˆæœ¬å·:%s \r\n&quot;</span>, OTA.OTA_Ver);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;5&#x27;</span>))	<span class="comment">//å‘å¤–éƒ¨FLASHä¼ è¾“ç¨‹åº</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;å‘å¤–éƒ¨FLASHä¼ è¾“ç¨‹åº,è¾“å…¥éœ€è¦ä½¿ç”¨çš„å—ç¼–å·(1~9) \r\n&quot;</span>);</span><br><span class="line">			BootState |= CMD_5_FLAG;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;6&#x27;</span>))	<span class="comment">//ä½¿ç”¨å¤–éƒ¨FLASHä¸‹è½½ç¨‹åº</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;ä½¿ç”¨å¤–éƒ¨FLASHä¸‹è½½ç¨‹åº,è¾“å…¥éœ€è¦ä½¿ç”¨çš„å—ç¼–å·(1~9) \r\n&quot;</span>);</span><br><span class="line">			BootState |= CMD_6_FLAG;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="string">&#x27;7&#x27;</span>))	<span class="comment">// Reset</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;é‡å¯ä¸­ \r\n&quot;</span>);</span><br><span class="line">			__set_FAULTMASK(<span class="number">1</span>);</span><br><span class="line">			Delay_ms(<span class="number">100</span>);</span><br><span class="line">			NVIC_SystemReset();							<span class="comment">//NVICé‡å¯</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (BootState &amp; IAP_XMODEMD_FLAG)				<span class="comment">// Xmodemåè®®æ•°æ®å¤„ç†</span></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">// æ¥æ”¶æ•°æ®åŒ…ï¼ˆ133å­—èŠ‚ï¼š1ä¸ªå­—èŠ‚+128å­—èŠ‚+2CRC+2Byteåºå·ï¼‰</span></span><br><span class="line">		<span class="keyword">if</span> ((datalen == <span class="number">133</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="number">0x01</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			BootState &amp;= ~IAP_XMODEM_FLAG;	</span><br><span class="line">			UpDATA_A.XmodemCRC = Xmodem_CRC16(&amp;data[<span class="number">3</span>], <span class="number">128</span>);<span class="comment">// è®¡ç®—æ¥æ”¶æ•°æ®çš„CRCæ ¡éªŒå€¼</span></span><br><span class="line">			<span class="keyword">if</span> (UpDATA_A.XmodemCRC == data[<span class="number">131</span>] * <span class="number">256</span> + data[<span class="number">132</span>])	<span class="comment">// æ ¡éªŒé€šè¿‡å¤„ç†</span></span><br><span class="line">			&#123;</span><br><span class="line">				UpDATA_A.XmodemNB++;<span class="comment">// Xmodemæ¥æ”¶æ•°æ®åŒ…å¢åŠ 					</span></span><br><span class="line">				<span class="comment">// å°†æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒº</span></span><br><span class="line">                <span class="built_in">memcpy</span>(&amp;UpDATA_A.UpDataBuff[((UpDATA_A.XmodemNB - <span class="number">1</span>) % (FLASH_PAGE_SIZE / <span class="number">128</span>)) * <span class="number">128</span>], &amp;data[<span class="number">3</span>], <span class="number">128</span>); </span><br><span class="line">                <span class="comment">//&amp;data[3]ï¼šXmodemåŒ…çš„æ•°æ®éƒ¨åˆ†ä»ç¬¬4å­—èŠ‚å¼€å§‹ï¼ˆè·³è¿‡1å­—èŠ‚å¤´+2å­—èŠ‚åºå·ï¼‰</span></span><br><span class="line">                <span class="comment">//(FLASH_PAGE_SIZE(1024) / 128)è®¡ç®—ä¸€é¡µå¯ä»¥å­˜ä¸‹çš„åŒ…æ•°ï¼Œå¯¹è¯¥å–æ¨¡ï¼Œå½“è¶…è¿‡ä¸€é¡µé‡æ–°è®¡ç®—</span></span><br><span class="line">				<span class="keyword">if</span> ((UpDATA_A.XmodemNB % (FLASH_PAGE_SIZE / <span class="number">128</span>)) == <span class="number">0</span>) <span class="comment">// 1024/128=8ï¼Œæ¯8ä¸ªæ•°æ®åŒ…å‘é€ä¸€æ¬¡</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (BootState &amp; CMD5_XMODEM_FLAG)<span class="comment">// é€‰æ‹©å†™å…¥W25Q64æˆ–FLASH</span></span><br><span class="line">					&#123;							</span><br><span class="line">						<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)<span class="comment">// å†™å…¥å¤–éƒ¨W25Q64ï¼Œæ¯æ¬¡å†™å…¥256å­—èŠ‚ï¼Œå†™4æ¬¡ä¸ºä¸€é¡µ</span></span><br><span class="line">						&#123;</span><br><span class="line">							W25Q64_PageWrite(&amp;UpDATA_A.UpDataBuff[i * <span class="number">256</span>], </span><br><span class="line">							(UpDATA_A.XmodemNB / <span class="number">8</span> - <span class="number">1</span>) * <span class="number">4</span> + i + UpDATA_A.W25Q64_BlockNM * <span class="number">64</span> * <span class="number">4</span>);</span><br><span class="line">							<span class="comment">//(x/8-1)*4+i,xè¡¨ç¤ºæ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¸ªæ•°ï¼Œ4è¡¨ç¤ºå†™å…¥W25Q64çš„é¡µæ•°,iç”¨æ¥å®šä½é¡µæ•°</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">// FLASH_A_SADDR + ((UpDATA_A.XmodemNB / (FLASH_PAGE_SIZE / 128)) - 1) * FLASH_PAGE_SIZE</span></span><br><span class="line">						<span class="comment">// AåŒºçš„èµ·å§‹åœ°å€+((æ¥æ”¶çš„8ä¸ªXmodemåè®®åŒ… / (ä¸€é¡µå æ®çš„åè®®åŒ…æ•°é‡)) -1(ç´¢å¼•ä»0å¼€å§‹) * å½“å‰é¡µåç§»åœ°å€</span></span><br><span class="line">                        <span class="comment">// é€šè¿‡Xmodemåè®®ä¼ è¾“çš„å†™å…¥åˆ°ç¼“å†²åŒºçš„æ•°æ®</span></span><br><span class="line">						FLASH_Write(FLASH_A_SADDR + ((UpDATA_A.XmodemNB / (FLASH_PAGE_SIZE / <span class="number">128</span>)) - <span class="number">1</span>) * FLASH_PAGE_SIZE,</span><br><span class="line">						(<span class="type">uint32_t</span> *)UpDATA_A.UpDataBuff, FLASH_PAGE_SIZE);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				uprintf(<span class="string">&quot;\x06&quot;</span>); 			<span class="comment">// è¡¨ç¤ºXmodemåè®®åŒ…è¯»å–æˆåŠŸ</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;\x15&quot;</span>); 			<span class="comment">// è¡¨ç¤ºXmodemåè®®åŒ…è¯»å–å¤±è´¥</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((datalen == <span class="number">1</span>) &amp;&amp; (data[<span class="number">0</span>] == <span class="number">0x04</span>)) 					<span class="comment">// è¯»å–Xmodemåè®®åŒ…å‰©ä½™çš„æ•°æ®</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;\x06&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> ((UpDATA_A.XmodemNB % (FLASH_PAGE_SIZE / <span class="number">128</span>)) != <span class="number">0</span>) <span class="comment">// å¦‚æœæœ‰å‰©ä½™çš„æ•°æ®</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (BootState &amp; CMD5_XMODEM_FLAG)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">					&#123;</span><br><span class="line">						W25Q64_PageWrite(&amp;UpDATA_A.UpDataBuff[i * <span class="number">256</span>],</span><br><span class="line">						(UpDATA_A.XmodemNB / <span class="number">8</span>) * <span class="number">4</span> + i + UpDATA_A.W25Q64_BlockNM * <span class="number">64</span> * <span class="number">4</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					FLASH_Write(FLASH_A_SADDR + ((UpDATA_A.XmodemNB / (FLASH_PAGE_SIZE / <span class="number">128</span>))) * FLASH_PAGE_SIZE,</span><br><span class="line">					(<span class="type">uint32_t</span> *)UpDATA_A.UpDataBuff,</span><br><span class="line">					(UpDATA_A.XmodemNB % (FLASH_PAGE_SIZE / <span class="number">128</span>)) * <span class="number">128</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			BootState &amp;= ~IAP_XMODEMD_FLAG;</span><br><span class="line">			<span class="keyword">if</span> (BootState &amp; CMD5_XMODEM_FLAG) 		<span class="comment">// å°†æ•°æ®ä¸‹è½½åˆ°W25Q64</span></span><br><span class="line">			&#123;</span><br><span class="line">				BootState &amp;= ~CMD5_XMODEM_FLAG;		<span class="comment">// å°†æ ‡å¿—ä½å¤ä½</span></span><br><span class="line">				OTA.FireLen[UpDATA_A.W25Q64_BlockNM] = UpDATA_A.XmodemNB * <span class="number">128</span>; <span class="comment">// å°†Xmodemæ•°æ®å­˜å…¥W25Q64ä¸­</span></span><br><span class="line">				AT24C02_WriteOTA();					<span class="comment">// å­˜å‚¨æ•°æ®,æ‰ç”µä¸ä¸¢å¤±</span></span><br><span class="line">				Delay_ms(<span class="number">100</span>);</span><br><span class="line">				BootLoader_Info();					<span class="comment">//é‡æ–°æ˜¾ç¤ºå‘½ä»¤è¡Œ</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				__set_FAULTMASK(<span class="number">1</span>); 				<span class="comment">// å…³é—­æ‰€æœ‰ä¸­æ–­</span></span><br><span class="line">				Delay_ms(<span class="number">100</span>);</span><br><span class="line">				NVIC_SystemReset(); 				<span class="comment">// ç¨‹åºé‡å¯</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (BootState &amp; SET_VERSION_FLAG) 		<span class="comment">// è®¾ç½®ç‰ˆæœ¬å·</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (datalen &lt;= <span class="number">32</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">sscanf</span>((<span class="type">const</span> <span class="type">char</span> *)data, <span class="string">&quot;VER-%d.%d.%d-%d/%d/%d-%d:%d&quot;</span>, &amp;temp, &amp;temp, &amp;temp, &amp;temp, &amp;temp, &amp;temp, &amp;temp, &amp;temp) == <span class="number">8</span>)</span><br><span class="line">			&#123;								   <span class="comment">// VER-1.0.0-2025/5/1-10:28</span></span><br><span class="line">				<span class="built_in">memset</span>(OTA.OTA_Ver, <span class="number">0</span>, <span class="number">32</span>);	   <span class="comment">// å°†ä¹‹å‰çš„ç‰ˆæœ¬å·æ¸…é›¶</span></span><br><span class="line">				<span class="built_in">memcpy</span>(OTA.OTA_Ver, data, <span class="number">32</span>); <span class="comment">// å¡«å…¥æ–°çš„ç‰ˆæœ¬å·</span></span><br><span class="line">				AT24C02_WriteOTA();			   <span class="comment">// å†™å…¥æ‰ç”µä¸ä¸¢å¤±èŠ¯ç‰‡</span></span><br><span class="line">				uprintf(<span class="string">&quot;ç‰ˆæœ¬å·æ­£ç¡® \r\n&quot;</span>);</span><br><span class="line">				BootLoader_Info();</span><br><span class="line">				BootState &amp;= ~SET_VERSION_FLAG; <span class="comment">// ä½¿ç”¨å®Œå¤ä½æ ‡å¿—ä½</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;ç‰ˆæœ¬å·é•¿åº¦é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (BootState &amp; CMD_5_FLAG)			<span class="comment">// å°†binç¨‹åºä¼ å…¥W25Q64çš„ç¬¬%dä¸ªå—</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (datalen == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ((data[<span class="number">0</span>] &gt;= <span class="number">0x31</span>) &amp;&amp; (data[<span class="number">0</span>] &lt;= <span class="number">0x39</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				UpDATA_A.W25Q64_BlockNM = data[<span class="number">0</span>] - <span class="number">0x30</span>; 	<span class="comment">// å­—ç¬¦è½¬æ¢æ•°å­—</span></span><br><span class="line">				BootState |= (IAP_XMODEM_FLAG | IAP_XMODEMD_FLAG | CMD5_XMODEM_FLAG);<span class="comment">//åŠ ä¸ŠXMODEMçš„æ ‡å¿—ä½</span></span><br><span class="line">				UpDATA_A.XmodemTimer = <span class="number">0</span>;					<span class="comment">// æ¸…ç©ºå®šæ—¶å™¨</span></span><br><span class="line">				UpDATA_A.XmodemNB = <span class="number">0</span>;						<span class="comment">// æ¸…ç©ºå‘é€çš„åŒ…æ•°</span></span><br><span class="line">				OTA.FireLen[UpDATA_A.W25Q64_BlockNM] = <span class="number">0</span>;	<span class="comment">// ç½®é›¶è¡¨ç¤ºæ¸…ç©ºæ•°æ®</span></span><br><span class="line">				W25Q64_Erase_64k(UpDATA_A.W25Q64_BlockNM);	<span class="comment">// æ“¦é™¤æ•´å—</span></span><br><span class="line">				uprintf(<span class="string">&quot;é€šè¿‡Xmodemåè®®,å‘å¤–éƒ¨FLASHç¬¬%dä¸ªå—ä¼ è¾“ç¨‹åº,ä½¿ç”¨binæ–‡ä»¶ \r\n&quot;</span>, UpDATA_A.W25Q64_BlockNM);</span><br><span class="line">				BootState &amp;= ~CMD_5_FLAG;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;ç¼–å·é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;æ•°æ®é•¿åº¦é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (BootState &amp; CMD_6_FLAG) 						<span class="comment">// ä½¿ç”¨W25Q64ä¿å­˜çš„APPç¨‹åº</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (datalen == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ((data[<span class="number">0</span>] &gt;= <span class="number">0x31</span>) &amp;&amp; (data[<span class="number">0</span>] &lt;= <span class="number">0x39</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				UpDATA_A.W25Q64_BlockNM = data[<span class="number">0</span>] - <span class="number">0x30</span>; 		<span class="comment">// å­—ç¬¦è½¬æ¢æ•°å­—</span></span><br><span class="line">				BootState |= UPDATA_A_FLAG;				  <span class="comment">// AåŒºæ›´æ–°æ ‡å¿—</span></span><br><span class="line">				BootState &amp;= ~CMD_6_FLAG;				  <span class="comment">// å°†å‘½ä»¤6æ ‡å¿—ç½®ä½</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;ç¼–å·é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;é•¿åº¦é”™è¯¯ \r\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸»ç¨‹åº"><a class="markdownIt-Anchor" href="#ä¸»ç¨‹åº"></a> ä¸»ç¨‹åº</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éœ€è¦ç”¨åˆ°çš„åŠŸèƒ½ï¼šä¸²å£ï¼ŒSPIï¼ŒFLASH</span></span><br><span class="line"><span class="type">uint32_t</span> BootState; 	<span class="comment">// ç³»ç»Ÿå¯åŠ¨çŠ¶æ€æ ‡å¿—ä½</span></span><br><span class="line"><span class="type">uint8_t</span> wdata[<span class="number">2048</span>];</span><br><span class="line"><span class="type">uint8_t</span> rdata[<span class="number">2048</span>];</span><br><span class="line"><span class="keyword">extern</span> OTA_CB OTA;</span><br><span class="line"><span class="keyword">extern</span> UpData UpDATA_A;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">uint32_t</span> BootState;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> i;</span><br><span class="line">	USART1_Init(<span class="number">921600</span>); 	<span class="comment">// åˆå§‹åŒ–ä¸²å£1ï¼Œæ³¢ç‰¹ç‡921600</span></span><br><span class="line">	Delay_Init();		 <span class="comment">// åˆå§‹åŒ–å»¶æ—¶å‡½æ•°</span></span><br><span class="line">	I2C1_Init();		 <span class="comment">// åˆå§‹åŒ–I2C1ï¼ˆç”¨äºAT24C02é€šä¿¡ï¼‰</span></span><br><span class="line">	AT24C02_ReadOTA();	 <span class="comment">// ä»AT24C02è¯»å–OTAæ ‡å¿—ä½</span></span><br><span class="line">	W25Q64_Init();		 <span class="comment">// åˆå§‹åŒ–W25Q64ï¼ˆSPI Flashï¼‰</span></span><br><span class="line">	BootLoader_Jump();	 <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬åˆ°BootLoader</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Delay_ms(<span class="number">10</span>); <span class="comment">// ä¸»å¾ªç¯å»¶æ—¶10ms</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// ä¸²å£1å¤„ç†ç¼“å†²åŒºæ•°æ®</span></span><br><span class="line">		<span class="keyword">if</span> (U1CB.URxDataOUT != U1CB.URxDataIN)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®ï¼ˆXmodemåè®®æˆ–å…¶ä»–æŒ‡ä»¤ï¼‰</span></span><br><span class="line">			BootLoader_Event(U1CB.URxDataOUT-&gt;start, U1CB.URxDataOUT-&gt;end - U1CB.URxDataOUT-&gt;start + <span class="number">1</span>);</span><br><span class="line">			<span class="comment">// ç§»åŠ¨æ¥æ”¶ç¼“å†²åŒºæŒ‡é’ˆ</span></span><br><span class="line">			U1CB.URxDataOUT++;</span><br><span class="line">			<span class="keyword">if</span> (U1CB.URxDataOUT == U1CB.URxDataEND)</span><br><span class="line">			&#123;</span><br><span class="line">				U1CB.URxDataOUT = &amp;U1CB.URxDataPtr[<span class="number">0</span>]; <span class="comment">// ç¯å½¢ç¼“å†²åŒºå›å·</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€Xmodemåè®®çš„æ§åˆ¶å­—ç¬¦&#x27;C&#x27;</span></span><br><span class="line">		<span class="keyword">if</span> (BootState &amp; IAP_XMODEM_FLAG)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (UpDATA_A.XmodemTimer &gt;= <span class="number">100</span>) 	<span class="comment">// æ¯100æ¬¡å¾ªç¯å‘é€ä¸€æ¬¡&#x27;C&#x27;</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;C&quot;</span>); 				<span class="comment">// å‘é€Xmodemèµ·å§‹ä¿¡å·</span></span><br><span class="line">				UpDATA_A.XmodemTimer = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			UpDATA_A.XmodemTimer++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°AåŒºå›ºä»¶</span></span><br><span class="line">		<span class="keyword">if</span> (BootState &amp; UPDATA_A_FLAG)</span><br><span class="line">		&#123;</span><br><span class="line">			uprintf(<span class="string">&quot;é•¿åº¦%då­—èŠ‚\r\n&quot;</span>, OTA.FireLen[UpDATA_A.W25Q64_BlockNM]);</span><br><span class="line">			<span class="comment">// æ“¦é™¤ç›®æ ‡FLASHåŒºåŸŸ(AåŒº)</span></span><br><span class="line">			FLASH_Erase(FLASH_A_SPAGE, FLASH_A_NUM);</span><br><span class="line">			uprintf(<span class="string">&quot;AåŒºå·²æ“¦é™¤ \r\n&quot;</span>);</span><br><span class="line">			<span class="comment">// æ£€æŸ¥å›ºä»¶é•¿åº¦æ˜¯å¦ä¸º4çš„å€æ•°</span></span><br><span class="line">			<span class="keyword">if</span> (OTA.FireLen[UpDATA_A.W25Q64_BlockNM] % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// æŒ‰1KBé¡µå¾ªç¯å†™å…¥å®Œæ•´æ•°æ®å—</span></span><br><span class="line">				<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (OTA.FireLen[UpDATA_A.W25Q64_BlockNM] / <span class="number">1024</span>); i++)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// ä»W25Q64è¯»å–1KBæ•°æ®åˆ°ç¼“å†²åŒº</span></span><br><span class="line">                    			<span class="comment">// æºåœ°å€ï¼šå—å·Ã—64KB + åç§»é‡ï¼Œ è¯»å–é•¿åº¦=1KB</span></span><br><span class="line">					W25Q64_Read(UpDATA_A.UpDataBuff, i * FLASH_PAGE_SIZE + <span class="number">64</span> * <span class="number">1024</span> * UpDATA_A.W25Q64_BlockNM, FLASH_PAGE_SIZE);</span><br><span class="line">					<span class="comment">// å°†1KBæ•°æ®å†™å…¥FLASHï¼ˆç›®æ ‡åœ°å€é€’å¢ï¼‰</span></span><br><span class="line">                    <span class="comment">// ç›®æ ‡åœ°å€</span></span><br><span class="line">                    <span class="comment">// æ•°æ®æŒ‡é’ˆï¼ˆå¼ºåˆ¶è½¬æ¢ä¸ºuint32_t*ï¼‰</span></span><br><span class="line">                    <span class="comment">// å†™å…¥é•¿åº¦=1KB</span></span><br><span class="line">					FLASH_Write(FLASH_A_SADDR + i * FLASH_PAGE_SIZE, (<span class="type">uint32_t</span> *)UpDATA_A.UpDataBuff, FLASH_PAGE_SIZE);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// å¤„ç†å‰©ä½™ä¸è¶³1KBçš„æ•°æ®</span></span><br><span class="line">				<span class="keyword">if</span> (OTA.FireLen[UpDATA_A.W25Q64_BlockNM] % <span class="number">1024</span> != <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">memset</span>(UpDATA_A.UpDataBuff, <span class="number">0</span>, FLASH_PAGE_SIZE);</span><br><span class="line">					<span class="comment">// è¯»å–å‰©ä½™æ•°æ®</span></span><br><span class="line">                    <span class="comment">// å‰©ä½™æ•°æ®çš„èµ·å§‹åœ°å€ï¼Œå‰©ä½™æ•°æ®é•¿åº¦</span></span><br><span class="line">					W25Q64_Read(UpDATA_A.UpDataBuff, i * FLASH_PAGE_SIZE + <span class="number">64</span> * <span class="number">1024</span> * UpDATA_A.W25Q64_BlockNM,</span><br><span class="line">					OTA.FireLen[UpDATA_A.W25Q64_BlockNM] % <span class="number">1024</span>);</span><br><span class="line">                    </span><br><span class="line">					<span class="comment">// å†™å…¥å‰©ä½™æ•°æ®åˆ°FLASH</span></span><br><span class="line">					FLASH_Write(FLASH_A_SADDR + i * FLASH_PAGE_SIZE, (<span class="type">uint32_t</span> *)UpDATA_A.UpDataBuff, OTA.FireLen[UpDATA_A.W25Q64_BlockNM] % <span class="number">1024</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// OTAæ›´æ–°åï¼ŒUpDATA_A.W25Q64_BlockNM == 0</span></span><br><span class="line">				<span class="keyword">if</span> (UpDATA_A.W25Q64_BlockNM == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					OTA.OTA_flag = <span class="number">0</span>;				<span class="comment">// æ¸…é™¤OTAæ ‡å¿—</span></span><br><span class="line">					AT24C02_WriteOTA(); 			<span class="comment">// æ›´æ–°åå†™å…¥AT24C02ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// é‡å¯</span></span><br><span class="line">				uprintf(<span class="string">&quot; \r\nAåŒºæ›´æ–°å®Œæ¯• \r\n&quot;</span>);</span><br><span class="line">				__set_FAULTMASK(<span class="number">1</span>); <span class="comment">// å±è”½æ‰€æœ‰å¼‚å¸¸</span></span><br><span class="line">				Delay_ms(<span class="number">100</span>);</span><br><span class="line">				NVIC_SystemReset(); <span class="comment">// ç³»ç»Ÿå¤ä½</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				uprintf(<span class="string">&quot;é•¿åº¦é”™è¯¯\r\n&quot;</span>);	 <span class="comment">// æ•°æ®é•¿åº¦æœªå¯¹é½</span></span><br><span class="line">				BootState &amp;= ~UPDATA_A_FLAG; <span class="comment">// æ¸…é™¤æ›´æ–°æ ‡å¿—</span></span><br><span class="line">				BootLoader_Info();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="xmodemåè®®"><a class="markdownIt-Anchor" href="#xmodemåè®®"></a> Xmodemåè®®</h1>
<p><strong>Xmodemä½¿ç”¨SecureCRTP</strong>è½¯ä»¶é…ç½®è¿æ¥ä¸²å£é€šä¿¡ï¼Œå®ƒç›¸è¾ƒäºYmodemçš„åŒºåˆ«æ˜¯å…·æœ‰æ›´å°çš„Packageé•¿åº¦</p>
<h2 id="æ ¼å¼"><a class="markdownIt-Anchor" href="#æ ¼å¼"></a> æ ¼å¼</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Byte1</th>
<th style="text-align:center">Byte2</th>
<th style="text-align:center">Byte3</th>
<th style="text-align:center">Byte4 ~ Byte131</th>
<th style="text-align:center">Byte132 ~ Byte133</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Start of Header(SOH)</td>
<td style="text-align:center">Packet Number</td>
<td style="text-align:center">~(Packet Number)</td>
<td style="text-align:center">Pcacket Data</td>
<td style="text-align:center">CRC16 Check</td>
</tr>
</tbody>
</table>
<h2 id="æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#æŒ‡ä»¤"></a> æŒ‡ä»¤</h2>
<table>
<thead>
<tr>
<th style="text-align:center">ä½</th>
<th style="text-align:center">æŒ‡ä»¤</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SOH</td>
<td style="text-align:center">0x01</td>
<td style="text-align:center">128å­—èŠ‚æ•°æ®åŒ…å¸§å¤´</td>
</tr>
<tr>
<td style="text-align:center">STX</td>
<td style="text-align:center">0x02</td>
<td style="text-align:center">1024å­—èŠ‚æ•°æ®åŒ…å¸§å¤´</td>
</tr>
<tr>
<td style="text-align:center">EOT</td>
<td style="text-align:center">0x04</td>
<td style="text-align:center">ç»“æŸä¼ è¾“</td>
</tr>
<tr>
<td style="text-align:center">ACK</td>
<td style="text-align:center">0x06</td>
<td style="text-align:center">æ­£ç¡®åº”ç­”</td>
</tr>
<tr>
<td style="text-align:center">NAK</td>
<td style="text-align:center">0x15</td>
<td style="text-align:center">é”™è¯¯åº”ç­”ï¼Œé‡ä¼ æ•°æ®</td>
</tr>
<tr>
<td style="text-align:center">CAN</td>
<td style="text-align:center">0x18</td>
<td style="text-align:center">å–æ¶ˆä¼ è¾“</td>
</tr>
<tr>
<td style="text-align:center">CTRLZ</td>
<td style="text-align:center">0x1A</td>
<td style="text-align:center">æ•°æ®å¡«å……</td>
</tr>
<tr>
<td style="text-align:center">HSC</td>
<td style="text-align:center">0x43</td>
<td style="text-align:center">æ¡æ‰‹</td>
</tr>
</tbody>
</table>
<h2 id="ä¾‹å­"><a class="markdownIt-Anchor" href="#ä¾‹å­"></a> ä¾‹å­</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">â€˜Câ€™											<span class="comment">// å‘é€ä¸€ä¸ªCç­‰å¾…æ•°æ®åŒ…</span></span><br><span class="line">											<span class="comment">// (3sä¸€æ¬¡ï¼Œç­‰å¾…åº”ç­”)</span></span><br><span class="line">SOH | <span class="number">0x01</span> | <span class="number">0xFE</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬ä¸€æ¡æŒ‡ä»¤</span></span><br><span class="line">ACKï¼ˆæ­£ç¡®åº”ç­”ï¼‰</span><br><span class="line">SOH | <span class="number">0x02</span> | <span class="number">0xFD</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬äºŒæ¡æŒ‡ä»¤</span></span><br><span class="line">NAKï¼ˆé”™è¯¯åº”ç­”ï¼‰</span><br><span class="line">SOH | <span class="number">0x02</span> | <span class="number">0xFD</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬äºŒæ¡æŒ‡ä»¤</span></span><br><span class="line">ACK</span><br><span class="line">SOH | <span class="number">0x03</span> | <span class="number">0xFC</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬ä¸‰æ¡æŒ‡ä»¤</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h2 id="crc16ç¨‹åº"><a class="markdownIt-Anchor" href="#crc16ç¨‹åº"></a> CRC16ç¨‹åº</h2>
<p>STM32æ”¯æŒCRC32ï¼Œä¸æ”¯æŒCRC16ï¼Œéœ€è¦è‡ªå·±å†™</p>
<p>å¤šé¡¹å¼p(x) = <strong>x^16 + x^12 + x^5 + 1</strong>ï¼Œå€ŸåŠ©å¤šé¡¹å¼å°†è¾“å…¥çš„æ•°å€¼è¿›è¡Œ<strong>æ¨¡2é™¤æ³•</strong>ï¼Œåœ¨Cè¯­è¨€ä¸­æ˜¯è¿›è¡Œ<strong>å¼‚æˆ–è¿ç®—</strong>^ã€‚</p>
<p><img src="https://s2.loli.net/2025/05/09/V1B2YkysPQZipdg.png" alt="" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡å­—è¯´æ˜</span></span><br><span class="line">å¯„å­˜å™¨æ¸…é›¶</span><br><span class="line">æ•°æ®æœ€å³è¾¹è¡¥é½Wä½<span class="number">0</span> 							<span class="comment">// Wæ˜¯CRCæ ¡éªŒå€¼çš„ä½æ•°</span></span><br><span class="line">when(è¿˜æœ‰æ•°æ®)&#123;</span><br><span class="line">    å·¦ç§»å¯„å­˜å™¨<span class="number">1</span>ä½ï¼Œè¯»å–æ•°æ®çš„ä¸‹ä¸€ä½åˆ°å¯„å­˜å™¨çš„bit <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (å·¦ç§»å¯„å­˜å™¨æ—¶å‡ºç°æº¢å‡º)&#123;</span><br><span class="line">        å¯„å­˜å™¨ ^= poly;    				<span class="comment">// è¿™é‡Œçš„poly=0011ï¼ŒæŒ‰ç…§ä¸Šé¢çš„ä¾‹å­</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">å¯„å­˜å™¨çš„å€¼å°±æ˜¯æ ¡éªŒå€¼</span><br><span class="line">    </span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">Xmodem_CRC16</span><span class="params">(<span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> i;</span><br><span class="line">	<span class="type">uint16_t</span> Crcinit = <span class="number">0x0000</span>; 	<span class="comment">// åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">	<span class="type">uint16_t</span> Poly = <span class="number">0x1021</span>;	   	<span class="comment">// XMODEM ä½¿ç”¨çš„å¤šé¡¹å¼ï¼šx^16 + x^12 + x^5 + 1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (datalen--)</span><br><span class="line">	&#123;</span><br><span class="line">		Crcinit = (*data &lt;&lt; <span class="number">8</span>) ^ Crcinit;</span><br><span class="line">		<span class="comment">// å·¦ç§»å…«ä½æ˜¯å› ä¸ºCRCæ˜¯é«˜ä½ä¼˜å…ˆè®¡ç®—ï¼Œå¼‚æˆ–æ˜¯ä¸ºäº†æ”¹å˜å½“å‰CRCçš„å€¼</span></span><br><span class="line">		<span class="comment">// å¼‚æˆ–å°†æ–°æ•°æ®â€œæ··åˆâ€è¿›å½“å‰çš„CRCå€¼ï¼Œä½¿CRCè®¡ç®—èƒ½è¦†ç›–æ‰€æœ‰è¾“å…¥æ•°æ®</span></span><br><span class="line">		<span class="comment">// è‹¥ç›´æ¥èµ‹å€¼ä¼šä¸¢å¤±ä¹‹å‰è®¡ç®—çš„CRCå€¼</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">// æ¯ä¸ªbitéƒ½è¦å½±å“CRCè®¡ç®—ï¼Œæ‰€ä»¥å¿…é¡»å¾ªç¯ 8 æ¬¡</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (Crcinit &amp; <span class="number">0x8000</span>) 	<span class="comment">// æ£€æŸ¥æœ€é«˜ä½æ˜¯å¦ä¸º1</span></span><br><span class="line">				Crcinit = (Crcinit &lt;&lt; <span class="number">1</span>) ^ Poly;</span><br><span class="line">			<span class="comment">// å¦‚æœæœ€é«˜ä½æ˜¯1ï¼Œè¯´æ˜å½“å‰çš„CRCå€¼å·²ç»è¾¾åˆ°æˆ–è¶…è¿‡å¤šé¡¹å¼çš„æœ€é«˜ä½(Polyæœ€é«˜ä½ä¸º0x1000)</span></span><br><span class="line">			<span class="comment">// å¿…é¡»å‡å»å¤šé¡¹(å³^Poly)å¦åˆ™CRCå€¼ä¼šè¶Šæ¥è¶Šå¤§</span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				Crcinit = (Crcinit &lt;&lt; <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		data++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Crcinit;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<p><a target="_blank" rel="noopener" href="https://github.com/havenxie/stm32-iap-uart-boot">havenxie/stm32-iap-uart-boot: STM32 IAP(UARTæ¨¡å¼)çš„BOOTéƒ¨åˆ†</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1SatHeBEVG/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click">ã€æ‰‹æŠŠæ‰‹æ•™ç¨‹ 4Gé€šä¿¡ç‰©è”ç½‘ OTAè¿œç¨‹å‡çº§ BootLoaderç¨‹åºè®¾è®¡ã€‘GD32F103C8T6å•ç‰‡æœºã€ä¸Šç¯‡ç« ã€‘_å“”å“©å“”å“©_bilibili</a></p>
<h1 id="è¡¥å……724"><a class="markdownIt-Anchor" href="#è¡¥å……724"></a> è¡¥å……ï¼ˆ7.24ï¼‰</h1>
<h2 id="bootloaderæ‰§è¡Œæµç¨‹"><a class="markdownIt-Anchor" href="#bootloaderæ‰§è¡Œæµç¨‹"></a> Bootloaderæ‰§è¡Œæµç¨‹</h2>
<ol>
<li>
<p><strong>ä¸Šç”µæˆ–å¤ä½</strong></p>
<ul>
<li>å½“ç³»ç»Ÿä¸Šç”µæˆ–å¤ä½æ—¶ï¼Œå¤„ç†å™¨ä»ä¸€ä¸ªå›ºå®šçš„åœ°å€å¼€å§‹æ‰§è¡Œï¼Œè¿™ä¸ªåœ°å€ç§°ä¸º <strong>å‘é‡è¡¨ï¼ˆVector Tableï¼‰</strong> çš„èµ·å§‹åœ°å€ã€‚</li>
</ul>
</li>
<li>
<p><strong>è¯»å–å‘é‡è¡¨åœ°å€ï¼ˆæ¯”å¦‚ Flash èµ·å§‹åœ°å€ï¼‰</strong></p>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒARM Cortex-M å¤„ç†å™¨ä¼šä»åœ°å€ <strong>0x08000000</strong>ï¼ˆå³ Flash èµ·å§‹åœ°å€ï¼‰è¯»å–ï¼š
<ul>
<li><code>0x08000000</code>ï¼šåˆå§‹ <strong>MSPï¼ˆMain Stack Pointerï¼‰</strong></li>
<li><code>0x08000004</code>ï¼š<strong>Reset Handler çš„åœ°å€</strong>ï¼Œä¹Ÿå°±æ˜¯ä¸»ç¨‹åºçš„å…¥å£ç‚¹</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>è®¾ç½® MSP</strong></p>
</li>
</ol>
<ul>
<li>å¤„ç†å™¨å°† <code>0x08000000</code> å¤„çš„å€¼åŠ è½½åˆ° MSPï¼ˆMain Stack Pointerï¼‰ï¼Œä¸ºå †æ ˆåˆå§‹åŒ–ã€‚</li>
</ul>
<ol start="4">
<li><strong>è·³è½¬åˆ° Reset Handler</strong>
<ul>
<li>å¤„ç†å™¨å°† <code>0x08000004</code> å¤„çš„å€¼ä½œä¸ºç¨‹åºè®¡æ•°å™¨ PCï¼Œå¼€å§‹æ‰§è¡Œå®é™…ç¨‹åºã€‚</li>
</ul>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®ä¸»æ ˆæŒ‡é’ˆ</span></span><br><span class="line">__ASM <span class="type">void</span> <span class="title function_">MSR_SP</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	MSR MSP, r0;</span><br><span class="line">	BX r14;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·³è½¬åˆ°AåŒºåº”ç”¨ç¨‹åº</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LOAD_A</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>((*(<span class="type">uint32_t</span> *)addr &gt;= <span class="number">0x20000000</span>) &amp;&amp; (*(<span class="type">uint32_t</span> *)addr &lt;= <span class="number">0x20004FFF</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		MSR_SP(*(<span class="type">uint32_t</span> *)addr);</span><br><span class="line">		load_A = (load_a)*(<span class="type">uint32_t</span> *)(addr + <span class="number">4</span>);</span><br><span class="line">		load_A();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		uprintf(<span class="string">&quot;Failed to jump to Area A \r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="sramåœ¨æ­¤çš„æ„ä¹‰"><a class="markdownIt-Anchor" href="#sramåœ¨æ­¤çš„æ„ä¹‰"></a> SRAMåœ¨æ­¤çš„æ„ä¹‰</h2>
<ul>
<li>
<p>SRAMï¼ˆStatic RAMï¼‰æ˜¯ MCU çš„è¿è¡Œå†…å­˜ï¼ˆRAMï¼‰ï¼Œæ ˆã€å…¨å±€å˜é‡ã€å±€éƒ¨å˜é‡éƒ½å­˜æ”¾åœ¨è¿™é‡Œã€‚</p>
</li>
<li>
<p>MSP æŒ‡é’ˆä¸€èˆ¬ä¼šæŒ‡å‘ SRAM çš„é¡¶ç«¯ï¼ˆä¾‹å¦‚ <code>0x20000000</code>ï¼‰ï¼Œå‘ä¸‹å¢é•¿ã€‚</p>
</li>
<li>
<p>åº”ç”¨ç¨‹åºè¿è¡ŒæœŸé—´æ‰€æœ‰åŠ¨æ€æ•°æ®ã€å †æ ˆå¸§ç­‰éƒ½å­˜åœ¨äº SRAM ä¸­ã€‚</p>
</li>
</ul>
<h2 id="appç¨‹åºé…ç½®"><a class="markdownIt-Anchor" href="#appç¨‹åºé…ç½®"></a> APPç¨‹åºé…ç½®</h2>
<ol>
<li>
<p>system_stm32f10x.cæ–‡ä»¶ä¸­çš„VECT_TAB_OFFSETï¼Œè®¾ç½®0x5000</p>
</li>
<li>
<p>é…ç½®Target</p>
</li>
</ol>
<p><img src="https://s2.loli.net/2025/07/24/r9UhFepacuX4bDy.png" alt="" /></p>
<h2 id="dmaå¦‚ä½•é…ç½®rx_buffer-1é…åˆidleå®ç°æ¥æ”¶ä¸å®šé•¿æ•°æ®"><a class="markdownIt-Anchor" href="#dmaå¦‚ä½•é…ç½®rx_buffer-1é…åˆidleå®ç°æ¥æ”¶ä¸å®šé•¿æ•°æ®"></a> DMAå¦‚ä½•é…ç½®RX_BUFFER + 1é…åˆIDLEå®ç°æ¥æ”¶ä¸å®šé•¿æ•°æ®</h2>
<ol>
<li>
<p><strong>DMAè®¾ç½®</strong>ï¼šä¼ è¾“è®¡æ•°ä¸ºRX_BUFFER + 1</p>
</li>
<li>
<p><strong>IDLEè§¦å‘</strong>ï¼šå½“æ¥æ”¶æ•°æ®é•¿åº¦å°äºè®¾ç½®è®¡æ•°æ—¶è§¦å‘</p>
</li>
<li>
<p><strong>é•¿åº¦è®¡ç®—</strong>ï¼šé€šè¿‡å‰©ä½™è®¡æ•°è®¡ç®—å®é™…æ¥æ”¶é•¿åº¦</p>
</li>
<li>
<p><strong>é‡æ–°é…ç½®</strong>ï¼šæ¯æ¬¡IDLEä¸­æ–­åé‡æ–°é…ç½®DMA</p>
</li>
</ol>

      </div>
    </div>
</div>

<div class="post-category">

    <div id="p-meta-i">
        
              
                <a class="hover-with-bg" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">åµŒå…¥å¼</a>
              
          
          
              
                <a class="hover-with-bg" href="/tags/STM32/"># STM32</a>
              
                <a class="hover-with-bg" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"># å­¦ä¹ ç¬”è®°</a>
              
          
    </div>
</div>


<div class="post-footer">
  

</div>

</article>


        </div>
        
<footer class="text-center">
    
    
    
    
    
    <p>&copy;  2022 - 2025&nbsp;&nbsp;æœ¬ä¹¦</p>
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme by <a href="https://github.com/oCoke/hexo-theme-miracle" target="_blank">Miracle</a></p>
    
    
</footer>

<div class="p-btn">
    
        <a class="toc-btn" id="toc-btn"><i id="i-menu"></i></a>
    
    
      <a class="toc-btn" id="share-btn"><i>
        <svg t="1670124379155" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2683" width="25" height="25"><path d="M395.946667 234.666667v64H256v469.333333h512V522.666667h64V768a64 64 0 0 1-64 64H256a64 64 0 0 1-64-64V298.666667a64 64 0 0 1 64-64h139.946667z m335.850666-87.914667l150.848 150.826667-158.378666 158.4-45.269334-45.248L748.394667 341.333333H672c-121.685333 0-220.714667 97.024-223.914667 217.941334L448 565.333333v85.333334h-64v-85.333334C384 406.272 512.938667 277.333333 672 277.333333h99.861333l-85.312-85.333333 45.248-45.248z" p-id="2684" fill="var(--first-text-color)"></path></svg>
      </i></a>
    
    <a href="javascript:window.scrollTo({top:0,behavior:'smooth'});" class="click-btn">
      <i id="i-up"></i>
    </a>
</div>

<!-- SCRIPTS -->






<script>
    document.getElementById("btn-dropdown").addEventListener('click', () => {
      toggleClass("#dropdown-menus","display-inline");
    });
    console.log('\n' + ' %c Powered by Hexo Theme Miracle ' + ' %c https://github.com/oCoke/hexo-theme-miracle ' + '\n' + '\n', 'color: #fff; background: #4F9BFA; padding:5px 0;', 'background: #FFF; padding:5px 0;');

    

    
  /* å°å½©è›‹: é¥®èŒ¶å…ˆå•¦ */
  setTimeout(() => {
    var time = new Date();
    if (time.getHours() == 15) {
      let comment = document.createComment(' ä¸‰ç‚¹å‡ åšŸï¼é¥®èŒ¶å…ˆå•¦ï¼ ');
      document.body.insertBefore(comment, document.getElementsByTagName('header')[0]);
    }
  },1);
    
</script>


<script>
    var postImg = document.querySelectorAll("article[class=page] img");
    for (let imgi = 0; imgi < postImg.length; imgi++) {
        postImg[imgi].onclick = () => {
            let zoomImg = document.createElement("div");
            zoomImg.id = "zoomImg";
            zoomImg.innerHTML = `<div id="zoom-picture"></div>
    <div class="poptrox-overlay"
        style="position: fixed; left: 0px; top: 0px; z-index: 20000; width: 100%; height: 100%; text-align: center; cursor: zoom-out; opacity: 1;">
        <div style="display:inline-block;height:100%;vertical-align:middle;"></div>
        <div
            style="position:absolute;left:0;top:0;width:100%;height:100%;background:#000000;opacity:0;filter:alpha(opacity=0);">
        </div>
        <div class="poptrox-popup"
            style="display: inline-block; vertical-align: middle; position: relative; z-index: 1; cursor: zoom-out; min-width: 10px; min-height: 10px; width: auto; height: auto;">
            <div class="loader" style="display: none;"></div>
            <div class="pic" style="text-indent: 0px;"><img
                    src="${ postImg[imgi].srcset || postImg[imgi].src }" alt="Loading..."
                    style="vertical-align: bottom; max-width: 85vw; max-height: 85vh;"></div>
        </div>
    </div>`;
            document.body.appendChild(zoomImg);
                document.querySelector("#zoomImg").onclick = () => {
                    document.querySelector("#zoomImg").remove();
                }
        }
    }
    
</script>




    <script>
        query("#toc-btn")[0].onclick = () => {
            if (query(".post-toc")[0].innerHTML) {
                toggleClass(".post-toc", "display-inline");
            }
        }

        if (!query(".post-toc")[0].innerHTML) {
            addClass("#toc-btn","display-none");
        }
    </script>



    <script>
        query("#share-btn")[0].onclick = async () => {
            let url = `${location.protocol}//${location.hostname}${location.port ? ":"+location.port:location.port}${location.pathname}#read=${sessionStorage.getItem(location.pathname+"_read_y") || ""}`;
            try {
                await navigator.clipboard.writeText(url);
                prompt_core("åˆ†äº«é“¾æ¥å·²ç»å¤åˆ¶è‡³å‰ªè´´æ¿", 4800, true);
            } catch(e) {
                prompt_core("åˆ†äº«é“¾æ¥å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶<br/>"+url, 4800, false);
            }
        }
    </script>







    <script>
        const getScrollPosition = (el = window) => ({
            x: el.pageXOffset !== undefined ? el.pageXOffset : el.scrollLeft,
            y: el.pageYOffset !== undefined ? el.pageYOffset : el.scrollTop
        });
        // æ­¤å¤„çš„ 750 æ˜¯ã€Œé¡µé¢å…ƒç´ çš„æœ€å¤§å®½åº¦ã€
        var wx = document.getElementsByClassName("article-m")[0].clientWidth;
        var wy = document.getElementsByClassName("article-m")[0].clientHeight;
        function windowScroll() {
            // åå¤ä¿®æ”¹ ç¡®ä¿é¡µé¢å°ºå¯¸ä¸æ”¹å˜
            wx = document.getElementsByClassName("article-m")[0].clientWidth;
            wy = document.getElementsByClassName("article-m")[0].clientHeight;
            let y = Math.round(getScrollPosition().y);
            // console.log(y);
            // ç»„åˆå­—ç¬¦ä¸²ï¼ŒåŒæ—¶è®°å½•é¡µé¢åæ ‡ï¼Œé¡µé¢å®½åº¦å’Œé«˜åº¦
            let p = `${y}:${wx}:${wy}`;
            // å†™å…¥åˆ° sessionStorage ä¸­
            sessionStorage.setItem(location.pathname + "_read_y", p);
        }
        // URL ä¸­æ˜¯å¦åŒ…å«ä¼ é€’çš„åæ ‡ä¿¡æ¯
        setTimeout(() => {
            if (location.hash.split("#read=").length > 1) {
                prompt_core("å·²æœ‰é˜…è¯»è¿›åº¦ï¼Œæ­£åœ¨è·³è½¬", 4800, true);
                // åˆ†ç¦»å­—ç¬¦ä¸²
                let read_y = location.hash.split("#read=")[1];
                read_y = read_y.split(":");
                // ç»„åˆä¹˜ç§¯ï¼Œé¡ºæ»‘ç§»åŠ¨è‡³åæ ‡
                window.scrollTo({top: Math.round(Number(read_y[0]) * Number(read_y[1] * Number(read_y[2] / wx / wy))), behavior: "smooth"});
            } else {
                // ä» sessionStorage ä¸­è·å–
                let read_y = sessionStorage.getItem(location.pathname + "_read_y") || "0:0:0";
                read_y = read_y.split(":");
                if (read_y[0] != "0") prompt_core("å·²æœ‰é˜…è¯»è¿›åº¦ï¼Œæ­£åœ¨è·³è½¬", 4800, true);
                window.scrollTo({top: Math.round(Number(read_y[0]) * Number(read_y[1] * Number(read_y[2] / wx / wy))), behavior: "smooth"});
            }
        }, 500);
        window.onscroll = windowScroll;
    </script>





        </div>
        <div id="css-loading">
            <h3 class="text-center">åŠ è½½ä¸­...</h3>
        </div>
        
    </body>
</html>
