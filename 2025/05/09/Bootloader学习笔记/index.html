<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    
    <link rel="apple-touch-icon" sizes="76x76" href="/null">
    <link rel="icon" type="image/png" href="/null">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>Bootloaderå­¦ä¹ ç¬”è®° - Ben Shu &#39;s Blog</title>
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    
    <meta name="description" content="">
    <meta name="author" content="Big Ben">
    <meta name="keywords" content="">
    <meta property="og:title" content="Bootloaderå­¦ä¹ ç¬”è®°"/>
    <style>


    
    :root{
        --shadow-color: rgba(0,0,0,0.2);
        --sec-shadow: rgba(0,0,0,0.03);
        --shadow-hover-color: rgba(0,0,0,0.28);
        --first-text-color: #475b6d;
        --second-text-color: #37475b;
        --third-text-color: #858585;
        --default-text-color: #505050;
        --default-link-color: #007bff;
        --link-color: #000000;
        --second-link-color: #4F9BFA;
        --code-color:rgba(27,31,35,.05);
        --post-bkg-color: #fff;
        --page-bkg-color: #f2f5f8;
        --nav-a-hover-color: #3498db;
        --post-sec-text-color: #718096;
        --sec-bkg: #f2f5f8;
        --color-mode: 'light';
        --bkg-h: rgba(255,255,255,0.6);
        --bkg-m: #e1e4e8;
        --home-title-color: #4169E1;
        --shadow: 0 4px 10px rgba(0,2,4,0.06),0 0 1px rgba(0,2,4,0.11);
        --hr-color: #ddd;
        --bg-t: #f4f4f4;
        --nav-bkg: rgba(255,255,255,0.6);
    }

@media (prefers-color-scheme: dark) {
  :root {
    --color-mode: 'dark';
  }

  :root:not([data-theme]) {
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
  }
}

[data-theme='dark'] {
    --shadow-color: rgba(0,0,0,0.2);
    --shadow-hover-color: rgba(0,0,0,0.28);
    --first-text-color: hsla(0,0%,100%,0.92);
    --second-text-color: hsla(0,0%,100%,0.86);
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #252d38;
    --page-bkg-color: #181c27;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
    --bkg-h: rgba(255,255,255,0.2);
    --bkg-m: rgba(255,255,255,0.1);
    --home-title-color: rgb(226, 82, 90);
    --code-color:#3e4b5e;
    --shadow: none;
    --hr-color: #718096;
    --bg-t: #364151;
    --nav-bkg: rgba(13,17,23,0.6);
}

</style>



<style>
#page-main,footer,.p-btn{
    display: none;
}
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
}
body {
    background-color: var(--page-bkg-color);
    color: var(--second-text-color);
    overflow-y: scroll;
    overflow-x: hidden;
    transition: all .3s;
}
a {
    color: var(--default-link-color);
    text-decoration: none;
    background-color: transparent;
}
a:hover{
    color: var(--second-link-color);
}
.main-content,.post-card-main{
    margin: 30px;
}



@media (max-width: 410px){
    .post-card-main{
        max-width: 350px!important;
    }
}

@media (max-width: 980px){
    .post-card-main{
        max-width: 520px!important;
    }
}


@media (min-width: 780px){ 
    h3{
        font-size: 1.5rem;
        line-height: 1.5em;
    }
}
@media (min-width: 1280px){ 
    h3{
        font-size: 1.7rem;
        line-height: 1.5em;
    }
}
@media (min-width: 2096px){ 
    h3{
        font-size: 1.8rem;
        line-height: 1.5em;
    }
}

.text-center{
    text-align: center!important;
}
.middle-center{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    height: 100%;
}
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    height: 54px;
    padding: 0 1.25rem;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    border-bottom: 1px solid var(--bkg-m);
    background-color: var(--nav-bkg);
    backdrop-filter: blur(4px);
    transition: all .3s;
}
header .header__left, header .header__right {
    display: flex;
    align-items: center;
    font-family: rubik,sans-serif,Varela Round;
}
header .header__left .logo__text {
    font-size: 18px;
    font-weight: 450;
    padding: 14.5px 10px;
    border-radius: 5px;
    color: var(--second-text-color);
}
header .header__right .navbar__menus {
    height: 54px;
    padding: 0 0 0 15px;
}
header .header__right .button {
    color: var(--second-text-color);
}
header .header__right .navbar__menus .navbar-menu {
    display: inline-block;
    align-items: center;
    height: 54px;
    padding: 0 10px;
    font-size: 16px;
    line-height: 54px;
}
header .header__right .dropdown-icon {
    display: none;
    height: 54px;
    padding: 15px 10px;
    border: 0;
    background-color: transparent;
}
header .header__right .dropdown-menus {
    line-height: 2rem;
    animation: slide-in .15s ease 1;
    display: none;
    position: absolute;
    left: 12px;
    right: 12px;
    top: calc(54px + 10px);
    border-radius: 6px;
    padding: 24px;
    background-color: var(--page-bkg-color);
    border: 1px solid var(--bkg-m);
    z-index: 9999;
    justify-items: center;
    justify-content: center;
    flex-direction: column;
}
header .header__right #btn-search, header .header__right #btn-toggle-dark{
    display: inline-block;
    padding:  18px 10px;
    height: 25px;
}
header .header__right #btn-dropdown{
  display: inline-block;
  padding:  13.5px 0;
}
header .header__right .dropdown-menus .dropdown-menu {
    padding: 10px;
    color: var(--second-text-color);
}
@media screen and (max-width: 764px){
.navbar__menus {
    display: none!important;
}
.dropdown-icon {
    display: inline-block!important;
}
}
.p-btn{
    position: fixed;
    bottom: 1.2rem;
    right: 1.2rem;
    contain: layout;
}
.toc-btn,.click-btn{
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    align-items: center;
    margin-top: .5rem;
    font-size: .75rem;
    background-color: var(--sec-bkg);
    display: block;
    padding: 0.9rem;
    box-shadow: 0 0.3rem 0.6rem rgba(48,55,66,.15);
    border: none;
    border-radius: 0.5rem;
    line-height: 1;
    color: var(--first-text-color);
}
.toc-link{
    color: var(--second-text-color);
}

#css-loading h3{
    font-weight: 500;
    font-size: 1.4rem;
    text-align: center;
    position: fixed;
    top: 200px;
    left: 0;
    right: 0;
    opacity: 0;
    animation: cssLoad;
    animation-delay: 0.3s;
    -webkit-animation: cssLoad;
    -webkit-animation-delay: 0.3s;
}
@keyframes cssLoad {
    from {
        opacity: 0;
    }
    to {
        opacity: 0.9;
    }
}


.memorial {
    -webkit-filter: grayscale(100%);
    -moz-filter: grayscale(100%);
    -ms-filter: grayscale(100%);
    -o-filter: grayscale(100%);
    filter: grayscale(100%);
    filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1); filter:gray;
}


    .post-copyright:after {
        position: absolute;
        color: #fff;
        background: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");
        content: ' ';
        height: 10rem;
        width: 10rem;
        right: -2rem;
        top: -2rem;
        opacity: .1;
    }

</style>

    

    
        <!--
        <link rel="stylesheet" href="/css/page.css" media="print"
            onload="this.media='all';this.onload=null">
        <noscript>-->
            <link rel="stylesheet" href="/css/page.css">
        <!--</noscript>-->
    
    
    <link rel="stylesheet" href="/css/main.css" media="print" onload="this.media='all';this.onload=null">
    <noscript>
        <link rel="stylesheet" href="/css/main.css">
    </noscript>

    
    <script src="/js/main.js"></script>
    
      
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

    <body>
        <header>
            
<div class="header__left">
	<a href="/" class="button"><span class="logo__text">ä¸»é¡µ</span></a>
</div>
<div class="header__right">
	<div class="navbar__menus">
		
		<a href="/" class="button">
			<div class="navbar-menu">é¦–é¡µ</div>
		</a>
		
		<a href="/archives/" class="button">
			<div class="navbar-menu">å½’æ¡£</div>
		</a>
		
		<a href="/categories/" class="button">
			<div class="navbar-menu">åˆ†ç±»</div>
		</a>
		
		<a href="/tags/" class="button">
			<div class="navbar-menu">æ ‡ç­¾</div>
		</a>
		
		<a href="/about/" class="button">
			<div class="navbar-menu">å…³äº</div>
		</a>
		
	</div>
	
	<a href="/search/" class="button">
		<div id="btn-search">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32">
				<path
					d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z">
				</path>
			</svg>
		</div>
	</a>
	
	<a href="javaScript:void(0);" class="button" id="btn-toggle-dark">
		<div>
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none"
				stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
			</svg>
		</div>
	</a>
	<a href="javaScript:void(0);" class="dropdown-icon button">
		<div id="btn-dropdown">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor"
				stroke="currentColor" stroke-width="32" stroke-linecap="round">
				<path
					d="M903.43 561.52H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 204.31H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 918.73H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24z"
					fill="currentColor"></path>
			</svg>
		</div>
	</a>
	<div class="dropdown-menus" id="dropdown-menus">
		
		<a href="/" class="dropdown-menu button">é¦–é¡µ</a>
		<br>
		
		<a href="/archives/" class="dropdown-menu button">å½’æ¡£</a>
		<br>
		
		<a href="/categories/" class="dropdown-menu button">åˆ†ç±»</a>
		<br>
		
		<a href="/tags/" class="dropdown-menu button">æ ‡ç­¾</a>
		<br>
		
		<a href="/about/" class="dropdown-menu button">å…³äº</a>
		<br>
		
	</div>
</div>

        </header>
        <div id="top"></div>
        <div id="page-main" class="main-content">
        <div class="mg-top">
            

<article class="page">
<div id="post-meta-m">
    <div class="post-meta" id="post-meta">
  <h3>Bootloaderå­¦ä¹ ç¬”è®°</h3>
    
      <span class="post-meta-label">
        Big Ben
      </span>
    
    
      <span class="post-meta-label">
        <span class="p-dot"></span>
        <time datetime="2025-05-09 12:31" pubdate>
          2025-05-09
        </time>
      </span>
    
    
      
      <span class="post-meta">
        <span class="p-dot"></span>
        å…± 2.6k å­—
      </span>
    
    
    
  </div>
  
</div>
<div class="article-m">
  <div class="post-toc">
    
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bootloaderiap"><span class="toc-number">1.</span> <span class="toc-text"> Bootloader+IAP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E8%A6%81%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.</span> <span class="toc-text"> ç®€è¦è¯´æ˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%8C%BA"><span class="toc-number">1.2.</span> <span class="toc-text"> åˆ†åŒº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text"> æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text"> ç¼–ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E4%B8%8Edma"><span class="toc-number">1.4.1.</span> <span class="toc-text"> ä¸²å£ä¸DMA</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#h%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.4.1.0.1.</span> <span class="toc-text"> .hç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%B2%E5%8F%A3"><span class="toc-number">1.4.1.1.</span> <span class="toc-text"> é…ç½®ä¸²å£</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.4.1.1.1.</span> <span class="toc-text"> .cç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEdma"><span class="toc-number">1.4.1.2.</span> <span class="toc-text"> é…ç½®DMA</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E7%A8%8B%E5%BA%8F-2"><span class="toc-number">1.4.1.2.1.</span> <span class="toc-text"> .cç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E7%A9%BA%E9%97%B2%E4%B8%AD%E6%96%AD%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.1.3.</span> <span class="toc-text"> ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E7%A8%8B%E5%BA%8F-3"><span class="toc-number">1.4.1.3.1.</span> <span class="toc-text"> .cç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%96%B0%E7%9A%84printf%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.1.4.</span> <span class="toc-text"> ç¼–å†™æ–°çš„Printfå‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#i2c"><span class="toc-number">1.4.2.</span> <span class="toc-text"> I2C</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#h%E7%A8%8B%E5%BA%8F-2"><span class="toc-number">1.4.2.1.</span> <span class="toc-text"> .hç¨‹åº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#delay"><span class="toc-number">1.4.2.2.</span> <span class="toc-text"> Delay</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-start%E5%92%8Cstop%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.4.2.3.</span> <span class="toc-text"> åˆå§‹åŒ–ã€STARTå’ŒSTOPä¿¡å·</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82"><span class="toc-number">1.4.2.4.</span> <span class="toc-text"> å‘é€ä¸€ä¸ªå­—èŠ‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82"><span class="toc-number">1.4.2.5.</span> <span class="toc-text"> è¯»å–ä¸€ä¸ªå­—èŠ‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%89%E5%BE%85%E4%BB%8E%E6%9C%BAack"><span class="toc-number">1.4.2.6.</span> <span class="toc-text"> ç­‰å¾…ä»æœºACK</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#at24c02-e2proms"><span class="toc-number">1.4.3.</span> <span class="toc-text"> AT24C02-E2PROMS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5"><span class="toc-number">1.4.3.1.</span> <span class="toc-text"> å†™å…¥</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#byte-write"><span class="toc-number">1.4.3.1.1.</span> <span class="toc-text"> Byte Write</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#page-write"><span class="toc-number">1.4.3.1.2.</span> <span class="toc-text"> Page Write</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96"><span class="toc-number">1.4.3.2.</span> <span class="toc-text"> è¯»å–</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#xmodem%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text"> Xmodemåè®®</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text"> æ ¼å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text"> æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">2.3.</span> <span class="toc-text"> ä¾‹å­</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#crc16%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.4.</span> <span class="toc-text"> CRC16ç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text"> å‚è€ƒ</span></a></li></ol>
    
  </div>
    <div id="article">
      <div id="post-content" class="markdown-body textretty">
        <h1 id="bootloaderiap"><a class="markdownIt-Anchor" href="#bootloaderiap"></a> Bootloader+IAP</h1>
<h2 id="ç®€è¦è¯´æ˜"><a class="markdownIt-Anchor" href="#ç®€è¦è¯´æ˜"></a> ç®€è¦è¯´æ˜</h2>
<p>æœ¬å­¦ä¹ ç¬”è®°ä¸»è¦åŒ…æ‹¬STM32F103ä¸‹çš„Bootloader+IAP</p>
<p>Bootloaderï¼šç”¨äºæ›´æ–°APPçš„ç¨‹åº</p>
<p>IAPï¼šåœ¨è®¾å¤‡è¿è¡Œæ—¶ï¼Œç”±Bootloaderå¼•å¯¼å¯¹è‡ªèº«ç¨‹åºæ“¦å†™</p>
<p>OTAï¼šæ— çº¿é€šä¿¡å°†æ–°çš„å›ºä»¶ä¸‹è½½åˆ°è®¾å¤‡ä¸­ï¼ˆOn the Airï¼‰</p>
<h2 id="åˆ†åŒº"><a class="markdownIt-Anchor" href="#åˆ†åŒº"></a> åˆ†åŒº</h2>
<p>AåŒºå­˜æ”¾APPï¼ŒBåŒºå­˜æ”¾Bootloaderç¨‹åºã€‚<strong>OTA_Flagè¡¨ç¤ºæ˜¯å¦æ›´æ–°APPï¼Œå­˜æ”¾åœ¨24C02ä¸­</strong></p>
<ol>
<li>
<p>âŒï¸<strong>æ ˆæŒ‡é’ˆ</strong>â€”&gt;<strong>| A | B |</strong>------&gt;ç¨‹åºè¿è¡Œåï¼Œå…ˆè¿›å…¥Aï¼Œå¯ä¸é€šè¿‡Bè¿›å…¥APPï¼›è‹¥OTA_Flag=1å¼€å§‹æ›´æ–°æ•°æ®ï¼Œå½“æ²¡æœ‰å®Œå…¨æ›´æ–°å®ŒAåå‡ºç°å¼‚å¸¸ï¼Œå†ä¸‹ä¸€æ¬¡ä¸Šç”µè¿è¡ŒAå‘ç°ç¨‹åºä¸å…¨ï¼Œ<strong>æ‚²æŠ¥ï¼Œæˆç –å¤´äº†</strong>ã€‚</p>
</li>
<li>
<p>âœ”ï¸<strong>æ ˆæŒ‡é’ˆ</strong>â€”&gt;<strong>| B | A |</strong>------&gt;ç¨‹åºè¿è¡Œåï¼Œå…ˆè¿›å…¥Bï¼Œè§‚å¯ŸOTA_Flag=1å¼€å§‹å¯¹Aæ›´æ–°æ•°æ®ï¼Œå¼‚å¸¸é€€å‡ºåä»ç„¶æ˜¯è¿›å…¥Bå¯¹Aè¿›è¡Œæ›´æ–°ï¼Œæ›´æ–°å®Œæˆåä½¿OTA_Flag=0ã€‚</p>
</li>
</ol>
<h2 id="æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆ"></a> æ–¹æ¡ˆ</h2>
<p>ğŸ¦<strong>DMA + ç©ºé—²ä¸­æ–­</strong></p>
<p><strong>DMA</strong>è´Ÿè´£åœ¨æ— éœ€CPUå¸®åŠ©ä¸‹ï¼Œå¤–è®¾ä¸å¯„å­˜å™¨ä¹‹é—´<strong>ä¼ è¾“æ•°æ®</strong></p>
<p><strong>ç©ºé—²ä¸­æ–­</strong>è¡¨ç¤º<strong>æ¥æ”¶å®Œæˆ</strong></p>
<p><strong>çª—å£æ¥æ”¶ç¼“å†²åŒº</strong>ï¼š<strong>æ•°æ®ä¼ è¾“</strong>è¿‡ç¨‹ä¸­ï¼Œ<strong>æ¥æ”¶é€Ÿåº¦å’Œå¤„ç†é€Ÿåº¦ä¸ä¸€å®šä¸€è‡´</strong>ï¼Œå› æ­¤<strong>éœ€è¦ç¼“å†²åŒºå…ˆä¿å­˜æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±</strong>ï¼›ä¸€ç»´æ•°ç»„ï¼Œç¡®è®¤<strong>å•æ¬¡æ¥æ”¶æœ€å¤§é‡</strong>ï¼Œé˜²æ­¢å‡ºç°è¶Šç•Œé—®é¢˜</p>
<p><strong>ç¼“å†²åŒºçš„æ„ä¹‰</strong>ï¼š<strong>DMAå‘é€çš„æ•°æ®é‡å¤§äºè¦æ¥æ”¶çš„é‡</strong>ï¼Œé™¤éç©ºé—²ä¸­æ–­å‘ç”Ÿï¼Œå¦åˆ™å®ƒæ°¸è¿œä¸ä¼šå®Œæˆ</p>
<p><strong>SEæŒ‡é’ˆå¯¹</strong>ï¼šç¼“å†²åŒºæ˜¯ä¸€ç»´æ•°ç»„ï¼Œå…±é•¿<strong>2048Bit</strong>ï¼Œæ¯ä¸€æ¬¡å‘é€<strong>200Bit</strong>ï¼Œåˆ†æˆ10å—ï¼›æ¯ä¸€å—<strong>å¼€å¤´SæŒ‡é’ˆ</strong>ï¼ˆINï¼‰ï¼Œ<strong>ç»“å°¾EæŒ‡é’ˆ</strong>ï¼ˆOUTï¼‰ï¼›è‹¥<strong>IN != OUT</strong>ï¼Œä»£è¡¨<strong>ç¼“å†²åŒºä¸­å­˜åœ¨æ•°æ®</strong>ï¼Œå†å¾€ä¸‹åˆ¤æ–­<strong>ç›´åˆ°IN == OUT</strong>ç»“æŸï¼›<strong>ENDæ˜¯æœ€åä¸€å—è¾¹ç•Œæ ‡è®°</strong>ï¼Œä¸å…è®¸è¶…è¿‡ã€‚</p>
<img src="https://s2.loli.net/2025/05/09/ItwM21gaURXiGLh.png" style="zoom: 50%;" />
<p>â—TIPï¼šæ¯æ¬¡æ¥æ”¶åï¼Œéƒ½<strong>éœ€è¦åˆ¤æ–­å‰©ä½™ç©ºé—´</strong>ï¼Œä»¥é˜²å†…å­˜ä¸è¶³ï¼ŒåŠæ—¶å›å·ï¼›éœ€è¦ä¸€ä¸ªå·²ç»å­˜æ”¾çš„<strong>ç´¯åŠ å€¼</strong></p>
<h2 id="ç¼–ç¨‹"><a class="markdownIt-Anchor" href="#ç¼–ç¨‹"></a> ç¼–ç¨‹</h2>
<p>STM32F103ä½¿ç”¨å¤–éƒ¨é«˜é€Ÿæ—¶é’ŸHSEï¼Œ8MHzï¼›é€šè¿‡PLLï¼ˆå€é¢‘é”ç›¸ç¯ï¼‰å¾—åˆ°72MHz</p>
<h3 id="ä¸²å£ä¸dma"><a class="markdownIt-Anchor" href="#ä¸²å£ä¸dma"></a> ä¸²å£ä¸DMA</h3>
<h5 id="hç¨‹åº"><a class="markdownIt-Anchor" href="#hç¨‹åº"></a> .hç¨‹åº</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> U1_RX_SIZE 2048 		<span class="comment">// æ•°æ®ç•Œé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> U1_TX_SIZE 2048</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> U1_RX_MAX 256 			<span class="comment">// æ¯æ¬¡æ¥æ”¶çš„æ•°æ®ï¼Œä»£è¡¨ä¸€ç»„æ•°æ®</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 10 					<span class="comment">// æ¥æ”¶çš„æœ€å¤§ç»„æ•°</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// USART1æ¥æ”¶å’Œå‘é€ç¼“å†²åŒº</span></span><br><span class="line"><span class="type">uint8_t</span> U1_RX_Buff[U1_RX_SIZE];</span><br><span class="line"><span class="type">uint8_t</span> U1_TX_Buff[U1_TX_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸä¸€ç»„æ•°æ®æ¥æ”¶å¼€å§‹ä¸ç»“æŸï¼Œ startï¼šå¼€å§‹ï¼Œ endï¼šç»“å°¾</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> *start;</span><br><span class="line">    <span class="type">uint8_t</span> *end;</span><br><span class="line">&#125; UCB_URxBuff;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç®¡ç†ä¸²å£æ¥æ”¶æ•°æ®</span></span><br><span class="line"><span class="comment">   URxCounter	å½“å‰ç¼“å†²åŒºä¸­æœªå¤„ç†çš„æ•°æ®é‡</span></span><br><span class="line"><span class="comment">   URxDataPtr	ç¼“å†²åŒºå­˜å‚¨æ•°ç»„åºå·</span></span><br><span class="line"><span class="comment">   URxDataIN	æŒ‡å‘ä¸‹ä¸€ç»„å¯å†™å…¥æ•°æ®çš„ä½ç½®</span></span><br><span class="line"><span class="comment">   URxDataOUT	æŒ‡å‘ä¸‹ä¸€ä¸ªå¾…è¯»å–æ•°æ®çš„ä½ç½®</span></span><br><span class="line"><span class="comment">   URxDataEND	æŒ‡å‘æ•°ç»„æœ«å°¾	*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> URxCounter;</span><br><span class="line">    UCB_URxBuff URxDataPtr[NUM];</span><br><span class="line">    UCB_URxBuff *URxDataIN;</span><br><span class="line">    UCB_URxBuff *URxDataOUT;</span><br><span class="line">    UCB_URxBuff *URxDataEND;</span><br><span class="line">&#125; UCB_CB;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®ä¸²å£"><a class="markdownIt-Anchor" href="#é…ç½®ä¸²å£"></a> é…ç½®ä¸²å£</h4>
<ol>
<li>
<p>è®¾ç½®ç›¸å…³<strong>å¤–è®¾æ—¶é’Ÿ</strong></p>
</li>
<li>
<p>åˆå§‹åŒ–<strong>GPIO(IOåˆ†åŒº,MODE,é¢‘ç‡,IOå£)</strong></p>
</li>
<li>
<p><strong>å¤ä½ä¸²å£</strong></p>
</li>
<li>
<p>é…ç½®<strong>ä¸²å£ï¼ˆåˆå§‹åŒ–ï¼Œæ³¢ç‰¹ç‡ï¼Œæ ¡éªŒï¼Œæ•°æ®ä½é•¿åº¦ï¼Œåœæ­¢ä½ä¸ªæ•°ï¼Œæ¥æ”¶å‘æƒ…å†µï¼‰</strong></p>
</li>
<li>
<p>æ‰“å¼€<strong>ç›¸å…³ä¸­æ–­ï¼ˆIDLEä¸ºç©ºé—²ä¸­æ–­ï¼‰</strong></p>
</li>
<li>
<p><strong>è°ƒç”¨å…¶ä»–åŠŸèƒ½å‡½æ•°</strong></p>
</li>
<li>
<p><strong>ä½¿èƒ½ä¸²å£</strong></p>
</li>
</ol>
<h5 id="cç¨‹åº"><a class="markdownIt-Anchor" href="#cç¨‹åº"></a> .cç¨‹åº</h5>
<p><img src="https://s2.loli.net/2025/05/09/OnjapTsHUrgZX6A.png" alt="" /></p>
<h4 id="é…ç½®dma"><a class="markdownIt-Anchor" href="#é…ç½®dma"></a> é…ç½®DMA</h4>
<ol>
<li>
<p>è®¾ç½®ç›¸å…³<strong>å¤–è®¾æ—¶é’Ÿ</strong></p>
</li>
<li>
<p><strong>å¤ä½DMAï¼ˆDMAï¼Œé€šé“ï¼‰</strong></p>
</li>
<li>
<p><strong>é…ç½®DMAï¼ˆå¤–è®¾åœ°å€ã€å¤–è®¾å®½åº¦ã€å†…å­˜åœ°å€ã€å†…å­˜å®½åº¦ã€ä¼ è¾“æ•°é‡ã€ä¼˜å…ˆçº§ã€å¤–è®¾æ¨¡å¼ã€å†…å­˜æ¨¡å¼ã€æ–¹å‘ï¼‰</strong></p>
</li>
<li>
<p><strong>åˆå§‹åŒ–DMAï¼ˆDMAé€šé“ã€ç»“æ„ä½“ï¼‰</strong></p>
</li>
<li>
<p><strong>è®¾ç½®å¾ªç¯æ–¹å¼</strong></p>
</li>
<li>
<p><strong>ä½¿èƒ½ç›¸å…³é€šé“</strong></p>
</li>
</ol>
<h5 id="cç¨‹åº-2"><a class="markdownIt-Anchor" href="#cç¨‹åº-2"></a> .cç¨‹åº</h5>
<p><img src="https://s2.loli.net/2025/05/09/5vHiYpyeR3Bj8sk.png" alt="" /></p>
<h4 id="ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°"><a class="markdownIt-Anchor" href="#ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°"></a> ä¸²å£ç©ºé—²ä¸­æ–­å‡½æ•°</h4>
<ol>
<li>é…ç½®<strong>ç›¸å…³ç»“æ„ä½“åˆå§‹åŒ–</strong></li>
<li>ç¼–å†™<strong>ç©ºé—²ä¸­æ–­å‡½æ•°</strong>ï¼ˆ<strong>åªæœ‰è¯»æ ‡å¿—ä½å¯„å­˜å™¨å’Œæ•°æ®ä½å¯„å­˜å™¨æ‰èƒ½å°†ç©ºé—²æ ‡å¿—ä½æ¸…é™¤</strong>ï¼‰</li>
<li>åœ¨ç©ºé—²ä¸­æ–­ä¸­<strong>è¯»DMAæœ¬æ¬¡æ·»åŠ çš„æ•°é‡</strong>(DMA,é€šé“)----counter += (æ€»é‡ - å‰©ä½™å€¼)</li>
<li><strong>è®¾ç½®ç¼“å†²åŒºçš„INæŒ‡é’ˆ</strong></li>
<li>Disable DMAï¼Œé‡æ–°é…ç½®DMAï¼ˆDMAï¼Œé€šé“ï¼Œå¤§å°ï¼Œåœ°å€ï¼‰ï¼Œæ°¸è¿œä¸å‡ºç°å®ŒæˆçŠ¶æ€ï¼Œä½¿èƒ½DMA</li>
</ol>
<p><strong>è¦ä¸€ç›´è®©DMAè¯»å–æ•°æ®ï¼Œç›´åˆ°å‡ºç°ç©ºé—²ä¸­æ–­æ‰ä¼šåœæ­¢ï¼Œå› æ­¤ä¸ä¼šå‡ºç°å®ŒæˆçŠ¶æ€</strong></p>
<h5 id="cç¨‹åº-3"><a class="markdownIt-Anchor" href="#cç¨‹åº-3"></a> .cç¨‹åº</h5>
<p><img src="https://s2.loli.net/2025/05/09/AuD6WQVYR2mbt7U.png" alt="" /></p>
<p><img src="https://s2.loli.net/2025/05/09/3uySNRibECUpag7.png" alt="" /></p>
<h4 id="ç¼–å†™æ–°çš„printfå‡½æ•°"><a class="markdownIt-Anchor" href="#ç¼–å†™æ–°çš„printfå‡½æ•°"></a> ç¼–å†™æ–°çš„Printfå‡½æ•°</h4>
<p><img src="https://s2.loli.net/2025/05/09/daQyDsxRGJXrjuC.png" alt="" /></p>
<h3 id="i2c"><a class="markdownIt-Anchor" href="#i2c"></a> I2C</h3>
<p><strong>è½¯ä»¶I2C</strong>ï¼Œå»¶æ—¶éƒ¨åˆ†éœ€è¦è‡ªå·±é‡æ–°è®¾è®¡</p>
<h4 id="hç¨‹åº-2"><a class="markdownIt-Anchor" href="#hç¨‹åº-2"></a> .hç¨‹åº</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SCL_H GPIO_SetBits(GPIOB, GPIO_Pin_6)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCL_L GPIO_ResetBits(GPIOB, GPIO_Pin_6)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDA_H GPIO_SetBits(GPIOB, GPIO_Pin_7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDA_L GPIO_ResetBits(GPIOB, GPIO_Pin_7)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Read_SDA GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_7)</span></span><br></pre></td></tr></table></figure>
<h4 id="delay"><a class="markdownIt-Anchor" href="#delay"></a> Delay</h4>
<p><img src="https://s2.loli.net/2025/05/09/gpyum8SCRIqJYkt.png" alt="" /></p>
<h4 id="åˆå§‹åŒ–-startå’Œstopä¿¡å·"><a class="markdownIt-Anchor" href="#åˆå§‹åŒ–-startå’Œstopä¿¡å·"></a> åˆå§‹åŒ–ã€STARTå’ŒSTOPä¿¡å·</h4>
<ol>
<li>
<p>å¼€å¯<strong>æ—¶é’Ÿ</strong></p>
</li>
<li>
<p>é…ç½®<strong>GPIO</strong>ï¼ˆPB6ï¼ŒPB7ï¼Œå¼€æ¼æ¨¡å¼ï¼‰</p>
</li>
<li>
<p>é…ç½®<strong>SCLå’ŒSDA</strong>ä¸¤æ¡çº¿</p>
</li>
</ol>
<p><strong>èµ·å§‹ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»é«˜ç”µå¹³å˜ä¸ºä½ç”µå¹³</p>
<p><strong>åœæ­¢ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä»ä½ç”µå¹³å˜ä¸ºé«˜ç”µå¹³</p>
<p><strong>æ•°æ®ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDAä¿æŒä¸å˜ï¼›<strong>SCLä½ç”µå¹³ï¼ŒSDAç”µå¹³å¯ä»¥ä¿®æ”¹</strong></p>
<p><strong>åº”ç­”ä¿¡å·</strong>ï¼šSCLé«˜ç”µå¹³ï¼ŒSDA<strong>ä½ç”µå¹³</strong>ï¼Œ<strong>åº”ç­”</strong>ï¼Œå¦åˆ™ï¼Œéåº”ç­”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* åˆå§‹åŒ– */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C1_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C1, ENABLE); <span class="comment">// ä½¿èƒ½I2C1å’ŒGPIOBæ—¶é’Ÿ</span></span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);</span><br><span class="line">    </span><br><span class="line">    GPIO_InitTypeDef GPIO_StructInit;					 <span class="comment">// åˆå§‹åŒ–SCLå¼•è„š(PB6)</span></span><br><span class="line">    GPIO_StructInit.GPIO_Pin = GPIO_Pin_6;</span><br><span class="line">    GPIO_StructInit.GPIO_Mode = GPIO_Mode_Out_OD; 		 <span class="comment">// å¼€æ¼è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">    GPIO_StructInit.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOB, &amp;GPIO_StructInit);</span><br><span class="line"></span><br><span class="line">    GPIO_StructInit.GPIO_Pin = GPIO_Pin_7;				 <span class="comment">// åˆå§‹åŒ–SDAå¼•è„š(PB7)</span></span><br><span class="line">    GPIO_StructInit.GPIO_Mode = GPIO_Mode_Out_OD; 		 <span class="comment">// å¼€æ¼è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">    GPIO_StructInit.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOB, &amp;GPIO_StructInit);</span><br><span class="line"></span><br><span class="line">    SCL_H;												 <span class="comment">// åˆå§‹çŠ¶æ€æ‹‰é«˜æ€»çº¿</span></span><br><span class="line">    SDA_H;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Startä¿¡å· */</span></span><br><span class="line"><span class="comment">// ä¸€æ—¦ Start äº§ç”Ÿåï¼Œæ•°æ®ä¼ è¾“å¿…é¡»åœ¨ SCL ä¸ºä½æ—¶å¼€å§‹ã€‚</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SCL_H;			<span class="comment">//	SCLé«˜ï¼Œé”æ•°æ®</span></span><br><span class="line">    SDA_H;			<span class="comment">//	SDAé«˜</span></span><br><span class="line">    Delay_us(<span class="number">2</span>);</span><br><span class="line">    SDA_L;			<span class="comment">//	SDAä½</span></span><br><span class="line">    SCL_L;			<span class="comment">//	SCLä½</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Endä¿¡å· */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Stop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SCL_L;			<span class="comment">//	SCLä½</span></span><br><span class="line">    SDA_L;			<span class="comment">//	SDAä½</span></span><br><span class="line">    SCL_H;			<span class="comment">//	SCLé«˜ï¼Œé”æ•°æ®</span></span><br><span class="line">    SDA_H;			<span class="comment">//	SDAé«˜ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å¼€å§‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å‘é€ä¸€ä¸ªå­—èŠ‚"><a class="markdownIt-Anchor" href="#å‘é€ä¸€ä¸ªå­—èŠ‚"></a> å‘é€ä¸€ä¸ªå­—èŠ‚</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendByte</span><span class="params">(<span class="type">uint8_t</span> tx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int8_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        SCL_L;             				<span class="comment">// SCLä½ç”µå¹³</span></span><br><span class="line">        <span class="keyword">if</span> (tx &amp; (<span class="number">1</span> &lt;&lt; i)) 				<span class="comment">// ç§»ä½æ“ä½œ</span></span><br><span class="line">            SDA_H;         				<span class="comment">// å€¼ä¸º1ï¼ŒSDAé«˜ç”µå¹³</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            SDA_L; 						<span class="comment">// å€¼ä¸º0ï¼ŒSDAä½ç”µå¹³</span></span><br><span class="line">        Delay_us(<span class="number">2</span>);</span><br><span class="line">        SCL_H; 							<span class="comment">// SCLé«˜ç”µå¹³ï¼Œé”æ•°æ®</span></span><br><span class="line">        Delay_us(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    SCL_L; 								<span class="comment">// SCLä½ç”µå¹³</span></span><br><span class="line">    SDA_H; 								<span class="comment">// SDAé«˜ç”µå¹³ï¼Œè¡¨ç¤ºNACK,å‘é€å°±ä¸€æ¬¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯»å–ä¸€ä¸ªå­—èŠ‚"><a class="markdownIt-Anchor" href="#è¯»å–ä¸€ä¸ªå­—èŠ‚"></a> è¯»å–ä¸€ä¸ªå­—èŠ‚</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> <span class="title function_">I2C_ReadByte</span><span class="params">(<span class="type">uint8_t</span> ack)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int8_t</span> i;</span><br><span class="line">    <span class="type">uint8_t</span> rx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        SCL_L; 					<span class="comment">// æœ€9ä½ACKç»“æŸï¼Œé˜²æ­¢è¢«è¯¯è®¤ä¸ºæ˜¯å…¶ä»–ä¿¡å·ï¼ŒSCLæ‹‰ä½</span></span><br><span class="line">        Delay_us(<span class="number">2</span>);</span><br><span class="line">        SCL_H;              	<span class="comment">// SCLé«˜ç”µå¹³ï¼Œå‡†å¤‡è¯»SDAæ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (Read_SDA)       	</span><br><span class="line">            rx |= (<span class="number">1</span> &lt;&lt; i); 	<span class="comment">// rxæœ€åˆ0000 0000ï¼Œä½è¿ç®—ï¼Œ1å†™å…¥ï¼Œ0ä¸å˜</span></span><br><span class="line">        Delay_us(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬9ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œæ›´æ”¹ACK/NACK</span></span><br><span class="line">    SCL_L; 						<span class="comment">// SCLé«˜ç”µå¹³ï¼Œå¯ä»¥å˜åŒ–SDA</span></span><br><span class="line">    <span class="keyword">if</span> (ack)</span><br><span class="line">    &#123;</span><br><span class="line">        SDA_L; 					<span class="comment">// SDAä½ç”µå¹³ï¼Œè¡¨ç¤ºACK</span></span><br><span class="line">        SCL_H; 					<span class="comment">// SCLé«˜ç”µå¹³ï¼Œé”æ•°æ®</span></span><br><span class="line">        Delay_us(<span class="number">2</span>);</span><br><span class="line">        SCL_L; 					<span class="comment">// ä¸ºäº†ä¸‹ä¸€å‘¨æœŸï¼Œéœ€è¦å˜åŒ–SDAä¸ºé«˜ç”µå¹³</span></span><br><span class="line">        SDA_H; 					<span class="comment">// SDAé«˜ç”µå¹³ï¼Œä»¥é˜²ä¸‹ä¸€æ¬¡Start</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        SDA_H; 					<span class="comment">// SDAé«˜ç”µå¹³ï¼Œè¡¨ç¤ºNACK</span></span><br><span class="line">        SCL_H; 					<span class="comment">// SCLé«˜ç”µå¹³ï¼Œé”æ•°æ®</span></span><br><span class="line">        Delay_us(<span class="number">2</span>);</span><br><span class="line">        SCL_L; 					<span class="comment">// ä¸ºäº†ä¸‹ä¸€å‘¨æœŸï¼Œéœ€è¦å˜åŒ–SDAä¸ºé«˜ç”µå¹³</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç­‰å¾…ä»æœºack"><a class="markdownIt-Anchor" href="#ç­‰å¾…ä»æœºack"></a> ç­‰å¾…ä»æœºACK</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> <span class="title function_">I2C_Wait_ACK</span><span class="params">(<span class="type">int16_t</span> timeout)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        timeout--;</span><br><span class="line">        Delay_us(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> ((Read_SDA) &amp;&amp; (timeout &gt;= <span class="number">0</span>)); 		<span class="comment">// SDAä½ç”µå¹³è¡¨ç¤ºACK</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; 									<span class="comment">// è¶…æ—¶æ— åº”ç­”</span></span><br><span class="line"></span><br><span class="line">    SCL_H;											<span class="comment">//æ‹‰é«˜SCLï¼Œé”ACK/NACK</span></span><br><span class="line">    Delay_us(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (Read_SDA != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 									<span class="comment">// ä¿¡å·ä¸ç¨³å®š</span></span><br><span class="line"></span><br><span class="line">    SCL_L;											<span class="comment">//æ‹‰ä½ï¼Œå’ŒStarté‚£é‡Œä¸€æ ·</span></span><br><span class="line">    Delay_us(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 										<span class="comment">// åº”ç­”æ­£å¸¸</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="at24c02-e2proms"><a class="markdownIt-Anchor" href="#at24c02-e2proms"></a> AT24C02-E2PROMS</h3>
<p><strong>I2Cé€šä¿¡</strong>ï¼Œè®¾å¤‡åœ°å€ï¼š1 0 10  E2 E1 E0 R/éWï¼›è¯»R=1ï¼Œ0XA1ï¼›å†™W=0;0XA0ï¼Œ<strong>æŒ‰å­—èŠ‚å†™å…¥</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> AT24C02_WADDR 0xA0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AT24C02_RADDR 0xA1</span></span><br></pre></td></tr></table></figure>
<p>AT24C02å…±<strong>16é¡µ</strong>ï¼Œ<strong>ä¸€é¡µ16å­—èŠ‚</strong>ï¼Œå…±256å­—èŠ‚ï¼›<strong>å­˜åœ¨å›å·é—®é¢˜</strong></p>
<h4 id="å†™å…¥"><a class="markdownIt-Anchor" href="#å†™å…¥"></a> å†™å…¥</h4>
<img src="https://s2.loli.net/2025/05/09/4LQS8qFYM3cmdbp.png" style="zoom:80%;" />
<h5 id="byte-write"><a class="markdownIt-Anchor" href="#byte-write"></a> Byte Write</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addr:å†™å…¥çš„EEPROMå†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment">// wdata:å†™å…¥çš„æ•°æ®</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_WriteByte</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> wdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)  			<span class="comment">// 100ä¸ºç­‰å¾…åº”ç­”çš„ä¿¡å·</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;                			<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line"></span><br><span class="line">    I2C_SendByte(addr);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥åœ°å€å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    I2C_SendByte(wdata);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥æ•°æ®å¤±è´¥</span></span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="page-write"><a class="markdownIt-Anchor" href="#page-write"></a> Page Write</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addrï¼šå†™å…¥åœ°å€</span></span><br><span class="line"><span class="comment">// wdataï¼šå†™å…¥æ•°æ®</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_WritePage</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> *wdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> i;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; 							<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line"></span><br><span class="line">    I2C_SendByte(addr);</span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥åœ°å€å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        I2C_SendByte(wdata[i]);</span><br><span class="line">        <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span> + i; 					<span class="comment">// å†™å…¥æ•°æ®å¤±è´¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯»å–"><a class="markdownIt-Anchor" href="#è¯»å–"></a> è¯»å–</h4>
<img src="https://s2.loli.net/2025/05/09/74nb8woeaplzTcr.png" style="zoom:67%;" />
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addrï¼šè¯»å–çš„èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="comment">// rdataï¼šæŒ‡å‘å­˜å‚¨è¯»å–æ•°æ®çš„ç¼“å†²åŒºçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// datalen:è¯»å–æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">AT24C02_ReadData</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> *rdata, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> i;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_WADDR); 			<span class="comment">// å‘é€å†™å…¥ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; 							<span class="comment">// èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line"></span><br><span class="line">    I2C_SendByte(addr); 					<span class="comment">// å†™å…¥è¯»å–åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; 							<span class="comment">// å†™å…¥è¯»å–åœ°å€å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(AT24C02_RADDR); 			<span class="comment">// å‘é€è¯»å–ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (I2C_Wait_ACK(<span class="number">100</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>; 							<span class="comment">// åˆ‡æ¢è¯»æ¨¡å¼æ—¶èŠ¯ç‰‡æ— åº”ç­”</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; datalen - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rdata[i] = I2C_ReadByte(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    rdata[datalen - <span class="number">1</span>] = I2C_ReadByte(<span class="number">0</span>); 	<span class="comment">// è¯»å–æœ€åä¸€ä¸ªå­—èŠ‚æ—¶ä¸å‘é€ACKä¿¡å·</span></span><br><span class="line">    I2C_Stop();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; 								<span class="comment">// æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="xmodemåè®®"><a class="markdownIt-Anchor" href="#xmodemåè®®"></a> Xmodemåè®®</h1>
<h2 id="æ ¼å¼"><a class="markdownIt-Anchor" href="#æ ¼å¼"></a> æ ¼å¼</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Byte1</th>
<th style="text-align:center">Byte2</th>
<th style="text-align:center">Byte3</th>
<th style="text-align:center">Byte4 ~ Byte131</th>
<th style="text-align:center">Byte132 ~ Byte133</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Start of Header(SOH)</td>
<td style="text-align:center">Packet Number</td>
<td style="text-align:center">~(Packet Number)</td>
<td style="text-align:center">Pcacket Data</td>
<td style="text-align:center">CRC16 Check</td>
</tr>
</tbody>
</table>
<h2 id="æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#æŒ‡ä»¤"></a> æŒ‡ä»¤</h2>
<table>
<thead>
<tr>
<th style="text-align:center">ä½</th>
<th style="text-align:center">æŒ‡ä»¤</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SOH</td>
<td style="text-align:center">0x01</td>
<td style="text-align:center">128å­—èŠ‚æ•°æ®åŒ…å¸§å¤´</td>
</tr>
<tr>
<td style="text-align:center">STX</td>
<td style="text-align:center">0x02</td>
<td style="text-align:center">1024å­—èŠ‚æ•°æ®åŒ…å¸§å¤´</td>
</tr>
<tr>
<td style="text-align:center">EOT</td>
<td style="text-align:center">0x04</td>
<td style="text-align:center">ç»“æŸä¼ è¾“</td>
</tr>
<tr>
<td style="text-align:center">ACK</td>
<td style="text-align:center">0x06</td>
<td style="text-align:center">æ­£ç¡®åº”ç­”</td>
</tr>
<tr>
<td style="text-align:center">NAK</td>
<td style="text-align:center">0x15</td>
<td style="text-align:center">é”™è¯¯åº”ç­”ï¼Œé‡ä¼ æ•°æ®</td>
</tr>
<tr>
<td style="text-align:center">CAN</td>
<td style="text-align:center">0x18</td>
<td style="text-align:center">å–æ¶ˆä¼ è¾“</td>
</tr>
<tr>
<td style="text-align:center">CTRLZ</td>
<td style="text-align:center">0x1A</td>
<td style="text-align:center">æ•°æ®å¡«å……</td>
</tr>
<tr>
<td style="text-align:center">HSC</td>
<td style="text-align:center">0x43</td>
<td style="text-align:center">æ¡æ‰‹</td>
</tr>
</tbody>
</table>
<h2 id="ä¾‹å­"><a class="markdownIt-Anchor" href="#ä¾‹å­"></a> ä¾‹å­</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">â€˜Câ€™											<span class="comment">// å‘é€ä¸€ä¸ªCç­‰å¾…æ•°æ®åŒ…</span></span><br><span class="line">											<span class="comment">// (3sä¸€æ¬¡ï¼Œç­‰å¾…åº”ç­”)</span></span><br><span class="line">SOH | <span class="number">0x01</span> | <span class="number">0xFE</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬ä¸€æ¡æŒ‡ä»¤</span></span><br><span class="line">ACKï¼ˆæ­£ç¡®åº”ç­”ï¼‰</span><br><span class="line">SOH | <span class="number">0x02</span> | <span class="number">0xFD</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬äºŒæ¡æŒ‡ä»¤</span></span><br><span class="line">NAKï¼ˆé”™è¯¯åº”ç­”ï¼‰</span><br><span class="line">SOH | <span class="number">0x02</span> | <span class="number">0xFD</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16		<span class="comment">// ç¬¬äºŒæ¡æŒ‡ä»¤</span></span><br><span class="line">ACK</span><br><span class="line">SOH | <span class="number">0x03</span> | <span class="number">0xFC</span> | Data[<span class="number">0</span>~<span class="number">127</span>] | CRC16s	<span class="comment">// ç¬¬ä¸‰æ¡æŒ‡ä»¤</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h2 id="crc16ç¨‹åº"><a class="markdownIt-Anchor" href="#crc16ç¨‹åº"></a> CRC16ç¨‹åº</h2>
<p>STM32æ”¯æŒCRC32ï¼Œä¸æ”¯æŒCRC16ï¼Œéœ€è¦è‡ªå·±å†™</p>
<p>å¤šé¡¹å¼p(x) = <strong>x^16 + x^12 + x^5 + 1</strong>ï¼Œå€ŸåŠ©å¤šé¡¹å¼å°†è¾“å…¥çš„æ•°å€¼è¿›è¡Œ<strong>æ¨¡2é™¤æ³•</strong>ï¼Œåœ¨Cè¯­è¨€ä¸­æ˜¯è¿›è¡Œ<strong>å¼‚æˆ–è¿ç®—</strong>^ã€‚</p>
<p><img src="https://s2.loli.net/2025/05/09/V1B2YkysPQZipdg.png" alt="" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡å­—è¯´æ˜</span></span><br><span class="line">å¯„å­˜å™¨æ¸…é›¶</span><br><span class="line">æ•°æ®æœ€å³è¾¹è¡¥é½Wä½<span class="number">0</span> 							<span class="comment">// Wæ˜¯CRCæ ¡éªŒå€¼çš„ä½æ•°</span></span><br><span class="line">when(è¿˜æœ‰æ•°æ®)&#123;</span><br><span class="line">    å·¦ç§»å¯„å­˜å™¨<span class="number">1</span>ä½ï¼Œè¯»å–æ•°æ®çš„ä¸‹ä¸€ä½åˆ°å¯„å­˜å™¨çš„bit <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (å·¦ç§»å¯„å­˜å™¨æ—¶å‡ºç°æº¢å‡º)&#123;</span><br><span class="line">        å¯„å­˜å™¨ ^= poly;    				<span class="comment">// è¿™é‡Œçš„poly=0011ï¼ŒæŒ‰ç…§ä¸Šé¢çš„ä¾‹å­</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">å¯„å­˜å™¨çš„å€¼å°±æ˜¯æ ¡éªŒå€¼</span><br><span class="line">    </span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">Xmodem_CRC16</span><span class="params">(<span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> datalen)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint8_t</span> i;</span><br><span class="line">	<span class="type">uint16_t</span> Crcinit = <span class="number">0x0000</span>; 	<span class="comment">// åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">	<span class="type">uint16_t</span> Poly = <span class="number">0x1021</span>;	   	<span class="comment">// XMODEM ä½¿ç”¨çš„å¤šé¡¹å¼ï¼šx^16 + x^12 + x^5 + 1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (datalen--)</span><br><span class="line">	&#123;</span><br><span class="line">		Crcinit = (*data &lt;&lt; <span class="number">8</span>) ^ Crcinit;</span><br><span class="line">		<span class="comment">// å·¦ç§»å…«ä½æ˜¯å› ä¸ºCRCæ˜¯é«˜ä½ä¼˜å…ˆè®¡ç®—ï¼Œå¼‚æˆ–æ˜¯ä¸ºäº†æ”¹å˜å½“å‰CRCçš„å€¼</span></span><br><span class="line">		<span class="comment">// å¼‚æˆ–å°†æ–°æ•°æ®â€œæ··åˆâ€è¿›å½“å‰çš„CRCå€¼ï¼Œä½¿CRCè®¡ç®—èƒ½è¦†ç›–æ‰€æœ‰è¾“å…¥æ•°æ®</span></span><br><span class="line">		<span class="comment">// è‹¥ç›´æ¥èµ‹å€¼ä¼šä¸¢å¤±ä¹‹å‰è®¡ç®—çš„CRCå€¼</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">// æ¯ä¸ªbitéƒ½è¦å½±å“CRCè®¡ç®—ï¼Œæ‰€ä»¥å¿…é¡»å¾ªç¯ 8 æ¬¡</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (Crcinit &amp; <span class="number">0x8000</span>) 	<span class="comment">// æ£€æŸ¥æœ€é«˜ä½æ˜¯å¦ä¸º1</span></span><br><span class="line">				Crcinit = (Crcinit &lt;&lt; <span class="number">1</span>) ^ Poly;</span><br><span class="line">			<span class="comment">// å¦‚æœæœ€é«˜ä½æ˜¯1ï¼Œè¯´æ˜å½“å‰çš„CRCå€¼å·²ç»è¾¾åˆ°æˆ–è¶…è¿‡å¤šé¡¹å¼çš„æœ€é«˜ä½(Polyæœ€é«˜ä½ä¸º0x1000)</span></span><br><span class="line">			<span class="comment">// å¿…é¡»å‡å»å¤šé¡¹(å³^Poly)å¦åˆ™CRCå€¼ä¼šè¶Šæ¥è¶Šå¤§</span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				Crcinit = (Crcinit &lt;&lt; <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		data++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Crcinit;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<p><a target="_blank" rel="noopener" href="https://github.com/havenxie/stm32-iap-uart-boot">havenxie/stm32-iap-uart-boot: STM32 IAP(UARTæ¨¡å¼)çš„BOOTéƒ¨åˆ†</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1SatHeBEVG/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click">ã€æ‰‹æŠŠæ‰‹æ•™ç¨‹ 4Gé€šä¿¡ç‰©è”ç½‘ OTAè¿œç¨‹å‡çº§ BootLoaderç¨‹åºè®¾è®¡ã€‘GD32F103C8T6å•ç‰‡æœºã€ä¸Šç¯‡ç« ã€‘_å“”å“©å“”å“©_bilibili</a></p>

      </div>
    </div>
</div>

<div class="post-category">

    <div id="p-meta-i">
        
              
                <a class="hover-with-bg" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">åµŒå…¥å¼</a>
              
          
          
              
                <a class="hover-with-bg" href="/tags/STM32/"># STM32</a>
              
                <a class="hover-with-bg" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"># å­¦ä¹ ç¬”è®°</a>
              
          
    </div>
</div>


<div class="post-footer">
  

</div>

</article>


        </div>
        
<footer class="text-center">
    
    
    
    
    
    <p>&copy;  2022 - 2025&nbsp;&nbsp;æœ¬ä¹¦</p>
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme by <a href="https://github.com/oCoke/hexo-theme-miracle" target="_blank">Miracle</a></p>
    
    
</footer>

<div class="p-btn">
    
        <a class="toc-btn" id="toc-btn"><i id="i-menu"></i></a>
    
    
      <a class="toc-btn" id="share-btn"><i>
        <svg t="1670124379155" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2683" width="25" height="25"><path d="M395.946667 234.666667v64H256v469.333333h512V522.666667h64V768a64 64 0 0 1-64 64H256a64 64 0 0 1-64-64V298.666667a64 64 0 0 1 64-64h139.946667z m335.850666-87.914667l150.848 150.826667-158.378666 158.4-45.269334-45.248L748.394667 341.333333H672c-121.685333 0-220.714667 97.024-223.914667 217.941334L448 565.333333v85.333334h-64v-85.333334C384 406.272 512.938667 277.333333 672 277.333333h99.861333l-85.312-85.333333 45.248-45.248z" p-id="2684" fill="var(--first-text-color)"></path></svg>
      </i></a>
    
    <a href="javascript:window.scrollTo({top:0,behavior:'smooth'});" class="click-btn">
      <i id="i-up"></i>
    </a>
</div>

<!-- SCRIPTS -->






<script>
    document.getElementById("btn-dropdown").addEventListener('click', () => {
      toggleClass("#dropdown-menus","display-inline");
    });
    console.log('\n' + ' %c Powered by Hexo Theme Miracle ' + ' %c https://github.com/oCoke/hexo-theme-miracle ' + '\n' + '\n', 'color: #fff; background: #4F9BFA; padding:5px 0;', 'background: #FFF; padding:5px 0;');

    

    
  /* å°å½©è›‹: é¥®èŒ¶å…ˆå•¦ */
  setTimeout(() => {
    var time = new Date();
    if (time.getHours() == 15) {
      let comment = document.createComment(' ä¸‰ç‚¹å‡ åšŸï¼é¥®èŒ¶å…ˆå•¦ï¼ ');
      document.body.insertBefore(comment, document.getElementsByTagName('header')[0]);
    }
  },1);
    
</script>


<script>
    var postImg = document.querySelectorAll("article[class=page] img");
    for (let imgi = 0; imgi < postImg.length; imgi++) {
        postImg[imgi].onclick = () => {
            let zoomImg = document.createElement("div");
            zoomImg.id = "zoomImg";
            zoomImg.innerHTML = `<div id="zoom-picture"></div>
    <div class="poptrox-overlay"
        style="position: fixed; left: 0px; top: 0px; z-index: 20000; width: 100%; height: 100%; text-align: center; cursor: zoom-out; opacity: 1;">
        <div style="display:inline-block;height:100%;vertical-align:middle;"></div>
        <div
            style="position:absolute;left:0;top:0;width:100%;height:100%;background:#000000;opacity:0;filter:alpha(opacity=0);">
        </div>
        <div class="poptrox-popup"
            style="display: inline-block; vertical-align: middle; position: relative; z-index: 1; cursor: zoom-out; min-width: 10px; min-height: 10px; width: auto; height: auto;">
            <div class="loader" style="display: none;"></div>
            <div class="pic" style="text-indent: 0px;"><img
                    src="${ postImg[imgi].srcset || postImg[imgi].src }" alt="Loading..."
                    style="vertical-align: bottom; max-width: 85vw; max-height: 85vh;"></div>
        </div>
    </div>`;
            document.body.appendChild(zoomImg);
                document.querySelector("#zoomImg").onclick = () => {
                    document.querySelector("#zoomImg").remove();
                }
        }
    }
    
</script>




    <script>
        query("#toc-btn")[0].onclick = () => {
            if (query(".post-toc")[0].innerHTML) {
                toggleClass(".post-toc", "display-inline");
            }
        }

        if (!query(".post-toc")[0].innerHTML) {
            addClass("#toc-btn","display-none");
        }
    </script>



    <script>
        query("#share-btn")[0].onclick = async () => {
            let url = `${location.protocol}//${location.hostname}${location.port ? ":"+location.port:location.port}${location.pathname}#read=${sessionStorage.getItem(location.pathname+"_read_y") || ""}`;
            try {
                await navigator.clipboard.writeText(url);
                prompt_core("åˆ†äº«é“¾æ¥å·²ç»å¤åˆ¶è‡³å‰ªè´´æ¿", 4800, true);
            } catch(e) {
                prompt_core("åˆ†äº«é“¾æ¥å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶<br/>"+url, 4800, false);
            }
        }
    </script>







    <script>
        const getScrollPosition = (el = window) => ({
            x: el.pageXOffset !== undefined ? el.pageXOffset : el.scrollLeft,
            y: el.pageYOffset !== undefined ? el.pageYOffset : el.scrollTop
        });
        // æ­¤å¤„çš„ 750 æ˜¯ã€Œé¡µé¢å…ƒç´ çš„æœ€å¤§å®½åº¦ã€
        var wx = document.getElementsByClassName("article-m")[0].clientWidth;
        var wy = document.getElementsByClassName("article-m")[0].clientHeight;
        function windowScroll() {
            // åå¤ä¿®æ”¹ ç¡®ä¿é¡µé¢å°ºå¯¸ä¸æ”¹å˜
            wx = document.getElementsByClassName("article-m")[0].clientWidth;
            wy = document.getElementsByClassName("article-m")[0].clientHeight;
            let y = Math.round(getScrollPosition().y);
            // console.log(y);
            // ç»„åˆå­—ç¬¦ä¸²ï¼ŒåŒæ—¶è®°å½•é¡µé¢åæ ‡ï¼Œé¡µé¢å®½åº¦å’Œé«˜åº¦
            let p = `${y}:${wx}:${wy}`;
            // å†™å…¥åˆ° sessionStorage ä¸­
            sessionStorage.setItem(location.pathname + "_read_y", p);
        }
        // URL ä¸­æ˜¯å¦åŒ…å«ä¼ é€’çš„åæ ‡ä¿¡æ¯
        setTimeout(() => {
            if (location.hash.split("#read=").length > 1) {
                prompt_core("å·²æœ‰é˜…è¯»è¿›åº¦ï¼Œæ­£åœ¨è·³è½¬", 4800, true);
                // åˆ†ç¦»å­—ç¬¦ä¸²
                let read_y = location.hash.split("#read=")[1];
                read_y = read_y.split(":");
                // ç»„åˆä¹˜ç§¯ï¼Œé¡ºæ»‘ç§»åŠ¨è‡³åæ ‡
                window.scrollTo({top: Math.round(Number(read_y[0]) * Number(read_y[1] * Number(read_y[2] / wx / wy))), behavior: "smooth"});
            } else {
                // ä» sessionStorage ä¸­è·å–
                let read_y = sessionStorage.getItem(location.pathname + "_read_y") || "0:0:0";
                read_y = read_y.split(":");
                if (read_y[0] != "0") prompt_core("å·²æœ‰é˜…è¯»è¿›åº¦ï¼Œæ­£åœ¨è·³è½¬", 4800, true);
                window.scrollTo({top: Math.round(Number(read_y[0]) * Number(read_y[1] * Number(read_y[2] / wx / wy))), behavior: "smooth"});
            }
        }, 500);
        window.onscroll = windowScroll;
    </script>





        </div>
        <div id="css-loading">
            <h3 class="text-center">åŠ è½½ä¸­...</h3>
        </div>
        
    </body>
</html>
